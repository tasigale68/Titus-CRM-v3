// ─── Weekly Stakeholder Reports & Stakeholder Portal ─────
var crypto = require('crypto');
var fs = require('fs');
var path = require('path');
var airtable = require('../../services/database');
var env = require('../../config/env');
var { db } = require('../../db/sqlite');
var { logAudit } = require('../../services/audit');
var { uploadsDir } = require('../../config/upload');

// ═══ GET weekly reports list ═══
function getWeeklyReports(req, res) {
  if (!env.airtable.apiKey || !env.airtable.baseId) return res.json([]);
  var clientName = req.query.clientName || "";
  airtable.fetchAllFromTable("Weekly Stakeholder Reports").then(function(records) {
    if (!records) return res.json([]);
    var result = (records || []).filter(function(r) {
      if (!r.fields) return false;
      var cn = r.fields["Client Full Name (from Client Name)"];
      if (Array.isArray(cn)) cn = cn[0] || "";
      return !clientName || String(cn).toLowerCase() === clientName.toLowerCase();
    }).map(function(r) {
      var f = r.fields || {};
      var uploads = f["Report Upload"] || [];
      var pdfUrl = Array.isArray(uploads) && uploads.length > 0 ? (uploads[0].url || "") : "";
      var cn = f["Client Full Name (from Client Name)"];
      if (Array.isArray(cn)) cn = cn[0] || "";
      return {
        id: r.id,
        uniqueRef: f["Unique Ref #"] || r.id,
        dateCreated: f["Date created in Titus"] || "",
        clientName: cn || f["Client Name Text"] || "",
        reportFrom: f["Report Period From"] || "",
        reportTo: f["Report Period To"] || "",
        generatedBy: f["Generated By"] || "",
        pdfUrl: pdfUrl
      };
    });
    result.sort(function(a, b) { return (b.dateCreated || "").localeCompare(a.dateCreated || ""); });
    res.json(result);
  }).catch(function(e) {
    console.error("Weekly reports GET error:", e.message);
    res.json([]);
  });
}

// ═══ POST generate or save weekly report ═══
function postWeeklyReport(req, res) {
  var b = req.body || {};

  // ─── Generate mode: {from, to, clients:[name]} → return report data ───
  if (b.from && b.to && b.clients) {
    return generateStakeholderData(req, res, b);
  }

  // ─── Save mode: {clientName, pdfBase64} → save to Airtable ───
  if (!env.airtable.apiKey || !env.airtable.baseId) return res.json({ error: "Airtable not configured" });
  var clientName = b.clientName || "";
  var pdfBase64 = b.pdfBase64 || "";
  var filename = b.filename || ("NDIS_Report_" + Date.now() + ".pdf");

  var fields = {};
  fields["Date created in Titus"] = new Date().toISOString().split("T")[0];

  if (clientName) {
    var reportFrom = b.reportFrom || b.from || "";
    var reportTo   = b.reportTo   || b.to   || "";
    var generatedBy = b.generatedBy || "";
    if (reportFrom) fields["Report Period From"] = reportFrom;
    if (reportTo)   fields["Report Period To"]   = reportTo;
    if (generatedBy) fields["Generated By"] = generatedBy;

    function lookupAndSave() {
      return airtable.fetchAllFromTable("Clients").then(function(clients) {
        var match = (clients || []).find(function(c) {
          var fn = c.fields && (c.fields["Client Name"] || c.fields["Full Name"] || c.fields["Name"] || "");
          if (Array.isArray(fn)) fn = fn[0] || "";
          return fn.toLowerCase() === clientName.toLowerCase();
        });
        if (match) {
          fields["Client Name"] = [match.id];
          return;
        }
        return airtable.fetchAllFromTable("Contacts").then(function(contacts) {
          var cm = (contacts || []).find(function(c) {
            var fn = c.fields && (c.fields["Full Name"] || c.fields["Name"] || "");
            if (Array.isArray(fn)) fn = fn[0] || "";
            return fn.toLowerCase() === clientName.toLowerCase();
          });
          if (cm) fields["Client Name"] = [cm.id];
          else console.warn("Weekly report: no client record found for:", clientName);
        });
      });
    }

    lookupAndSave().catch(function(){}).then(function() {
      if (pdfBase64) {
        try {
          var ext = ".pdf";
          var safeName = "stakeholder_" + Date.now() + "_" + crypto.randomBytes(4).toString("hex") + ext;
          var filePath = path.join(uploadsDir, safeName);
          var buf = Buffer.from(pdfBase64, "base64");
          fs.writeFileSync(filePath, buf);
          var protocol = "https";
          var host = req.headers["x-forwarded-host"] || req.headers.host || "localhost:3000";
          var fileUrl = protocol + "://" + host + "/uploads/" + safeName;
          fields["Report Upload"] = [{ url: fileUrl, filename: filename }];
        } catch(e) {
          console.warn("Weekly report PDF save error:", e.message);
        }
      }

      airtable.rawFetch("Weekly Stakeholder Reports", "POST", "", { records: [{ fields: fields }] })
        .then(function(data) {
          if (data.records && data.records.length > 0) {
            console.log("Weekly report saved:", data.records[0].id, clientName);
            res.json({ id: data.records[0].id, success: true });
          } else {
            console.error("Weekly report save failed:", JSON.stringify(data));
            res.json({ error: data.error || "Failed to save" });
          }
        }).catch(function(e) {
          console.error("Weekly report POST error:", e.message);
          res.json({ error: e.message });
        });
    });
  } else {
    res.json({ error: "clientName required" });
  }
}

// ═══ STAKEHOLDER PORTAL — Admin: Create portal access link ═══
function createPortalAccess(req, res) {
  var contactId = (req.body.contactId || "").trim();
  var contactName = (req.body.contactName || "").trim();
  var pin = (req.body.pin || "").trim();
  var expiresInDays = parseInt(req.body.expiresInDays) || 365;
  if (!contactId || !contactName) return res.status(400).json({ error: "contactId and contactName required" });

  var token = crypto.randomBytes(32).toString("hex");
  var expiresAt = new Date(Date.now() + expiresInDays * 86400000).toISOString();
  var pinHash = pin ? crypto.createHash("sha256").update(pin + "stakeholder-salt").digest("hex") : null;

  db.prepare(
    "INSERT INTO stakeholder_access (token, contact_id, contact_name, pin, expires_at, created_by, created_by_name) VALUES (?, ?, ?, ?, ?, ?, ?)"
  ).run(token, contactId, contactName, pinHash, expiresAt, req.user.id, req.user.name || req.user.email);

  var protocol = "https";
  var host = req.headers["x-forwarded-host"] || req.headers.host || "localhost:3000";
  var portalUrl = protocol + "://" + host + "/stakeholder-portal.html?token=" + token;

  logAudit(req.user, "create", "stakeholder_access", token, contactName, "portal_link", "", portalUrl);
  res.json({ success: true, token: token, portalUrl: portalUrl, expiresAt: expiresAt });
}

// Admin: List all portal access links
function listPortalAccess(req, res) {
  var rows = db.prepare("SELECT id, token, contact_id, contact_name, expires_at, active, last_accessed, access_count, created_by_name, created_at FROM stakeholder_access ORDER BY created_at DESC").all();
  res.json(rows || []);
}

// Admin: Revoke portal access
function revokePortalAccess(req, res) {
  var id = req.params.id;
  var row = db.prepare("SELECT * FROM stakeholder_access WHERE id = ?").get(id);
  if (!row) return res.status(404).json({ error: "Access link not found" });
  db.prepare("UPDATE stakeholder_access SET active = 0 WHERE id = ?").run(id);
  logAudit(req.user, "revoke", "stakeholder_access", row.token, row.contact_name, "active", "1", "0");
  res.json({ success: true });
}

// Admin: Reactivate portal access
function reactivatePortalAccess(req, res) {
  var id = req.params.id;
  db.prepare("UPDATE stakeholder_access SET active = 1 WHERE id = ?").run(id);
  res.json({ success: true });
}

// Public: Validate portal token
function portalAuth(req, res) {
  var token = (req.body.token || "").trim();
  var pin = (req.body.pin || "").trim();
  if (!token) return res.status(400).json({ error: "Token required" });

  var row = db.prepare("SELECT * FROM stakeholder_access WHERE token = ?").get(token);
  if (!row) return res.status(404).json({ error: "Invalid access link" });
  if (!row.active) return res.status(403).json({ error: "This access link has been revoked" });
  if (row.expires_at && new Date(row.expires_at) < new Date()) return res.status(403).json({ error: "This access link has expired" });

  if (row.pin) {
    var pinHash = crypto.createHash("sha256").update(pin + "stakeholder-salt").digest("hex");
    if (pinHash !== row.pin) return res.status(401).json({ error: "Incorrect PIN", needsPin: true });
  }

  db.prepare("UPDATE stakeholder_access SET last_accessed = CURRENT_TIMESTAMP, access_count = access_count + 1 WHERE id = ?").run(row.id);

  res.json({
    success: true,
    contactId: row.contact_id,
    contactName: row.contact_name,
    hasPin: !!row.pin
  });
}

// Public: Get portal dashboard data
function portalData(req, res) {
  var token = (req.body.token || "").trim();
  if (!token) return res.status(400).json({ error: "Token required" });

  var row = db.prepare("SELECT * FROM stakeholder_access WHERE token = ? AND active = 1").get(token);
  if (!row) return res.status(403).json({ error: "Invalid or revoked access" });
  if (row.expires_at && new Date(row.expires_at) < new Date()) return res.status(403).json({ error: "Access expired" });

  var contactId = row.contact_id;
  var contactName = row.contact_name;

  function arrayVal(v) { return Array.isArray(v) ? v[0] || "" : v || ""; }

  var progressNotesP = airtable.fetchAllFromTable("Progress Notes").then(function(records) {
    return (records || []).filter(function(r) {
      var f = r.fields || {};
      var cn = f["Client Name"] || "";
      if (Array.isArray(cn)) cn = cn[0] || "";
      return String(cn).toLowerCase() === contactName.toLowerCase();
    }).map(function(r) {
      var f = r.fields || {};
      return {
        id: r.id,
        date: f["Date"] || "",
        notes: f["Notes"] || "",
        author: f["Author"] || f["Created By"] || "",
        category: f["Category"] || "",
        goalArea: f["Goal Area"] || ""
      };
    }).sort(function(a, b) { return (b.date || "").localeCompare(a.date || ""); }).slice(0, 20);
  }).catch(function() { return []; });

  var incidentsP = airtable.fetchAllFromTable("IR Reports 2025").then(function(records) {
    return (records || []).filter(function(r) {
      var f = r.fields || {};
      var cn = f["Client Name"] || f["Participant Name"] || "";
      if (Array.isArray(cn)) cn = cn[0] || "";
      return String(cn).toLowerCase() === contactName.toLowerCase();
    }).map(function(r) {
      var f = r.fields || {};
      return {
        id: r.id,
        date: f["Date of Incident"] || f["Date"] || "",
        type: f["Type"] || f["Incident Type"] || "",
        severity: f["Severity"] || "",
        status: f["Status"] || ""
      };
    }).sort(function(a, b) { return (b.date || "").localeCompare(a.date || ""); }).slice(0, 10);
  }).catch(function() { return []; });

  var budgetP = airtable.fetchAllFromTable("Client Core Budgets").then(function(records) {
    return (records || []).filter(function(r) {
      var f = r.fields || {};
      var cn = f["Client Name"] || "";
      if (Array.isArray(cn)) cn = cn[0] || "";
      return String(cn).toLowerCase() === contactName.toLowerCase();
    }).map(function(r) {
      var f = r.fields || {};
      return {
        id: r.id,
        category: f["Budget Category"] || f["Category"] || "",
        silBudget: f["SIL Budget"] || f["SIL Allocation"] || 0,
        communityBudget: f["Community Access Budget"] || f["CA Allocation"] || 0,
        transportBudget: f["Transport Budget"] || f["Transport Allocation"] || 0,
        totalBudget: f["Total Budget"] || 0,
        invoiced: f["Invoice Amount"] || f["Total Invoiced"] || 0
      };
    });
  }).catch(function() { return []; });

  var contactP = airtable.rawFetch("All Contacts", "GET", "/" + contactId).then(function(data) {
    var f = (data && data.fields) || {};
    var photo = f["PIC - SW Photo"] || f["Photo"] || [];
    return {
      name: f["Full Name"] || contactName,
      ndisRef: f["NDIS Ref Number"] || f["NDIS Number"] || "",
      phone: f["Mobile"] || f["Phone"] || "",
      email: f["Email"] || "",
      suburb: f["Suburb"] || "",
      photo: (Array.isArray(photo) && photo.length > 0) ? (photo[0].thumbnails ? photo[0].thumbnails.large.url : photo[0].url || "") : ""
    };
  }).catch(function() { return { name: contactName }; });

  var reportsP = airtable.fetchAllFromTable("Weekly Stakeholder Reports").then(function(records) {
    return (records || []).filter(function(r) {
      var f = r.fields || {};
      var cn = f["Client Full Name (from Client Name)"] || "";
      if (Array.isArray(cn)) cn = cn[0] || "";
      return String(cn).toLowerCase() === contactName.toLowerCase();
    }).map(function(r) {
      var f = r.fields || {};
      var uploads = f["Report Upload"] || [];
      var pdfUrl = (Array.isArray(uploads) && uploads.length > 0) ? (uploads[0].url || "") : "";
      return {
        id: r.id,
        dateCreated: f["Date created in Titus"] || "",
        reportFrom: f["Report Period From"] || "",
        reportTo: f["Report Period To"] || "",
        pdfUrl: pdfUrl
      };
    }).sort(function(a, b) { return (b.dateCreated || "").localeCompare(a.dateCreated || ""); }).slice(0, 10);
  }).catch(function() { return []; });

  Promise.all([progressNotesP, incidentsP, budgetP, contactP, reportsP])
    .then(function(results) {
      res.json({
        contact: results[3],
        progressNotes: results[0],
        incidents: results[1],
        budget: results[2],
        reports: results[4]
      });
    })
    .catch(function(err) {
      console.error("Stakeholder portal data error:", err);
      res.status(500).json({ error: "Error loading portal data" });
    });
}

// ═══ GENERATE stakeholder report data for one or more clients ═══
function generateStakeholderData(req, res, b) {
  var from = b.from;
  var to = b.to;
  var clientNames = (b.clients || []).map(function(c) { return typeof c === 'string' ? c : (c.name || c.id || ''); }).filter(function(n) { return n; });
  if (clientNames.length === 0) return res.json({ error: 'No clients specified' });

  function arrayVal(v) { return Array.isArray(v) ? v[0] || '' : v || ''; }
  function inRange(dateStr) {
    if (!dateStr) return true;
    var d = dateStr.split('T')[0];
    return d >= from && d <= to;
  }

  // Fetch all needed data in parallel
  var companyP = apiCall('GET', '/api/company-details', req).catch(function() { return {}; });
  var progressP = airtable.fetchAllFromTable('Progress Notes').catch(function() { return []; });
  var incidentsP = airtable.fetchAllFromTable('IR Reports 2025').catch(function() { return []; });
  var clientsP = airtable.fetchAllFromTable('Clients').catch(function() { return []; });
  var contactsP = airtable.fetchAllFromTable('All Contacts').catch(function() { return []; });
  var mediaP = airtable.fetchAllFromTable('Client Media').catch(function() { return []; });

  Promise.all([companyP, progressP, incidentsP, clientsP, contactsP, mediaP]).then(function(results) {
    var company = results[0] || {};
    var allNotes = results[1] || [];
    var allIncidents = results[2] || [];
    var allClients = results[3] || [];
    var allContacts = results[4] || [];
    var allMedia = results[5] || [];

    var participants = clientNames.map(function(clientName) {
      var lcName = clientName.toLowerCase();

      // Find client info
      var clientRec = allClients.find(function(c) {
        var f = c.fields || {};
        var n = arrayVal(f['Client Name'] || f['Full Name'] || f['Name'] || '');
        return n.toLowerCase() === lcName;
      });
      var contactRec = allContacts.find(function(c) {
        var f = c.fields || {};
        var n = arrayVal(f['Full Name'] || f['Client Name'] || f['Name'] || '');
        return n.toLowerCase() === lcName;
      });
      var cf = (clientRec && clientRec.fields) || {};
      var ctf = (contactRec && contactRec.fields) || {};
      var info = {
        ndisNumber: arrayVal(cf['NDIS Number'] || ctf['NDIS Number'] || ctf['NDIS Ref Number'] || ''),
        serviceType: arrayVal(cf['SIL or CAS?'] || cf['Service Type'] || ''),
        suburb: arrayVal(cf['Suburb'] || ctf['Suburb'] || ''),
        supportCoordinator: arrayVal(cf['Support Coordinator'] || ctf['Support Coordinator'] || ''),
        planExpiry: arrayVal(cf['Plan End'] || cf['Plan End Date'] || ''),
        age: arrayVal(cf['Age'] || ctf['Age'] || '')
      };

      // Filter progress notes for this client in date range
      var shifts = allNotes.filter(function(r) {
        var f = r.fields || {};
        var cn = arrayVal(f['Client Name'] || f['Client'] || '');
        if (cn.toLowerCase() !== lcName) return false;
        var d = f['Date'] || f['Shift Date'] || f['Session Date'] || '';
        return inRange(d);
      }).map(function(r) {
        var f = r.fields || {};
        return {
          date: f['Date'] || f['Shift Date'] || f['Session Date'] || '',
          worker: arrayVal(f['Staff Name'] || f['Worker'] || f['Support Worker'] || ''),
          hours: parseFloat(f['Total Hours'] || f['Hours'] || 0) || 0,
          activity: f['Progress Notes'] || f['Activity'] || f['Notes'] || f['Session Notes'] || ''
        };
      }).sort(function(a, b) { return (a.date || '').localeCompare(b.date || ''); });

      // Filter incidents
      var incidents = allIncidents.filter(function(r) {
        var f = r.fields || {};
        var cn = arrayVal(f['Client Name'] || f['Participant'] || '');
        if (cn.toLowerCase() !== lcName) return false;
        var d = f['Date'] || f['Incident Date'] || f['Date of Incident'] || '';
        return inRange(d);
      }).map(function(r) {
        var f = r.fields || {};
        return {
          date: f['Date'] || f['Incident Date'] || f['Date of Incident'] || '',
          category: f['Category'] || f['Incident Type'] || f['Type'] || '',
          description: f['Description'] || f['Incident Description'] || f['Summary'] || ''
        };
      });

      // Extract goals from progress notes (fields containing 'goal' or 'objective')
      var goals = [];
      shifts.forEach(function(s) {
        if (!s.activity) return;
        var goalFields = ['Goals', 'Goal Progress', 'Objectives', 'Goal Observation'];
        goalFields.forEach(function(gf) {
          if (s.activity.toLowerCase().indexOf(gf.toLowerCase()) >= 0) {
            goals.push({ field: gf, date: s.date, content: s.activity });
          }
        });
      });

      // Filter photos/media
      var photos = allMedia.filter(function(r) {
        var f = r.fields || {};
        var cn = arrayVal(f['Client Name'] || f['Client'] || '');
        if (cn.toLowerCase() !== lcName) return false;
        var d = f['Date'] || f['Upload Date'] || '';
        return inRange(d);
      }).map(function(r) {
        var f = r.fields || {};
        var attachments = f['Photo'] || f['Attachment'] || f['File'] || [];
        if (!Array.isArray(attachments) || attachments.length === 0) return null;
        var att = attachments[0];
        return {
          url: att.url || '',
          thumbnail: (att.thumbnails && att.thumbnails.large) ? att.thumbnails.large.url : att.url || '',
          date: f['Date'] || f['Upload Date'] || '',
          worker: arrayVal(f['Staff Name'] || f['Uploaded By'] || '')
        };
      }).filter(function(p) { return p && p.url; });

      // Health/behaviour concerns
      var concerns = [];

      // Build incident chart data
      var incByDay = {};
      incidents.forEach(function(inc) {
        var d = (inc.date || '').split('T')[0];
        if (d) incByDay[d] = (incByDay[d] || 0) + 1;
      });
      var chartIncByDay = { labels: Object.keys(incByDay).sort(), data: [] };
      chartIncByDay.data = chartIncByDay.labels.map(function(k) { return incByDay[k]; });

      var incByCat = {};
      incidents.forEach(function(inc) {
        var cat = inc.category || 'Other';
        incByCat[cat] = (incByCat[cat] || 0) + 1;
      });
      var chartIncidents = Object.keys(incByCat).map(function(k) { return { label: k, value: incByCat[k] }; });

      return {
        name: clientName,
        info: info,
        shifts: shifts,
        incidents: incidents,
        goals: goals,
        photos: photos,
        concerns: concerns,
        chartIncByDay: chartIncByDay,
        chartIncidents: chartIncidents,
        aiSections: {}
      };
    });

    // Try to generate AI analysis if Anthropic key is available
    var anthropicKey = env.anthropic && env.anthropic.apiKey;
    if (anthropicKey && participants.length > 0) {
      var aiPromises = participants.map(function(p) {
        return generateAISections(anthropicKey, p, from, to).then(function(ai) {
          p.aiSections = ai;
        }).catch(function(e) {
          console.warn('AI analysis failed for ' + p.name + ':', e.message);
        });
      });
      Promise.all(aiPromises).then(function() {
        res.json({ company: company, participants: participants });
      });
    } else {
      res.json({ company: company, participants: participants });
    }
  }).catch(function(err) {
    console.error('Stakeholder generate error:', err.message);
    res.status(500).json({ error: err.message });
  });
}

// Internal API call helper for company details
function apiCall(method, path, req) {
  var protocol = 'http';
  var host = req.headers.host || 'localhost:3000';
  var url = protocol + '://' + host + path;
  var headers = { 'Content-Type': 'application/json' };
  if (req.headers.authorization) headers['Authorization'] = req.headers.authorization;
  if (req.headers['x-auth-token']) headers['x-auth-token'] = req.headers['x-auth-token'];
  var cookie = req.headers.cookie;
  if (cookie) headers['Cookie'] = cookie;
  return fetch(url, { method: method, headers: headers }).then(function(r) {
    return r.ok ? r.json() : {};
  }).catch(function() { return {}; });
}

// Generate AI analysis sections using Claude API
function generateAISections(apiKey, participant, from, to) {
  var notesSummary = (participant.shifts || []).slice(0, 20).map(function(s) {
    return s.date + ': ' + (s.activity || '').substring(0, 200);
  }).join('\n');
  var incidentsSummary = (participant.incidents || []).map(function(i) {
    return i.date + ' [' + (i.category || '') + ']: ' + (i.description || '').substring(0, 150);
  }).join('\n');

  var prompt = 'You are writing an NDIS stakeholder report for participant "' + participant.name + '" for the period ' + from + ' to ' + to + '.\n\n'
    + 'Progress Notes:\n' + (notesSummary || 'No progress notes in period.') + '\n\n'
    + 'Incidents:\n' + (incidentsSummary || 'No incidents in period.') + '\n\n'
    + 'Write 4 sections (3-5 sentences each). Return ONLY valid JSON:\n'
    + '{"goalProgress":"...","functionalCapacity":"...","incidentRisk":"...","emergingNeeds":"..."}\n'
    + 'goalProgress: Outcomes, goals achieved, participation.\n'
    + 'functionalCapacity: Independence, daily living skills, functional improvements.\n'
    + 'incidentRisk: Safety, incidents summary, risk management.\n'
    + 'emergingNeeds: Changing needs, upcoming transitions, recommendations.';

  return fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1024,
      messages: [{ role: 'user', content: prompt }]
    })
  }).then(function(r) {
    if (!r.ok) throw new Error('Claude API ' + r.status);
    return r.json();
  }).then(function(data) {
    var text = (data.content && data.content[0] && data.content[0].text) || '{}';
    // Extract JSON from response
    var jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try { return JSON.parse(jsonMatch[0]); } catch (e) { return {}; }
    }
    return {};
  });
}

module.exports = {
  getWeeklyReports,
  postWeeklyReport,
  createPortalAccess,
  listPortalAccess,
  revokePortalAccess,
  reactivatePortalAccess,
  portalAuth,
  portalData
};
