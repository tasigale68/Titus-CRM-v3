<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Titus CRM ‚Äî Delta Community Support</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root{--bg:#F5F6FA;--surface:#FFFFFF;--surface2:#F8F9FC;--border:#E8EBF0;--border2:#D5DAE3;--royal:#1E4BA0;--teal:#0A9396;--tealLight:rgba(10,147,150,.08);--tealBorder:rgba(10,147,150,.2);--green:#10B981;--greenBg:rgba(16,185,129,.08);--greenBorder:rgba(16,185,129,.2);--orange:#F59E0B;--red:#EF4444;--text:#111827;--text2:#374151;--muted:#6B7280;--dim:#9CA3AF;--light:#D1D5DB;--r:10px;--rs:6px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
.login-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg)}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:44px;width:400px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.06)}
.logo-mark{width:48px;height:48px;background:var(--teal);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;color:#fff;margin:0 auto 16px}
.login-card h1{font-size:22px;font-weight:700;color:var(--text);margin-bottom:4px}
.login-card .sub{font-size:13px;color:var(--dim);margin-bottom:28px}
.login-err{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);color:var(--red);font-size:12px;padding:8px 12px;border-radius:var(--rs);margin-bottom:14px;display:none}
.fg{margin-bottom:16px;text-align:left}
.fg label{display:block;font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:10px 12px;font-size:13px;color:var(--text);font-family:inherit;outline:none;transition:border .15s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(10,147,150,.1)}
.fg input::placeholder,.fg textarea::placeholder{color:var(--dim)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:8px 14px;border-radius:var(--rs);font-size:12px;font-weight:600;border:none;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-p{background:var(--teal);color:#fff;width:100%;padding:11px;font-size:13px}
.btn-p:hover{background:#088587}
.btn-s{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}
.btn-s:hover{background:var(--border);color:var(--text)}
.btn-d{background:rgba(239,68,68,.06);color:var(--red);border:1px solid rgba(239,68,68,.2);font-size:11px;padding:5px 10px}
.btn-d:hover{background:rgba(239,68,68,.12)}
.btn-sm{padding:6px 10px;font-size:11px}
.btn-teal{background:var(--tealLight);color:var(--teal);border:1px solid var(--tealBorder);font-size:11px;padding:5px 10px}
.btn-teal:hover{background:var(--teal);color:#fff}
.app{display:grid;grid-template-columns:200px 320px 1fr;grid-template-rows:1fr;height:100vh;overflow:hidden;display:none;transition:grid-template-columns .25s ease}
.app.sb-collapsed{grid-template-columns:60px 320px 1fr}
.app.sb-collapsed .sb-brand-text,.app.sb-collapsed .sb-brand-sub,.app.sb-collapsed .sb-user-info,.app.sb-collapsed .sb-signout,.app.sb-collapsed .sb-item-label,.app.sb-collapsed .badge-dot,.app.sb-collapsed .sb-sub,.app.sb-collapsed .sb-collapse-label{display:none!important}
.app.sb-collapsed .sb-brand{justify-content:center;padding:12px 8px}
.app.sb-collapsed .sb-item{justify-content:center;padding:9px 8px}
.app.sb-collapsed .sb-item svg{margin:0}
.app.sb-collapsed .sb-footer{padding:8px}
.app.sb-collapsed .sb-user{justify-content:center;padding:4px}
.app.sb-collapsed .sb-collapse-btn svg{transform:rotate(180deg)}
.sidebar{background:#1E4BA0;border-right:none;display:flex;flex-direction:column;overflow:hidden;transition:all .25s ease}
.sb-collapse-btn{display:flex;align-items:center;gap:8px;padding:6px 12px;margin:4px 8px;border-radius:var(--rs);cursor:pointer;font-size:11px;font-weight:600;color:rgba(255,255,255,.5);border:none;background:none;width:calc(100% - 16px);text-align:left;font-family:inherit;transition:all .12s}
.sb-collapse-btn:hover{background:rgba(255,255,255,.1);color:rgba(255,255,255,.8)}
.sb-collapse-btn svg{width:16px;height:16px;flex-shrink:0;transition:transform .25s ease}
.sb-sub{padding:0 8px 0 36px;overflow:hidden;max-height:0;transition:max-height .3s ease}
.sb-sub.open{max-height:600px}
.sb-sub-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:var(--rs);cursor:pointer;font-size:11px;font-weight:700;color:rgba(255,255,255,.7);border:none;background:none;width:100%;text-align:left;font-family:inherit;transition:all .12s}
.sb-sub-item:hover{background:rgba(255,255,255,.08);color:#fff}
.sb-sub-item.on{background:rgba(255,255,255,.12);color:#fff;font-weight:700}
.kanban-wrap{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px;min-height:400px}
.kanban-col{min-width:220px;flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);display:flex;flex-direction:column;max-height:calc(100vh - 220px)}
.kanban-col-hdr{padding:10px 12px;font-size:12px;font-weight:700;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface2);border-radius:var(--r) var(--r) 0 0}
.kanban-col-body{flex:1;padding:8px;overflow-y:auto;min-height:60px}
.kanban-col-body.drag-over{background:rgba(10,147,150,.06);border:2px dashed var(--teal);border-radius:0 0 var(--r) var(--r)}
.kanban-card{padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;cursor:grab;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.kanban-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08);border-color:var(--teal)}
.kanban-card.dragging{opacity:.5;transform:rotate(2deg)}
.cv-drop-zone{border:2px dashed var(--border);border-radius:var(--r);padding:48px 24px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface2)}
.cv-drop-zone:hover,.cv-drop-zone.drag-active{border-color:var(--teal);background:rgba(10,147,150,.04)}
.cv-drop-zone.drag-active{box-shadow:0 0 0 4px rgba(10,147,150,.1)}
.cv-file-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px}
.cv-file-icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.cv-file-info{flex:1;min-width:0}
.cv-file-name{font-size:12px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cv-file-size{font-size:10px;color:var(--muted)}
.cv-file-status{font-size:10px;font-weight:600;padding:3px 8px;border-radius:8px;white-space:nowrap}
.cv-progress{width:100%;height:4px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden}
.cv-progress-bar{height:100%;background:var(--teal);border-radius:2px;transition:width .3s ease}
.sb-brand{padding:16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.15)}
.sb-brand .logo-mark{width:32px;height:32px;font-size:11px;margin:0;border-radius:8px;background:#fff;color:#1E4BA0}
.sb-brand-text{font-size:14px;font-weight:700;color:#fff}
.sb-brand-sub{font-size:9px;color:rgba(255,255,255,.55);font-weight:400}
.sb-nav{flex:1;padding:8px;overflow-y:auto}
.sb-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--rs);cursor:pointer;font-size:13px;font-weight:700;color:#FFD166;border:none;background:none;width:100%;text-align:left;font-family:inherit;transition:all .12s;position:relative}
.sb-item:hover{background:rgba(255,255,255,.1);color:#FFE08A}
.sb-item.on{background:rgba(255,210,100,.12);color:#FFD166;font-weight:700}
.sb-item .sb-arrow{margin-left:auto;font-size:16px;font-weight:900;transition:transform .2s;color:#FFD166;line-height:1}
.sb-item.on .sb-arrow,.sb-item:hover .sb-arrow{color:#FFE08A}
.sb-item .badge-dot{margin-left:auto;min-width:20px;height:20px;background:#FFD166;color:#1E4BA0;font-size:9px;font-weight:700;border-radius:10px;display:flex;align-items:center;justify-content:center}
.sb-item svg{width:18px;height:18px;flex-shrink:0;stroke:#FFD166}
.sb-footer{padding:10px;border-top:1px solid rgba(255,255,255,.15)}
.sb-user{display:flex;align-items:center;gap:8px;padding:8px;border-radius:var(--rs)}
.sb-avatar{width:32px;height:32px;background:rgba(255,255,255,.2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:700}
.sb-user-info{flex:1}
.sb-user-name{font-size:12px;font-weight:600;color:#fff}
.sb-user-status{font-size:10px;color:#4ADE80;display:flex;align-items:center;gap:4px}
.sb-user-status::before{content:'';width:6px;height:6px;background:#4ADE80;border-radius:50%}
.sb-signout{font-size:10px;color:rgba(255,255,255,.5);cursor:pointer;border:none;background:none;font-family:inherit;padding:4px 6px;border-radius:4px}
.sb-signout:hover{color:#fff;background:rgba(255,255,255,.1)}
.mid-panel{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;min-height:0;min-width:0}
.mid-hdr{padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.mid-hdr h2{font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px}
.mid-search{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:8px 10px;font-size:12px;color:var(--text);font-family:inherit;outline:none}
.mid-search:focus{border-color:var(--teal)}
.mid-search::placeholder{color:var(--dim)}
.mid-tabs{display:flex;padding:0 16px;border-bottom:1px solid var(--border);gap:0;flex-shrink:0}
.mid-tab{padding:10px 12px;font-size:11px;font-weight:600;color:var(--dim);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;font-family:inherit;transition:all .12s}
.mid-tab.on{color:var(--teal);border-bottom-color:var(--teal)}
.mid-tab:hover{color:var(--text)}
.conv-list{flex:1;overflow-y:auto;overflow-x:hidden;min-height:0;min-width:0}
.conv-item{display:flex;align-items:flex-start;gap:10px;padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s;overflow:hidden}
.conv-item:hover{background:var(--surface2)}
.conv-item.on{background:var(--tealLight);border-left:3px solid var(--teal);padding-left:13px}
.conv-avatar{width:36px;height:36px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0}
.conv-body{flex:1;min-width:0}
.conv-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
.conv-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-time{font-size:10px;color:var(--dim);flex-shrink:0}
.conv-sub{font-size:10px;color:var(--dim);font-family:'JetBrains Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-preview{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.conv-badges{display:flex;gap:4px;margin-top:4px}
.conv-badge{font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px}
.conv-badge.call{background:rgba(10,147,150,.08);color:var(--teal)}
.conv-badge.sms{background:rgba(245,158,11,.08);color:var(--orange)}
.right-panel{background:var(--bg);display:flex;flex-direction:column;overflow:hidden;min-height:0;min-width:0}
.rp-hdr{padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.rp-hdr-info{display:flex;align-items:center;gap:10px}
.rp-hdr-avatar{width:36px;height:36px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700}
.rp-hdr-name{font-size:15px;font-weight:700;color:var(--text)}
.rp-hdr-sub{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.rp-hdr-actions{display:flex;gap:6px;align-items:center}
.rp-action{width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);transition:all .12s}
.rp-action:hover{background:var(--teal);color:#fff;border-color:var(--teal)}
.rp-action svg{width:16px;height:16px}
.rp-thread{flex:1;overflow-y:auto;overflow-x:hidden;padding:16px 20px;display:flex;flex-direction:column;gap:12px;min-height:0;min-width:0}
.thread-date{text-align:center;font-size:10px;font-weight:600;color:var(--dim);padding:8px 0}
.msg-row{display:flex;gap:8px;max-width:80%;min-width:0}
.msg-row.out{align-self:flex-end;flex-direction:row-reverse}
.msg-ava{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--muted);flex-shrink:0}
.msg-bubble{padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.55;position:relative;overflow:hidden;word-break:break-word}
.msg-row:not(.out) .msg-bubble{background:var(--surface);border:1px solid var(--border);color:var(--text);border-top-left-radius:4px}
.msg-row.out .msg-bubble{background:var(--teal);color:#fff;border-top-right-radius:4px}
.msg-meta{font-size:9px;color:var(--dim);margin-top:3px;display:flex;align-items:center;gap:4px}
.msg-row.out .msg-meta{justify-content:flex-end}
.msg-type-badge{font-size:8px;font-weight:600;padding:1px 5px;border-radius:3px;background:var(--surface2);color:var(--muted);border:1px solid var(--border)}
.rp-compose{padding:12px 20px;background:var(--surface);border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-shrink:0}
.rp-compose input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:10px 16px;font-size:13px;color:var(--text);font-family:inherit;outline:none}
.rp-compose input:focus{border-color:var(--teal)}
.rp-compose input::placeholder{color:var(--dim)}
.rp-compose button{background:var(--teal);color:#fff;border:none;padding:10px 18px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.rp-compose button:hover{background:#088587}
.rp-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--dim);font-size:13px;gap:8px}
.ai-messages{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:10px;background:var(--bg)}
.ai-msg{max-width:80%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.55;white-space:pre-wrap}
.ai-msg.user{background:var(--teal);color:#fff;align-self:flex-end;border-top-right-radius:4px}
.ai-msg.bot{background:var(--surface);border:1px solid var(--border);align-self:flex-start;color:var(--text);border-top-left-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.03)}
.ai-compose{padding:12px 20px;background:var(--surface);border-top:1px solid var(--border);display:flex;gap:8px}
.ai-compose input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:20px;padding:10px 16px;font-size:13px;color:var(--text);font-family:inherit;outline:none}
.ai-compose input:focus{border-color:var(--teal)}
.ai-compose input::placeholder{color:var(--dim)}
.ai-compose button{background:var(--teal);color:#fff;border:none;padding:10px 18px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.transcript-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin:8px 16px}
.transcript-hdr{display:flex;justify-content:space-between;margin-bottom:8px}
.transcript-name{font-weight:600;font-size:14px;color:var(--text)}
.transcript-time{font-size:11px;color:var(--dim)}
.transcript-summary{background:var(--tealLight);border:1px solid var(--tealBorder);border-radius:var(--rs);padding:10px;margin-bottom:8px;font-size:12px;line-height:1.5;color:var(--text2)}
.transcript-body{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:10px;font-size:12px;line-height:1.6;color:var(--muted);white-space:pre-wrap}
.admin-wrap{padding:16px}
.admin-form{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}
.admin-form h3{font-size:14px;font-weight:700;margin-bottom:12px;color:var(--text)}
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.admin-user{background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.admin-user-info{display:flex;align-items:center;gap:8px}
.admin-user-ava{width:30px;height:30px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--muted)}
.role-badge{font-size:9px;font-weight:600;padding:2px 8px;border-radius:10px;background:var(--greenBg);color:var(--green);border:1px solid var(--greenBorder)}
.contact-type-badge{font-size:9px;font-weight:600;padding:2px 8px;border-radius:10px;display:inline-block;margin-top:3px}
.contact-type-badge.staff{background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.2)}
.contact-type-badge.participant{background:rgba(30,75,160,.08);color:var(--royal);border:1px solid rgba(30,75,160,.2)}
.contact-type-badge.stakeholder{background:rgba(245,158,11,.08);color:var(--orange);border:1px solid rgba(245,158,11,.2)}
.contact-type-badge.other{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}
.contact-type-badge.allied{background:rgba(124,58,237,.08);color:#7C3AED;border:1px solid rgba(124,58,237,.2)}
.contact-type-badge.personal{background:rgba(236,72,153,.08);color:#EC4899;border:1px solid rgba(236,72,153,.2)}
@keyframes spin{to{transform:rotate(360deg)}}.spin{animation:spin .8s linear infinite}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--dim);font-size:13px;gap:6px;padding:20px;text-align:center}
/* DIALER MODAL */
.dialer-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.dialer-overlay.show{display:flex}
.dialer-modal{background:var(--surface);border-radius:16px;width:380px;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:dialIn .2s ease}
@keyframes dialIn{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.dialer-modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border)}
.dialer-modal-hdr h3{font-size:15px;font-weight:700;color:var(--text)}
.dialer-modal-close{width:30px;height:30px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:16px;transition:all .12s}
.dialer-modal-close:hover{background:var(--red);color:#fff;border-color:var(--red)}
.dialer-wrap{display:flex;flex-direction:column;align-items:center;padding:16px 20px;gap:12px}
.dialer-search{width:100%;position:relative}
.dialer-search input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:9px 12px;font-size:13px;color:var(--text);font-family:inherit;outline:none}
.dialer-search input:focus{border-color:var(--teal)}
.dialer-search input::placeholder{color:var(--dim)}
.dialer-search label{display:block;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.dialer-results{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);max-height:200px;overflow-y:auto;z-index:10;display:none;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.dialer-results.show{display:block}
.dialer-result-item{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);transition:background .1s}
.dialer-result-item:hover{background:var(--tealLight)}
.dialer-result-item:last-child{border-bottom:none}
.dialer-result-name{font-size:13px;font-weight:600;color:var(--text)}
.dialer-result-phone{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.dialer-display{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:12px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:600;color:var(--text);min-height:52px;display:flex;align-items:center;justify-content:center;letter-spacing:1px;flex-direction:column;gap:4px}
.dialer-display .contact-label{font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--teal);letter-spacing:0}
.dialer-pad{display:grid;grid-template-columns:repeat(3,80px);gap:8px}
.dial-key{width:80px;height:52px;border-radius:var(--rs);border:1px solid var(--border);background:var(--surface);font-size:20px;font-weight:600;color:var(--text);cursor:pointer;font-family:inherit;transition:all .1s;display:flex;flex-direction:column;align-items:center;justify-content:center}
.dial-key:hover{background:var(--surface2);border-color:var(--teal)}
.dial-key:active{background:var(--tealLight)}
.dial-key .sub{font-size:8px;color:var(--dim);font-weight:400;letter-spacing:2px}
.dialer-actions{display:flex;gap:10px;align-items:center}
.dial-call{width:56px;height:56px;border-radius:50%;border:none;color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.dial-call:hover{transform:scale(1.05)}
.dial-call.del-btn{background:var(--surface2);color:var(--muted);width:40px;height:40px;font-size:16px;border:1px solid var(--border)}
.dial-call.del-btn:hover{background:var(--border);transform:none}
.dialer-sms-area{width:100%;display:none}
.dialer-sms-area.show{display:block}
.dialer-sms-area textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:10px;font-size:13px;color:var(--text);font-family:inherit;outline:none;resize:vertical;min-height:60px}
.dialer-sms-area textarea:focus{border-color:var(--teal)}
.dialer-sms-area button{margin-top:8px;width:100%}
.dialer-status{font-size:12px;color:var(--muted);min-height:18px;text-align:center}
/* INLINE TRANSCRIPT */
.call-transcript-btn{font-size:10px;font-weight:600;color:var(--teal);cursor:pointer;margin-top:6px;display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--tealLight);border:1px solid var(--tealBorder);border-radius:4px;transition:all .12s}
.call-transcript-btn:hover{background:var(--teal);color:#fff}
.call-transcript-box{margin-top:8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:10px;font-size:11px;line-height:1.6;color:var(--muted);white-space:pre-wrap;max-height:200px;overflow-y:auto;display:none}
.call-transcript-box.show{display:block}
.call-summary-box{margin-top:6px;padding:6px 10px;background:var(--tealLight);border:1px solid var(--tealBorder);border-radius:var(--rs);font-size:11px;line-height:1.5;color:var(--text2)}
.call-summary-box strong{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--teal);display:block;margin-bottom:2px}
/* FAB */
.fab-dial{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--green);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(16,185,129,.4);display:none;align-items:center;justify-content:center;z-index:100;transition:all .15s}
.fab-dial:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(16,185,129,.5)}
.fab-dial svg{width:24px;height:24px}
/* TZ BAR */
.tz-bar{padding:6px 16px;background:rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.1);font-size:10px;color:rgba(255,255,255,.5);display:flex;align-items:center;gap:6px}
.tz-bar .tz-time{font-weight:600;color:#fff;font-family:'JetBrains Mono',monospace;font-size:11px}
/* SMS COMPOSE MODAL */
.sms-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:210;display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.sms-overlay.show{display:flex}
.sms-modal{background:var(--surface);border-radius:16px;width:640px;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:dialIn .2s ease}
.sms-modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border)}
.sms-modal-hdr h3{font-size:15px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
.sms-modal-hdr .sms-type-toggle{display:flex;gap:0;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border);overflow:hidden;margin-left:12px}
.sms-type-btn{padding:5px 12px;font-size:11px;font-weight:600;border:none;background:none;cursor:pointer;color:var(--muted);font-family:inherit;transition:all .12s}
.sms-type-btn.on{background:var(--teal);color:#fff}
.sms-modal-close{width:30px;height:30px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:16px;transition:all .12s}
.sms-modal-close:hover{background:var(--red);color:#fff;border-color:var(--red)}
.sms-compose-wrap{padding:16px 20px;display:flex;flex-direction:column;gap:14px}
.sms-to-section{position:relative}
.sms-to-section label{display:block;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.sms-recipients-box{display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:38px;max-height:80px;overflow-y:auto;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:6px 10px;cursor:text}
.sms-recipients-box:focus-within{border-color:var(--teal);box-shadow:0 0 0 3px rgba(10,147,150,.1)}
.sms-recipient-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--tealLight);border:1px solid var(--tealBorder);border-radius:12px;font-size:11px;font-weight:600;color:var(--teal)}
.sms-recipient-tag .remove{cursor:pointer;font-size:14px;line-height:1;opacity:.6;transition:opacity .1s}
.sms-recipient-tag .remove:hover{opacity:1;color:var(--red)}
.sms-to-input{border:none;background:none;outline:none;font-size:13px;color:var(--text);font-family:inherit;flex:1;min-width:120px;padding:2px 0}
.sms-to-input::placeholder{color:var(--dim)}
.sms-contact-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);max-height:240px;overflow-y:auto;z-index:10;display:none;box-shadow:0 8px 24px rgba(0,0,0,.12);margin-top:4px}
.sms-contact-dropdown.show{display:block}
.sms-contact-item{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);transition:background .1s}
.sms-contact-item:hover{background:var(--tealLight)}
.sms-contact-item:last-child{border-bottom:none}
.sms-contact-check{width:18px;height:18px;border-radius:4px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .12s}
.sms-contact-check.on{background:var(--teal);border-color:var(--teal);color:#fff}
.sms-contact-info{flex:1}
.sms-contact-name{font-size:13px;font-weight:600;color:var(--text)}
.sms-contact-phone{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.sms-select-all{padding:8px 12px;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:8px;cursor:pointer;background:var(--surface2);font-size:11px;font-weight:600;color:var(--muted);transition:background .1s}
.sms-select-all:hover{background:var(--tealLight);color:var(--teal)}
.sms-dropdown-done{padding:10px 12px;border-top:2px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface);cursor:pointer;position:sticky;bottom:0}
.sms-dropdown-done button{padding:6px 16px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.sms-dropdown-done button:hover{background:#088587}
.sms-dropdown-done .count{font-size:12px;font-weight:600;color:var(--teal)}
.sms-recipient-summary{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
.sms-recipient-count{font-size:11px;font-weight:600;color:var(--teal);display:flex;align-items:center;gap:4px}
.sms-recipient-count .num{background:var(--teal);color:#fff;padding:1px 7px;border-radius:10px;font-size:10px}
.sms-edit-recipients{font-size:11px;color:var(--muted);cursor:pointer;border:none;background:none;font-family:inherit;text-decoration:underline}
.sms-edit-recipients:hover{color:var(--teal)}
/* CALL FETCH TRANSCRIPT BTN */
.call-fetch-btn{font-size:10px;font-weight:600;color:var(--muted);cursor:pointer;margin-top:6px;display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;transition:all .12s}
.call-fetch-btn:hover{background:var(--teal);color:#fff;border-color:var(--teal)}
.ai-agent-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:linear-gradient(135deg,rgba(30,75,160,.08),rgba(124,58,237,.08));border:1px solid rgba(124,58,237,.2);border-radius:10px;font-size:9px;font-weight:700;color:#7C3AED;letter-spacing:.3px;margin-left:6px}
.ai-agent-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,rgba(30,75,160,.06),rgba(124,58,237,.06));border:1px solid rgba(124,58,237,.15);border-radius:var(--rs);font-size:11px;font-weight:600;color:#7C3AED;margin-top:6px}
.reports-kpi.ai .kpi-val{color:#7C3AED}
.sms-toolbar{display:flex;align-items:center;gap:2px;padding:6px 8px;background:var(--surface2);border:1px solid var(--border);border-bottom:none;border-radius:var(--rs) var(--rs) 0 0}
.sms-tool-btn{width:30px;height:28px;border:none;background:none;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;font-weight:700;font-family:inherit;transition:all .1s}
.sms-tool-btn:hover{background:var(--border);color:var(--text)}
.sms-tool-btn.on{background:var(--tealLight);color:var(--teal)}
.sms-tool-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.sms-body-area{width:100%;min-height:120px;max-height:200px;background:var(--surface);border:1px solid var(--border);border-radius:0 0 var(--rs) var(--rs);padding:12px;font-size:13px;color:var(--text);font-family:inherit;outline:none;resize:vertical;line-height:1.6}
.sms-body-area:focus{border-color:var(--teal)}
.sms-body-area::placeholder{color:var(--dim)}
.sms-char-info{display:flex;justify-content:space-between;align-items:center;font-size:10px;color:var(--dim)}
.sms-char-warn{color:var(--orange)}
.sms-attach-section{display:flex;align-items:center;gap:8px}
.sms-attach-btn{display:inline-flex;align-items:center;gap:5px;padding:6px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;font-family:inherit;transition:all .12s}
.sms-attach-btn:hover{background:var(--border);color:var(--text)}
.sms-attach-btn svg{width:14px;height:14px}
.sms-attach-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.sms-attach-item{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);font-size:11px;color:var(--text)}
.sms-attach-item img{width:32px;height:32px;object-fit:cover;border-radius:4px}
.sms-attach-item .remove{cursor:pointer;color:var(--dim);font-size:14px;transition:color .1s}
.sms-attach-item .remove:hover{color:var(--red)}
.sms-footer{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-top:1px solid var(--border);background:var(--surface2);border-radius:0 0 16px 16px}
.sms-send-btn{padding:10px 24px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;transition:all .15s}
.sms-send-btn:hover{background:#088587}
.sms-send-btn:disabled{opacity:.5;cursor:not-allowed}
.sms-send-status{font-size:12px;color:var(--muted);max-width:280px}
.sms-send-progress{margin-top:8px;display:none}
.sms-send-progress.show{display:block}
.sms-progress-bar{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-bottom:6px}
.sms-progress-fill{height:100%;background:var(--teal);border-radius:2px;transition:width .3s}
.sms-progress-text{font-size:10px;color:var(--muted)}
/* FAB SMS */
.fab-sms{position:fixed;bottom:24px;right:90px;width:48px;height:48px;border-radius:50%;background:var(--teal);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(10,147,150,.4);display:none;align-items:center;justify-content:center;z-index:100;transition:all .15s}
.fab-sms:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(10,147,150,.5)}
.fab-sms svg{width:20px;height:20px}
/* REPORTS DASHBOARD */
.reports-wrap{padding:20px;overflow-y:auto;flex:1}
.reports-filters{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:20px;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r)}
.reports-filters label{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.reports-filters select{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:7px 10px;font-size:12px;color:var(--text);font-family:inherit;outline:none;min-width:140px}
.reports-filters select:focus{border-color:var(--teal)}
.reports-kpi-row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:20px}
.reports-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px;text-align:center}
.reports-kpi .kpi-val{font-size:28px;font-weight:700;color:var(--text);line-height:1.2}
.reports-kpi .kpi-label{font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:4px}
.reports-kpi .kpi-sub{font-size:11px;color:var(--dim);margin-top:2px}
.reports-kpi.inbound .kpi-val{color:var(--royal)}
.reports-kpi.outbound .kpi-val{color:var(--teal)}
.reports-kpi.sms .kpi-val{color:var(--orange)}
.reports-kpi.duration .kpi-val{color:var(--green)}
.reports-charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.reports-chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:16px}
.reports-chart-card h4{font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.reports-chart-card canvas{width:100%!important;max-height:280px}
.reports-chart-full{grid-column:1/-1}
.reports-table{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
.reports-table h4{font-size:13px;font-weight:700;color:var(--text);padding:14px 16px;border-bottom:1px solid var(--border);margin:0}
.reports-table table{width:100%;border-collapse:collapse;font-size:12px}
.reports-table th{background:var(--surface2);padding:8px 12px;text-align:left;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.reports-table td{padding:8px 12px;border-bottom:1px solid var(--border);color:var(--text)}
.reports-table tr:last-child td{border-bottom:none}
.reports-table tr:hover td{background:var(--surface2)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--light);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--dim)}
.sched-cell:hover{background:rgba(10,147,150,.04) !important}
.sched-cell:hover::before{content:'+';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:16px;color:var(--teal);font-weight:700;opacity:.25;pointer-events:none;z-index:0}
@keyframes otPulse{0%,100%{opacity:1}50%{opacity:.6}}
</style>
<script>
// Twilio Voice SDK loader with fallback
(function() {
  var script = document.createElement('script');
  script.src = 'https://sdk.twilio.com/js/voice/releases/2.11.0/twilio.min.js';
  script.onload = function() { console.log('Twilio Voice SDK loaded ‚úÖ'); };
  script.onerror = function() {
    console.warn('Twilio SDK CDN failed, trying unpkg fallback...');
    var s2 = document.createElement('script');
    s2.src = 'https://unpkg.com/@twilio/voice-sdk@2.11.0/dist/twilio.min.js';
    s2.onload = function() { console.log('Twilio Voice SDK loaded via unpkg ‚úÖ'); };
    s2.onerror = function() { console.error('Twilio Voice SDK failed to load from both CDNs'); };
    document.head.appendChild(s2);
  };
  document.head.appendChild(script);
})();
</script>
</head>
<body>
<div id="loginScreen" class="login-wrap">
<div class="login-card">
<div class="logo-mark">DCS</div>
<h1>Titus CRM</h1>
<p class="sub">Delta Community Support Phone System</p>
<div id="loginError" class="login-err"></div>
<div class="fg"><label>Email</label><input type="email" id="loginEmail" placeholder="you@deltacommunity.com.au"></div>
<div class="fg"><label>Password</label><input type="password" id="loginPassword" placeholder="Enter password"></div>
<button class="btn btn-p" id="loginBtn">Sign In</button>
</div>
</div>
<div id="dashboard" class="app">
<div class="sidebar">
<div class="sb-brand"><div class="logo-mark">DCS</div><div><div class="sb-brand-text">Titus CRM</div><div class="sb-brand-sub">Delta Community Support</div></div></div>
<div id="tzBar" class="tz-bar" style="display:none"></div>
<button class="sb-collapse-btn" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 19l-7-7 7-7"/><path d="M18 19l-7-7 7-7" opacity=".4"/></svg><span class="sb-collapse-label">Hide Menu</span></button>
<div class="sb-nav">
<button class="sb-item" data-view="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span class="sb-item-label">Dashboard</span></button>
<button class="sb-item" data-view="inbox" onclick="toggleInboxMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg><span class="sb-item-label">Inbox</span><span class="badge-dot" id="convCount" style="display:none">0</span><span class="sb-arrow sb-item-label">‚ñæ</span></button>
<div class="sb-sub" id="inboxSub">
<button class="sb-sub-item" data-view="conversations" onclick="setInboxView('conversations')"><span class="sb-item-label">üí¨ Conversations</span></button>
<button class="sb-sub-item" data-view="dialer" onclick="setInboxView('dialer')"><span class="sb-item-label">üìû Dialer</span></button>
<button class="sb-sub-item" data-view="agent" onclick="setInboxView('agent')"><span class="sb-item-label">ü§ñ AI Agent</span></button>
<button class="sb-sub-item" data-view="tasks" onclick="setInboxView('tasks')"><span class="sb-item-label">üìã Tasks</span></button>
<button class="sb-sub-item" id="navCallWorkflow" data-view="callWorkflow" onclick="setInboxView('callWorkflow')" style="display:none"><span class="sb-item-label">üîÄ Call Workflow</span></button>
</div>
<button class="sb-item" data-view="contacts" onclick="toggleContactsMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span class="sb-item-label">Contacts</span><span class="sb-arrow sb-item-label">‚ñæ</span></button>
<div class="sb-sub" id="contactsSub">
<button class="sb-sub-item" data-view="contacts" data-subview="overview" onclick="setContactsView('overview')"><span class="sb-item-label">üìä Overview</span></button>
<button class="sb-sub-item" data-view="contacts" data-subview="all" onclick="setContactsView('all')"><span class="sb-item-label">üë• All Contacts</span></button>
<button class="sb-sub-item" data-view="sendClientAgreement" onclick="setContactsView('sendClientAgreement')"><span class="sb-item-label">üìÑ Send Client Agreement</span></button>
<button class="sb-sub-item" data-view="sendEmploymentContract" onclick="setContactsView('sendEmploymentContract')"><span class="sb-item-label">üìù Send Employment Contract</span></button>
<button class="sb-sub-item" data-view="sendContractorAgreement" onclick="setContactsView('sendContractorAgreement')"><span class="sb-item-label">üìã Send Contractor Agreement</span></button>
</div>
<button class="sb-item" data-view="leads" onclick="toggleLeadsMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span class="sb-item-label">Leads</span><span class="sb-arrow sb-item-label">‚ñæ</span></button>
<div class="sb-sub" id="leadsSub">
<button class="sb-sub-item" data-view="leads" data-subview="overview" onclick="setLeadsView('overview')"><span class="sb-item-label">üìä Overview</span></button>
<button class="sb-sub-item" data-view="leads" data-subview="list" onclick="setLeadsView('list')"><span class="sb-item-label">üìã List</span></button>
<button class="sb-sub-item" data-view="leads" data-subview="kanban" onclick="setLeadsView('kanban')"><span class="sb-item-label">üìå Kanban</span></button>
</div>
<button class="sb-item" data-view="recruit" onclick="toggleRecruitMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg><span class="sb-item-label">HR / Recruit</span><span class="sb-arrow sb-item-label">‚ñæ</span></button>
<div class="sb-sub" id="recruitSub">
<button class="sb-sub-item" data-view="recruit" data-subview="overview" onclick="setRecruitView('overview')"><span class="sb-item-label">Overview</span></button>
<button class="sb-sub-item" data-view="recruit" data-subview="list" onclick="setRecruitView('list')"><span class="sb-item-label">üìã List</span></button>
<button class="sb-sub-item" data-view="recruit" data-subview="kanban" onclick="setRecruitView('kanban')"><span class="sb-item-label">üìå Kanban</span></button>
<button class="sb-sub-item" data-view="recruit" data-subview="lms" onclick="setRecruitView('lms')"><span class="sb-item-label">üéì LMS</span></button>
</div>
<button class="sb-item" data-view="rosters" onclick="toggleRostersMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class="sb-item-label">Rosters</span><span class="sb-arrow sb-item-label">‚ñæ</span></button>
<div class="sb-sub" id="rostersSub">
<button class="sb-sub-item" data-view="rosters" data-subview="scheduler" onclick="setRostersView('scheduler')"><span class="sb-item-label">üìÖ Scheduler</span></button>
<button class="sb-sub-item" data-view="rosters" data-subview="accommodation" onclick="setRostersView('accommodation')"><span class="sb-item-label">üè† Accommodation</span></button>
<button class="sb-sub-item" data-view="rosters" data-subview="clientBudget" onclick="setRostersView('clientBudget')"><span class="sb-item-label">üí∞ Client Budget</span></button>
</div>
<button class="sb-item" data-view="reports" onclick="toggleReportsMenu(event)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg><span class="sb-item-label">Reports</span><span class="sb-arrow sb-item-label">‚ñæ</span></button>
<div class="sb-sub" id="reportsSub">
<button class="sb-sub-item" data-view="reports" data-subview="reports" onclick="setReportsMenuView('reports')"><span class="sb-item-label">üìä Reports</span></button>
<button class="sb-sub-item" data-view="reports" data-subview="registers" onclick="setReportsMenuView('registers')"><span class="sb-item-label">üìã Registers</span></button>
<button class="sb-sub-item" data-view="reports" data-subview="files" onclick="setReportsMenuView('files')"><span class="sb-item-label">üìÅ Files</span></button>
<button class="sb-sub-item" data-view="reports" data-subview="auditLog" onclick="setReportsMenuView('auditLog')"><span class="sb-item-label">üîç Audit Log</span></button>
<button class="sb-sub-item" data-view="reports" data-subview="receipts" onclick="setReportsMenuView('receipts')"><span class="sb-item-label">üßæ Receipts</span></button>
<button class="sb-sub-item" data-view="reports" data-subview="ndisReports" onclick="setReportsMenuView('ndisReports')"><span class="sb-item-label">üìë NDIS Reports</span></button>
</div>

<button class="sb-item" data-view="admin" id="navAdmin" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span class="sb-item-label">User Management</span></button>
</div>
<div class="sb-footer"><div class="sb-user"><div class="sb-avatar" id="userAvatar"></div><div class="sb-user-info"><div class="sb-user-name" id="userName"></div><div class="sb-user-status">Online</div></div><button class="sb-signout" id="logoutBtn">Sign Out</button></div></div>
</div>
<div class="mid-panel" id="midPanel">
<div class="mid-hdr"><h2 id="midTitle">Conversations</h2><input class="mid-search" id="midSearch" placeholder="Search conversations..."></div>
<div class="mid-tabs" id="midTabs"><button class="mid-tab on" data-filter="all">All</button><button class="mid-tab" data-filter="calls">Calls</button><button class="mid-tab" data-filter="sms">SMS</button></div>
<div class="conv-list" id="midList"></div>
</div>
<div class="right-panel" id="rightPanel">
<div class="rp-empty" id="rpEmpty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--light)"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Select a conversation to view details</div>
</div>
</div>
<button class="fab-dial" id="fabDial" onclick="openDialer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>
<div class="dialer-overlay" id="dialerOverlay">
<div class="dialer-modal">
<div class="dialer-modal-hdr"><h3>Dialer</h3><div class="dialer-modal-close" onclick="closeDialer()">&times;</div></div>
<div class="dialer-wrap">
<div id="dialerSoftphoneStatus" style="width:100%;display:flex;align-items:center;gap:8px;padding:7px 12px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);font-size:11px;font-weight:600;color:var(--muted)"><span id="dialerSoftphoneDot" style="width:8px;height:8px;border-radius:50%;background:#94a3b8;flex-shrink:0;display:inline-block"></span><span id="dialerSoftphoneLabel">Checking softphone...</span></div>
<div class="dialer-search"><label>Destination Number or Contact Name</label><input id="dialSearch" placeholder="Type number or search contacts..." oninput="dialSearchOrNumber(this.value)" onfocus="dialSearchContacts(this.value)" onkeydown="if(event.key==='Enter'){event.preventDefault();dialCall()}"><div class="dialer-results" id="dialResults"></div></div>
<div class="dialer-display" id="dialDisplay"><span>Enter number</span></div>
<div class="dialer-pad" id="dialPad"></div>
<div class="dialer-actions">
<button class="dial-call del-btn" onclick="dialDelete()" title="Delete">&#9003;</button>
<button id="dialCallBtn" class="dial-call" style="background:var(--green)" onclick="dialCall()" title="Call"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="26" height="26"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>
<button class="dial-call" style="background:var(--teal);width:46px;height:46px" onclick="dialToggleSms()" title="SMS"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button>
</div>
<div class="dialer-status" id="dialStatus"></div>
<div class="dialer-sms-area" id="dialSmsArea" style="display:none"></div>

</div>
</div>
</div>
<!-- SMS FAB -->
<button class="fab-sms" id="fabSms" onclick="openSmsComposer()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button>
<!-- SMS COMPOSE MODAL -->
<div class="sms-overlay" id="smsOverlay">
<div class="sms-modal">
<div class="sms-modal-hdr"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> New Message <div class="sms-type-toggle"><button class="sms-type-btn on" id="smsTypeSms" onclick="setSmsType('sms')">SMS</button><button class="sms-type-btn" id="smsTypeMms" onclick="setSmsType('mms')">MMS</button></div></h3><div class="sms-modal-close" onclick="closeSmsComposer()">&times;</div></div>
<div class="sms-compose-wrap">
<div class="sms-to-section">
<label>To <span style="font-weight:400;text-transform:none;letter-spacing:0">(click contacts or type number)</span></label>
<div class="sms-recipients-box" id="smsRecipientsBox" onclick="document.getElementById('smsToInput').focus()">
<div id="smsRecipientTags"></div>
<input class="sms-to-input" id="smsToInput" placeholder="Search contacts or enter number..." oninput="smsSearchRecipients(this.value)" onfocus="smsSearchRecipients(this.value)" onkeydown="smsInputKeydown(event)">
</div>
<div class="sms-recipient-summary" id="smsRecipientSummary" style="display:none">
<div class="sms-recipient-count"><span class="num" id="smsRecipientNum">0</span> recipients selected</div>
<button class="sms-edit-recipients" onclick="document.getElementById('smsToInput').focus();smsSearchRecipients('')">Edit recipients</button>
</div>
<div class="sms-contact-dropdown" id="smsContactDropdown">
<div class="sms-select-all" onclick="smsSelectAll()"><div class="sms-contact-check" id="smsSelectAllCheck"></div> Select All Contacts</div>
<div id="smsContactList"></div>
<div class="sms-dropdown-done"><span class="count" id="smsDropdownCount">0 selected</span><button onclick="smsCloseDropdown()">Done ‚úì</button></div>
</div>
</div>
<div>
<div class="sms-toolbar" id="smsToolbar" style="display:none">
<button class="sms-tool-btn" onclick="smsFmt('bold')" title="Bold"><b>B</b></button>
<button class="sms-tool-btn" onclick="smsFmt('italic')" title="Italic"><i>I</i></button>
<button class="sms-tool-btn" onclick="smsFmt('underline')" title="Underline"><u>U</u></button>
<div class="sms-tool-sep"></div>
<button class="sms-tool-btn" onclick="smsInsertEmoji()" title="Emoji" style="font-weight:400">üòä</button>
<button class="sms-tool-btn" onclick="smsInsertTemplate()" title="Template" style="font-weight:400;font-size:11px">üìã</button>
</div>
<textarea class="sms-body-area" id="smsBodyInput" placeholder="Type your message..." oninput="smsUpdateCharCount()"></textarea>
</div>
<div class="sms-char-info">
<div id="smsCharCount">0 / 160 characters (1 segment)</div>
<div id="smsMmsNote" style="display:none;color:var(--teal);font-weight:600">MMS ‚Äî images &amp; longer text supported</div>
</div>
<div id="smsAttachSection" style="display:none">
<div class="sms-attach-section">
<label class="sms-attach-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg> Attach Image<input type="file" id="smsFileInput" accept="image/*" onchange="smsHandleAttachment(this)" style="display:none" multiple></label>
<span id="smsAttachInfo" style="font-size:11px;color:var(--dim)">Max 5MB per image</span>
</div>
<div class="sms-attach-preview" id="smsAttachPreview"></div>
</div>
</div>
<div class="sms-footer">
<div>
<div class="sms-send-status" id="smsSendStatus"></div>
<div class="sms-send-progress" id="smsSendProgress"><div class="sms-progress-bar"><div class="sms-progress-fill" id="smsSendProgressFill" style="width:0%"></div></div><div class="sms-progress-text" id="smsSendProgressText">Sending 0 / 0</div></div>
</div>
<button class="sms-send-btn" id="smsSendBtn" onclick="smsSendAll()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send</button>
</div>
</div>
</div>
<script>
var token=localStorage.getItem("titus_token");var currentUser=null;try{currentUser=JSON.parse(localStorage.getItem("titus_user"))}catch(e){}
var calls=[],smsList=[],emailList=[],participants=[],contacts=[],users=[],conversations=[],clientsList=[];var currentView="conversations",selectedConv=null,convFilter="calls";var socket=io();
var dialerNumber="",dialerContactName="";
var contactFilter=[];
var AU_TIMEZONES={QLD:"Australia/Brisbane",NSW:"Australia/Sydney",VIC:"Australia/Melbourne",SA:"Australia/Adelaide",NT:"Australia/Darwin",WA:"Australia/Perth",TAS:"Australia/Hobart",ACT:"Australia/Sydney"};
function getAppTimezone(){return window._appTimezone||localStorage.getItem("titus_timezone")||"QLD"}
function fmtTimeInTZ(iso){if(!iso)return"";try{return new Date(iso).toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true,timeZone:AU_TIMEZONES[getAppTimezone()]||"Australia/Brisbane"})}catch(e){return""}}
function fmtDateInTZ(iso){if(!iso)return"";try{return new Date(iso).toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric",timeZone:AU_TIMEZONES[getAppTimezone()]||"Australia/Brisbane"})}catch(e){return""}}
function updateTzBar(){var bar=document.getElementById("tzBar");if(!bar)return;var tz=getAppTimezone();try{var now=new Date().toLocaleString("en-AU",{timeZone:AU_TIMEZONES[tz],weekday:"short",day:"numeric",month:"short",hour:"2-digit",minute:"2-digit",second:"2-digit"});bar.innerHTML='<span style="opacity:.7">üïí</span> <span class="tz-time">'+now+'</span> <span style="color:rgba(255,255,255,.5)">'+tz+'</span>';bar.style.display="flex"}catch(e){bar.style.display="none"}}
setInterval(updateTzBar,1000);
function apiCall(method,url,body){var headers={"Content-Type":"application/json"};if(token)headers["Authorization"]="Bearer "+token;var opts={method:method,headers:headers};if(body)opts.body=JSON.stringify(body);return fetch(url,opts).then(function(r){if(r.status===401){localStorage.removeItem("titus_token");localStorage.removeItem("titus_user");location.reload()}return r.json()})}
function showLogin(){document.getElementById("loginScreen").style.display="flex";document.getElementById("dashboard").style.display="none";document.getElementById("fabDial").style.display="none";document.getElementById("fabSms").style.display="none"}
// ‚îÄ‚îÄ Permission helpers ‚îÄ‚îÄ
var PERM_KEYS=[
{key:"dashboard",label:"Dashboard",group:"Main",icon:"üìä"},
{key:"conversations",label:"Conversations",group:"Inbox",icon:"üí¨"},
{key:"dialer",label:"Dialer",group:"Inbox",icon:"üìû"},
{key:"agent",label:"AI Agent",group:"Inbox",icon:"ü§ñ"},
{key:"tasks",label:"Tasks",group:"Inbox",icon:"üìã"},
{key:"contacts",label:"Contacts",group:"Main",icon:"üë•"},
{key:"leads_list",label:"Leads ‚Äî List",group:"Leads",icon:"üìã"},
{key:"leads_kanban",label:"Leads ‚Äî Kanban",group:"Leads",icon:"üìå"},
{key:"recruit_overview",label:"HR ‚Äî Overview",group:"HR / Recruit",icon:"üìà"},
{key:"recruit_list",label:"HR ‚Äî List",group:"HR / Recruit",icon:"üìã"},
{key:"recruit_kanban",label:"HR ‚Äî Kanban",group:"HR / Recruit",icon:"üìå"},
{key:"recruit_lms",label:"HR ‚Äî LMS",group:"HR / Recruit",icon:"üéì"},
{key:"recruit_cvupload",label:"HR ‚Äî CV Upload",group:"HR / Recruit",icon:"üìÑ"},
{key:"scheduler",label:"Scheduler",group:"Rosters",icon:"üìÖ"},
{key:"accommodation",label:"Accommodation",group:"Rosters",icon:"üè†"},
{key:"clientBudget",label:"Client Budget",group:"Rosters",icon:"üí∞"},
{key:"reports",label:"Reports",group:"Reports",icon:"üìä"},
{key:"registers",label:"Registers",group:"Reports",icon:"üìã"},
{key:"files",label:"Files",group:"Reports",icon:"üìÅ"},
{key:"auditLog",label:"Audit Log",group:"Reports",icon:"üîç"},
{key:"admin",label:"User Management",group:"System",icon:"‚öôÔ∏è"}
];
function getPermKey(view,sub){
// Map currentView + subView to permission key
if(view==="leads"){return sub==="kanban"?"leads_kanban":"leads_list"}
if(view==="recruit"){
if(sub==="kanban")return "recruit_kanban";
if(sub==="list")return "recruit_list";
if(sub==="lms")return "recruit_lms";
if(sub==="cvupload")return "recruit_cvupload";
return "recruit_overview";
}
return view;
}
function hasAccess(permKey,level){
if(!currentUser)return false;
if(currentUser.role==="superadmin")return true;
var perms=currentUser.permissions||{};
var val=perms[permKey]||"edit";
if(level==="view")return val==="view"||val==="edit";
if(level==="edit")return val==="edit";
return val!=="none";
}
function canView(permKey){return hasAccess(permKey,"view")}
function canEdit(permKey){return hasAccess(permKey,"edit")}

function applySidebarPermissions(){
if(!currentUser)return;
var perms=currentUser.permissions||{};
if(currentUser.role==="superadmin")return; // superadmin sees all

// Main items
var viewMap={
"dashboard":"dashboard","contacts":"contacts","admin":"admin"
};
document.querySelectorAll(".sb-item").forEach(function(btn){
var view=btn.getAttribute("data-view");
if(!view)return;
var key=viewMap[view];
if(key&&perms[key]==="none"){btn.style.display="none"}
});

// Inbox parent: hide if ALL sub-items are none
var inboxKeys=["conversations","dialer","agent","tasks"];
var inboxAll=inboxKeys.every(function(k){return perms[k]==="none"});
if(inboxAll){var ib=document.querySelector('[data-view="inbox"]');if(ib)ib.style.display="none";var is=document.getElementById("inboxSub");if(is)is.style.display="none"}
else{
inboxKeys.forEach(function(k){
var btn=document.querySelector('#inboxSub [data-view="'+k+'"]');
if(btn&&perms[k]==="none")btn.style.display="none";
});
}

// Leads parent
var leadsKeys=["leads_list","leads_kanban"];
var leadsAll=leadsKeys.every(function(k){return perms[k]==="none"});
if(leadsAll){var lb=document.querySelector('[data-view="leads"]');if(lb)lb.style.display="none";var ls=document.getElementById("leadsSub");if(ls)ls.style.display="none"}
else{
if(perms["leads_list"]==="none"){var ll=document.querySelector('#leadsSub [data-subview="list"]');if(ll)ll.style.display="none"}
if(perms["leads_kanban"]==="none"){var lk=document.querySelector('#leadsSub [data-subview="kanban"]');if(lk)lk.style.display="none"}
}

// Recruit parent
var recruitKeys=["recruit_overview","recruit_list","recruit_kanban","recruit_lms","recruit_cvupload"];
var recruitAll=recruitKeys.every(function(k){return perms[k]==="none"});
if(recruitAll){var rb=document.querySelector('[data-view="recruit"]');if(rb)rb.style.display="none";var rs=document.getElementById("recruitSub");if(rs)rs.style.display="none"}
else{
var rSubMap={"recruit_overview":"overview","recruit_list":"list","recruit_kanban":"kanban","recruit_lms":"lms"};
Object.keys(rSubMap).forEach(function(pk){
if(perms[pk]==="none"){var b=document.querySelector('#recruitSub [data-subview="'+rSubMap[pk]+'"]');if(b)b.style.display="none"}
});
}

// Rosters parent
var rosterKeys=["scheduler","accommodation","clientBudget"];
var rostersAll=rosterKeys.every(function(k){return perms[k]==="none"});
if(rostersAll){var rob=document.querySelector('[data-view="rosters"]');if(rob)rob.style.display="none";var ros=document.getElementById("rostersSub");if(ros)ros.style.display="none"}
else{
rosterKeys.forEach(function(k){
var b=document.querySelector('#rostersSub [data-subview="'+k+'"]');
if(b&&perms[k]==="none")b.style.display="none";
});
}

// Reports parent
var reportKeys=["reports","registers","files","auditLog"];
var reportsAll=reportKeys.every(function(k){return perms[k]==="none"});
if(reportsAll){var rpb=document.querySelector('.sb-item[data-view="reports"]');if(rpb)rpb.style.display="none";var rps=document.getElementById("reportsSub");if(rps)rps.style.display="none"}
else{
reportKeys.forEach(function(k){
var sv=k==="reports"?"reports":k;
var b=document.querySelector('#reportsSub [data-subview="'+sv+'"]');
if(b&&perms[k]==="none")b.style.display="none";
});
}
}

function showDashboard(){document.getElementById("loginScreen").style.display="none";document.getElementById("dashboard").style.display="grid";document.getElementById("fabDial").style.display="none";document.getElementById("fabSms").style.display="none";var initials=(currentUser.name||currentUser.email).substring(0,2).toUpperCase();document.getElementById("userAvatar").textContent=initials;document.getElementById("userName").textContent=currentUser.name||currentUser.email;if(currentUser.role==="superadmin"||canView("admin"))document.getElementById("navAdmin").style.display="flex";if(currentUser.role==="superadmin"){var cwNav=document.getElementById("navCallWorkflow");if(cwNav)cwNav.style.display="flex";}applySidebarPermissions();renderImpersonationBanner();updateTzBar();initDialerPad();loadData();setTimeout(function(){initTwilioDevice();renderSoftphoneIndicator();},2000)}
function loadData(){
  // Load timezone from server ‚Äî always overrides localStorage so all users get same TZ
  apiCall("GET","/api/settings/timezone").then(function(d){
    var tz = (d&&d.timezone)||"QLD";
    window._appTimezone=tz;
    localStorage.setItem("titus_timezone",tz);
    updateTzBar();
  }).catch(function(){
    // Fallback to QLD if server unreachable
    window._appTimezone="QLD";
    localStorage.setItem("titus_timezone","QLD");
    updateTzBar();
  });
  apiCall("GET","/api/calls").then(function(d){calls=d||[];buildConversations();render();autoSyncTranscripts()});apiCall("GET","/api/sms").then(function(d){smsList=d||[];buildConversations();render()});emailList=[];apiCall("GET","/api/participants").then(function(d){participants=d||[]});apiCall("GET","/api/contacts").then(function(d){contacts=d||[];buildConversations();render()});apiCall("GET","/api/clients").then(function(d){clientsList=d||[];console.log("Clients loaded from Clients table:",clientsList.length)}).catch(function(){clientsList=[]})}
var _autoSynced=false;function autoSyncTranscripts(){if(_autoSynced)return;var missing=calls.filter(function(c){return!c.transcript&&c.status==="completed"&&c.duration>0});if(missing.length>0){_autoSynced=true;console.log("Auto-syncing transcripts for",missing.length,"calls");apiCall("POST","/api/transcripts/bulk-fetch",{}).then(function(d){console.log("Bulk fetch started:",d);setTimeout(function(){apiCall("GET","/api/calls").then(function(d2){calls=d2||[];buildConversations();render()})},12000)})}}
function bulkFetchTranscripts(){var btn=document.getElementById("bulkFetchBtn");if(btn){btn.innerHTML="‚è≥ Fetching all transcripts...";btn.disabled=true;btn.style.opacity=".6"}apiCall("POST","/api/transcripts/bulk-fetch",{}).then(function(d){if(btn)btn.innerHTML="‚è≥ Processing "+((d&&d.total)||"")+" calls...";setTimeout(function(){apiCall("GET","/api/calls").then(function(d2){calls=d2||[];buildConversations();render();if(btn){btn.innerHTML="‚úÖ Done ‚Äî Fetch All Transcripts";btn.disabled=false;btn.style.opacity="1"}})},10000)}).catch(function(){if(btn){btn.innerHTML="‚ùå Failed ‚Äî Fetch All Transcripts";btn.disabled=false;btn.style.opacity="1"}})}
function getInitials(name){if(!name||name==="Unknown"||typeof name!=="string")return"?";var n=name.trim();if(!n)return"?";if(n.indexOf("@")>=0)n=n.split("@")[0];var parts=n.split(" ").filter(function(p){return p.length>0});return parts.length>1?(parts[0][0]+parts[parts.length-1][0]).toUpperCase():n.substring(0,2).toUpperCase()}
function fmtTime(iso){if(!iso)return"";try{
  var tz=AU_TIMEZONES[getAppTimezone()]||"Australia/Brisbane";
  var d=new Date(iso);var now=new Date();var diff=now-d;
  // Compare dates in the APP timezone, not UTC/browser local
  var dDateStr=d.toLocaleDateString("en-AU",{timeZone:tz,year:"numeric",month:"2-digit",day:"2-digit"});
  var nowDateStr=now.toLocaleDateString("en-AU",{timeZone:tz,year:"numeric",month:"2-digit",day:"2-digit"});
  if(diff<86400000*2&&dDateStr===nowDateStr)return fmtTimeInTZ(iso);
  if(diff<86400000*2)return"Yesterday";
  return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",timeZone:tz});
}catch(e){return""}}
function findContactName(phone){
  if(!phone)return"Unknown";
  // Normalise to digit-only last 9 digits for robust matching (handles +61/04 format differences)
  function normLast9(p){var d=(p||"").replace(/[^0-9]/g,"");return d.length>=9?d.slice(-9):d;}
  var clean9=normLast9(phone);
  if(!clean9)return"Unknown";
  for(var i=0;i<contacts.length;i++){var cp=normLast9(contacts[i].phone||"");if(cp&&cp===clean9)return contacts[i].name}
  for(var i=0;i<participants.length;i++){var pp=normLast9(participants[i].phone||participants[i].mobile||"");if(pp&&pp===clean9)return participants[i].name}
  return"Unknown";
}
function findContactByEmail(email){if(!email)return null;var e=email.toLowerCase();for(var i=0;i<contacts.length;i++){if((contacts[i].email||"").toLowerCase()===e)return contacts[i]}return null}
function findContactNameByEmail(email){var c=findContactByEmail(email);return c?c.name:(email||"Unknown")}
function findContactPhoneByEmail(email){var c=findContactByEmail(email);return c?(c.phone||""):""}
function isContactSaved(phone){if(!phone)return false;var clean=phone.replace(/[^0-9+]/g,"");for(var i=0;i<contacts.length;i++){var cp=(contacts[i].phone||"").replace(/[^0-9+]/g,"");if(cp&&(clean.indexOf(cp)>=0||cp.indexOf(clean)>=0))return true}return false}
function buildConversations(){var convMap={};
  function normalisePhone(p){if(!p)return "";var d=p.replace(/[^0-9]/g,"");if(d.match(/^614\d{8}$/))return "0"+d.substring(2);if(d.match(/^61\d{9}$/))return "0"+d.substring(2);return p;}
  calls.forEach(function(c){var phone=normalisePhone(c.type==="inbound"?c.from_number:c.to_number);if(!phone)return;if(!convMap[phone])convMap[phone]={phone:phone,email:"",name:c.participant||findContactName(phone),items:[],lastTime:null};convMap[phone].items.push({type:"call",data:c,time:c.created_at});if(!convMap[phone].lastTime||c.created_at>convMap[phone].lastTime)convMap[phone].lastTime=c.created_at;if(c.participant&&c.participant!=="Unknown")convMap[phone].name=c.participant});smsList.forEach(function(m){var phone=normalisePhone(m.direction==="inbound"?m.from_number:m.to_number);if(!phone)return;if(!convMap[phone])convMap[phone]={phone:phone,email:"",name:findContactName(phone),items:[],lastTime:null};convMap[phone].items.push({type:"sms",data:m,time:m.created_at});if(!convMap[phone].lastTime||m.created_at>convMap[phone].lastTime)convMap[phone].lastTime=m.created_at});var emailConvMap={};[].forEach(function(e){var otherEmail=e.direction==="inbound"?(e.from_address||"").toLowerCase():(e.to_address||"").toLowerCase();if(!otherEmail)return;if(!emailConvMap[otherEmail])emailConvMap[otherEmail]={items:[],name:e.direction==="inbound"?(e.from_name||otherEmail):(e.to_name||otherEmail)};emailConvMap[otherEmail].items.push({type:"email",data:e,time:e.received_at||e.sent_at||""})});Object.keys(emailConvMap).forEach(function(email){var ec=emailConvMap[email];var contact=findContactByEmail(email);var merged=false;if(contact&&contact.phone){var cleanPhone=(contact.phone||"").replace(/[^0-9+]/g,"");Object.keys(convMap).forEach(function(phone){var cp=phone.replace(/[^0-9+]/g,"");if(cp&&cleanPhone&&cp.length>=6&&(cp.indexOf(cleanPhone)>=0||cleanPhone.indexOf(cp)>=0)){ec.items.forEach(function(item){convMap[phone].items.push(item);if(item.time&&(!convMap[phone].lastTime||item.time>convMap[phone].lastTime))convMap[phone].lastTime=item.time});convMap[phone].email=email;if(contact.name)convMap[phone].name=contact.name;merged=true}})}if(!merged){var key="email:"+email;convMap[key]={phone:findContactPhoneByEmail(email),email:email,name:contact?contact.name:(ec.name||email),items:ec.items,lastTime:null};ec.items.forEach(function(item){if(item.time&&(!convMap[key].lastTime||item.time>convMap[key].lastTime))convMap[key].lastTime=item.time})}});conversations=Object.values(convMap).sort(function(a,b){return(b.lastTime||"").localeCompare(a.lastTime||"")})}
function render(){var midPanel=document.getElementById("midPanel");var rightPanel=document.getElementById("rightPanel");document.querySelectorAll(".sb-item").forEach(function(n){n.classList.remove("on")});var inboxViews=["conversations","dialer","agent","tasks","callWorkflow"];if(inboxViews.indexOf(currentView)>=0){var inboxBtn=document.querySelector('[data-view="inbox"]');if(inboxBtn)inboxBtn.classList.add("on");var inboxSub=document.getElementById("inboxSub");if(inboxSub&&!inboxSub.classList.contains("open"))inboxSub.classList.add("open");document.querySelectorAll("#inboxSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});var activeSub=document.querySelector('#inboxSub [data-view="'+currentView+'"]');if(activeSub)activeSub.classList.add("on")}else if(currentView==="leads"||currentView==="leadsOverview"){var leadsBtn=document.querySelector('[data-view="leads"]');if(leadsBtn)leadsBtn.classList.add("on");var leadsSub=document.getElementById("leadsSub");if(leadsSub&&!leadsSub.classList.contains("open"))leadsSub.classList.add("open");document.querySelectorAll("#leadsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});var activeLeadSub=document.querySelector('#leadsSub [data-subview="'+leadsSubView+'"]');if(activeLeadSub)activeLeadSub.classList.add("on")}else if(currentView==="recruit"){var recruitBtn=document.querySelector('[data-view="recruit"]');if(recruitBtn)recruitBtn.classList.add("on");var recruitSub=document.getElementById("recruitSub");if(recruitSub&&!recruitSub.classList.contains("open"))recruitSub.classList.add("open")}else if(currentView==="reports"||currentView==="registers"||currentView==="files"||currentView==="receipts"||currentView==="ndisReports"){var reportsBtn=document.querySelector('.sb-item[data-view="reports"]');if(reportsBtn)reportsBtn.classList.add("on");var reportsSub=document.getElementById("reportsSub");if(reportsSub&&!reportsSub.classList.contains("open"))reportsSub.classList.add("open");document.querySelectorAll("#reportsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});var _rptSubKey=currentView==="reports"?"reports":(currentView==="ndisReports"?"ndisReports":currentView);
var activeRptSub=document.querySelector('#reportsSub [data-subview="'+_rptSubKey+'"]');if(activeRptSub)activeRptSub.classList.add("on")}else if(currentView==="accommodation"||currentView==="scheduler"||currentView==="clientBudget"){var rostersBtn=document.querySelector('.sb-item[data-view="rosters"]');if(rostersBtn)rostersBtn.classList.add("on");var rostersSub=document.getElementById("rostersSub");if(rostersSub&&!rostersSub.classList.contains("open"))rostersSub.classList.add("open");document.querySelectorAll("#rostersSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});var activeRosSub=document.querySelector('#rostersSub [data-subview="'+currentView+'"]');if(activeRosSub)activeRosSub.classList.add("on")}else if(currentView==="contacts"||currentView==="contactsOverview"||currentView==="sendClientAgreement"||currentView==="sendEmploymentContract"||currentView==="sendContractorAgreement"){var contactsBtn=document.querySelector('.sb-item[data-view="contacts"]');if(contactsBtn)contactsBtn.classList.add("on");var contactsSub=document.getElementById("contactsSub");if(contactsSub&&!contactsSub.classList.contains("open"))contactsSub.classList.add("open");document.querySelectorAll("#contactsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});if(currentView==="contacts"){var activeCSub=document.querySelector('#contactsSub [data-subview="all"]');if(activeCSub)activeCSub.classList.add("on")}else{var activeCSub=document.querySelector('#contactsSub [data-view="'+currentView+'"]');if(activeCSub)activeCSub.classList.add("on")}}else{var activeNav=document.querySelector('.sb-item[data-view="'+currentView+'"]');if(activeNav)activeNav.classList.add("on")};if(currentView==="conversations"){midPanel.style.display="flex";midPanel.style.flexDirection="column";midPanel.style.overflow="hidden";rightPanel.style.gridColumn="";document.getElementById("midTitle").textContent="Conversations";document.getElementById("midSearch").placeholder="Search conversations...";document.getElementById("midTabs").style.display="flex";document.getElementById("midTabs").innerHTML='<button class="mid-tab'+(convFilter==="calls"?" on":"")+'" data-filter="calls">üìû Calls</button><button class="mid-tab'+(convFilter==="sms"?" on":"")+'" data-filter="sms">üí¨ SMS</button>';document.getElementById("midTabs").querySelectorAll(".mid-tab").forEach(function(t){t.addEventListener("click",function(){convFilter=this.getAttribute("data-filter");document.querySelectorAll("#midTabs .mid-tab").forEach(function(b){b.classList.remove("on")});this.classList.add("on");renderConvList()})});var _emailCount=emailList.length;var _convCount=conversations.filter(function(c){if(convFilter==="calls")return c.items.some(function(i){return i.type==="call"});if(convFilter==="sms")return c.items.some(function(i){return i.type==="sms"});if(convFilter==="email")return c.items.some(function(i){return i.type==="email"});return true}).length;document.getElementById("convCount").textContent=_convCount+" conversations"+(convFilter==="email"?" ("+_emailCount+" emails)":"");renderConvList();renderConvThread()}else if(currentView==="contactsOverview"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderContactsOverview()}else if(currentView==="contacts"){midPanel.style.display="flex";midPanel.style.flexDirection="column";midPanel.style.overflow="hidden";rightPanel.style.gridColumn="";document.getElementById("midTitle").textContent="Contacts";document.getElementById("midSearch").placeholder="Search contacts...";document.getElementById("midTabs").style.display="flex";var typeSet={};contacts.forEach(function(c){if(c.contactType)typeSet[c.contactType]=(typeSet[c.contactType]||0)+1});CONTACT_TYPES.forEach(function(t){if(!typeSet[t])typeSet[t]=0});var selTypes=Array.isArray(contactFilter)?contactFilter:[];var selLabel=selTypes.length===0?"All Contacts ("+contacts.length+")":selTypes.length===1?selTypes[0]+" ("+typeSet[selTypes[0]]+")":selTypes.length+" types selected";var ddHtml='<div style="width:100%"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Type of Contact (multi-select)</div><div style="position:relative" id="contactFilterWrap"><button onclick="toggleContactFilterDD()" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:7px 10px;font-size:12px;color:var(--text);font-family:inherit;outline:none;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center"><span>'+selLabel+'</span><span style="opacity:.5">‚ñæ</span></button><div id="contactFilterDD" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:50;max-height:280px;overflow-y:auto;margin-top:2px">';ddHtml+='<label style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border);font-weight:600"><input type="checkbox" onchange="toggleContactType(\'all\')"'+(selTypes.length===0?" checked":"")+'> All Contacts ('+contacts.length+')</label>';Object.keys(typeSet).sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())}).forEach(function(t){var checked=selTypes.indexOf(t)>=0;var cnt=typeSet[t];ddHtml+='<label style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;font-size:12px;'+(checked?"background:rgba(10,175,171,.06)":"")+(cnt===0?";opacity:.5":"")+'"><input type="checkbox" onchange="toggleContactType(\''+t.replace(/'/g,"\\'")+'\')"'+(checked?" checked":"")+'> <span class="contact-type-badge '+getContactTypeCss(t)+'" style="font-size:10px">'+t+'</span> <span style="opacity:.5;font-size:11px">('+cnt+')</span></label>'});ddHtml+='</div></div></div>';document.getElementById("midTabs").innerHTML=ddHtml;renderContactsList();renderContactDetail()}else if(currentView==="dialer"){openDialer();currentView="conversations";render()}else if(currentView==="agent"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderAIAgent()}else if(currentView==="tasks"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderTasks()}else if(currentView==="callWorkflow"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderCallWorkflow()}else if(currentView==="reports"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderReportsMenu()}else if(currentView==="dashboard"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderReports()}else if(currentView==="admin"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderAdmin()}else if(currentView==="recruit"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderRecruit()}else if(currentView==="leadsOverview"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderLeadsOverview()}else if(currentView==="leads"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderLeads()}else if(currentView==="accommodation"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderAccommodation()}else if(currentView==="scheduler"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderScheduler()}else if(currentView==="clientBudget"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderClientBudget()}else if(currentView==="registers"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderPlaceholder("Registers","üìã","Document registers and compliance tracking coming soon.")}else if(currentView==="files"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderCompanyFiles()}else if(currentView==="auditLog"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderAuditLog()}else if(currentView==="sendClientAgreement"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderSendDocPage("client")}else if(currentView==="sendEmploymentContract"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderSendDocPage("employment")}else if(currentView==="sendContractorAgreement"){midPanel.style.display="none";rightPanel.style.gridColumn="2 / -1";renderSendDocPage("contractor")}}

function renderConvList(){var list=document.getElementById("midList");var searchVal=document.getElementById("midSearch").value.toLowerCase();var filtered=conversations.filter(function(c){if(searchVal&&c.name.toLowerCase().indexOf(searchVal)<0&&(c.phone||"").indexOf(searchVal)<0&&(c.email||"").toLowerCase().indexOf(searchVal)<0)return false;if(convFilter==="calls")return c.items.some(function(i){return i.type==="call"});if(convFilter==="sms")return c.items.some(function(i){return i.type==="sms"});if(convFilter==="email")return c.items.some(function(i){return i.type==="email"});return true});if(filtered.length===0){list.innerHTML='<div class="empty-state">'+(convFilter==="email"?'No emails yet ‚Äî <a href="javascript:void(0)" onclick="syncEmails()" style="color:var(--teal)">Sync emails from Microsoft 365</a>':'No conversations yet')+'</div>';return}var html="";filtered.forEach(function(c){var isOn=selectedConv&&((selectedConv.phone&&selectedConv.phone===c.phone)||(selectedConv.email&&selectedConv.email===c.email));var lastItem=c.items.sort(function(a,b){return(b.time||"").localeCompare(a.time||"")})[0];var preview="";var hasCalls=c.items.some(function(i){return i.type==="call"});var hasSms=c.items.some(function(i){return i.type==="sms"});var hasEmail=c.items.some(function(i){return i.type==="email"});if(lastItem.type==="call")preview=(lastItem.data.status||"Call")+" \u2014 "+(lastItem.data.duration||0)+"s";else if(lastItem.type==="sms")preview=lastItem.data.body||"SMS";else if(lastItem.type==="email")preview=(lastItem.data.subject||"(No subject)")+" ‚Äî "+(lastItem.data.body_preview||"").substring(0,60);var badges="";var callItemCount=c.items.filter(function(i){return i.type==="call"}).length;var smsItemCount=c.items.filter(function(i){return i.type==="sms"}).length;if(hasCalls)badges+='<span class="conv-badge call">üìû '+callItemCount+'</span>';if(hasSms)badges+='<span class="conv-badge sms">üí¨ '+smsItemCount+'</span>';var emailItemCount=c.items.filter(function(i){return i.type==="email"}).length;if(hasEmail)badges+='<span class="conv-badge" style="background:rgba(99,102,241,.08);color:#6366F1">üìß '+emailItemCount+' email'+(emailItemCount!==1?"s":"")+'</span>';var hasAi=c.items.some(function(i){return i.type==="call"&&i.data.type==="inbound"});if(hasAi)badges+='<span class="conv-badge" style="background:rgba(124,58,237,.08);color:#7C3AED">ü§ñ AI</span>';var unread=c.items.filter(function(i){return i.type==="email"&&!i.data.is_read&&i.data.direction==="inbound"}).length;var convKey=c.phone||c.email||"";html+='<div class="conv-item'+(isOn?" on":"")+'" data-phone="'+convKey+'" data-email="'+(c.email||"")+'">';html+='<div class="conv-avatar">'+getInitials(c.name)+'</div>';html+='<div class="conv-body">';html+='<div class="conv-top"><span class="conv-name">'+(unread>0?'<strong>':'')+c.name+(unread>0?'</strong>':'')+'</span><span class="conv-time">'+fmtTime(c.lastTime)+'</span></div>';html+='<div class="conv-sub">'+(c.phone?(c.phone+(c.email?' ¬∑ '+c.email:'')):(c.email||''))+'</div>';html+='<div class="conv-preview">'+(unread>0?'<strong style="color:var(--teal)">['+unread+' new] </strong>':'')+preview+'</div>';if(badges)html+='<div class="conv-badges">'+badges+'</div>';html+='</div></div>'});list.innerHTML=html;list.querySelectorAll(".conv-item").forEach(function(el){el.addEventListener("click",function(){var phone=this.getAttribute("data-phone");var email=this.getAttribute("data-email");selectedConv=conversations.find(function(c){if(phone&&c.phone===phone)return true;if(email&&c.email===email)return true;return false})||null;render()})})}
function renderConvThread(){var rp=document.getElementById("rightPanel");if(!selectedConv||currentView!=="conversations"){if(currentView==="conversations")rp.innerHTML='<div class="rp-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--light)"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Select a conversation to view details<div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-teal" id="bulkFetchBtn" onclick="bulkFetchTranscripts()">üì• Fetch All Transcripts</button></div></div>';return}var c=selectedConv;var saved=c.phone?isContactSaved(c.phone):!!findContactByEmail(c.email);var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar">'+getInitials(c.name)+'</div><div><div class="rp-hdr-name">'+c.name+'</div><div class="rp-hdr-sub">'+(c.phone?(c.phone+(c.email?' ¬∑ '+c.email:'')):(c.email||''))+'</div></div></div>';html+='<div class="rp-hdr-actions">';if(!saved&&c.phone)html+='<button class="btn btn-teal" onclick="addConvAsContact(\''+c.phone+'\',\''+c.name+'\')">+ Save Contact</button>';if(!saved&&!c.phone&&c.email)html+='<button class="btn btn-teal" onclick="addEmailAsContact(\''+c.email+'\',\''+c.name+'\')">+ Save Contact</button>';if(c.phone){html+='<div class="rp-action" title="Call" onclick="openDialerWithNumber(\''+c.phone+'\',\''+c.name+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg></div>';html+='<div class="rp-action" title="Send SMS" onclick="focusSms()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>'}if(c.email){html+='<div class="rp-action" title="Send Email" onclick="openEmailCompose(\''+c.email+'\',\''+c.name+'\')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>'}html+='<button class="btn btn-s btn-sm" id="bulkFetchBtn" onclick="bulkFetchTranscripts()" title="Fetch all missing transcripts" style="font-size:10px;padding:4px 8px">üì• Fetch Transcripts</button></div></div>';html+='<div class="rp-thread" id="threadArea">';var items=c.items.sort(function(a,b){return(a.time||"").localeCompare(b.time||"")});var lastDate=null;items.forEach(function(item){var d=item.time?fmtDateInTZ(item.time):"Unknown date";if(d!==lastDate){html+='<div class="thread-date">'+d+'</div>';lastDate=d}if(item.type==="call"){var cd=item.data;var isOut=cd.type==="outbound";var timeStr=fmtTimeInTZ(cd.created_at);var durStr=cd.duration?cd.duration+"s":"0s";html+='<div class="msg-row'+(isOut?" out":"")+'">';if(!isOut)html+='<div class="msg-ava">'+getInitials(c.name)+'</div>';html+='<div><div class="msg-bubble">\u{1F4DE} <strong>'+(cd.type==="inbound"?"Inbound":"Outbound")+' call</strong> \u2014 '+(cd.status||"completed")+(cd.type==="inbound"?'<span class="ai-agent-badge">ü§ñ Denise AI</span>':'')+'<div style="font-size:11px;margin-top:4px;opacity:.85">\u{1F552} '+timeStr+' &nbsp; \u23F1 '+durStr+'</div></div>';if(cd.type==="inbound")html+='<div class="ai-agent-tag">ü§ñ Answered by Denise AI Agent</div>';if(cd.summary)html+='<div class="call-summary-box"><strong>AI Summary</strong>'+cd.summary+'</div>';if(cd.transcript){html+='<div class="call-transcript-btn" onclick="toggleTranscript(\'t'+cd.id+'\')">\u{1F4DD} View Transcript</div>';html+='<div class="call-transcript-box" id="t'+cd.id+'">'+cd.transcript+'</div>';if(cd.sid&&(cd.sid.substring(0,3)==='el_'||cd.recording_url)){html+='<div style="margin-top:8px" id="audio_wrap_'+cd.id+'"><button onclick="loadCallAudio(\'' + cd.sid + '\',\'' + cd.id + '\')" style="background:var(--teal);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px">‚ñ∂ Play Recording</button></div>';}}else if(cd.status==="completed"&&cd.duration>0){html+='<div class="call-fetch-btn" id="fetch'+cd.id+'" onclick="fetchCallTranscript(\''+cd.sid+'\','+cd.id+')">üîÑ Fetch Transcript</div>';if(cd.sid&&(cd.sid.substring(0,3)==='el_'||cd.recording_url)){html+='<div style="margin-top:8px" id="audio_wrap_'+cd.id+'"><button onclick="loadCallAudio(\'' + cd.sid + '\',\'' + cd.id + '\')" style="background:var(--teal);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px">‚ñ∂ Play Recording</button></div>';}}html+='<div class="msg-meta"><span class="msg-type-badge">Call</span> '+timeStr+'</div></div>';if(isOut)html+='<div class="msg-ava">'+getInitials(currentUser.name)+'</div>';html+='</div>'}else if(item.type==="sms"){var sm=item.data;var isOut=sm.direction==="outbound";html+='<div class="msg-row'+(isOut?" out":"")+'">';if(!isOut)html+='<div class="msg-ava">'+getInitials(c.name)+'</div>';var _smMedia=[];try{_smMedia=JSON.parse(sm.media_urls||'[]')}catch(x){}html+='<div><div class="msg-bubble">';if(sm.body)html+='<div>'+sm.body+'</div>';if(_smMedia.length>0){html+='<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:6px">';_smMedia.forEach(function(m){var isImg=m.type&&m.type.indexOf('image')>=0;if(isImg){html+='<a href="'+m.url+'" target="_blank"><img src="'+m.url+'" alt="'+m.name+'" style="max-width:200px;max-height:160px;border-radius:8px;border:1px solid var(--border);display:block;cursor:pointer" onerror="this.style.display=\'none\'"></a>';}else{html+='<a href="'+m.url+'" target="_blank" style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;color:var(--royal);text-decoration:none">üìé '+m.name+'</a>';}});html+='</div>';}html+='</div>';html+='<div class="msg-meta"><span class="msg-type-badge">SMS</span> '+fmtTimeInTZ(sm.created_at)+'</div></div>';if(isOut)html+='<div class="msg-ava">'+getInitials(currentUser.name)+'</div>';html+='</div>'}else if(item.type==="email"){var em=item.data;var isOut=em.direction==="outbound";var emailTime=em.received_at||em.sent_at||"";var _ec=isOut?"#3B82F6":"#6366F1";var _ecb=isOut?"rgba(59,130,246,":"rgba(99,102,241,";html+='<div class="msg-row'+(isOut?" out":"")+'">';if(!isOut)html+='<div class="msg-ava" style="background:rgba(99,102,241,.1);color:#6366F1;border:1px solid rgba(99,102,241,.2)">'+getInitials(em.from_name||c.name)+'</div>';html+='<div style="max-width:85%"><div class="msg-bubble" style="border-left:3px solid '+_ec+';'+(isOut?'background:rgba(59,130,246,.06)':'')+'">'+'<div style="font-size:10px;font-weight:700;color:'+_ec+';margin-bottom:4px;display:flex;align-items:center;gap:4px">üìß '+(isOut?"Sent":"Received")+' Email</div><div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:4px">'+(em.subject||"(No subject)")+'</div><div style="font-size:11px;color:var(--text2);line-height:1.5">'+(em.body_preview||"").substring(0,300)+(em.body_preview&&em.body_preview.length>300?"...":"")+'</div>'+(function(){var _a=[];try{_a=JSON.parse(em.attachments||"[]")}catch(x){};if(!_a||!_a.length)_a=em.attachmentsList||[];if(_a.length>0){var _ah="<div style=\"margin-top:8px;border-top:1px solid var(--border);padding-top:6px\">";_a.forEach(function(att){var sz=att.size>1048576?(att.size/1048576).toFixed(1)+" MB":att.size>0?(att.size/1024).toFixed(0)+" KB":"";_ah+="<div style=\"display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;color:var(--muted)\"><span>üìé</span><span style=\"font-weight:600;color:var(--text)\">"+att.name+"</span>"+(sz?" <span>("+sz+")</span>":"")+"</div>"});return _ah+"</div>"}else if(em.has_attachments){return'<div style="font-size:10px;color:var(--muted);margin-top:6px">üìé Has attachments</div>'}return""})()+'</div>';html+='<div style="display:flex;gap:6px;margin-top:4px">';html+='<div class="msg-meta"><span class="msg-type-badge" style="background:'+_ecb+'.08);color:'+_ec+'">Email</span> '+fmtTimeInTZ(emailTime)+'</div>';html+='<button onclick="viewFullEmail('+em.id+')" style="font-size:9px;padding:2px 8px;background:rgba(10,147,150,.06);color:var(--teal);border:1px solid rgba(10,147,150,.1);border-radius:4px;cursor:pointer;font-family:inherit;font-weight:600">View Full</button>';html+='<button onclick="openEmailForward('+(em.id)+',\''+(em.subject||"").replace(/'/g,"\\'")+'\')" style="font-size:9px;padding:2px 8px;background:rgba(99,102,241,.06);color:#6366F1;border:1px solid rgba(99,102,241,.1);border-radius:4px;cursor:pointer;font-family:inherit;font-weight:600">‚Ü™ Forward</button>';if(!isOut)html+='<button onclick="openEmailCompose(\''+(em.from_address||"").replace(/'/g,"\\'")+'\',\''+(em.from_name||"").replace(/'/g,"\\'")+'\',\'Re: '+(em.subject||"").replace(/'/g,"\\'")+'\')" style="font-size:9px;padding:2px 8px;background:rgba(10,147,150,.06);color:var(--teal);border:1px solid rgba(10,147,150,.1);border-radius:4px;cursor:pointer;font-family:inherit;font-weight:600">‚Ü© Reply</button>';html+='</div></div>';if(isOut)html+='<div class="msg-ava" style="background:rgba(59,130,246,.1);color:#3B82F6;border:1px solid rgba(59,130,246,.2)">'+getInitials(currentUser.name)+'</div>';html+='</div>'}});html+='</div>';html+='<div class="rp-compose" style="gap:6px">';if(c.phone)html+='<button onclick="focusSms()" style="flex:1;background:var(--teal);color:#fff;border:none;padding:10px 18px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Send SMS</button>';if(c.email)html+='<button onclick="openEmailCompose(\''+c.email+'\',\''+c.name+'\')" style="flex:1;background:#4F46E5;color:#fff;border:none;padding:10px 18px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px">üìß Send Email</button>';if(!c.phone&&!c.email)html+='<div style="flex:1;text-align:center;color:var(--muted);font-size:11px">No phone or email for this contact</div>';html+='</div>';rp.innerHTML=html;var area=document.getElementById("threadArea");if(area)area.scrollTop=area.scrollHeight}
function loadCallAudio(sid,callId){var wrap=document.getElementById('audio_wrap_'+callId);if(!wrap)return;wrap.innerHTML='<div style="font-size:11px;color:var(--muted);padding:4px 0">Loading audio...</div>';apiCall('GET','/api/calls/audio-token/'+sid).then(function(d){if(!d||!d.token){wrap.innerHTML='<div style="font-size:11px;color:red">Audio not available</div>';return;}wrap.innerHTML='<audio controls autoplay style="width:100%;height:36px;border-radius:8px" src="/api/calls/audio/'+d.token+'" preload="auto"><track kind="captions"></audio>';}).catch(function(){wrap.innerHTML='<div style="font-size:11px;color:red">Failed to load audio</div>';});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALL WORKFLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var cwGroups = [];
var cwUsers = [];
var cwTab = "groups"; // groups | availability
var cwEditGroup = null; // group being edited
var cwDragIdx = null;

function renderCallWorkflow() {
  if(currentUser.role !== "superadmin") {
    document.getElementById("rightPanel").innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted)">üîí Super Admin access required</div>';
    return;
  }
  Promise.all([
    apiCall("GET", "/api/call-workflow/groups"),
    apiCall("GET", "/api/admin/users"),
    apiCall("GET", "/api/availability"),
    apiCall("GET", "/api/availability/log"),
    apiCall("GET", "/api/settings/ai-enabled")
  ]).then(function(results) {
    cwGroups = results[0] || [];
    cwUsers = (results[1] || []).filter(function(u){ return u.id && u.name; });
    var availability = results[2] || [];
    var avLog = results[3] || [];
    var aiStatus = results[4] || {};
    window._cwAiEnabled = aiStatus.ai_enabled !== false;
    renderCallWorkflowUI(availability, avLog);
  }).catch(function(e) {
    document.getElementById("rightPanel").innerHTML = '<div style="padding:40px;text-align:center;color:red">Error loading Call Workflow: ' + e.message + '</div>';
  });
}

function renderCallWorkflowUI(availability, avLog) {
  var rp = document.getElementById("rightPanel");
  var statusColors = { available: "#10b981", busy: "#f59e0b", offline: "#94a3b8" };
  var strategyLabels = { sequential: "Sequential / Linear", roundrobin: "Round Robin", simultaneous: "Simultaneous / Blast", lru: "Least Recently Used" };
  var strategyIcons = { sequential: "‚û°Ô∏è", roundrobin: "üîÑ", simultaneous: "üì£", lru: "‚è±Ô∏è" };
  var strategyDesc = {
    sequential: "Rings person 1 for X seconds, then person 2, then person 3, etc.",
    roundrobin: "Distributes calls evenly across the group in rotation",
    simultaneous: "Rings everyone at once ‚Äî first to answer gets the call",
    lru: "Rings whoever hasn't taken a call the longest"
  };

  // Build availability map
  var availMap = {};
  availability.forEach(function(a){ availMap[a.user_id] = a; });

  var h = '<div style="padding:24px;max-width:1100px">';
  // Header
  h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">';
  h += '<div><h2 style="font-size:20px;font-weight:700;color:var(--text);margin:0">üîÄ Call Workflow</h2>';
  h += '<p style="font-size:12px;color:var(--muted);margin:4px 0 0">Configure hunt groups and monitor agent availability</p></div>';
  // Availability toggle for current user
  var myStatus = (availMap[currentUser.id] || {}).status || "offline";
  h += '<div style="display:flex;align-items:center;gap:8px">';
  h += '<span style="font-size:11px;color:var(--muted);font-weight:600">MY STATUS:</span>';
  ["available","busy","offline"].forEach(function(s){
    var active = myStatus === s;
    var col = statusColors[s];
    h += '<button data-avail-btn="\'+s+\'" onclick="setMyAvailability(\''+s+'\')" style="padding:6px 12px;border-radius:20px;border:2px solid '+(active?col:"var(--border)")+';background:'+(active?"rgba("+hexToRgb(col)+",.12)":"transparent")+';color:'+(active?col:"var(--muted)")+';font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s">'+(s==="available"?"üü¢":s==="busy"?"üü°":"‚ö´")+" "+s.charAt(0).toUpperCase()+s.slice(1)+'</button>';
  });
  h += '</div></div>';

  // AI Toggle banner
  var aiOn = window._cwAiEnabled !== false;
  h += '<div style="margin-bottom:16px;padding:14px 18px;background:'+(aiOn?'rgba(10,147,150,.06)':'rgba(239,68,68,.06)')+';border:2px solid '+(aiOn?'rgba(10,147,150,.2)':'rgba(239,68,68,.2)')+';border-radius:12px;display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="display:flex;align-items:center;gap:12px">';
  h += '<div style="width:40px;height:40px;border-radius:10px;background:'+(aiOn?'var(--teal)':'#ef4444')+';display:flex;align-items:center;justify-content:center;font-size:20px">ü§ñ</div>';
  h += '<div><div style="font-size:13px;font-weight:700;color:var(--text)">Denise AI Agent</div>';
  h += '<div style="font-size:11px;color:'+(aiOn?'#10b981':'#ef4444')+';font-weight:600">'+(aiOn?'‚óè Active ‚Äî answering inbound calls':'‚óè Disabled ‚Äî AI will not answer calls')+'</div>';
  h += '<div style="font-size:10px;color:var(--muted);margin-top:2px">ElevenLabs voice AI ‚Ä¢ Can be added as hunt group member</div>';
  h += '</div></div>';
  h += '<div style="display:flex;align-items:center;gap:10px">';
  h += '<span style="font-size:11px;color:var(--muted);font-weight:600">AI ANSWERING:</span>';
  h += '<button onclick="cwToggleAI(true)" style="padding:7px 16px;border-radius:20px;border:2px solid '+(aiOn?'var(--teal)':'var(--border)')+';background:'+(aiOn?'rgba(10,147,150,.12)':'transparent')+';color:'+(aiOn?'var(--teal)':'var(--muted)')+';font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">‚úÖ ON</button>';
  h += '<button onclick="cwToggleAI(false)" style="padding:7px 16px;border-radius:20px;border:2px solid '+(!aiOn?'#ef4444':'var(--border)')+';background:'+(!aiOn?'rgba(239,68,68,.12)':'transparent')+';color:'+(!aiOn?'#ef4444':'var(--muted)')+';font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">‚õî OFF</button>';
  h += '</div></div>';

  // Tabs
  h += '<div style="display:flex;gap:4px;margin-bottom:20px;border-bottom:2px solid var(--border)">';
  h += '<button onclick="cwTab=\'groups\';renderCallWorkflow()" class="cw-tab'+(cwTab==="groups"?" on":"")+'" style="padding:8px 16px;background:none;border:none;border-bottom:'+(cwTab==="groups"?"2px solid var(--teal)":"2px solid transparent")+';font-size:13px;font-weight:600;color:'+(cwTab==="groups"?"var(--teal)":"var(--muted)")+';cursor:pointer;font-family:inherit;margin-bottom:-2px">üîÄ Hunt Groups</button>';
  h += '<button onclick="cwTab=\'availability\';renderCallWorkflow()" class="cw-tab'+(cwTab==="availability"?" on":"")+'" style="padding:8px 16px;background:none;border:none;border-bottom:'+(cwTab==="availability"?"2px solid var(--teal)":"2px solid transparent")+';font-size:13px;font-weight:600;color:'+(cwTab==="availability"?"var(--teal)":"var(--muted)")+';cursor:pointer;font-family:inherit;margin-bottom:-2px">üìä Availability Log</button>';
  h += '</div>';

  if(cwTab === "groups") {
    // Hunt Groups tab
    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">';
    h += '<span style="font-size:13px;color:var(--muted)">'+cwGroups.length+' hunt group'+(cwGroups.length!==1?"s":"")+' configured</span>';
    h += '<button onclick="cwOpenEditor(null)" style="background:var(--teal);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">+ New Hunt Group</button>';
    h += '</div>';

    if(cwGroups.length === 0) {
      h += '<div style="text-align:center;padding:60px 20px;color:var(--muted)">';
      h += '<div style="font-size:40px;margin-bottom:12px">üîÄ</div>';
      h += '<div style="font-size:14px;font-weight:600;margin-bottom:8px">No hunt groups yet</div>';
      h += '<div style="font-size:12px">Create a hunt group to define how inbound calls are distributed to your team</div>';
      h += '</div>';
    } else {
      h += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px">';
      cwGroups.forEach(function(g) {
        var membersHtml = "";
        (g.members||[]).forEach(function(m,i) {
          var u = cwUsers.find(function(u){ return String(u.id)===String(m.userId); });
          var avail = availMap[m.userId];
          var st = (avail||{}).status||"offline";
          var col = statusColors[st];
          membersHtml += '<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--surface2);border-radius:6px;margin-bottom:4px">';
          membersHtml += '<span style="width:20px;height:20px;border-radius:50%;background:var(--teal);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+(i+1)+'</span>';
          membersHtml += '<span style="flex:1;font-size:12px;font-weight:600;color:var(--text)">'+(u?u.name:("User "+m.userId))+'</span>';
          membersHtml += '<span style="font-size:10px;color:'+col+';font-weight:600">‚óè  '+st+'</span>';
          if(g.strategy==="sequential") membersHtml += '<span style="font-size:10px;color:var(--muted)">'+m.ringSeconds+'s</span>';
          membersHtml += '</div>';
        });
        h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative">';
        h += '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px">';
        h += '<div><div style="font-size:15px;font-weight:700;color:var(--text)">'+(g.active?'<span style="color:#10b981">‚óè</span> ':'<span style="color:#94a3b8">‚óè</span> ')+g.name+'</div>';
        h += '<div style="display:flex;align-items:center;gap:6px;margin-top:4px"><span style="font-size:18px">'+(strategyIcons[g.strategy]||"üîÄ")+'</span><span style="font-size:11px;font-weight:600;color:var(--teal)">'+(strategyLabels[g.strategy]||g.strategy)+'</span></div>';
        h += '<div style="font-size:10px;color:var(--muted);margin-top:2px">'+(strategyDesc[g.strategy]||"")+'</div></div>';
        h += '<div style="display:flex;gap:6px">';
        h += '<button onclick="cwOpenEditorById('+g.id+')" style="padding:4px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;font-size:11px;cursor:pointer;font-family:inherit">‚úèÔ∏è Edit</button>';
        h += '<button onclick="cwDeleteGroup('+g.id+')" style="padding:4px 10px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);border-radius:6px;font-size:11px;cursor:pointer;font-family:inherit;color:#ef4444">üóëÔ∏è</button>';
        h += '</div></div>';
        h += '<div style="margin-top:8px">';
        h += '<div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Members ('+( g.members||[]).length+')</div>';
        h += membersHtml || '<div style="font-size:11px;color:var(--muted);font-style:italic;padding:4px 0">No members ‚Äî click Edit to add</div>';
        h += '</div></div>';
      });
      h += '</div>';
    }

  } else {
    // Availability Log tab
    h += '<div style="margin-bottom:16px;display:flex;align-items:center;justify-content:space-between">';
    h += '<span style="font-size:13px;color:var(--muted)">Current status of all agents + session history (last 7 days)</span>';
    h += '</div>';
    // Current status cards
    h += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px">';
    cwUsers.forEach(function(u) {
      var a = availMap[u.id] || {};
      var st = a.status || "offline";
      var col = statusColors[st];
      var since = a.changed_at ? fmtTimeInTZ(a.changed_at) : "‚Äî";
      h += '<div style="background:var(--surface);border:2px solid '+(st==="available"?"rgba(16,185,129,.2)":st==="busy"?"rgba(245,158,11,.2)":"var(--border)")+';border-radius:10px;padding:12px">';
      h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
      h += '<div style="width:32px;height:32px;border-radius:50%;background:var(--teal);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center">'+getInitials(u.name)+'</div>';
      h += '<div><div style="font-size:12px;font-weight:700;color:var(--text)">'+u.name+'</div>';
      h += '<div style="font-size:10px;color:'+col+';font-weight:600">'+( st==="available"?"üü¢":st==="busy"?"üü°":"‚ö´")+" "+st+'</div></div></div>';
      h += '<div style="font-size:10px;color:var(--muted)">Since: '+since+'</div>';
      h += '</div>';
    });
    h += '</div>';
    // Session log table
    h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden">';
    h += '<div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;color:var(--text)">üìã Session History</div>';
    h += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
    h += '<thead><tr style="background:var(--surface2)">';
    ["Agent","Status","Login Time","Logout Time","Duration"].forEach(function(col){
      h += '<th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">'+col+'</th>';
    });
    h += '</tr></thead><tbody>';
    // Group by user and filter to available/busy sessions
    var logByDate = avLog.filter(function(l){ return l.status === "available" || l.status === "busy"; });
    if(logByDate.length === 0) {
      h += '<tr><td colspan="5" style="padding:24px;text-align:center;color:var(--muted)">No availability sessions recorded yet</td></tr>';
    } else {
      logByDate.slice(0, 100).forEach(function(row) {
        var stCol = statusColors[row.status] || "#94a3b8";
        var dur = row.duration_secs ? formatDuration(row.duration_secs) : (row.ended_at ? "‚Äî" : "Active now");
        h += '<tr style="border-bottom:1px solid var(--border)">';
        h += '<td style="padding:8px 12px;font-weight:600;color:var(--text)">'+(row.name||row.email||"User "+row.user_id)+'</td>';
        h += '<td style="padding:8px 12px"><span style="color:'+stCol+';font-weight:600">'+( row.status==="available"?"üü¢":"üü°")+" "+row.status+'</span></td>';
        h += '<td style="padding:8px 12px;color:var(--text2)">'+fmtTimeInTZ(row.started_at)+' <span style="color:var(--muted);font-size:10px">'+fmtDateInTZ(row.started_at)+'</span></td>';
        h += '<td style="padding:8px 12px;color:var(--text2)">'+(row.ended_at ? fmtTimeInTZ(row.ended_at)+' <span style="color:var(--muted);font-size:10px">'+fmtDateInTZ(row.ended_at)+'</span>' : '<span style="color:#10b981;font-weight:600">Active</span>')+'</td>';
        h += '<td style="padding:8px 12px;color:var(--text2)">'+dur+'</td>';
        h += '</tr>';
      });
    }
    h += '</tbody></table></div></div>';
  }

  h += '</div>';

  // Editor modal
  if(cwEditGroup !== null) {
    h += cwRenderEditor();
  }

  rp.innerHTML = h;

  // Re-attach drag events if in editor
  if(cwEditGroup !== null) cwAttachDrag();
}

function hexToRgb(hex) {
  // handle named colors
  var map = {"#10b981":"16,185,129","#f59e0b":"245,158,11","#94a3b8":"148,163,184"};
  return map[hex] || "10,147,150";
}

function formatDuration(secs) {
  if(!secs) return "0s";
  var h = Math.floor(secs/3600);
  var m = Math.floor((secs%3600)/60);
  var s = secs%60;
  if(h>0) return h+"h "+m+"m";
  if(m>0) return m+"m "+s+"s";
  return s+"s";
}

function setMyAvailability(status) {
  apiCall("POST", "/api/availability", {status:status}).then(function(){
    renderCallWorkflow();
  });
}

function cwDeleteGroup(id) {
  if(!confirm("Delete this hunt group?")) return;
  apiCall("DELETE", "/api/call-workflow/groups/"+id).then(function(){
    renderCallWorkflow();
  });
}

function cwToggleAI(enabled) {
  apiCall("POST", "/api/settings/ai-enabled", { enabled: enabled }).then(function(d) {
    window._cwAiEnabled = d.ai_enabled;
    renderCallWorkflow();
  });
}

function cwOpenEditorById(id) {
  var group = cwGroups.find(function(g){ return String(g.id)===String(id); });
  if(group) cwOpenEditor(group);
}
function cwOpenEditor(group) {
  if(group) {
    // Parse group if it came as a string
    cwEditGroup = typeof group === "string" ? JSON.parse(group) : group;
  } else {
    cwEditGroup = { id: null, name: "", strategy: "sequential", ring_seconds: 20, members: [], active: true };
  }
  renderCallWorkflow();
}

function cwCloseEditor() {
  cwEditGroup = null;
  renderCallWorkflow();
}

function cwRenderEditor() {
  var g = cwEditGroup;
  var strategyOptions = [
    {v:"sequential", label:"‚û°Ô∏è Sequential / Linear", desc:"Ring each person in order ‚Äî next if no answer"},
    {v:"roundrobin", label:"üîÑ Round Robin", desc:"Distribute evenly across the group in rotation"},
    {v:"simultaneous", label:"üì£ Simultaneous / Blast", desc:"Ring everyone at once ‚Äî first to answer wins"},
    {v:"lru", label:"‚è±Ô∏è Least Recently Used", desc:"Ring whoever hasn't taken a call the longest"}
  ];

  var h = '<div id="cwModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px">';
  h += '<div style="background:var(--surface);border-radius:16px;width:100%;max-width:680px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';

  // Modal header
  h += '<div style="padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">';
  h += '<h3 style="margin:0;font-size:16px;font-weight:700;color:var(--text)">'+(g.id?"Edit":"New")+' Hunt Group</h3>';
  h += '<button onclick="cwCloseEditor()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:0 4px">√ó</button>';
  h += '</div>';

  h += '<div style="padding:24px">';

  // Name + active
  h += '<div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:20px">';
  h += '<div><label style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">Group Name</label>';
  h += '<input id="cwName" type="text" value="'+(g.name||"")+'" placeholder="e.g. Support Team, After Hours..." style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:var(--surface2);color:var(--text);box-sizing:border-box"></div>';
  h += '<div style="padding-top:20px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text)"><input type="checkbox" id="cwActive" '+(g.active!==false?"checked":"")+' style="width:16px;height:16px"> Active</label></div>';
  h += '</div>';

  // Strategy selection
  h += '<label style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:8px">Hunt Strategy</label>';
  h += '<div style="margin-bottom:20px;padding:12px 16px;background:rgba(10,147,150,.06);border:2px solid rgba(10,147,150,.2);border-radius:10px;display:flex;align-items:center;gap:12px">';
  h += '<span style="font-size:22px">‚û°Ô∏è</span>';
  h += '<div><div style="font-size:13px;font-weight:700;color:var(--text)">Sequential / Linear</div>';
  h += '<div style="font-size:11px;color:var(--muted);margin-top:2px">Rings each person in order ‚Äî moves to next if no answer within ring duration</div></div>';
  h += '<input type="hidden" id="cwStrategyVal" value="sequential">';
  h += '</div>';


  // Ring seconds (for sequential)
  h += '<div id="cwRingSecsRow" style="margin-bottom:20px;'+(g.strategy==="simultaneous"?"display:none":"")+'">';
  h += '<label style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">Default Ring Duration (seconds)</label>';
  h += '<input id="cwRingSecs" type="number" min="5" max="120" value="'+(g.ring_seconds||20)+'" style="width:100px;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:var(--surface2);color:var(--text)">';
  h += '<span style="font-size:11px;color:var(--muted);margin-left:8px">seconds per agent before moving to next</span>';
  h += '</div>';

  // Skip if busy option
  h += '<div style="margin-bottom:20px;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px">';
  h += '<label style="display:flex;align-items:center;gap:10px;cursor:pointer">';
  h += '<input type="checkbox" id="cwSkipBusy" '+(g.skip_if_busy?"checked":"")+' style="width:16px;height:16px;accent-color:var(--teal)">';
  h += '<div><div style="font-size:12px;font-weight:700;color:var(--text)">Skip agent if on a call</div>';
  h += '<div style="font-size:10px;color:var(--muted);margin-top:2px">If an agent is currently busy on another call, automatically ring the next person in the queue</div>';
  h += '</div></label>';
  h += '</div>';

  // Members drag-and-drop
  h += '<label style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:8px">Team Members <span style="color:var(--muted);text-transform:none;font-weight:400;font-size:11px">(drag to reorder)</span></label>';

  // Available agents to add
  var memberIds = (g.members||[]).map(function(m){ return String(m.userId); });
  // Include Denise AI as virtual agent (id: "ai_denise")
  var deniseId = "ai_denise";
  var allAgents = cwUsers.concat([{ id: deniseId, name: "ü§ñ Denise AI", role: "ai", isAI: true }]);
  var available = allAgents.filter(function(u){ return memberIds.indexOf(String(u.id)) < 0; });

  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">';

  // Left: member list (drag-drop)
  h += '<div>';
  h += '<div style="font-size:11px;font-weight:600;color:var(--teal);margin-bottom:6px">In Group ('+( g.members||[]).length+')</div>';
  h += '<div id="cwMemberList" style="min-height:80px;border:2px dashed var(--border);border-radius:8px;padding:6px;background:var(--surface2)">';
  if((g.members||[]).length === 0) {
    h += '<div id="cwEmptyMsg" style="padding:16px;text-align:center;font-size:11px;color:var(--muted)">Drag agents here or click + to add</div>';
  } else {
    (g.members||[]).forEach(function(m, i) {
      var u = cwUsers.find(function(u){ return String(u.id)===String(m.userId); });
      h += '<div class="cw-member-row" data-idx="'+i+'" draggable="true" style="display:flex;align-items:center;gap:8px;padding:7px 8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;cursor:grab;user-select:none">';
      h += '<span style="color:var(--muted);font-size:16px;cursor:grab">‚†ø</span>';
      h += '<span style="width:22px;height:22px;border-radius:50%;background:var(--teal);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+(i+1)+'</span>';
      var _isAI=String(m.userId)==='ai_denise';h += '<span style="flex:1;font-size:12px;font-weight:600;color:var(--text)">'+(_isAI?'ü§ñ Denise AI':(u?u.name:'User '+m.userId))+(_isAI?'<span style="margin-left:6px;background:rgba(10,147,150,.1);color:var(--teal);border-radius:4px;padding:1px 5px;font-size:9px;font-weight:700">AI</span>':'')+'</span>';
      if(g.strategy==="sequential") {
        h += '<input type="number" class="cw-ring-secs" data-idx="'+i+'" value="'+(m.ringSeconds||g.ring_seconds||20)+'" min="5" max="120" style="width:52px;padding:3px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface2);color:var(--text)" title="Ring seconds"> <span style="font-size:10px;color:var(--muted)">s</span>';
      }
      h += '<button onclick="cwRemoveMember('+i+')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px;padding:0 2px" title="Remove">√ó</button>';
      h += '</div>';
    });
  }
  h += '</div></div>';

  // Right: available agents
  h += '<div>';
  h += '<div style="font-size:11px;font-weight:600;color:var(--muted);margin-bottom:6px">Available Agents ('+available.length+')</div>';
  h += '<div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface2)">';
  if(available.length === 0) {
    h += '<div style="padding:16px;text-align:center;font-size:11px;color:var(--muted)">All agents added</div>';
  } else {
    available.forEach(function(u) {
      h += '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border)">';
      h += '<span style="font-size:12px;font-weight:600;color:var(--text)">'+u.name+'</span>';
      h += '<button onclick="cwAddMember('+u.id+',\''+u.name.replace(/'/g,"\\''")+'\')" style="background:var(--teal);color:#fff;border:none;border-radius:6px;padding:3px 10px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">+ Add</button>';
      h += '</div>';
    });
  }
  h += '</div></div>';
  h += '</div>'; // end grid

  // Footer buttons
  h += '<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">';
  h += '<button onclick="cwCloseEditor()" style="padding:8px 20px;border:1px solid var(--border);border-radius:8px;background:var(--surface2);color:var(--text);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Cancel</button>';
  h += '<button onclick="cwSaveGroup()" style="padding:8px 20px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">üíæ Save Group</button>';
  h += '</div>';

  h += '</div></div></div>'; // end modal
  return h;
}

function cwSetStrategy(strategy) {
  if(!cwEditGroup) return;
  cwEditGroup.strategy = strategy;
  var ringRow = document.getElementById("cwRingSecsRow");
  if(ringRow) ringRow.style.display = strategy === "simultaneous" ? "none" : "";
  // Re-render member list to show/hide ring seconds per member
  var nameEl = document.getElementById("cwName");
  if(nameEl) cwEditGroup.name = nameEl.value;
  var activeEl = document.getElementById("cwActive");
  if(activeEl) cwEditGroup.active = activeEl.checked;
  // Re-render just the members area
  var ml = document.getElementById("cwMemberList");
  if(ml) {
    var newHtml = "";
    if((cwEditGroup.members||[]).length === 0) {
      newHtml = '<div id="cwEmptyMsg" style="padding:16px;text-align:center;font-size:11px;color:var(--muted)">Drag agents here or click + to add</div>';
    } else {
      (cwEditGroup.members||[]).forEach(function(m,i){
        var u = cwUsers.find(function(u){ return String(u.id)===String(m.userId); });
        newHtml += '<div class="cw-member-row" data-idx="'+i+'" draggable="true" style="display:flex;align-items:center;gap:8px;padding:7px 8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;cursor:grab;user-select:none">';
        newHtml += '<span style="color:var(--muted);font-size:16px;cursor:grab">‚†ø</span>';
        newHtml += '<span style="width:22px;height:22px;border-radius:50%;background:var(--teal);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+(i+1)+'</span>';
        var isAI=String(m.userId)==='ai_denise';newHtml += '<span style="flex:1;font-size:12px;font-weight:600;color:var(--text)">'+(isAI?'ü§ñ Denise AI':(u?u.name:'User '+m.userId))+(isAI?'<span style="margin-left:6px;background:rgba(10,147,150,.1);color:var(--teal);border-radius:4px;padding:1px 5px;font-size:9px;font-weight:700">AI</span>':'')+'</span>';
        if(strategy==="sequential"){newHtml += '<input type="number" class="cw-ring-secs" data-idx="'+i+'" value="'+(m.ringSeconds||cwEditGroup.ring_seconds||20)+'" min="5" max="120" style="width:52px;padding:3px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface2);color:var(--text)"> <span style="font-size:10px;color:var(--muted)">s</span>';}
        newHtml += '<button onclick="cwRemoveMember('+i+')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px;padding:0 2px">√ó</button>';
        newHtml += '</div>';
      });
    }
    ml.innerHTML = newHtml;
    cwAttachDrag();
  }
}

function cwAddMemberById(userId) {
  var u = cwUsers.find(function(u){ return String(u.id)===String(userId); });
  cwAddMember(userId, u ? u.name : "User "+userId);
}
function cwAddMember(userId, userName) {
  if(!cwEditGroup) return;
  cwEditGroup.members = cwEditGroup.members || [];
  cwEditGroup.members.push({ userId: userId, name: userName, ringSeconds: cwEditGroup.ring_seconds || 20 });
  // Save form state
  var nameEl = document.getElementById("cwName"); if(nameEl) cwEditGroup.name = nameEl.value;
  var activeEl = document.getElementById("cwActive"); if(activeEl) cwEditGroup.active = activeEl.checked;
  var secsEl = document.getElementById("cwRingSecs"); if(secsEl) cwEditGroup.ring_seconds = parseInt(secsEl.value)||20;
  // Save per-member ring seconds
  document.querySelectorAll(".cw-ring-secs").forEach(function(inp){
    var idx = parseInt(inp.getAttribute("data-idx"));
    if(cwEditGroup.members[idx]) cwEditGroup.members[idx].ringSeconds = parseInt(inp.value)||20;
  });
  // Re-render just the modal without full async reload
  var modal = document.getElementById("cwModal");
  if(modal) {
    var newModal = document.createElement("div");
    newModal.innerHTML = cwRenderEditor();
    modal.parentNode.replaceChild(newModal.firstChild, modal);
    cwAttachDrag();
  }
}

function cwRemoveMember(idx) {
  if(!cwEditGroup) return;
  var nameEl = document.getElementById("cwName"); if(nameEl) cwEditGroup.name = nameEl.value;
  var activeEl = document.getElementById("cwActive"); if(activeEl) cwEditGroup.active = activeEl.checked;
  document.querySelectorAll(".cw-ring-secs").forEach(function(inp){
    var i = parseInt(inp.getAttribute("data-idx"));
    if(cwEditGroup.members[i]) cwEditGroup.members[i].ringSeconds = parseInt(inp.value)||20;
  });
  cwEditGroup.members.splice(idx, 1);
  var modal = document.getElementById("cwModal");
  if(modal) {
    var newModal = document.createElement("div");
    newModal.innerHTML = cwRenderEditor();
    modal.parentNode.replaceChild(newModal.firstChild, modal);
    cwAttachDrag();
  }
}

function cwAttachDrag() {
  var rows = document.querySelectorAll(".cw-member-row");
  rows.forEach(function(row) {
    row.addEventListener("dragstart", function(e) {
      cwDragIdx = parseInt(this.getAttribute("data-idx"));
      this.style.opacity = "0.5";
    });
    row.addEventListener("dragend", function() { this.style.opacity = "1"; });
    row.addEventListener("dragover", function(e) {
      e.preventDefault();
      this.style.background = "rgba(10,147,150,.1)";
    });
    row.addEventListener("dragleave", function() { this.style.background = ""; });
    row.addEventListener("drop", function(e) {
      e.preventDefault();
      this.style.background = "";
      var toIdx = parseInt(this.getAttribute("data-idx"));
      if(cwDragIdx === null || cwDragIdx === toIdx) return;
      // Sync ring seconds before reorder
      document.querySelectorAll(".cw-ring-secs").forEach(function(inp){
        var i = parseInt(inp.getAttribute("data-idx"));
        if(cwEditGroup.members[i]) cwEditGroup.members[i].ringSeconds = parseInt(inp.value)||20;
      });
      var moved = cwEditGroup.members.splice(cwDragIdx, 1)[0];
      cwEditGroup.members.splice(toIdx, 0, moved);
      cwDragIdx = null;
      // Re-render member list
      cwSetStrategy(cwEditGroup.strategy);
    });
  });
}

function cwSaveGroup() {
  if(!cwEditGroup) return;
  var nameEl = document.getElementById("cwName");
  var name = nameEl ? nameEl.value.trim() : cwEditGroup.name;
  if(!name) { alert("Please enter a group name"); return; }
  var activeEl = document.getElementById("cwActive");
  var secsEl = document.getElementById("cwRingSecs");
  // Capture per-member ring seconds
  document.querySelectorAll(".cw-ring-secs").forEach(function(inp){
    var idx = parseInt(inp.getAttribute("data-idx"));
    if(cwEditGroup.members[idx]) cwEditGroup.members[idx].ringSeconds = parseInt(inp.value)||20;
  });
  var skipBusyEl = document.getElementById("cwSkipBusy");
  var payload = {
    id: cwEditGroup.id || null,
    name: name,
    strategy: "sequential",
    ring_seconds: secsEl ? (parseInt(secsEl.value)||20) : 20,
    members: cwEditGroup.members || [],
    active: activeEl ? activeEl.checked : true,
    skip_if_busy: skipBusyEl ? skipBusyEl.checked : false
  };
  apiCall("POST", "/api/call-workflow/groups", payload).then(function() {
    cwEditGroup = null;
    renderCallWorkflow();
  });
}


function toggleTranscript(id){var el=document.getElementById(id);if(el)el.classList.toggle("show")}
function addConvAsContact(phone,name){currentView="contacts";selectedConv={id:"new",name:name==="Unknown"?"":name,phone:phone,email:"",organisation:"",notes:""};render()}
function setContactFilter(val){contactFilter=val==="all"?[]:[val];renderContactsList()}
function toggleContactFilterDD(){var dd=document.getElementById("contactFilterDD");if(dd)dd.style.display=dd.style.display==="none"?"block":"none"}
function toggleContactType(val){if(val==="all"){contactFilter=[];render();return}var idx=contactFilter.indexOf(val);if(idx>=0)contactFilter.splice(idx,1);else contactFilter.push(val);render()}
function getContactTypeCss(type){if(!type)return"other";var t=type.toLowerCase();if(t.indexOf("employee")>=0||t.indexOf("contractor")>=0||t.indexOf("independent")>=0)return"staff";if(t.indexOf("ndis client")>=0||t.indexOf("jobseeker")>=0)return"participant";if(t.indexOf("coordinator")>=0||t.indexOf("plan manager")>=0||t.indexOf("lac")>=0||t.indexOf("advocate")>=0||t.indexOf("public guardian")>=0||t.indexOf("public trustee")>=0||t.indexOf("child safety")>=0)return"stakeholder";if(t.indexOf("doctor")>=0||t.indexOf("nurse")>=0||t.indexOf("therapist")>=0||t.indexOf("physiotherapist")>=0||t.indexOf("behaviour")>=0||t.indexOf("psychosocial")>=0||t.indexOf("practitioner")>=0||t.indexOf("social worker")>=0)return"allied";if(t.indexOf("family")>=0||t.indexOf("friend")>=0||t.indexOf("nominee")>=0||t.indexOf("guardian")>=0)return"personal";if(t.indexOf("sda provider")>=0||t.indexOf("sil provider")>=0||t.indexOf("real estate")>=0)return"stakeholder";return"other"}
var CONTACT_TYPES=["Advocate","Behaviour Practitioner","Child Safety Officer","Doctor (GP)","Employee","Family Member","Friend","Independant Contractor","Jobseeker","LAC","Mental Health Nurse","NDIS Client (Active)","NDIS Client (Prospect)","Nominee or Guardian","Occupational Therapist","Physiotherapist","Plan Manager","Psychosocial Recovery Coach","Public Guardian (OPG)","Public Trustee","Real Estate Agent","SDA Provider","SIL Provider","Social Worker","Support Coordinator"];
function contactTypeSelect(currentVal){
var typeSet={};
contacts.forEach(function(c){if(c.contactType)typeSet[c.contactType]=1});
CONTACT_TYPES.forEach(function(t){typeSet[t]=1});
if(currentVal&&!typeSet[currentVal])typeSet[currentVal]=1;
var types=Object.keys(typeSet).sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())});
var s='<select id="editContactType" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--teal);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer">';s+='<option value="">‚Äî Select ‚Äî</option>';types.forEach(function(t){s+='<option value="'+t+'"'+(currentVal===t?" selected":"")+'>'+t+'</option>'});s+='</select>';return s}
function renderContactsList(){var list=document.getElementById("midList");var searchVal=document.getElementById("midSearch").value.toLowerCase();var filtered=contacts.filter(function(c){if(contactFilter.length>0&&contactFilter.indexOf(c.contactType||"")<0)return false;if(!searchVal)return true;return(c.name||"").toLowerCase().indexOf(searchVal)>=0||(c.phone||"").indexOf(searchVal)>=0||(c.email||"").toLowerCase().indexOf(searchVal)>=0||(c.contactType||"").toLowerCase().indexOf(searchVal)>=0});var html='';
// SC filter banner
var isSCFilter=currentUser&&currentUser.permissions&&currentUser.permissions.client_filter==="linked_sc";
if(isSCFilter)html+='<div style="padding:8px 12px;background:rgba(245,158,11,.08);border-bottom:1px solid rgba(245,158,11,.2);font-size:10px;font-weight:600;color:#D97706;text-align:center">üîí Showing your linked clients only</div>';
html+='<div style="padding:8px 12px">';if(canEdit("contacts"))html+='<button class="btn btn-p" style="width:100%;padding:8px" onclick="showAddContact()">+ Add Contact</button>';html+='<div style="font-size:10px;color:var(--dim);text-align:center;margin-top:4px">'+filtered.length+' contact'+(filtered.length!==1?'s':'')+(contactFilter.length>0?' ‚Äî '+contactFilter.join(', '):'')+'</div></div>';if(filtered.length===0){html+='<div class="empty-state" style="padding:20px">No contacts found.</div>'}filtered.forEach(function(c){var isOn=selectedConv&&selectedConv.id===c.id;html+='<div class="conv-item'+(isOn?" on":"")+'" data-contact-id="'+(c.id||c.airtable_id||"")+'">';html+='<div class="conv-avatar" style="overflow:hidden">'+(c.photo&&c.photo.length>0?'<img src="'+(c.photo[0].thumbnailUrl||c.photo[0].url)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">':getInitials(c.name))+'</div>';html+='<div class="conv-body">';html+='<div class="conv-name">'+(c.name||"Unnamed")+'</div>';html+='<div class="conv-sub">'+(c.phone||"No phone")+'</div>';if(c.contactType)html+='<div class="contact-type-badge '+getContactTypeCss(c.contactType)+'">'+c.contactType+'</div>';if(c.statusOfContact)html+='<span style="font-size:9px;font-weight:600;margin-left:4px;padding:1px 6px;border-radius:8px;'+(c.statusOfContact.toLowerCase()==="active"?"background:rgba(16,185,129,.08);color:var(--green)":"background:rgba(239,68,68,.06);color:var(--red)")+'">'+c.statusOfContact+'</span>';if(c.email)html+='<div class="conv-preview">'+c.email+'</div>';html+='</div></div>'});list.innerHTML=html;list.querySelectorAll(".conv-item").forEach(function(el){el.addEventListener("click",function(){var cid=this.getAttribute("data-contact-id");selectedConv=contacts.find(function(c){return(c.id||c.airtable_id)==cid})||null;render()})})}
function renderContactDetail(){var rp=document.getElementById("rightPanel");if(!selectedConv||currentView!=="contacts"){if(currentView==="contacts")rp.innerHTML='<div class="rp-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color:var(--light)"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Select a contact to view details</div>';return}var c=selectedConv;
var ct=(c.contactType||"").toLowerCase();var isStaff=ct.indexOf("employee")>=0||ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0||ct==="";
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;
var isNDISClient=ct.indexOf("ndis client")>=0||ct.indexOf("ndis participant")>=0;
var isJobseeker=ct.indexOf("jobseeker")>=0;
var contactPhotoHtml=(c.photo&&c.photo.length>0)?'<img src="'+(c.photo[0].thumbnailUrl||c.photo[0].url)+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">':getInitials(c.name);
var activeTab=c._activeTab||"details";
var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar" style="overflow:hidden">'+contactPhotoHtml+'</div><div><div class="rp-hdr-name">'+(c.name||"New Contact")+'</div><div class="rp-hdr-sub">'+(c.phone||"")+'</div>'+(c.contactType?'<span class="contact-type-badge '+getContactTypeCss(c.contactType)+'" style="margin-top:4px">'+c.contactType+'</span>':'')+'</div></div></div>';
// ‚îÄ‚îÄ TABS ‚Äî immediately after header ‚îÄ‚îÄ
html+='<div style="display:flex;gap:0;border-bottom:1px solid var(--border);padding:0 20px;background:var(--surface);overflow-x:auto">';
var tabs;
if(isNDISClient){tabs=[{id:"details",label:"üìã Details"},{id:"supportPlan",label:"üõ°Ô∏è Support Plan"},{id:"ndisPlanBudget",label:"üíú NDIS Plan & Budget"},{id:"stakeholders",label:"üë• Stakeholders"},{id:"serviceRecords",label:"üìÇ Service Records"},{id:"history",label:"üìù Contact History"},{id:"documents",label:"üìÅ Docs"}]}
else if(isJobseeker){tabs=[{id:"details",label:"üìã Details"},{id:"convos",label:"üí¨ Conversations"},{id:"history",label:"üìù Contact History"},{id:"training",label:"üéì Training"}]}
else if(isStaff){tabs=[{id:"details",label:"üìã Details"},{id:"employment",label:"üíº Employment"},{id:"leave",label:"üìÖ Leave & Availability"},{id:"serviceRecords",label:"üìÇ Service Records"},{id:"convos",label:"üí¨ Conversations"},{id:"history",label:"üìù Contact History"},{id:"training",label:"üéì Training"}]}
else{tabs=[{id:"details",label:"üìã Details"},{id:"convos",label:"üí¨ Conversations"},{id:"history",label:"üìù Contact History"},{id:"serviceRecords",label:"üìÇ Service Records"},{id:"training",label:"üéì Training"}]}
tabs.forEach(function(tab){var isActive=activeTab===tab.id||(tab.id==="serviceRecords"&&["progress","incidents","kms","calendar","weeklyreports"].indexOf(activeTab)>=0)||(tab.id==="ndisPlanBudget"&&["ndisPlan","budget"].indexOf(activeTab)>=0);html+='<button onclick="switchContactTab(\''+tab.id+'\')" style="padding:10px 12px;font-size:11px;font-weight:600;border:none;background:none;cursor:pointer;color:'+(isActive?"var(--teal)":"var(--muted)")+';border-bottom:2px solid '+(isActive?"var(--teal)":"transparent")+';transition:all .12s;white-space:nowrap">'+tab.label+'</button>'});
html+='</div>';
// ‚îÄ‚îÄ TAB CONTENT ‚îÄ‚îÄ
html+='<div style="flex:1;overflow-y:auto;padding:20px">';
if(activeTab==="details"){
// Photo above fields if staff
if(isStaff&&!isNDISClient&&c.photo&&c.photo.length>0){var photoUrl=c.photo[0].thumbnailUrl||c.photo[0].url;html+='<div style="text-align:center;margin-bottom:12px"><img src="'+photoUrl+'" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--teal);box-shadow:0 2px 8px rgba(0,0,0,.15)" alt="Photo"></div>'}
if(isNDISClient){
// ‚îÄ‚îÄ NDIS CLIENT DETAILS ‚Äî loads from Clients table ‚îÄ‚îÄ
// Determine client name: try linked field, then full name, then firstName+lastName
var detailClientName=c.linkedToClient||(c.firstName&&c.lastName?c.firstName+" "+c.lastName:"")||c.name||"";
if(Array.isArray(detailClientName))detailClientName=detailClientName[0]||"";
if(detailClientName==="New Contact")detailClientName="";
if(c.id==="new"||!detailClientName){
// New contact ‚Äî show create form, don't try to load from Clients table
html+='<div style="padding:16px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üë§</div><div style="font-size:13px;font-weight:600;margin-bottom:4px">New NDIS Client</div><div style="font-size:11px;margin-bottom:16px">Fill in the contact details below and save. Client data will load once the name matches a record in the Clients table.</div></div>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>First Name</label><input id="editFirstName" value="'+(c.firstName||"")+'"></div><div class="fg" style="margin:0"><label>Last Name</label><input id="editLastName" value="'+(c.lastName||"")+'"></div></div>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Type of Contact</label>'+contactTypeSelect(c.contactType||"")+'</div><div class="fg" style="margin:0"><label>Status of Contact</label><select id="editStatus" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer"><option value="Active Contact"'+(c.statusOfContact==="Active Contact"?" selected":"")+'>Active Contact</option><option value="Inactive Contact"'+(c.statusOfContact==="Inactive Contact"?" selected":"")+'>Inactive Contact</option></select></div></div>';
html+='<div class="fg"><label>Phone</label><input id="editPhone" type="tel" value="'+(c.phone||"")+'" placeholder="+61400000000"></div>';
html+='<div class="fg"><label>Email</label><input id="editEmail" type="email" value="'+(c.email||"")+'"></div>';
html+='<div style="margin-bottom:8px;padding:10px 12px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs)"><div style="font-size:9px;font-weight:700;color:var(--royal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">‚úçÔ∏è Document Signing Email</div><input id="editSigningEmail" type="email" value="'+(c.signingEmail||c.email||"")+'" placeholder="Leave blank to use main email above" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box"></div>';
html+='<div class="fg"><label>Notes</label><input id="editNotes" value="'+(c.notes||"")+'"></div>';
html+='<input type="hidden" id="editName" value="'+(c.name||"")+'"><input type="hidden" id="editOrg" value=""><input type="hidden" id="editAddress" value=""><input type="hidden" id="editSuburb" value=""><input type="hidden" id="editPostcode" value=""><input type="hidden" id="editState" value=""><input type="hidden" id="editAbn" value="">';
html+='<div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-p" style="width:auto;padding:8px 16px" onclick="saveContact(\''+(c.id||"")+'\')">'+(c.id==="new"?"Create Contact":"Save Changes")+'</button></div>';
}else{
html+='<div id="ndisClientDetails"><div style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading client details from Clients table...</div></div>';
// Hidden fields for save
html+='<input type="hidden" id="editFirstName" value="'+(c.firstName||"")+'"><input type="hidden" id="editLastName" value="'+(c.lastName||"")+'"><input type="hidden" id="editPhone" value="'+(c.phone||"")+'"><input type="hidden" id="editEmail" value="'+(c.email||"")+'"><input type="hidden" id="editStatus" value="'+(c.statusOfContact||"Active Contact")+'"><input type="hidden" id="editName" value="'+(c.name||"")+'"><input type="hidden" id="editOrg" value="'+(c.organisation||"")+'"><input type="hidden" id="editAddress" value="'+(c.homeAddress||"")+'"><input type="hidden" id="editSuburb" value="'+(c.suburb||"")+'"><input type="hidden" id="editPostcode" value="'+(c.postcode||"")+'"><input type="hidden" id="editState" value="'+(c.state||"")+'"><input type="hidden" id="editAbn" value="'+(c.abn||"")+'"><input type="hidden" id="editNotes" value="'+(c.notes||"")+'">';
}
}else if(isJobseeker){
// ‚îÄ‚îÄ JOBSEEKER DETAILS ‚îÄ‚îÄ
var af=c.allFields||{};
// Stage in Recruitment badge large at top
var jsRecruitStage=c.stageInRecruitment||"";
if(jsRecruitStage){var rsBadgeCol=kanbanColors[jsRecruitStage]||"var(--royal)";html+='<div style="text-align:center;margin-bottom:16px"><span style="display:inline-block;padding:8px 24px;border-radius:12px;font-size:18px;font-weight:800;background:'+rsBadgeCol+'10;color:'+rsBadgeCol+';border:2px solid '+rsBadgeCol+'30">üè∑Ô∏è '+jsRecruitStage+'</span></div>'}
// Name + basic fields
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>First Name</label><input id="editFirstName" value="'+(c.firstName||"")+'"></div><div class="fg" style="margin:0"><label>Last Name</label><input id="editLastName" value="'+(c.lastName||"")+'"></div></div>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Type of Contact</label>'+contactTypeSelect(c.contactType||"")+'</div><div class="fg" style="margin:0"><label>Status of Contact</label><select id="editStatus" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer"><option value="Active Contact"'+(c.statusOfContact==="Active Contact"?" selected":"")+'>Active Contact</option><option value="Inactive Contact"'+(c.statusOfContact==="Inactive Contact"?" selected":"")+'>Inactive Contact</option></select></div></div>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Phone</label><input id="editPhone" type="tel" value="'+(c.phone||"")+'"></div><div class="fg" style="margin:0"><label>Email</label><input id="editEmail" type="email" value="'+(c.email||"")+'"></div></div>';

// CV/Resume & SW Profile ‚Äî use mapped fields
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
html+='<div style="padding:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.15);border-radius:var(--rs)"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìï CV / Resume</div>';
if(c.cvResume&&c.cvResume.length>0){c.cvResume.forEach(function(f){html+='<a href="'+(f.url||"")+'" target="_blank" style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--teal);text-decoration:none;font-weight:600;margin-bottom:2px">üìé '+(f.name||"View CV")+'</a>'})}
else html+='<div style="font-size:11px;color:var(--dim)">No CV uploaded</div>';
html+='</div>';
html+='<div style="padding:12px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs)"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìò SW Profile</div>';
if(c.swProfile&&c.swProfile.length>0){c.swProfile.forEach(function(f){html+='<a href="'+(f.url||"")+'" target="_blank" style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--teal);text-decoration:none;font-weight:600;margin-bottom:2px">üìé '+(f.name||"View Profile")+'</a>'})}
else html+='<div style="font-size:11px;color:var(--dim)">No profile uploaded</div>';
html+='</div></div>';

// Address card
var fullAddr=[c.homeAddress,c.suburb,c.state,c.postcode].filter(function(x){return x}).join(", ");
if(fullAddr)html+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üè† Address</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+fullAddr+'</div></div>';

// Emergency Contact ‚Äî use mapped fields
if(c.emergencyContact||c.emergencyPhone)html+='<div style="padding:12px;background:rgba(239,68,68,.03);border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üö® Emergency Contact</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><div><div style="font-size:9px;color:var(--muted);font-weight:600">Name</div><div style="font-size:12px;font-weight:700;color:var(--text)">'+(c.emergencyContact||"‚Äî")+'</div></div><div><div style="font-size:9px;color:var(--muted);font-weight:600">Relationship</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+(c.emergencyRelationship||"‚Äî")+'</div></div><div><div style="font-size:9px;color:var(--muted);font-weight:600">Phone</div><div style="font-size:12px;font-weight:600;color:var(--royal)">'+(c.emergencyPhone||"‚Äî")+'</div></div></div></div>';

// Compliance & Certs ‚Äî same as staff
var compFields2=[{label:"First Aid",val:c.firstAidExpiry},{label:"CPR",val:c.cprExpiry},{label:"Car Insurance",val:c.insuranceExpiry},{label:"Driver Licence",val:c.driversLicenseExpiry},{label:"NDIS Worker Screening",val:c.ndisExpiry},{label:"WWCC Blue Card",val:c.wwccExpiry}];
var hasComp2=compFields2.some(function(f){return f.val});
if(hasComp2){html+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìã Compliance &amp; Certifications</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">';
compFields2.forEach(function(f){if(!f.val)return;var dateVal=f.val;var expDate;if(dateVal.indexOf("/")>=0){var parts=dateVal.split("/");if(parts.length===3){var yr=parts[2];if(yr.length===2)yr="20"+yr;expDate=new Date(yr+"-"+parts[1]+"-"+parts[0])}}else{expDate=new Date(dateVal)}var now=new Date();var daysLeft=expDate?Math.ceil((expDate-now)/(1000*60*60*24)):999;var color=daysLeft<0?"var(--red)":daysLeft<90?"var(--orange)":"var(--green)";var bg=daysLeft<0?"rgba(239,68,68,.06)":daysLeft<90?"rgba(245,158,11,.06)":"rgba(16,185,129,.06)";var border=daysLeft<0?"rgba(239,68,68,.15)":daysLeft<90?"rgba(245,158,11,.15)":"rgba(16,185,129,.15)";var status=daysLeft<0?"EXPIRED":daysLeft<90?daysLeft+"d left":"Valid";html+='<div style="padding:6px 8px;background:'+bg+';border:1px solid '+border+';border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+f.label+'</div><div style="font-size:11px;font-weight:700;color:'+color+';margin-top:1px">'+dateVal+'</div><div style="font-size:8px;font-weight:600;color:'+color+'">'+status+'</div></div>'});
html+='</div></div>'}

// Notes
html+='<div class="fg"><label>Notes</label><textarea id="editNotes" rows="3" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text);resize:vertical">'+(c.notes||"")+'</textarea></div>';
html+='<input type="hidden" id="editName" value="'+(c.name||"")+'"><input type="hidden" id="editOrg" value=""><input type="hidden" id="editAddress" value="'+(c.homeAddress||"")+'"><input type="hidden" id="editSuburb" value="'+(c.suburb||"")+'"><input type="hidden" id="editPostcode" value="'+(c.postcode||"")+'"><input type="hidden" id="editState" value="'+(c.state||"")+'"><input type="hidden" id="editAbn" value="">';
html+='<div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-p" style="width:auto;padding:8px 16px" onclick="saveContact(\''+(c.id||"")+'\')">'+(c.id==="new"?"Create Contact":"Save Changes")+'</button></div>';
}else if(isStaff){
// ‚îÄ‚îÄ STAFF DETAILS ‚îÄ‚îÄ
// SW Profile + CV/Resume ‚Äî moved to top
var hasDocs=(c.swProfile&&c.swProfile.length>0)||(c.cvResume&&c.cvResume.length>0);
if(hasDocs){html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';
if(c.swProfile&&c.swProfile.length>0){var sp=c.swProfile[0];html+='<a href="'+sp.url+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.15);border-radius:var(--rs);text-decoration:none;transition:all .12s" onmouseover="this.style.background=\'rgba(10,147,150,.1)\'" onmouseout="this.style.background=\'rgba(10,147,150,.04)\'"><span style="font-size:20px">üìÑ</span><div><div style="font-size:12px;font-weight:700;color:var(--teal)">SW Profile</div><div style="font-size:9px;color:var(--muted)">'+sp.name+(sp.size?' ¬∑ '+(sp.size>1048576?(sp.size/1048576).toFixed(1)+'MB':(sp.size/1024).toFixed(0)+'KB'):'')+'</div></div></a>'}
if(c.cvResume&&c.cvResume.length>0){var cv=c.cvResume[0];html+='<a href="'+cv.url+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs);text-decoration:none;transition:all .12s" onmouseover="this.style.background=\'rgba(30,75,160,.1)\'" onmouseout="this.style.background=\'rgba(30,75,160,.04)\'"><span style="font-size:20px">üìã</span><div><div style="font-size:12px;font-weight:700;color:var(--royal)">CV / Resume</div><div style="font-size:9px;color:var(--muted)">'+cv.name+(cv.size?' ¬∑ '+(cv.size>1048576?(cv.size/1048576).toFixed(1)+'MB':(cv.size/1024).toFixed(0)+'KB'):'')+'</div></div></a>'}
html+='</div>'}
// First Name + Last Name + Cultural Ethnicity (3 columns)
html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>First Name</label><input id="editFirstName" value="'+(c.firstName||"")+'"></div><div class="fg" style="margin:0"><label>Last Name</label><input id="editLastName" value="'+(c.lastName||"")+'"></div><div class="fg" style="margin:0"><label>Cultural Ethnicity</label><input value="'+(c.cultureEthnicity||"")+'" disabled style="opacity:.7"></div></div>';
// Type of Contact + Job Title + Status of Contact (3 columns)
html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Type of Contact</label>'+contactTypeSelect(c.contactType||"")+'</div><div class="fg" style="margin:0"><label>Job Title</label><input value="'+(c.jobTitle||"")+'" disabled style="opacity:.7"></div><div class="fg" style="margin:0"><label>Status of Contact</label><select id="editStatus" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer"><option value="Active Contact"'+(c.statusOfContact==="Active Contact"?" selected":"")+'>Active Contact</option><option value="Inactive Contact"'+(c.statusOfContact==="Inactive Contact"?" selected":"")+'>Inactive Contact</option><option value="Archive (Gus only)"'+(c.statusOfContact==="Archive (Gus only)"?" selected":"")+'>Archive (Gus only)</option></select></div></div>';
// Phone + Email + Signing Email
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Phone</label><input id="editPhone" type="tel" value="'+(c.phone||"")+'" placeholder="+61400000000"></div><div class="fg" style="margin:0"><label>Email</label><input id="editEmail" type="email" value="'+(c.email||"")+'"></div></div>';
html+='<div style="margin-bottom:8px;padding:10px 12px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs)">';
html+='<div style="font-size:9px;font-weight:700;color:var(--royal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px">‚úçÔ∏è Document Signing Email <span style="font-size:9px;font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted)">(used when sending agreements for e-signature)</span></div>';
html+='<input id="editSigningEmail" type="email" value="'+(c.signingEmail||c.email||"")+'" placeholder="Leave blank to use main email above" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box">';
html+='</div>';
// Organisation + ABN for contractors
if(isContractor){html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Organisation</label><input id="editOrg" value="'+(c.organisation||"")+'"></div><div class="fg" style="margin:0"><label>ABN</label><input id="editAbn" value="'+(c.abn||"")+'" placeholder="Australian Business Number" style="font-family:JetBrains Mono,monospace"></div></div>'}else{html+='<input type="hidden" id="editOrg" value="'+(c.organisation||"")+'"><input type="hidden" id="editAbn" value="'+(c.abn||"")+'">'}
// Gender + DOB + Age
var dobVal=c.dob||"";var dobDisplay="";var ageDisplay="";if(dobVal){try{var dp;if(dobVal.indexOf("/")>=0){var pts=dobVal.split("/");if(pts.length===3){var yr=pts[2];if(yr.length===2)yr="20"+yr;dp=new Date(yr+"-"+pts[1]+"-"+pts[0])}}else{dp=new Date(dobVal)}if(dp&&!isNaN(dp)){dobDisplay=("0"+dp.getDate()).slice(-2)+"/"+("0"+(dp.getMonth()+1)).slice(-2)+"/"+String(dp.getFullYear()).slice(-2);var ageDiff=Date.now()-dp.getTime();var ageDate=new Date(ageDiff);ageDisplay=Math.abs(ageDate.getUTCFullYear()-1970)+" yrs"}}catch(e){dobDisplay=dobVal}}
var genderOpts=["","Male","Female","Non-Binary","Other","Prefer not to say"];var genderSelect='<select id="editGender" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer">';genderOpts.forEach(function(g){genderSelect+='<option value="'+g+'"'+(c.gender===g?" selected":"")+'>'+( g||"‚Äî Select ‚Äî")+'</option>'});genderSelect+='</select>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Gender</label>'+genderSelect+'</div><div class="fg" style="margin:0"><label>Date of Birth</label><input value="'+dobDisplay+'" disabled style="opacity:.7"></div><div class="fg" style="margin:0"><label>Age</label><input value="'+ageDisplay+'" disabled style="opacity:.7"></div></div>';
// Save button
html+='<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-p" style="width:auto;padding:6px 14px;font-size:12px" onclick="saveContact(\''+(c.id||c.airtable_id||"")+'\')">'+(c.id==="new"?"Create Contact":"Save Changes")+'</button></div>';
// Address
html+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìç Address</div>';
html+='<div class="fg" style="margin:0 0 6px"><input id="editAddress" value="'+(c.homeAddress||"")+'" placeholder="Street Address" style="font-size:12px;padding:6px 8px"></div>';
html+='<div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:6px"><input id="editSuburb" value="'+(c.suburb||"")+'" placeholder="Suburb" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);padding:6px 8px;font-size:12px;color:var(--text);font-family:inherit"><input id="editState" value="'+(c.state||"")+'" placeholder="State" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);padding:6px 8px;font-size:12px;color:var(--text);font-family:inherit"><input id="editPostcode" value="'+(c.postcode||"")+'" placeholder="Postcode" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);padding:6px 8px;font-size:12px;color:var(--text);font-family:inherit"></div></div>';
// Emergency contact
if(c.emergencyContact||c.emergencyPhone)html+='<div style="padding:10px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üö® Emergency Contact</div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:13px;font-weight:600;color:var(--text)">'+(c.emergencyContact||"Not set")+'</span>'+(c.emergencyRelationship?'<span style="font-size:11px;color:var(--muted)">('+c.emergencyRelationship+')</span>':'')+(c.emergencyPhone?'<a href="tel:'+c.emergencyPhone+'" style="font-size:12px;color:var(--teal);font-family:JetBrains Mono,monospace;font-weight:600;text-decoration:none">üìû '+c.emergencyPhone+'</a>':'')+(c.emergencyEmail?'<a href="mailto:'+c.emergencyEmail+'" style="font-size:11px;color:var(--muted);text-decoration:none">‚úâÔ∏è '+c.emergencyEmail+'</a>':'')+'</div></div>';
// Compliance
var compFields=[{label:"First Aid",val:c.firstAidExpiry},{label:"CPR",val:c.cprExpiry},{label:"Car Insurance",val:c.insuranceExpiry},{label:"Driver Licence",val:c.driversLicenseExpiry},{label:"NDIS Worker Screening",val:c.ndisExpiry},{label:"WWCC Blue Card",val:c.wwccExpiry}];
var hasComp=compFields.some(function(f){return f.val});
if(hasComp){html+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìã Compliance &amp; Certifications</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">';
compFields.forEach(function(f){if(!f.val)return;var dateVal=f.val;var expDate;if(dateVal.indexOf("/")>=0){var parts=dateVal.split("/");if(parts.length===3){var yr=parts[2];if(yr.length===2)yr="20"+yr;expDate=new Date(yr+"-"+parts[1]+"-"+parts[0])}}else{expDate=new Date(dateVal)}var now=new Date();var daysLeft=expDate?Math.ceil((expDate-now)/(1000*60*60*24)):999;var color=daysLeft<0?"var(--red)":daysLeft<90?"var(--orange)":"var(--green)";var bg=daysLeft<0?"rgba(239,68,68,.06)":daysLeft<90?"rgba(245,158,11,.06)":"rgba(16,185,129,.06)";var border=daysLeft<0?"rgba(239,68,68,.15)":daysLeft<90?"rgba(245,158,11,.15)":"rgba(16,185,129,.15)";var status=daysLeft<0?"EXPIRED":daysLeft<90?daysLeft+"d left":"Valid";html+='<div style="padding:6px 8px;background:'+bg+';border:1px solid '+border+';border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+f.label+'</div><div style="font-size:11px;font-weight:700;color:'+color+';margin-top:1px">'+dateVal+'</div><div style="font-size:8px;font-weight:600;color:'+color+'">'+status+'</div></div>'});
html+='</div></div>'}
html+='<div class="fg" style="margin:0"><label>Notes</label><input id="editNotes" value="'+(c.notes||"")+'"></div>';
}else{
// ‚îÄ‚îÄ NON-STAFF DETAILS ‚îÄ‚îÄ
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>First Name</label><input id="editFirstName" value="'+(c.firstName||"")+'"></div><div class="fg" style="margin:0"><label>Last Name</label><input id="editLastName" value="'+(c.lastName||"")+'"></div></div>';
if(c.contactType)html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="fg" style="margin:0"><label>Type of Contact</label>'+contactTypeSelect(c.contactType||"")+'</div><div class="fg" style="margin:0"><label>Status of Contact</label><select id="editStatus" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer"><option value="Active Contact"'+(c.statusOfContact==="Active Contact"?" selected":"")+'>Active Contact</option><option value="Inactive Contact"'+(c.statusOfContact==="Inactive Contact"?" selected":"")+'>Inactive Contact</option><option value="Archive (Gus only)"'+(c.statusOfContact==="Archive (Gus only)"?" selected":"")+'>Archive (Gus only)</option></select></div></div>';
else html+='<div class="fg"><label>Status of Contact</label><select id="editStatus" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer"><option value="Active Contact"'+(c.statusOfContact==="Active Contact"?" selected":"")+'>Active Contact</option><option value="Inactive Contact"'+(c.statusOfContact==="Inactive Contact"?" selected":"")+'>Inactive Contact</option><option value="Archive (Gus only)"'+(c.statusOfContact==="Archive (Gus only)"?" selected":"")+'>Archive (Gus only)</option></select></div>';
html+='<div class="fg"><label>Phone</label><input id="editPhone" type="tel" value="'+(c.phone||"")+'" placeholder="+61400000000"></div>';
html+='<div class="fg"><label>Email</label><input id="editEmail" type="email" value="'+(c.email||"")+'"></div>';
html+='<div style="margin-bottom:8px;padding:10px 12px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs)">';
html+='<div style="font-size:9px;font-weight:700;color:var(--royal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px">‚úçÔ∏è Document Signing Email</div>';
html+='<input id="editSigningEmail" type="email" value="'+(c.signingEmail||c.email||"")+'" placeholder="Leave blank to use main email above" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box">';
html+='</div>';
html+='<div class="fg"><label>State</label><input id="editState" value="'+(c.state||"")+'"></div>';
if(c.linkedToClient){var linked=Array.isArray(c.linkedToClient)?c.linkedToClient.join(", "):c.linkedToClient;html+='<div class="fg"><label>Linked to Client</label><div style="padding:8px 12px;background:rgba(30,75,160,.06);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs);font-size:13px;font-weight:600;color:var(--royal)">'+linked+'</div></div>'}
html+='<div class="fg"><label>Notes</label><input id="editNotes" value="'+(c.notes||"")+'"></div>';
html+='<input type="hidden" id="editName" value="'+(c.name||"")+'"><input type="hidden" id="editOrg" value="'+(c.organisation||"")+'"><input type="hidden" id="editAddress" value="'+(c.homeAddress||"")+'"><input type="hidden" id="editSuburb" value="'+(c.suburb||"")+'"><input type="hidden" id="editPostcode" value="'+(c.postcode||"")+'"><input type="hidden" id="editAbn" value="'+(c.abn||"")+'">';
html+='<div style="display:flex;gap:8px;margin-top:8px"><button class="btn btn-p" style="width:auto;padding:8px 16px" onclick="saveContact(\''+(c.id||c.airtable_id||"")+'\')">'+(c.id==="new"?"Create Contact":"Save Changes")+'</button></div>';
}
}else if(activeTab==="employment"){
html+='<div id="employmentContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading employment details...</div></div>';
}else if(activeTab==="leave"){
html+='<div id="leaveContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading leave & availability...</div></div>';
}else if(activeTab==="serviceRecords"||activeTab==="progress"||activeTab==="incidents"||activeTab==="kms"||activeTab==="calendar"||activeTab==="weeklyreports"){
var srSubTab=activeTab==="serviceRecords"?"overview":activeTab;
html+='<div id="serviceRecordsContent">';
// Sub-navigation bar
html+='<div style="display:flex;align-items:center;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px">';
var srSubTabs=[
{id:"overview",icon:"üìÇ",label:"Overview"},
{id:"progress",icon:"üìì",label:"Progress Notes"},
{id:"incidents",icon:"‚ö†Ô∏è",label:"Incidents"},
{id:"kms",icon:"üöó",label:"KMs"}
];
if(isNDISClient)srSubTabs.push({id:"calendar",icon:"üìÖ",label:"Calendar"});
if(isNDISClient)srSubTabs.push({id:"weeklyreports",icon:"üìä",label:"Weekly Reports"});
srSubTabs.forEach(function(st){
var isOn=srSubTab===st.id;
html+='<button onclick="switchContactTab(\''+( st.id==="overview"?"serviceRecords":st.id)+'\')" style="padding:10px 16px;font-size:12px;font-weight:'+(isOn?"700":"500")+';font-family:inherit;cursor:pointer;border:none;background:'+(isOn?"var(--surface)":"transparent")+';color:'+(isOn?"var(--teal)":"var(--muted)")+';border-bottom:2px solid '+(isOn?"var(--teal)":"transparent")+';margin-bottom:-2px;display:flex;align-items:center;gap:6px;transition:all .12s;border-radius:var(--rs) var(--rs) 0 0;white-space:nowrap" onmouseover="if(!'+isOn+')this.style.color=\'var(--text)\'" onmouseout="if(!'+isOn+')this.style.color=\''+(isOn?"var(--teal)":"var(--muted)")+'\'">';
html+='<span>'+st.icon+'</span> '+st.label+'</button>';
});
html+='</div>';

if(srSubTab==="overview"){
// Cards view
html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">';
html+='<div><div style="font-size:16px;font-weight:700;color:var(--text)">üìÇ Service Records</div><div style="font-size:11px;color:var(--muted)">View progress notes, incidents and KM records for '+(c.name||"this contact")+'</div></div></div>';
var srCards=[
{id:"progress",icon:"üìì",title:"Progress Notes",desc:"Shift notes, observations and service delivery records",color:"var(--teal)",bg:"rgba(10,175,171,.06)"},
{id:"incidents",icon:"‚ö†Ô∏è",title:"Incident Reports",desc:"Incident records, injuries, near-misses and behavioural events",color:"var(--red)",bg:"rgba(239,68,68,.04)"},
{id:"kms",icon:"üöó",title:"KM Records",desc:"Travel and mileage claims for client support trips",color:"#F59E0B",bg:"rgba(245,158,11,.06)"}
];
if(isNDISClient)srCards.push({id:"calendar",icon:"üìÖ",title:"Client Calendar",desc:"Appointments, inspections and scheduled events",color:"#3B82F6",bg:"rgba(59,130,246,.04)"});
if(isNDISClient)srCards.push({id:"weeklyreports",icon:"üìä",title:"Weekly Reports",desc:"NDIS stakeholder reports generated for this participant",color:"#7c3aed",bg:"rgba(124,58,237,.04)"});
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px">';
srCards.forEach(function(sr){
html+='<div onclick="switchContactTab(\''+sr.id+'\')" style="padding:20px;background:'+sr.bg+';border:1px solid '+sr.color+'20;border-radius:var(--r);cursor:pointer;transition:all .15s;border-left:4px solid '+sr.color+'" onmouseover="this.style.boxShadow=\'0 4px 12px rgba(0,0,0,.08)\';this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.boxShadow=\'none\';this.style.transform=\'none\'">';
html+='<div style="font-size:28px;margin-bottom:8px">'+sr.icon+'</div>';
html+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px">'+sr.title+'</div>';
html+='<div style="font-size:11px;color:var(--muted);line-height:1.4">'+sr.desc+'</div>';
html+='<div style="margin-top:12px;font-size:11px;font-weight:700;color:'+sr.color+'">Open ‚Üí</div>';
html+='</div>';
});
html+='</div>';
}else if(srSubTab==="progress"){
html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text)">üìì Progress Notes</div></div>';
html+='<div id="progressNotesContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading progress notes...</div></div>';
}else if(srSubTab==="incidents"){
html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text)">‚ö†Ô∏è Incident Reports</div></div>';
html+='<div id="incidentReportsContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading incident reports...</div></div>';
}else if(srSubTab==="kms"){
html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text)">üöó KM Records</div></div>';
html+='<div id="kmsContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading KMs...</div></div>';
}else if(srSubTab==="calendar"){
html+='<div id="calendarContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading calendar...</div></div>';
}else if(srSubTab==="weeklyreports"){
html+='<div id="weeklyReportsContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:#7c3aed;border-radius:50%;margin:0 auto 8px"></div>Loading weekly reports...</div></div>';
}
html+='</div>';
}else if(activeTab==="convos"){
html+='<div id="convosContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading conversations...</div></div>';
}else if(activeTab==="history"){
html+='<div id="contactHistoryContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading contact history...</div></div>';
}else if(activeTab==="training"){
html+='<div id="trainingContent"><div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading training records...</div></div>';
}else if(activeTab==="supportPlan"){
html+='<div id="supportPlanContent"><div style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading support plan...</div></div>';
}else if(activeTab==="ndisPlanBudget"||activeTab==="ndisPlan"||activeTab==="budget"){
var npbSub=activeTab==="ndisPlanBudget"?"ndisPlan":activeTab;
html+='<div id="ndisPlanBudgetContent">';
// Sub-navigation
html+='<div style="display:flex;align-items:center;gap:0;border-bottom:2px solid var(--border);margin-bottom:16px">';
[{id:"ndisPlan",icon:"üíú",label:"NDIS Plan"},{id:"budget",icon:"üí∞",label:"Budget"}].forEach(function(st){
var isOn=npbSub===st.id;
html+='<button onclick="switchContactTab(\''+st.id+'\')" style="padding:10px 16px;font-size:12px;font-weight:'+(isOn?"700":"500")+';font-family:inherit;cursor:pointer;border:none;background:'+(isOn?"var(--surface)":"transparent")+';color:'+(isOn?"var(--teal)":"var(--muted)")+';border-bottom:2px solid '+(isOn?"var(--teal)":"transparent")+';margin-bottom:-2px;display:flex;align-items:center;gap:6px;transition:all .12s;border-radius:var(--rs) var(--rs) 0 0;white-space:nowrap" onmouseover="if(!'+isOn+')this.style.color=\'var(--text)\'" onmouseout="if(!'+isOn+')this.style.color=\''+(isOn?"var(--teal)":"var(--muted)")+'\'">';
html+='<span>'+st.icon+'</span> '+st.label+'</button>';
});
html+='</div>';
if(npbSub==="ndisPlan"){
html+='<div id="ndisPlanContent"><div style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading NDIS plan details...</div></div>';
}else{
html+='<div id="budgetContent"><div style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading budgets...</div></div>';
}
html+='</div>';
}else if(activeTab==="stakeholders"){
html+='<div id="stakeholdersContent">';
html+='<div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">üë• Key Stakeholders</div>';
html+='<div style="font-size:11px;color:var(--muted);margin-bottom:16px">Support team contacts for '+(c.name||"this client")+'</div>';
html+='<div style="text-align:center;padding:20px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading stakeholders...</div>';
html+='</div>';
}else if(activeTab==="documents"){
html+='<div id="documentsContent">';
html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">';
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text)">üìÅ Client Documents</div>';
html+='<div style="font-size:11px;color:var(--muted)">Signed agreements and documents on file for '+(c.name||"this client")+'</div></div>';
html+='<button id="uploadDocBtn_'+c.id+'" onclick="_triggerClientDocUpload(this)" data-cid="'+c.id+'" data-cn="'+(c.name||'Client').replace(/["']/g,'')+'" style="padding:8px 16px;background:linear-gradient(135deg,var(--royal),#2563EB);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer">üì§ Upload Document</button>';
html+='</div>';
html+='<div id="clientDocsLoading" style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading documents...</div>';
html+='</div>';
}
// Hidden fields for non-details tabs
if(activeTab!=="details"){
if(isStaff)html+='<input type="hidden" id="editAddress" value="'+(c.homeAddress||"")+'"><input type="hidden" id="editSuburb" value="'+(c.suburb||"")+'"><input type="hidden" id="editState" value="'+(c.state||"")+'"><input type="hidden" id="editPostcode" value="'+(c.postcode||"")+'"><input type="hidden" id="editNotes" value="'+(c.notes||"")+'">';
else html+='<input type="hidden" id="editName" value="'+(c.name||"")+'"><input type="hidden" id="editEmail" value="'+(c.email||"")+'"><input type="hidden" id="editOrg" value="'+(c.organisation||"")+'"><input type="hidden" id="editAddress" value="'+(c.homeAddress||"")+'"><input type="hidden" id="editSuburb" value="'+(c.suburb||"")+'"><input type="hidden" id="editPostcode" value="'+(c.postcode||"")+'"><input type="hidden" id="editAbn" value="'+(c.abn||"")+'"><input type="hidden" id="editNotes" value="'+(c.notes||"")+'">';
}
html+='</div>';rp.innerHTML=html;
// Auto-load tab data
if(c.email){
if(c._activeTab==="history")loadContactHistory(c.email,c.name);
if(c._activeTab==="progress")loadProgressNotes(c.email);
if(c._activeTab==="incidents")loadIncidentReports(c.email);
if(c._activeTab==="kms")loadKms(c.email,c.name);
}
if(c._activeTab==="convos"&&(c.phone||c.email))loadConversations(c.phone,c.name,c.email);
if(c._activeTab==="employment")loadEmploymentTab(c);
if(c._activeTab==="leave")loadLeaveTab(c);
if(c._activeTab==="training")loadTrainingRecords(c.name,c.email);
// NDIS Client auto-loads
if(isNDISClient){
var clientName=c.linkedToClient||(c.firstName&&c.lastName?c.firstName+" "+c.lastName:c.name);
if(Array.isArray(clientName))clientName=clientName[0]||"";
if(activeTab==="details")loadNDISClientDetails(clientName,c);
if(activeTab==="supportPlan")loadNDISClientSupportPlan(clientName);
if(activeTab==="calendar")loadNDISClientCalendar(clientName);
if(activeTab==="ndisPlan"||activeTab==="ndisPlanBudget")loadNDISClientPlan(clientName);
if(activeTab==="budget")loadNDISClientBudgets(clientName);
if(activeTab==="progress")loadProgressNotes("",clientName);
if(activeTab==="incidents")loadIncidentReports("",clientName);
if(activeTab==="history")loadContactHistory("","",clientName);
if(activeTab==="stakeholders")loadStakeholders(clientName,c);
if(activeTab==="documents")loadClientDocs(c.id,clientName);
if(activeTab==="weeklyreports")loadWeeklyReports(clientName);
}
}
function switchContactTab(tabId){if(!selectedConv)return;selectedConv._activeTab=tabId;renderContactDetail()}

// ‚ïê‚ïê‚ïê SERVICE RECORDS MODAL ‚ïê‚ïê‚ïê
function openServiceRecordModal(type){
if(!selectedConv)return;
var c=selectedConv;
var titles={progress:"üìì Progress Notes",incidents:"‚ö†Ô∏è Incident Reports",kms:"üöó KM Records"};
var overlay=document.createElement("div");
overlay.id="srModalOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:9000;display:flex;align-items:stretch;justify-content:center;padding:20px";
var h='<div style="background:var(--surface);border-radius:12px;width:100%;max-width:900px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.2)">';
// Header
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--surface)">';
h+='<div style="display:flex;align-items:center;gap:10px">';
h+='<div style="font-size:16px;font-weight:700;color:var(--text)">'+(titles[type]||type)+'</div>';
h+='<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:6px;background:rgba(10,175,171,.08);color:var(--teal)">'+(c.name||"")+'</span>';
h+='</div>';
h+='<div style="display:flex;align-items:center;gap:8px">';
// Sub-nav buttons
h+='<button onclick="switchServiceRecord(\'progress\')" style="padding:5px 12px;font-size:10px;font-weight:700;border:1px solid '+(type==="progress"?"var(--teal)":"var(--border)")+';background:'+(type==="progress"?"rgba(10,175,171,.08)":"var(--surface2)")+';color:'+(type==="progress"?"var(--teal)":"var(--muted)")+';border-radius:var(--rs);cursor:pointer;font-family:inherit">üìì Notes</button>';
h+='<button onclick="switchServiceRecord(\'incidents\')" style="padding:5px 12px;font-size:10px;font-weight:700;border:1px solid '+(type==="incidents"?"var(--red)":"var(--border)")+';background:'+(type==="incidents"?"rgba(239,68,68,.06)":"var(--surface2)")+';color:'+(type==="incidents"?"var(--red)":"var(--muted)")+';border-radius:var(--rs);cursor:pointer;font-family:inherit">‚ö†Ô∏è Incidents</button>';
h+='<button onclick="switchServiceRecord(\'kms\')" style="padding:5px 12px;font-size:10px;font-weight:700;border:1px solid '+(type==="kms"?"#F59E0B":"var(--border)")+';background:'+(type==="kms"?"rgba(245,158,11,.06)":"var(--surface2)")+';color:'+(type==="kms"?"#F59E0B":"var(--muted)")+';border-radius:var(--rs);cursor:pointer;font-family:inherit">üöó KMs</button>';
h+='<button onclick="document.getElementById(\'srModalOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px;margin-left:4px">‚úï</button>';
h+='</div></div>';
// Body
h+='<div style="flex:1;overflow-y:auto;padding:20px" id="srModalBody">';
h+='<div style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading...</div>';
h+='</div></div>';
overlay.innerHTML=h;
overlay.addEventListener("click",function(e){if(e.target===overlay)overlay.remove()});
document.body.appendChild(overlay);
// Load data
loadServiceRecordData(type,c);
}

function switchServiceRecord(type){
var overlay=document.getElementById("srModalOverlay");
if(overlay)overlay.remove();
openServiceRecordModal(type);
}

function loadServiceRecordData(type,c){
var el=document.getElementById("srModalBody");if(!el)return;

// Universal date formatter: handles ISO, AU dd/mm/yyyy, and Airtable formula dates
function fmtDT(v){if(!v)return"";var d;if(typeof v==="string"&&v.match(/^\d{4}-/)){d=new Date(v)}else if(typeof v==="string"&&v.indexOf("/")>=0){var p=v.split(/[\s,]+/);var dp=p[0].split("/");if(dp.length===3){var yr=dp[2];if(yr.length===2)yr=(parseInt(yr)>50?"19":"20")+yr;d=new Date(yr+"-"+dp[1]+"-"+dp[0]);if(p.length>1){var tp=p[1];if(tp){var tm=tp.match(/(\d+):(\d+)\s*(am|pm)?/i);if(tm){var hr=parseInt(tm[1]);var mn=parseInt(tm[2]);if(tm[3]&&tm[3].toLowerCase()==="pm"&&hr<12)hr+=12;if(tm[3]&&tm[3].toLowerCase()==="am"&&hr===12)hr=0;d.setHours(hr,mn)}}}}else{d=new Date(v)}}else{d=new Date(v)}
if(!d||isNaN(d))return v;
return("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+String(d.getFullYear()).slice(-2)+" "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true}).toUpperCase()}

// Sort helper: parse to Date for comparison, newest first
function sortDateDesc(arr,field){arr.sort(function(a,b){var da=new Date(a[field]||"");var db=new Date(b[field]||"");if(isNaN(da))da=new Date(0);if(isNaN(db))db=new Date(0);return db-da});return arr}

if(type==="progress"){
if(!c.email){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)">No email address ‚Äî cannot load progress notes</div>';return}
apiCall("GET","/api/contacts/progress-notes?email="+encodeURIComponent(c.email)).then(function(records){
if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìì</div><div style="font-size:13px;font-weight:600">No progress notes found</div></div>';return}
sortDateDesc(records,"startDate");
var h='<div style="font-size:11px;color:var(--muted);margin-bottom:12px;font-weight:600">'+records.length+' progress note'+(records.length!==1?"s":"")+'</div>';
records.forEach(function(r,idx){
var shiftStart=fmtDT(r.startDate);
var shiftEnd=fmtDT(r.endDate);
var createdDT=fmtDT(r.created);
var hasDate=shiftStart&&shiftStart!==r.startDate;

h+='<div style="padding:0;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;border-left:3px solid var(--teal);overflow:hidden">';

// Clickable summary row
h+='<div onclick="togglePNDetail('+idx+')" style="padding:12px 14px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background .1s" onmouseover="this.style.background=\'rgba(10,175,171,.03)\'" onmouseout="this.style.background=\'transparent\'">';
h+='<div style="flex:1;min-width:0">';

// Shift date/time line
h+='<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
h+='<span style="font-size:13px;font-weight:700;color:var(--text)">'+(shiftStart||"No date")+'</span>';
if(shiftEnd)h+='<span style="font-size:10px;color:var(--muted)">‚Üí '+shiftEnd+'</span>';
if(r.totalHours)h+='<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(10,175,171,.08);color:var(--teal)">'+r.totalHours+'h</span>';
h+='</div>';

// Client + created
h+='<div style="display:flex;align-items:center;gap:8px;margin-top:3px;flex-wrap:wrap">';
if(r.client)h+='<span style="font-size:10px;font-weight:600;color:var(--royal)">üë§ '+r.client+'</span>';
if(r.shiftType)h+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:3px;background:rgba(139,92,246,.08);color:#8B5CF6">'+r.shiftType+'</span>';
if(createdDT)h+='<span style="font-size:9px;color:var(--muted)">Created: '+createdDT+'</span>';
h+='</div>';

// Preview of notes (truncated)
if(r.notes){var preview=String(r.notes).substring(0,120);h+='<div style="font-size:11px;color:var(--muted);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+preview+(r.notes.length>120?"‚Ä¶":"")+'</div>'}

h+='</div>';
h+='<span id="pnChev'+idx+'" style="font-size:14px;color:var(--muted);flex-shrink:0;transition:transform .2s;margin-left:8px">‚ñ∏</span>';
h+='</div>';

// Expandable detail section (hidden by default)
h+='<div id="pnDetail'+idx+'" style="display:none;border-top:1px solid var(--border);padding:14px;background:rgba(10,175,171,.02)">';

// Show all populated fields from allFields
var af=r.allFields||{};
var skipFields=["Support Workers Name","Employees","Client","Client Name","Full Name (from Employees)","Created","Start Date & Time Formula","End Date & Time Formula","Start Date and Time","End Date and Time","Attachments","Files","Upload"];
var fieldEntries=[];
Object.keys(af).forEach(function(k){
if(skipFields.indexOf(k)>=0)return;
var v=af[k];
if(v===null||v===undefined||v===""||(Array.isArray(v)&&v.length===0))return;
// Skip attachment arrays (they have url/filename properties)
if(Array.isArray(v)&&v.length>0&&v[0]&&typeof v[0]==="object"&&v[0].url)return;
// Format value
var display;
if(Array.isArray(v))display=v.join(", ");
else if(typeof v==="boolean")display=v?"Yes":"No";
else display=String(v);
if(display.trim()==="")return;
fieldEntries.push({key:k,val:display});
});

if(fieldEntries.length>0){
h+='<div style="display:grid;grid-template-columns:1fr;gap:0">';
fieldEntries.forEach(function(fe){
var isLong=fe.val.length>100;
h+='<div style="padding:8px 0;border-bottom:1px solid var(--border)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px">'+fe.key+'</div>';
h+='<div style="font-size:12px;color:var(--text);line-height:1.5;'+(isLong?"white-space:pre-wrap":"")+'">'+fe.val+'</div>';
h+='</div>';
});
h+='</div>';
}else{
h+='<div style="font-size:11px;color:var(--muted);text-align:center;padding:8px">No additional detail fields</div>';
}

// Files/attachments
if(r.files&&r.files.length>0){
h+='<div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">';
r.files.forEach(function(f){h+='<a href="'+f.url+'" target="_blank" style="font-size:10px;font-weight:600;color:var(--teal);text-decoration:none;padding:4px 10px;background:rgba(10,175,171,.06);border:1px solid rgba(10,175,171,.15);border-radius:4px">üìé '+f.name+'</a>'});
h+='</div>';
}

h+='</div>';
h+='</div>';
});
el.innerHTML=h;
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:20px;text-align:center">Failed to load: '+e.message+'</div>'});

}else if(type==="incidents"){
if(!c.email){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)">No email address ‚Äî cannot load incidents</div>';return}
apiCall("GET","/api/contacts/incidents?email="+encodeURIComponent(c.email)).then(function(records){
if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="font-size:13px;font-weight:600">No incident reports found</div></div>';return}
sortDateDesc(records,"date");
var h='<div style="font-size:11px;color:var(--muted);margin-bottom:12px;font-weight:600">'+records.length+' incident'+(records.length!==1?"s":"")+'</div>';
records.forEach(function(r,idx){
var dateStr=fmtDT(r.date);
var severity=r.severity||"";var sevCol=severity.toLowerCase().indexOf("critical")>=0||severity.toLowerCase().indexOf("high")>=0?"var(--red)":severity.toLowerCase().indexOf("medium")>=0?"#F59E0B":"var(--muted)";

h+='<div style="padding:0;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;border-left:3px solid var(--red);overflow:hidden">';

// Clickable summary row
h+='<div onclick="toggleIRDetail('+idx+')" style="padding:12px 14px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background .1s" onmouseover="this.style.background=\'rgba(239,68,68,.02)\'" onmouseout="this.style.background=\'transparent\'">';
h+='<div style="flex:1;min-width:0">';

// Date + badges
h+='<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
h+='<span style="font-size:13px;font-weight:700;color:var(--text)">'+(dateStr||"No date")+'</span>';
if(severity)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+sevCol+'10;color:'+sevCol+';border:1px solid '+sevCol+'30">'+severity+'</span>';
if(r.reportable&&String(r.reportable).toLowerCase().indexOf("yes")>=0)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2)">REPORTABLE</span>';
h+='</div>';

// Client + categories
h+='<div style="display:flex;align-items:center;gap:6px;margin-top:3px;flex-wrap:wrap">';
if(r.client)h+='<span style="font-size:10px;font-weight:600;color:var(--royal)">üë§ '+r.client+'</span>';
if(r.type)h+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:3px;background:rgba(139,92,246,.08);color:#8B5CF6">'+r.type+'</span>';
if(r.categories&&r.categories.length>0){var cats=Array.isArray(r.categories)?r.categories:[r.categories];cats.forEach(function(cat){h+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:3px;background:rgba(245,158,11,.08);color:#D97706">'+cat+'</span>'})}
h+='</div>';

// Description preview
if(r.description){var prev=String(r.description).substring(0,120);h+='<div style="font-size:11px;color:var(--muted);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+prev+(r.description.length>120?"‚Ä¶":"")+'</div>'}

h+='</div>';
h+='<span id="irChev'+idx+'" style="font-size:14px;color:var(--muted);flex-shrink:0;transition:transform .2s;margin-left:8px">‚ñ∏</span>';
h+='</div>';

// Expandable detail section
h+='<div id="irDetail'+idx+'" style="display:none;border-top:1px solid var(--border);padding:14px;background:rgba(239,68,68,.01)">';

var af=r.allFields||{};
var skipFields=["Person completing IR","Employees","Client","Client Name","Full Name (from Person completing IR)","Attachments","Files","Upload","Upload File here"];
var fieldEntries=[];
Object.keys(af).forEach(function(k){
if(skipFields.indexOf(k)>=0)return;
var v=af[k];
if(v===null||v===undefined||v===""||(Array.isArray(v)&&v.length===0))return;
if(Array.isArray(v)&&v.length>0&&v[0]&&typeof v[0]==="object"&&v[0].url)return;
var display;
if(Array.isArray(v))display=v.join(", ");
else if(typeof v==="boolean")display=v?"Yes":"No";
else display=String(v);
if(display.trim()==="")return;
fieldEntries.push({key:k,val:display});
});

if(fieldEntries.length>0){
h+='<div style="display:grid;grid-template-columns:1fr;gap:0">';
fieldEntries.forEach(function(fe){
var isLong=fe.val.length>100;
h+='<div style="padding:8px 0;border-bottom:1px solid var(--border)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px">'+fe.key+'</div>';
h+='<div style="font-size:12px;color:var(--text);line-height:1.5;'+(isLong?"white-space:pre-wrap":"")+'">'+fe.val+'</div>';
h+='</div>';
});
h+='</div>';
}

if(r.files&&r.files.length>0){
h+='<div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">';
r.files.forEach(function(f){h+='<a href="'+f.url+'" target="_blank" style="font-size:10px;font-weight:600;color:var(--teal);text-decoration:none;padding:4px 10px;background:rgba(10,175,171,.06);border:1px solid rgba(10,175,171,.15);border-radius:4px">üìé '+f.name+'</a>'});
h+='</div>';
}

h+='</div>';
h+='</div>';
});
el.innerHTML=h;
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:20px;text-align:center">Failed to load: '+e.message+'</div>'});

}else if(type==="kms"){
var url="/api/contacts/kms?";
if(c.email)url+="email="+encodeURIComponent(c.email);
if(c.name)url+=(c.email?"&":"")+"name="+encodeURIComponent(c.name);
apiCall("GET",url).then(function(records){
if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üöó</div><div style="font-size:13px;font-weight:600">No KM records found</div></div>';return}
sortDateDesc(records,"date");
var totalKms=records.reduce(function(a,r){return a+(r.kms||0)},0);
var h='<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div style="font-size:11px;color:var(--muted);font-weight:600">'+records.length+' trip'+(records.length!==1?"s":"")+'</div><div style="padding:4px 12px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;font-size:13px;font-weight:700;color:#F59E0B;font-family:JetBrains Mono,monospace">Total: '+totalKms.toFixed(1)+' km</div></div>';
records.forEach(function(r){
var dateStr=fmtDT(r.date);
h+='<div style="padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">';
h+='<div><div style="font-size:12px;font-weight:600;color:var(--text)">'+(dateStr||"No date")+'</div>';
if(r.client)h+='<div style="font-size:10px;font-weight:600;color:var(--royal)">üë§ '+r.client+'</div>';
if(r.from&&r.to)h+='<div style="font-size:10px;color:var(--muted)">'+r.from+' ‚Üí '+r.to+'</div>';
h+='</div>';
h+='<div style="font-size:16px;font-weight:700;color:#F59E0B;font-family:JetBrains Mono,monospace">'+(r.kmsRaw||((r.kms||0)+" km"))+'</div></div>';
});
el.innerHTML=h;
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:20px;text-align:center">Failed to load: '+e.message+'</div>'});
}
}

function togglePNDetail(idx){
var det=document.getElementById("pnDetail"+idx);
var chev=document.getElementById("pnChev"+idx);
if(!det)return;
if(det.style.display==="none"){det.style.display="block";if(chev)chev.style.transform="rotate(90deg)"}
else{det.style.display="none";if(chev)chev.style.transform=""}
}

function toggleIRDetail(idx){
var det=document.getElementById("irDetail"+idx);
var chev=document.getElementById("irChev"+idx);
if(!det)return;
if(det.style.display==="none"){det.style.display="block";if(chev)chev.style.transform="rotate(90deg)"}
else{det.style.display="none";if(chev)chev.style.transform=""}
}

// ‚ïê‚ïê‚ïê EMPLOYMENT TAB ‚ïê‚ïê‚ïê
var _payRatesCache={tfn:null,contractor:null};
function fmtPayRate(v){if(!v&&v!==0)return"";var s=String(v).replace(/[$,]/g,"");var n=parseFloat(s);if(isNaN(n))return String(v);return"$"+n.toFixed(2)}

function loadEmploymentTab(c){
var el=document.getElementById("employmentContent");if(!el)return;
var ct=(c.contactType||"").toLowerCase();
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;

// Store current sub-tab or default to payDetails
if(!c._empSubTab)c._empSubTab="payDetails";

var h='';

// ‚îÄ‚îÄ Sub-menu tabs ‚îÄ‚îÄ
h+='<div style="display:flex;gap:4px;margin-bottom:16px;border-bottom:2px solid var(--border);padding-bottom:0">';
var empSubTabs=[
{id:"payDetails",icon:"üí∞",label:"Pay Details"},
{id:"contracts",icon:"üìù",label:"Contracts & Documents"}
];
empSubTabs.forEach(function(t){
var isActive=c._empSubTab===t.id;
h+='<button onclick="switchEmpSubTab(\''+t.id+'\')" style="padding:10px 18px;font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;border:none;background:'+(isActive?"var(--surface)":"transparent")+';color:'+(isActive?"var(--teal)":"var(--muted)")+';border-bottom:2px solid '+(isActive?"var(--teal)":"transparent")+';margin-bottom:-2px;display:flex;align-items:center;gap:6px;transition:all .12s;border-radius:var(--rs) var(--rs) 0 0" onmouseover="if(!'+isActive+')this.style.color=\'var(--text)\'" onmouseout="if(!'+isActive+')this.style.color=\'var(--muted)\'">';
h+='<span>'+t.icon+'</span> '+t.label+'</button>';
});
h+='</div>';

if(c._empSubTab==="payDetails"){
h+=buildPayDetailsContent(c,isContractor);
}else if(c._empSubTab==="contracts"){
h+=buildContractsContent(c,isContractor);
}

el.innerHTML=h;

// Load data based on active sub-tab
if(c._empSubTab==="payDetails"){
loadRateTable(isContractor);
}else if(c._empSubTab==="contracts"){
loadDocSigningList(c);
}
}

function switchEmpSubTab(tab){
var c=selectedConv;if(!c)return;
c._empSubTab=tab;
loadEmploymentTab(c);
}

function buildPayDetailsContent(c,isContractor){
var empLabel=isContractor?"Independant Contractor":"TFN Employee";
var empColor=isContractor?"#8B5CF6":"#3B82F6";
var h='';

// ‚îÄ‚îÄ Employment Details Section ‚îÄ‚îÄ
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üíº</span> Employment Details</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">';

// Employment type badge
h+='<div style="padding:12px;background:'+empColor+'0a;border:1px solid '+empColor+'25;border-radius:var(--r)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Employment Type</div>';
h+='<div style="font-size:13px;font-weight:700;color:'+empColor+'">'+empLabel+'</div></div>';

// Start date
var startRaw=c.employmentStartDate||"";
var startDisplay="Not set";
var startDateObj=null;
if(startRaw){
if(startRaw.indexOf("/")>=0){var p=startRaw.split("/");startDateObj=new Date(p[2],p[1]-1,p[0]);if(!isNaN(startDateObj))startDisplay=("0"+parseInt(p[0])).slice(-2)+"/"+("0"+parseInt(p[1])).slice(-2)+"/"+String(p[2]).slice(-2)}
if(!startDateObj||isNaN(startDateObj)){startDateObj=new Date(startRaw);if(!isNaN(startDateObj))startDisplay=("0"+startDateObj.getDate()).slice(-2)+"/"+("0"+(startDateObj.getMonth()+1)).slice(-2)+"/"+String(startDateObj.getFullYear()).slice(-2)}
if(!startDateObj||isNaN(startDateObj)){startDisplay=startRaw;startDateObj=null}
}
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Start Date</div>';
h+='<div style="font-size:13px;font-weight:600;color:var(--text)">'+startDisplay+'</div></div>';

// Arrangement
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Arrangement</div>';
h+='<div style="font-size:13px;font-weight:600;color:var(--text)">'+(c.typeOfEmployment||"Not set")+'</div></div>';

// Tenure
if(startDateObj&&!isNaN(startDateObj)){
var now=new Date();var months=Math.round((now-startDateObj)/(1000*60*60*24*30.44));var yrs=Math.floor(months/12);var mo=months%12;var tenStr=yrs>0?yrs+"y "+mo+"m":mo+"m";
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Tenure</div>';
h+='<div style="font-size:13px;font-weight:600;color:var(--text)">'+tenStr+'</div></div>';
}

h+='</div>';

// Secondary employment
if(c.secondaryEmployment||c.detailsOfOtherEmployment){
h+='<div style="padding:10px 12px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:var(--r);margin-top:8px;font-size:11px">';
h+='<span style="font-weight:700;color:#D97706">‚ö†Ô∏è Secondary Employment:</span> '+(c.secondaryEmployment||"")+(c.detailsOfOtherEmployment?" ‚Äî "+c.detailsOfOtherEmployment:"")+'</div>';
}
h+='</div>';

// ‚îÄ‚îÄ Current Pay Rate Section ‚îÄ‚îÄ
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üí∞</span> Current Pay Rate</div>';

if(isContractor&&c.contractorPayRateName){
var lvlCol=c.contractorPayRateName.indexOf("Gold")>=0?"#F59E0B":c.contractorPayRateName.indexOf("Silver")>=0?"#9CA3AF":"#CD7F32";
h+='<div style="padding:16px;background:linear-gradient(135deg,'+lvlCol+'08,'+lvlCol+'15);border:2px solid '+lvlCol+'40;border-radius:var(--r);margin-bottom:12px">';
h+='<div style="font-size:16px;font-weight:800;color:'+lvlCol+';margin-bottom:12px">'+c.contractorPayRateName+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px">';
var cRates=[{l:"Weekday",v:fmtPayRate(c.contractorWeekday)},{l:"Weeknight",v:fmtPayRate(c.contractorWeeknight)},{l:"Saturday",v:fmtPayRate(c.contractorSaturday)},{l:"Sunday",v:fmtPayRate(c.contractorSunday)},{l:"Pub Holiday",v:fmtPayRate(c.contractorPubHoliday)},{l:"Sleepover",v:fmtPayRate(c.contractorSleepover)}];
cRates.forEach(function(r){if(r.v){h+='<div style="text-align:center;padding:8px;background:rgba(255,255,255,.6);border-radius:6px"><div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase">'+r.l+'</div><div style="font-size:16px;font-weight:800;color:var(--text);font-family:JetBrains Mono,monospace;margin-top:2px">'+r.v+'</div></div>'}});
h+='</div></div>';
}else if(!isContractor&&c.tfnPayLevel){
h+='<div style="padding:16px;background:linear-gradient(135deg,rgba(59,130,246,.04),rgba(59,130,246,.1));border:2px solid rgba(59,130,246,.25);border-radius:var(--r);margin-bottom:12px">';
h+='<div style="font-size:14px;font-weight:800;color:#3B82F6;margin-bottom:12px">'+c.tfnPayLevel+'</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px">';
var tRates=[{l:"Day Rate",v:fmtPayRate(c.tfnDayRate)},{l:"Afternoon",v:fmtPayRate(c.tfnAfternoon)},{l:"Night",v:fmtPayRate(c.tfnNight)},{l:"Saturday",v:fmtPayRate(c.tfnSaturday)},{l:"Sunday",v:fmtPayRate(c.tfnSunday)},{l:"Pub Holiday",v:fmtPayRate(c.tfnPubHoliday)},{l:"Sleepover",v:fmtPayRate(c.tfnSleepover)}];
tRates.forEach(function(r){if(r.v){h+='<div style="text-align:center;padding:8px;background:rgba(255,255,255,.6);border-radius:6px"><div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase">'+r.l+'</div><div style="font-size:16px;font-weight:800;color:var(--text);font-family:JetBrains Mono,monospace;margin-top:2px">'+r.v+'</div></div>'}});
h+='</div></div>';
}else{
h+='<div style="padding:16px;background:rgba(245,158,11,.06);border:2px dashed rgba(245,158,11,.3);border-radius:var(--r);text-align:center">';
h+='<div style="font-size:13px;font-weight:700;color:#D97706;margin-bottom:4px">‚ö†Ô∏è No pay rate assigned</div>';
h+='<div style="font-size:11px;color:var(--muted)">Use the AI recommendation below or assign manually in Airtable</div></div>';
}
h+='</div>';

// ‚îÄ‚îÄ AI Pay Rate Recommendation ‚îÄ‚îÄ
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">ü§ñ</span> AI Pay Rate Recommendation</div>';
if(c.cvResume&&c.cvResume.length>0){
h+='<div style="padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px">';
h+='<div style="font-size:11px;color:var(--muted);margin-bottom:8px">Based on CV: <strong style="color:var(--teal)">'+c.cvResume[0].name+'</strong></div>';
h+='<button id="aiPayRateBtn" onclick="aiRecommendPayRate()" style="padding:10px 20px;background:linear-gradient(135deg,var(--teal),#0E9AA7);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:8px"><span>ü§ñ</span> Analyse CV & Recommend Pay Level</button>';
h+='<div id="aiPayRateResult" style="margin-top:12px"></div></div>';
}else{
h+='<div style="padding:14px;background:var(--surface2);border:1px dashed var(--border);border-radius:var(--r);text-align:center;color:var(--muted);font-size:11px">No CV/Resume uploaded ‚Äî upload one to enable AI pay rate analysis</div>';
}
h+='</div>';

// ‚îÄ‚îÄ Full Rate Table ‚îÄ‚îÄ
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìä</span> '+(isContractor?"Contractor":"TFN Casual/Part-Time")+' Rate Table (FY 2025-26)</div>';
h+='<div id="fullRateTable"><div style="text-align:center;padding:12px;color:var(--muted);font-size:11px">Loading rate table...</div></div>';
h+='</div>';

return h;
}

function buildContractsContent(c,isContractor){
var h='';

// ‚îÄ‚îÄ Existing Employment Contract from Airtable ‚îÄ‚îÄ
if(c.employmentContract&&c.employmentContract.length>0){
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìÑ</span> Uploaded Contracts</div>';
h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
c.employmentContract.forEach(function(doc){
h+='<a href="'+doc.url+'" target="_blank" style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.15);border-radius:var(--r);text-decoration:none;transition:all .12s" onmouseover="this.style.background=\'rgba(10,147,150,.1)\'" onmouseout="this.style.background=\'rgba(10,147,150,.04)\'">';
h+='<span style="font-size:20px">üìÑ</span><div><div style="font-size:12px;font-weight:700;color:var(--teal)">'+(doc.name||"Employment Contract")+'</div>';
if(doc.size)h+='<div style="font-size:9px;color:var(--muted)">'+(doc.size>1048576?(doc.size/1048576).toFixed(1)+"MB":(doc.size/1024).toFixed(0)+"KB")+'</div>';
h+='</div></a>';
});
h+='</div></div>';
}

// ‚îÄ‚îÄ Documents for Signing ‚îÄ‚îÄ
h+='<div style="margin-bottom:20px">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px"><span style="font-size:18px">‚úçÔ∏è</span> Documents for Signing</div>';
h+='<button onclick="openSendDocModal()" style="padding:8px 16px;background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;border:none;border-radius:var(--rs);font-size:11px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:6px"><span>üì§</span> Send for Signing</button>';
h+='</div>';
h+='<div id="docSigningList"><div style="text-align:center;padding:12px;color:var(--muted);font-size:11px">Loading signing requests...</div></div>';
h+='</div>';

return h;
}

function loadRateTable(isContractor){
var endpoint=isContractor?"/api/pay-rates/contractor":"/api/pay-rates/tfn";
var cacheKey=isContractor?"contractor":"tfn";
if(_payRatesCache[cacheKey]){renderRateTable(_payRatesCache[cacheKey],isContractor);return}
apiCall("GET",endpoint).then(function(data){
_payRatesCache[cacheKey]=data;
renderRateTable(data,isContractor);
}).catch(function(e){
var el=document.getElementById("fullRateTable");
if(el)el.innerHTML='<div style="color:var(--red);font-size:11px">Failed to load: '+e.message+'</div>';
});
}

function renderRateTable(data,isContractor){
var el=document.getElementById("fullRateTable");if(!el)return;
if(!data||data.length===0){el.innerHTML='<div style="color:var(--muted);font-size:11px">No rate data available</div>';return}
var h='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">';
if(isContractor){
h+='<thead><tr style="background:var(--surface2)">';
h+='<th style="padding:8px;text-align:left;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Level</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Weekday</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Weeknight</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Sat</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Sun</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Pub Hol</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Sleepover</th>';
h+='<th style="padding:8px;text-align:left;font-weight:700;border-bottom:2px solid var(--border);color:var(--muted)">Criteria</th>';
h+='</tr></thead><tbody>';
data.forEach(function(r){
var lvlCol=r.name.indexOf("Gold")>=0?"#F59E0B":r.name.indexOf("Silver")>=0?"#9CA3AF":"#CD7F32";
var isActive=selectedConv&&selectedConv.contractorPayRateName&&selectedConv.contractorPayRateName.indexOf(r.name)>=0;
h+='<tr style="'+(isActive?"background:rgba(10,175,171,.06);font-weight:700":"")+'"><td style="padding:8px;border-bottom:1px solid var(--border)"><span style="color:'+lvlCol+';font-weight:700">'+r.name+'</span>'+(isActive?' <span style="font-size:9px;background:var(--teal);color:#fff;padding:1px 6px;border-radius:4px">CURRENT</span>':'')+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+(r.weekday||"")+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+(r.weeknight||"")+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+(r.saturday||"")+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+(r.sunday||"")+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+(r.pubHolidays||"")+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+(r.sleepover||"")+'</td>';
h+='<td style="padding:8px;border-bottom:1px solid var(--border);font-size:10px;color:var(--muted);max-width:200px">'+(r.description||"")+'</td></tr>';
});
}else{
// Sort TFN rates: Casual levels first (1.1‚Üí5.2) then Part Time (3.1‚Üí5.2)
var levelOrder=["Home Care Level 1.1 (Casual)","Home Care Level 2.1 (Casual)","Home Care Level 2.2 (Casual)","Home Care Level 3.1 (Casual)","Home Care Level 3.2 (Casual)","Home Care Level 4.1 (Casual)","Home Care Level 4.2 (Casual)","Home Care Level 5.1 (Casual)","Home Care Level 5.2 (Casual)","Home Care PPT 3.1 (Part Time)","Home Care PPT 3.2 (Part Time)","Home Care PPT 4.1 (Part Time)","Home Care PPT 4.2 (Part Time)","Home Care PPT 5.1 (Part Time)","Home Care PPT 5.2 (Part Time)"];
data.sort(function(a,b){var ai=levelOrder.indexOf(a.payLevel);var bi=levelOrder.indexOf(b.payLevel);if(ai===-1)ai=999;if(bi===-1)bi=999;return ai-bi});
// Row colours matching Airtable style
var rowColors=["#EFF6FF","#F0FDF4","#FFFBEB","#FDF2F8","#F5F3FF","#ECFDF5","#FEF3C7","#FCE7F3","#EDE9FE","#F0FDFA","#FEF9C3","#FBCFE8","#DDD6FE","#CCFBF1","#FDE68A"];
function fmtUpdated(v){if(!v)return"";try{var d=new Date(v);if(isNaN(d))return v;return("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+d.getFullYear()+" "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true}).toLowerCase()}catch(e){return v}}
h+='<thead><tr style="background:var(--surface2)">';
h+='<th style="padding:8px 10px;text-align:left;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Pay Level</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Day Rate</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Afternoon</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Night</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Saturday</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Sunday</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Pub Holidays</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--text)">Sleepover</th>';
h+='<th style="padding:8px;text-align:right;font-weight:700;border-bottom:2px solid var(--border);color:var(--muted);font-size:9px">Last Updated</th>';
h+='</tr></thead><tbody>';
data.forEach(function(r,idx){
var isActive=selectedConv&&selectedConv.tfnPayLevel&&selectedConv.tfnPayLevel===r.payLevel;
var bg=isActive?"rgba(10,175,171,.1)":rowColors[idx%rowColors.length];
var leftBorder=isActive?"3px solid var(--teal)":"3px solid "+(rowColors[idx%rowColors.length]==="rgba(10,175,171,.1)"?"var(--teal)":rowColors[idx%rowColors.length].replace("FF","CC"));
h+='<tr style="background:'+bg+'"><td style="padding:8px 10px;border-bottom:1px solid var(--border);border-left:'+leftBorder+';font-weight:600;font-size:10px">'+(r.payLevel||"")+''+(isActive?' <span style="font-size:8px;background:var(--teal);color:#fff;padding:1px 6px;border-radius:4px;margin-left:4px">CURRENT</span>':'')+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace;font-weight:600">'+fmtPayRate(r.dayRate)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+fmtPayRate(r.afternoon)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+fmtPayRate(r.night)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+fmtPayRate(r.saturday)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+fmtPayRate(r.sunday)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+fmtPayRate(r.pubHolidays)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-family:JetBrains Mono,monospace">'+fmtPayRate(r.sleepover)+'</td>';
h+='<td style="padding:8px;text-align:right;border-bottom:1px solid var(--border);font-size:9px;color:var(--muted);white-space:nowrap">'+fmtUpdated(r.lastUpdated)+'</td></tr>';
});
}
h+='</tbody></table></div>';
el.innerHTML=h;
}

function aiRecommendPayRate(){
var c=selectedConv;if(!c)return;
var btn=document.getElementById("aiPayRateBtn");
var resEl=document.getElementById("aiPayRateResult");
if(btn){btn.disabled=true;btn.innerHTML='<span class="spin" style="width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%"></span> Analysing CV & checking Fair Work compliance...'}

var ct=(c.contactType||"").toLowerCase();
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;

var cvInfo=(c.cvResume&&c.cvResume.length>0)?c.cvResume[0].name:"No CV";
var empStart=c.employmentStartDate||"";
var tenure="";
if(empStart){try{var sd=new Date(empStart);if(isNaN(sd)){var p=empStart.split("/");sd=new Date(p[2],p[1]-1,p[0])}if(!isNaN(sd)){var mo=Math.round((new Date()-sd)/(1000*60*60*24*30.44));tenure=mo+" months at DCS"}}catch(e){}}

var jobDescContext="DCS SUPPORT WORKER JOB DESCRIPTION (SCHADS Award ‚Äî Home Care Stream):\n"
+"Classification: Home Care Stream, Level 3.1 (base). May be paid above Award rates (Levels 3.2 to 5.2).\n"
+"Casual employees receive 25% loading in lieu of paid leave. Part-time employees accrue leave per NES and Award.\n\n"
+"MANDATORY QUALIFICATIONS:\n"
+"- Minimum Certificate III in Individual Support (Disability) or higher ‚Äî OR actively enrolled within 21 days of commencing\n"
+"- NDIS Worker Screening Clearance (Yellow Card)\n"
+"- Paid Blue Card (Working with Children Check)\n"
+"- Senior First Aid Certificate (updated every 3 years)\n"
+"- CPR Certificate (updated every 12 months)\n"
+"- Current Queensland Driver Licence (minimum Green P2)\n"
+"- Own reliable vehicle + comprehensive car insurance\n\n"
+"KEY RESPONSIBILITIES: Person-centred disability support, personal care, community access, follow PBSPs and medication protocols, progress notes and incident reporting, mealtime support, emotional regulation strategies.\n\n"
+"NDIS CODE OF CONDUCT: Must respect participant rights, privacy, provide safe competent supports, act with integrity, report concerns promptly.\n\n"
+"NOTE: The Award classification states Level 3.1 as the BASE level for this role. This means qualified support workers performing the full scope of duties should generally be classified at Level 3.1 or above ‚Äî NOT Level 1.1 or 2.x unless they are genuinely entry-level with no qualification.";

var rateContext="";
if(isContractor){
rateContext="CONTRACTOR PAY LEVELS (DCS Internal):\n"
+"- Level 1 (Bronze): Less than 18 months total disability support experience, with or without formal qualification. Weekday $38.00/hr\n"
+"- Level 2 (Silver): 18+ months experience AND minimum Certificate III in Disability Support or higher qualification. Weekday $43.00/hr\n"
+"- Level 3 (Gold): 5+ years experience AND minimum Diploma in Community Services or similar AND typically holds or is suited for a Senior/Leadership role. Weekday $48.00/hr\n\n"
+"ASSESSMENT CRITERIA: Consider TOTAL industry experience (not just DCS tenure), formal qualifications evident from CV filename, and role seniority.";
}else{
rateContext="TFN CASUAL EMPLOYEE PAY LEVELS (SCHADS Award 2010 ‚Äî Home Care Stream):\n"
+"CASUAL RATES (include 25% loading):\n"
+"- Level 1.1: Entry level, no experience or qualification. Day $32.56 ‚Äî ONLY for staff with zero disability experience and no Cert III\n"
+"- Level 2.1: Some experience OR holds/enrolled in Cert III. Day $34.44\n"
+"- Level 2.2: Cert III completed + approx 1 year experience. Day $34.68\n"
+"- Level 3.1: Cert III/IV + 2+ years experience ‚Äî THIS IS THE JOB DESCRIPTION BASE LEVEL. Day $35.15\n"
+"- Level 3.2: Cert IV + significant experience (3+ years). Day $36.23\n"
+"- Level 4.1: Diploma or equivalent + 3+ years experience. Day $38.34\n"
+"- Level 4.2: Diploma + 4+ years experience or specialist skills. Day $39.11\n"
+"- Level 5.1: Advanced Diploma + 5+ years or team leader capability. Day $41.11\n"
+"- Level 5.2: Degree level + extensive experience or senior specialist. Day $42.74\n\n"
+"PERMANENT PART-TIME RATES (no casual loading):\n"
+"- PPT 3.1 to PPT 5.2 mirror casual levels but for permanent part-time staff.\n\n"
+"CRITICAL FAIR WORK RULES:\n"
+"1. The SCHADS Award MANDATES minimum classification based on duties performed and qualifications held ‚Äî underpaying is a Fair Work Act breach.\n"
+"2. Per the DCS Job Description, the BASE classification is Level 3.1. A worker with Cert III performing full support worker duties MUST be at least Level 3.1.\n"
+"3. Level 1.1 is ONLY appropriate for genuine entry-level workers with NO disability experience and NO Cert III who are in their first role.\n"
+"4. If a worker has Cert III AND 2+ years experience, they MUST be Level 3.1 or above ‚Äî anything lower risks underpayment.\n"
+"5. Always err on the side of paying higher rather than lower to exceed Fair Work compliance. DCS policy is to never underpay.\n"
+"6. Consider TOTAL disability industry experience (not just DCS tenure) when assessing level.";
}

var prompt="You are a Senior HR Specialist and Industrial Relations Advisor for Delta Community Support (DCS), an NDIS disability support provider in Queensland, Australia. "
+"You have deep expertise in the SCHADS Award 2010, Fair Work Act 2009, and NDIS workforce compliance. Your PRIMARY obligation is ensuring DCS EXCEEDS Fair Work legislation at all times ‚Äî underpayment is never acceptable.\n\n"
+"ANALYSE THIS EMPLOYEE AND RECOMMEND THE CORRECT PAY CLASSIFICATION:\n\n"
+"EMPLOYEE: "+c.name+"\n"
+"CONTACT TYPE: "+(c.contactType||"")+"\n"
+"CV/RESUME FILENAME: "+cvInfo+"\n"
+"EMPLOYMENT START AT DCS: "+empStart+(tenure?" ("+tenure+")":"")+"\n"
+"JOB TITLE: "+(c.jobTitle||"Disability Support Worker")+"\n"
+"CURRENT ASSIGNED PAY LEVEL: "+(isContractor?(c.contractorPayRateName||"None assigned"):(c.tfnPayLevel||"None assigned"))+"\n"
+"EMPLOYMENT ARRANGEMENT: "+(c.typeOfEmployment||"Not specified")+"\n\n"
+jobDescContext+"\n\n"
+rateContext+"\n\n"
+"INSTRUCTIONS:\n"
+"1. Analyse the CV filename for clues about qualifications (e.g. 'Disability Support Worker' suggests Cert III, 'Diploma' suggests higher, 'Registered Nurse' suggests degree level)\n"
+"2. Calculate total likely industry experience from employment start date and CV context\n"
+"3. Cross-reference with SCHADS Award classification descriptors\n"
+"4. Ensure the recommendation meets or EXCEEDS the minimum Award requirement ‚Äî NEVER recommend below what the Award mandates\n"
+"5. If the worker holds Cert III and performs full support worker duties per the Job Description, the MINIMUM is Level 3.1\n"
+"6. Provide a clear justification that would withstand a Fair Work audit\n\n"
+"Respond EXACTLY in this format:\n"
+"RECOMMENDED: [Full level name exactly as it appears in the rate table e.g. 'Home Care Level 3.1 (Casual)' or 'Level 2 (Silver)']\n"
+"FAIR_WORK_COMPLIANT: [Yes/No]\n"
+"REASON: [3-4 sentences explaining the classification decision, referencing specific Award criteria, qualifications, experience, and the Job Description base level. Explain why this level meets or exceeds Fair Work requirements.]\n"
+"CONFIDENCE: [High/Medium/Low]\n"
+"WARNING: [Only include if current assigned level appears to be an underpayment risk, otherwise write 'None']";

apiCall("POST","/api/ai/ask",{question:prompt}).then(function(data){
var reply=(data.answer||"No response");
if(btn){btn.disabled=false;btn.innerHTML='<span>ü§ñ</span> Analyse CV & Recommend Pay Level'}
if(resEl){
var recMatch=reply.match(/RECOMMENDED:\s*(.+)/i);
var fwMatch=reply.match(/FAIR_WORK_COMPLIANT:\s*(.+)/i);
var reasonMatch=reply.match(/REASON:\s*([\s\S]*?)(?=\nCONFIDENCE:|\nWARNING:|$)/i);
var confMatch=reply.match(/CONFIDENCE:\s*(.+)/i);
var warnMatch=reply.match(/WARNING:\s*(.+)/i);

var rh='<div style="padding:16px;background:linear-gradient(135deg,rgba(10,175,171,.04),rgba(10,175,171,.1));border:1px solid rgba(10,175,171,.2);border-radius:var(--r)">';

// Recommendation header
if(recMatch){
var recLevel=recMatch[1].trim();
rh+='<div style="font-size:16px;font-weight:800;color:var(--teal);margin-bottom:8px">‚úÖ Recommended: '+recLevel+'</div>';
}

// Fair Work badge + Confidence badge
rh+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">';
if(fwMatch){var fw=fwMatch[1].trim().toLowerCase();rh+='<span style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;background:'+(fw.indexOf("yes")>=0?"rgba(16,185,129,.1)":"rgba(239,68,68,.1)")+';color:'+(fw.indexOf("yes")>=0?"#10B981":"var(--red)")+';border:1px solid '+(fw.indexOf("yes")>=0?"rgba(16,185,129,.3)":"rgba(239,68,68,.3)")+'">‚öñÔ∏è Fair Work: '+fwMatch[1].trim()+'</span>'}
if(confMatch){var conf=confMatch[1].trim().toLowerCase();var confCol=conf.indexOf("high")>=0?"#10B981":conf.indexOf("low")>=0?"var(--red)":"#F59E0B";rh+='<span style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;background:'+confCol+'15;color:'+confCol+';border:1px solid '+confCol+'30">'+confMatch[1].trim()+' confidence</span>'}
rh+='</div>';

// Reason
if(reasonMatch)rh+='<div style="font-size:12px;color:var(--text);line-height:1.6;margin-bottom:10px">'+reasonMatch[1].trim()+'</div>';

// Warning
if(warnMatch&&warnMatch[1].trim().toLowerCase()!=="none"){
rh+='<div style="padding:8px 12px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:6px;margin-bottom:10px"><span style="font-size:11px;font-weight:700;color:var(--red)">‚ö†Ô∏è UNDERPAYMENT RISK: </span><span style="font-size:11px;color:var(--text)">'+warnMatch[1].trim()+'</span></div>';
}

// Fallback if no structured output
if(!recMatch)rh+='<div style="font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+reply+'</div>';

// ‚îÄ‚îÄ User override: Apply or Change ‚îÄ‚îÄ
rh+='<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">';
rh+='<div style="font-size:11px;font-weight:700;color:var(--muted);margin-bottom:8px">SET PAY LEVEL</div>';
rh+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">';
rh+='<select id="payRateOverrideSelect" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);min-width:260px">';
if(isContractor){
["Level 1 (Bronze)","Level 2 (Silver)","Level 3 (Gold)"].forEach(function(lv){
var sel=(recMatch&&recMatch[1].trim().indexOf(lv)>=0)?" selected":"";
rh+='<option value="'+lv+'"'+sel+'>'+lv+'</option>';
});
}else{
["Home Care Level 1.1 (Casual)","Home Care Level 2.1 (Casual)","Home Care Level 2.2 (Casual)","Home Care Level 3.1 (Casual)","Home Care Level 3.2 (Casual)","Home Care Level 4.1 (Casual)","Home Care Level 4.2 (Casual)","Home Care Level 5.1 (Casual)","Home Care Level 5.2 (Casual)","Home Care PPT 3.1 (Part Time)","Home Care PPT 3.2 (Part Time)","Home Care PPT 4.1 (Part Time)","Home Care PPT 4.2 (Part Time)","Home Care PPT 5.1 (Part Time)","Home Care PPT 5.2 (Part Time)"].forEach(function(lv){
var sel=(recMatch&&recMatch[1].trim()===lv)?" selected":"";
rh+='<option value="'+lv+'"'+sel+'>'+lv+'</option>';
});
}
rh+='</select>';
rh+='<button onclick="applyPayRateSelection()" style="padding:8px 18px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer">‚úÖ Apply to Airtable</button>';
rh+='<span id="payRateApplyStatus" style="font-size:10px;color:var(--muted)"></span>';
rh+='</div></div>';

rh+='</div>';
resEl.innerHTML=rh;
}
}).catch(function(e){
if(btn){btn.disabled=false;btn.innerHTML='<span>ü§ñ</span> Analyse CV & Recommend Pay Level'}
if(resEl)resEl.innerHTML='<div style="color:var(--red);font-size:11px">AI analysis failed: '+e.message+'</div>';
});
}

function applyPayRateSelection(){
var c=selectedConv;if(!c||!c.airtableId)return;
var sel=document.getElementById("payRateOverrideSelect");
var status=document.getElementById("payRateApplyStatus");
if(!sel)return;
var level=sel.value;
var ct=(c.contactType||"").toLowerCase();
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;

if(status)status.innerHTML='<span style="color:#F59E0B">‚è≥ Updating Airtable...</span>';

// Determine field name based on type
var fieldName=isContractor?"SW Independant Contractor Rates":"Casual TFN Employees";
// We need to find the record ID of the selected rate level
var cacheKey=isContractor?"contractor":"tfn";
var rateData=_payRatesCache[cacheKey]||[];
var match=null;
if(isContractor){match=rateData.find(function(r){return r.name===level})}
else{match=rateData.find(function(r){return r.payLevel===level})}

if(!match){
// Try loading rates first
var endpoint=isContractor?"/api/pay-rates/contractor":"/api/pay-rates/tfn";
apiCall("GET",endpoint).then(function(data){
_payRatesCache[cacheKey]=data;
if(isContractor)match=data.find(function(r){return r.name===level});
else match=data.find(function(r){return r.payLevel===level});
if(match&&match.id)doApplyRate(c.airtableId,fieldName,match.id,level,status);
else if(status)status.innerHTML='<span style="color:var(--red)">‚ùå Rate record not found</span>';
});
return;
}

if(match&&match.id)doApplyRate(c.airtableId,fieldName,match.id,level,status);
else if(status)status.innerHTML='<span style="color:var(--red)">‚ùå Rate record not found</span>';
}

function doApplyRate(contactId,fieldName,rateRecordId,levelLabel,statusEl){
var updateFields={};
updateFields[fieldName]=[rateRecordId];
apiCall("PATCH","/api/contacts/"+contactId,updateFields).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#10B981;font-weight:700">‚úÖ Updated to '+levelLabel+'</span>';
// Refresh contact data after a moment
setTimeout(function(){
apiCall("GET","/api/contacts").then(function(d){
contacts=d||[];
var updated=contacts.find(function(ct){return ct.airtableId===contactId});
if(updated&&selectedConv){Object.assign(selectedConv,updated);renderContactDetail()}
});
},1500);
}).catch(function(e){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå Failed: '+e.message+'</span>';
});
}

// ‚ïê‚ïê‚ïê LEAVE & UNAVAILABILITY ‚ïê‚ïê‚ïê
function loadLeaveTab(c){
var el=document.getElementById("leaveContent");if(!el)return;
var ct=(c.contactType||"").toLowerCase();
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;
var isCasual=ct.indexOf("casual")>=0||(c.typeOfEmployment||"").toLowerCase().indexOf("casual")>=0;
var isPTFT=!isContractor&&!isCasual;
var empType=isContractor?"Independent Contractor":isCasual?"Casual":(c.typeOfEmployment||"Part Time");

var h='';
// Header with request button
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">';
h+='<div><div style="font-size:16px;font-weight:700;color:var(--text)">üìÖ Leave & Availability</div>';
h+='<div style="font-size:11px;color:var(--muted);margin-top:2px">'+(c.name||"")+' ¬∑ '+empType;
if(isPTFT)h+=' ¬∑ Entitled to Annual Leave & Personal/Sick Leave';
else if(isCasual)h+=' ¬∑ Casual ‚Äî no paid leave entitlements';
else h+=' ¬∑ Contractor ‚Äî no paid leave entitlements';
h+='</div></div>';
h+='<button onclick="openLeaveRequestForm()" style="padding:10px 20px;background:linear-gradient(135deg,var(--teal),#0E9AA7);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:8px;white-space:nowrap"><span>‚ûï</span> Request Leave</button>';
h+='</div>';

// Entitlement info banner
if(isPTFT){
h+='<div style="padding:10px 14px;background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.15);border-radius:var(--r);margin-bottom:16px;display:flex;align-items:flex-start;gap:10px">';
h+='<span style="font-size:16px;flex-shrink:0">‚ÑπÔ∏è</span>';
h+='<div style="font-size:11px;color:var(--text);line-height:1.5"><strong>Leave entitlements (SCHADS Award):</strong> Full-time employees accrue 4 weeks Annual Leave and 10 days Personal/Sick Leave per year. Part-time employees accrue on a pro-rata basis. Annual Leave and Personal/Sick Leave requests require approval from a Super Admin or nominated Manager.</div>';
h+='</div>';
}else{
h+='<div style="padding:10px 14px;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.15);border-radius:var(--r);margin-bottom:16px;display:flex;align-items:flex-start;gap:10px">';
h+='<span style="font-size:16px;flex-shrink:0">‚ö†Ô∏è</span>';
h+='<div style="font-size:11px;color:var(--text);line-height:1.5"><strong>'+(isCasual?"Casual employees":"Independent Contractors")+'</strong> do not accrue paid leave entitlements. Use this section to record dates of unavailability so the rostering team can plan accordingly.</div>';
h+='</div>';
}

// Leave records list
h+='<div id="leaveRecordsList"><div style="text-align:center;padding:20px;color:var(--muted);font-size:11px">Loading leave records...</div></div>';

el.innerHTML=h;
loadLeaveRecords(c);
}

function loadLeaveRecords(c){
var el=document.getElementById("leaveRecordsList");if(!el)return;
if(!c.email){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted);font-size:11px">No email ‚Äî cannot load leave records</div>';return}
apiCall("GET","/api/staff-availability?email="+encodeURIComponent(c.email)).then(function(records){
if(!records||records.length===0){
el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:24px;margin-bottom:6px">üìÖ</div><div style="font-size:12px;font-weight:600">No leave requests yet</div><div style="font-size:10px;margin-top:4px">Click "Request Leave" to submit a new request</div></div>';
return;
}
var now=new Date();now.setHours(0,0,0,0);
var upcoming=[];var past=[];
records.forEach(function(r){
var end=new Date(r.endDate||r.startDate||"");
if(isNaN(end)){upcoming.push(r);return}
if(end>=now)upcoming.push(r);else past.push(r);
});
var h='';
var approved=records.filter(function(r){return(r.status||"").toLowerCase()==="approved"}).length;
var pending=records.filter(function(r){return(r.status||"").toLowerCase()==="pending"}).length;
var totalDaysApproved=records.filter(function(r){return(r.status||"").toLowerCase()==="approved"}).reduce(function(a,r){return a+(parseFloat(r.totalDays)||0)},0);
h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
h+='<div style="padding:6px 12px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs);font-size:10px"><span style="font-weight:700;color:#10B981">'+approved+'</span> <span style="color:var(--muted)">Approved</span></div>';
if(pending>0)h+='<div style="padding:6px 12px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:var(--rs);font-size:10px"><span style="font-weight:700;color:#F59E0B">'+pending+'</span> <span style="color:var(--muted)">Pending</span></div>';
h+='<div style="padding:6px 12px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs);font-size:10px"><span style="font-weight:700;color:var(--royal)">'+totalDaysApproved+'</span> <span style="color:var(--muted)">days approved</span></div>';
h+='</div>';
if(upcoming.length>0){
h+='<div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Upcoming & Current</div>';
upcoming.forEach(function(r){h+=renderLeaveCard(r)});
}
if(past.length>0){
h+='<div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin:12px 0 6px">Past</div>';
past.forEach(function(r){h+=renderLeaveCard(r)});
}
el.innerHTML=h;
}).catch(function(e){el.innerHTML='<div style="color:var(--red);font-size:11px;text-align:center;padding:12px">Failed to load: '+e.message+'</div>'});
}

function renderLeaveCard(r){
var statusLower=(r.status||"").toLowerCase();
var statusCol=statusLower==="approved"?"#10B981":statusLower==="pending"?"#F59E0B":statusLower==="declined"?"var(--red)":"var(--muted)";
var statusBg=statusLower==="approved"?"rgba(16,185,129,.06)":statusLower==="pending"?"rgba(245,158,11,.06)":statusLower==="declined"?"rgba(239,68,68,.06)":"var(--surface2)";
var borderCol=statusLower==="approved"?"#10B981":statusLower==="pending"?"#F59E0B":statusLower==="declined"?"var(--red)":"var(--border)";
function fmtD(v){if(!v)return"";try{var d=new Date(v);if(isNaN(d))return v;return("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+String(d.getFullYear()).slice(-2)}catch(e){return v}}
var typeCol={"Annual Leave":"#3B82F6","Personal/Sick":"#EF4444","Unpaid":"#6B7280","TOIL":"#8B5CF6","Unavailable":"#F59E0B","Other":"#6B7280"};
var ltCol=typeCol[r.leaveType]||"var(--muted)";
var h='<div style="padding:12px;background:'+statusBg+';border:1px solid '+borderCol+'25;border-left:3px solid '+borderCol+';border-radius:var(--r);margin-bottom:6px">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">';
h+='<div style="display:flex;align-items:center;gap:8px">';
h+='<span style="font-size:13px;font-weight:700;color:var(--text)">'+fmtD(r.startDate);
if(r.endDate&&r.endDate!==r.startDate)h+=' ‚Üí '+fmtD(r.endDate);
h+='</span>';
if(r.totalDays)h+='<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(59,130,246,.08);color:var(--royal)">'+r.totalDays+' day'+(parseFloat(r.totalDays)!==1?"s":"")+'</span>';
h+='</div>';
h+='<div style="display:flex;gap:4px;align-items:center">';
h+='<span style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;background:'+ltCol+'12;color:'+ltCol+';border:1px solid '+ltCol+'30">'+(r.leaveType||"‚Äî")+'</span>';
h+='<span style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;background:'+statusCol+'15;color:'+statusCol+';border:1px solid '+statusCol+'30">'+(r.status||"‚Äî")+'</span>';
h+='</div></div>';
if(r.statusComments)h+='<div style="font-size:11px;color:var(--text);margin-top:6px;line-height:1.4">'+r.statusComments+'</div>';
if(r.requiresApproval&&statusLower==="approved")h+='<div style="font-size:10px;color:var(--muted);margin-top:4px">Approved by: <strong>'+r.requiresApproval+'</strong>'+(r.approvedDate?' on '+fmtD(r.approvedDate):'')+'</div>';
if(r.attachments&&r.attachments.length>0){
h+='<div style="margin-top:6px;display:flex;gap:4px;flex-wrap:wrap">';
r.attachments.forEach(function(f){h+='<a href="'+f.url+'" target="_blank" style="font-size:9px;font-weight:600;color:var(--teal);text-decoration:none;padding:2px 8px;background:rgba(10,175,171,.06);border:1px solid rgba(10,175,171,.15);border-radius:4px">üìé '+f.name+'</a>'});
h+='</div>';
}
if(statusLower==="pending"&&currentUser&&(currentUser.role==="superadmin"||currentUser.role==="admin")){
h+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;gap:6px;align-items:center">';
h+='<button onclick="approveLeave(\''+r.id+'\')" style="padding:5px 14px;background:#10B981;color:#fff;border:none;border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">‚úÖ Approve</button>';
h+='<button onclick="declineLeave(\''+r.id+'\')" style="padding:5px 14px;background:var(--red);color:#fff;border:none;border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">‚ùå Decline</button>';
h+='<span id="leaveAction'+r.id+'" style="font-size:10px;color:var(--muted)"></span>';
h+='</div>';
}
h+='</div>';
return h;
}

function openLeaveRequestForm(){
var c=selectedConv;if(!c)return;
var ct=(c.contactType||"").toLowerCase();
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;
var isCasual=ct.indexOf("casual")>=0||(c.typeOfEmployment||"").toLowerCase().indexOf("casual")>=0;
var isPTFT=!isContractor&&!isCasual;
var empType=isContractor?"Independent Contractor":isCasual?"Casual":(c.typeOfEmployment||"Part Time");
var leaveTypes=[];
if(isPTFT){leaveTypes=["Annual Leave","Personal/Sick","Unpaid","TOIL","Other"]}
else if(isCasual){leaveTypes=["Unavailable","Unpaid","TOIL","Other"]}
else{leaveTypes=["Unavailable","Unpaid","Other"]}
var overlay=document.createElement("div");
overlay.id="leaveFormOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10001;display:flex;align-items:center;justify-content:center";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
var html='<div style="background:var(--surface);border-radius:12px;width:440px;max-width:92vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
html+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between"><div style="font-size:16px;font-weight:800;color:var(--text)">üìÖ Request Leave / Unavailability</div><button onclick="document.getElementById(\'leaveFormOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:0;line-height:1">‚úï</button></div>';
html+='<div style="padding:20px">';
html+='<div style="padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:16px;display:flex;align-items:center;gap:10px">';
html+='<div style="width:32px;height:32px;border-radius:50%;background:var(--teal);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px">'+(c.firstName||c.name||"?").charAt(0).toUpperCase()+'</div>';
html+='<div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(c.name||"")+'</div>';
html+='<div style="font-size:10px;color:var(--muted)">'+empType+(isPTFT?"":" ‚Äî Annual Leave & Personal/Sick not available")+'</div></div></div>';
html+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Leave Type *</label>';
html+='<select id="leaveTypeSelect" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)">';
leaveTypes.forEach(function(lt){html+='<option value="'+lt+'">'+lt+'</option>'});
html+='</select></div>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
html+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Start Date *</label>';
html+='<input type="date" id="leaveStartDate" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box"></div>';
html+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">End Date *</label>';
html+='<input type="date" id="leaveEndDate" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box"></div></div>';
html+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Reason / Notes</label>';
html+='<textarea id="leaveReason" rows="3" placeholder="Optional ‚Äî add any details" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text);resize:vertical;box-sizing:border-box"></textarea></div>';
if(isPTFT){
html+='<div style="padding:8px 12px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:var(--rs);margin-bottom:12px;font-size:10px;color:#D97706"><strong>‚ö†Ô∏è Approval Required:</strong> Annual Leave and Personal/Sick requests require approval from a Super Admin or nominated Manager.</div>';
}else{
html+='<div style="padding:8px 12px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs);margin-bottom:12px;font-size:10px;color:#10B981"><strong>‚ÑπÔ∏è Note:</strong> Unavailability requests will be recorded and visible to the rostering team.</div>';
}
html+='<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">';
html+='<button onclick="document.getElementById(\'leaveFormOverlay\').remove()" style="padding:10px 20px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer">Cancel</button>';
html+='<button id="submitLeaveBtn" onclick="submitLeaveRequest()" style="padding:10px 20px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer">Submit Request</button>';
html+='</div>';
html+='<div id="leaveFormStatus" style="margin-top:8px;font-size:11px;text-align:center"></div>';
html+='</div></div>';
overlay.innerHTML=html;
document.body.appendChild(overlay);
var tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
var tmStr=tomorrow.toISOString().split("T")[0];
var startEl=document.getElementById("leaveStartDate");
var endEl=document.getElementById("leaveEndDate");
if(startEl)startEl.value=tmStr;
if(endEl)endEl.value=tmStr;
}

function submitLeaveRequest(){
var c=selectedConv;if(!c)return;
var leaveType=document.getElementById("leaveTypeSelect").value;
var startDate=document.getElementById("leaveStartDate").value;
var endDate=document.getElementById("leaveEndDate").value;
var reason=document.getElementById("leaveReason").value;
var statusEl=document.getElementById("leaveFormStatus");
var btn=document.getElementById("submitLeaveBtn");
if(!startDate||!endDate){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Please select both start and end dates</span>';return}
if(new Date(endDate)<new Date(startDate)){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">End date must be on or after start date</span>';return}
if(btn){btn.disabled=true;btn.textContent="Submitting..."}
var ct=(c.contactType||"").toLowerCase();
var isContractor=ct.indexOf("independent")>=0||ct.indexOf("contractor")>=0;
var isCasual=ct.indexOf("casual")>=0||(c.typeOfEmployment||"").toLowerCase().indexOf("casual")>=0;
var empType=isContractor?"Independent Contractor":isCasual?"Casual":(c.typeOfEmployment||"Part Time");
var needsApproval=(leaveType==="Annual Leave"||leaveType==="Personal/Sick");
var requiresApproval=needsApproval?"Super Admin / Manager":"";
apiCall("POST","/api/staff-availability",{
startDate:startDate,
endDate:endDate,
leaveType:leaveType,
status:"Pending",
employmentType:empType,
reason:reason,
requiresApproval:requiresApproval,
contactRecordId:c.airtableId||""
}).then(function(data){
if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';if(btn){btn.disabled=false;btn.textContent="Submit Request"}return}
if(statusEl)statusEl.innerHTML='<span style="color:#10B981;font-weight:700">‚úÖ Leave request submitted!</span>';
setTimeout(function(){
var overlay=document.getElementById("leaveFormOverlay");
if(overlay)overlay.remove();
loadLeaveRecords(c);
},1200);
}).catch(function(e){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';
if(btn){btn.disabled=false;btn.textContent="Submit Request"}
});
}

function approveLeave(recordId){
var statusEl=document.getElementById("leaveAction"+recordId);
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Approving...</span>';
var today=new Date().toISOString().split("T")[0];
apiCall("PATCH","/api/staff-availability/"+recordId,{
status:"Approved",
approvedDate:today,
approvedBy:(currentUser&&currentUser.name)||"Admin"
}).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#10B981;font-weight:700">‚úÖ Approved</span>';
setTimeout(function(){if(selectedConv)loadLeaveRecords(selectedConv)},1000);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}

function declineLeave(recordId){
var reason=prompt("Reason for declining (optional):");
var statusEl=document.getElementById("leaveAction"+recordId);
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Declining...</span>';
var today=new Date().toISOString().split("T")[0];
var body={status:"Declined",approvedDate:today,approvedBy:(currentUser&&currentUser.name)||"Admin"};
if(reason)body.statusComments=reason;
apiCall("PATCH","/api/staff-availability/"+recordId,body).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red);font-weight:700">‚ùå Declined</span>';
setTimeout(function(){if(selectedConv)loadLeaveRecords(selectedConv)},1000);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}

// ‚ïê‚ïê‚ïê SEND DOCUMENT PAGES (Sidebar) ‚ïê‚ïê‚ïê
var _sendDocPageData={templates:[],signingRequests:[],loaded:false};

function renderSendDocPage(docCategory){
var rp=document.getElementById("rightPanel");
var config={
client:{title:"Send Client Agreement",icon:"üìÑ",subtitle:"Send Service Agreements, Schedules of Support and other documents to clients for digital signature",types:["Service Agreement","Schedule of Support","Consent Form","Client Policy Acknowledgement"],contactTypes:["Client","Clients","NDIS Client (Active)","NDIS Client (Prospect)"],color:"#059669"},
employment:{title:"Send Employment Contract",icon:"üìù",subtitle:"Send employment contracts to Part-Time and Full-Time staff for digital signature",types:["Employment Contract (PT/FT)","Casual Employment Agreement","Policy / Code of Conduct Acknowledgement"],contactTypes:["TFN Employee","Support Worker","TFN Casual Employee","TFN Part-Time Employee","TFN Full-Time Employee"],color:"#3B82F6"},
contractor:{title:"Send Contractor Agreement",icon:"üìã",subtitle:"Send independent contractor service agreements for digital signature",types:["Independent Contractor Agreement","Policy / Code of Conduct Acknowledgement"],contactTypes:["Independent Contractor","Independant Contractor","Contractor"],color:"#8B5CF6"}
}[docCategory]||{title:"Send Document",icon:"üìÑ",subtitle:"",types:[],contactTypes:[],color:"var(--teal)"};

// Load templates and recent requests
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading...</div></div></div>';

Promise.all([
apiCall("GET","/api/doc-templates?all=1"),
apiCall("GET","/api/doc-signing/all?status=")
]).then(function(res){
var allTemplates=res[0]||[];
var allRequests=res[1]||[];

// Filter templates to this category
var templates=allTemplates.filter(function(t){
return config.types.indexOf(t.type)>=0&&(t.status||"").toLowerCase()==="active";
});

// Filter requests to matching doc types
var requests=allRequests.filter(function(r){
return config.types.indexOf(r.documentType)>=0;
});
requests.sort(function(a,b){return(b.sentDate||b.created||"").localeCompare(a.sentDate||a.created||"")});

// Filter contacts to matching types
var matchingContacts=contacts.filter(function(c){
var ct=(c.contactType||"").toLowerCase();
return config.contactTypes.some(function(t){return ct.indexOf(t.toLowerCase())>=0});
});

renderSendDocPageContent(rp,config,templates,requests,matchingContacts,docCategory);
}).catch(function(e){
rp.innerHTML='<div style="padding:24px"><div style="color:var(--red);text-align:center">Failed to load: '+e.message+'</div></div>';
});
}

function renderSendDocPageContent(rp,config,templates,requests,matchingContacts,docCategory){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';

// Header
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">';
h+='<div><div style="font-size:20px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:10px"><span style="font-size:24px">'+config.icon+'</span> '+config.title+'</div>';
h+='<div style="font-size:12px;color:var(--muted);margin-top:4px">'+config.subtitle+'</div></div>';
h+='</div>';

// Stats
var signed=requests.filter(function(r){return(r.status||"").toLowerCase()==="signed"}).length;
var awaiting=requests.filter(function(r){return(r.status||"").toLowerCase()==="sent"}).length;
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px">';
h+='<div style="padding:14px;background:rgba(5,150,105,.04);border:1px solid rgba(5,150,105,.12);border-radius:var(--r);text-align:center"><div style="font-size:22px;font-weight:800;color:#059669">'+signed+'</div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">Signed</div></div>';
h+='<div style="padding:14px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12);border-radius:var(--r);text-align:center"><div style="font-size:22px;font-weight:800;color:#D97706">'+awaiting+'</div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">Awaiting</div></div>';
h+='<div style="padding:14px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:var(--r);text-align:center"><div style="font-size:22px;font-weight:800;color:#3B82F6">'+requests.length+'</div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">Total Sent</div></div>';
h+='<div style="padding:14px;background:'+config.color+'08;border:1px solid '+config.color+'15;border-radius:var(--r);text-align:center"><div style="font-size:22px;font-weight:800;color:'+config.color+'">'+matchingContacts.length+'</div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">'+(docCategory==="client"?"Clients":"Staff")+'</div></div>';
h+='</div>';

// ‚îÄ‚îÄ Send New Document Section ‚îÄ‚îÄ
h+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:20px">';
h+='<div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:14px;display:flex;align-items:center;gap:8px"><span>üì§</span> Send Document for Signing</div>';

// Template selection
h+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Document Template *</label>';
if(templates.length>0){
h+='<select id="sdpTemplate" onchange="var t=this.value;var b=document.getElementById(\'sdpSignerBadges\');if(b)b.innerHTML=t?getSignerBadges(t):\'\';" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)">';
h+='<option value="">‚Äî Select template ‚Äî</option>';
templates.forEach(function(t){
var hasFile=t.files&&t.files.length>0;
h+='<option value="'+t.id+'" data-type="'+t.type+'">'+(hasFile?"üìÑ":"‚ö†Ô∏è")+' '+t.name+' ('+t.type+')</option>';
});
h+='</select>';
h+='<div id="sdpSignerBadges" style="margin-top:4px"></div>';
}else{
h+='<div style="padding:12px;background:rgba(245,158,11,.06);border:2px dashed rgba(245,158,11,.2);border-radius:var(--rs);font-size:11px;color:#D97706;text-align:center"><strong>No active templates</strong> ‚Äî go to User Management ‚Üí Document Templates to create one</div>';
}
h+='</div>';

// Recipient search
h+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Recipient * <span style="font-weight:400;text-transform:none;letter-spacing:0">('+matchingContacts.length+' '+(docCategory==="client"?"clients":"staff")+' available)</span></label>';
h+='<div style="position:relative">';
h+='<input id="sdpRecipientSearch" placeholder="Search by name or email..." oninput="searchSendDocRecipients(\''+docCategory+'\')" onfocus="searchSendDocRecipients(\''+docCategory+'\')" autocomplete="off" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box">';
h+='<div id="sdpRecipientResults" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 4px 16px rgba(0,0,0,.1);z-index:100;max-height:240px;overflow-y:auto;margin-top:2px"></div>';
h+='</div>';
h+='<div id="sdpSelectedRecipient" style="margin-top:6px"></div>';
h+='</div>';

// Send via
h+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">Send Via</label>';
h+='<div style="display:flex;gap:8px">';
["Email","SMS","Copy Link"].forEach(function(via){
var icon=via==="Email"?"üìß":via==="SMS"?"üì±":"üîó";
h+='<button onclick="selectSendDocVia(\''+via+'\')" id="sdpVia_'+via.replace(" ","")+'" style="flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--rs);cursor:pointer;text-align:center;background:transparent;font-family:inherit;transition:all .12s"><div style="font-size:18px;margin-bottom:2px">'+icon+'</div><div style="font-size:10px;font-weight:700;color:var(--text)">'+via+'</div></button>';
});
h+='</div></div>';

// Distribution list ‚Äî "Send Copies To"
h+='<div style="margin-bottom:14px;padding:14px;background:rgba(99,102,241,.04);border:1px solid rgba(99,102,241,.15);border-radius:var(--rs)">';
h+='<div style="font-size:10px;font-weight:700;color:#4F46E5;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px;display:flex;align-items:center;gap:6px">üìÆ Send Copies To <span style="font-size:9px;font-weight:400;color:var(--muted);text-transform:none;letter-spacing:0">(once fully executed ‚Äî up to 10 recipients)</span></div>';
h+='<div style="font-size:10px;color:var(--muted);margin-bottom:10px">Type any email address and press Enter or click Add. You can also search contacts by name.</div>';
h+='<div style="position:relative;margin-bottom:8px">';
h+='<div style="display:flex;gap:6px">';
h+='<input id="sdpDistSearch" placeholder="name@example.com or search a contact..." oninput="sdpSearchDistRecipients()" onfocus="sdpSearchDistRecipients()" onkeydown="if(event.key===\'Enter\'){event.preventDefault();sdpAddDistFromInput()}" autocomplete="off" style="flex:1;padding:8px 12px;border:1px solid rgba(99,102,241,.3);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)">';
h+='<button onclick="sdpAddDistFromInput()" style="padding:8px 14px;background:#4F46E5;color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;white-space:nowrap;flex-shrink:0">+ Add</button>';
h+='</div>';
h+='<div id="sdpDistResults" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:200;max-height:220px;overflow-y:auto;margin-top:2px"></div>';
h+='</div>';
h+='<div id="sdpDistList"><div style="font-size:10px;color:var(--muted);font-style:italic">No recipients added yet</div></div>';
h+='</div>';

// Send button
h+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">';
h+='<button onclick="sendDocWithSignerWorkflow(\''+docCategory+'\')" id="sdpSendBtn" style="padding:12px 28px;background:linear-gradient(135deg,'+config.color+','+config.color+'dd);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:8px"><span>üì§</span> Send for Signing</button>';
if(docCategory==="client"){
h+='<button onclick="openAgreementCreator()" style="padding:12px 20px;background:linear-gradient(135deg,#1E4BA0,#2563EB);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;gap:8px"><span>‚úçÔ∏è</span> Create Agreement</button>';
}
h+='<span id="sdpStatus" style="font-size:11px"></span>';
h+='</div>';
h+='</div>';

// ‚îÄ‚îÄ Recent Signing Requests ‚îÄ‚îÄ
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìã</span> Recent Requests <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;background:var(--surface2);color:var(--muted)">'+requests.length+'</span></div>';

if(requests.length===0){
h+='<div style="padding:24px;text-align:center;color:var(--muted);background:var(--surface2);border:1px dashed var(--border);border-radius:var(--r)"><div style="font-size:28px;margin-bottom:6px">üì§</div><div style="font-size:12px;font-weight:600">No documents sent yet</div></div>';
}else{
// Table view
h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden">';
h+='<table style="width:100%;border-collapse:collapse;font-size:11px">';
h+='<thead><tr style="background:var(--surface2);border-bottom:1px solid var(--border)">';
h+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Recipient</th>';
h+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Document</th>';
h+='<th style="padding:10px 12px;text-align:center;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Sent</th>';
h+='<th style="padding:10px 12px;text-align:center;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Status</th>';
h+='<th style="padding:10px 12px;text-align:center;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Signed</th>';
h+='<th style="padding:10px 12px;text-align:center;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Actions</th>';
h+='</tr></thead><tbody>';

requests.slice(0,25).forEach(function(r){
var sl=(r.status||"").toLowerCase();
var sc=sl==="signed"?"#059669":sl==="sent"?"#D97706":"var(--muted)";
function fmtD(v){if(!v)return"‚Äî";try{var d=new Date(v);if(isNaN(d))return v;return("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+String(d.getFullYear()).slice(-2)}catch(e){return v}}

h+='<tr style="border-bottom:1px solid var(--border)">';
h+='<td style="padding:10px 12px"><div style="font-weight:700;color:var(--text)">'+(r.recipientName||"‚Äî")+'</div><div style="font-size:9px;color:var(--muted)">'+(r.recipientEmail||"")+'</div></td>';
h+='<td style="padding:10px 12px"><span style="font-size:10px;font-weight:600">'+(r.documentType||r.templateName||"‚Äî")+'</span></td>';
h+='<td style="padding:10px 12px;text-align:center;font-size:10px">'+fmtD(r.sentDate)+'<div style="font-size:9px;color:var(--muted)">'+(r.sentVia==="SMS"?"üì±":"üìß")+' '+( r.sentVia||"")+'</div></td>';
h+='<td style="padding:10px 12px;text-align:center"><span style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;background:'+sc+'10;color:'+sc+';border:1px solid '+sc+'20">'+(r.status||"‚Äî")+'</span></td>';
h+='<td style="padding:10px 12px;text-align:center;font-size:10px;color:'+(sl==="signed"?"#059669":"var(--muted)")+'">'+fmtD(r.signedDate)+'</td>';
h+='<td style="padding:10px 12px;text-align:center">';
if(sl==="sent"&&r.signingToken){
h+='<button onclick="copySigningLink(\''+r.signingToken+'\')" style="padding:3px 8px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;font-size:9px;font-weight:600;font-family:inherit;cursor:pointer" title="Copy signing link">üìã</button> ';
h+='<button onclick="resendFromTable(\''+r.id+'\',\''+r.signingToken+'\',\''+(r.recipientPhone||"").replace(/'/g,"")+'\')" style="padding:3px 8px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;font-size:9px;font-weight:600;font-family:inherit;cursor:pointer" title="Resend">üîÑ</button>';
}else if(sl==="signed"&&r.signedDoc&&r.signedDoc.length>0){
h+='<a href="'+r.signedDoc[0].url+'" target="_blank" style="padding:3px 8px;background:rgba(5,150,105,.06);color:#059669;border:1px solid rgba(5,150,105,.15);border-radius:4px;font-size:9px;font-weight:700;text-decoration:none">üìé View</a>';
}else{
h+='<span style="color:var(--muted);font-size:9px">‚Äî</span>';
}
h+='</td></tr>';
});
h+='</tbody></table>';
if(requests.length>25)h+='<div style="padding:8px;text-align:center;font-size:10px;color:var(--muted);border-top:1px solid var(--border)">Showing 25 of '+requests.length+' requests</div>';
h+='</div>';
}
h+='</div>';

h+='</div>';
rp.innerHTML=h;
// Default send via
selectSendDocVia("Email");
}

var _sdpSelectedContact=null;
var _sdpSendVia="Email";
var _sdpDistRecipients=[]; // up to 10 email addresses for signed copy distribution

function selectSendDocVia(via){
_sdpSendVia=via;
["Email","SMS","CopyLink"].forEach(function(v){
var el=document.getElementById("sdpVia_"+v);
if(el){
var isActive=(v==="CopyLink"?"Copy Link":v)===via;
el.style.borderColor=isActive?"var(--royal)":"var(--border)";
el.style.background=isActive?"rgba(59,130,246,.04)":"transparent";
}
});
}

function searchSendDocRecipients(docCategory){
var input=document.getElementById("sdpRecipientSearch");
var results=document.getElementById("sdpRecipientResults");
if(!input||!results)return;
var q=(input.value||"").toLowerCase().trim();

var config={
client:{contactTypes:["client","clients","ndis client"]},
employment:{contactTypes:["tfn employee","support worker","tfn casual","tfn part-time","tfn full-time"]},
contractor:{contactTypes:["independent contractor","independant contractor","contractor"]}
}[docCategory]||{contactTypes:[]};

var matches=contacts.filter(function(c){
var ct=(c.contactType||"").toLowerCase();
var typeMatch=config.contactTypes.some(function(t){return ct.indexOf(t)>=0});
if(!typeMatch)return false;
if(!q)return true;
return(c.name||"").toLowerCase().indexOf(q)>=0||(c.email||"").toLowerCase().indexOf(q)>=0||(c.phone||"").indexOf(q)>=0;
}).slice(0,12);

if(matches.length===0&&q.length>0){results.innerHTML='<div style="padding:12px;text-align:center;color:var(--muted);font-size:11px">No matching contacts found</div>';results.style.display="block";return}
if(matches.length===0){results.style.display="none";return}

var html="";
matches.forEach(function(c){
html+='<div onclick="selectSendDocRecipient(\''+c.id+'\',\''+((c.name||"").replace(/'/g,"\\'"))+'\',\''+((c.email||"").replace(/'/g,"\\'"))+'\',\''+((c.phone||"").replace(/'/g,"\\'"))+'\')" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;transition:background .1s" onmouseover="this.style.background=\'var(--surface2)\'" onmouseout="this.style.background=\'transparent\'">';
html+='<div style="width:30px;height:30px;border-radius:50%;background:var(--royal);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px">'+((c.name||"?").charAt(0).toUpperCase())+'</div>';
html+='<div style="flex:1"><div style="font-size:12px;font-weight:700;color:var(--text)">'+(c.name||"Unknown")+'</div>';
html+='<div style="font-size:10px;color:var(--muted)">'+(c.email||"")+(c.phone?" ¬∑ "+c.phone:"")+'</div>';
if(c.signingEmail&&c.signingEmail!==c.email)html+='<div style="font-size:9px;color:var(--royal);font-weight:600">‚úçÔ∏è Signs via: '+c.signingEmail+'</div>';
html+='</div>';
html+='<span style="font-size:9px;padding:2px 6px;border-radius:3px;background:var(--surface2);color:var(--muted)">'+(c.contactType||"")+'</span></div>';
});
results.innerHTML=html;
results.style.display="block";
}

function selectSendDocRecipient(id,name,email,phone){
_sdpSelectedContact={id:id,name:name,email:email,phone:phone};
var input=document.getElementById("sdpRecipientSearch");
var results=document.getElementById("sdpRecipientResults");
var selectedEl=document.getElementById("sdpSelectedRecipient");
if(input)input.value=name;
if(results)results.style.display="none";
// Look up the full contact to get signingEmail
var fullContact=contacts.find(function(c){return c.id===id})||{};
var sigEmail=fullContact.signingEmail||"";
var sendToEmail=sigEmail||email;
if(selectedEl){
var sigBadge=sigEmail?'<div style="margin-top:3px;display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:rgba(30,75,160,.08);border:1px solid rgba(30,75,160,.15);border-radius:20px;font-size:9px"><span>‚úçÔ∏è</span><span style="color:var(--royal);font-weight:700">Signs via: '+sigEmail+'</span></div>':'';
selectedEl.innerHTML=
'<div style="padding:10px 14px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.2);border-radius:var(--rs)">'
+'<div style="display:flex;align-items:flex-start;gap:10px">'
+'<div style="width:32px;height:32px;border-radius:50%;background:var(--royal);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">'+name.charAt(0).toUpperCase()+'</div>'
+'<div style="flex:1;min-width:0">'
+'<div style="font-size:13px;font-weight:700;color:var(--text)">'+name+'</div>'
+'<div style="font-size:10px;color:var(--muted)">'+email+(phone?" ¬∑ "+phone:"")+'</div>'
+(sigBadge?sigBadge:'')
+'</div>'
+'<button onclick="_sdpSelectedContact=null;document.getElementById(\'sdpSelectedRecipient\').innerHTML=\'\';document.getElementById(\'sdpRecipientSearch\').value=\'\'" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);flex-shrink:0;line-height:1">‚úï</button>'
+'</div>'
+'<div style="margin-top:10px;padding:8px 10px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.12);border-radius:6px;font-size:10px;color:#475569;display:flex;align-items:center;gap:8px">'
+'<span style="font-size:14px">üìã</span>'
+'<span><strong>Signing order:</strong> 1Ô∏è‚É£ <strong>'+sendToEmail+'</strong> signs first &nbsp;‚Üí&nbsp; ‚úÖ <strong>DCS counter-signs last</strong></span>'
+'</div>'
+'</div>';
}
}

function sendFromDocPage(docCategory){
var templateSel=document.getElementById("sdpTemplate");
var statusEl=document.getElementById("sdpStatus");
var btn=document.getElementById("sdpSendBtn");
if(!templateSel||!templateSel.value){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Select a template</span>';return}
if(!_sdpSelectedContact){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Select a recipient</span>';return}

var c=_sdpSelectedContact;
var sendVia=_sdpSendVia==="Copy Link"?"Link":_sdpSendVia;
if(sendVia==="Email"&&!c.email){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">No email on file</span>';return}
if(sendVia==="SMS"&&!c.phone){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">No phone on file</span>';return}

var opt=templateSel.options[templateSel.selectedIndex];
var docType=opt?opt.getAttribute("data-type"):"";
if(btn){btn.disabled=true;btn.textContent="Sending..."}
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Creating signing request...</span>';

apiCall("POST","/api/doc-signing/send",{
recipientName:c.name,recipientEmail:c.email,recipientPhone:c.phone,
templateId:templateSel.value,documentType:docType,
sendVia:sendVia,contactRecordId:c.id
}).then(function(data){
if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';if(btn){btn.disabled=false;btn.textContent="üì§ Send for Signing"}return}

if(_sdpSendVia==="Copy Link"&&data.signingUrl){
navigator.clipboard.writeText(data.signingUrl).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Link copied!</span><div style="margin-top:4px;padding:6px 8px;background:var(--surface2);border-radius:4px;font-family:JetBrains Mono,monospace;font-size:9px;word-break:break-all;user-select:all">'+data.signingUrl+'</div>';
}).catch(function(){if(statusEl)statusEl.innerHTML='<span style="color:#059669">‚úÖ Created</span><div style="margin-top:4px;padding:6px 8px;background:var(--surface2);border-radius:4px;font-family:JetBrains Mono,monospace;font-size:9px;word-break:break-all;user-select:all">'+data.signingUrl+'</div>'});
}else{
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Sent via '+sendVia+'!</span>';
setTimeout(function(){renderSendDocPage(docCategory)},1500);
}
if(btn){btn.textContent="‚úÖ Sent";btn.style.background="#059669"}
}).catch(function(e){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';
if(btn){btn.disabled=false;btn.textContent="üì§ Send for Signing"}
});
}

function resendFromTable(recordId,token,phone){
if(!phone){alert("No phone number on file for this recipient");return}
var url=window.location.origin+"/sign/"+token;
apiCall("POST","/api/sms/send",{
to:phone,body:"Reminder: Delta Community Support has sent you a document to sign. Please click here: "+url
}).then(function(){alert("‚úÖ Reminder SMS sent!")}).catch(function(e){alert("Error: "+e.message)});
}

// Close recipient dropdown on outside click
document.addEventListener("click",function(e){
var results=document.getElementById("sdpRecipientResults");
var input=document.getElementById("sdpRecipientSearch");
if(results&&input&&!results.contains(e.target)&&e.target!==input)results.style.display="none";
});

// ‚ïê‚ïê‚ïê DOCUMENTS & SIGNING ‚ïê‚ïê‚ïê
function loadDocSigningList(c){
var el=document.getElementById("docSigningList");if(!el)return;
if(!c.email){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:11px">No email ‚Äî cannot load signing requests</div>';return}
apiCall("GET","/api/doc-signing?email="+encodeURIComponent(c.email)).then(function(records){
if(!records||records.length===0){
el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:28px;margin-bottom:6px">‚úçÔ∏è</div><div style="font-size:12px;font-weight:600">No documents sent for signing yet</div><div style="font-size:10px;margin-top:4px">Click "Send for Signing" to send an employment contract or policy document</div></div>';
return;
}
// Summary stats
var signed=records.filter(function(r){return(r.status||"").toLowerCase()==="signed"}).length;
var awaiting=records.filter(function(r){return(r.status||"").toLowerCase()==="sent"}).length;
var h='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
h+='<div style="padding:6px 12px;background:rgba(5,150,105,.06);border:1px solid rgba(5,150,105,.15);border-radius:var(--rs);font-size:10px"><span style="font-weight:700;color:#059669">'+signed+'</span> <span style="color:var(--muted)">Signed</span></div>';
if(awaiting>0)h+='<div style="padding:6px 12px;background:rgba(217,119,6,.06);border:1px solid rgba(217,119,6,.15);border-radius:var(--rs);font-size:10px"><span style="font-weight:700;color:#D97706">'+awaiting+'</span> <span style="color:var(--muted)">Awaiting Signature</span></div>';
h+='<div style="padding:6px 12px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs);font-size:10px"><span style="font-weight:700;color:var(--royal)">'+records.length+'</span> <span style="color:var(--muted)">total</span></div>';
h+='</div>';

records.forEach(function(r){
var statusLower=(r.status||"").toLowerCase();
var statusCol=statusLower==="signed"?"#059669":statusLower==="sent"?"#D97706":statusLower==="viewed"?"#3B82F6":"var(--muted)";
var statusBg=statusLower==="signed"?"rgba(5,150,105,.04)":statusLower==="sent"?"rgba(217,119,6,.04)":"var(--surface2)";
function fmtDT(v){if(!v)return"‚Äî";try{var d=new Date(v);if(isNaN(d))return v;var dd=("0"+d.getDate()).slice(-2);var mm=("0"+(d.getMonth()+1)).slice(-2);var yy=String(d.getFullYear()).slice(-2);var hr=d.getHours();var mi=("0"+d.getMinutes()).slice(-2);var ap=hr>=12?"pm":"am";hr=hr%12||12;return dd+"/"+mm+"/"+yy+" "+hr+":"+mi+ap}catch(e){return v}}
function fmtD(v){if(!v)return"‚Äî";try{var d=new Date(v);if(isNaN(d))return v;return("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+String(d.getFullYear()).slice(-2)}catch(e){return v}}

// Calculate days waiting
var daysWaiting="";
if(statusLower==="sent"&&r.sentDate){
var sent=new Date(r.sentDate);var now=new Date();var diff=Math.floor((now-sent)/(1000*60*60*24));
if(diff>7)daysWaiting='<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.08);color:var(--red)">‚è∞ '+diff+' days waiting</span>';
else if(diff>2)daysWaiting='<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(245,158,11,.08);color:#D97706">'+diff+' days ago</span>';
}

h+='<div style="padding:14px;background:'+statusBg+';border:1px solid '+statusCol+'20;border-left:3px solid '+statusCol+';border-radius:var(--r);margin-bottom:8px">';

// Row 1: Doc name + status
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">';
h+='<div style="display:flex;align-items:center;gap:10px">';
h+='<span style="font-size:20px">üìÑ</span>';
h+='<div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(r.documentType||r.templateName||"Document")+'</div>';
if(r.templateName&&r.documentType)h+='<div style="font-size:10px;color:var(--muted)">'+r.templateName+'</div>';
h+='</div></div>';
h+='<div style="display:flex;gap:4px;align-items:center">';
if(daysWaiting)h+=daysWaiting;
h+='<span style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;background:'+statusCol+'12;color:'+statusCol+';border:1px solid '+statusCol+'25">'+(r.status||"‚Äî")+'</span>';
if(r.sentVia)h+='<span style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:3px;background:var(--surface2);color:var(--muted)">'+(r.sentVia==="SMS"?"üì±":"üìß")+' '+r.sentVia+'</span>';
h+='</div></div>';

// Row 2: Timeline tracker
h+='<div style="margin-top:10px;display:flex;align-items:stretch;gap:0">';

// Sent step
h+='<div style="flex:1;position:relative;text-align:center">';
h+='<div style="width:24px;height:24px;border-radius:50%;background:#3B82F6;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">üì§</div>';
h+='<div style="font-size:9px;font-weight:700;color:#3B82F6;margin-top:3px">SENT</div>';
h+='<div style="font-size:10px;font-weight:600;color:var(--text);margin-top:1px">'+fmtD(r.sentDate)+'</div>';
h+='</div>';

// Connector
h+='<div style="flex:0 0 40px;display:flex;align-items:center;justify-content:center;padding-bottom:22px"><div style="width:100%;height:2px;background:'+(statusLower==="signed"?"#059669":"var(--border)")+'"></div></div>';

// Signed step
var signedActive=statusLower==="signed";
h+='<div style="flex:1;position:relative;text-align:center">';
h+='<div style="width:24px;height:24px;border-radius:50%;background:'+(signedActive?"#059669":"var(--border)")+';color:'+(signedActive?"#fff":"var(--muted)")+';display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">'+(signedActive?"‚úÖ":"‚úçÔ∏è")+'</div>';
h+='<div style="font-size:9px;font-weight:700;color:'+(signedActive?"#059669":"var(--muted)")+';margin-top:3px">'+(signedActive?"SIGNED":"AWAITING")+'</div>';
h+='<div style="font-size:10px;font-weight:600;color:var(--text);margin-top:1px">'+(signedActive?fmtD(r.signedDate):"‚Äî")+'</div>';
h+='</div>';

h+='</div>';

// Actions
if(statusLower==="sent"){
h+='<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);display:flex;gap:6px;align-items:center">';
h+='<button onclick="copySigningLink(\''+r.signingToken+'\')" style="padding:5px 14px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--rs);font-size:10px;font-weight:600;font-family:inherit;cursor:pointer">üìã Copy Link</button>';
h+='<button onclick="resendSigningDoc(\''+r.id+'\',\''+r.signingToken+'\')" style="padding:5px 14px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--rs);font-size:10px;font-weight:600;font-family:inherit;cursor:pointer">üîÑ Resend</button>';
h+='<span id="docAction'+r.id+'" style="font-size:10px;color:var(--muted)"></span>';
h+='</div>';
}

// Signed doc + template links
if(statusLower==="signed"&&r.signedDoc&&r.signedDoc.length>0){
h+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)"><a href="'+r.signedDoc[0].url+'" target="_blank" style="font-size:11px;font-weight:700;color:var(--teal);text-decoration:none;display:flex;align-items:center;gap:6px">üìé Download Signed Document</a></div>';
}
if(r.templateFile&&r.templateFile.length>0){
h+='<div style="margin-top:4px"><a href="'+r.templateFile[0].url+'" target="_blank" style="font-size:10px;font-weight:600;color:var(--muted);text-decoration:none">üìé Original: '+r.templateFile[0].name+'</a></div>';
}

h+='</div>';
});
el.innerHTML=h;
}).catch(function(e){el.innerHTML='<div style="color:var(--red);font-size:11px;text-align:center;padding:12px">Failed to load: '+e.message+'</div>'});
}

function openSendDocModal(){
var c=selectedConv;if(!c)return;

// Load templates first
apiCall("GET","/api/doc-templates").then(function(templates){
var overlay=document.createElement("div");
overlay.id="sendDocOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:10001;display:flex;align-items:center;justify-content:center";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

var html='<div style="background:var(--surface);border-radius:12px;width:480px;max-width:92vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
html+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between"><div style="font-size:16px;font-weight:800;color:var(--text)">üì§ Send Document for Signing</div><button onclick="document.getElementById(\'sendDocOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:0;line-height:1">‚úï</button></div>';

html+='<div style="padding:20px">';

// Recipient info
html+='<div style="padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:16px;display:flex;align-items:center;gap:10px">';
html+='<div style="width:32px;height:32px;border-radius:50%;background:var(--royal);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px">'+(c.firstName||c.name||"?").charAt(0).toUpperCase()+'</div>';
html+='<div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(c.name||"")+'</div>';
html+='<div style="font-size:10px;color:var(--muted)">'+(c.email||"No email")+(c.phone?" ¬∑ "+c.phone:"")+'</div></div></div>';

// Template selection
html+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Document Template *</label>';
html+='<select id="docTemplateSelect" onchange="onTemplateChange()" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)">';
html+='<option value="">‚Äî Select a template ‚Äî</option>';
if(templates&&templates.length>0){
templates.forEach(function(t){
html+='<option value="'+t.id+'" data-type="'+(t.type||"")+'" data-desc="'+(t.description||"")+'">'+t.name+(t.type?" ("+t.type+")":"")+'</option>';
});
}else{
html+='<option value="" disabled>No templates found ‚Äî upload templates to Airtable first</option>';
}
html+='</select></div>';

// Template description
html+='<div id="templateDesc" style="display:none;padding:8px 12px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:var(--rs);margin-bottom:14px;font-size:11px;color:var(--text)"></div>';

// Send via
html+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Send Via *</label>';
html+='<div style="display:flex;gap:8px">';
html+='<label style="flex:1;padding:12px;border:2px solid var(--border);border-radius:var(--rs);cursor:pointer;text-align:center;transition:all .12s" id="sendViaEmailLabel" onclick="selectSendVia(\'Email\')"><input type="radio" name="sendVia" value="Email" checked style="display:none"><div style="font-size:20px;margin-bottom:4px">üìß</div><div style="font-size:11px;font-weight:700">Email</div><div style="font-size:9px;color:var(--muted)">'+(c.email||"No email")+'</div></label>';
html+='<label style="flex:1;padding:12px;border:2px solid var(--border);border-radius:var(--rs);cursor:pointer;text-align:center;transition:all .12s" id="sendViaSMSLabel" onclick="selectSendVia(\'SMS\')"><input type="radio" name="sendVia" value="SMS" style="display:none"><div style="font-size:20px;margin-bottom:4px">üì±</div><div style="font-size:11px;font-weight:700">SMS</div><div style="font-size:9px;color:var(--muted)">'+(c.phone||"No phone")+'</div></label>';
html+='<label style="flex:1;padding:12px;border:2px solid var(--border);border-radius:var(--rs);cursor:pointer;text-align:center;transition:all .12s" id="sendViaCopyLabel" onclick="selectSendVia(\'Copy Link\')"><input type="radio" name="sendVia" value="Copy Link" style="display:none"><div style="font-size:20px;margin-bottom:4px">üîó</div><div style="font-size:11px;font-weight:700">Copy Link</div><div style="font-size:9px;color:var(--muted)">Manual share</div></label>';
html+='</div></div>';

// Submit
html+='<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">';
html+='<button onclick="document.getElementById(\'sendDocOverlay\').remove()" style="padding:10px 20px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer">Cancel</button>';
html+='<button id="sendDocBtn" onclick="sendDocForSigning()" style="padding:10px 20px;background:linear-gradient(135deg,#3B82F6,#2563EB);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer">üì§ Send for Signing</button>';
html+='</div>';
html+='<div id="sendDocStatus" style="margin-top:8px;font-size:11px;text-align:center"></div>';

html+='</div></div>';
overlay.innerHTML=html;
document.body.appendChild(overlay);
selectSendVia("Email");
}).catch(function(e){alert("Failed to load templates: "+e.message)});
}

var _selectedSendVia="Email";
function selectSendVia(via){
_selectedSendVia=via;
["Email","SMS","Copy Link"].forEach(function(v){
var label=document.getElementById("sendVia"+v.replace(" ","")+"Label");
if(label){
label.style.borderColor=v===via?"var(--royal)":"var(--border)";
label.style.background=v===via?"rgba(59,130,246,.04)":"transparent";
}
});
}

function onTemplateChange(){
var sel=document.getElementById("docTemplateSelect");
var descEl=document.getElementById("templateDesc");
if(!sel||!descEl)return;
var opt=sel.options[sel.selectedIndex];
var desc=opt?opt.getAttribute("data-desc"):"";
if(desc){descEl.style.display="block";descEl.textContent=desc}
else{descEl.style.display="none"}
}

function sendDocForSigning(){
var c=selectedConv;if(!c)return;
var templateSel=document.getElementById("docTemplateSelect");
var statusEl=document.getElementById("sendDocStatus");
var btn=document.getElementById("sendDocBtn");
if(!templateSel||!templateSel.value){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Please select a document template</span>';return}

var opt=templateSel.options[templateSel.selectedIndex];
var docType=opt?opt.getAttribute("data-type"):"";
var sendVia=_selectedSendVia==="Copy Link"?"Link":_selectedSendVia;

if(sendVia==="Email"&&!c.email){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">No email address on file</span>';return}
if(sendVia==="SMS"&&!c.phone){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">No phone number on file</span>';return}

if(btn){btn.disabled=true;btn.textContent="Sending..."}

apiCall("POST","/api/doc-signing/send",{
recipientName:c.name||"",
recipientEmail:c.email||"",
recipientPhone:c.phone||"",
templateId:templateSel.value,
documentType:docType,
sendVia:sendVia,
contactRecordId:c.airtableId||""
}).then(function(data){
if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';if(btn){btn.disabled=false;btn.textContent="üì§ Send for Signing"}return}

if(_selectedSendVia==="Copy Link"&&data.signingUrl){
// Copy to clipboard
navigator.clipboard.writeText(data.signingUrl).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Link copied to clipboard!</span><div style="margin-top:6px;padding:8px;background:var(--surface2);border-radius:4px;font-family:JetBrains Mono,monospace;font-size:10px;word-break:break-all">'+data.signingUrl+'</div>';
}).catch(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Created!</span><div style="margin-top:6px;padding:8px;background:var(--surface2);border-radius:4px;font-family:JetBrains Mono,monospace;font-size:10px;word-break:break-all;user-select:all">'+data.signingUrl+'</div>';
});
}else{
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Document sent via '+sendVia+'!</span>';
setTimeout(function(){
var overlay=document.getElementById("sendDocOverlay");
if(overlay)overlay.remove();
loadDocSigningList(c);
},1500);
}
if(btn){btn.textContent="‚úÖ Sent";btn.style.background="#059669"}
}).catch(function(e){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';
if(btn){btn.disabled=false;btn.textContent="üì§ Send for Signing"}
});
}

function copySigningLink(token){
var url=window.location.origin+"/sign/"+token;
navigator.clipboard.writeText(url).then(function(){
alert("Signing link copied to clipboard!");
}).catch(function(){
prompt("Copy this signing link:",url);
});
}

function resendSigningDoc(recordId,token){
var c=selectedConv;if(!c)return;
var statusEl=document.getElementById("docAction"+recordId);
if(!c.phone){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">No phone number</span>';return}
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Resending...</span>';
var url=window.location.origin+"/sign/"+token;
apiCall("POST","/api/sms/send",{
to:c.phone,
body:"Reminder: Delta Community Support has sent you a document to sign. Please click here: "+url,
participant:c.name||""
}).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Resent via SMS</span>';
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}

// ‚ïê‚ïê‚ïê NDIS CLIENT FUNCTIONS ‚ïê‚ïê‚ïê
function loadNDISClientDetails(clientName,contact){
var el=document.getElementById("ndisClientDetails");if(!el)return;
// Try matching by linked client name first, then contact name
var nameToSearch=clientName||contact.name||"";
apiCall("GET","/api/client-details?name="+encodeURIComponent(nameToSearch)).then(function(d){
if(d.error&&d.error!=="Client not found"){el.innerHTML='<div style="color:var(--red);padding:12px;text-align:center">'+d.error+'</div>';return}
if(d.error==="Client not found"){
// Try just the contact full name
if(nameToSearch!==contact.name){
apiCall("GET","/api/client-details?name="+encodeURIComponent(contact.name)).then(function(d2){
if(d2.error){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--muted)"><div style="font-size:24px;margin-bottom:8px">üë§</div><div style="font-size:13px;font-weight:600">No matching client record found</div><div style="font-size:11px;margin-top:4px">Searched: "'+nameToSearch+'" and "'+contact.name+'"</div></div>';return}
renderNDISClientCard(el,d2,contact)}).catch(function(){el.innerHTML='<div style="color:var(--red);padding:12px;text-align:center">Failed to load client details</div>'});return}
el.innerHTML='<div style="padding:16px;text-align:center;color:var(--muted)"><div style="font-size:24px;margin-bottom:8px">üë§</div><div style="font-size:13px;font-weight:600">No matching client record found</div><div style="font-size:11px;margin-top:4px">Searched: "'+nameToSearch+'"</div></div>';return}
renderNDISClientCard(el,d,contact)
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:12px;text-align:center">Error: '+e.message+'</div>'})}

function renderNDISClientCard(el,d,contact){
if(selectedConv)selectedConv._clientData=d;
var h='';
// Account status banner
var acctType=(d.accountType||"").toLowerCase();
var statusColor=acctType.indexOf("active")>=0?"var(--green)":acctType.indexOf("prospect")>=0?"var(--orange)":"var(--red)";
var statusBg=acctType.indexOf("active")>=0?"rgba(16,185,129,.06)":acctType.indexOf("prospect")>=0?"rgba(245,158,11,.06)":"rgba(239,68,68,.06)";
var statusBorder=acctType.indexOf("active")>=0?"rgba(16,185,129,.15)":acctType.indexOf("prospect")>=0?"rgba(245,158,11,.15)":"rgba(239,68,68,.15)";
h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">';
h+='<span style="padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;background:'+statusBg+';color:'+statusColor+';border:1px solid '+statusBorder+'">'+(d.accountType||"Unknown")+'</span>';
h+='<span style="padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;background:rgba(30,75,160,.06);color:var(--royal);border:1px solid rgba(30,75,160,.15)">'+(d.silOrCas||"‚Äî")+'</span>';
h+='<span style="font-size:11px;color:var(--muted);font-weight:600">'+(d.serviceType||"")+'</span>';
h+='</div>';
// Personal info grid
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>Client Name</label><input value="'+(d.name||"")+'" disabled style="opacity:.7;font-weight:700"></div>';
h+='<div class="fg" style="margin:0"><label>NDIS Number</label><input value="'+(d.ndisNumber||"‚Äî")+'" disabled style="opacity:.7;font-family:JetBrains Mono,monospace;font-weight:600;color:var(--royal)"></div>';
h+='<div class="fg" style="margin:0"><label>Age</label><input value="'+(d.age?d.age+" yrs":"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
var dobDisp=d.dateOfBirth||"";
if(dobDisp){try{var dp=new Date(dobDisp);if(!isNaN(dp))dobDisp=("0"+dp.getDate()).slice(-2)+"/"+("0"+(dp.getMonth()+1)).slice(-2)+"/"+dp.getFullYear()}catch(e){}}
h+='<div class="fg" style="margin:0"><label>Gender</label><input value="'+(d.gender||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='<div class="fg" style="margin:0"><label>Date of Birth</label><input value="'+(dobDisp||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='<div class="fg" style="margin:0"><label>Phone</label><input value="'+(d.phone||contact.phone||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>Email</label><input value="'+(d.email||contact.email||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='<div class="fg" style="margin:0"><label>Suburb</label><input value="'+(d.suburb||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='<div class="fg" style="margin:0"><label>KM Allowance</label><input value="'+(d.kmAllowance?d.kmAllowance+" km/wk":"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>Gender of Support Workers</label><input value="'+(d.genderOfWorkers||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='<div class="fg" style="margin:0"><label>Personal Care</label><input value="'+(d.personalCare||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='<div class="fg" style="margin:0"><label>Communication Aids</label><input value="'+(d.communicationAids||"‚Äî")+'" disabled style="opacity:.7"></div>';
h+='</div>';
// Address
h+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìç Address</div>';
var addrParts=[d.address,d.suburb,d.state,d.postcode].filter(function(v){return v});
h+='<div style="font-size:12px;color:var(--text);font-weight:600">'+(addrParts.length>0?addrParts.join(", "):"No address on file")+'</div></div>';
// Type of Disability
if(d.typeOfDisability){
h+='<div style="padding:10px;background:rgba(124,58,237,.04);border:1px solid rgba(124,58,237,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:#7C3AED;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üß© Type of Disability</div><div style="font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+d.typeOfDisability+'</div></div>'}
// General Background Info
if(d.generalBackground){
h+='<div style="padding:10px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--royal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìã General Background</div><div style="font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+d.generalBackground+'</div></div>'}
// NDIS Goals
if(d.ndisGoals){
h+='<div style="padding:10px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üéØ NDIS Client Goals</div><div style="font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+d.ndisGoals+'</div></div>'}
// Allergies & Alerts
if(d.hasAllergies==="Yes"||d.allergiesAlerts){
h+='<div style="padding:10px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">‚ö†Ô∏è Allergies & Alerts</div><div style="font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+(d.allergiesAlerts||"Yes ‚Äî see details in Support Plan")+'</div></div>'}
// Known Triggers
if(d.knownTriggers){
h+='<div style="padding:10px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--orange);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">‚ö° Known Triggers</div><div style="font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap">'+d.knownTriggers+'</div></div>'}
// PBSP
if(d.pbspYesNo==="Yes"){
h+='<div style="padding:10px;background:rgba(220,38,38,.04);border:1px solid rgba(220,38,38,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:#DC2626;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üß† Behaviour Support Plan (PBSP)</div>';
if(d.pbspPracName)h+='<div style="font-size:12px;margin-bottom:4px"><strong>Practitioner:</strong> '+d.pbspPracName+(d.pbspPracEmail?' ¬∑ <a href="mailto:'+d.pbspPracEmail+'" style="color:var(--teal)">'+d.pbspPracEmail+'</a>':'')+(d.pbspPhone?' ¬∑ '+d.pbspPhone:'')+'</div>';
if(d.pbspStrategies)h+='<div style="font-size:11px;color:var(--text);line-height:1.5;margin-top:6px;white-space:pre-wrap">'+d.pbspStrategies.substring(0,500)+(d.pbspStrategies.length>500?"...":"")+'</div>';
h+='</div>'}
// Required Staff Skills
if(d.requiredSkills&&d.requiredSkills.length>0){
h+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">‚ö° Required Staff Skills</div><div style="display:flex;flex-wrap:wrap;gap:4px">';
var skillColors=["#EF4444","#F59E0B","#7C3AED","#1E4BA0","#0A9396","#EC4899","#6366F1","#10B981"];
d.requiredSkills.forEach(function(s,i){var col=skillColors[i%skillColors.length];h+='<span style="padding:3px 10px;border-radius:8px;font-size:10px;font-weight:700;background:'+col+'12;color:'+col+';border:1px solid '+col+'25">'+s+'</span>'});
h+='</div></div>'}
// Emergency Contact
if(d.emergencyContact||d.emergencyPhone){
h+='<div style="padding:10px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üö® Emergency Contact</div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">';
h+='<span style="font-size:13px;font-weight:600;color:var(--text)">'+(d.emergencyContact||"Not set")+'</span>';
if(d.emergencyRelationship)h+='<span style="font-size:11px;color:var(--muted)">('+d.emergencyRelationship+')</span>';
if(d.emergencyPhone)h+='<a href="tel:'+d.emergencyPhone+'" style="font-size:12px;color:var(--teal);font-family:JetBrains Mono,monospace;font-weight:600;text-decoration:none">üìû '+d.emergencyPhone+'</a>';
if(d.emergencyEmail)h+='<a href="mailto:'+d.emergencyEmail+'" style="font-size:12px;color:var(--teal);font-weight:600;text-decoration:none">üìß '+d.emergencyEmail+'</a>';
h+='</div></div>'}
// Plan Expiry
if(d.planExpiry){
var expDate;try{expDate=new Date(d.planExpiry)}catch(e){}
var daysLeft=expDate?Math.ceil((expDate-new Date())/(1000*60*60*24)):999;
var expColor=daysLeft<0?"var(--red)":daysLeft<90?"var(--orange)":"var(--green)";
var expBg=daysLeft<0?"rgba(239,68,68,.06)":daysLeft<90?"rgba(245,158,11,.06)":"rgba(16,185,129,.06)";
var expBorder=daysLeft<0?"rgba(239,68,68,.15)":daysLeft<90?"rgba(245,158,11,.15)":"rgba(16,185,129,.15)";
var expDisp=d.planExpiry;try{var ed=new Date(d.planExpiry);if(!isNaN(ed))expDisp=ed.toLocaleDateString("en-AU",{day:"numeric",month:"long",year:"numeric"})}catch(e){}
var expStatus=daysLeft<0?"EXPIRED ‚Äî "+Math.abs(daysLeft)+" days ago":daysLeft<90?"‚ö†Ô∏è "+daysLeft+" days remaining":"‚úÖ "+daysLeft+" days remaining";
h+='<div style="padding:10px;background:'+expBg+';border:1px solid '+expBorder+';border-radius:var(--rs);margin-bottom:10px"><div style="font-size:10px;font-weight:600;color:'+expColor+';text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üìÖ NDIS Plan Expiry</div><div style="display:flex;align-items:center;gap:12px"><span style="font-size:14px;font-weight:700;color:'+expColor+'">'+expDisp+'</span><span style="font-size:11px;color:'+expColor+';font-weight:600">'+expStatus+'</span></div></div>'}
el.innerHTML=h}

function loadNDISClientSupportPlan(clientName){
var el=document.getElementById("supportPlanContent");if(!el)return;
apiCall("GET","/api/client-support-plan?name="+encodeURIComponent(clientName)).then(function(data){
var records=data.records||[];
if(records.length===0){
// Fallback to clientData overview
var d=selectedConv&&selectedConv._clientData;
if(d)renderSupportPlanFromClientData(el,d);
else el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üõ°Ô∏è</div><div style="font-size:13px;font-weight:600">No support plan records found</div><div style="font-size:11px;margin-top:4px">No entries in Support Plan - 2025 for '+clientName+'</div></div>';
return}
renderSupportPlanRecords(el,records,clientName)
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:12px;text-align:center">Failed to load: '+e.message+'</div>'})}

function renderSupportPlanRecords(el,records,clientName){
var h='<div style="margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">Support Plan</div><div style="font-size:11px;color:var(--muted)">'+records.length+' record'+(records.length!==1?"s":"")+" from Support Plan - 2025"+'</div></div>';
records.forEach(function(f,idx){
h+='<div style="padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:10px">';
// Show all fields dynamically
var keys=Object.keys(f).sort();
var skipFields=["Client Name","Client Name (from Client)","Full Name (from Client)","Client"];
keys.forEach(function(k){
if(skipFields.indexOf(k)>=0)return;
var v=f[k];if(!v||v===""||v===0)return;
if(Array.isArray(v)){
if(v.length>0&&typeof v[0]==="object"&&v[0].url){
// Attachments
h+='<div style="margin-bottom:8px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">'+k+'</div>';
v.forEach(function(att){h+='<a href="'+(att.url||"")+'" target="_blank" style="font-size:11px;color:var(--teal);text-decoration:none;display:block">üìé '+(att.filename||"Attachment")+'</a>'});
h+='</div>';return}
v=v.join(", ")}
if(typeof v==="object")v=JSON.stringify(v);
var isDate=typeof v==="string"&&v.match(/^\d{4}-\d{2}/);
var displayVal=v;
if(isDate){try{var dt=new Date(v);if(!isNaN(dt))displayVal=dt.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
var isLong=String(displayVal).length>80;
h+='<div style="margin-bottom:8px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">'+k+'</div><div style="font-size:12px;color:var(--text);'+(isLong?"line-height:1.5;white-space:pre-wrap":"font-weight:600")+'">'+displayVal+'</div></div>'});
h+='</div>'});
el.innerHTML=h}

function renderSupportPlanFromClientData(el,d){
var h='';
h+='<div style="margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">Support Plan Overview</div><div style="font-size:11px;color:var(--muted)">Service delivery details for '+(d.name||"this participant")+'</div></div>';
// Service type
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
h+='<div style="padding:14px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Service Type</div><div style="font-size:14px;font-weight:700;color:var(--royal)">'+(d.serviceType||"‚Äî")+'</div><div style="font-size:11px;color:var(--muted);margin-top:2px">'+(d.silOrCas||"")+'</div></div>';
h+='<div style="padding:14px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.15);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">NDIS Plan Type</div><div style="font-size:14px;font-weight:700;color:var(--teal)">'+(d.ndisType||"‚Äî")+'</div></div>';
h+='</div>';
// Required skills
if(d.requiredSkills&&d.requiredSkills.length>0){
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">‚ö° Required Staff Skills</div><div style="display:flex;flex-wrap:wrap;gap:6px">';
var skillColors=["#EF4444","#F59E0B","#7C3AED","#1E4BA0","#0A9396","#EC4899","#6366F1","#10B981"];
d.requiredSkills.forEach(function(s,i){var col=skillColors[i%skillColors.length];h+='<span style="padding:5px 12px;border-radius:8px;font-size:11px;font-weight:700;background:'+col+'12;color:'+col+';border:1px solid '+col+'25">'+s+'</span>'});
h+='</div></div>'}
// Key contacts
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üë• Key Contacts</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
[{l:"Support Coordinator",v:d.supportCoordinator},{l:"Plan Manager",v:d.planManager},{l:"Nominee/Guardian",v:d.nominee},{l:"Emergency Contact",v:d.emergencyContact}].forEach(function(kc){
h+='<div style="padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+kc.l+'</div><div style="font-size:12px;font-weight:700;color:var(--text);margin-top:2px">'+(kc.v||"Not assigned")+'</div></div>'});
h+='</div></div>';
// KM allowance
if(d.kmAllowance)h+='<div style="padding:12px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üöó KM Allowance</div><div style="font-size:16px;font-weight:700;color:var(--green)">'+d.kmAllowance+' km per week</div></div>';
el.innerHTML=h}

function loadNDISClientPlan(clientName){
var el=document.getElementById("ndisPlanContent");if(!el)return;
apiCall("GET","/api/client-support-plan?name="+encodeURIComponent(clientName)).then(function(spData){
var ndis=spData.stakeholders&&spData.stakeholders.ndisPlan||{};
var d=selectedConv&&selectedConv._clientData;
if(!d){return apiCall("GET","/api/client-details?name="+encodeURIComponent(clientName)).then(function(data){
if(data.error){el.innerHTML='<div style="color:var(--red);padding:12px">'+data.error+'</div>';return}
if(selectedConv)selectedConv._clientData=data;
if(ndis.startDate)data.planStartDate=ndis.startDate;
if(ndis.expiryDate)data.planExpiry=ndis.expiryDate;
if(ndis.planType)data.ndisType=ndis.planType;
if(ndis.ndisNumber)data.ndisNumber=ndis.ndisNumber;
renderNDISPlan(el,data)})}
if(ndis.startDate)d.planStartDate=ndis.startDate;
if(ndis.expiryDate)d.planExpiry=ndis.expiryDate;
if(ndis.planType)d.ndisType=ndis.planType;
if(ndis.ndisNumber)d.ndisNumber=ndis.ndisNumber;
renderNDISPlan(el,d)}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:12px">'+e.message+'</div>'})}

function renderNDISPlan(el,d){
var h='';
h+='<div style="margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">NDIS Plan &amp; Stakeholders</div><div style="font-size:11px;color:var(--muted)">'+(d.name||"")+'</div></div>';
// Plan overview cards
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:16px">';
h+='<div style="padding:14px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">NDIS Number</div><div style="font-size:16px;font-weight:700;color:var(--royal);font-family:JetBrains Mono,monospace">'+(d.ndisNumber||"‚Äî")+'</div></div>';
h+='<div style="padding:14px;background:rgba(124,58,237,.04);border:1px solid rgba(124,58,237,.15);border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Plan Type</div><div style="font-size:14px;font-weight:700;color:#7C3AED">'+(d.ndisType||"‚Äî")+'</div></div>';
// Plan Start
var startDisp=d.planStartDate||"‚Äî";
if(d.planStartDate){try{var sd=new Date(d.planStartDate);if(!isNaN(sd))startDisp=sd.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
h+='<div style="padding:14px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Plan Start</div><div style="font-size:14px;font-weight:700;color:#3B82F6">'+startDisp+'</div></div>';
// Expiry
var expDisp=d.planExpiry||"‚Äî";var daysLeft=999;
if(d.planExpiry){try{var ed=new Date(d.planExpiry);if(!isNaN(ed)){expDisp=ed.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"});daysLeft=Math.ceil((ed-new Date())/(1000*60*60*24))}}catch(e){}}
var expColor=daysLeft<0?"var(--red)":daysLeft<90?"var(--orange)":"var(--green)";
var expBg=daysLeft<0?"rgba(239,68,68,.04)":daysLeft<90?"rgba(245,158,11,.04)":"rgba(16,185,129,.04)";
var expBorder=daysLeft<0?"rgba(239,68,68,.15)":daysLeft<90?"rgba(245,158,11,.15)":"rgba(16,185,129,.15)";
h+='<div style="padding:14px;background:'+expBg+';border:1px solid '+expBorder+';border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Plan Expiry</div><div style="font-size:14px;font-weight:700;color:'+expColor+'">'+expDisp+'</div>'+(daysLeft!==999?'<div style="font-size:9px;font-weight:600;color:'+expColor+';margin-top:2px">'+(daysLeft<0?Math.abs(daysLeft)+"d overdue":daysLeft+"d remaining")+'</div>':'')+'</div>';
h+='</div>';
// Plan manager & SC
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">';
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">üíº Plan Manager</div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(d.planManager||"Self-managed / NDIA-managed")+'</div></div>';
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">ü§ù Support Coordinator</div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(d.supportCoordinator||"Not assigned")+'</div></div>';
h+='</div>';
el.innerHTML=h}

function loadNDISClientCalendar(clientName){
var el=document.getElementById("calendarContent");if(!el)return;
apiCall("GET","/api/client-calendar?name="+encodeURIComponent(clientName)).then(function(data){
var records=data.records||[];
window._calEvents=records;
window._calClientName=clientName;
var now=new Date();
window._calYear=now.getFullYear();
window._calMonth=now.getMonth();
renderCalendarView(el,records);
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:12px;text-align:center">Failed to load: '+e.message+'</div>'})}

function renderCalendarView(el,records){
var year=window._calYear;var month=window._calMonth;
var months=["January","February","March","April","May","June","July","August","September","October","November","December"];
var days=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
var today=new Date();today.setHours(0,0,0,0);

// Parse events into date map
var eventMap={};
records.forEach(function(ev){
if(!ev.startDate)return;
var d=new Date(ev.startDate);if(isNaN(d))return;
var key=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
if(!eventMap[key])eventMap[key]=[];
eventMap[key].push(ev);
});

// Count upcoming/past
var upcoming=0;var past=0;
records.forEach(function(ev){if(!ev.startDate)return;var d=new Date(ev.startDate);if(d>=today)upcoming++;else past++});

var h='';
// Stats row
h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">';
h+='<div style="padding:12px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs);text-align:center"><div style="font-size:20px;font-weight:800;color:#3B82F6">'+records.length+'</div><div style="font-size:10px;font-weight:600;color:var(--muted)">Total Events</div></div>';
h+='<div style="padding:12px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs);text-align:center"><div style="font-size:20px;font-weight:800;color:var(--green)">'+upcoming+'</div><div style="font-size:10px;font-weight:600;color:var(--muted)">Upcoming</div></div>';
h+='<div style="padding:12px;background:rgba(156,163,175,.06);border:1px solid rgba(156,163,175,.15);border-radius:var(--rs);text-align:center"><div style="font-size:20px;font-weight:800;color:var(--muted)">'+past+'</div><div style="font-size:10px;font-weight:600;color:var(--muted)">Past</div></div>';
h+='</div>';

// Month nav
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:8px 12px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)">';
h+='<button onclick="calNav(-1)" style="border:none;background:none;cursor:pointer;font-size:16px;padding:4px 8px;color:var(--text);font-family:inherit;border-radius:var(--rs)" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">‚óÄ</button>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text)">'+months[month]+' '+year+'</div>';
h+='<div style="display:flex;gap:4px"><button onclick="calNavToday()" style="border:1px solid var(--border);background:var(--surface);cursor:pointer;font-size:10px;padding:4px 10px;color:var(--teal);font-weight:700;font-family:inherit;border-radius:var(--rs)" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface)\'">Today</button>';
h+='<button onclick="calNav(1)" style="border:none;background:none;cursor:pointer;font-size:16px;padding:4px 8px;color:var(--text);font-family:inherit;border-radius:var(--rs)" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">‚ñ∂</button></div></div>';

// Day headers
h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;margin-bottom:1px">';
days.forEach(function(d){h+='<div style="text-align:center;font-size:10px;font-weight:700;color:var(--muted);padding:6px 0;text-transform:uppercase;letter-spacing:.5px">'+d+'</div>'});
h+='</div>';

// Calendar grid
var firstDay=new Date(year,month,1);
var lastDay=new Date(year,month+1,0);
var startDow=firstDay.getDay();startDow=startDow===0?6:startDow-1;// Monday=0
var totalDays=lastDay.getDate();

h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--rs);overflow:hidden">';
// Empty cells before first day
for(var i=0;i<startDow;i++){h+='<div style="min-height:80px;background:var(--surface2);padding:4px"></div>'}
// Day cells
for(var d=1;d<=totalDays;d++){
var key=year+"-"+(month+1)+"-"+d;
var dayEvents=eventMap[key]||[];
var isToday=today.getFullYear()===year&&today.getMonth()===month&&today.getDate()===d;
var cellBg=isToday?"rgba(10,147,150,.06)":"var(--surface)";
var borderStyle=isToday?"box-shadow:inset 0 0 0 2px var(--teal)":"";

h+='<div style="min-height:80px;background:'+cellBg+';padding:4px;position:relative;'+borderStyle+'">';
h+='<div style="font-size:11px;font-weight:'+(isToday?"800":"600")+';color:'+(isToday?"var(--teal)":"var(--text)")+';margin-bottom:2px">'+d+'</div>';

dayEvents.slice(0,3).forEach(function(ev){
var typeColors={"Real Estate Inspection":"#EF4444","Client Shopping List":"#3B82F6","Medical":"#10B981","NDIS":"#7C3AED","Client Shopping":"#3B82F6"};
var evColor=typeColors[ev.appointmentType]||"var(--teal)";
var startTime="";
if(ev.startDate){try{var sd=new Date(ev.startDate);startTime=sd.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}
h+='<div onclick="event.stopPropagation();openCalEvent('+records.indexOf(ev)+')" style="font-size:9px;font-weight:600;padding:2px 4px;margin-bottom:1px;border-radius:3px;background:'+evColor+'18;color:'+evColor+';cursor:pointer;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;border-left:2px solid '+evColor+'" title="'+((ev.eventName||ev.appointmentType||"Event")+" - "+(startTime||"")).replace(/"/g,"&quot;")+'">';
h+=(startTime?startTime+" ":"")+(ev.eventName||ev.appointmentType||"Event");
h+='</div>';
});
if(dayEvents.length>3)h+='<div style="font-size:8px;font-weight:700;color:var(--muted);padding:1px 4px">+'+(dayEvents.length-3)+' more</div>';
h+='</div>';
}
// Empty cells after last day
var endDow=(startDow+totalDays)%7;
if(endDow>0)for(var i=endDow;i<7;i++){h+='<div style="min-height:80px;background:var(--surface2);padding:4px"></div>'}
h+='</div>';

// Upcoming events list
var futureEvents=records.filter(function(ev){return ev.startDate&&new Date(ev.startDate)>=today}).sort(function(a,b){return new Date(a.startDate)-new Date(b.startDate)});
if(futureEvents.length>0){
h+='<div style="margin-top:16px"><div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px">üìã Upcoming Events ('+futureEvents.length+')</div>';
futureEvents.slice(0,10).forEach(function(ev,idx){
var startTime="";var endTime="";var dateStr="";
if(ev.startDate){try{var sd=new Date(ev.startDate);dateStr=sd.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short",year:"numeric"});startTime=sd.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}
if(ev.endDate){try{var ed=new Date(ev.endDate);endTime=ed.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}
var globalIdx=records.indexOf(ev);
h+='<div onclick="openCalEvent('+globalIdx+')" style="padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:6px;cursor:pointer;border-left:3px solid #3B82F6;transition:all .12s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface2)\'">';
h+='<div style="display:flex;align-items:center;justify-content:space-between">';
h+='<div><div style="font-size:12px;font-weight:700;color:var(--text)">'+(ev.eventName||ev.appointmentType||"Event")+'</div>';
h+='<div style="font-size:10px;color:var(--muted)">'+dateStr+(startTime?" ‚Ä¢ "+startTime:"")+(endTime?" ‚Äì "+endTime:"")+'</div>';
if(ev.appointmentType)h+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:rgba(59,130,246,.08);color:#3B82F6;margin-top:2px;display:inline-block">'+ev.appointmentType+'</span>';
h+='</div><span style="font-size:10px;color:var(--muted)">‚ñ∏</span></div></div>';
});
if(futureEvents.length>10)h+='<div style="font-size:10px;color:var(--muted);text-align:center;padding:6px">+'+(futureEvents.length-10)+' more events</div>';
h+='</div>';
}

el.innerHTML=h;
}

function calNav(dir){
window._calMonth+=dir;
if(window._calMonth>11){window._calMonth=0;window._calYear++}
if(window._calMonth<0){window._calMonth=11;window._calYear--}
var el=document.getElementById("calendarContent");if(el)renderCalendarView(el,window._calEvents||[]);
}
function calNavToday(){
var now=new Date();window._calYear=now.getFullYear();window._calMonth=now.getMonth();
var el=document.getElementById("calendarContent");if(el)renderCalendarView(el,window._calEvents||[]);
}
function openCalEvent(idx){
var ev=(window._calEvents||[])[idx];if(!ev)return;
var startTime="";var endTime="";var dateStr="";
if(ev.startDate){try{var sd=new Date(ev.startDate);dateStr=sd.toLocaleDateString("en-AU",{weekday:"long",day:"numeric",month:"long",year:"numeric"});startTime=sd.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}
if(ev.endDate){try{var ed=new Date(ev.endDate);endTime=ed.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}

var overlay=document.createElement("div");overlay.id="calEventOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
var h='<div style="background:var(--surface);border-radius:12px;max-width:560px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìÖ</span><span style="font-size:15px;font-weight:700;color:var(--text)">'+(ev.eventName||"Event Details")+'</span></div><button onclick="document.getElementById(\'calEventOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';
h+='<div style="padding:20px">';

// Status badge
if(ev.status)h+='<div style="margin-bottom:12px"><span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:8px;background:rgba(16,185,129,.08);color:var(--green);border:1px solid rgba(16,185,129,.15)">'+ev.status+'</span></div>';

// Date/time
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';
h+='<div style="padding:10px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:3px">üìÖ Date</div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(dateStr||"‚Äî")+'</div></div>';
h+='<div style="padding:10px;background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.12);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:3px">üïê Time</div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(startTime||"‚Äî")+(endTime?" ‚Äì "+endTime:"")+'</div></div>';
h+='</div>';

// Info fields
var fields=[
{label:"Type of Appointment",val:ev.appointmentType,icon:"üìå"},
{label:"Address & Suburb",val:ev.address,icon:"üìç"},
{label:"SIL or CAS",val:ev.silOrCas,icon:"üè†"},
{label:"Created By",val:ev.createdBy,icon:"üë§"}
];
fields.forEach(function(f){
if(!f.val)return;
h+='<div style="margin-bottom:10px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">'+f.icon+' '+f.label+'</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+f.val+'</div></div>';
});

// Details
if(ev.details){
h+='<div style="margin-bottom:12px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üìù Details of Appointment</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);white-space:pre-wrap">'+ev.details+'</div></div>';
}

// SW Instructions
if(ev.swInstructions){
h+='<div style="margin-bottom:12px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">üìã Instructions for Support Workers</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:10px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12);border-radius:var(--rs);white-space:pre-wrap">'+ev.swInstructions+'</div></div>';
}

// Files
if(ev.files&&ev.files.length>0){
h+='<div style="margin-bottom:12px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">üìé Attachments ('+ev.files.length+')</div>';
ev.files.forEach(function(f){
h+='<a href="'+f.url+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);text-decoration:none;margin-bottom:4px"><span style="font-size:14px">üìé</span><span style="font-size:12px;font-weight:600;color:var(--teal)">'+f.name+'</span></a>';
});
h+='</div>';
}

h+='</div></div>';
overlay.innerHTML=h;document.body.appendChild(overlay);
}

function loadNDISClientBudgets(clientName){
var el=document.getElementById("budgetContent");if(!el)return;
apiCall("GET","/api/client-budgets?name="+encodeURIComponent(clientName)).then(function(data){
var records=data.records||[];
if(records.length===0){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üí∞</div><div style="font-size:13px;font-weight:600">No budget records found</div><div style="font-size:11px;margin-top:4px">No entries in Client Core Budgets for '+clientName+'</div></div>';return}
var h='<div style="margin-bottom:16px"><div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">Core Budgets</div><div style="font-size:11px;color:var(--muted)">'+records.length+' budget line'+(records.length!==1?"s":"")+'</div></div>';
records.forEach(function(f){
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px">';
var keys=Object.keys(f).sort();
var skipFields=["Client Name","Client Name (from Client)","Full Name (from Client)","Client"];
keys.forEach(function(k){
if(skipFields.indexOf(k)>=0)return;
var v=f[k];if(!v||v===""||v===0)return;
if(Array.isArray(v)){if(v.length>0&&typeof v[0]==="object"&&v[0].url){h+='<div style="margin-bottom:6px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">'+k+'</div>';v.forEach(function(att){h+='<a href="'+(att.url||"")+'" target="_blank" style="font-size:11px;color:var(--teal);text-decoration:none;display:block">üìé '+(att.filename||"File")+'</a>'});h+='</div>';return}v=v.join(", ")}
if(typeof v==="object")v=JSON.stringify(v);
var isMoney=typeof v==="number"&&(k.toLowerCase().indexOf("budget")>=0||k.toLowerCase().indexOf("amount")>=0||k.toLowerCase().indexOf("cost")>=0||k.toLowerCase().indexOf("rate")>=0||k.toLowerCase().indexOf("total")>=0||k.toLowerCase().indexOf("spent")>=0||k.toLowerCase().indexOf("remaining")>=0||k.toLowerCase().indexOf("$")>=0);
if(isMoney)v="$"+Number(v).toLocaleString("en-AU",{minimumFractionDigits:2,maximumFractionDigits:2});
var isDate=typeof v==="string"&&v.match(/^\d{4}-\d{2}/);
var dv=String(v);if(isDate){try{var dt=new Date(v);if(!isNaN(dt))dv=dt.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
h+='<div style="margin-bottom:6px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">'+k+'</div><div style="font-size:12px;color:var(--text);font-weight:600">'+dv+'</div></div>'});
h+='</div>'});
el.innerHTML=h
}).catch(function(e){el.innerHTML='<div style="color:var(--red);padding:12px;text-align:center">Failed to load: '+e.message+'</div>'})}

function loadConversations(phone,name,contactEmail){var el=document.getElementById("convosContent");if(!el)return;var cemail=(contactEmail||"").toLowerCase();if(!cemail&&name){for(var i=0;i<contacts.length;i++){if(contacts[i].name===name||(contacts[i].phone&&contacts[i].phone===phone)){cemail=(contacts[i].email||"").toLowerCase();break}}}var localEmails=emailList.filter(function(e){if(!cemail)return false;return(e.from_address||"").toLowerCase()===cemail||(e.to_address||"").toLowerCase()===cemail});if(!phone){if(localEmails.length===0){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üí¨</div><div style="font-size:13px;font-weight:600">No conversations found</div><div style="font-size:11px;margin-top:4px">No emails with '+((name||cemail))+'</div></div>';return}var allItems=[];localEmails.forEach(function(e){allItems.push({type:"email",data:e,time:e.received_at||e.sent_at||""})});allItems.sort(function(a,b){return(b.time||"").localeCompare(a.time||"")});window._convoItems=allItems;window._convoFilter="all";var html='<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><div style="font-size:11px;color:var(--muted);font-weight:600">'+allItems.length+' total</div><div style="padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700;background:rgba(16,185,129,.08);color:#059669;border:1px solid rgba(16,185,129,.15)">üìß '+localEmails.length+' email'+(localEmails.length!==1?"s":"")+'</div></div><div id="convoItemsList">'+renderConvoItems(allItems,"all")+'</div>';el.innerHTML=html;return}apiCall("GET","/api/contacts/conversations?phone="+encodeURIComponent(phone)).then(function(data){if(!el)return;var callData=data.calls||[];var smsData=data.sms||[];if(callData.length===0&&smsData.length===0&&localEmails.length===0){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üí¨</div><div style="font-size:13px;font-weight:600">No conversations found</div><div style="font-size:11px;margin-top:4px">No calls, SMS, or emails with '+((name||phone))+'</div></div>';return}var allItems=[];callData.forEach(function(c){allItems.push({type:"call",data:c,time:c.created_at})});smsData.forEach(function(m){allItems.push({type:"sms",data:m,time:m.created_at})});localEmails.forEach(function(e){allItems.push({type:"email",data:e,time:e.received_at||e.sent_at||""})});allItems.sort(function(a,b){return(b.time||"").localeCompare(a.time||"")});var callCount=callData.length;var smsCount=smsData.length;var emailCount=localEmails.length;var html='<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap"><div style="font-size:11px;color:var(--muted);font-weight:600">'+allItems.length+' total</div>';if(callCount>0)html+='<div style="padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700;background:rgba(59,130,246,.08);color:#3B82F6;border:1px solid rgba(59,130,246,.15)">üìû '+callCount+' call'+(callCount!==1?"s":"")+'</div>';if(smsCount>0)html+='<div style="padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700;background:rgba(139,92,246,.08);color:#8B5CF6;border:1px solid rgba(139,92,246,.15)">üí¨ '+smsCount+' SMS</div>';if(emailCount>0)html+='<div style="padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700;background:rgba(16,185,129,.08);color:#059669;border:1px solid rgba(16,185,129,.15)">üìß '+emailCount+' email'+(emailCount!==1?"s":"")+'</div>';html+='</div>';window._convoItems=allItems;var filterState=window._convoFilter||"all";html+='<div style="display:flex;gap:4px;margin-bottom:10px">';["all","calls","sms","email"].forEach(function(f){var isActive=filterState===f;html+='<button onclick="filterConvos(\''+f+'\')" style="padding:4px 12px;border-radius:8px;font-size:10px;font-weight:600;border:1px solid '+(isActive?"var(--teal)":"var(--border)")+';background:'+(isActive?"rgba(10,147,150,.08)":"var(--surface2)")+';color:'+(isActive?"var(--teal)":"var(--muted)")+';cursor:pointer">'+({all:"All",calls:"üìû Calls",sms:"üí¨ SMS",email:"üìß Email"}[f])+'</button>'});html+='</div><div id="convoItemsList">'+renderConvoItems(allItems,filterState)+'</div>';el.innerHTML=html}).catch(function(e){if(el)el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>'})}
function filterConvos(f){window._convoFilter=f;var el=document.getElementById("convoItemsList");if(!el||!window._convoItems)return;el.innerHTML=renderConvoItems(window._convoItems,f);document.querySelectorAll("#convosContent button[onclick^=filterConvos]").forEach(function(b){var m=b.getAttribute("onclick").match(/'(\w+)'/);var bf=m?m[1]:"";b.style.borderColor=bf===f?"var(--teal)":"var(--border)";b.style.background=bf===f?"rgba(10,147,150,.08)":"var(--surface2)";b.style.color=bf===f?"var(--teal)":"var(--muted)"})}
function renderConvoItems(items,filter){function fmtDT(v){if(!v)return"";try{var d=new Date(v);return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){return v}}var filtered=items;if(filter==="calls")filtered=items.filter(function(i){return i.type==="call"});if(filter==="sms")filtered=items.filter(function(i){return i.type==="sms"});if(filter==="email")filtered=items.filter(function(i){return i.type==="email"});if(filtered.length===0)return'<div style="text-align:center;padding:16px;color:var(--muted);font-size:12px">No '+(filter==="all"?"items":filter)+' found</div>';var html="";filtered.forEach(function(item,idx){if(item.type==="call"){var cd=item.data;var isIn=cd.type==="inbound";var dur=cd.duration?cd.duration+"s":"0s";var statusCol=cd.status==="completed"?"var(--green)":cd.status==="no-answer"||cd.status==="busy"?"var(--red)":"var(--orange)";html+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;border-left:3px solid '+(isIn?"#3B82F6":"var(--teal)")+'">';html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:14px">'+(isIn?"üì≤":"üìû")+'</span><span style="font-size:12px;font-weight:700;color:var(--text)">'+(isIn?"Inbound Call":"Outbound Call")+'</span></div><div style="display:flex;align-items:center;gap:6px"><span style="font-size:10px;font-weight:600;padding:2px 6px;border-radius:6px;background:'+statusCol+'15;color:'+statusCol+'">'+(cd.status||"unknown")+'</span><span style="font-size:10px;font-weight:600;color:var(--muted)">‚è± '+dur+'</span></div></div>';html+='<div style="font-size:10px;color:var(--muted);margin-bottom:4px">'+fmtDT(cd.created_at)+'</div>';if(isIn)html+='<div style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:6px;background:rgba(124,58,237,.06);color:#7C3AED;display:inline-block;margin-bottom:4px">ü§ñ Answered by Denise AI</div>';if(cd.summary)html+='<div style="margin-top:6px;padding:8px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.12);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--teal);text-transform:uppercase;margin-bottom:3px">AI Summary</div><div style="font-size:11px;color:var(--text);line-height:1.5">'+cd.summary+'</div></div>';if(cd.transcript){html+='<details style="margin-top:6px"><summary style="font-size:10px;font-weight:600;color:var(--royal);cursor:pointer;padding:4px 0">üìù View Transcript</summary><div style="margin-top:4px;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);font-size:11px;color:var(--text);line-height:1.6;white-space:pre-wrap;max-height:300px;overflow-y:auto">'+cd.transcript+'</div></details>'}if(cd.recording_url)html+='<div style="margin-top:6px"><audio controls style="width:100%;height:32px" src="'+cd.recording_url+'"></audio></div>';html+='</div>'}else if(item.type==="sms"){var sm=item.data;var isOut=sm.direction==="outbound";html+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;border-left:3px solid '+(isOut?"var(--teal)":"#8B5CF6")+'">';html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:14px">'+(isOut?"üì§":"üì•")+'</span><span style="font-size:12px;font-weight:700;color:var(--text)">'+(isOut?"Sent SMS":"Received SMS")+'</span></div></div>';html+='<div style="font-size:10px;color:var(--muted);margin-bottom:6px">'+fmtDT(sm.created_at)+'</div>';if(sm.body)html+='<div style="font-size:12px;color:var(--text);line-height:1.5;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);white-space:pre-wrap">'+sm.body+'</div>';
var _cm=[];try{_cm=JSON.parse(sm.media_urls||'[]')}catch(x){}
if(_cm.length>0){html+='<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:6px">';_cm.forEach(function(m){var isImg=m.type&&m.type.indexOf('image')>=0;if(isImg){html+='<a href="'+m.url+'" target="_blank"><img src="'+m.url+'" style="max-width:180px;max-height:140px;border-radius:6px;border:1px solid var(--border)" onerror="this.style.display=\'none\'"></a>';}else{html+='<a href="'+m.url+'" target="_blank" style="display:flex;align-items:center;gap:5px;padding:5px 8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-size:10px;font-weight:600;color:var(--royal);text-decoration:none">üìé '+m.name+'</a>';}});html+='</div>';}
html+='</div>'}else if(item.type==="email"){var em=item.data;var isOut=em.direction==="outbound";var _ecc=isOut?"#3B82F6":"#6366F1";html+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;border-left:3px solid '+_ecc+'">';html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:14px">üìß</span><span style="font-size:12px;font-weight:700;color:var(--text)">'+(isOut?"Sent Email":"Received Email")+'</span></div>'+(em.has_attachments?'<span style="font-size:10px;color:var(--muted)">üìé</span>':'')+'</div>';html+='<div style="font-size:10px;color:var(--muted);margin-bottom:4px">'+fmtDT(em.received_at||em.sent_at)+'</div>';html+='<div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px">'+(em.subject||"(No subject)")+'</div>';if(em.body_preview)html+='<div style="font-size:11px;color:var(--text2);line-height:1.5;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">'+em.body_preview.substring(0,300)+(em.body_preview.length>300?"...":"")+'</div>';var _ca=[];try{_ca=JSON.parse(em.attachments||"[]")}catch(x){}if(!_ca||!_ca.length)_ca=em.attachmentsList||[];if(_ca.length>0){html+='<div style="margin-top:6px;border-top:1px solid var(--border);padding-top:4px">';_ca.forEach(function(att){var sz=att.size>1048576?(att.size/1048576).toFixed(1)+" MB":att.size>0?(att.size/1024).toFixed(0)+" KB":"";html+='<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px;color:var(--muted)"><span>üìé</span><span style="font-weight:600;color:var(--text)">'+att.name+'</span>'+(sz?' <span>('+sz+')</span>':'')+'</div>'});html+='</div>'}else if(em.has_attachments){html+='<div style="font-size:10px;color:var(--muted);margin-top:4px">üìé Has attachments</div>'}html+='<div style="margin-top:6px"><button onclick="viewFullEmail('+em.id+')" style="font-size:10px;padding:4px 10px;background:rgba(99,102,241,.06);color:#6366F1;border:1px solid rgba(99,102,241,.12);border-radius:var(--rs);cursor:pointer;font-family:inherit;font-weight:600">View Full Email</button></div>';html+='</div>'}});return html}
function loadContactHistory(email,name,clientName){var url="/api/contacts/history?";if(clientName)url+="clientName="+encodeURIComponent(clientName);else{if(email)url+="email="+encodeURIComponent(email);if(name)url+=(email?"&":"")+"name="+encodeURIComponent(name)}apiCall("GET",url).then(function(records){window._contactHistoryRecords=records;var el=document.getElementById("contactHistoryContent");if(!el)return;if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìù</div><div style="font-size:13px;font-weight:600">No contact history found</div><div style="font-size:11px;margin-top:4px">No entries for this employee</div></div>';return}function fmtDT(v){if(!v)return"";if(v.indexOf("T")>=0){try{var d=new Date(v);return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}return v}var html='<div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:600">'+records.length+' record'+(records.length!==1?"s":"")+'</div>';records.forEach(function(r,idx){var dateStr=fmtDT(r.date)||"No date";var methods=Array.isArray(r.method)?r.method:r.method?[r.method]:[];var reasons=Array.isArray(r.reason)?r.reason:r.reason?[r.reason]:[];html+='<div onclick="openContactHistoryModal('+idx+')" style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;cursor:pointer;transition:all .12s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface2)\'">';html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;font-weight:700;color:var(--text)">'+dateStr+'</span><span style="font-size:10px;color:var(--muted)">‚ñ∏</span></div>';if(methods.length>0){html+='<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px">';methods.forEach(function(m){var col=m==="Phone"?"#3B82F6":m==="Email"?"#10B981":m==="SMS"?"#8B5CF6":"#6B7280";html+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:'+col+'15;color:'+col+';border:1px solid '+col+'25">'+m+'</span>'});html+='</div>'}if(reasons.length>0){html+='<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px">';reasons.forEach(function(rr){html+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:rgba(236,72,153,.08);color:#EC4899;border:1px solid rgba(236,72,153,.15)">'+rr+'</span>'});html+='</div>'}if(r.summary||(r.allFields&&r.allFields["Summarise"])){var previewText=r.summary||r.allFields["Summarise"]||"";var preview=previewText.length>120?previewText.substring(0,120)+"‚Ä¶":previewText;html+='<div style="font-size:11px;color:var(--muted);line-height:1.4;margin-top:2px">'+preview.replace(/\n/g," ")+'</div>'}html+='</div>'});el.innerHTML=html}).catch(function(e){var el=document.getElementById("contactHistoryContent");if(el)el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>'})}
function openContactHistoryModal(idx){var r=(window._contactHistoryRecords||[])[idx];if(!r)return;function fmtDT(v){if(!v)return"‚Äî";if(v.indexOf("T")>=0){try{var d=new Date(v);return d.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}return v}var methods=Array.isArray(r.method)?r.method:r.method?[r.method]:[];var reasons=Array.isArray(r.reason)?r.reason:r.reason?[r.reason]:[];var overlay=document.createElement("div");overlay.id="chModalOverlay";overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};var html='<div style="background:var(--surface);border-radius:12px;max-width:640px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';html+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìù</span><span style="font-size:15px;font-weight:700;color:var(--text)">Contact History</span></div><button onclick="document.getElementById(\'chModalOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';html+='<div style="padding:20px">';var dateStr=fmtDT(r.date);if(dateStr&&dateStr!=="‚Äî")html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Date & Time of Contact</div><div style="font-size:14px;font-weight:700;color:var(--text)">'+dateStr+'</div></div>';if(methods.length>0){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Method of Contact</div><div style="display:flex;gap:4px;flex-wrap:wrap">';methods.forEach(function(m){var col=m==="Phone"?"#3B82F6":m==="Email"?"#10B981":m==="SMS"?"#8B5CF6":"#6B7280";html+='<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:10px;background:'+col+'15;color:'+col+';border:1px solid '+col+'25">'+m+'</span>'});html+='</div></div>'}if(reasons.length>0){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Reason for Contact</div><div style="display:flex;gap:4px;flex-wrap:wrap">';reasons.forEach(function(rr){html+='<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:10px;background:rgba(236,72,153,.08);color:#EC4899;border:1px solid rgba(236,72,153,.15)">'+rr+'</span>'});html+='</div></div>'}if(r.workerName)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Support Worker</div><div style="font-size:13px;font-weight:600;color:var(--text)">'+r.workerName+'</div></div>';if(r.staffName)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Staff Name (Internal Office)</div><div style="font-size:13px;font-weight:600;color:var(--royal)">'+r.staffName+'</div></div>';var metaFields=[];if(r.duration)metaFields.push({label:"Duration",val:r.duration});if(r.assignee)metaFields.push({label:"Assignee",val:r.assignee});if(r.jobTitle)metaFields.push({label:"Job Title",val:r.jobTitle});if(metaFields.length>0){html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';metaFields.forEach(function(m){html+='<div style="padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.3px">'+m.label+'</div><div style="font-size:12px;font-weight:600;color:var(--text);margin-top:2px">'+m.val+'</div></div>'});html+='</div>'}if(r.summary||(r.allFields&&r.allFields["Summarise"])){var summaryText=r.summary||r.allFields["Summarise"]||"";if(summaryText)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Summary</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:12px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border);white-space:pre-wrap">'+summaryText+'</div></div>'};if(r.files&&r.files.length>0){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Attachments ('+r.files.length+')</div><div style="display:flex;flex-direction:column;gap:6px">';r.files.forEach(function(f){html+='<a href="'+f.url+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);text-decoration:none"><span style="font-size:16px">üìé</span><div><div style="font-size:12px;font-weight:600;color:var(--text)">'+f.name+'</div>'+(f.size?'<div style="font-size:10px;color:var(--muted)">'+(f.size>1048576?(f.size/1048576).toFixed(1)+" MB":(f.size/1024).toFixed(0)+" KB")+'</div>':'')+'</div></a>'});html+='</div></div>'}if(r.lastModified)html+='<div style="font-size:10px;color:var(--muted);margin-top:8px">Last modified: '+fmtDT(r.lastModified)+'</div>';var af=r.allFields||{};var shown={"Date & Time of...":1,"Date & Time of":1,"Day of Contact":1,"Date & Time of Contact":1,"Support Worker Name":1,"Full Name (from Support Worker Name)":1,"Email (from Support Worker Name)":1,"Employees Full Name":1,"Full Name (Formula)":1,"Method of Contact":1,"Reason for Contact":1,"Summarise":1,"Duration of work to...":1,"Duration of work to complete contact":1,"Assignee":1,"Staff Name":1,"Upload File here":1,"Last modified":1,"Unique Contact Record":1,"Job Title":1,"Job Title (Formula)":1,"Status of Contact":1,"Status of Contact (Formula)":1};var extra={};Object.keys(af).forEach(function(k){if(shown[k])return;var v=af[k];if(!v||v===""||v===0||(Array.isArray(v)&&v.length===0))return;extra[k]=v});var extraKeys=Object.keys(extra);if(extraKeys.length>0){html+='<details style="margin-top:8px"><summary style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;padding:6px 0">All Other Fields ('+extraKeys.length+')</summary><div style="display:grid;gap:6px;margin-top:6px">';extraKeys.sort().forEach(function(k){var v=extra[k];if(Array.isArray(v))v=v.join(", ");if(typeof v==="object")v=JSON.stringify(v);html+='<div style="padding:6px 8px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+k+'</div><div style="font-size:11px;color:var(--text);margin-top:1px;word-break:break-word">'+v+'</div></div>'});html+='</div></details>'}html+='</div></div>';overlay.innerHTML=html;document.body.appendChild(overlay)}
function loadProgressNotes(email,clientName){var url="/api/contacts/progress-notes?";if(clientName)url+="clientName="+encodeURIComponent(clientName);else url+="email="+encodeURIComponent(email);apiCall("GET",url).then(function(records){window._progressRecords=records;var el=document.getElementById("progressNotesContent");if(!el)return;if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìì</div><div style="font-size:13px;font-weight:600">No progress notes found</div><div style="font-size:11px;margin-top:4px">No entries for this employee</div></div>';return}function fmtDT(v){if(!v)return"";if(v.indexOf("T")>=0){try{var d=new Date(v);return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}return v}var html='<div style="font-size:11px;color:var(--muted);margin-bottom:10px;font-weight:600">'+records.length+' note'+(records.length!==1?"s":"")+'</div>';records.forEach(function(r,idx){var startStr=fmtDT(r.startDate);var endStr=fmtDT(r.endDate);var hasTransport=r.transport&&r.transport.toLowerCase().indexOf("yes")>=0;html+='<div onclick="openProgressModal('+idx+')" style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;cursor:pointer;transition:all .12s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface2)\'">';html+='<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:4px"><div>';html+='<div style="font-size:12px;font-weight:700;color:var(--text)">'+startStr+'</div>';if(endStr)html+='<div style="font-size:10px;color:var(--muted);margin-top:1px">‚Üí '+endStr+'</div>';html+='</div>';html+='<div style="display:flex;gap:4px;align-items:center;flex-shrink:0">';if(r.totalHours)html+='<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.2)">‚è± '+r.totalHours+'h</span>';html+='<span style="font-size:10px;color:var(--muted)">‚ñ∏</span></div></div>';if(r.client)html+='<div style="font-size:11px;font-weight:600;color:var(--royal);margin-bottom:4px">üë§ '+r.client+'</div>';html+='<div style="display:flex;gap:4px;flex-wrap:wrap">';if(r.shiftType)html+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:var(--surface);border:1px solid var(--border);color:var(--muted)">'+r.shiftType+'</span>';if(hasTransport)html+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:rgba(59,130,246,.08);color:#3B82F6;border:1px solid rgba(59,130,246,.15)">üöó Transport</span>';if(r.kms>0)html+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.15)">'+r.kms+' km</span>';html+='</div>';html+='</div>'});el.innerHTML=html}).catch(function(e){var el=document.getElementById("progressNotesContent");if(el)el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>'})}
function openProgressModal(idx){var r=(window._progressRecords||[])[idx];if(!r)return;function fmtDT(v){if(!v)return"";if(v.indexOf("T")>=0){try{var d=new Date(v);return d.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}return v}var hasTransport=r.transport&&r.transport.toLowerCase().indexOf("yes")>=0;var overlay=document.createElement("div");overlay.id="progressModalOverlay";overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};var html='<div style="background:var(--surface);border-radius:12px;max-width:640px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';html+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìì</span><span style="font-size:15px;font-weight:700;color:var(--text)">Progress Note</span>'+(r.totalHours?'<span style="font-size:12px;font-weight:700;padding:2px 10px;border-radius:10px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.2)">‚è± '+r.totalHours+'h</span>':'')+'</div><button onclick="document.getElementById(\'progressModalOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';html+='<div style="padding:20px">';var hasStart=r.startDate&&fmtDT(r.startDate);var hasEnd=r.endDate&&fmtDT(r.endDate);if(hasStart||hasEnd){html+='<div style="display:grid;grid-template-columns:'+(hasStart&&hasEnd?"1fr 1fr":"1fr")+';gap:12px;margin-bottom:16px">';if(hasStart)html+='<div style="padding:12px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.15);border-radius:var(--rs)"><div style="font-size:10px;font-weight:600;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Shift Start</div><div style="font-size:14px;font-weight:700;color:var(--text)">'+fmtDT(r.startDate)+'</div></div>';if(hasEnd)html+='<div style="padding:12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.12);border-radius:var(--rs)"><div style="font-size:10px;font-weight:600;color:var(--red);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Shift End</div><div style="font-size:14px;font-weight:700;color:var(--text)">'+fmtDT(r.endDate)+'</div></div>';html+='</div>'}if(r.created)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Created Date & Time</div><div style="font-size:13px;font-weight:600;color:var(--text)">'+fmtDT(r.created)+'</div></div>';if(r.client)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Client</div><div style="font-size:14px;font-weight:700;color:var(--royal)">'+r.client+'</div></div>';if(r.workerName)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Support Worker</div><div style="font-size:13px;font-weight:600;color:var(--text)">'+r.workerName+'</div></div>';var metaFields=[];if(r.shiftType)metaFields.push({label:"Shift Type",val:r.shiftType});if(r.totalHours)metaFields.push({label:"Total Hours",val:r.totalHours+"h"});if(r.transport)metaFields.push({label:"Transport Client?",val:hasTransport?"Yes ‚úÖ":"No"});if(r.kmsRaw)metaFields.push({label:"Kilometers",val:r.kmsRaw});else if(r.kms>0)metaFields.push({label:"Kilometers",val:r.kms+" km"});if(r.from)metaFields.push({label:"Travel From",val:r.from});if(r.to)metaFields.push({label:"Travel To",val:r.to});if(metaFields.length>0){html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';metaFields.forEach(function(m){html+='<div style="padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.3px">'+m.label+'</div><div style="font-size:12px;font-weight:600;color:var(--text);margin-top:2px">'+m.val+'</div></div>'});html+='</div>'}var noteText=r.notes||(r.allFields&&r.allFields["Progress Note"])||"";if(noteText)html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Progress Note</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:12px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border);white-space:pre-wrap">'+noteText+'</div></div>';if(r.files&&r.files.length>0){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Attachments ('+r.files.length+')</div><div style="display:flex;flex-direction:column;gap:6px">';r.files.forEach(function(f){html+='<a href="'+f.url+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);text-decoration:none"><span style="font-size:16px">üìé</span><div style="font-size:12px;font-weight:600;color:var(--text)">'+f.name+'</div></a>'});html+='</div></div>'}var af=r.allFields||{};var shown={"Start Date & Time Formula":1,"Start Date and Time":1,"End Date & Time Formula":1,"End Date and Time":1,"Total Hours":1,"Hours":1,"Client Name (from Client)":1,"Full Name (from Client)":1,"Client Name":1,"Client":1,"Name (from Client)":1,"Unique Client ID (from Client)":1,"Full Name (from Employees)":1,"Support Workers Name":1,"Did you transport the client in your vehicle today?":1,"Transport":1,"Created":1,"Created Formula":1,"Shift Type":1,"Service Type":1,"Progress Note":1,"Notes":1,"Summary":1,"KMs":1,"Kilometers":1,"How many Kilometres did you transport Client in your vehicle today and list TO & FROM addresses?":1,"Travel From":1,"Travel To":1,"From":1,"To":1,"Attachments":1,"Files":1,"Upload":1,"Record ID":1};var extra={};Object.keys(af).forEach(function(k){if(shown[k])return;var v=af[k];if(!v||v===""||v===0||v===false||(Array.isArray(v)&&v.length===0))return;extra[k]=v});var extraKeys=Object.keys(extra);if(extraKeys.length>0){html+='<details style="margin-top:8px"><summary style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;padding:6px 0">All Other Fields ('+extraKeys.length+')</summary><div style="display:grid;gap:6px;margin-top:6px">';extraKeys.sort().forEach(function(k){var v=extra[k];if(Array.isArray(v))v=v.map(function(x){return typeof x==="object"?(x.filename||x.name||JSON.stringify(x)):x}).join(", ");if(typeof v==="object")v=JSON.stringify(v);html+='<div style="padding:6px 8px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+k+'</div><div style="font-size:11px;color:var(--text);margin-top:1px;word-break:break-word;white-space:pre-wrap">'+v+'</div></div>'});html+='</div></details>'}html+='</div></div>';overlay.innerHTML=html;document.body.appendChild(overlay)}
function loadIncidentReports(email,clientName){var url="/api/contacts/incidents?";if(clientName)url+="clientName="+encodeURIComponent(clientName);else url+="email="+encodeURIComponent(email);apiCall("GET",url).then(function(records){window._incidentRecords=records;var el=document.getElementById("incidentReportsContent");if(!el)return;if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">‚ö†Ô∏è</div><div style="font-size:13px;font-weight:600">No incident reports found</div><div style="font-size:11px;margin-top:4px">No incidents linked to this employee</div></div>';return}var html='<div style="font-size:11px;color:var(--muted);margin-bottom:10px;font-weight:600">'+records.length+' report'+(records.length!==1?"s":"")+'</div>';records.forEach(function(r,idx){var cats=Array.isArray(r.categories)?r.categories:r.categories?[r.categories]:[];var dateStr=r.date||"No date";if(dateStr.indexOf("T")>=0){try{var d=new Date(dateStr);dateStr=d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}var isReportable=r.reportable&&(r.reportable.toLowerCase().indexOf("yes")>=0||r.reportable==="true");html+='<div onclick="openIncidentModal('+idx+')" style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px;cursor:pointer;transition:all .12s;border-left:3px solid '+(isReportable?"var(--red)":"var(--teal)")+'" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface2)\'">';html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><span style="font-size:12px;font-weight:700;color:var(--text)">'+dateStr+'</span><div style="display:flex;gap:4px;align-items:center">';if(isReportable)html+='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:8px;background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)">üî¥ REPORTABLE</span>';else if(r.reportable)html+='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:8px;background:rgba(16,185,129,.08);color:var(--green);border:1px solid rgba(16,185,129,.2)">‚úÖ Not Reportable</span>';html+='<span style="font-size:10px;color:var(--muted)">‚ñ∏</span></div></div>';if(r.client)html+='<div style="font-size:11px;font-weight:600;color:var(--royal);margin-bottom:4px">üë§ '+r.client+'</div>';if(cats.length>0){html+='<div style="display:flex;gap:4px;flex-wrap:wrap">';cats.forEach(function(cat){html+='<span style="font-size:9px;font-weight:600;padding:1px 6px;border-radius:8px;background:rgba(245,158,11,.08);color:var(--orange);border:1px solid rgba(245,158,11,.15)">'+cat+'</span>'});html+='</div>'}html+='</div>'});el.innerHTML=html}).catch(function(e){var el=document.getElementById("incidentReportsContent");if(el)el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>'})}
function openIncidentModal(idx){var r=(window._incidentRecords||[])[idx];if(!r)return;var dateStr=r.date||"No date";if(dateStr.indexOf("T")>=0){try{var d=new Date(dateStr);dateStr=d.toLocaleDateString("en-AU",{weekday:"long",day:"numeric",month:"long",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}var cats=Array.isArray(r.categories)?r.categories:r.categories?[r.categories]:[];var isReportable=r.reportable&&(r.reportable.toLowerCase().indexOf("yes")>=0||r.reportable==="true");var overlay=document.createElement("div");overlay.id="incidentModalOverlay";overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};var html='<div style="background:var(--surface);border-radius:12px;max-width:640px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';html+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">‚ö†Ô∏è</span><span style="font-size:15px;font-weight:700;color:var(--text)">Incident Report</span></div><button onclick="document.getElementById(\'incidentModalOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';html+='<div style="padding:20px">';html+='<div style="margin-bottom:16px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Date & Time</div><div style="font-size:14px;font-weight:700;color:var(--text)">'+dateStr+'</div></div>';if(isReportable)html+='<div style="padding:10px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:16px">üî¥</span><div><div style="font-size:12px;font-weight:700;color:var(--red)">NDIS Reportable Incident</div><div style="font-size:10px;color:var(--red);opacity:.8">Reportable to NDIS Quality & Safeguards Commission</div></div></div>';else if(r.reportable)html+='<div style="padding:8px 12px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs);margin-bottom:12px;font-size:11px;font-weight:600;color:var(--green)">‚úÖ Not a reportable incident</div>';if(r.client){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Client</div><div style="font-size:13px;font-weight:600;color:var(--royal)">'+r.client+'</div></div>'}if(r.reporter){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Reported By</div><div style="font-size:13px;font-weight:600;color:var(--text)">'+r.reporter+'</div></div>'}if(cats.length>0){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Incident Categories</div><div style="display:flex;gap:4px;flex-wrap:wrap">';cats.forEach(function(cat){html+='<span style="font-size:10px;font-weight:600;padding:3px 10px;border-radius:10px;background:rgba(245,158,11,.08);color:var(--orange);border:1px solid rgba(245,158,11,.15)">'+cat+'</span>'});html+='</div></div>'}var detailFields=[{label:"Type of Incident",val:r.type},{label:"Severity",val:r.severity},{label:"Status",val:r.status},{label:"Location",val:r.location},{label:"Injuries",val:r.injuries},{label:"Witnesses",val:r.witnesses}];var hasDetails=detailFields.some(function(d){return d.val});if(hasDetails){html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';detailFields.forEach(function(d){if(!d.val)return;var v=Array.isArray(d.val)?d.val.join(", "):d.val;html+='<div style="padding:8px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.3px">'+d.label+'</div><div style="font-size:12px;font-weight:600;color:var(--text);margin-top:2px">'+v+'</div></div>'});html+='</div>'}if(r.description){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Description</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:12px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border);white-space:pre-wrap">'+r.description+'</div></div>'}if(r.actionTaken){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Action Taken</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:12px;background:rgba(16,185,129,.04);border-radius:var(--rs);border:1px solid rgba(16,185,129,.15);white-space:pre-wrap">'+r.actionTaken+'</div></div>'}if(r.followUp){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Follow Up</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:12px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border);white-space:pre-wrap">'+r.followUp+'</div></div>'}if(r.files&&r.files.length>0){html+='<div style="margin-bottom:12px"><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Attachments ('+r.files.length+')</div><div style="display:flex;flex-direction:column;gap:6px">';r.files.forEach(function(f){var isImg=f.type&&f.type.indexOf("image")>=0;html+='<a href="'+f.url+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);text-decoration:none;transition:all .12s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface2)\'">'+(isImg?'<span style="font-size:16px">üñºÔ∏è</span>':'<span style="font-size:16px">üìé</span>')+'<div><div style="font-size:12px;font-weight:600;color:var(--text)">'+f.name+'</div>'+(f.size?'<div style="font-size:10px;color:var(--muted)">'+(f.size>1048576?(f.size/1048576).toFixed(1)+" MB":(f.size/1024).toFixed(0)+" KB")+'</div>':'')+'</div></a>'});html+='</div></div>'}var af=r.allFields||{};var shown=["Date & Time of Incident FORMULA","Date & Time of Incident","Date","Incident Categories","Category","Client Name","Client Name (from Client Name)","Full Name (from Person completing IR)","Person completing IR","Is this a Reportable Incident to the NDIS Quality Safeguards Commission??","Is this a Reportable Incident to the NDIS Quality Safeguards Commission??","Reportable Incident","Type of Incident","Incident Type","Severity","Risk Level","Status","IR Status","Description","Summary","Details","What Happened","Location","Location of Incident","Action Taken","Immediate Action","Follow Up","Follow Up Actions","Witnesses","Injuries","Injury Details","Attachments","Files","Upload","Upload File here","Unique IR #","Record ID"];var extra={};Object.keys(af).forEach(function(k){if(shown.indexOf(k)>=0)return;var v=af[k];if(!v||v===""||v===0||(Array.isArray(v)&&v.length===0))return;extra[k]=v});var extraKeys=Object.keys(extra);if(extraKeys.length>0){html+='<details style="margin-bottom:12px"><summary style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;padding:6px 0">All Other Fields ('+extraKeys.length+')</summary><div style="display:grid;gap:6px;margin-top:6px">';extraKeys.sort().forEach(function(k){var v=extra[k];if(Array.isArray(v))v=v.join(", ");if(typeof v==="object")v=JSON.stringify(v);html+='<div style="padding:6px 8px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+k+'</div><div style="font-size:11px;color:var(--text);margin-top:1px;word-break:break-word">'+v+'</div></div>'});html+='</div></details>'}html+='</div></div>';overlay.innerHTML=html;document.body.appendChild(overlay)}
function loadKms(email,name){var url="/api/contacts/kms?";if(email)url+="email="+encodeURIComponent(email);if(name)url+=(email?"&":"")+"name="+encodeURIComponent(name);apiCall("GET",url).then(function(records){var el=document.getElementById("kmsContent");if(!el)return;if(!records||records.length===0){el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üöó</div><div style="font-size:13px;font-weight:600">No KM records found</div><div style="font-size:11px;margin-top:4px">No travel entries for this employee</div></div>';return}function fmtDT(v){if(!v)return"";if(v.indexOf("T")>=0){try{var d=new Date(v);return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+", "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){}}return v}var totalKms=records.reduce(function(a,r){return a+(r.kms||0)},0);var html='<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px"><div style="font-size:11px;color:var(--muted);font-weight:600">'+records.length+' trip'+(records.length!==1?"s":"")+'</div><div style="padding:4px 10px;background:rgba(10,147,150,.08);border:1px solid rgba(10,147,150,.2);border-radius:8px;font-size:12px;font-weight:700;color:var(--teal)">Total: '+totalKms.toFixed(1)+' km</div></div>';records.forEach(function(r){var dateStr=fmtDT(r.date)||"No date";html+='<div style="padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">';html+='<div><div style="font-size:12px;font-weight:600;color:var(--text)">'+dateStr+'</div>';if(r.client)html+='<div style="font-size:10px;font-weight:600;color:var(--royal)">üë§ '+r.client+'</div>';if(r.from&&r.to)html+='<div style="font-size:10px;color:var(--muted)">'+r.from+' ‚Üí '+r.to+'</div>';html+='</div>';html+='<div style="font-size:14px;font-weight:700;color:var(--teal);font-family:JetBrains Mono,monospace">'+(r.kmsRaw||((r.kms||0)+' km'))+'</div></div>'});el.innerHTML=html}).catch(function(e){var el=document.getElementById("kmsContent");if(el)el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>'})}

// ‚ïê‚ïê‚ïê STAKEHOLDERS TAB ‚ïê‚ïê‚ïê
function loadStakeholders(clientName,contact){
var el=document.getElementById("stakeholdersContent");if(!el)return;
apiCall("GET","/api/client-support-plan?name="+encodeURIComponent(clientName)).then(function(data){
var sh=data.stakeholders||{};
if(!data.clientFound){el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üë•</div><div style="font-size:13px;font-weight:600">No client record found</div><div style="font-size:11px;margin-top:4px">Could not load stakeholders for '+clientName+'</div></div>';return}
var stakeholders=[];
var sc=sh.supportCoordinator||{};if(sc.name)stakeholders.push({role:"Support Coordinator",name:sc.name,email:sc.email,phone:sc.phone,company:sc.company,icon:"ü§ù",color:"var(--teal)",bg:"rgba(10,147,150,.06)"});
var pm=sh.planManager||{};if(pm.name)stakeholders.push({role:"Plan Manager",name:pm.name,email:pm.email,phone:pm.phone,company:pm.company,icon:"üíº",color:"#7C3AED",bg:"rgba(124,58,237,.04)"});
var nom=sh.nominee||{};if(nom.name)stakeholders.push({role:"Nominee / Guardian",name:nom.name,email:nom.email,phone:nom.phone,icon:"üõ°Ô∏è",color:"var(--royal)",bg:"rgba(30,75,160,.04)"});
var opg=sh.opg||{};if(opg.name)stakeholders.push({role:"Public Guardian (OPG)",name:opg.name,email:opg.email,phone:opg.phone,icon:"‚öñÔ∏è",color:"#D97706",bg:"rgba(217,119,6,.04)"});
var bp=sh.behaviourPractitioner||{};if(bp.name)stakeholders.push({role:"Behaviour Practitioner",name:bp.name,email:bp.email,phone:bp.phone,icon:"üß†",color:"#DC2626",bg:"rgba(220,38,38,.04)"});
var ec=sh.emergency||{};if(ec.name)stakeholders.push({role:"Emergency Contact",name:ec.name,email:ec.email,phone:ec.phone,relationship:ec.relationship,icon:"üö®",color:"#EF4444",bg:"rgba(239,68,68,.04)"});
// Decisions section
var dec=sh.decisions||{};
var h='<div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">üë• Key Stakeholders</div>';
h+='<div style="font-size:11px;color:var(--muted);margin-bottom:16px">Support team contacts for '+clientName+'</div>';
if(stakeholders.length===0){
h+='<div style="text-align:center;padding:30px;color:var(--muted);background:var(--surface2);border:1px dashed var(--border);border-radius:var(--r)"><div style="font-size:28px;margin-bottom:8px">üë•</div><div style="font-size:12px;font-weight:600">No stakeholders assigned</div><div style="font-size:11px;margin-top:4px">Assign a Support Coordinator, Plan Manager, or Guardian in the Clients table</div></div>';
}else{
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px">';
stakeholders.forEach(function(s){
h+='<div style="background:'+s.bg+';border:1px solid '+s.color+'20;border-left:4px solid '+s.color+';border-radius:var(--r);overflow:hidden">';
h+='<div style="padding:14px 16px;border-bottom:1px solid '+s.color+'15"><div style="display:flex;align-items:center;gap:10px"><div style="width:40px;height:40px;border-radius:50%;background:'+s.color+'15;display:flex;align-items:center;justify-content:center;font-size:18px">'+s.icon+'</div><div style="flex:1"><div style="font-size:10px;font-weight:700;color:'+s.color+';text-transform:uppercase;letter-spacing:.5px">'+s.role+'</div><div style="font-size:14px;font-weight:700;color:var(--text);margin-top:2px">'+(s.name||"Not assigned")+'</div></div></div></div>';
h+='<div style="padding:12px 16px">';
var fields=[{label:"Phone",val:s.phone,icon:"üì±"},{label:"Email",val:s.email,icon:"üìß"},{label:"Company",val:s.company,icon:"üè¢"},{label:"Relationship",val:s.relationship,icon:"üë•"}];
fields.forEach(function(dd){if(!dd.val)return;
h+='<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">';
h+='<span style="font-size:12px;width:16px;text-align:center">'+dd.icon+'</span>';
h+='<span style="font-size:10px;font-weight:600;color:var(--muted);width:85px;text-transform:uppercase;letter-spacing:.3px">'+dd.label+'</span>';
if(dd.label==="Email")h+='<a href="mailto:'+dd.val+'" style="font-size:12px;font-weight:600;color:var(--teal);text-decoration:none">'+dd.val+'</a>';
else if(dd.label==="Phone")h+='<a href="tel:'+dd.val+'" style="font-size:12px;font-weight:600;color:var(--text);text-decoration:none">'+dd.val+'</a>';
else h+='<span style="font-size:12px;font-weight:600;color:var(--text)">'+dd.val+'</span>';
h+='</div>'});
h+='<div style="display:flex;gap:6px;margin-top:10px">';
if(s.phone)h+='<button onclick="dialerNumber=\''+s.phone.replace(/'/g,"")+'\';openDialer()" style="flex:1;padding:6px;background:rgba(10,147,150,.06);border:1px solid rgba(10,147,150,.15);border-radius:var(--rs);cursor:pointer;font-size:10px;font-weight:700;color:var(--teal);font-family:inherit">üìû Call</button>';
if(s.email)h+='<a href="mailto:'+s.email+'" style="flex:1;padding:6px;background:rgba(124,58,237,.06);border:1px solid rgba(124,58,237,.15);border-radius:var(--rs);font-size:10px;font-weight:700;color:#7C3AED;font-family:inherit;text-decoration:none;text-align:center">üìß Email</a>';
h+='</div>';
h+='</div></div>'});
h+='</div>'}
// Decisions section
if(dec.ownDecisionMaker){
h+='<div style="margin-top:16px;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r)">';
h+='<div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">‚öñÔ∏è Decision Making</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
var decFields=[{l:"Own Decision Maker?",v:dec.ownDecisionMaker},{l:"Medical",v:dec.medical},{l:"Financial",v:dec.financial},{l:"NDIS & Accommodation",v:dec.ndisAccommodation},{l:"Living Arrangements",v:dec.livingArrangements},{l:"Legal",v:dec.legal}];
decFields.forEach(function(df){if(!df.v)return;
h+='<div style="padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">'+df.l+'</div><div style="font-size:12px;font-weight:700;color:var(--text);margin-top:2px">'+df.v+'</div></div>'});
h+='</div></div>'}
el.innerHTML=h;
}).catch(function(e){
el.innerHTML='<div style="text-align:center;padding:30px;color:var(--red)">Failed to load: '+e.message+'</div>';
});
}

function showAddContact(){var rp=document.getElementById("rightPanel");
// Gather unique contact types from loaded contacts + defaults
var typeSet={};
contacts.forEach(function(c){if(c.contactType)typeSet[c.contactType]=1});
CONTACT_TYPES.forEach(function(t){typeSet[t]=1});
var types=Object.keys(typeSet).sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())});

var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar" style="background:var(--surface2);color:var(--muted);border:1px solid var(--border)">?</div><div><div class="rp-hdr-name">New Contact</div><div class="rp-hdr-sub">Select a contact type to begin</div></div></div></div>';
html+='<div style="flex:1;overflow-y:auto;padding:20px"><div style="margin-bottom:16px"><div class="fg"><label>What type of contact is this?</label></div>';
html+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
types.forEach(function(t){var css=getContactTypeCss(t);
html+='<button class="btn" onclick="createNewContactWithType(\''+t.replace(/'/g,"\\'")+'\')" style="text-align:left;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);cursor:pointer;font-size:12px;font-weight:600;color:var(--text);transition:all .12s" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.background=\'rgba(10,147,150,.04)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.background=\'var(--surface)\'"><span class="contact-type-badge '+css+'" style="font-size:11px">'+t+'</span></button>'});
html+='</div></div></div>';rp.innerHTML=html}
function createNewContactWithType(type){selectedConv={id:"new",name:"",firstName:"",lastName:"",phone:"+61400000000",email:"",contactType:type,statusOfContact:"Active Contact",organisation:"",homeAddress:"",suburb:"",state:"",postcode:"",abn:"",notes:"",gender:"",linkedToClient:""};renderContactDetail()}
function saveContact(id){var firstName=(document.getElementById("editFirstName")||{}).value||"";var lastName=(document.getElementById("editLastName")||{}).value||"";var data={firstName:firstName,lastName:lastName,name:(firstName+" "+lastName).trim()||(document.getElementById("editName")||{}).value||"",phone:document.getElementById("editPhone").value.replace(/[^+0-9]/g,""),email:(document.getElementById("editEmail")||{}).value||"",signingEmail:(document.getElementById("editSigningEmail")||{}).value||"",organisation:(document.getElementById("editOrg")||{}).value||"",homeAddress:(document.getElementById("editAddress")||{}).value||"",suburb:(document.getElementById("editSuburb")||{}).value||"",state:(document.getElementById("editState")||{}).value||"",postcode:(document.getElementById("editPostcode")||{}).value||"",abn:(document.getElementById("editAbn")||{}).value||"",notes:(document.getElementById("editNotes")||{}).value||"",statusOfContact:(document.getElementById("editStatus")||{}).value||"",gender:(document.getElementById("editGender")||{}).value||""};if(selectedConv&&selectedConv.contactType)data.contactType=selectedConv.contactType;var editCT=(document.getElementById("editContactType")||{}).value;if(editCT)data.contactType=editCT;if(id==="new"||id===""){apiCall("POST","/api/contacts",data).then(function(r){if(r.error){alert("Error: "+r.error);return}apiCall("GET","/api/contacts").then(function(d){contacts=d||[];selectedConv=null;render()})})}else{apiCall("PUT","/api/contacts/"+id,data).then(function(){apiCall("GET","/api/contacts").then(function(d){contacts=d||[];selectedConv=contacts.find(function(c){return(c.id||c.airtable_id)==id});render()})})}}
function deleteContact(id){if(!confirm("Delete this contact?"))return;apiCall("DELETE","/api/contacts/"+id).then(function(){apiCall("GET","/api/contacts").then(function(d){contacts=d||[];selectedConv=null;render()})})}
function syncDialerSoftphoneStatus(){var dot=document.getElementById("dialerSoftphoneDot");var label=document.getElementById("dialerSoftphoneLabel");if(!dot||!label)return;if(typeof twilioDevice!=="undefined"&&twilioDevice&&twilioDevice.state==="registered"){dot.style.background="#10b981";label.textContent="Softphone Ready"}else if(typeof twilioDevice!=="undefined"&&twilioDevice){dot.style.background="#f59e0b";label.textContent="Connecting..."}else{dot.style.background="#94a3b8";label.textContent="Softphone Offline"}}
function initDialerPad(){var pad=document.getElementById("dialPad");if(!pad)return;var keys=[["1",""],["2","ABC"],["3","DEF"],["4","GHI"],["5","JKL"],["6","MNO"],["7","PQRS"],["8","TUV"],["9","WXYZ"],["*",""],["0","+"],["#",""]];var html="";keys.forEach(function(k){html+='<button class="dial-key" onclick="dialPress(\''+k[0]+'\')"><span>'+k[0]+'</span><span class="sub">'+k[1]+'</span></button>'});pad.innerHTML=html;syncDialerSoftphoneStatus()}
function openDialer(){document.getElementById("dialerOverlay").classList.add("show");initDialerPad();if(!dialerNumber){var ds=document.getElementById("dialSearch");if(ds)ds.value=""}updateDialDisplay();var st=document.getElementById("dialStatus");if(st)st.textContent="";document.addEventListener("keydown",dialerKeyHandler)}
function openDialerWithNumber(phone,name){dialerNumber=phone||"";dialerContactName=name||"";openDialer();var ds=document.getElementById("dialSearch");if(ds&&phone)ds.value=(name?name+" ‚Äî ":"")+phone;updateDialDisplay()}
function closeDialer(){document.getElementById("dialerOverlay").classList.remove("show");var smsArea=document.getElementById("dialSmsArea");if(smsArea)smsArea.classList.remove("show");dialerNumber="";dialerContactName="";var ds=document.getElementById("dialSearch");if(ds)ds.value="";document.removeEventListener("keydown",dialerKeyHandler)}
function dialerKeyHandler(e){var tag=(e.target||{}).tagName;if(tag==="INPUT"||tag==="TEXTAREA")return;if(e.key>="0"&&e.key<="9"){dialPress(e.key)}else if(e.key==="*"){dialPress("*")}else if(e.key==="#"){dialPress("#")}else if(e.key==="Backspace"){e.preventDefault();dialDelete()}else if(e.key==="Enter"){dialCall()}else if(e.key==="Escape"){closeDialer()}}
function dialSearchOrNumber(val){val=(val||"").trim();var digitsOnly=val.replace(/[^0-9+]/g,"");if(digitsOnly.length>=4&&digitsOnly.length/val.length>0.7){dialerNumber=val.replace(/[\s\-()]/g,"");dialerContactName=findContactName(dialerNumber);if(dialerContactName==="Unknown")dialerContactName="";updateDialDisplay();document.getElementById("dialResults").classList.remove("show")}else if(val.length>=1){dialSearchContacts(val)}else{dialerNumber="";dialerContactName="";updateDialDisplay();document.getElementById("dialResults").classList.remove("show")}}
function dialSearchContacts(val){var results=document.getElementById("dialResults");if(!val||val.length<1){results.classList.remove("show");return}var q=val.toLowerCase();var matches=contacts.filter(function(c){return(c.name||"").toLowerCase().indexOf(q)>=0||(c.phone||"").indexOf(q)>=0}).slice(0,8);var pMatches=participants.filter(function(p){return(p.name||"").toLowerCase().indexOf(q)>=0}).slice(0,5);if(matches.length===0&&pMatches.length===0){results.classList.remove("show");return}var html="";matches.forEach(function(c){html+='<div class="dialer-result-item" onclick="dialSelectContact(\''+((c.phone||"").replace(/'/g,""))+'\',\''+(c.name||"").replace(/'/g,"")+'\')">';html+='<div><div class="dialer-result-name">'+(c.name||"Unknown")+'</div><div class="dialer-result-phone">'+(c.phone||"")+'</div></div></div>'});pMatches.forEach(function(p){var ph=p.phone||p.mobile||"";if(!ph)return;html+='<div class="dialer-result-item" onclick="dialSelectContact(\''+ph.replace(/'/g,"")+'\',\''+p.name.replace(/'/g,"")+'\')">';html+='<div><div class="dialer-result-name">'+p.name+'</div><div class="dialer-result-phone">'+ph+' (roster)</div></div></div>'});results.innerHTML=html;results.classList.add("show")}
function dialSelectContact(phone,name){dialerNumber=phone;dialerContactName=name;document.getElementById("dialSearch").value=name+" ‚Äî "+phone;document.getElementById("dialResults").classList.remove("show");updateDialDisplay()}
function dialPress(key){dialerNumber+=key;dialerContactName=findContactName(dialerNumber);if(dialerContactName==="Unknown")dialerContactName="";updateDialDisplay()}
function dialDelete(){dialerNumber=dialerNumber.slice(0,-1);if(!dialerNumber)dialerContactName="";else{dialerContactName=findContactName(dialerNumber);if(dialerContactName==="Unknown")dialerContactName="";}updateDialDisplay()}
function updateDialDisplay(){var display=document.getElementById("dialDisplay");if(!display)return;var html="";if(dialerContactName)html+='<span class="contact-label">'+dialerContactName+'</span>';html+='<span>'+(dialerNumber||"Enter number")+'</span>';display.innerHTML=html}
function dialCall(){if(!dialerNumber||dialerNumber.length<4){document.getElementById("dialStatus").textContent="Enter a valid number";return}if(!twilioDevice){document.getElementById("dialStatus").textContent="‚ö†Ô∏è Softphone not ready ‚Äî please wait a moment";return}document.getElementById("dialStatus").textContent="Connecting...";twilioDevice.connect({params:{To:dialerNumber,ContactName:dialerContactName||""}}).then(function(call){twilioConnection=call;updateSoftphoneStatus("active");document.getElementById("dialStatus").textContent="üìû On call with "+(dialerContactName||dialerNumber);var btn=document.getElementById("dialCallBtn");if(btn){btn.style.background="var(--red)";btn.title="Hang up";btn.onclick=function(){dialHangup()}}if(dialerContactName){var _mc=contacts.find(function(c){var cp=(c.phone||"").replace(/\D/g,"");var dn=(dialerNumber||"").replace(/\D/g,"");return cp&&dn&&(cp===dn||cp.slice(-9)===dn.slice(-9))});if(_mc){selectedConv=_mc;currentView="contacts";render()}}call.on("disconnect",function(){twilioConnection=null;updateSoftphoneStatus("ready");document.getElementById("dialStatus").textContent="Call ended";resetDialCallBtn();setTimeout(function(){loadData()},2000)});call.on("cancel",function(){twilioConnection=null;updateSoftphoneStatus("ready");document.getElementById("dialStatus").textContent="Call cancelled";resetDialCallBtn()});call.on("reject",function(){twilioConnection=null;updateSoftphoneStatus("ready");document.getElementById("dialStatus").textContent="Call rejected";resetDialCallBtn()})}).catch(function(e){document.getElementById("dialStatus").textContent="Call failed: "+e.message})}
function dialHangup(){if(twilioConnection){twilioConnection.disconnect()}else if(twilioDevice){twilioDevice.disconnectAll()}twilioConnection=null;updateSoftphoneStatus("ready");document.getElementById("dialStatus").textContent="Call ended";resetDialCallBtn()}
function resetDialCallBtn(){var btn=document.getElementById("dialCallBtn");if(!btn)return;btn.style.background="var(--green)";btn.title="Call";btn.onclick=function(){dialCall()}}
function dialToggleSms(){closeDialer();openSmsComposer(dialerNumber||"",dialerContactName||"")}
function dialSendSms(){if(!dialerNumber||dialerNumber.length<4){document.getElementById("dialStatus").textContent="Enter a valid number";return}var body=(document.getElementById("dialSmsBody").value||"").trim();if(!body){document.getElementById("dialStatus").textContent="Type a message first";return}document.getElementById("dialStatus").textContent="Sending SMS...";apiCall("POST","/api/sms/send",{to:dialerNumber,body:body,participant:dialerContactName}).then(function(d){if(d.error){document.getElementById("dialStatus").textContent="Error: "+d.error}else{document.getElementById("dialStatus").textContent="SMS sent!";document.getElementById("dialSmsBody").value="";document.getElementById("dialSmsArea").classList.remove("show");setTimeout(function(){loadData()},1500)}}).catch(function(e){document.getElementById("dialStatus").textContent="SMS failed: "+e.message})}
document.addEventListener("click",function(e){var results=document.getElementById("dialResults");if(results&&!e.target.closest(".dialer-search"))results.classList.remove("show");var cfw=document.getElementById("contactFilterWrap");var cfd=document.getElementById("contactFilterDD");if(cfd&&cfw&&!cfw.contains(e.target))cfd.style.display="none"});
document.addEventListener("click",function(e){if(e.target.id==="dialerOverlay")closeDialer()});
document.addEventListener("keydown",function(e){if(e.key==="Escape")closeDialer()});
/* ‚îÄ‚îÄ‚îÄ SMS COMPOSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
var smsRecipients=[];var smsAttachments=[];var smsMode="sms";
function openSmsComposer(prePhone,preName){document.getElementById("smsOverlay").classList.add("show");smsRecipients=[];smsAttachments=[];smsMode="sms";setSmsType("sms");document.getElementById("smsBodyInput").value="";document.getElementById("smsToInput").value="";smsUpdateCharCount();renderSmsRecipients();document.getElementById("smsSendStatus").textContent="";document.getElementById("smsSendProgress").classList.remove("show");if(prePhone){smsAddRecipient(prePhone,preName||findContactName(prePhone));renderSmsRecipients()}setTimeout(function(){document.getElementById("smsToInput").focus()},200)}
function closeSmsComposer(){document.getElementById("smsOverlay").classList.remove("show");document.getElementById("smsContactDropdown").classList.remove("show")}
document.addEventListener("click",function(e){if(e.target.id==="smsOverlay")closeSmsComposer()});
document.addEventListener("click",function(e){var dd=document.getElementById("smsContactDropdown");if(dd&&dd.classList.contains("show")&&!e.target.closest(".sms-to-section"))dd.classList.remove("show")});
document.addEventListener("keydown",function(e){if(e.key==="Escape"&&document.getElementById("smsOverlay").classList.contains("show"))closeSmsComposer()});
function setSmsType(type){smsMode=type;document.getElementById("smsTypeSms").classList.toggle("on",type==="sms");document.getElementById("smsTypeMms").classList.toggle("on",type==="mms");document.getElementById("smsAttachSection").style.display=type==="mms"?"block":"none";document.getElementById("smsToolbar").style.display=type==="mms"?"flex":"none";document.getElementById("smsMmsNote").style.display=type==="mms"?"block":"none";smsUpdateCharCount()}
function smsAddRecipient(phone,name){phone=phone.replace(/[^+0-9]/g,"");if(!phone)return;if(smsRecipients.some(function(r){return r.phone===phone}))return;smsRecipients.push({phone:phone,name:name||"Unknown"});renderSmsRecipients()}
function smsRemoveRecipient(phone){smsRecipients=smsRecipients.filter(function(r){return r.phone!==phone});renderSmsRecipients()}
function renderSmsRecipients(){var container=document.getElementById("smsRecipientTags");var summary=document.getElementById("smsRecipientSummary");var html="";smsRecipients.forEach(function(r){html+='<span class="sms-recipient-tag">'+r.name+' <span class="remove" onclick="event.stopPropagation();smsRemoveRecipient(\''+r.phone+'\')">&times;</span></span>'});container.innerHTML=html;document.getElementById("smsSendBtn").disabled=false;if(smsRecipients.length>0){summary.style.display="flex";document.getElementById("smsRecipientNum").textContent=smsRecipients.length}else{summary.style.display="none"}var ddCount=document.getElementById("smsDropdownCount");if(ddCount)ddCount.textContent=smsRecipients.length+" selected"}
function smsSearchRecipients(val){var dd=document.getElementById("smsContactDropdown");var list=document.getElementById("smsContactList");if(!val&&contacts.length===0){dd.classList.remove("show");return}var q=(val||"").toLowerCase();var merged=[];contacts.forEach(function(c){if(!c.phone)return;if(q&&(c.name||"").toLowerCase().indexOf(q)<0&&(c.phone||"").indexOf(q)<0&&(c.email||"").toLowerCase().indexOf(q)<0&&(c.contactType||"").toLowerCase().indexOf(q)<0)return;merged.push({name:c.name||"Unknown",phone:c.phone,type:c.contactType||""})});if(merged.length===0&&!val){dd.classList.remove("show");return}var html="";merged.slice(0,20).forEach(function(c){var isSelected=smsRecipients.some(function(r){return r.phone===c.phone});html+='<div class="sms-contact-item" onclick="smsToggleRecipient(\''+c.phone.replace(/'/g,"")+'\',\''+c.name.replace(/'/g,"")+'\')">';html+='<div class="sms-contact-check'+(isSelected?" on":"")+'">'+(isSelected?"‚úì":"")+'</div>';html+='<div class="sms-contact-info"><div class="sms-contact-name">'+c.name+(c.type?' <span style="font-size:9px;opacity:.6;font-weight:400">'+c.type+'</span>':'')+'</div><div class="sms-contact-phone">'+c.phone+'</div></div></div>'});list.innerHTML=html;dd.classList.add("show");var ddCount=document.getElementById("smsDropdownCount");if(ddCount)ddCount.textContent=smsRecipients.length+" selected"}
function smsCloseDropdown(){document.getElementById("smsContactDropdown").classList.remove("show");document.getElementById("smsToInput").value="";document.getElementById("smsBodyInput").focus()}
function smsToggleRecipient(phone,name){var exists=smsRecipients.some(function(r){return r.phone===phone});if(exists)smsRemoveRecipient(phone);else smsAddRecipient(phone,name);smsSearchRecipients(document.getElementById("smsToInput").value)}
function smsSelectAll(){var merged=[];contacts.forEach(function(c){if(c.phone)merged.push({name:c.name||"Unknown",phone:c.phone})});var allSelected=merged.every(function(c){return smsRecipients.some(function(r){return r.phone===c.phone})});if(allSelected){smsRecipients=[];renderSmsRecipients()}else{merged.forEach(function(c){if(!smsRecipients.some(function(r){return r.phone===c.phone}))smsRecipients.push(c)});renderSmsRecipients()}smsSearchRecipients(document.getElementById("smsToInput").value)}
function smsInputKeydown(e){if(e.key==="Enter"){e.preventDefault();var val=document.getElementById("smsToInput").value.trim();if(val&&val.match(/^[+0-9\s\-()]{8,}$/)){smsAddRecipient(val.replace(/[\s\-()]/g,""),"Manual: "+val);document.getElementById("smsToInput").value="";renderSmsRecipients();document.getElementById("smsContactDropdown").classList.remove("show")}}}
function smsUpdateCharCount(){var body=document.getElementById("smsBodyInput").value;var len=body.length;var segments=Math.ceil(len/160)||1;var el=document.getElementById("smsCharCount");if(smsMode==="mms"){el.textContent=len+" characters (MMS - no segment limit)";el.className=""}else{el.textContent=len+" / 160 characters ("+segments+" segment"+(segments>1?"s":"")+")";el.className=len>160?"sms-char-warn":""}}
function smsFmt(cmd){var ta=document.getElementById("smsBodyInput");var start=ta.selectionStart;var end=ta.selectionEnd;var sel=ta.value.substring(start,end);if(!sel)return;var wrap={bold:["*","*"],italic:["_","_"],underline:["~","~"]};if(!wrap[cmd])return;ta.value=ta.value.substring(0,start)+wrap[cmd][0]+sel+wrap[cmd][1]+ta.value.substring(end);ta.focus();ta.setSelectionRange(start,end+wrap[cmd][0].length+wrap[cmd][1].length);smsUpdateCharCount()}
function smsInsertEmoji(){var emojis=["üëç","‚úÖ","‚ù§Ô∏è","üôè","üìû","üè•","üöó","‚è∞","üìã","üòä","üëã","üéâ"];var pick=prompt("Pick an emoji or paste one:\\n\\n"+emojis.join("  "));if(pick){var ta=document.getElementById("smsBodyInput");var pos=ta.selectionStart;ta.value=ta.value.substring(0,pos)+pick+ta.value.substring(pos);ta.focus();smsUpdateCharCount()}}
function smsInsertTemplate(){var templates=["Hi [name], this is Delta Community Support. Just a reminder about your appointment tomorrow.","Hi [name], your support worker is running approximately [X] minutes late. Apologies for the inconvenience.","Hi [name], this is a courtesy call from Delta Community Support. Please call us back at your earliest convenience.","Hi [name], we have an update regarding your NDIS plan. Please contact us to discuss."];var choice=prompt("Choose a template (1-"+templates.length+"):\\n\\n"+templates.map(function(t,i){return(i+1)+". "+t}).join("\\n\\n"));if(choice){var idx=parseInt(choice)-1;if(idx>=0&&idx<templates.length){document.getElementById("smsBodyInput").value=templates[idx];smsUpdateCharCount()}}}
function smsHandleAttachment(input){var files=input.files;if(!files||files.length===0)return;for(var i=0;i<files.length;i++){var file=files[i];if(file.size>5242880){alert(file.name+" is too large (max 5MB)");continue}if(smsAttachments.length>=3){alert("Maximum 3 attachments");break}var reader=new FileReader();reader.onload=(function(f){return function(e){smsAttachments.push({name:f.name,size:f.size,type:f.type,data:e.target.result});renderSmsAttachments()}})(file);reader.readAsDataURL(file)}input.value=""}
function renderSmsAttachments(){var container=document.getElementById("smsAttachPreview");if(smsAttachments.length===0){container.innerHTML="";return}var html="";smsAttachments.forEach(function(a,i){html+='<div class="sms-attach-item">';if(a.type.startsWith("image/"))html+='<img src="'+a.data+'" alt="'+a.name+'">';html+='<span>'+a.name+' ('+(a.size/1024).toFixed(1)+'KB)</span>';html+='<span class="remove" onclick="smsRemoveAttachment('+i+')">&times;</span></div>'});container.innerHTML=html}
function smsRemoveAttachment(idx){smsAttachments.splice(idx,1);renderSmsAttachments()}
function smsSendAll(){var body=document.getElementById("smsBodyInput").value.trim();if(!body){document.getElementById("smsSendStatus").textContent="Please type a message";return}if(smsRecipients.length===0){document.getElementById("smsSendStatus").textContent="Add at least one recipient";return}var total=smsRecipients.length;var sent=0;var failed=0;document.getElementById("smsSendBtn").disabled=true;document.getElementById("smsSendProgress").classList.add("show");document.getElementById("smsSendProgressFill").style.width="0%";document.getElementById("smsSendProgressText").textContent="Sending 0 / "+total;document.getElementById("smsSendStatus").textContent="Sending to "+total+" recipient"+(total>1?"s":"")+"...";var mediaUrls=smsAttachments.map(function(a){return a.data});function sendNext(idx){if(idx>=total){document.getElementById("smsSendBtn").disabled=false;document.getElementById("smsSendStatus").textContent="Done! "+sent+" sent"+(failed>0?", "+failed+" failed":"");if(sent>0)setTimeout(function(){loadData()},2000);return}var r=smsRecipients[idx];var payload={to:r.phone,body:body,participant:r.name};if(smsMode==="mms"&&mediaUrls.length>0)payload.mediaUrls=mediaUrls;apiCall("POST","/api/sms/send",payload).then(function(d){if(d.error){failed++;document.getElementById("smsSendStatus").textContent="Failed: "+r.name+" - "+d.error}else{sent++}}).catch(function(){failed++}).finally(function(){var pct=Math.round(((idx+1)/total)*100);document.getElementById("smsSendProgressFill").style.width=pct+"%";document.getElementById("smsSendProgressText").textContent="Sent "+(idx+1)+" / "+total;setTimeout(function(){sendNext(idx+1)},800)})}sendNext(0)}
function renderAIAgent(){var rp=document.getElementById("rightPanel");var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar" style="background:linear-gradient(135deg,var(--teal),var(--royal))">AI</div><div><div class="rp-hdr-name">ü§ñ Denise AI Agent</div><div class="rp-hdr-sub">Participant knowledge base & policies</div></div></div></div>';html+='<div class="ai-messages" id="aiMessages"><div class="ai-msg bot">G\'day! I\'m Denise, your DCS AI Agent.\n\nAsk me about participants, policies, procedures, or SCHADS compliance.\n\nTry: "What\'s Aden\'s km allowance?"\nOr: "Emergency contact for Brett"</div></div>';html+='<div class="ai-compose"><input id="aiInput" placeholder="Ask Denise..." onkeydown="if(event.key===\'Enter\')sendAi()"><button onclick="sendAi()">Send</button></div>';rp.innerHTML=html}
function renderTranscripts(){var rp=document.getElementById("rightPanel");var transcribed=calls.filter(function(c){return c.transcript});var allCalls=calls.filter(function(c){return c.status==="completed"&&c.duration>0});var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar" style="background:var(--surface2);color:var(--muted);border:1px solid var(--border)">\u{1F4DD}</div><div><div class="rp-hdr-name">Transcripts</div><div class="rp-hdr-sub">'+transcribed.length+' of '+allCalls.length+' calls transcribed</div></div></div><div class="rp-hdr-actions"><button class="btn btn-teal" onclick="syncTranscripts()">Sync Transcripts</button></div></div>';html+='<div style="flex:1;overflow-y:auto;padding:0">';if(transcribed.length===0){html+='<div class="empty-state" style="padding:40px"><p>No transcripts yet.</p><p style="margin-top:8px;font-size:12px">Click <strong>Sync Transcripts</strong> above to fetch from Twilio &amp; ElevenLabs.</p></div>'}else{transcribed.forEach(function(c){html+='<div class="transcript-card"><div class="transcript-hdr"><span class="transcript-name">'+(c.participant||findContactName(c.type==="inbound"?c.from_number:c.to_number)||"Unknown")+'</span><span class="transcript-time">'+fmtTime(c.created_at)+' \u2022 '+(c.duration||0)+'s \u2022 '+(c.type||"")+'</span></div>';if(c.summary)html+='<div class="transcript-summary"><strong style="font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--teal)">AI Summary</strong><br>'+c.summary+'</div>';html+='<div class="transcript-body">'+c.transcript+'</div></div>'})}html+='<div onclick="window._reportsSubView=\'receipts\';renderReportsMenu()" style="padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px;margin-top:12px" onmouseover="this.style.borderColor=\'#f59e0b\';this.style.boxShadow=\'0 4px 12px rgba(245,158,11,.1)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'none\'">';
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(251,191,36,.1));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üßæ</div>';
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">Receipts Register</div><div style="font-size:12px;color:var(--muted);line-height:1.5">Track all business receipts. Use the mobile-friendly form link to photograph receipts ‚Äî AI automatically scans and extracts all fields.</div></div>';
html+='<div style="font-size:20px;color:var(--muted);flex-shrink:0">‚Üí</div></div>';
html+='</div>';rp.innerHTML=html}
function syncTranscripts(){apiCall("POST","/api/transcripts/bulk-fetch",{}).then(function(d){alert("Bulk transcript fetch started! Checking "+((d&&d.total)||"all")+" calls against ElevenLabs & Twilio. Results will appear in ~10 seconds.");setTimeout(function(){loadData()},10000)}).catch(function(){alert("Sync failed - check server logs")})}
function fetchCallTranscript(sid,callId){var btn=document.getElementById("fetch"+callId);if(btn){btn.innerHTML="‚è≥ Fetching from Twilio & ElevenLabs...";btn.style.pointerEvents="none";btn.style.background="var(--tealLight)";btn.style.color="var(--teal)";btn.style.borderColor="var(--tealBorder)"}apiCall("POST","/api/transcripts/fetch/"+sid,{}).then(function(d){if(d.already&&d.transcript){if(btn){btn.innerHTML="‚úÖ Transcript found!";btn.style.background="var(--greenBg)";btn.style.color="var(--green)";btn.style.borderColor="var(--greenBorder)"}setTimeout(function(){loadData()},1000);return}if(btn){btn.innerHTML="‚è≥ Searching ElevenLabs conversations..."}setTimeout(function(){apiCall("GET","/api/calls").then(function(data){var found=data.find(function(c){return c.sid===sid});if(found&&found.transcript){calls=data;buildConversations();render()}else{if(btn){btn=document.getElementById("fetch"+callId);if(btn){btn.innerHTML="‚è≥ Processing... click again in 30s";btn.style.pointerEvents="auto";btn.onclick=function(){fetchCallTranscript(sid,callId)}}}}})},8000)}).catch(function(){if(btn){btn.innerHTML="‚ùå Fetch failed ‚Äî click to retry";btn.style.pointerEvents="auto";btn.style.background="rgba(239,68,68,.06)";btn.style.color="var(--red)";btn.onclick=function(){fetchCallTranscript(sid,callId)}}})}
// Listen for real-time transcript arrivals and update UI without full re-render
socket.on("call:transcribed",function(d){calls=calls.map(function(c){return c.sid===d.sid?Object.assign({},c,{transcript:d.transcript}):c});var callObj=calls.find(function(c){return c.sid===d.sid});if(callObj){var btn=document.getElementById("fetch"+callObj.id);if(btn){btn.innerHTML="‚úÖ Transcript received!";btn.style.background="var(--greenBg)";btn.style.color="var(--green)";btn.style.borderColor="var(--greenBorder)";btn.style.pointerEvents="none";setTimeout(function(){buildConversations();render()},1500)}}if(currentView==="transcripts")renderTranscripts()});
var reportCharts={};
function renderReportsMenu(){var rp=document.getElementById("rightPanel");var reportView=window._reportsSubView||"menu";
if(reportView==="opsReport"){renderOpsReport();return}
if(reportView==="stakeholderReport"){renderStakeholderReport();return}
if(reportView==="auditLog"){renderAuditLog();return}
if(reportView==="receipts"){renderReceipts();return}
if(reportView==="files"){renderCompanyFiles();return}
if(reportView==="ndisReports"){renderNdisReportsList();return}
if(reportView==="customReport"){renderCustomReport();return}
if(reportView==="customReport"){renderCustomReport();return}
var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar" style="background:linear-gradient(135deg,var(--teal),var(--royal))">üìä</div><div><div class="rp-hdr-name">Reports</div><div class="rp-hdr-sub">Generate internal reports</div></div></div></div>';
html+='<div style="padding:24px;max-width:800px">';
html+='<div onclick="window._reportsSubView=\'opsReport\';renderReportsMenu()" style="padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.boxShadow=\'0 4px 12px rgba(10,147,150,.1)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'none\'">';
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(10,147,150,.1),rgba(30,75,160,.1));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìã</div>';
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">Operations Report</div><div style="font-size:12px;color:var(--muted);line-height:1.5">Generate a comprehensive internal ops report. Scans Progress Notes, Incident Reports, Contact History, Sleep Disturbances, Risks & Concerns, Expiry Dates, Schedule of Support, PBSP and Handover data.</div></div>';
html+='<div style="font-size:20px;color:var(--muted);flex-shrink:0">‚Üí</div></div>';
// Stakeholder Report card
html+='<div onclick="window._reportsSubView=\'stakeholderReport\';renderReportsMenu()" style="padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px;margin-top:12px" onmouseover="this.style.borderColor=\'var(--royal)\';this.style.boxShadow=\'0 4px 12px rgba(30,75,160,.1)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'none\'">';
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(30,75,160,.1),rgba(124,58,237,.1));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìë</div>';
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">NDIS Stakeholder Report</div><div style="font-size:12px;color:var(--muted);line-height:1.5">Weekly update for stakeholders ‚Äî families, support coordinators & NDIS planners. Goal progress, service delivery evidence, photos and incident summaries per client.</div></div>';
html+='<div style="font-size:20px;color:var(--muted);flex-shrink:0">‚Üí</div></div>';
html+='<div onclick="window._reportsSubView=\'auditLog\';renderReportsMenu()" style="padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px;margin-top:12px" onmouseover="this.style.borderColor=\'#6366f1\';this.style.boxShadow=\'0 4px 12px rgba(99,102,241,.1)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'none\'">';
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(124,58,237,.1));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üîç</div>';
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">Audit Log</div><div style="font-size:12px;color:var(--muted);line-height:1.5">Track every change made in Titus ‚Äî who edited what, when, and what the values were. Filter by user, date range, entity type or search keyword.</div></div>';
html+='<div style="font-size:20px;color:var(--muted);flex-shrink:0">‚Üí</div></div>';
html+='<div onclick="window._reportsSubView=\'ndisReports\';renderReportsMenu()" style="padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px;margin-top:12px" onmouseover="this.style.borderColor=\'#7c3aed\';this.style.boxShadow=\'0 4px 12px rgba(124,58,237,.1)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'none\'">'
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(124,58,237,.1),rgba(30,75,160,.1));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìë</div>'
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">NDIS Reports Archive</div><div style="font-size:12px;color:var(--muted);line-height:1.5">View all generated NDIS Stakeholder Reports. Filter by client, date range and reporting period.</div></div>'
html+='<div style="font-size:20px;color:var(--muted);flex-shrink:0">‚Üí</div></div>';
html+='<div onclick="window._reportsSubView=\'customReport\';renderReportsMenu()" style="padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:16px;margin-top:12px" onmouseover="this.style.borderColor=\'#0d9488\';this.style.boxShadow=\'0 4px 12px rgba(13,148,136,.1)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'none\'">';
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(13,148,136,.1),rgba(16,185,129,.1));display:flex;align-items:center;justify-content:font-size:24px;flex-shrink:0;align-items:center;justify-content:center">üìä</div>';
html+='<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,rgba(13,148,136,.12),rgba(16,185,129,.1));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0">üìä</div>';
html+='<div><div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:4px">Customised Client Report</div><div style="font-size:12px;color:var(--muted);line-height:1.5">Choose a date range, select clients, and pick any combination of data tables ‚Äî Clients, Progress Notes, Incidents, Budgets, Sleep Charts, Bowel Charts, Fluid Intake, Behaviours and more.</div></div>';
html+='<div style="font-size:20px;color:var(--muted);flex-shrink:0">‚Üí</div></div>';
html+='</div>';rp.innerHTML=html}

function renderCustomReport(){
  var rp=document.getElementById("rightPanel");
  var TABLES=[
    "Clients","Client Docs","Client Core Budgets","Complaints Register","Client Calendar",
    "Progress Notes","SIL Site Visits","Approved / Excluded Workers 2025","Risk Register",
    "Internal Audit","Tasks","SIL Induction Register","Client Contact Preferences",
    "Client Sleep Chart","IR Reports 2025","Bowel Chart","Support Plan 2025",
    "Fluid Intake Diary","QR Code Data - Behaviours","Client SA & SOS","Conversations SMS & Calls","PBSP"
  ];
  var today=new Date().toISOString().split("T")[0];
  var monthAgo=new Date(Date.now()-30*86400000).toISOString().split("T")[0];
  // Pre-fetch company details
  if(!window._crCompany){
    apiCall("GET","/api/company-details").then(function(d){window._crCompany=d||{};}).catch(function(){window._crCompany={};});
  }
  var html='<div class="rp-hdr"><div class="rp-hdr-info"><div style="cursor:pointer;padding:6px 10px;border-radius:var(--rs);font-size:12px;font-weight:600;color:var(--muted);border:1px solid var(--border);margin-right:8px" onclick="window._reportsSubView=\'menu\';renderReportsMenu()">‚Üê Back</div><div><div class="rp-hdr-name">üìä Customised Client Report</div><div class="rp-hdr-sub">Select clients, date range and data tables</div></div></div></div>';
  html+='<div style="padding:20px;max-width:900px;overflow-y:auto">';
  // Date range
  html+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px">';
  html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px">üìÖ Date Range</div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  html+='<div><label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">FROM</label><input type="date" id="crFrom" value="'+monthAgo+'" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box;background:var(--surface)"></div>';
  html+='<div><label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">TO</label><input type="date" id="crTo" value="'+today+'" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box;background:var(--surface)"></div>';
  html+='</div></div>';
  // Client selector
  html+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px">';
  html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">';
  html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px">üë§ Clients</div>';
  html+='<div style="display:flex;gap:8px"><button onclick="crSelectAllClients()" style="font-size:10px;padding:3px 10px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.2);border-radius:6px;cursor:pointer;font-family:inherit;font-weight:600">All</button><button onclick="crClearClients()" style="font-size:10px;padding:3px 10px;background:var(--surface2);color:var(--muted);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-family:inherit">Clear</button></div>';
  html+='</div>';
  // ‚îÄ‚îÄ Report Type Section
  html+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px">';
  html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:12px">üìã Report Type & Audience</div>';
  html+='<div style="margin-bottom:12px"><label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:6px">WHO IS THIS REPORT FOR?</label>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="crAudienceGrid">';
  var audiences=[
    {key:"stakeholder",label:"üìä Stakeholder Progress Report",sub:"NDIA ¬∑ Plan Manager ¬∑ Support Coordinator",color:"#0a9396"},
    {key:"guardian",label:"‚öñÔ∏è Public Guardian Report",sub:"Office of the Public Guardian (QLD)",color:"#6366f1"},
    {key:"behaviour",label:"üß† Behaviour Support Report",sub:"NDIS Quality & Safeguards Commission",color:"#f59e0b"},
    {key:"mentalhealth",label:"üè• Mental Health Nurse Report",sub:"Treating Team ¬∑ NDIA ¬∑ Support Coordinator",color:"#10b981"},
    {key:"internal",label:"üè¢ Internal Operations Report",sub:"DCS Management ¬∑ Internal Use Only",color:"#1E4BA0"},
    {key:"family",label:"üë®‚Äçüë©‚Äçüëß Family / Carer Update",sub:"Families ¬∑ Informal Support Network",color:"#8b5cf6"}
  ];
  audiences.forEach(function(a){
    html+='<label id="crAudienceLabel_'+a.key+'" style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s;background:var(--surface)" data-key=""+a.key+"" onclick="crSelectAudience(this.dataset.key)">';
    html+='<input type="radio" name="crAudience" value="'+a.key+'" id="crAudience_'+a.key+'" style="margin-top:2px;accent-color:'+a.color+'">';
    html+='<div><div style="font-size:12px;font-weight:700;color:var(--text)">'+a.label+'</div>';
    html+='<div style="font-size:10px;color:var(--muted);margin-top:2px">'+a.sub+'</div></div>';
    html+='</label>';
  });
  html+='</div></div>';
  // Recipient details
  html+='<div><label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">RECIPIENT NAME / ORGANISATION <span style="font-weight:400;opacity:.6">(optional)</span></label>';
  html+='<input type="text" id="crRecipient" placeholder="e.g. Jane Smith ‚Äî NDIA Brisbane, or Office of the Public Guardian QLD" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;box-sizing:border-box;background:var(--surface)">';
  html+='</div></div>';

  html+='<div id="crClientSearch" style="margin-bottom:10px"><input id="crClientSearchInput" placeholder="Search clients..." oninput="crFilterClients(this.value)" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;box-sizing:border-box;background:var(--surface)"></div>';
  html+='<div id="crClientList" style="max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--rs)">';
  if(clientsList&&clientsList.length>0){
    clientsList.forEach(function(c,i){
      html+='<label style="display:flex;align-items:center;gap:8px;padding:7px 10px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border);transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'\'">';
      html+='<input type="checkbox" class="cr-client-cb" data-name="'+c.name.replace(/"/g,"&quot;")+'" data-id="'+(c.airtable_id||"")+'"> ';
      html+='<span style="font-weight:600">'+c.name+'</span>';
      if(c.silOrCas)html+='<span style="font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.15);margin-left:auto">'+c.silOrCas+'</span>';
      html+='</label>';
    });
  }else{
    html+='<div style="padding:12px;text-align:center;font-size:12px;color:var(--muted)">Loading clients... (Airtable may be syncing)</div>';
  }
  html+='</div>';
  html+='<div id="crClientCount" style="font-size:11px;color:var(--muted);margin-top:6px">0 clients selected</div>';
  html+='</div>';
  // Table selector
  html+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;margin-bottom:16px">';
  html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">';
  html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px">üìã Data Tables</div>';
  html+='<div style="display:flex;gap:8px"><button onclick="crSelectAllTables()" style="font-size:10px;padding:3px 10px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.2);border-radius:6px;cursor:pointer;font-family:inherit;font-weight:600">All</button><button onclick="crClearTables()" style="font-size:10px;padding:3px 10px;background:var(--surface2);color:var(--muted);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-family:inherit">Clear</button></div>';
  html+='</div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">';
  TABLES.forEach(function(t){
    var ico=t==="Progress Notes"?"üìì":t==="IR Reports 2025"?"‚ö†Ô∏è":t==="Clients"?"üë§":t==="Client Docs"?"üìÑ":t==="Bowel Chart"?"üíä":t==="Fluid Intake Diary"?"üíß":t==="Client Sleep Chart"?"üò¥":t==="Risk Register"?"‚ö°":t==="Tasks"?"‚úÖ":t==="QR Code Data - Behaviours"?"üîç":t==="Conversations SMS & Calls"?"üí¨":t==="PBSP"?"üß†":"üìã";
    html+='<label style="display:flex;align-items:center;gap:6px;padding:6px 8px;cursor:pointer;font-size:11px;border-radius:6px;transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'\'">';
    html+='<input type="checkbox" class="cr-table-cb" data-table="'+t+'"'+(['Progress Notes','IR Reports 2025','Risk Register','PBSP'].indexOf(t)>=0?' checked':'')+'>  '+ico+' '+t;
    html+='</label>';
  });
  html+='</div></div>';
  // Generate button
  html+='<button onclick="crGenerate()" style="width:100%;padding:14px;background:linear-gradient(135deg,#0a9396,#1E4BA0);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;letter-spacing:.2px">üìä Generate Report</button>';
  html+='<div id="crStatus" style="margin-top:12px;text-align:center;font-size:12px;color:var(--muted)"></div>';
  html+='<div id="crResult" style="margin-top:20px"></div>';
  html+='</div>';
  rp.innerHTML=html;
  // Update client count on checkbox change
  rp.addEventListener("change",function(e){
    if(e.target.classList.contains("cr-client-cb")||e.target.classList.contains("cr-table-cb")){
      var cnt=rp.querySelectorAll(".cr-client-cb:checked").length;
      var el=document.getElementById("crClientCount");
      if(el)el.textContent=cnt+" client"+(cnt!==1?"s":"")+" selected";
    }
  });
}

function crSelectAudience(key){
  var audiences=["stakeholder","guardian","behaviour","mentalhealth","internal","family"];
  var colors={"stakeholder":"#0a9396","guardian":"#6366f1","behaviour":"#f59e0b","mentalhealth":"#10b981","internal":"#1E4BA0","family":"#8b5cf6"};
  audiences.forEach(function(a){
    var lbl=document.getElementById("crAudienceLabel_"+a);
    var inp=document.getElementById("crAudience_"+a);
    if(!lbl||!inp)return;
    if(a===key){
      lbl.style.borderColor=colors[a];
      lbl.style.background=colors[a]+"0f";
      inp.checked=true;
    } else {
      lbl.style.borderColor="var(--border)";
      lbl.style.background="var(--surface)";
    }
  });
}

function crFilterClients(q){
  q=(q||"").toLowerCase();
  document.querySelectorAll(".cr-client-cb").forEach(function(cb){
    var label=cb.closest("label");
    if(!label)return;
    var name=cb.getAttribute("data-name")||"";
    label.style.display=(!q||name.toLowerCase().indexOf(q)>=0)?"":"none";
  });
}
function crSelectAllClients(){document.querySelectorAll(".cr-client-cb").forEach(function(cb){if(cb.closest("label").style.display!=="none")cb.checked=true});var cnt=document.querySelectorAll(".cr-client-cb:checked").length;var el=document.getElementById("crClientCount");if(el)el.textContent=cnt+" clients selected";}
function crClearClients(){document.querySelectorAll(".cr-client-cb").forEach(function(cb){cb.checked=false});var el=document.getElementById("crClientCount");if(el)el.textContent="0 clients selected";}
function crSelectAllTables(){document.querySelectorAll(".cr-table-cb").forEach(function(cb){cb.checked=true});}
function crClearTables(){document.querySelectorAll(".cr-table-cb").forEach(function(cb){cb.checked=false});}

function crGenerate(){
  var from=document.getElementById("crFrom").value;
  var to=document.getElementById("crTo").value;
  if(!from||!to){alert("Please select a date range");return}
  var clients=[];
  document.querySelectorAll(".cr-client-cb:checked").forEach(function(cb){clients.push({name:cb.getAttribute("data-name"),airtable_id:cb.getAttribute("data-id")})});
  var tables=[];
  document.querySelectorAll(".cr-table-cb:checked").forEach(function(cb){tables.push(cb.getAttribute("data-table"))});
  var audienceEl=document.querySelector("input[name='crAudience']:checked");
  var audience=audienceEl?audienceEl.value:"stakeholder";
  var recipient=(document.getElementById("crRecipient")||{}).value||"";
  if(!clients.length){alert("Please select at least one client");return}
  if(!tables.length){alert("Please select at least one table");return}
  // Show loading modal
  var loadOverlay=document.createElement("div");
  loadOverlay.id="crLoadOverlay";
  loadOverlay.style.cssText="position:fixed;inset:0;background:rgba(10,20,40,.7);z-index:9000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)";
  loadOverlay.innerHTML='<div style="background:#fff;border-radius:16px;padding:36px 48px;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.3);max-width:380px"><div style="font-size:48px;margin-bottom:16px">üìä</div><div style="font-size:17px;font-weight:800;color:#1a1a2e;margin-bottom:8px">Generating Report</div><div style="font-size:13px;color:#64748b;margin-bottom:20px">Fetching data from '+tables.length+' table(s)<br>for '+clients.length+' client(s)‚Ä¶</div><div style="width:100%;height:4px;background:#f1f5f9;border-radius:4px;overflow:hidden"><div id="crLoadBar" style="height:100%;width:0%;background:linear-gradient(90deg,#0a9396,#1E4BA0);border-radius:4px;transition:width .4s ease"></div></div><div id="crLoadMsg" style="font-size:11px;color:#94a3b8;margin-top:10px">Connecting to Airtable‚Ä¶</div></div>';
  document.body.appendChild(loadOverlay);
  var bar=document.getElementById("crLoadBar");
  var msg=document.getElementById("crLoadMsg");
  var prog=0;
  var ticker=setInterval(function(){prog=Math.min(prog+Math.random()*8,85);if(bar)bar.style.width=prog+"%";if(msg){var msgs=["Fetching Progress Notes‚Ä¶","Loading client records‚Ä¶","Scanning data tables‚Ä¶","Building report‚Ä¶","Almost done‚Ä¶"];msg.textContent=msgs[Math.floor(prog/20)]||"Processing‚Ä¶"}},400);
  apiCall("POST","/api/custom-report",{from:from,to:to,clients:clients,tables:tables,audience:audience,recipient:recipient}).then(function(data){
    clearInterval(ticker);
    var ol=document.getElementById("crLoadOverlay");if(ol)ol.remove();
    if(data.error){
      var status=document.getElementById("crStatus");
      if(status)status.innerHTML='<div style="padding:16px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:8px;color:#ef4444;font-size:13px">Error: '+data.error+'</div>';
      return;
    }
    data.audience=audience;data.recipient=recipient;crOpenPreviewModal(data);
  }).catch(function(e){
    clearInterval(ticker);
    var ol=document.getElementById("crLoadOverlay");if(ol)ol.remove();
    var status=document.getElementById("crStatus");
    if(status)status.innerHTML='<div style="padding:16px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:8px;color:#ef4444;font-size:13px">Request failed: '+e.message+'</div>';
  });
}

function crOpenPreviewModal(data){
  var ex=document.getElementById("crPreviewModal");if(ex)ex.remove();

  // ‚îÄ‚îÄ Simple progress bar loader ‚îÄ‚îÄ
  var modal=document.createElement("div");
  modal.id="crPreviewModal";
  modal.style.cssText="position:fixed;inset:0;background:rgba(10,20,40,.82);z-index:9500;display:flex;flex-direction:column;backdrop-filter:blur(6px)";

  var clientNames=(data.clients||[]).join(", ");
  var estSecs=Math.max(20,Math.min((data.clients||[]).length*20,90));

  modal.innerHTML='<div style="display:flex;align-items:center;justify-content:center;flex:1"><div style="background:#fff;border-radius:20px;padding:40px 48px;max-width:520px;width:100%;box-shadow:0 32px 80px rgba(0,0,0,.4)">'
    +'<div style="text-align:center;margin-bottom:28px">'
    +'<div style="font-size:48px;margin-bottom:12px">üìä</div>'
    +'<div style="font-size:20px;font-weight:900;color:#1a1a2e;margin-bottom:6px">Building Report</div>'
    +'<div style="font-size:12px;color:#64748b;margin-bottom:4px">'+esc(clientNames)+'</div>'
    +'<div id="crEstTime" style="font-size:11px;color:#94a3b8">Estimated time: ~'+estSecs+' seconds</div>'
    +'</div>'
    +'<div style="background:#f1f5f9;border-radius:999px;height:12px;overflow:hidden;margin-bottom:10px">'
    +'<div id="crProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#0a9396,#1E4BA0);border-radius:999px;transition:width .4s ease"></div>'
    +'</div>'
    +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">'
    +'<div id="crPctLabel" style="font-size:13px;font-weight:700;color:#1E4BA0">0%</div>'
    +'<div id="crTimeLeft" style="font-size:11px;color:#64748b">~'+estSecs+' sec remaining</div>'
    +'</div>'
    +'<div id="crStageMsg" style="text-align:center;font-size:11px;color:#94a3b8;min-height:18px">Fetching records‚Ä¶</div>'
    +'</div></div>';

  document.body.appendChild(modal);
  document.body.style.overflow="hidden";

  // Progress animation
  var prog=0;
  var startTime=Date.now();
  var stages=["Fetching records‚Ä¶","Loading client data‚Ä¶","Scanning progress notes‚Ä¶","Analysing incidents‚Ä¶","Mapping stakeholders‚Ä¶","Generating AI summary‚Ä¶","Building report sections‚Ä¶","Finalising document‚Ä¶","Almost done‚Ä¶"];
  var bar=modal.querySelector("#crProgressBar");
  var pctLbl=modal.querySelector("#crPctLabel");
  var timeLbl=modal.querySelector("#crTimeLeft");
  var stageEl=modal.querySelector("#crStageMsg");

  var ticker=setInterval(function(){
    var elapsed=(Date.now()-startTime)/1000;
    prog=Math.min(Math.round((elapsed/estSecs)*90),90);
    if(bar)bar.style.width=prog+"%";
    if(pctLbl)pctLbl.textContent=prog+"%";
    var secsLeft=Math.max(1,Math.round(estSecs-elapsed));
    if(timeLbl)timeLbl.textContent="~"+secsLeft+" sec remaining";
    var si=Math.min(Math.floor(elapsed/8),stages.length-1);
    if(stageEl)stageEl.textContent=stages[si];
  },500);

  function esc(v){return String(v||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

  // Queue per-client AI analysis
  var allAnalyses={};
  var clientQueue=[].concat(data.clients||[]);
  function processNextClient(){
    if(clientQueue.length===0){
      data.aiAnalyses=allAnalyses;
      window._crCurrentData=data;
      renderFinalReport();
      return;
    }
    var cn=clientQueue.shift();
    var audience=data.audience||"stakeholder";
    var recipient=data.recipient||"";
    var company=window._crCompany||{};
    apiCall("POST","/api/custom-report-analyse",{
      clientName:cn,
      audience:audience,
      from:data.from,
      to:data.to,
      recipient:recipient,
      rawData:data.results||{},
      tables:data.tables||[],
      company:company
    }).then(function(analysis){
      allAnalyses[cn]=analysis;
      processNextClient();
    }).catch(function(e){
      console.warn("AI analysis failed for",cn,":",e.message);
      allAnalyses[cn]={error:e.message,aiNarrative:null};
      processNextClient();
    });
  }

  processNextClient();

  function renderFinalReport(){
    clearInterval(ticker);
    // Snap to 100%
    if(bar){bar.style.width="100%";bar.style.transition="width .3s ease";}
    if(pctLbl)pctLbl.textContent="100%";
    if(timeLbl)timeLbl.textContent="Complete";
    if(stageEl)stageEl.textContent="Report ready!";

    setTimeout(function(){
      var reportHtml=crBuildProfessionalReport(data);
      var topBar='<div style="background:linear-gradient(135deg,#0a9396,#1E4BA0);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;gap:12px">';
      topBar+='<div style="display:flex;align-items:center;gap:12px"><div style="font-size:20px">üìä</div><div><div style="font-size:15px;font-weight:800;color:#fff">Report Preview</div>';
      topBar+='<div style="font-size:11px;color:rgba(255,255,255,.7)">'+esc((data.clients||[]).join(', '))+' ¬∑ '+data.from+' to '+data.to+'</div></div></div>';
      topBar+='<div style="display:flex;align-items:center;gap:8px">';
      topBar+='<button id="crSaveBtnModal" onclick="crSaveToAirtable(window._crCurrentData,false)" style="padding:8px 16px;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">‚òÅÔ∏è Save to Airtable</button>';
      topBar+='<button onclick="crPrint()" style="padding:8px 16px;background:#fff;color:#0a9396;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">üñ®Ô∏è Export / Print</button>';
      topBar+='<button onclick="document.getElementById(\'crPreviewModal\').remove();document.body.style.overflow=\'\';" style="padding:8px 12px;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">‚úï Close</button>';
      topBar+='</div></div>';
      var statusBar='<div id="crSaveStatus" style="padding:5px 20px;background:rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.1);font-size:11px;color:rgba(255,255,255,.6)">Report ready ‚Äî click Save to Airtable to archive</div>';
      var layout='<div style="flex:1;display:flex;overflow:hidden">';
      layout+='<div id="crSectionSidebar" style="width:248px;flex-shrink:0;background:#0F2440;border-right:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;overflow:hidden">';
      layout+='<div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12);flex-shrink:0">';
      layout+='<div style="font-size:10px;font-weight:800;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üìã Report Sections</div>';
      layout+='<div style="display:flex;gap:6px">';
      layout+='<button onclick="crSelectAllSections(true)" style="flex:1;padding:5px 0;background:rgba(255,255,255,.1);color:rgba(255,255,255,.85);border:1px solid rgba(255,255,255,.15);border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;font-family:inherit">‚úì Show All</button>';
      layout+='<button onclick="crSelectAllSections(false)" style="flex:1;padding:5px 0;background:rgba(255,255,255,.04);color:rgba(255,255,255,.4);border:1px solid rgba(255,255,255,.08);border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;font-family:inherit">‚úó Hide All</button>';
      layout+='</div></div>';
      layout+='<div id="crSectionList" style="flex:1;overflow-y:auto;padding:6px 0"></div>';
      layout+='<div style="padding:8px 12px;border-top:1px solid rgba(255,255,255,.08);flex-shrink:0;font-size:9px;color:rgba(255,255,255,.28);line-height:1.6">‚òë Uncheck = hide from export<br>‚ñº Click heading = collapse<br>‚Üó Arrow = jump to section</div>';
      layout+='</div>';
      layout+='<div style="flex:1;overflow-y:auto;padding:24px 20px;background:#f1f5f9">';
      layout+='<div id="crReportWrapper" style="max-width:960px;margin:0 auto;background:#fff;border-radius:12px;padding:32px;box-shadow:0 8px 32px rgba(0,0,0,.12)">';
      layout+='<div id="crReportContent">'+reportHtml+'</div>';
      layout+='</div></div></div>';
      modal.innerHTML=topBar+statusBar+layout;
      setTimeout(function(){ crInitSectionToggles(); },80);
      crSaveToAirtable(data,true);
    },400);
  }
}

function crSaveToAirtable(data,isAuto){
  var saveBtn=document.getElementById("crSaveBtnModal")||document.getElementById("crSaveBtn");
  if(saveBtn)saveBtn.disabled=true;
  var reportHtmlEl=document.getElementById("crReportContent");
  var htmlContent=reportHtmlEl?reportHtmlEl.outerHTML:"";
  var tableSources=(data.tables||[]).join(", ");
  var clients=data.clients||[];
  // Use modal status bar if available, else fallback
  var saveStatus=document.getElementById("crModalSaveStatus")||document.getElementById("crSaveStatus");
  if(!saveStatus){
    saveStatus=document.createElement("div");
    saveStatus.id="crSaveStatus";
    saveStatus.style.cssText="margin-top:10px;font-size:12px;padding:8px 12px;border-radius:8px";
    var result=document.getElementById("crResult");
    if(result)result.appendChild(saveStatus);
  }
  saveStatus.style.display="block";
  saveStatus.style.background="rgba(10,147,150,.06)";
  saveStatus.style.borderBottom="1px solid rgba(10,147,150,.15)";
  if(isAuto)saveStatus.innerHTML='<span style="color:#0a9396">‚è≥ Auto-saving to Airtable‚Ä¶</span>';
  var saves=clients.map(function(name){
    var titusUser=(function(){try{var u=JSON.parse(localStorage.getItem("titus_user")||"{}");return u.name||u.email||"Titus User"}catch(e){return "Titus User"}})();
    return apiCall("POST","/api/custom-report-save",{
      clientName:name,
      from:data.from,
      to:data.to,
      tableSources:tableSources,
      generatedBy:titusUser,
      reportTitle:"Customised Report ‚Äî "+name+" ‚Äî "+data.from+" to "+data.to,
      htmlContent:htmlContent
    });
  });
  Promise.all(saves).then(function(results){
    var errors=results.filter(function(r){return r&&r.error});
    if(errors.length===0){
      saveStatus.style.background="rgba(16,185,129,.06)";
      saveStatus.style.borderBottom="1px solid rgba(16,185,129,.15)";
      saveStatus.innerHTML='<span style="color:#10b981">‚úÖ Saved '+clients.length+' record'+(clients.length!==1?"s":"")+ ' to Weekly Stakeholder Reports 2026</span>';
      if(saveBtn){saveBtn.innerHTML="‚úÖ Saved";saveBtn.style.opacity=".6";}
    } else {
      saveStatus.style.background="rgba(239,68,68,.06)";
      saveStatus.style.borderBottom="1px solid rgba(239,68,68,.15)";
      saveStatus.innerHTML='<span style="color:#ef4444">‚ö†Ô∏è Saved '+(clients.length-errors.length)+'/'+clients.length+' ‚Äî '+errors.map(function(e){return e.error}).join(", ")+'</span>';
      if(saveBtn){saveBtn.disabled=false;saveBtn.innerHTML="‚òÅÔ∏è Retry Save to Airtable";}
    }
  }).catch(function(e){
    saveStatus.style.background="rgba(239,68,68,.06)";
    saveStatus.innerHTML='<span style="color:#ef4444">‚ö†Ô∏è Save failed: '+e.message+'</span>';
    if(saveBtn){saveBtn.disabled=false;}
  });
}

function crBuildProfessionalReport(data){
  var from=data.from,to=data.to,clients=data.clients||[],tables=data.tables||[],results=data.results||{},allStakeholders=data.stakeholders||{};
  var reportCreatedBy=(function(){try{var u=JSON.parse(localStorage.getItem("titus_user")||"{}" );return u.name||u.email||"Titus User"}catch(e){return "Titus User"}})();
  var reportCreatedAt=new Date().toLocaleDateString("en-AU",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"});
  var genDate=data.generatedAt||new Date().toLocaleString("en-AU");
  var audience=data.audience||"stakeholder";
  var recipient=data.recipient||"";
  var company=window._crCompany||{};
  var companyName=company.tradingName||"Delta Community Support";
  var ndisProvider=company.ndisProvider||"4050123456";
  var companyABN=company.abn||"";
  var companyEmail=company.email||"";
  var companyPhone=company.phone||"";
  var companySuburb=company.suburb||"Brisbane";
  var companyState=company.state||"QLD";
  var companyLogo=company.logo||"";

  // ‚îÄ‚îÄ Audience config ‚îÄ‚îÄ
  var AUDIENCE_CONFIG={
    stakeholder:{
      label:"Stakeholder Progress Report",
      to:"NDIA ¬∑ Plan Manager ¬∑ Support Coordinator",
      framework:"NDIS Act 2013 ¬∑ NDIS Practice Standards",
      color:"#0a9396",
      badge:"MEDIUM COMPLEXITY",
      icon:"üìä",
      confidentiality:"CONFIDENTIAL ‚Äî For authorised recipients only"
    },
    guardian:{
      label:"Report to the Office of the Public Guardian",
      to:"Office of the Public Guardian (QLD)",
      framework:"Guardianship & Administration Act 2000 (Qld)",
      color:"#6366f1",
      badge:"HIGH COMPLEXITY ‚Äî LEGAL DOCUMENT",
      icon:"‚öñÔ∏è",
      confidentiality:"STRICTLY CONFIDENTIAL ‚Äî Report to Office of the Public Guardian"
    },
    behaviour:{
      label:"Behaviour Support Report",
      to:"NDIS Quality & Safeguards Commission ¬∑ Implementing Provider",
      framework:"NDIS (Restrictive Practices & Behaviour Support) Rules 2018",
      color:"#f59e0b",
      badge:"VERY HIGH COMPLEXITY ‚Äî REGULATORY DOCUMENT",
      icon:"üß†",
      confidentiality:"CONFIDENTIAL ‚Äî Behaviour Support Report ¬∑ Regulatory Document"
    },
    mentalhealth:{
      label:"Mental Health Nursing Report",
      to:"Treating Team ¬∑ NDIA ¬∑ Support Coordinator",
      framework:"NDIS Act 2013 ¬∑ Mental Health Act 2016 (Qld) ¬∑ AHPRA Standards",
      color:"#10b981",
      badge:"HIGH COMPLEXITY ‚Äî CLINICAL DOCUMENT",
      icon:"üè•",
      confidentiality:"CLINICAL DOCUMENT ‚Äî STRICTLY CONFIDENTIAL ¬∑ For authorised clinical recipients only"
    },
    internal:{
      label:"Internal Operations Report",
      to:"DCS Management ‚Äî Internal Use Only",
      framework:"Internal DCS Quality Framework",
      color:"#1E4BA0",
      badge:"INTERNAL USE",
      icon:"üè¢",
      confidentiality:"INTERNAL DOCUMENT ‚Äî Not for external distribution"
    },
    family:{
      label:"Family & Carer Update",
      to:"Family Members ¬∑ Informal Support Network",
      framework:"NDIS Act 2013 ¬∑ Person-Centred Practice",
      color:"#8b5cf6",
      badge:"FAMILY UPDATE",
      icon:"üë®‚Äçüë©‚Äçüëß",
      confidentiality:"CONFIDENTIAL ‚Äî For family and authorised carers only"
    }
  };
  var aud=AUDIENCE_CONFIG[audience]||AUDIENCE_CONFIG.stakeholder;

  function fmtDate(s){if(!s)return"";try{var d=new Date(s);return d.toLocaleDateString("en-AU",{day:"numeric",month:"long",year:"numeric"})}catch(e){return s}}
  function fmtDateShort(s){if(!s)return"";try{var d=new Date(s);return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){return s}}
  function fmtDT(s){if(!s)return"";try{var d=new Date(s);return d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+" at "+d.toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:true})}catch(e){return s}}
  function esc(v){return String(v||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  function fv(f,key){var v=f[key];if(v===null||v===undefined)return"";if(Array.isArray(v)){if(v.length>0&&typeof v[0]==="object")return v.map(function(x){return x.filename||x.name||x.url||""}).join(", ");return v.map(function(x){return String(x)}).join(", ")}if(typeof v==="object")return JSON.stringify(v);return String(v)}
  function badge(text,color,bg){return'<span style="display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;background:'+(bg||color+"12")+';color:'+color+';border:1px solid '+color+'25;white-space:nowrap">'+esc(text)+'</span>'}
  function sectionHdr(icon,title,count,color){color=color||aud.color;var cb=count!==undefined?'<span style="margin-left:auto;background:'+color+'12;color:'+color+';border:1px solid '+color+'25;border-radius:20px;padding:3px 12px;font-size:11px;font-weight:700">'+count+(typeof count==="number"?" record"+(count!==1?"s":""):"")+'</span>':"";return'<div data-cr-section-hdr="'+esc(title)+'" onclick="crToggleSection(this)" style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:linear-gradient(135deg,'+color+'08,'+color+'02);border-bottom:2px solid '+color+'18;cursor:pointer">'+
    '<span style="font-size:18px">'+icon+'</span>'+
    '<span style="font-size:13px;font-weight:800;color:#1a1a2e">'+esc(title)+'</span>'+
    cb+'<span class="cr-chevron" style="margin-left:8px;font-size:10px;color:'+color+';transition:transform .2s;flex-shrink:0">&#9660;</span>'+'</div>'}
  function clientMatch(rec){var f=rec.fields||{};return Object.keys(f).some(function(k){return String(fv(f,k)).toLowerCase().indexOf(clientName.toLowerCase())>=0})}
  var clientName=""; // set per-client in loop

  // ‚îÄ‚îÄ AGGREGATES ‚îÄ‚îÄ
  var totalRecords=0,totalNotes=0,totalIncidents=0,totalReportable=0,totalRisks=0,totalTasks=0;
  tables.forEach(function(t){var r=results[t];if(!r||r.error)return;if(t==="Conversations SMS & Calls"){totalRecords+=(r.calls||[]).length+(r.sms||[]).length;return}var cnt=r.length||0;totalRecords+=cnt;if(t==="Progress Notes")totalNotes=cnt;if(t==="IR Reports 2025"){totalIncidents=cnt;(r||[]).forEach(function(rec){if(String(fv(rec.fields||{},"Is this a Reportable Incident to the NDIS Quality Safeguards Commission??")||"").toLowerCase().indexOf("yes")>=0)totalReportable++})}if(t==="Risk Register")totalRisks=cnt;if(t==="Tasks")totalTasks=cnt;});

  var h='<div id="crReportContent" style="font-family:\'Segoe UI\',Arial,sans-serif;color:#1a1a2e">';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // OFFICIAL DCS LETTERHEAD HEADER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  h+='<div style="border:2px solid '+aud.color+';border-radius:14px;overflow:hidden;margin-bottom:24px;box-shadow:0 4px 20px rgba(0,0,0,.08)">';

  // Top colour bar
  h+='<div style="background:linear-gradient(135deg,'+aud.color+' 0%,'+aud.color+'cc 100%);padding:5px 0"></div>';

  // Letterhead body
  h+='<div style="padding:22px 28px;display:flex;align-items:center;justify-content:space-between;gap:16px;border-bottom:1px solid #e2e8f0;flex-wrap:wrap">';
  // Logo / company name block
  h+='<div style="display:flex;align-items:center;gap:14px">';
  if(companyLogo){
    h+='<img src="'+companyLogo+'" alt="'+esc(companyName)+' logo" style="height:52px;width:auto;object-fit:contain" onerror="this.style.display=\'none\'">';
  } else {
    h+='<div style="width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,'+aud.color+','+aud.color+'99);display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;font-weight:900;flex-shrink:0">'+esc(companyName.charAt(0))+'</div>';
  }
  h+='<div>';
  h+='<div style="font-size:18px;font-weight:900;color:#1a1a2e;letter-spacing:-.3px">'+esc(companyName)+'</div>';
  h+='<div style="font-size:11px;color:#64748b;margin-top:2px">Registered NDIS Provider'+(ndisProvider?' &nbsp;¬∑&nbsp; Provider No: <strong>'+esc(ndisProvider)+'</strong>':'')+(companyABN?' &nbsp;¬∑&nbsp; ABN: '+esc(companyABN):'')+'</div>';
  h+='<div style="font-size:10px;color:#94a3b8;margin-top:2px">'+(companySuburb?esc(companySuburb)+', ':'')+(companyState?esc(companyState)+' &nbsp;¬∑&nbsp; ':'')+( companyEmail?'<a href="mailto:'+esc(companyEmail)+'" style="color:#94a3b8">'+esc(companyEmail)+'</a>':'')+( companyPhone?' &nbsp;¬∑&nbsp; '+esc(companyPhone):'')+'</div>';
  h+='</div></div>';
    // Report type badge removed per user request
  h+='</div>';

  // Report metadata table removed per user request

  // NDIS Provider + Client declaration strip
  h+='<div style="background:'+aud.color+'08;border-top:2px solid '+aud.color+'20;padding:10px 20px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
  h+='<span style="font-size:10px;color:'+aud.color+';font-weight:700">üìã This report is provided by: <strong>'+esc(companyName)+'</strong> (NDIS Provider No: <strong>'+esc(ndisProvider)+'</strong>)</span>';
  if(clients.length===1)h+='<span style="font-size:10px;color:'+aud.color+'"> &nbsp;¬∑&nbsp; For client: <strong>'+esc(clients[0])+'</strong></span>';
  if(companyABN)h+='<span style="font-size:10px;color:'+aud.color+'"> &nbsp;¬∑&nbsp; ABN: <strong>'+esc(companyABN)+'</strong></span>';
    h+='<span style="font-size:10px;color:'+aud.color+';margin-left:auto;font-weight:600">‚úçÔ∏è Created by: <strong>'+esc(reportCreatedBy)+'</strong></span>';
h+='</div>';

  h+='</div>'; // end letterhead

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AUDIENCE-SPECIFIC PREAMBLE / LEGAL NOTICE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var preambles={
    stakeholder:'<p>This report has been prepared by '+esc(companyName)+' in accordance with the <strong>NDIS Act 2013</strong> and <strong>NDIS Practice Standards</strong>. It is intended to provide the NDIA, Plan Manager, and/or Support Coordinator with a structured evidence-based account of support delivery, goal progress, and participant outcomes for the reporting period. All information has been sourced from verified service records within the Titus CRM.</p>',
    guardian:'<p>This report is prepared pursuant to the <strong>Guardianship and Administration Act 2000 (Qld)</strong> and the <strong>Adult Guardian Act 2000 (Qld)</strong>. It constitutes a formal provider report to the Office of the Public Guardian and is a <strong>legally significant document</strong>. Every statement is factual, evidence-based, and sourced from verified records. Opinions are clearly labelled. '+esc(companyName)+' (NDIS Provider No: '+esc(ndisProvider)+') assumes full responsibility for the accuracy of this report.</p><p style="margin-top:8px;color:#ef4444;font-weight:600;font-size:12px">‚ö†Ô∏è IMPORTANT: This report must be reviewed and signed by an authorised DCS staff member before distribution. Non-compliance with OPG reporting obligations carries serious legal consequences.</p>',
    behaviour:'<p>This report presents the operational observations of '+esc(companyName)+' as the NDIS implementing provider ‚Äî including staffing responses, incident records, strategy effectiveness, and environmental factors ‚Äî to assist the practitioner in reviewing and updating the Behaviour Support Plan. All information is sourced from verified service records within the Titus CRM.</p>',
    mentalhealth:'<p>This Mental Health Nursing Report has been prepared by '+esc(companyName)+' in accordance with both <strong>NDIS documentation standards</strong> and <strong>Queensland Health clinical documentation standards</strong>. It bridges the NDIS and Queensland mental health systems and may be shared with the participant\'s treating team, NDIA, support coordinators, and/or the participant\'s guardian. NDIS Provider No: <strong>'+esc(ndisProvider)+'</strong>.</p>',
    internal:'<p>This internal operations report has been generated from Titus CRM for management review and quality assurance purposes. It is intended for authorised DCS staff only and is not for external distribution. All data is sourced directly from '+esc(companyName)+'\'s operational records. NDIS Provider No: <strong>'+esc(ndisProvider)+'</strong>.</p>',
    family:'<p>This update has been prepared by '+esc(companyName)+' (NDIS Provider No: '+esc(ndisProvider)+') to keep families and carers informed about the supports and progress achieved by their loved one during the reporting period. If you have any questions about the information in this report, please contact our team directly.</p>'
  };
  h+='<div style="background:#fff;border:1px solid #e2e8f0;border-left:4px solid '+aud.color+';border-radius:0 10px 10px 0;padding:16px 20px;margin-bottom:22px;font-size:12px;color:#374151;line-height:1.7">';
  h+='<div style="font-size:10px;font-weight:800;color:'+aud.color+';text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">About This Report</div>';
  h+=(preambles[audience]||preambles.stakeholder);
  h+='</div>';

  // ‚îÄ‚îÄ KEY METRICS SUMMARY ‚îÄ‚îÄ
  var metrics=[];
  // Progress Notes metric removed ‚Äî shown in overview section instead
  if(totalIncidents>0)metrics.push({icon:"‚ö†Ô∏è",label:"Incidents"+(totalReportable>0?" ¬∑ "+totalReportable+" Reportable":""),val:totalIncidents,color:totalReportable>0?"#ef4444":"#f59e0b"});
  if(totalRisks>0)metrics.push({icon:"‚ö°",label:"Active Risks",val:totalRisks,color:"#f59e0b"});
  if(totalTasks>0)metrics.push({icon:"‚úÖ",label:"Tasks",val:totalTasks,color:"#10b981"});
  // Total Records fallback metric removed
  h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:10px;margin-bottom:22px">';
  metrics.forEach(function(m){
    h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:14px 16px;border-left:4px solid '+m.color+';box-shadow:0 1px 4px rgba(0,0,0,.04)">';
    h+='<div style="font-size:22px;margin-bottom:6px">'+m.icon+'</div>';
    h+='<div style="font-size:30px;font-weight:900;color:'+m.color+';line-height:1">'+m.val+'</div>';
    h+='<div style="font-size:11px;font-weight:600;color:#64748b;margin-top:4px">'+esc(m.label)+'</div>';
    h+='</div>';
  });
  h+='</div>';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PER-CLIENT SECTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  clients.forEach(function(cn,ci){
    clientName=cn;
    if(ci>0)h+='<div style="border-top:3px dashed #e2e8f0;margin:28px 0;position:relative"><div style="position:absolute;top:-11px;left:50%;transform:translateX(-50%);background:#fff;padding:0 16px;font-size:10px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:1px">Next Client</div></div>';

    // ‚îÄ‚îÄ Client profile banner ‚îÄ‚îÄ
    h+='<div style="background:linear-gradient(135deg,'+aud.color+'0a,'+aud.color+'04);border:1px solid '+aud.color+'22;border-radius:12px;padding:18px 22px;margin-bottom:18px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">';
    h+='<div style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,'+aud.color+','+aud.color+'aa);display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;font-weight:900;flex-shrink:0">'+esc(cn.charAt(0).toUpperCase())+'</div>';
    h+='<div style="flex:1"><div style="font-size:19px;font-weight:900;color:#1a1a2e">'+esc(cn)+'</div>';
    h+='<div style="font-size:12px;color:#64748b;margin-top:2px">'+fmtDate(from)+' to '+fmtDate(to)+'</div>';
    h+='<div style="font-size:11px;color:'+aud.color+';margin-top:3px;font-weight:600">Provided by: '+esc(companyName)+' &nbsp;¬∑&nbsp; NDIS Provider No: '+esc(ndisProvider)+'</div>';
    h+='</div>';
    if(recipient)h+='<div style="background:#fff;border:1px solid '+aud.color+'22;border-radius:8px;padding:8px 14px;font-size:11px"><div style="font-size:9px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.6px">Submitted To</div><div style="font-weight:700;color:#1a1a2e;margin-top:2px">'+esc(recipient)+'</div></div>';
    h+='</div>';

    // gather client data
    function getClientRows(tableKey){
      var r=results[tableKey];
      if(!r||r.error||!Array.isArray(r))return[];
      return r.filter(function(rec){return Object.keys(rec.fields||{}).some(function(k){return String(fv(rec.fields,k)).toLowerCase().indexOf(cn.toLowerCase())>=0})});
    }
    var notesRows=getClientRows("Progress Notes");
    var incRows=getClientRows("IR Reports 2025");
    var riskRows=getClientRows("Risk Register");
    var taskRows=getClientRows("Tasks");
    var sleepRows=getClientRows("Client Sleep Chart");
    var pbspRows=getClientRows("PBSP");
    var bowelRows=getClientRows("Bowel Chart");
    var fluidRows=getClientRows("Fluid Intake Diary");
    var calRows=getClientRows("Client Calendar");
    var budgetRows=getClientRows("Client Core Budgets");
    var supportPlanRows=getClientRows("Support Plan 2025");
    var contactPrefRows=getClientRows("Client Contact Preferences");
    var clientInfoRows=getClientRows("Clients");
    var complaintRows=getClientRows("Complaints Register");
    var clientDocRows=getClientRows("Client Docs");
    var saRows=getClientRows("Client SA & SOS");
    var behaviourRows=getClientRows("QR Code Data - Behaviours");
    var auditRows=getClientRows("Internal Audit");
    var silVisitRows=getClientRows("SIL Site Visits");
    var inductRows=getClientRows("SIL Induction Register");
    var workerRows=getClientRows("Approved / Excluded Workers 2025");

    var repCount=incRows.filter(function(r){return String(fv(r.fields||{},"Is this a Reportable Incident to the NDIS Quality Safeguards Commission??")||"").toLowerCase().indexOf("yes")>=0}).length;

    // ‚îÄ‚îÄ REPORT TYPE & AUDIENCE + STAKEHOLDERS PANEL ‚îÄ‚îÄ
    var cliSH=allStakeholders[cn]||{};
    var audConf={stakeholder:{label:'Stakeholder Progress Report',icon:'\u{1F4CA}'},guardian:{label:'Public Guardian Report',icon:'\u2696\uFE0F'},behaviour:{label:'Behaviour Support Report',icon:'\u{1F9E0}'},mentalhealth:{label:'Mental Health Nurse Report',icon:'\u{1F3E5}'},ops:{label:'Internal Operations Report',icon:'\u{1F3E2}'},family:{label:'Family / Carer Update',icon:'\u{1F46A}'}};
    var audConfi=audConf[audience]||{label:audience,icon:'\u{1F4CB}'};
    h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
    h+='<div style="padding:10px 16px;background:'+aud.color+'08;border-bottom:2px solid '+aud.color+'20;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">';
    h+='<div style="font-size:10px;font-weight:800;color:'+aud.color+';text-transform:uppercase;letter-spacing:1px">\u{1F4CB} Report Type &amp; Audience</div>';
    h+='<div style="display:flex;align-items:center;gap:8px">';
    h+='<span style="font-size:11px;font-weight:700;color:'+aud.color+';background:'+aud.color+'12;border:1px solid '+aud.color+'30;padding:3px 12px;border-radius:20px">'+audConfi.icon+' '+esc(audConfi.label)+'</span>';
    if(recipient)h+='<span style="font-size:10px;color:#64748b;font-weight:600"> \xb7 Prepared for: <strong>'+esc(recipient)+'</strong></span>';
    h+='</div>';
    h+='</div>';
    var shCards=[];
    if(cliSH.supportCoordinator&&cliSH.supportCoordinator.name)shCards.push({role:'Support Coordinator',icon:'\u{1F91D}',color:'#0a9396',sh:cliSH.supportCoordinator});
    if(cliSH.nominee&&cliSH.nominee.name)shCards.push({role:'Nominee / Guardian',icon:'\u{1F6E1}\uFE0F',color:'#6366f1',sh:cliSH.nominee});
    if(cliSH.opg&&cliSH.opg.name)shCards.push({role:'Public Guardian',icon:'\u2696\uFE0F',color:'#7c3aed',sh:cliSH.opg});
    if(cliSH.behaviourPractitioner&&cliSH.behaviourPractitioner.name)shCards.push({role:'Behaviour Practitioner',icon:'\u{1F9E0}',color:'#f59e0b',sh:cliSH.behaviourPractitioner});
    if(cliSH.planManager&&cliSH.planManager.name)shCards.push({role:'Plan Manager',icon:'\u{1F4BC}',color:'#1E4BA0',sh:cliSH.planManager});
    if(shCards.length>0){
      h+='<div style="padding:12px 16px">';
      h+='<div style="font-size:9px;font-weight:800;color:#64748b;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">KEY STAKEHOLDERS</div>';
      h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px">';
      shCards.forEach(function(sc){
        var sh=sc.sh;
        h+='<div style="background:'+sc.color+'06;border:1px solid '+sc.color+'20;border-radius:10px;padding:10px 12px">';
        h+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:5px">';
        h+='<span style="font-size:14px">'+sc.icon+'</span>';
        h+='<div style="font-size:9px;font-weight:800;color:'+sc.color+';text-transform:uppercase;letter-spacing:.5px">'+esc(sc.role)+'</div>';
        h+='</div>';
        h+='<div style="font-size:12px;font-weight:700;color:#1a1a2e;margin-bottom:3px">'+esc(sh.name)+'</div>';
        if(sh.company)h+='<div style="font-size:10px;color:#64748b;margin-bottom:2px">\u{1F3E2} '+esc(sh.company)+'</div>';
        if(sh.phone)h+='<div style="font-size:10px;color:#64748b;margin-bottom:2px">\u{1F4DE} '+esc(sh.phone)+'</div>';
        if(sh.email)h+='<div style="font-size:10px;color:#64748b;word-break:break-all">\u2709\uFE0F '+esc(sh.email)+'</div>';
        if(sh.relationship)h+='<div style="font-size:10px;color:#64748b;margin-top:2px">Relationship: <strong>'+esc(sh.relationship)+'</strong></div>';
        h+='</div>';
      });
      h+='</div></div>';
    } else {
      h+='<div style="padding:10px 16px;font-size:11px;color:#94a3b8;font-style:italic">No stakeholder details recorded for this client.</div>';
    }
    h+='</div>';

    // ‚îÄ‚îÄ EXECUTIVE SUMMARY ‚îÄ‚îÄ
// ‚îÄ‚îÄ EXECUTIVE SUMMARY ‚îÄ‚îÄ
    var narr=[];
    if(notesRows.length>0){
      var hrs=notesRows.map(function(r){return parseFloat(fv(r.fields||{},"Total Hours")||fv(r.fields||{},"Hours")||0)}).filter(function(v){return!isNaN(v)&&v>0}).reduce(function(a,b){return a+b},0);
      var wset={};notesRows.forEach(function(r){var w=fv(r.fields||{},"Full Name (from Employees)")||fv(r.fields||{},"Support Workers Name")||"";if(w)wset[w]=1});
      var wnames=Object.keys(wset);
      var workerListStr=wnames.length>0?" Support was provided by <strong>"+wnames.slice(0,3).map(esc).join(", ")+(wnames.length>3?" and "+(wnames.length-3)+" others":"")+"</strong>.":""; narr.push("During this reporting period, <strong>"+esc(companyName)+"</strong> delivered disability support services to "+esc(cn)+" across morning, afternoon, evening, and sleepover shifts."+workerListStr);
    }
    if(incRows.length>0){narr.push("<strong>"+incRows.length+" incident report"+(incRows.length!==1?"s were":"was")+" recorded</strong>."+(repCount>0?" <span style='color:#ef4444;font-weight:700'>"+repCount+" NDIS-reportable incident"+(repCount!==1?"s require":"requires")+" mandatory notification to the Quality &amp; Safeguards Commission.</span>":""))}
    else if(tables.indexOf("IR Reports 2025")>=0){narr.push("There were <strong>no incidents recorded</strong> during this reporting period ‚Äî "+esc(cn)+" experienced a safe reporting period.")}
    if(riskRows.length>0){var hi=riskRows.filter(function(r){var s=String(fv(r.fields||{},"Severity")||"").toLowerCase();return s.indexOf("high")>=0||s.indexOf("extreme")>=0});narr.push("<strong>"+riskRows.length+" risk"+(riskRows.length!==1?"s are":"is")+" active</strong> on "+esc(cn)+"'s risk register"+(hi.length>0?", including <strong>"+hi.length+" high/extreme</strong> requiring urgent monitoring":"")+".")}
    // Health monitoring removed from executive summary
    if(calRows.length>0)narr.push("<strong>"+calRows.length+" scheduled activities</strong> recorded on the client calendar.");
    if(audience==="guardian"&&narr.length>0)narr.push("All decisions documented in this report have been made in accordance with the participant's expressed wishes and the scope of the Guardian order.");
    if(audience==="behaviour"&&behaviourRows.length>0)narr.push("<strong>"+behaviourRows.length+" behaviour data entr"+(behaviourRows.length!==1?"ies were":"y was")+" recorded</strong> via QR code monitoring.");

    // ‚îÄ‚îÄ Executive Summary ‚îÄ‚îÄ
    // Build rich operational summary
    var opSummaryParts=[];
    // Service delivery context
    var wset2={};notesRows.forEach(function(r){var w=fv(r.fields||{},"Full Name (from Employees)")||fv(r.fields||{},"Support Workers Name")||"";if(w)wset2[w]=1;});
    var wnames2=Object.keys(wset2);
    if(notesRows.length>0){
      var staffStr=wnames2.length>0?" Support was co-ordinated across a team of "+wnames2.length+" support workers"+(wnames2.length<=3?", including "+wnames2.map(esc).join(", "):""):"";
      opSummaryParts.push("<strong>"+esc(companyName)+"</strong> provided continuous Supported Independent Living and disability support services to <strong>"+esc(cn)+"</strong> during this reporting period."+staffStr+". Shift coverage included morning, afternoon, evening, and sleepover shifts across the full period.");
    }
    // Incidents context
    if(tables.indexOf("IR Reports 2025")>=0){
      if(incRows.length>0){
        // Categorise incidents
        var catMap={};incRows.forEach(function(r){var cats=fv(r.fields||{},"Incident Categories (Multi-select)")||fv(r.fields||{},"Incident Categories")||"Unclassified";String(cats).split(/[,;]/).forEach(function(cat){var t=cat.trim();if(t)catMap[t]=(catMap[t]||0)+1;});});
        var topCats=Object.keys(catMap).sort(function(a,b){return catMap[b]-catMap[a];}).slice(0,3);
        var catStr=topCats.length>0?" The most frequently recorded incident categories were: <strong>"+topCats.map(function(t){return esc(t)+" ("+catMap[t]+")"}).join(", ")+"</strong>.":"";
        opSummaryParts.push("<strong>"+incRows.length+" incident report"+(incRows.length!==1?"s were":"was")+" logged</strong> during this period."+(repCount>0?" <span style='color:#ef4444;font-weight:700'>"+repCount+" NDIS-reportable incident"+(repCount!==1?"s require":"requires")+" mandatory notification to the Quality &amp; Safeguards Commission.</span>":"")+catStr);
      } else {
        opSummaryParts.push("There were <strong>no incidents recorded</strong> during this reporting period ‚Äî "+esc(cn)+" experienced a safe reporting period.");
      }
    }
    // Risk context
    if(riskRows.length>0){
      var hi=riskRows.filter(function(r){var s=String(fv(r.fields||{},"Severity")||"").toLowerCase();return s.indexOf("high")>=0||s.indexOf("extreme")>=0;});
      opSummaryParts.push("<strong>"+riskRows.length+" risk"+(riskRows.length!==1?"s are":"is")+" active</strong> on "+esc(cn)+"'s risk register"+(hi.length>0?", of which <strong>"+hi.length+" are rated high or extreme severity</strong> requiring ongoing monitoring":"")+".");
    }
    // PBS context for behaviour reports
    if(audience==="behaviour"){
      opSummaryParts.push("This report has been prepared by the implementing provider to inform the PBS Practitioner of observed behaviours, staffing responses, and environmental factors during the reporting period. All observations are sourced from verified shift notes and incident records. The practitioner is invited to review the evidence below and update the Behaviour Support Plan accordingly.");
    }
    // Guardian context
    if(audience==="guardian"){
      opSummaryParts.push("All decisions made during this period have been documented in accordance with the participant's expressed wishes and the scope of the Guardian order. No decisions outside the Guardian's authority were made.");
    }

    if(opSummaryParts.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-left:4px solid '+aud.color+';border-radius:0 10px 10px 0;padding:18px 22px;margin-bottom:18px">';
      h+='<div style="font-size:10px;font-weight:800;color:'+aud.color+';text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">üìã Executive Summary ‚Äî '+esc(cn)+'</div>';
      h+='<div style="font-size:12px;color:#374151;line-height:1.9">';
      opSummaryParts.forEach(function(p){h+='<p style="margin:0 0 10px">'+p+'</p>';});
      h+='</div></div>';
    } else if(narr.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-left:4px solid '+aud.color+';border-radius:0 10px 10px 0;padding:16px 20px;margin-bottom:18px">';
      h+='<div style="font-size:10px;font-weight:800;color:'+aud.color+';text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">üìã Executive Summary ‚Äî '+esc(cn)+'</div>';
      h+='<div style="font-size:12px;color:#374151;line-height:1.8">'+narr.join(" ")+'</div>';
      h+='</div>';
    }

    // ‚îÄ‚îÄ AUDIENCE-SPECIFIC INTRODUCTORY SECTION ‚îÄ‚îÄ
    if(audience==="guardian"){
      h+='<div style="background:#6366f108;border:1px solid #6366f125;border-radius:10px;padding:14px 18px;margin-bottom:16px">';
      h+='<div style="font-size:10px;font-weight:800;color:#6366f1;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">‚öñÔ∏è Legal Context &amp; Guardian Order</div>';
      h+='<div style="font-size:12px;color:#374151;line-height:1.7"><p>Provider: <strong>'+esc(companyName)+'</strong> (NDIS Provider No: <strong>'+esc(ndisProvider)+'</strong>)<br>Report Prepared For: <strong>'+esc(recipient||"Office of the Public Guardian (QLD)")+'</strong><br>Regulatory Framework: Guardianship and Administration Act 2000 (Qld)</p><p style="margin-top:8px">This report documents all decisions made during the reporting period, the participant\'s expressed wishes, any restrictive practices in use, and the participant\'s health, wellbeing, and quality of life.</p></div>';
      h+='</div>';
    }
    // Behaviour support context box removed per user request
    if(audience==="mentalhealth"){
      h+='<div style="background:#10b98108;border:1px solid #10b98125;border-radius:10px;padding:14px 18px;margin-bottom:16px">';
      h+='<div style="font-size:10px;font-weight:800;color:#10b981;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">üè• Clinical Report Context</div>';
      h+='<div style="font-size:12px;color:#374151;line-height:1.7">Provider: <strong>'+esc(companyName)+'</strong> (NDIS Provider No: <strong>'+esc(ndisProvider)+'</strong>)<br>Regulatory Frameworks: NDIS Act 2013 ¬∑ Mental Health Act 2016 (Qld) ¬∑ AHPRA Standards<br>Distribution: '+esc(recipient||"Treating Team ¬∑ NDIA ¬∑ Support Coordinator")+'</div>';
      h+='</div>';
    }

        // ‚ïê‚ïê OPERATIONAL OVERVIEW (PROVIDER PERSPECTIVE) ‚ïê‚ïê
    if(audience==="behaviour"||audience==="stakeholder"||audience==="guardian"){
      // Calculate support hours from Progress Notes
      var totalHours=0,shiftCount=0,workerSet={};
      var notesForOverview=getClientRows("Progress Notes");
      notesForOverview.forEach(function(rec){
        var f=rec.fields||{};
        var hrs=parseFloat(fv(f,"Total Hours")||fv(f,"Hours")||0)||0;
        totalHours+=hrs;
        shiftCount++;
        var w=fv(f,"Full Name (from Employees)")||fv(f,"Support Workers Name")||"";
        if(w)workerSet[w]=(workerSet[w]||0)+1;
      });
      var incForOverview=getClientRows("IR Reports 2025");
      var incCount=incForOverview.length;
      var repCount2=incForOverview.filter(function(r){return String(fv(r.fields||{},"Is this a Reportable Incident to the NDIS Quality Safeguards Commission??")||"").toLowerCase().indexOf("yes")>=0}).length;

      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+='<div style="padding:12px 16px;background:linear-gradient(135deg,'+aud.color+'12,'+aud.color+'06);border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between">';
      h+='<div style="font-size:13px;font-weight:800;color:'+aud.color+'">üìä Operational Overview</div>';
      h+='<div style="font-size:10px;font-weight:600;color:#64748b">'+esc(fmtDate(from)||from||"")+(to?" ‚Äì "+esc(fmtDate(to)||to):"")+'</div>';
      h+='</div>';
      // Stats grid
      h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:0;border-bottom:1px solid #e2e8f0">';
      var stats=[
        {icon:"üë•",label:"Staff Involved",val:Object.keys(workerSet).length>0?Object.keys(workerSet).length:"‚Äî",color:"#6366f1"},
        {icon:"‚ö†Ô∏è",label:"Incidents Logged",val:incCount>0?incCount:"0",color:incCount>0?"#f59e0b":"#10b981"},
        {icon:"üî¥",label:"NDIS Reportable",val:repCount2>0?repCount2:"0",color:repCount2>0?"#ef4444":"#10b981"}
      ];
      stats.forEach(function(s){
        h+='<div style="padding:12px 14px;border-right:1px solid #e2e8f0">';
        h+='<div style="font-size:18px;margin-bottom:4px">'+s.icon+'</div>';
        h+='<div style="font-size:22px;font-weight:900;color:'+s.color+';line-height:1">'+s.val+'</div>';
        h+='<div style="font-size:10px;font-weight:600;color:#64748b;margin-top:3px">'+esc(s.label)+'</div>';
        h+='</div>';
      });
      h+='</div>';

      // Staff breakdown
      var workers=Object.keys(workerSet);
      if(workers.length>0){
        workers.sort(function(a,b){return workerSet[b]-workerSet[a]});
        h+='<div style="padding:14px 16px;border-bottom:1px solid #e2e8f0">';
        h+='<div style="font-size:10px;font-weight:800;color:#64748b;text-transform:uppercase;letter-spacing:.6px;margin-bottom:10px">üë• Support Staff</div>';
        h+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
        workers.slice(0,12).forEach(function(w){
          h+='<div style="padding:5px 10px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:20px;font-size:11px;color:#374151;font-weight:600">'+esc(w)+'</div>';
        });
        h+='</div></div>';
      }

      // Written operational narrative summary
      h+='<div style="padding:14px 16px">';
      h+='<div style="font-size:10px;font-weight:800;color:'+aud.color+';text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">üìù Provider Summary</div>';
      var summaryParts=[];
      summaryParts.push('During the period '+esc(fmtDate(from)||from||"")+(to?" to "+esc(fmtDate(to)||to):"")+', '+esc(companyName)+' provided ongoing disability support to '+esc(cn)+'. Support was coordinated across morning, afternoon, evening, and sleepover shifts by '+(workers.length>0?workers.length+' staff members':'the support team')+'.');
      if(workers.length>0)summaryParts.push("The primary support workers during this period were "+workers.slice(0,3).map(function(w){return esc(w)}).join(", ")+(workers.length>3?", and "+(workers.length-3)+" additional staff members":"")+".");
      if(incCount>0)summaryParts.push(incCount+" incident report"+(incCount!==1?"s were":"was")+" logged during this period"+(repCount2>0?", of which "+repCount2+" "+(repCount2===1?"is":"are")+" NDIS reportable to the Quality and Safeguards Commission":". No incidents met the threshold for NDIS reportability")+".");
      else summaryParts.push("No incidents were recorded during the reporting period for "+esc(cn)+".");
      if(summaryParts.length>0)h+='<div style="font-size:12px;color:#374151;line-height:1.8">'+summaryParts.join(" ")+'</div>';
      h+='</div>';
      h+='</div>';
    }

    // ‚ïê‚ïê PBSP EXPIRY STATUS BANNER ‚ïê‚ïê
    // Looks in both: 1) Client Docs table (doc type = "PBSP Plan"), 2) PBSP table directly
    (function(){
      var now=new Date();
      var pbspDocRec=null, pbspExpDate=null, pbspFileName="", pbspExpiredOrSoon=false;

      // --- Source 1: Client Docs table - find row where doc type contains "PBSP" ---
      var cdRows=clientDocRows.length>0?clientDocRows:getClientRows("Client Docs");
      cdRows.forEach(function(r){
        var f=r.fields||{};
        var docType=String(fv(f,"Type of Document")||fv(f,"Document Type")||fv(f,"Type")||"").toLowerCase();
        if(docType.indexOf("pbsp")>=0||docType.indexOf("behaviour support plan")>=0||docType.indexOf("bsp")>=0){
          var expRaw=fv(f,"Expiry Date of Document")||fv(f,"Expiry Date")||fv(f,"Review Date")||fv(f,"End Date")||"";
          if(expRaw){
            var d=new Date(expRaw);
            if(!isNaN(d)){
              pbspDocRec=f;
              pbspExpDate=d;
              // Attachment filename
              var att=f["File Upload"]||f["Attachments"]||f["Document"]||[];
              if(Array.isArray(att)&&att.length>0) pbspFileName=att[0].filename||att[0].name||att[0].url||"";
              else if(typeof att==="string") pbspFileName=att;
            }
          }
        }
      });

      // --- Source 2: PBSP table (dedicated table) ---
      if(!pbspDocRec&&pbspRows.length>0){
        var pr=pbspRows[0].fields||{};
        var keys=Object.keys(pr);
        keys.forEach(function(k){
          var kl=k.toLowerCase();
          if(!pbspExpDate&&(kl.indexOf("expir")>=0||kl.indexOf("review")>=0||kl.indexOf("end date")>=0)){
            var d=new Date(pr[k]);
            if(!isNaN(d)){pbspExpDate=d;pbspDocRec=pr;}
          }
          if(!pbspFileName){
            var v=pr[k];
            if(Array.isArray(v)&&v[0]&&v[0].filename)pbspFileName=v[0].filename;
          }
        });
      }

      // --- Only render if we have a date ---
      if(!pbspExpDate) return;

      var daysLeft=Math.ceil((pbspExpDate-now)/86400000);
      var expired=daysLeft<0;
      var duesSoon=!expired&&daysLeft<=60;
      var dateStr=pbspExpDate.toLocaleDateString("en-AU",{day:"numeric",month:"long",year:"numeric"});

      // Colour scheme
      var bg=expired?"#fef2f2":duesSoon?"#fff7ed":"#f0fdf4";
      var border=expired?"#fca5a5":duesSoon?"#fcd34d":"#86efac";
      var color=expired?"#dc2626":duesSoon?"#d97706":"#16a34a";
      var icon=expired?"üî¥":duesSoon?"üü†":"üü¢";
      var statusLabel=expired?"EXPIRED ‚Äî Immediate Action Required":duesSoon?"Due for Review Within 60 Days":"Current";
      var daysMsg=expired?"Expired "+Math.abs(daysLeft)+" day"+(Math.abs(daysLeft)!==1?"s":"")+" ago":duesSoon?"Expires in "+daysLeft+" day"+(daysLeft!==1?"s":""):"Expires in "+daysLeft+" days";

      h+='<div style="background:'+bg+';border:2px solid '+border+';border-radius:10px;padding:14px 18px;margin-bottom:16px;display:flex;align-items:flex-start;gap:14px">';
      h+='<div style="font-size:26px;flex-shrink:0;margin-top:1px">üß†</div>';
      h+='<div style="flex:1">';
      h+='<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:6px">';
      h+='<span style="font-size:13px;font-weight:900;color:'+color+'">Positive Behaviour Support Plan (PBSP)</span>';
      h+='<span style="font-size:10px;font-weight:800;background:'+color+';color:#fff;padding:2px 10px;border-radius:20px;white-space:nowrap">'+icon+' '+esc(statusLabel)+'</span>';
      h+='</div>';
      h+='<div style="display:flex;flex-wrap:wrap;gap:16px">';
      h+='<div><div style="font-size:9px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Expiry / Review Date</div>';
      h+='<div style="font-size:12px;font-weight:700;color:'+color+'">üìÖ '+esc(dateStr)+'</div></div>';
      h+='<div><div style="font-size:9px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Status</div>';
      h+='<div style="font-size:12px;font-weight:700;color:'+color+'">'+esc(daysMsg)+'</div></div>';
      if(pbspFileName){
        h+='<div><div style="font-size:9px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Document on File</div>';
        h+='<div style="font-size:11px;color:#374151;font-weight:600">üìé '+esc(pbspFileName)+'</div></div>';
      }
      h+='</div>';
      if(expired){
        h+='<div style="margin-top:8px;font-size:11px;color:#991b1b;font-weight:600">‚ö†Ô∏è This PBSP has expired. Delta Community Support must arrange an urgent review with the registered Behaviour Support Practitioner. The NDIS (Restrictive Practices and Behaviour Support) Rules 2018 require an approved, current PBSP if regulated restrictive practices are in use.</div>';
      } else if(duesSoon){
        h+='<div style="margin-top:8px;font-size:11px;color:#92400e;font-weight:600">Action required: Contact the Behaviour Support Practitioner to schedule the upcoming PBSP review before the expiry date.</div>';
      }
      h+='</div></div>';
    })();


// ‚ïê‚ïê INCIDENTS ‚ïê‚ïê
    if(tables.indexOf("IR Reports 2025")>=0){
      var icolor=incRows.length>0&&repCount>0?"#ef4444":"#f59e0b";
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("‚ö†Ô∏è","Incident Reports",incRows.length,icolor);
      if(incRows.length===0){
        h+='<div style="padding:20px;text-align:center"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div><div style="font-size:13px;font-weight:700;color:#10b981">No incidents recorded</div><div style="font-size:11px;color:#94a3b8;margin-top:4px">'+esc(cn)+' experienced a safe, incident-free reporting period.</div></div>';
      }else{
        h+='<div style="padding:14px">';
        // ‚îÄ‚îÄ BAR CHART 1: Incidents by Month (all months in period shown) ‚îÄ‚îÄ
        (function(){
          // ‚îÄ‚îÄ INCIDENTS BY WEEK chart ‚îÄ‚îÄ
          // Build full week range from report period
          function parseIRDate(v){
            if(!v)return null;
            if(v.match(/^\d{4}-/))return new Date(v);
            if(v.indexOf('/')>=0){
              var p=v.split(/[\s,]+/);var dp=p[0].split('/');
              if(dp.length===3){var yr=dp[2];if(yr.length===2)yr=(parseInt(yr)>50?'19':'20')+yr;
                var d=new Date(yr+'-'+('0'+dp[1]).slice(-2)+'-'+('0'+dp[0]).slice(-2));
                if(p[1]){var tm=p[1].match(/(\d+):(\d+)\s*(am|pm)?/i);if(tm){var hr=parseInt(tm[1]),mn=parseInt(tm[2]);if(tm[3]&&tm[3].toLowerCase()==='pm'&&hr<12)hr+=12;if(tm[3]&&tm[3].toLowerCase()==='am'&&hr===12)hr=0;d.setHours(hr,mn);}}
                return isNaN(d)?null:d;}
            }
            var d=new Date(v.replace(/(\d)(am|pm)/i,'$1 $2'));
            return isNaN(d)?null:d;
          }
          function getWeekLabel(d){
            // Get Monday of the week
            var day=d.getDay(); // 0=Sun
            var diff=d.getDate()-(day===0?6:day-1);
            var mon=new Date(d);mon.setDate(diff);mon.setHours(0,0,0,0);
            return ('0'+mon.getDate()).slice(-2)+'/'+('0'+(mon.getMonth()+1)).slice(-2)+'/'+mon.getFullYear();
          }
          function getWeekStart(dateStr){
            var parts=dateStr.split('/');
            return new Date(parts[2],parts[1]-1,parts[0]);
          }
          // Build week range
          var weekLabels=[];var weekCounts={};
          try{
            var dFrom=new Date(from);var dTo=new Date(to);
            // Start from Monday of the from week
            var startDay=dFrom.getDay();var startDiff=dFrom.getDate()-(startDay===0?6:startDay-1);
            var cur=new Date(dFrom);cur.setDate(startDiff);cur.setHours(0,0,0,0);
            while(cur<=dTo){
              var lbl=getWeekLabel(cur);
              weekLabels.push(lbl);weekCounts[lbl]=0;
              cur=new Date(cur.getTime()+7*24*60*60*1000);
            }
          }catch(e){}
          // Count incidents into weeks
          incRows.forEach(function(rec){
            var f=rec.fields||{};
            var dt=fv(f,'Date & Time of Incident FORMULA')||fv(f,'Date & Time of Incident')||fv(f,'Date')||'';
            if(!dt)return;
            var d=parseIRDate(dt);if(!d)return;
            var key=getWeekLabel(d);
            if(weekCounts.hasOwnProperty(key))weekCounts[key]++;
            else{weekCounts[key]++;if(weekLabels.indexOf(key)<0)weekLabels.push(key);}
          });
          if(weekLabels.length===0)return;
          weekLabels.sort(function(a,b){return getWeekStart(a)-getWeekStart(b);});
          var vals=weekLabels.map(function(l){return weekCounts[l]||0;});
          var maxVal=Math.max.apply(null,vals)||1;
          var totalInc=vals.reduce(function(a,b){return a+b},0);
          // Peak week
          var peakIdx=vals.indexOf(maxVal);
          h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:14px 16px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)">';
          h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">';
          h+='<div style="font-size:11px;font-weight:800;color:#ef4444;text-transform:uppercase;letter-spacing:.7px">üìä Incidents by Week</div>';
          h+='<div style="display:flex;align-items:center;gap:10px">';
          h+='<span style="font-size:10px;font-weight:600;color:#64748b">'+totalInc+' total ¬∑ '+weekLabels.length+' weeks</span>';
          if(peakIdx>=0&&maxVal>0)h+='<span style="font-size:9px;background:#fef2f2;color:#ef4444;border:1px solid #fecaca;padding:2px 8px;border-radius:10px;font-weight:700">‚ö° Peak: w/c '+weekLabels[peakIdx]+' ('+maxVal+')</span>';
          h+='</div>';
          h+='</div>';
          // Chart bars ‚Äî responsive horizontal scroll if many weeks
          h+='<div style="overflow-x:auto;padding-bottom:4px">';
          h+='<div style="display:flex;align-items:flex-end;gap:4px;height:110px;min-width:'+(weekLabels.length*52)+'px">';
          weekLabels.forEach(function(lbl,i){
            var v=vals[i];
            var pct=Math.round((v/maxVal)*100);
            var barH=Math.max(pct*0.9,v>0?10:3);
            var isPeak=i===peakIdx&&v>0;
            var barColor=isPeak?'#dc2626':v>0?'#ef4444':'#e2e8f0';
            var textColor=isPeak?'#dc2626':v>0?'#ef4444':'#94a3b8';
            // Week label: "22 Jan\n(W4)"
            var ws=getWeekStart(lbl);
            var shortLbl=('0'+ws.getDate()).slice(-2)+' '+ws.toLocaleString('en-AU',{month:'short'});
            h+='<div style="display:flex;flex-direction:column;align-items:center;flex:0 0 48px;gap:3px">';
            h+='<div style="font-size:10px;font-weight:700;color:'+textColor+'">'+(v>0?v:'')+' </div>';
            h+='<div style="width:38px;background:'+barColor+';border-radius:4px 4px 0 0;height:'+barH+'px;position:relative">';
            if(isPeak)h+='<div style="position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-size:9px">üî¥</div>';
            h+='</div>';
            h+='<div style="font-size:8px;color:#64748b;text-align:center;line-height:1.3;margin-top:2px">'+esc(shortLbl)+'</div>';
            h+='</div>';
          });
          h+='</div>';
          h+='</div>';
          h+='</div>';
        })();
        // ‚îÄ‚îÄ BAR CHART 2: Escalation Reasons ‚îÄ‚îÄ
        (function(){
          var catCounts={};
          var escalationFields=['Incident Categories (Multi-select)','Incident Categories','Category','Incident Type','Type of Incident','Behaviour Category','Escalation Reason','Reason','Incident Reason'];
          incRows.forEach(function(rec){
            var f=rec.fields||{};
            var cat='';
            for(var i=0;i<escalationFields.length;i++){var v=fv(f,escalationFields[i]);if(v){cat=v;break;}}
            if(!cat)cat='Unclassified';
            // Handle comma-separated multi-values
            var parts=String(cat).split(/[,;|\/]/);
            parts.forEach(function(p){
              var t=p.trim();
              if(t)catCounts[t]=(catCounts[t]||0)+1;
            });
          });
          var labels=Object.keys(catCounts);
          if(labels.length===0)return;
          labels.sort(function(a,b){return catCounts[b]-catCounts[a];});
          var top=labels.slice(0,8);
          var maxVal=catCounts[top[0]]||1;
          h+='<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:14px 16px;margin-bottom:14px">';
          h+='<div style="font-size:10px;font-weight:800;color:#f59e0b;text-transform:uppercase;letter-spacing:.7px;margin-bottom:10px">üìä Escalation Reasons</div>';
          top.forEach(function(lbl){
            var pct=Math.round((catCounts[lbl]/maxVal)*100);
            var barW=Math.max(pct,4);
            h+='<div style="margin-bottom:8px">';
            h+='<div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px">';
            h+='<span style="color:#374151;font-weight:600;max-width:75%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(lbl)+'</span>';
            h+='<span style="color:#f59e0b;font-weight:700">'+catCounts[lbl]+'</span>';
            h+='</div>';
            h+='<div style="background:#e2e8f0;border-radius:4px;height:10px;overflow:hidden">';
            h+='<div style="width:'+barW+'%;background:linear-gradient(90deg,#f59e0b,#fbbf24);height:100%;border-radius:4px;transition:width .4s"></div>';
            h+='</div></div>';
          });
          h+='</div>';
        })();
        if(repCount>0)h+='<div style="padding:10px 14px;background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.15);border-radius:8px;margin-bottom:10px;font-size:12px;color:#ef4444;font-weight:700">üî¥ '+repCount+' NDIS Reportable Incident'+(repCount!==1?"s":"")+ ' ‚Äî Mandatory notification to the Quality &amp; Safeguards Commission required</div>';
        incRows.forEach(function(rec,irIdx){
          var f=rec.fields||{};
          var irRef=fv(f,"Unique IR #")||fv(f,"IR Reference")||fv(f,"Reference")||("#"+(irIdx+1));
          var dt=fv(f,"Date & Time of Incident FORMULA")||fv(f,"Date & Time of Incident")||fv(f,"Date")||"";
          var cats=fv(f,"Incident Categories (Multi-select)")||fv(f,"Incident Categories")||fv(f,"Category")||"";
          var reporter=fv(f,"Full Name (from Person completing IR)")||fv(f,"Person completing IR")||"";
          var summary=fv(f,"Summarise the incident and/or allegation (without reference to peoples names).")||fv(f,"Description")||fv(f,"Summary")||"";
          var why=fv(f,"WHY do you believe the incident occurred?")||"";
          var improvements=fv(f,"What steps do you think we could take to minimise the risk or harm or so this incident never occurrs?")||fv(f,"What could have been done better")||"";
          var isRep=String(fv(f,"Is this a Reportable Incident to the NDIS Quality Safeguards Commission??")||"").toLowerCase().indexOf("yes")>=0;
          // ‚îÄ‚îÄ NDIS Commission Reportability Assessment ‚îÄ‚îÄ
          // Per NDIS (Incidents Management and Reportable Incidents) Rules 2018
          // 7 categories: death, serious injury, abuse/neglect, unlawful sexual/physical contact,
          // sexual misconduct, unauthorised restrictive practice, unexplained absence
          var ndisClass=(function(){
            var allText=[
              cats,summary,why,improvements,
              fv(f,"Describe what happened")||"",
              fv(f,"What happened")||"",
              fv(f,"Description of Incident")||""
            ].join(" ").toLowerCase();

            // Category 1: Death
            if(/\b(death|deceased|died|passed away|fatal)\b/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Death of a person with disability",color:"#991b1b",bg:"#fee2e2",icon:"üî¥"};

            // Category 2: Serious injury requiring emergency treatment
            if(/\b(ambulance|hospital|emergency|serious injur|fracture|broken bone|unconscious|unresponsive|critical|resuscitat|icu|intensive care)\b/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Serious injury requiring emergency medical treatment (ambulance/hospitalisation)",color:"#b91c1c",bg:"#fee2e2",icon:"üî¥"};

            // Category 3: Abuse or neglect by a worker or another person
            if(/\b(neglect|abuse|neglected|abused|harm|exploitation|financial abuse|emotional abuse|physical abuse|psychological abuse)\b/.test(allText) && !/client (was|became|is|feels|felt)\s+(verbally )?abus/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Abuse or neglect of a person with disability by a worker or third party",color:"#b91c1c",bg:"#fee2e2",icon:"üî¥"};

            // Category 4: Unlawful physical contact or assault (by worker)
            if(/\b(assaulted|assault by|hit by (staff|worker|carer)|struck|punched|kicked by (staff|worker))\b/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Unlawful physical contact or assault by a support worker",color:"#b91c1c",bg:"#fee2e2",icon:"üî¥"};

            // Category 5: Sexual misconduct
            if(/\b(sexual|rape|sexually|inappropriate touch|indecent|exploitation sexual)\b/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Sexual misconduct or unlawful sexual contact with a person with disability",color:"#b91c1c",bg:"#fee2e2",icon:"üî¥"};

            // Category 6: Unauthorised restrictive practice
            if(/\b(restrain|restricted|locked|seclud|chemical restrain|physical restrain|unauthori[sz]ed restrictive|restrictive practice)\b/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Use of a restrictive practice not authorised in an approved Behaviour Support Plan",color:"#c2410c",bg:"#fff7ed",icon:"üü†"};

            // Category 7: Unexplained absence / elopement
            if(/\b(missing|elopement|eloped|unexplained absence|could not locate|went missing|absconded)\b/.test(allText))
              return{rep:true,label:"Reportable ‚Äî Unexplained absence of a person with disability from a service",color:"#c2410c",bg:"#fff7ed",icon:"üü†"};

            // NOT reportable ‚Äî classify by type
            if(/medication error|missed dose|wrong medication|wrong med/.test(allText))
              return{rep:false,label:"Internal incident ‚Äî Medication error; reportable only if the person suffered serious harm requiring emergency treatment",color:"#065f46",bg:"#f0fdf4",icon:"üü¢"};

            if(/\b(verbally abusive|aggressive|challenging behaviour|behaviour of concern|abusive|refused|yelling|screaming)\b/.test(allText))
              return{rep:false,label:"Internal incident ‚Äî Client challenging behaviour; reportable only if a restrictive practice was used or serious injury resulted",color:"#065f46",bg:"#f0fdf4",icon:"üü¢"};

            if(/\b(client refuses|refusing medication|refused medication|refused meds)\b/.test(allText))
              return{rep:false,label:"Internal incident ‚Äî Client refused medication; not reportable unless serious harm or emergency treatment followed",color:"#065f46",bg:"#f0fdf4",icon:"üü¢"};

            if(/\b(fall|fell|slipped|tripped)\b/.test(allText))
              return{rep:false,label:"Internal incident ‚Äî Client fall; reportable only if serious injury required emergency or hospital treatment",color:"#065f46",bg:"#f0fdf4",icon:"üü¢"};

            if(/\b(sleep|sleepover|not sleeping|awake|inactive)\b/.test(allText))
              return{rep:false,label:"Internal incident ‚Äî Sleepover disturbance; not a reportable incident under NDIS Commission Rules 2018",color:"#065f46",bg:"#f0fdf4",icon:"üü¢"};

            return{rep:false,label:"Internal incident ‚Äî Does not meet the 7 reportable incident categories under NDIS (Incidents Management and Reportable Incidents) Rules 2018",color:"#065f46",bg:"#f0fdf4",icon:"üü¢"};
          })();
          // Override isRep if our assessment says truly reportable
          if(ndisClass.rep) isRep=true;

          var dtFormatted=(function(){
            if(!dt)return'No date recorded';
            // parseIRDate may not be in scope here - inline it
            var d;
            if(dt.match(/^\d{4}-/)){d=new Date(dt);}
            else if(dt.indexOf('/')>=0){
              var p=dt.split(/[\s,]+/),dp=p[0].split('/');
              if(dp.length===3){var yr=dp[2];if(yr.length===2)yr=(parseInt(yr)>50?'19':'20')+yr;
                d=new Date(yr+'-'+('0'+dp[1]).slice(-2)+'-'+('0'+dp[0]).slice(-2));}
              if(p[1]&&d&&!isNaN(d)){var tm=p[1].match(/(\d+):(\d+)\s*(am|pm)?/i);if(tm){var hr=parseInt(tm[1]),mn=parseInt(tm[2]);if(tm[3]&&tm[3].toLowerCase()==='pm'&&hr<12)hr+=12;if(tm[3]&&tm[3].toLowerCase()==='am'&&hr===12)hr=0;d.setHours(hr,mn);}}
            } else {d=new Date(dt.replace(/(\d)(am|pm)/i,'$1 $2'));}
            if(!d||isNaN(d))return dt;
            return d.toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'})+' '+d.toLocaleTimeString('en-AU',{hour:'numeric',minute:'2-digit',hour12:true});
          })();

          h+='<div style="background:'+(isRep?"rgba(239,68,68,.03)":"#fff")+';border:1px solid '+(isRep?"rgba(239,68,68,.2)":"#e8edf2")+';border-radius:12px;margin-bottom:12px;overflow:hidden">';

          // Header strip
          h+='<div style="padding:10px 14px;background:'+(isRep?"rgba(239,68,68,.06)":"#f8fafc")+';border-bottom:1px solid '+(isRep?"rgba(239,68,68,.15)":"#e2e8f0")+';display:flex;align-items:center;flex-wrap:wrap;gap:8px">';
          h+='<span style="font-size:11px;font-weight:800;color:'+(isRep?"#ef4444":"#374151")+'">IR Ref: '+esc(String(irRef))+'</span>';
          h+='<span style="font-size:11px;font-weight:700;color:#1E4BA0">'+esc(dtFormatted)+'</span>';
          if(cats)h+='<span style="font-size:10px;padding:2px 8px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);border-radius:10px;color:#b45309;font-weight:600">'+esc(cats)+'</span>';
          if(isRep)h+=badge("üî¥ NDIS Reportable","#ef4444","rgba(239,68,68,.08)");
          // NDIS Commission one-line assessment
          h+='<div style="margin:8px 14px 0;padding:6px 10px;background:'+ndisClass.bg+';border-left:3px solid '+ndisClass.color+';border-radius:0 6px 6px 0;font-size:10px;color:'+ndisClass.color+';font-weight:600">'+ndisClass.icon+' <em>NDIS Commission Assessment:</em> '+esc(ndisClass.label)+'</div>';
          h+='</div>';

          // Reporter
          if(reporter){
            h+='<div style="padding:8px 14px;border-bottom:1px solid #f1f5f9;font-size:11px;color:#64748b">';
            h+='<span style="font-weight:700;color:#374151">Reported by: </span>'+esc(reporter);
            h+='</div>';
          }

          // Incident body - 3 fields
          h+='<div style="padding:12px 14px;display:flex;flex-direction:column;gap:10px">';

          if(summary){
            h+='<div>';
            h+='<div style="font-size:9px;font-weight:800;color:#f59e0b;text-transform:uppercase;letter-spacing:.7px;margin-bottom:4px">üìã What Happened</div>';
            h+='<div style="font-size:12px;color:#374151;line-height:1.7;background:#fafbfc;border-left:3px solid #f59e0b;padding:8px 12px;border-radius:0 6px 6px 0">'+esc(summary.substring(0,600))+(summary.length>600?"‚Ä¶":"")+'</div>';
            h+='</div>';
          }

          if(why){
            h+='<div>';
            h+='<div style="font-size:9px;font-weight:800;color:#6366f1;text-transform:uppercase;letter-spacing:.7px;margin-bottom:4px">üîç Why It Occurred</div>';
            h+='<div style="font-size:12px;color:#374151;line-height:1.7;background:#f8f8ff;border-left:3px solid #6366f1;padding:8px 12px;border-radius:0 6px 6px 0">'+esc(why.substring(0,400))+(why.length>400?"‚Ä¶":"")+'</div>';
            h+='</div>';
          }

          if(improvements){
            h+='<div>';
            h+='<div style="font-size:9px;font-weight:800;color:#10b981;text-transform:uppercase;letter-spacing:.7px;margin-bottom:4px">‚úÖ What Could Be Done Better</div>';
            h+='<div style="font-size:12px;color:#374151;line-height:1.7;background:rgba(16,185,129,.04);border-left:3px solid #10b981;padding:8px 12px;border-radius:0 6px 6px 0">'+esc(improvements.substring(0,400))+(improvements.length>400?"‚Ä¶":"")+'</div>';
            h+='</div>';
          }

          h+='</div></div>';
        });
        h+='</div>';
      }
      h+='</div>';
    }



    // ‚ïê‚ïê CLIENT DOCS ‚ïê‚ïê
    if(tables.indexOf("Client Docs")>=0&&clientDocRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üìÑ","Client Documents",clientDocRows.length,"#64748b");
      h+='<div style="padding:14px;display:flex;flex-direction:column;gap:8px">';
      clientDocRows.forEach(function(rec){
        var f=rec.fields||{};
        var docType=fv(f,"Type of Document")||fv(f,"Document Type")||fv(f,"Type")||"Document";
        var expRaw=fv(f,"Expiry Date of Document")||fv(f,"Expiry Date")||fv(f,"Review Date")||"";
        var updRaw=fv(f,"Last Updated")||fv(f,"Last Modified")||fv(f,"Date")||"";
        var updatedBy=fv(f,"Updated by")||fv(f,"Updated By")||fv(f,"Last Updated By")||"";
        var statusDoc=fv(f,"Status of Doc")||fv(f,"Status")||"";
        var uniqueRef=fv(f,"Unique Ref #")||fv(f,"Unique Ref")||"";
        var att=f["File Upload"]||f["Attachments"]||f["Document"]||[];
        var attName="";
        if(Array.isArray(att)&&att.length>0) attName=att[0].filename||att[0].name||att[0].url||"";
        else if(typeof att==="string") attName=att;

        var expired=false,expDateStr="",expColor="#64748b";
        if(expRaw){
          var expD=new Date(expRaw);
          if(!isNaN(expD)){
            expDateStr=expD.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"});
            expired=expD<new Date();
            expColor=expired?"#dc2626":((expD-new Date())<60*86400000?"#d97706":"#16a34a");
          }
        }
        var isPBSP=docType.toLowerCase().indexOf("pbsp")>=0||docType.toLowerCase().indexOf("behaviour support")>=0;

        h+='<div style="background:'+(isPBSP?"#f5f3ff":"#f8fafc")+';border:1px solid '+(isPBSP?"#ddd6fe":"#e2e8f0")+';border-left:3px solid '+(isPBSP?"#8b5cf6":expColor)+';border-radius:8px;padding:10px 14px">';
        h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:4px">';
        h+='<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">';
        h+='<div style="font-size:12px;font-weight:800;color:#1e293b">'+(isPBSP?"üß† ":"üìÑ ")+esc(docType)+'</div>';
        if(uniqueRef) h+='<span style="font-size:9px;color:#94a3b8;font-weight:600;background:#f1f5f9;padding:1px 6px;border-radius:4px">'+esc(uniqueRef)+'</span>';
        if(statusDoc){var sc=statusDoc.toLowerCase()==="active"?"#16a34a":statusDoc.toLowerCase().indexOf("expir")>=0?"#dc2626":"#64748b";h+='<span style="font-size:9px;font-weight:700;color:'+sc+';background:'+sc+'18;padding:1px 8px;border-radius:10px;text-transform:uppercase">'+esc(statusDoc)+'</span>';}
        h+='</div>';
        if(expDateStr){
          h+='<div style="font-size:10px;font-weight:700;color:'+expColor+'">';
          if(expired) h+='üî¥ Expired: '+esc(expDateStr);
          else h+='üìÖ Expires: '+esc(expDateStr);
          h+='</div>';
        }
        h+='</div>';
        if(attName) h+='<div style="font-size:10px;color:#64748b;margin-top:2px">üìé '+esc(attName)+'</div>';
        if(updRaw||updatedBy){
          var updStr="";
          if(updRaw){try{var ud=new Date(updRaw);if(!isNaN(ud))updStr=ud.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"});}catch(e){updStr=updRaw;}}
          h+='<div style="font-size:10px;color:#94a3b8;margin-top:3px">Last updated'+(updStr?" "+updStr:"")+(updatedBy?" by "+esc(updatedBy):"")+'</div>';
        }
        h+='</div>';
      });
      h+='</div></div>';
    }

    // ‚ïê‚ïê PBSP TABLE (dedicated Airtable PBSP table) ‚ïê‚ïê
    if(tables.indexOf("PBSP")>=0&&pbspRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üß†","PBSP ‚Äî Positive Behaviour Support Plan",pbspRows.length,"#8b5cf6");
      h+='<div style="padding:14px;display:flex;flex-direction:column;gap:10px">';
      pbspRows.forEach(function(rec){
        var f=rec.fields||{};
        // Find all text fields
        var textFields=["Behaviours of Concern","Strategies","De-escalation Strategies","Triggers","Goals","Function of Behaviour","Restrictive Practices","Authorised Restrictive Practices","Status","Review Date","Next Review Date","Practitioner","Behaviour Practitioner","PBSP Prac Name","Notes","Summary","Description"];
        h+='<div style="background:#f5f3ff;border:1px solid #ddd6fe;border-radius:8px;padding:12px">';
        var hasContent=false;
        textFields.forEach(function(tf){
          var v=fv(f,tf);
          if(!v)return;
          hasContent=true;
          var isDate=/date|review|expir/i.test(tf);
          var dateStr="";
          if(isDate){try{var d=new Date(v);if(!isNaN(d)){var expired2=d<new Date();dateStr=d.toLocaleDateString("en-AU",{day:"numeric",month:"long",year:"numeric"})+(expired2?" üî¥ EXPIRED":"");}}catch(e){}}
          h+='<div style="margin-bottom:8px">';
          h+='<div style="font-size:9px;font-weight:800;color:#7c3aed;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">'+esc(tf)+'</div>';
          h+='<div style="font-size:11px;color:#374151;line-height:1.5">'+esc(dateStr||String(v).substring(0,400))+'</div>';
          h+='</div>';
        });
        if(!hasContent){
          // Fall back to showing any available fields
          Object.keys(f).slice(0,10).forEach(function(k){
            var v=fv(f,k);if(!v)return;
            h+='<div style="margin-bottom:6px"><div style="font-size:9px;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:.5px">'+esc(k)+'</div><div style="font-size:11px;color:#374151">'+esc(String(v).substring(0,300))+'</div></div>';
          });
        }
        h+='</div>';
      });
      h+='</div></div>';
    }


    
    if(tables.indexOf("Risk Register")>=0&&riskRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("‚ö°","Risk Register",riskRows.length,"#f59e0b");
      h+='<div style="padding:14px">';
      riskRows.forEach(function(rec){
        var f=rec.fields||{};
        var title=fv(f,"Risk Title")||fv(f,"Risk")||fv(f,"Description")||"Unnamed Risk";
        var sev=fv(f,"Severity")||fv(f,"Risk Level")||"";
        var status=fv(f,"Status")||"";
        var mit=fv(f,"Mitigation")||fv(f,"Action")||"";
        var sl=String(sev).toLowerCase();
        var sc=sl.indexOf("high")>=0||sl.indexOf("extreme")>=0?"#ef4444":sl.indexOf("med")>=0?"#f59e0b":"#10b981";
        h+='<div style="padding:10px 12px;border-left:4px solid '+sc+';border-radius:0 8px 8px 0;margin-bottom:6px;border:1px solid #e8edf2;border-left-color:'+sc+';background:#fafbfc">';
        h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:'+(mit?'5':'0')+'px">';
        h+='<span style="font-size:12px;font-weight:700;color:#1a1a2e">'+esc(String(title))+'</span>';
        if(sev)h+=badge(String(sev),sc,sc+"12");
        if(status)h+='<span style="font-size:10px;color:#94a3b8;margin-left:auto">'+esc(String(status))+'</span>';
        h+='</div>';
        if(mit)h+='<div style="font-size:11px;color:#64748b"><strong>Mitigation:</strong> '+esc(String(mit).substring(0,250))+'</div>';
        h+='</div>';
      });
      h+='</div></div>';
    }

    // ‚ïê‚ïê HEALTH MONITORING (removed) ‚ïê‚ïê
    var healthSets=[];
    // Health monitoring section removed per user request
    if(false&&healthSets.length>0){
      var htotal=healthSets.reduce(function(a,t){return a+t.rows.length},0);
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üè•","Health Monitoring",htotal,"#10b981");
      h+='<div style="padding:14px">';
      healthSets.forEach(function(ht){
        h+='<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:800;color:#1a1a2e;text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">'+ht.icon+' '+esc(ht.name)+' <span style="font-size:10px;font-weight:600;padding:1px 8px;border-radius:8px;background:rgba(16,185,129,.08);color:#10b981;border:1px solid rgba(16,185,129,.15)">'+ht.rows.length+' records</span></div>';
        h+='<table style="width:100%;border-collapse:collapse;font-size:11px"><thead><tr style="background:#f8fafc"><th style="padding:6px 10px;text-align:left;font-weight:700;color:#64748b;font-size:10px;text-transform:uppercase;border-bottom:1px solid #e2e8f0">Date</th><th style="padding:6px 10px;text-align:left;font-weight:700;color:#64748b;font-size:10px;text-transform:uppercase;border-bottom:1px solid #e2e8f0">Result / Value</th><th style="padding:6px 10px;text-align:left;font-weight:700;color:#64748b;font-size:10px;text-transform:uppercase;border-bottom:1px solid #e2e8f0">Notes</th></tr></thead><tbody>';
        ht.rows.slice(0,30).forEach(function(rec,i){
          var f=rec.fields||{};
          var dt=fmtDateShort(fv(f,"Date")||fv(f,"Date & Time")||"");
          var val=fv(f,ht.valF)||fv(f,"Result")||fv(f,"Amount")||fv(f,"Total")||"";
          var note=fv(f,ht.noteF)||fv(f,"Notes")||fv(f,"Comments")||"";
          h+='<tr style="background:'+(i%2===0?'#fff':'#f8fafc')+'"><td style="padding:5px 10px;border-bottom:1px solid #e2e8f0;font-weight:600;color:#374151">'+esc(dt)+'</td><td style="padding:5px 10px;border-bottom:1px solid #e2e8f0;color:#374151">'+esc(String(val).substring(0,60))+'</td><td style="padding:5px 10px;border-bottom:1px solid #e2e8f0;color:#64748b">'+esc(String(note).substring(0,80))+'</td></tr>';
        });
        h+='</tbody></table></div>';
      });
      h+='</div></div>';
    }

    // ‚ïê‚ïê BEHAVIOUR DATA (for behaviour support reports) ‚ïê‚ïê
    if(tables.indexOf("QR Code Data - Behaviours")>=0&&behaviourRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üîç","Behaviour Monitoring Data",behaviourRows.length,"#f59e0b");
      var bkeys={};behaviourRows.slice(0,5).forEach(function(r){Object.keys(r.fields||{}).forEach(function(k){bkeys[k]=1})});
      var bk=Object.keys(bkeys).slice(0,8);
      h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px"><thead><tr style="background:#f8fafc">';
      bk.forEach(function(k){h+='<th style="padding:7px 12px;text-align:left;font-weight:700;color:#64748b;font-size:10px;text-transform:uppercase;border-bottom:2px solid #e2e8f0;white-space:nowrap">'+esc(k)+'</th>'});
      h+='</tr></thead><tbody>';
      behaviourRows.slice(0,50).forEach(function(rec,i){
        h+='<tr style="background:'+(i%2===0?'#fff':'#f8fafc')+'">';
        bk.forEach(function(k){var v=fv(rec.fields||{},k);if(v.length>60)v=v.substring(0,60)+"‚Ä¶";h+='<td style="padding:6px 12px;border-bottom:1px solid #e2e8f0;color:#374151">'+esc(v)+'</td>'});
        h+='</tr>';
      });
      h+='</tbody></table></div></div>';
    }

    // ‚ïê‚ïê COMPLAINTS ‚ïê‚ïê
    if(tables.indexOf("Complaints Register")>=0&&complaintRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üì¢","Complaints Register",complaintRows.length,"#8b5cf6");
      var ck={};complaintRows.slice(0,5).forEach(function(r){Object.keys(r.fields||{}).forEach(function(k){ck[k]=1})});
      var ckeys=Object.keys(ck).slice(0,8);
      h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px"><thead><tr style="background:#f8fafc">';
      ckeys.forEach(function(k){h+='<th style="padding:7px 12px;text-align:left;font-weight:700;color:#64748b;font-size:10px;text-transform:uppercase;border-bottom:2px solid #e2e8f0">'+esc(k)+'</th>'});
      h+='</tr></thead><tbody>';
      complaintRows.forEach(function(rec,i){
        h+='<tr style="background:'+(i%2===0?'#fff':'#f8fafc')+'">';
        ckeys.forEach(function(k){var v=fv(rec.fields||{},k);if(v.match&&v.match(/^\d{4}-\d{2}-\d{2}/))v=fmtDateShort(v);if(v.length>80)v=v.substring(0,80)+"‚Ä¶";h+='<td style="padding:6px 12px;border-bottom:1px solid #e2e8f0;color:#374151">'+esc(v)+'</td>'});
        h+='</tr>';
      });
      h+='</tbody></table></div></div>';
    }

    // ‚ïê‚ïê TASKS ‚ïê‚ïê
    if(tables.indexOf("Tasks")>=0&&taskRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("‚úÖ","Tasks",taskRows.length,"#10b981");
      h+='<div style="padding:10px 14px">';
      taskRows.slice(0,20).forEach(function(rec){
        var f=rec.fields||{};
        var title=fv(f,"Task")||fv(f,"Title")||fv(f,"Name")||fv(f,"Description")||"Untitled";
        var status=fv(f,"Status")||"";
        var due=fv(f,"Due Date")||fv(f,"Due")||"";
        var isDone=String(status).toLowerCase().indexOf("done")>=0||String(status).toLowerCase().indexOf("complet")>=0;
        h+='<div style="display:flex;align-items:center;gap:10px;padding:7px 8px;border-bottom:1px solid #f1f5f9"><span>'+(isDone?"‚úÖ":"üî≤")+'</span><div style="flex:1"><div style="font-size:12px;font-weight:600;color:#1a1a2e">'+esc(String(title).substring(0,100))+'</div>'+(due?'<div style="font-size:10px;color:#94a3b8">Due: '+esc(fmtDateShort(due))+'</div>':"")+'</div>'+badge(String(status),isDone?"#10b981":"#f59e0b",isDone?"rgba(16,185,129,.08)":"rgba(245,158,11,.08)")+'</div>';
      });
      h+='</div></div>';
    }

    // ‚ïê‚ïê CALENDAR ‚ïê‚ïê
    if(tables.indexOf("Client Calendar")>=0&&calRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üìÖ","Client Calendar",calRows.length,"#6366f1");
      h+='<div style="padding:12px 14px"><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px">';
      calRows.slice(0,20).forEach(function(rec){
        var f=rec.fields||{};
        var title=fv(f,"Event")||fv(f,"Title")||fv(f,"Name")||fv(f,"Activity")||"Event";
        var date=fv(f,"Date")||fv(f,"Start Date")||fv(f,"Date & Time")||"";
        var loc=fv(f,"Location")||fv(f,"Venue")||"";
        h+='<div style="padding:10px;background:#f8fafc;border:1px solid #e8edf2;border-radius:8px"><div style="font-size:11px;font-weight:700;color:#6366f1;margin-bottom:3px">'+esc(fmtDateShort(date))+'</div><div style="font-size:12px;font-weight:600;color:#1a1a2e">'+esc(String(title).substring(0,60))+'</div>'+(loc?'<div style="font-size:10px;color:#94a3b8;margin-top:2px">üìç '+esc(String(loc))+'</div>':"")+'</div>';
      });
      h+='</div></div></div>';
    }

    // ‚ïê‚ïê SUPPORT PLAN ‚ïê‚ïê
    if(tables.indexOf("Support Plan 2025")>=0&&supportPlanRows.length>0){
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üéØ","Support Plan",supportPlanRows.length,"#1E4BA0");
      h+='<div style="padding:14px">';
      supportPlanRows.slice(0,5).forEach(function(rec){
        var f=rec.fields||{};var keys=Object.keys(f).slice(0,8);
        h+='<div style="padding:12px;background:#f8fafc;border:1px solid #e8edf2;border-radius:8px;margin-bottom:8px">';
        keys.forEach(function(k){var v=fv(f,k);if(!v)return;h+='<div style="margin-bottom:5px"><span style="font-size:9px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.4px">'+esc(k)+'</span><div style="font-size:12px;color:#374151;margin-top:2px">'+esc(String(v).substring(0,300))+'</div></div>'});
        h+='</div>';
      });
      h+='</div></div>';
    }

    // ‚ïê‚ïê GENERIC TABLES ‚ïê‚ïê
    var handled=["Progress Notes","IR Reports 2025","Risk Register","Client Sleep Chart","Bowel Chart","Fluid Intake Diary","Tasks","Client Calendar","Client Core Budgets","Support Plan 2025","Conversations SMS & Calls","QR Code Data - Behaviours","Complaints Register","Client Contact Preferences","PBSP","Client Docs"];
    var icons2={"Client Docs":"üìÑ","SIL Site Visits":"üè†","SIL Induction Register":"üìã","Approved / Excluded Workers 2025":"üë∑","Internal Audit":"üîé","Client Contact Preferences":"üìû","Client SA & SOS":"üö®","Clients":"üë§"};
    tables.forEach(function(tk){
      if(handled.indexOf(tk)>=0)return;
      var rows=results[tk];if(!rows||rows.error)return;
      var crows=rows.filter(function(rec){return Object.keys(rec.fields||{}).some(function(k){return String(fv(rec.fields,k)).toLowerCase().indexOf(cn.toLowerCase())>=0})});
      if(crows.length===0)return;
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr(icons2[tk]||"üìã",tk,crows.length);
      var ak={};crows.slice(0,8).forEach(function(r){Object.keys(r.fields||{}).forEach(function(k){ak[k]=1})});
      var kk=Object.keys(ak).slice(0,9);
      h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px"><thead><tr style="background:#f8fafc">';
      kk.forEach(function(k){h+='<th style="padding:7px 12px;text-align:left;font-weight:700;color:#64748b;font-size:10px;text-transform:uppercase;border-bottom:2px solid #e2e8f0;white-space:nowrap">'+esc(k)+'</th>'});
      h+='</tr></thead><tbody>';
      crows.slice(0,100).forEach(function(rec,i){
        h+='<tr style="background:'+(i%2===0?'#fff':'#f8fafc')+'">';
        kk.forEach(function(k){var v=fv(rec.fields||{},k);if(v.match&&v.match(/^\d{4}-\d{2}-\d{2}/))v=fmtDateShort(v);if(v.length>80)v=v.substring(0,80)+"‚Ä¶";h+='<td style="padding:6px 12px;border-bottom:1px solid #e2e8f0;color:#374151;vertical-align:top">'+esc(v)+'</td>'});
        h+='</tr>';
      });
      h+='</tbody></table>'+(crows.length>100?'<div style="padding:7px 12px;font-size:10px;color:#94a3b8;text-align:center">Showing 100 of '+crows.length+' records</div>':"")+'</div></div>';
    });

    // ‚ïê‚ïê CONVERSATIONS ‚ïê‚ïê
    if(tables.indexOf("Conversations SMS & Calls")>=0){
      var conv=results["Conversations SMS & Calls"]||{};
      var allc=(conv.calls||[]),alls=(conv.sms||[]),tot=allc.length+alls.length;
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üí¨","SMS & Call History",tot,"#6366f1");
      if(tot===0){h+='<div style="padding:18px;text-align:center;font-size:12px;color:#94a3b8">No conversations recorded in this period.</div>'}
      else{
        h+='<div style="padding:12px">';
        if(allc.length>0){h+='<div style="font-size:10px;font-weight:800;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìû Calls ('+allc.length+')</div>';allc.slice(0,15).forEach(function(c){var io=c.type==="outbound";h+='<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:'+(io?"rgba(30,75,160,.03)":"rgba(10,147,150,.03)")+';border:1px solid '+(io?"rgba(30,75,160,.1)":"rgba(10,147,150,.1)")+';border-radius:8px;margin-bottom:5px"><span>'+(io?"üì§":"üì•")+'</span><div style="flex:1"><div style="font-size:11px;font-weight:600;color:#1a1a2e">'+(io?"Outbound":"Inbound")+' ‚Äî '+(c.duration||0)+'s</div><div style="font-size:10px;color:#94a3b8">'+(c.created_at||"").substring(0,16)+'</div></div>'+badge(c.status||"",c.status==="completed"?"#10b981":"#f59e0b","rgba(16,185,129,.07)")+'</div>'})}
        if(alls.length>0){h+='<div style="font-size:10px;font-weight:800;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;margin-top:'+(allc.length?'12px':'0')+'">üí¨ SMS ('+alls.length+')</div>';alls.slice(0,15).forEach(function(s){var io=s.direction==="outbound";h+='<div style="padding:7px 10px;background:#fafbfc;border:1px solid #e8edf2;border-radius:8px;margin-bottom:5px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">'+badge(io?"Sent":"Received",io?"#3b82f6":"#6366f1","rgba(99,102,241,.07)")+'<span style="font-size:10px;color:#94a3b8">'+(s.created_at||"").substring(0,16)+'</span></div><div style="font-size:11px;color:#374151">'+esc((s.body||"").substring(0,200))+'</div></div>'})}
        h+='</div>';
      }
      h+='</div>';
    }

    // ‚ïê‚ïê DATA SOURCES ‚ïê‚ïê
    (function(){
      var sourceMap={
        "Progress Notes":        {icon:"üìù", label:"Progress Notes",        desc:"Shift-by-shift observations, carer notes, incident triggers and wellbeing data.",          color:"#6366f1"},
        "IR Reports 2025":       {icon:"‚ö†Ô∏è", label:"Incident Reports",       desc:"Formal incident submissions including escalation reasons, reportability and resolutions.", color:"#ef4444"},
        "Risk Register":         {icon:"‚ö°", label:"Risk Register",          desc:"Active and resolved risk items with severity ratings and management strategies.",          color:"#f59e0b"},
        "Client Sleep Chart":    {icon:"üò¥", label:"Sleep Chart",            desc:"Overnight and daytime sleep tracking data.",                                               color:"#8b5cf6"},
        "Bowel Chart":           {icon:"ü©∫", label:"Bowel Chart",            desc:"Bowel monitoring records used for health trend analysis.",                                 color:"#10b981"},
        "Fluid Intake Diary":    {icon:"üíß", label:"Fluid Intake Diary",     desc:"Daily fluid intake logs for hydration monitoring.",                                       color:"#0ea5e9"},
        "Complaints Register":   {icon:"üì¢", label:"Complaints Register",    desc:"Formal complaints, feedback and resolution tracking.",                                    color:"#8b5cf6"},
        "Client Calendar":       {icon:"üìÖ", label:"Client Calendar",        desc:"Scheduled appointments, activities and community access.",                                color:"#6366f1"},
        "Client Core Budgets":   {icon:"üí∞", label:"Core Budgets",           desc:"NDIS funding allocations and budget utilisation data.",                                   color:"#1E4BA0"},
        "Support Plan 2025":     {icon:"üéØ", label:"Support Plan",           desc:"NDIS support plan goals, strategies and outcome targets.",                                color:"#1E4BA0"},
        "Clients":               {icon:"üë§", label:"Client Profile",         desc:"Core participant demographic, contact and stakeholder data from the client record.",      color:"#0a9396"},
        "Tasks":                 {icon:"‚úÖ", label:"Tasks",                   desc:"Action items, follow-ups and scheduled tasks assigned to the support team.",             color:"#10b981"},
        "Conversations SMS & Calls":{icon:"üí¨",label:"Calls & SMS",          desc:"Communication logs including inbound/outbound calls and SMS messages.",                  color:"#6366f1"},
        "SIL Site Visits":       {icon:"üè†", label:"SIL Site Visits",        desc:"Supported Independent Living site visit observations and compliance notes.",              color:"#f59e0b"}
      };
      var usedSources=tables.filter(function(t){return sourceMap[t];});
      // Always include Clients table (stakeholder data)
      if(usedSources.indexOf("Clients")<0)usedSources.unshift("Clients");
      if(usedSources.length===0)return;
      h+='<div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)">';
      h+=sectionHdr("üóÇÔ∏è","Data Sources",usedSources.length,"#64748b");
      h+='<div style="padding:14px">';
      h+='<div style="font-size:10px;color:#64748b;margin-bottom:12px">This report was generated using the following verified data sources from the Titus CRM, linked to Airtable. All records are filtered to the reporting period and client.</div>';
      h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:8px">';
      usedSources.forEach(function(tk){
        var src=sourceMap[tk];if(!src)return;
        h+='<div style="background:'+src.color+'06;border:1px solid '+src.color+'20;border-radius:8px;padding:10px 12px;display:flex;gap:10px;align-items:flex-start">';
        h+='<span style="font-size:18px;flex-shrink:0">'+src.icon+'</span>';
        h+='<div>';
        h+='<div style="font-size:11px;font-weight:700;color:'+src.color+';margin-bottom:2px">'+esc(src.label)+'</div>';
        h+='<div style="font-size:10px;color:#64748b;line-height:1.4">'+esc(src.desc)+'</div>';
        h+='</div>';
        h+='</div>';
      });
      h+='</div>';
      h+='<div style="margin-top:12px;padding-top:10px;border-top:1px solid #f1f5f9;font-size:9px;color:#94a3b8">';
      h+='üìä Titus CRM &nbsp;¬∑&nbsp; Airtable Base ID: appg3Cz7mEsGA6IOI &nbsp;¬∑&nbsp; Report generated: '+new Date().toLocaleDateString("en-AU",{day:"numeric",month:"long",year:"numeric"})+' &nbsp;¬∑&nbsp; Created by: <strong>'+esc(reportCreatedBy)+'</strong>';
      h+='</div>';
      h+='</div>';
      h+='</div>';
    })();

    h+='</div>'; // end client section
  });

  // sign-off removed per user request

  // ‚ïê‚ïê FOOTER ‚ïê‚ïê
  h+='<div style="margin-top:16px;padding:14px 20px;background:linear-gradient(135deg,'+aud.color+'08,'+aud.color+'04);border:1px solid '+aud.color+'18;border-radius:10px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">';
  h+='<div style="font-size:10px;color:#64748b">Prepared by <strong>'+esc(companyName)+'</strong> &nbsp;¬∑&nbsp; NDIS Provider No: <strong>'+esc(ndisProvider)+'</strong> &nbsp;¬∑&nbsp; Created by: <strong>'+esc(reportCreatedBy)+'</strong>'+(companyABN?' &nbsp;¬∑&nbsp; ABN: <strong>'+esc(companyABN)+'</strong>':'')+(companySuburb?' &nbsp;¬∑&nbsp; '+esc(companySuburb)+', '+esc(companyState):'')+'</div>';
  h+='<div style="font-size:10px;font-weight:700;color:'+aud.color+'">üîí '+esc(aud.confidentiality)+'</div>';
  h+='</div>';

  h+='</div>'; // end crReportContent
  return h;
}

function crPrint(){
  var area=document.getElementById("crReportContent");
  if(!area)return;
  var d=window._crCurrentData||{};
  var company=window._crCompany||{};
  var cn=company.tradingName||"Delta Community Support";
  var np=company.ndisProvider||"4050123456";
  var abn=company.abn||"";
  var AUDIENCE_CONFIG={
    stakeholder:{label:"Stakeholder Progress Report",color:"#0a9396"},
    guardian:{label:"Report to the Office of the Public Guardian",color:"#6366f1"},
    behaviour:{label:"Behaviour Support Report",color:"#f59e0b"},
    mentalhealth:{label:"Mental Health Nursing Report",color:"#10b981"},
    internal:{label:"Internal Operations Report",color:"#1E4BA0"},
    family:{label:"Family & Carer Update",color:"#8b5cf6"}
  };
  var aud=AUDIENCE_CONFIG[d.audience||"stakeholder"]||AUDIENCE_CONFIG.stakeholder;
  var title=(aud.label||"Customised Client Report")+" ‚Äî "+(d.clients||[]).join(", ");
  var w=window.open("","_blank");
  w.document.write('<!DOCTYPE html><html><head><title>'+title+'</title><meta charset="utf-8"><style>');
  w.document.write('*{margin:0;padding:0;box-sizing:border-box}');
  w.document.write('body{font-family:"Segoe UI",Arial,sans-serif;color:#1a1a2e;padding:24px 28px;font-size:11px;background:#fff}');
  w.document.write('table{width:100%;border-collapse:collapse}');
  w.document.write('th,td{padding:5px 8px;border:1px solid #e2e8f0;font-size:10px;text-align:left}');
  w.document.write('th{background:#f1f5f9;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:#475569}');
  w.document.write('tr:nth-child(even){background:#f9fafb}');
  w.document.write('img{max-width:120px;border-radius:4px}');
  w.document.write('[data-cr-hidden="true"],[data-cr-collapsed="true"] .cr-section-body{display:none!important}');
  w.document.write('@page{margin:12mm 14mm}');
  w.document.write('@media print{button,.no-print,.cr-chevron{display:none!important}[data-cr-hidden="true"]{display:none!important}}');
  w.document.write('</style></head><body>');
  // Only include visible (non-hidden) sections
  var clone = document.getElementById('crReportContent') ? document.getElementById('crReportContent').cloneNode(true) : (document.getElementById('crReportWrapper') ? document.getElementById('crReportWrapper').cloneNode(true) : null);
  if(clone){
    var hiddenSections = clone.querySelectorAll('[data-cr-hidden="true"]');
    hiddenSections.forEach(function(el){ el.parentNode && el.parentNode.removeChild(el); });
    var collapsedBodies = clone.querySelectorAll('.cr-section-body[style*="display:none"],.cr-section-body[style*="display: none"]');
    collapsedBodies.forEach(function(el){ el.parentNode && el.parentNode.removeChild(el.parentNode); });
    w.document.write(clone.outerHTML);
  }
  w.document.write('</body></html>');
  w.document.close();
  setTimeout(function(){w.print();},700);
}

// ‚îÄ‚îÄ Section toggle helpers ‚îÄ‚îÄ
function crToggleSection(hdrEl){
  var card = hdrEl.closest ? hdrEl.closest('[data-cr-section]') : null;
  if(!card){var el=hdrEl.parentNode;while(el&&!el.getAttribute('data-cr-section'))el=el.parentNode;card=el;}
  if(!card) return;
  var body = card.querySelector('.cr-section-body');
  if(!body) return;
  var isCollapsed = body.style.display==='none';
  body.style.display = isCollapsed ? '' : 'none';
  var chevron = hdrEl.querySelector('.cr-chevron');
  if(chevron) chevron.style.transform = isCollapsed ? '' : 'rotate(-90deg)';
  card.setAttribute('data-cr-collapsed', isCollapsed ? 'false' : 'true');
}

function crInitSectionToggles(){
  var content = document.getElementById('crReportContent');
  if(!content) return;
  var hdrs = content.querySelectorAll('[data-cr-section-hdr]');
  var sectionList = document.getElementById('crSectionList');
  var sections = [];
  hdrs.forEach(function(hdr){
    var card = hdr.parentNode;
    if(!card) return;
    var title = hdr.getAttribute('data-cr-section-hdr') || '';
    card.setAttribute('data-cr-section', title);
    var body = document.createElement('div');
    body.className = 'cr-section-body';
    var children = Array.prototype.slice.call(card.childNodes);
    var hdrFound = false;
    children.forEach(function(ch){
      if(ch === hdr){ hdrFound = true; return; }
      if(hdrFound) body.appendChild(ch);
    });
    if(body.childNodes.length > 0) card.appendChild(body);
    var badge = hdr.querySelector('span[style*="border-radius:20px"]');
    var countText = badge ? badge.textContent.trim() : '';
    sections.push({title:title, card:card, countText:countText});
  });
  if(sectionList && sections.length > 0){
    var html = '';
    sections.forEach(function(sec, i){
      var safeTitle = sec.title.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
      var id = 'cr-sec-'+i;
      html += '<div style="display:flex;align-items:center;gap:0;border-bottom:1px solid rgba(255,255,255,.05)">';
      html += '<label for="'+id+'" style="display:flex;align-items:center;gap:8px;padding:7px 14px;cursor:pointer;flex:1;user-select:none">';
      html += '<input type="checkbox" id="'+id+'" data-idx="'+i+'" checked ';
      html += 'style="width:14px;height:14px;cursor:pointer;accent-color:#00B4D8;flex-shrink:0" ';
      html += 'onclick="event.stopPropagation();crToggleSectionByIdx('+i+',this.checked)">';
      html += '<span style="font-size:11px;font-weight:600;color:rgba(255,255,255,.8);flex:1;line-height:1.3">'+safeTitle+'</span>';
      if(sec.countText) html += '<span style="font-size:9px;color:rgba(255,255,255,.3);flex-shrink:0;padding-left:4px">'+sec.countText+'</span>';
      html += '</label>';
      html += '<button onclick="crScrollToSectionIdx('+i+')" title="Jump to section" ';
      html += 'style="padding:4px 8px;background:transparent;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:10px;flex-shrink:0">‚Üó</button>';
      html += '</div>';
    });
    sectionList.innerHTML = html;
    window._crSections = sections;
  }
}

function crToggleSectionByIdx(idx, show){
  var sections = window._crSections || [];
  var sec = sections[idx];
  if(!sec) return;
  sec.card.setAttribute('data-cr-hidden', show ? 'false' : 'true');
  sec.card.style.display = show ? '' : 'none';
}

function crSelectAllSections(show){
  var checkboxes = document.querySelectorAll('#crSectionList input[type="checkbox"]');
  checkboxes.forEach(function(cb){
    cb.checked = show;
    crToggleSectionByIdx(parseInt(cb.getAttribute('data-idx')||'0'), show);
  });
}

function crScrollToSectionIdx(idx){
  var sections = window._crSections || [];
  var sec = sections[idx];
  if(!sec) return;
  if(sec.card.style.display === 'none'){
    // make visible first
    sec.card.style.display = '';
    var cb = document.querySelector('#crSectionList input[data-idx="'+idx+'"]');
    if(cb) cb.checked = true;
  }
  sec.card.scrollIntoView({behavior:'smooth', block:'start'});
}


function renderNdisReportsList() {
  var rp = document.getElementById('rightPanel');
  rp.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:#7c3aed;border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading NDIS reports...</div></div></div>';
  apiCall('GET', '/api/weekly-reports').then(function(data) {
    var records = Array.isArray(data) ? data : [];
    var h = '';
    // Header
    h += '<div style="background:linear-gradient(135deg,#1E4BA0,#7C3AED);padding:20px 24px;display:flex;align-items:center;justify-content:space-between">';
    h += '<div><div style="font-size:18px;font-weight:700;color:#fff">üìë NDIS Reports Archive</div>';
    h += '<div style="font-size:11px;color:rgba(255,255,255,.65);margin-top:2px">All generated NDIS Stakeholder Reports ‚Äî '+records.length+' records</div></div>';
    h += '<div style="display:flex;gap:8px">';
    h += '<button onclick="window._reportsSubView=\'menu\';renderReportsMenu()" style="padding:7px 14px;background:rgba(255,255,255,.15);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">‚Üê Back</button>';
    h += '<button onclick="renderNdisReportsList()" style="padding:7px 14px;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:8px;font-size:12px;cursor:pointer;font-family:inherit">üîÑ</button>';
    h += '</div></div>';
    // Search/filter bar
    h += '<div style="padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap">';
    h += '<input id="ndisRptSearch" type="text" placeholder="üîç Search client name..." oninput="filterNdisReports()" style="padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;outline:none;font-family:inherit;min-width:200px;flex:1">';
    h += '</div>';
    // Table
    h += '<div style="flex:1;overflow-y:auto;padding:0">';
    h += '<div style="overflow-x:auto"><table id="ndisRptTable" style="width:100%;border-collapse:collapse;font-size:12px">';
    h += '<thead><tr style="background:var(--surface2);border-bottom:2px solid var(--border)">';
    ['Client Name','Date Generated','Period From','Period To','Generated By','PDF'].forEach(function(col) {
      h += '<th style="padding:10px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>';
    });
    h += '</tr></thead><tbody id="ndisRptBody"></tbody></table></div></div>';
    rp.innerHTML = h;

    // Store data globally for filtering
    window._ndisReportsData = records;
    renderNdisReportsTable(records);
  }).catch(function(e) {
    rp.innerHTML = '<div style="padding:40px;text-align:center;color:var(--red)">Failed to load: '+e.message+'</div>';
  });
}

function renderNdisReportsTable(records) {
  var tbody = document.getElementById('ndisRptBody');
  if (!tbody) return;
  if (!records || records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="padding:40px;text-align:center;color:var(--muted);font-size:13px">No NDIS reports generated yet</td></tr>';
    return;
  }
  var rows = '';
  records.forEach(function(r) {
    var dateStr = r.dateCreated ? new Date(r.dateCreated).toLocaleDateString('en-AU', {day:'2-digit',month:'short',year:'numeric'}) : '‚Äî';
    var hasPDF = r.pdfUrl ? true : false;
    rows += '<tr style="border-bottom:1px solid var(--border);transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">'; 
    rows += '<td style="padding:11px 14px;font-weight:600;color:var(--text)">'+(r.clientName||'‚Äî')+'</td>';
    rows += '<td style="padding:11px 14px;color:var(--muted);white-space:nowrap">'+dateStr+'</td>';
    rows += '<td style="padding:11px 14px;color:var(--muted);font-size:11px;white-space:nowrap">'+(r.reportFrom||'‚Äî')+'</td>';
    rows += '<td style="padding:11px 14px;color:var(--muted);font-size:11px;white-space:nowrap">'+(r.reportTo||'‚Äî')+'</td>';
    rows += '<td style="padding:11px 14px;color:var(--muted);font-size:11px">'+(r.generatedBy||'‚Äî')+'</td>';
    rows += '<td style="padding:11px 14px">';
    if (hasPDF) rows += '<a href="'+r.pdfUrl+'" target="_blank" style="color:#7c3aed;font-size:11px;font-weight:600;text-decoration:none">üìÑ View PDF</a>';
    else rows += '<span style="color:var(--muted);font-size:11px">No PDF</span>';
    rows += '</td></tr>';
  });
  tbody.innerHTML = rows;
}

window.filterNdisReports = function() {
  var q = (document.getElementById('ndisRptSearch').value || '').toLowerCase();
  var data = (window._ndisReportsData || []).filter(function(r) {
    return !q || (r.clientName||'').toLowerCase().indexOf(q) >= 0 || (r.uniqueRef||'').toLowerCase().indexOf(q) >= 0;
  });
  renderNdisReportsTable(data);
};

function renderOpsReport(){var rp=document.getElementById("rightPanel");
var html='<div class="rp-hdr"><div class="rp-hdr-info"><div style="cursor:pointer;padding:6px 10px;border-radius:var(--rs);font-size:12px;font-weight:600;color:var(--muted);border:1px solid var(--border);margin-right:8px" onclick="window._reportsSubView=\'menu\';renderReportsMenu()">‚Üê Back</div><div><div class="rp-hdr-name">üìã Operations Report</div><div class="rp-hdr-sub">Internal management summary</div></div></div></div>';
html+='<div style="padding:20px;max-width:1200px">';
// Date range picker
html+='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:20px">';
html+='<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">Select Date Range</div>';
html+='<div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">';
html+='<div><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">From</label><input type="date" id="opsFrom" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:13px"></div>';
html+='<div><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">To</label><input type="date" id="opsTo" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:13px"></div>';
html+='<button class="btn btn-p" style="padding:8px 20px;font-size:13px" onclick="generateOpsReport()">Generate Report</button>';
html+='<div style="display:flex;gap:6px">';
html+='<button class="btn btn-s" style="font-size:11px;padding:6px 10px" onclick="setOpsPreset(\'7d\')">Last 7d</button>';
html+='<button class="btn btn-s" style="font-size:11px;padding:6px 10px" onclick="setOpsPreset(\'30d\')">Last 30d</button>';
html+='<button class="btn btn-s" style="font-size:11px;padding:6px 10px" onclick="setOpsPreset(\'90d\')">Last 90d</button>';
html+='</div></div></div>';
// Report content
html+='<div id="opsReportContent"><div style="text-align:center;padding:40px;color:var(--muted)"><div style="font-size:40px;margin-bottom:12px">üìã</div><div style="font-size:14px;font-weight:600">Select a date range and click Generate Report</div><div style="font-size:12px;margin-top:4px">The report will scan multiple Airtable tables and generate a comprehensive summary</div></div></div>';
html+='</div>';rp.innerHTML=html;
// Default to last 7 days
var now=new Date();var from=new Date(now-7*86400000);
document.getElementById("opsFrom").value=from.toISOString().split("T")[0];
document.getElementById("opsTo").value=now.toISOString().split("T")[0]}

function setOpsPreset(range){var now=new Date();var days=range==="7d"?7:range==="30d"?30:90;var from=new Date(now-days*86400000);document.getElementById("opsFrom").value=from.toISOString().split("T")[0];document.getElementById("opsTo").value=now.toISOString().split("T")[0]}

function generateOpsReport(){var from=document.getElementById("opsFrom").value;var to=document.getElementById("opsTo").value;if(!from||!to){alert("Please select both From and To dates");return}
window._opsReportFrom=from;window._opsReportTo=to;
var modal=document.createElement("div");modal.id="opsReportModal";
modal.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:rgba(0,0,0,.45);display:flex;flex-direction:column";
modal.innerHTML='<div style="background:var(--bg);flex:1;display:flex;flex-direction:column;overflow:hidden">'
+'<div style="padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0">'
+'<div style="display:flex;align-items:center;gap:10px"><button onclick="closeOpsModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:2px 6px" title="Close">‚úï</button><div style="font-size:15px;font-weight:800;color:var(--text)">Operations Report Preview</div></div>'
+'<div id="opsModalActions" style="display:flex;gap:8px"></div></div>'
+'<div id="opsModalBody" style="flex:1;overflow-y:auto;padding:20px;background:var(--bg)">'
+'<div style="text-align:center;padding:60px"><div class="spin" style="width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 16px"></div>'
+'<div style="font-size:15px;font-weight:700;color:var(--text)">Generating Operations Report...</div>'
+'<div style="font-size:12px;color:var(--muted);margin-top:8px">Scanning Progress Notes, Contacts, Incidents, Clients‚Ä¶</div>'
+'<div style="font-size:11px;color:var(--teal);margin-top:10px">This may take 15‚Äì30 seconds</div></div></div></div>';
document.body.appendChild(modal);document.body.style.overflow="hidden";
apiCall("POST","/api/ops-report",{from:from,to:to}).then(function(data){
if(data.error){document.getElementById("opsModalBody").innerHTML='<div style="text-align:center;padding:60px;color:var(--red)"><div style="font-size:36px;margin-bottom:12px">‚ö†Ô∏è</div>Error: '+data.error+'</div>';return}
document.getElementById("opsModalActions").innerHTML='<button onclick="downloadOpsPDF()" id="opsPdfBtn" class="btn btn-p" style="padding:7px 18px;font-size:12px;display:flex;align-items:center;gap:5px">üì• Download PDF</button><button onclick="window.print()" class="btn btn-s" style="padding:7px 12px;font-size:11px">üñ®Ô∏è Print</button>';
renderOpsReportResults(data,from,to);
}).catch(function(err){document.getElementById("opsModalBody").innerHTML='<div style="text-align:center;padding:60px;color:var(--red)"><div style="font-size:36px;margin-bottom:12px">‚ùå</div>Failed: '+err.message+'</div>'})}

function closeOpsModal(){var m=document.getElementById("opsReportModal");if(m){if(window._opsCharts){Object.keys(window._opsCharts).forEach(function(k){try{if(window._opsCharts[k])window._opsCharts[k].destroy()}catch(e){}});window._opsCharts={}}var _pill=document.getElementById("shModalPill");if(_pill)_pill.remove();m.remove();document.body.style.overflow=""}}

function renderOpsReportResults(data,from,to){
var el=document.getElementById("opsModalBody");
var fromD=new Date(from);var toD=new Date(to);
var rangeLabel=fromD.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+" ‚Äî "+toD.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"});
var genTime=new Date().toLocaleString("en-AU",{day:"numeric",month:"short",year:"numeric",hour:"numeric",minute:"2-digit",hour12:true});
if(window._opsCharts){Object.keys(window._opsCharts).forEach(function(k){try{if(window._opsCharts[k])window._opsCharts[k].destroy()}catch(e){}});window._opsCharts={}}else{window._opsCharts={}}
var s=data.summary||{};
function kpi(val,label,color,sub){return'<div style="padding:12px;background:'+color.replace(",1)",",0.04)")+';border:1px solid '+color.replace(",1)",",0.15)")+';border-radius:10px;text-align:center"><div style="font-size:22px;font-weight:800;color:'+color+'">'+val+'</div><div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-top:2px">'+label+'</div>'+(sub?'<div style="font-size:9px;color:var(--dim);margin-top:1px">'+sub+'</div>':'')+'</div>'}
var html='<div id="opsReportPrintArea" style="max-width:1100px;margin:0 auto">';
// ‚îÄ‚îÄ Header ‚îÄ‚îÄ
html+='<div style="background:linear-gradient(135deg,#0A9396,#1E4BA0);border-radius:12px;padding:24px 28px;margin-bottom:20px;color:#fff;display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:22px;font-weight:800;letter-spacing:-.3px">Delta Community Support</div><div style="font-size:14px;font-weight:600;opacity:.9;margin-top:4px">Operations Report</div><div style="font-size:12px;opacity:.75;margin-top:2px">'+rangeLabel+'</div></div><div style="text-align:right"><div style="font-size:10px;opacity:.7">Generated</div><div style="font-size:11px;font-weight:600">'+genTime+'</div></div></div>';
// ‚îÄ‚îÄ KPI Row 1: Service Delivery ‚îÄ‚îÄ
html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Service Delivery Overview</div>';
html+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px">';
html+=kpi(s.progressNotes||0,"Progress Notes","rgba(10,147,150,1)",(s.totalServiceHours?s.totalServiceHours+"h service":""));
html+=kpi(s.activeWorkers||0,"Active Workers","rgba(30,75,160,1)",(s.activeEmployees?s.activeEmployees+"E / "+s.activeContractors+"C":""));
html+=kpi(s.activeClients||0,"Active Clients","rgba(124,58,237,1)",(s.activeSIL||s.activeCAS?s.activeSIL+"SIL / "+s.activeCAS+"CAS":""));
html+=kpi(s.totalTransportTrips||0,"Transport Trips","rgba(245,158,11,1)",(s.totalKms?s.totalKms+"km":""));
html+=kpi(s.prospectClients||0,"Prospects","rgba(16,185,129,1)",(s.prospectSIL||s.prospectCAS?s.prospectSIL+"SIL / "+s.prospectCAS+"CAS":""));
html+='</div>';
// ‚îÄ‚îÄ KPI Row 2: Risk & Compliance ‚îÄ‚îÄ
html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Risk & Compliance</div>';
html+='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px">';
html+=kpi(s.incidents||0,"Incidents","rgba(239,68,68,1)",(s.reportableIncidents?s.reportableIncidents+" NDIS Reportable":""));
html+=kpi(s.risksOrConcerns||0,"Risks/Concerns","rgba(236,72,153,1)","from Progress Notes");
html+=kpi(s.sleepDisturbances||0,"Sleep Disturbances","rgba(245,158,11,1)","");
var saExp=(s.expiryByType&&s.expiryByType["Service Agreement"])?s.expiryByType["Service Agreement"].expired+"exp / "+s.expiryByType["Service Agreement"].expiring+"due":"";
html+=kpi(s.expiringAgreements||0,"Expiring Agreements","rgba(239,68,68,1)",saExp||"within 90 days");
html+=kpi(s.riskAssessExpired||0,"Risk Assess. Expired","rgba(168,85,247,1)",(s.riskAssessExpiring?s.riskAssessExpiring+" expiring soon":""));
html+='</div>';
// ‚îÄ‚îÄ KPI Row 3: Operations ‚îÄ‚îÄ
html+='<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Operations & Transport</div>';
html+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px">';
html+=kpi(s.totalKms||0,"KMs Claimed","rgba(245,158,11,1)","from Progress Notes");
html+=kpi(s.totalTransportTrips||0,"Transport Trips","rgba(10,147,150,1)","");
html+=kpi(s.scheduleOfSupport||0,"Schedule/Handover","rgba(30,75,160,1)","");
html+=kpi(s.pbspExpiring60d||0,"PBSP Reviews Due","rgba(168,85,247,1)","within 60 days");
html+='</div>';
// ‚îÄ‚îÄ Reportable Alert with Details ‚îÄ‚îÄ
if(s.reportableIncidents>0){
var repIncs=data.incidentDetails?data.incidentDetails.filter(function(i){return i.reportable}):[];
html+='<div style="padding:16px 18px;background:rgba(239,68,68,.06);border:2px solid rgba(239,68,68,.3);border-radius:10px;margin-bottom:16px">';
html+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px"><div style="font-size:28px">üö®</div><div><div style="font-size:14px;font-weight:800;color:var(--red)">'+s.reportableIncidents+' NDIS Reportable Incident'+(s.reportableIncidents>1?"s":"")+'</div><div style="font-size:11px;color:var(--muted);margin-top:2px">Must be reported to NDIS Quality & Safeguards Commission within 24hrs (immediate) and 5 business days (detailed)</div></div></div>';
if(repIncs.length>0){repIncs.forEach(function(inc){
var d=inc.date?new Date(inc.date).toLocaleDateString("en-AU",{day:"numeric",month:"short"}):"";
html+='<div style="padding:10px 12px;background:rgba(239,68,68,.04);border:1px solid rgba(239,68,68,.15);border-radius:8px;margin-top:8px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div style="font-size:12px;font-weight:700;color:var(--red)">'+inc.client+'</div><div style="font-size:10px;font-weight:600;color:var(--red)">'+d+(inc.time?" "+inc.time:"")+'</div></div>';
if(inc.category)html+='<div style="font-size:10px;color:var(--muted);margin-bottom:3px">Category: '+inc.category+'</div>';
if(inc.worker)html+='<div style="font-size:10px;color:var(--muted);margin-bottom:3px">Worker: '+inc.worker+'</div>';
if(inc.description)html+='<div style="font-size:10px;color:var(--text);line-height:1.5;margin-top:4px">'+inc.description+'</div>';
if(inc.actionsTaken)html+='<div style="font-size:10px;color:var(--teal);margin-top:4px"><strong>Actions:</strong> '+inc.actionsTaken+'</div>';
html+='</div>'})}
html+='</div>'}
// ‚îÄ‚îÄ Expiry Alerts ‚îÄ‚îÄ
if((data.expiringDetails&&data.expiringDetails.length>0)||(data.pbspExpiring&&data.pbspExpiring.length>0)){
html+='<div style="padding:14px 18px;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.2);border-radius:10px;margin-bottom:16px"><div style="font-size:13px;font-weight:700;color:var(--orange);margin-bottom:8px">‚ö†Ô∏è Upcoming Expiries Requiring Action</div>';
if(data.expiringDetails){html+='<table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:8px"><thead><tr style="border-bottom:2px solid rgba(245,158,11,.2)"><th style="text-align:left;padding:4px 8px;font-size:9px;color:var(--muted)">CLIENT</th><th style="text-align:left;padding:4px 8px;font-size:9px;color:var(--muted)">TYPE</th><th style="text-align:left;padding:4px 8px;font-size:9px;color:var(--muted)">EXPIRY</th><th style="text-align:left;padding:4px 8px;font-size:9px;color:var(--muted)">STATUS</th></tr></thead><tbody>';
data.expiringDetails.forEach(function(e){var badge=e.daysLeft<0?'<span style="color:#fff;background:#EF4444;padding:2px 6px;border-radius:4px;font-weight:700;font-size:9px">EXPIRED '+Math.abs(e.daysLeft)+'d ago</span>':e.daysLeft<14?'<span style="color:#fff;background:#F59E0B;padding:2px 6px;border-radius:4px;font-weight:700;font-size:9px">'+e.daysLeft+'d ‚Äî URGENT</span>':'<span style="padding:2px 6px;border-radius:4px;font-weight:600;font-size:9px;background:rgba(16,185,129,.1);color:var(--green)">'+e.daysLeft+' days</span>';html+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 8px;font-weight:600">'+e.client+'</td><td style="padding:5px 8px;font-size:10px;color:var(--muted)">'+(e.type||'')+'</td><td style="padding:5px 8px">'+e.expiryDate+'</td><td style="padding:5px 8px">'+badge+'</td></tr>'});
html+='</tbody></table>'}
if(data.pbspExpiring&&data.pbspExpiring.length>0){html+='<div style="font-size:11px;font-weight:600;color:var(--orange);margin-top:6px">PBSP Reviews: '+data.pbspExpiring.map(function(p){return p.client+' ('+p.date+')'}).join(', ')+'</div>'}
html+='</div>'}
// ‚îÄ‚îÄ Charts Row 1 ‚îÄ‚îÄ
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
html+='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px"><div style="font-size:12px;font-weight:700;margin-bottom:12px">üìä Activity Breakdown</div><canvas id="opsChartBreakdown" height="220"></canvas></div>';
html+='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px"><div style="font-size:12px;font-weight:700;margin-bottom:12px">üìà Daily Activity</div><canvas id="opsChartDaily" height="220"></canvas></div>';
html+='</div>';
// ‚îÄ‚îÄ Charts Row 2 ‚îÄ‚îÄ
var hasIncChart=data.incidentBreakdown&&Object.keys(data.incidentBreakdown).length>0;
if(hasIncChart){html+='<div style="margin-bottom:16px">';
html+='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px"><div style="font-size:12px;font-weight:700;margin-bottom:12px">‚ö†Ô∏è Incident Categories</div><canvas id="opsChartIncidents" height="140"></canvas></div>';
html+='</div>'}
// ‚îÄ‚îÄ Client Service Frequency removed ‚îÄ‚îÄ
// ‚îÄ‚îÄ INTERNAL: Contact History Section ‚îÄ‚îÄ
html+='<div style="font-size:16px;font-weight:800;color:var(--text);margin:8px 0 12px">üìã Internal: Contact History</div>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
// Employee Contact History
html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--royal);border-radius:10px">';
html+='<div style="font-size:13px;font-weight:700;margin-bottom:2px">üìû Employee Contact History</div>';
html+='<div style="font-size:10px;color:var(--muted);margin-bottom:10px">'+(s.employeeContacts||0)+' entries this period</div>';
if(data.empContactByUser&&Object.keys(data.empContactByUser).length>0){
html+='<div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Logged By (Staff Name)</div>';
var eUsers=Object.keys(data.empContactByUser).sort(function(a,b){return data.empContactByUser[b]-data.empContactByUser[a]});
eUsers.forEach(function(u){html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)"><span style="font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;margin-right:8px">'+u+'</span><span style="font-size:12px;font-weight:800;color:var(--royal);flex-shrink:0">'+data.empContactByUser[u]+'</span></div>'});
html+='<div style="height:10px"></div>'}
if(data.empContactReasons&&Object.keys(data.empContactReasons).length>0){
html+='<div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;padding-top:6px;border-top:1px solid var(--border)">Top Reasons</div>';
var eck=Object.keys(data.empContactReasons).sort(function(a,b){return data.empContactReasons[b]-data.empContactReasons[a]}).slice(0,6);
eck.forEach(function(k){html+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--muted)">'+k+'</span><span style="font-weight:600;color:var(--royal)">'+data.empContactReasons[k]+'</span></div>'})}
if(data.empContactMethods&&Object.keys(data.empContactMethods).length>0){
html+='<div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;margin-top:8px;padding-top:6px;border-top:1px solid var(--border)">Method of Contact</div>';
var emk=Object.keys(data.empContactMethods).sort(function(a,b){return data.empContactMethods[b]-data.empContactMethods[a]});
emk.forEach(function(k){html+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--muted)">'+k+'</span><span style="font-weight:600;color:var(--royal)">'+data.empContactMethods[k]+'</span></div>'})}
html+='</div>';
// Client Contact History
html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-left:4px solid #7C3AED;border-radius:10px">';
html+='<div style="font-size:13px;font-weight:700;margin-bottom:2px">üìã Client Contact History</div>';
html+='<div style="font-size:10px;color:var(--muted);margin-bottom:10px">'+(s.clientContacts||0)+' entries this period</div>';
if(data.clientContactByUser&&Object.keys(data.clientContactByUser).length>0){
html+='<div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Logged By (Staff Name)</div>';
var cUsers=Object.keys(data.clientContactByUser).sort(function(a,b){return data.clientContactByUser[b]-data.clientContactByUser[a]});
cUsers.forEach(function(u){html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)"><span style="font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;margin-right:8px">'+u+'</span><span style="font-size:12px;font-weight:800;color:#7C3AED;flex-shrink:0">'+data.clientContactByUser[u]+'</span></div>'});
html+='<div style="height:10px"></div>'}
if(data.clientContactReasons&&Object.keys(data.clientContactReasons).length>0){
html+='<div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;padding-top:6px;border-top:1px solid var(--border)">Top Reasons</div>';
var cck=Object.keys(data.clientContactReasons).sort(function(a,b){return data.clientContactReasons[b]-data.clientContactReasons[a]}).slice(0,6);
cck.forEach(function(k){html+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--muted)">'+k+'</span><span style="font-weight:600;color:#7C3AED">'+data.clientContactReasons[k]+'</span></div>'})}
if(data.clientContactMethods&&Object.keys(data.clientContactMethods).length>0){
html+='<div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;margin-top:8px;padding-top:6px;border-top:1px solid var(--border)">Method of Contact</div>';
var cmk=Object.keys(data.clientContactMethods).sort(function(a,b){return data.clientContactMethods[b]-data.clientContactMethods[a]});
cmk.forEach(function(k){html+='<div style="display:flex;justify-content:space-between;padding:2px 0;font-size:10px"><span style="color:var(--muted)">'+k+'</span><span style="font-weight:600;color:#7C3AED">'+data.clientContactMethods[k]+'</span></div>'})}
html+='</div>';
html+='</div>';
// ‚îÄ‚îÄ Staff Contact Report ‚îÄ‚îÄ
if(data.staffContactReport&&data.staffContactReport.length>0){
html+='<div style="font-size:16px;font-weight:800;color:var(--text);margin:16px 0 12px">üë§ Staff Contact Report <span style="font-size:11px;font-weight:500;color:var(--muted)">('+rangeLabel+')</span></div>';
html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px">';
data.staffContactReport.forEach(function(s){
html+='<div style="padding:10px 0;border-bottom:1px solid var(--border)">';
html+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px"><div style="font-size:12px;font-weight:700;color:var(--text)">'+s.name+'</div>';
html+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(30,75,160,.08);color:var(--royal)">'+s.entries+' entr'+(s.entries>1?'ies':'y')+'</span></div>';
// Reasons badges
if(s.reasons&&s.reasons.length>0){html+='<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px">';
s.reasons.forEach(function(r){html+='<span style="font-size:8px;font-weight:600;padding:1px 5px;border-radius:4px;background:rgba(236,72,153,.06);color:#EC4899">'+r.reason+(r.count>1?' ('+r.count+')':'')+'</span>'});
html+='</div>'}
// Methods inline
if(s.methods&&s.methods.length>0){html+='<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px">';
s.methods.forEach(function(m){var col=m.method==='Phone'?'#3B82F6':m.method==='Email'?'#10B981':m.method==='SMS'?'#8B5CF6':'#6B7280';html+='<span style="font-size:8px;font-weight:600;padding:1px 5px;border-radius:4px;background:'+col+'10;color:'+col+'">'+m.method+(m.count>1?' ('+m.count+')':'')+'</span>'});
html+='</div>'}
// Ops Narrative
if(s.opsNarrative){html+='<div style="margin-top:4px;padding:6px 8px;background:rgba(30,75,160,.03);border-left:2px solid var(--royal);border-radius:0 4px 4px 0"><div style="font-size:9px;font-weight:700;color:var(--royal);text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px">Ops Summary</div><div style="font-size:10px;color:var(--text);line-height:1.5">'+s.opsNarrative+'</div></div>'}
html+='</div>'});
html+='</div>'}
// ‚îÄ‚îÄ New Staff - Ready to Work ‚îÄ‚îÄ
if(data.readyToWork&&data.readyToWork.length>0){
html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--green);border-radius:10px;margin-bottom:16px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-size:13px;font-weight:700">üÜï New Staff ‚Äî Ready to Work</div><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(16,185,129,.1);color:var(--green)">'+data.readyToWork.length+' staff</span></div>';
html+='<table style="width:100%;border-collapse:collapse;font-size:10px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:5px 6px;font-size:9px;color:var(--muted)">NAME</th><th style="text-align:left;padding:5px 6px;font-size:9px;color:var(--muted)">SUBURB</th><th style="text-align:left;padding:5px 6px;font-size:9px;color:var(--muted)">GENDER</th><th style="text-align:left;padding:5px 6px;font-size:9px;color:var(--muted)">ETHNICITY</th><th style="text-align:left;padding:5px 6px;font-size:9px;color:var(--muted)">MOBILE</th><th style="text-align:left;padding:5px 6px;font-size:9px;color:var(--muted)">MANDATORY DOCS</th></tr></thead><tbody>';
data.readyToWork.forEach(function(s){
var docColor=!s.mandatoryDocs?'var(--muted)':s.mandatoryDocs.indexOf('100')>=0?'var(--green)':'var(--orange)';
html+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:5px 6px;font-weight:600">'+s.name+'</td><td style="padding:5px 6px">'+s.suburb+'</td><td style="padding:5px 6px">'+(s.gender||'')+'</td><td style="padding:5px 6px">'+s.ethnicity+'</td><td style="padding:5px 6px;white-space:nowrap">'+s.mobile+'</td><td style="padding:5px 6px;font-weight:700;color:'+docColor+'">'+s.mandatoryDocs+'</td></tr>'});
html+='</tbody></table></div>'}
// ‚îÄ‚îÄ Incident Details ‚îÄ‚îÄ
if(data.incidentDetails&&data.incidentDetails.length>0){
html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:12px;font-weight:700">‚ö†Ô∏è Incident Details</div><div style="font-size:9px;font-weight:600;color:var(--muted)">Reporting Period: '+rangeLabel+'</div></div>';
data.incidentDetails.forEach(function(inc){
var d=inc.date?new Date(inc.date).toLocaleDateString("en-AU",{day:"numeric",month:"short"}):"";
var flags='';if(inc.reportable)flags+='<span style="color:#fff;background:#EF4444;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:700;margin-right:3px">REPORTABLE</span>';
if(inc.highRisk)flags+='<span style="color:#fff;background:#F59E0B;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:700">HIGH RISK</span>';
var rowBg=inc.reportable?'background:rgba(239,68,68,.04);border-left:3px solid var(--red);':inc.highRisk?'background:rgba(245,158,11,.04);border-left:3px solid var(--orange);':'border-left:3px solid transparent;';
html+='<div style="padding:8px 10px;margin-bottom:6px;border-radius:6px;'+rowBg+'">';
html+='<div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div style="font-size:11px;font-weight:700">'+inc.client+(inc.worker?' <span style="font-weight:400;color:var(--muted)">‚Äî '+inc.worker+'</span>':'')+'</div>';
html+='<div style="font-size:9px;font-weight:600;color:var(--teal);margin-top:2px">'+d+(inc.time?" "+inc.time:"")+'</div></div>';
html+='<div style="display:flex;gap:4px;flex-shrink:0">'+flags+'</div></div>';
if(inc.category)html+='<div style="font-size:9px;color:var(--muted);margin-top:2px">'+inc.category+'</div>';
html+='<div style="font-size:10px;color:var(--muted);margin-top:3px;line-height:1.4">'+inc.description+'</div>';
if(inc.actionsTaken)html+='<div style="font-size:9px;color:var(--teal);margin-top:3px"><strong>Actions:</strong> '+inc.actionsTaken+'</div>';
html+='</div>'});
html+='</div>'}
// ‚îÄ‚îÄ Incidents by Category by Client ‚îÄ‚îÄ
if(data.incidentsByClientCat&&Object.keys(data.incidentsByClientCat).length>0){
html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px"><div style="font-size:12px;font-weight:700;margin-bottom:8px">üìä Incidents by Category & Client <span style="font-size:9px;font-weight:500;color:var(--muted)">('+rangeLabel+')</span></div>';
var iccKeys=Object.keys(data.incidentsByClientCat).sort(function(a,b){return data.incidentsByClientCat[b].total-data.incidentsByClientCat[a].total});
iccKeys.forEach(function(client){
var cd=data.incidentsByClientCat[client];
html+='<div style="padding:6px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;margin-bottom:3px"><span>'+client+(cd.reportable?' <span style="color:#fff;background:#EF4444;padding:1px 5px;border-radius:3px;font-size:8px;font-weight:700;margin-left:4px">'+cd.reportable+' Reportable</span>':'')+'</span><span style="color:var(--red)">'+cd.total+' incident'+(cd.total>1?'s':'')+'</span></div>';
html+='<div style="display:flex;gap:4px;flex-wrap:wrap">';
var catKeys=Object.keys(cd.categories).sort(function(a,b){return cd.categories[b]-cd.categories[a]});
catKeys.forEach(function(cat){html+='<span style="font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.06);color:var(--red);font-weight:600">'+cat+' ('+cd.categories[cat]+')</span>'});
html+='</div></div>'});
html+='</div>'}
// ‚îÄ‚îÄ Incidents by Month ‚Äî Open vs Closed (Chart) ‚îÄ‚îÄ
if(data.incidentsByMonth&&data.incidentsByMonth.length>0){
html+='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:12px;font-weight:700">üìà Incidents by Month ‚Äî Open vs Closed</div><div style="display:flex;gap:8px;align-items:center"><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(239,68,68,.08);color:var(--red)">'+(data.openIncidentsTotal||0)+' open</span><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(16,185,129,.08);color:var(--green)">'+(data.closedIncidentsTotal||0)+' closed</span></div></div><canvas id="opsChartOpenInc" height="160"></canvas></div>'}
// ‚îÄ‚îÄ Risks & Concerns ‚îÄ‚îÄ
if(data.riskDetails&&data.riskDetails.length>0){html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px"><div style="font-size:12px;font-weight:700;margin-bottom:8px">üî¥ Risks & Concerns (from Progress Notes)</div>';
data.riskDetails.forEach(function(r){html+='<div style="padding:8px 10px;border-bottom:1px solid var(--border)"><div style="font-size:11px;font-weight:700;color:var(--text)">'+r.client+(r.worker?' <span style="font-weight:400;color:var(--muted)">‚Äî '+r.worker+'</span>':'')+'</div>';
if(r.date)html+='<div style="font-size:9px;font-weight:600;color:var(--teal);margin-top:2px">'+r.date+'</div>';
html+='<div style="font-size:10px;color:var(--muted);margin-top:4px;line-height:1.5">'+r.summary+'</div></div>'});html+='</div>'}
// ‚îÄ‚îÄ Sleep Disturbances ‚îÄ‚îÄ
if(data.sleepByClient){html+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:16px"><div style="font-size:12px;font-weight:700;margin-bottom:8px">üò¥ Sleep Disturbances by Client (from Progress Notes)</div>';
var slk=Object.keys(data.sleepByClient).sort(function(a,b){var al=Array.isArray(data.sleepByClient[b])?data.sleepByClient[b].length:data.sleepByClient[b];var bl=Array.isArray(data.sleepByClient[a])?data.sleepByClient[a].length:data.sleepByClient[a];return al-bl});
slk.forEach(function(k){var entries=data.sleepByClient[k];var count=Array.isArray(entries)?entries.length:entries;
html+='<div style="padding:6px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700"><span>'+k+'</span><span style="color:var(--orange)">'+count+' episode'+(count>1?'s':'')+'</span></div>';
if(Array.isArray(entries)){entries.forEach(function(e){html+='<div style="font-size:9px;color:var(--muted);padding:1px 0 1px 12px">';
if(e.date)html+='<span style="color:var(--teal);font-weight:600">'+e.date+'</span>';
if(e.worker)html+=' ‚Äî <span>'+e.worker+'</span>';
if(e.note&&e.note.toLowerCase()!=='yes')html+=' ‚Äî <span style="font-style:italic">'+e.note+'</span>';
html+='</div>'});}
html+='</div>'});html+='</div>'}
// ‚îÄ‚îÄ Narrative ‚îÄ‚îÄ
if(data.narrative){html+='<div style="padding:20px;background:linear-gradient(135deg,rgba(10,147,150,.02),rgba(30,75,160,.02));border:1px solid rgba(10,147,150,.12);border-radius:12px;margin-bottom:16px">';
html+='<div style="font-size:14px;font-weight:800;color:var(--text);margin-bottom:12px">üìù Management Summary & Recommendations</div>';
var nar=data.narrative.replace(/^(EXECUTIVE SUMMARY|SERVICE DELIVERY|WORKFORCE|CLIENT BASE|INCIDENT MANAGEMENT|COMMUNICATION & CONTACT HISTORY|PARTICIPANT WELLBEING|RISKS & CONCERNS|COMPLIANCE & EXPIRY ALERTS|RECOMMENDATIONS|CLIENT ROSTER)$/gm,function(m){return'</div><div style="margin-top:14px"><div style="font-size:12px;font-weight:800;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;padding-bottom:4px;border-bottom:1px solid rgba(10,147,150,.15);margin-bottom:6px">'+m+'</div>'});
html+='<div style="font-size:11px;color:var(--text);line-height:1.8">'+nar+'</div></div>'}
// ‚îÄ‚îÄ Client Roster ‚îÄ‚îÄ
if(data.clientRoster){var cr=data.clientRoster;
function renderClientGroup(title,emoji,list,borderColor){if(!list||list.length===0)return'';
var h='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-left:4px solid '+borderColor+';border-radius:10px;margin-bottom:16px">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:14px;font-weight:800;color:var(--text)">'+emoji+' '+title+'</div><div style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:8px;background:'+borderColor+'15;color:'+borderColor+'">'+list.length+' Client'+(list.length!==1?'s':'')+'</div></div>';
list.forEach(function(c){h+='<div style="padding:10px 12px;border-bottom:1px solid var(--border)">';
var atBadge='';if(c.accountType){var atl=c.accountType.toLowerCase();if(atl.indexOf('active')>=0)atBadge='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(16,185,129,.1);color:var(--green);margin-left:6px">Active</span>';else if(atl.indexOf('prospect')>=0)atBadge='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(245,158,11,.1);color:var(--orange);margin-left:6px">Prospect</span>';else if(atl.indexOf('inactive')>=0)atBadge='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.1);color:var(--red);margin-left:6px">Inactive</span>'}
h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px"><div style="font-size:13px;font-weight:700;color:var(--text)">'+c.name+atBadge+'</div>';
h+='<div style="display:flex;gap:4px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">';
if(c.progressNotes>0)h+='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(10,147,150,.08);color:var(--teal)">'+c.progressNotes+' notes</span>';
if(c.kms&&c.kms>0)h+='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(245,158,11,.08);color:var(--orange)">'+c.kms+' km</span>';
if(c.incidents>0)h+='<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.08);color:var(--red)">'+c.incidents+' incident'+(c.incidents>1?'s':'')+'</span>';
h+='</div></div>';
var bullets=[];
var infoLine=[];
if(c.ndisType)infoLine.push(c.ndisType);
if(c.suburb)infoLine.push(c.suburb);
if(c.supportCoordinator)infoLine.push('SC: '+c.supportCoordinator);
if(infoLine.length>0)h+='<div style="font-size:10px;color:var(--muted);margin-top:2px">'+infoLine.join(' &nbsp;‚Ä¢&nbsp; ')+'</div>';
if(c.planEnd){try{var pe=new Date(c.planEnd);if(!isNaN(pe)){var dl=Math.ceil((pe-new Date())/86400000);var pdd=String(pe.getDate()).padStart(2,'0');var pmm=String(pe.getMonth()+1).padStart(2,'0');var pyy=String(pe.getFullYear()).slice(-2);var peLbl='NDIS Plan Expiry: '+pdd+'/'+pmm+'/'+pyy;if(dl<0)peLbl+=' <span style="color:var(--red);font-weight:700">(EXPIRED)</span>';else if(dl<60)peLbl+=' <span style="color:var(--orange);font-weight:700">('+dl+'d)</span>';bullets.push(peLbl)}}catch(e){}}
if(c.agreementExpiry){try{var ae=new Date(c.agreementExpiry);if(!isNaN(ae)){var adl=Math.ceil((ae-new Date())/86400000);var add=String(ae.getDate()).padStart(2,'0');var amm=String(ae.getMonth()+1).padStart(2,'0');var ayy=String(ae.getFullYear()).slice(-2);var aeLbl='S/Agreement Expiry: '+add+'/'+amm+'/'+ayy;if(adl<0)aeLbl+=' <span style="color:var(--red);font-weight:700">(EXPIRED)</span>';else if(adl<60)aeLbl+=' <span style="color:var(--orange);font-weight:700">('+adl+'d)</span>';bullets.push(aeLbl)}}catch(e){}}
if(c.kms&&c.kms>0)bullets.push('üöó Total KMs Claimed (Transport): '+c.kms+' km');
if(c.riskAssessmentExpiry){var raLabel='üìã Risk Assessment Expiry: ';try{var raDate=new Date(c.riskAssessmentExpiry+' 1');if(!isNaN(raDate)){var dd=String(raDate.getDate()).padStart(2,'0');var mm=String(raDate.getMonth()+1).padStart(2,'0');var yy=String(raDate.getFullYear()).slice(-2);raLabel+=dd+'/'+mm+'/'+yy;var rdl=Math.ceil((raDate-new Date())/86400000);if(rdl<0)raLabel+=' <span style="color:var(--red);font-weight:700">(EXPIRED)</span>';else if(rdl<90)raLabel+=' <span style="color:var(--orange);font-weight:700">('+rdl+'d)</span>'}else{raLabel+=c.riskAssessmentExpiry}}catch(e){raLabel+=c.riskAssessmentExpiry}bullets.push(raLabel)}
if(c.progressNotes===0)bullets.push('‚ö†Ô∏è No progress notes this period');
if(c.sleepIssues>0)bullets.push('üò¥ '+c.sleepIssues+' sleep disturbance'+(c.sleepIssues>1?'s':''));
if(bullets.length>0){h+='<div style="margin-top:4px">';bullets.forEach(function(b){h+='<div style="font-size:10px;color:var(--muted);padding:1px 0;padding-left:12px;position:relative"><span style="position:absolute;left:0">‚Ä¢</span>'+b+'</div>'});h+='</div>'}
if(c.opsNarrative){h+='<div style="margin-top:6px;padding:8px 10px;background:rgba(10,147,150,.03);border-left:2px solid var(--teal);border-radius:0 6px 6px 0"><div style="font-size:9px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px">Ops Summary</div><div style="font-size:10px;color:var(--text);line-height:1.6">'+c.opsNarrative+'</div></div>'}
h+='</div>'});h+='</div>';return h}
html+='<div style="margin-bottom:16px"><div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:12px">üë• Client Roster Summary</div>';
html+=renderClientGroup('SIL Clients (Supported Independent Living)','üè†',cr.sil,'#0A9396');
html+=renderClientGroup('CAS Clients (Community Access & Support)','ü§ù',cr.cas,'#1E4BA0');
if(cr.prospects&&cr.prospects.length>0)html+=renderClientGroup('Prospects','üîµ',cr.prospects,'#7C3AED');
html+='</div>'}
// ‚îÄ‚îÄ Footer ‚îÄ‚îÄ
html+='<div style="text-align:center;padding:16px;font-size:9px;color:var(--dim)">Delta Community Support ‚Äî Confidential Internal Report ‚Äî Generated by TITUS Operations Intelligence</div>';
html+='</div>';
el.innerHTML=html;
// ‚îÄ‚îÄ Render charts ‚îÄ‚îÄ
setTimeout(function(){
var ctx1=document.getElementById("opsChartBreakdown");if(ctx1){window._opsCharts.breakdown=new Chart(ctx1,{type:"doughnut",data:{labels:["Progress Notes","Incidents","Employee Contacts","Client Contacts","Sleep Disturbances","Risks/Concerns"],datasets:[{data:[s.progressNotes||0,s.incidents||0,s.employeeContacts||0,s.clientContacts||0,s.sleepDisturbances||0,s.risksOrConcerns||0],backgroundColor:["#0A9396","#EF4444","#1E4BA0","#7C3AED","#F59E0B","#EC4899"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:true,plugins:{legend:{position:"bottom",labels:{padding:8,usePointStyle:true,font:{size:9,family:"Plus Jakarta Sans"}}}}}})}
if(data.dailyActivity){var ctx2=document.getElementById("opsChartDaily");if(ctx2){var days=Object.keys(data.dailyActivity).sort();var vals=days.map(function(d){return data.dailyActivity[d]});window._opsCharts.daily=new Chart(ctx2,{type:"bar",data:{labels:days.map(function(d){var dt=new Date(d);return dt.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short"})}),datasets:[{label:"Records",data:vals,backgroundColor:"rgba(10,147,150,.6)",borderRadius:4}]},options:{responsive:true,scales:{x:{grid:{display:false},ticks:{font:{size:9}}},y:{beginAtZero:true,ticks:{stepSize:1,font:{size:10}}}},plugins:{legend:{display:false}}}})}}
if(data.incidentBreakdown){var ctx3=document.getElementById("opsChartIncidents");if(ctx3){var cats=Object.keys(data.incidentBreakdown);var catVals=cats.map(function(c){return data.incidentBreakdown[c]});var colors=["#EF4444","#F59E0B","#7C3AED","#3B82F6","#10B981","#EC4899","#6B7280"];window._opsCharts.incidents=new Chart(ctx3,{type:"bar",data:{labels:cats,datasets:[{data:catVals,backgroundColor:colors.slice(0,cats.length),borderRadius:4}]},options:{responsive:true,indexAxis:"y",scales:{x:{beginAtZero:true,ticks:{stepSize:1}},y:{ticks:{font:{size:9}}}},plugins:{legend:{display:false}}}})}}
// Worker chart removed
// ‚îÄ‚îÄ Incidents by Month Chart ‚Äî Open vs Closed ‚îÄ‚îÄ
if(data.incidentsByMonth&&data.incidentsByMonth.length>0){var ctx5=document.getElementById("opsChartOpenInc");if(ctx5){window._opsCharts.openInc=new Chart(ctx5,{type:"bar",data:{labels:data.incidentsByMonth.map(function(m){return m.month}),datasets:[{label:"Open",data:data.incidentsByMonth.map(function(m){return m.open}),backgroundColor:"rgba(239,68,68,.6)",borderRadius:4},{label:"Closed",data:data.incidentsByMonth.map(function(m){return m.closed}),backgroundColor:"rgba(16,185,129,.5)",borderRadius:4}]},options:{responsive:true,scales:{x:{grid:{display:false},stacked:true,ticks:{font:{size:9}}},y:{beginAtZero:true,stacked:true,ticks:{stepSize:2,font:{size:10}}}},plugins:{legend:{display:true,position:"bottom",labels:{boxWidth:12,font:{size:10}}}}}})}}
},300)}

function downloadOpsPDF(){
var printArea=document.getElementById("opsReportPrintArea");if(!printArea)return;
var btn=document.getElementById("opsPdfBtn");if(btn){btn.disabled=true;btn.textContent="‚è≥ Generating PDF..."}
html2canvas(printArea,{scale:2,useCORS:true,backgroundColor:"#f8fafb",logging:false,windowWidth:1100}).then(function(canvas){
var pdf=new jspdf.jsPDF("p","mm","a4");
var pageW=pdf.internal.pageSize.getWidth();var pageH=pdf.internal.pageSize.getHeight();
var margin=8;var contentW=pageW-margin*2;
var imgW=canvas.width;var imgH=canvas.height;var ratio=contentW/imgW;var totalH=imgH*ratio;
var yOffset=0;var pageNum=0;
while(yOffset<totalH){if(pageNum>0)pdf.addPage();
var srcY=yOffset/ratio;var srcH=Math.min((pageH-margin*2)/ratio,imgH-srcY);if(srcH<=0)break;
var tc=document.createElement("canvas");tc.width=imgW;tc.height=srcH;
var ctx=tc.getContext("2d");ctx.drawImage(canvas,0,srcY,imgW,srcH,0,0,imgW,srcH);
pdf.addImage(tc.toDataURL("image/jpeg",0.92),"JPEG",margin,margin,contentW,srcH*ratio);
yOffset+=pageH-margin*2;pageNum++;if(pageNum>20)break}
pdf.save("DCS_Ops_Report_"+(window._opsReportFrom||"report")+"_to_"+(window._opsReportTo||"")+".pdf");
if(btn){btn.disabled=false;btn.textContent="üì• Download PDF"}
}).catch(function(e){console.error("PDF error:",e);if(btn){btn.disabled=false;btn.textContent="üì• Download PDF"}alert("PDF generation failed: "+e.message)})}

// ‚îÄ‚îÄ‚îÄ STAKEHOLDER REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStakeholderReport(){var rp=document.getElementById("rightPanel");
var html='<div class="rp-hdr"><div class="rp-hdr-info"><div style="cursor:pointer;padding:6px 10px;border-radius:var(--rs);font-size:12px;font-weight:600;color:var(--muted);border:1px solid var(--border);margin-right:8px" onclick="window._reportsSubView=\'menu\';renderReportsMenu()">‚Üê Back</div><div><div class="rp-hdr-name">üìë NDIS Stakeholder Report</div><div class="rp-hdr-sub">Weekly update for families, support coordinators & NDIS planners</div></div></div></div>';
html+='<div style="padding:20px;max-width:1200px">';
html+='<div style="padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:20px">';
html+='<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">Report Settings</div>';
html+='<div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">';
html+='<div><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">From</label><input type="date" id="shFrom" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:13px"></div>';
html+='<div><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">To</label><input type="date" id="shTo" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:13px"></div>';
html+='<div style="display:flex;gap:6px;align-items:end">';
html+='<button class="btn btn-s" style="font-size:11px;padding:8px 10px" onclick="setShPreset(\'7d\')">Last 7d</button>';
html+='<button class="btn btn-s" style="font-size:11px;padding:8px 10px" onclick="setShPreset(\'14d\')">Last 14d</button>';
html+='<button class="btn btn-s" style="font-size:11px;padding:8px 10px" onclick="setShPreset(\'30d\')">Last 30d</button>';
html+='</div>';
html+='<button class="btn btn-p" style="padding:8px 24px;font-size:13px;font-weight:700;background:var(--royal);white-space:nowrap" onclick="generateStakeholderReport()">üìë Generate Report</button>';
html+='</div>';
html+='<div style="margin-top:12px"><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Participants <span style="font-weight:400;color:var(--dim)">(select up to 20)</span></label>';
html+='<div id="shClientSelector" style="position:relative"><div id="shClientToggle" onclick="toggleShClientDropdown()" style="padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--muted);font-size:13px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;min-height:38px"><span id="shClientLabel">Loading clients...</span><span style="font-size:10px">‚ñº</span></div>';
html+='<div id="shClientDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:100;max-height:240px;overflow-y:auto;margin-top:2px">';
html+='<div style="padding:6px 10px;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:center"><button class="btn btn-s" style="font-size:10px;padding:3px 8px" onclick="shSelectNone()">Clear</button><span id="shClientCount" style="font-size:10px;color:var(--muted);margin-left:auto"></span></div>';
html+='<div id="shClientList" style="padding:4px 0"></div></div></div></div>';
html+='</div>';
html+='<div id="shReportContent"><div style="text-align:center;padding:40px;color:var(--muted)"><div style="font-size:40px;margin-bottom:12px">üìë</div><div style="font-size:14px;font-weight:600">Select a date range, choose participants, and click Generate</div><div style="font-size:12px;margin-top:4px">Generates individual NDIS reports per participant with AI analysis, charts, and photographic evidence</div></div></div>';
html+='</div>';rp.innerHTML=html;
var now=new Date();var from=new Date(now-7*86400000);
document.getElementById("shFrom").value=from.toISOString().split("T")[0];
document.getElementById("shTo").value=now.toISOString().split("T")[0];
loadShClients()}

window._shSelectedClients=[];window._shAllClients=[];
function loadShClients(){apiCall("GET","/api/stakeholder-clients").then(function(d){
window._shAllClients=(d&&d.clients)||[];var list=document.getElementById("shClientList");if(!list)return;
var h="";window._shAllClients.forEach(function(name,i){
h+='<label style="display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer;font-size:12px;color:var(--text)" onmouseover="this.style.background=\'var(--surface2)\'" onmouseout="this.style.background=\'none\'">';
h+='<input type="checkbox" data-client="'+name+'" onchange="updateShClientSelection()" style="accent-color:var(--royal);width:14px;height:14px">'+name+'</label>'});
list.innerHTML=h;document.getElementById("shClientLabel").textContent="Select participants ("+window._shAllClients.length+" available)";
window._shSelectedClients=[];}).catch(function(){document.getElementById("shClientLabel").textContent="Could not load clients"})}
function toggleShClientDropdown(){var dd=document.getElementById("shClientDropdown");if(dd)dd.style.display=dd.style.display==="none"?"block":"none"}
function updateShClientSelection(){var boxes=document.querySelectorAll("#shClientList input[type=checkbox]");var sel=[];boxes.forEach(function(b){if(b.checked)sel.push(b.getAttribute("data-client"))});
// Enforce max 20
if(sel.length>20){boxes.forEach(function(b){if(b.checked&&sel.indexOf(b.getAttribute("data-client"))>=20)b.checked=false});sel=sel.slice(0,20)}
window._shSelectedClients=sel;
var lbl=document.getElementById("shClientLabel");if(sel.length===0)lbl.textContent="Select participants...";
else if(sel.length<=2)lbl.textContent=sel.join(", ");
else lbl.textContent=sel.length+" selected";
var cnt=document.getElementById("shClientCount");if(cnt)cnt.innerHTML=sel.length>0?'<span style="color:'+(sel.length>=20?"var(--red)":"var(--teal)")+'">'+sel.length+' / 20 max</span>':''}
function shSelectNone(){document.querySelectorAll("#shClientList input[type=checkbox]").forEach(function(b){b.checked=false});updateShClientSelection()}
function setShPreset(r){var now=new Date();var d=r==="7d"?7:r==="14d"?14:30;var from=new Date(now-d*86400000);document.getElementById("shFrom").value=from.toISOString().split("T")[0];document.getElementById("shTo").value=now.toISOString().split("T")[0]}

function generateStakeholderReport(){
var from=document.getElementById("shFrom").value;var to=document.getElementById("shTo").value;
if(!from||!to){alert("Please select both dates");return}
window._shReportFrom=from;window._shReportTo=to;
var clients=window._shSelectedClients||[];
if(clients.length===0){alert("Please select at least 1 participant");return}
if(clients.length>20){alert("Maximum 20 participants at a time. You selected "+clients.length+".");return}
var dd=document.getElementById("shClientDropdown");if(dd)dd.style.display="none";
var modal=document.createElement("div");modal.id="shReportModal";
modal.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:9999;overflow-y:auto;display:flex;flex-direction:column";
modal.innerHTML='<div style="position:sticky;top:0;z-index:10;background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;justify-content:space-between;align-items:center">'
+'<div style="display:flex;align-items:center;gap:10px"><button onclick="closeShModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:2px 6px">&#x2715;</button><div style="font-size:15px;font-weight:800;color:var(--text)">NDIS Stakeholder Report</div></div>'
+'<div style="display:flex;gap:8px"><button class="btn btn-s" style="font-size:11px" onclick="minimiseShModal()" title="Minimise ‚Äî continue working while generating">&#8212; Minimise</button><button id="shPdfBtn" class="btn btn-p" style="font-size:11px;padding:6px 14px;background:var(--royal)" onclick="downloadShPDF()">&#128229; Generate PDFs</button><button class="btn btn-s" style="font-size:11px" onclick="printShReport()">&#128424; Print</button></div></div>'
+'<div style="flex:1;padding:24px;display:flex;justify-content:center">'
+'<div id="shProgressArea" style="max-width:520px;width:100%;text-align:center;padding:48px 20px">'
+'<div style="font-size:48px;margin-bottom:16px">&#128209;</div>'
+'<div style="font-size:17px;font-weight:800;color:var(--text);margin-bottom:6px">Generating NDIS Reports</div>'
+'<div id="shProgressStatus" style="font-size:13px;color:var(--muted);margin-bottom:20px;min-height:20px">Starting...</div>'
+'<div style="background:var(--border);border-radius:10px;height:16px;overflow:hidden;margin-bottom:8px;box-shadow:inset 0 1px 3px rgba(0,0,0,.1)">'
+'<div id="shProgressBar" style="height:100%;background:linear-gradient(90deg,#1e3a8a,#6366f1);border-radius:10px;width:0%;transition:width .5s ease"></div></div>'
+'<div id="shProgressCount" style="font-size:12px;color:var(--muted)">0 of '+clients.length+' participants</div>'
+'<div id="shProgressList" style="margin-top:16px;text-align:left;max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface)"></div>'
+'</div></div>';
document.body.appendChild(modal);document.body.style.overflow="hidden";
var headers={"Content-Type":"application/json"};if(token)headers["Authorization"]="Bearer "+token;
var allResults={participants:[],company:{},from:from,to:to,generatedAt:new Date().toLocaleString("en-AU")};
var completed=0;var total=clients.length;
function setProgress(pct,status,listHtml){
  var bar=document.getElementById("shProgressBar");
  var st=document.getElementById("shProgressStatus");
  var cnt=document.getElementById("shProgressCount");
  var lst=document.getElementById("shProgressList");
  if(bar)bar.style.width=Math.round(pct)+"%";
  if(st)st.textContent=status;
  if(cnt)cnt.textContent=completed+" of "+total+" participants complete";
  if(lst&&listHtml){var row=document.createElement("div");row.style.cssText="padding:6px 12px;font-size:11px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px";row.innerHTML=listHtml;lst.appendChild(row);lst.scrollTop=lst.scrollHeight;}
}
function fetchNextClient(i){
  if(i>=clients.length){
    setProgress(100,"All reports generated! Building PDFs now...",null);
    setTimeout(function(){
      renderStakeholderResults(allResults,from,to);
      var _ps=Date.now();var _pt=setInterval(function(){
        var el=Date.now()-_ps;var cc=Object.keys(window._shCharts||{}).length;
        if(cc>0||el>4000){clearInterval(_pt);console.log('Batch charts ready ('+cc+'), starting PDF');downloadShPDF();}
      },300);
      setTimeout(function(){clearInterval(_pt);downloadShPDF();},5500);
    },400);
    return;
  }
  var client=clients[i];
  var clientLabel=typeof client==="object"?(client.name||client.id||"Participant "+(i+1)):String(client);
  setProgress(Math.round((i/total)*85),"Generating report for "+clientLabel+"...",null);
  var ctrl=new AbortController();var tid=setTimeout(function(){ctrl.abort();},120000);
  fetch("/api/stakeholder-report",{method:"POST",headers:headers,body:JSON.stringify({from:from,to:to,clients:[client]}),signal:ctrl.signal})
  .then(function(r){clearTimeout(tid);if(!r.ok)throw new Error("Server error "+r.status);return r.json();})
  .then(function(data){
    clearTimeout(tid);
    if(i===0&&data.company)allResults.company=data.company;
    if(data.participants&&data.participants.length)allResults.participants=allResults.participants.concat(data.participants);
    completed++;
    setProgress(Math.round((completed/total)*85),completed===total?"All "+total+" reports ready!":"Next participant...",
      '<span style="color:#059669">&#10003;</span> <span style="font-weight:700">'+clientLabel+'</span>');
    setTimeout(function(){fetchNextClient(i+1);},100);
  })
  .catch(function(e){
    clearTimeout(tid);completed++;
    var errMsg=e.name==="AbortError"?"timed out":"error: "+e.message;
    setProgress(Math.round((completed/total)*85),"Continuing...",
      '<span style="color:#d97706">&#9888;</span> <span style="font-weight:700">'+clientLabel+'</span> ('+errMsg+')');
    console.warn("Client "+clientLabel+" failed:",e.message);
    setTimeout(function(){fetchNextClient(i+1);},100);
  });
}
fetchNextClient(0);
}

function minimiseShModal() {
  var m = document.getElementById('shReportModal');
  if (!m) return;
  // Hide modal but keep it alive in DOM
  m.style.display = 'none';
  document.body.style.overflow = '';
  // Show floating restore pill
  var existing = document.getElementById('shModalPill');
  if (existing) existing.remove();
  var pill = document.createElement('div');
  pill.id = 'shModalPill';
  pill.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:99998;background:linear-gradient(135deg,#1E4BA0,#7C3AED);color:#fff;padding:10px 18px;border-radius:24px;font-size:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(30,75,160,.4);display:flex;align-items:center;gap:8px;user-select:none;transition:transform .15s';
  pill.innerHTML = '&#128209; NDIS Report ‚Äî Running <span style="background:rgba(255,255,255,.2);border-radius:10px;padding:1px 7px;font-size:11px">Click to restore</span>';
  pill.onmouseover = function(){ pill.style.transform='scale(1.04)'; };
  pill.onmouseout = function(){ pill.style.transform='scale(1)'; };
  pill.onclick = function() { restoreShModal(); };
  document.body.appendChild(pill);
}

function restoreShModal() {
  var m = document.getElementById('shReportModal');
  var pill = document.getElementById('shModalPill');
  if (pill) pill.remove();
  if (!m) return;
  m.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeShModal(){var m=document.getElementById("shReportModal");if(m){
// Destroy charts
if(window._shCharts){Object.keys(window._shCharts).forEach(function(k){try{window._shCharts[k].destroy()}catch(e){}});window._shCharts={}}
m.remove();document.body.style.overflow=""}}
function printShReport(){var area=document.getElementById("shPrintArea");if(!area)return;var w=window.open("","_blank");w.document.write('<html><head><title>NDIS Stakeholder Report</title><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Plus Jakarta Sans,sans-serif;color:#111;padding:20px;font-size:11px}img{max-width:100%;border-radius:6px}p{margin:6px 0;line-height:1.6}.client-page{page-break-before:always}.client-page:first-child{page-break-before:auto}.photos{display:flex;flex-wrap:wrap;gap:8px}.photos img{width:120px;height:90px;object-fit:cover;border-radius:6px;border:1px solid #E8EBF0}canvas{max-width:100%!important;height:auto!important}@media print{.no-print{display:none}.client-page{page-break-before:always}.client-page:first-child{page-break-before:auto}}</style></head><body>'+area.innerHTML+'</body></html>');w.document.close();setTimeout(function(){w.print()},800)}

function downloadShPDF(){
  // ‚îÄ‚îÄ Step 1: Get the rendered report HTML (from DOM or cache) ‚îÄ‚îÄ
  var sourceArea = document.getElementById('shPrintArea');
  var cacheHtml  = window._shPrintAreaHTML || '';

  // Always work from a dedicated off-screen capture container so
  // we never destroy the source elements when switching to progress UI
  var captureWrap = document.getElementById('shPdfCaptureWrap');
  if (captureWrap) captureWrap.remove();
  captureWrap = document.createElement('div');
  captureWrap.id = 'shPdfCaptureWrap';
  captureWrap.style.cssText = 'position:fixed;left:-9999px;top:0;width:940px;background:#fff;z-index:-1;overflow:visible';
  document.body.appendChild(captureWrap);

  if (sourceArea) {
    // Clone the live DOM so original stays intact
    captureWrap.appendChild(sourceArea.cloneNode(true));
  } else if (cacheHtml) {
    captureWrap.innerHTML = cacheHtml;
  } else {
    alert('Report not ready yet ‚Äî please wait for it to finish loading and try again');
    captureWrap.remove();
    return;
  }

  // ‚îÄ‚îÄ Step 2: Get client pages from capture container ‚îÄ‚îÄ
  var captureArea  = captureWrap.querySelector('#shPrintArea') || captureWrap;
  var clientPages  = Array.from(captureArea.querySelectorAll('.client-page'));

  if (clientPages.length === 0) {
    alert('No participant data found in this report. The selected date range may have no service records.');
    captureWrap.remove();
    return;
  }

  var total = clientPages.length;
  console.log('PDF generation: found', total, 'client pages in capture container');

  // ‚îÄ‚îÄ Step 3: Switch modal to PDF progress UI ‚îÄ‚îÄ
  var modal       = document.getElementById('shReportModal');
  var contentArea = modal ? modal.querySelector('div:last-child') : null;
  if (contentArea) {
    window._shReportBackup = contentArea.innerHTML;
    contentArea.innerHTML =
      '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:400px;padding:40px;text-align:center">'
      + '<div style="font-size:48px;margin-bottom:16px">&#128230;</div>'
      + '<div style="font-size:17px;font-weight:800;color:var(--text);margin-bottom:6px">Generating PDFs</div>'
      + '<div id="pdfProgressStatus" style="font-size:13px;color:var(--muted);margin-bottom:20px;min-height:20px">Preparing...</div>'
      + '<div style="background:var(--border);border-radius:10px;height:16px;width:100%;max-width:480px;overflow:hidden;margin-bottom:8px">'
      + '<div id="pdfProgressBar" style="height:100%;background:linear-gradient(90deg,#059669,#10b981);border-radius:10px;width:0%;transition:width .4s ease"></div></div>'
      + '<div id="pdfProgressCount" style="font-size:12px;color:var(--muted);margin-bottom:16px">0 of ' + total + ' PDFs</div>'
      + '<div id="pdfProgressList" style="text-align:left;width:100%;max-width:480px;max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface)"></div>'
      + '</div>';
  }

  function setPdfProgress(done, status, listHtml) {
    var pct = Math.round((done / total) * 100);
    var bar = document.getElementById('pdfProgressBar');
    var st  = document.getElementById('pdfProgressStatus');
    var cnt = document.getElementById('pdfProgressCount');
    var lst = document.getElementById('pdfProgressList');
    if (bar) bar.style.width = pct + '%';
    if (st)  st.textContent  = status;
    if (cnt) cnt.textContent = done + ' of ' + total + ' PDFs complete';
    if (lst && listHtml) {
      var row = document.createElement('div');
      row.style.cssText = 'padding:6px 12px;font-size:11px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px';
      row.innerHTML = listHtml;
      lst.appendChild(row);
      lst.scrollTop = lst.scrollHeight;
    }
  }

  var pdfResults = [];

  // ‚îÄ‚îÄ Step 4: Iterate client pages and generate PDFs ‚îÄ‚îÄ
  function generateClientPDF(idx) {
    if (idx >= clientPages.length) {
      setPdfProgress(total, 'All ' + total + ' PDFs downloaded!', null);
      captureWrap.remove();
      setTimeout(function() { showPDFViewer(pdfResults); }, 800);
      return;
    }

    var page = clientPages[idx];

    // Extract client name from the header element
    var nameEl     = page.querySelector('[data-client-name]') || page.querySelector('div[style*="font-size:20px"]');
    var clientName = (nameEl ? nameEl.textContent : 'Participant_' + (idx + 1)).trim();
    var safeName   = clientName.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');

    setPdfProgress(idx, 'Creating PDF for ' + clientName + '...', null);

    // Replace canvas elements with static images for html2canvas compatibility
    var canvases   = page.querySelectorAll('canvas');
    var chartImgs  = [];
    canvases.forEach(function(c) {
      try {
        var img = document.createElement('img');
        img.src = c.toDataURL('image/png');
        img.style.cssText  = c.style.cssText;
        img.style.width    = '100%';
        img.style.height   = 'auto';
        chartImgs.push({ canvas: c, img: img, parent: c.parentNode });
        c.parentNode.replaceChild(img, c);
      } catch(e) { console.warn('Canvas capture failed:', e.message); }
    });

    html2canvas(page, {
      scale:         2,
      useCORS:       false,
      allowTaint:    true,
      backgroundColor: '#ffffff',
      logging:       false,
      windowWidth:   940,
      imageTimeout:  20000,
      onclone: function(doc) {
        // Hide any cross-origin images (Airtable attachments) that would break capture
        doc.querySelectorAll('img').forEach(function(img) {
          if (img.src && (img.src.indexOf('airtable') >= 0 || img.src.indexOf('amazonaws') >= 0)) {
            img.style.display = 'none';
          }
        });
      }
    }).then(function(canvas) {
      // Restore canvas elements
      chartImgs.forEach(function(ci) { try { ci.parent.replaceChild(ci.canvas, ci.img); } catch(e) {} });

      var pdf      = new jspdf.jsPDF('p', 'mm', 'a4');
      var pageW    = pdf.internal.pageSize.getWidth();
      var pageH    = pdf.internal.pageSize.getHeight();
      var margin   = 8;
      var contentW = pageW - margin * 2;
      var imgW     = canvas.width;
      var imgH     = canvas.height;
      var ratio    = contentW / imgW;
      var totalH   = imgH * ratio;
      var yOff     = 0;
      var pNum     = 0;

      while (yOff < totalH) {
        if (pNum > 0) pdf.addPage();
        var srcY = yOff / ratio;
        var srcH = Math.min((pageH - margin * 2) / ratio, imgH - srcY);
        if (srcH <= 0) break;
        var tc  = document.createElement('canvas');
        tc.width  = imgW;
        tc.height = Math.ceil(srcH);
        var ctx = tc.getContext('2d');
        ctx.drawImage(canvas, 0, Math.floor(srcY), imgW, Math.ceil(srcH), 0, 0, imgW, Math.ceil(srcH));
        pdf.addImage(tc.toDataURL('image/jpeg', 0.92), 'JPEG', margin, margin, contentW, srcH * ratio);
        yOff += pageH - margin * 2;
        pNum++;
        if (pNum > 50) break;
      }

      var fromD  = (window._shReportFrom || '').replace(/-/g, '');
      var toD    = (window._shReportTo   || '').replace(/-/g, '');
      var fname  = 'NDIS_Report_' + safeName + '_' + fromD + '_to_' + toD + '.pdf';
      var blob   = pdf.output('blob');
      var url    = URL.createObjectURL(blob);
      pdfResults.push({ name: clientName, filename: fname, url: url, blob: blob });

      // Trigger download
      var a = document.createElement('a');
      a.href = url; a.download = fname; a.click();

      // Auto-save to Airtable if triggered from client profile
      if (window._wrSaveClientName) {
        var rdr = new FileReader();
        rdr.onload = function(ev) {
          var b64     = ev.target.result.split(',')[1] || '';
          var headers2 = { 'Content-Type': 'application/json' };
          if (token) headers2['Authorization'] = 'Bearer ' + token;
          fetch('/api/weekly-reports', {
            method: 'POST', headers: headers2,
            body: JSON.stringify({
              clientName:  window._wrSaveClientName,
              pdfBase64:   b64,
              filename:    fname,
              reportFrom:  window._wrSaveFrom  || window._shReportFrom || '',
              reportTo:    window._wrSaveTo    || window._shReportTo   || '',
              generatedBy: (currentUser && currentUser.name) || localStorage.getItem('titus_email') || 'System'
            })
          })
          .then(function(r2) { return r2.json(); })
          .then(function(d2) {
            if (d2 && d2.id) console.log('Weekly report saved to Airtable:', d2.id);
            else console.warn('Weekly report Airtable save issue:', d2 && d2.error);
          })
          .catch(function(e2) { console.warn('Weekly report save error:', e2.message); });
        };
        rdr.readAsDataURL(blob);
      }

      setPdfProgress(idx + 1, 'Saved: ' + fname,
        '<span style="color:#059669">&#128229;</span> <span style="font-weight:700">' + clientName + '</span>'
        + ' <span style="font-size:10px;color:var(--muted)">&#10004; downloaded</span>');

      setTimeout(function() { generateClientPDF(idx + 1); }, 600);

    }).catch(function(e) {
      // Restore canvases even on error
      chartImgs.forEach(function(ci) { try { ci.parent.replaceChild(ci.canvas, ci.img); } catch(ex) {} });
      console.error('html2canvas error for "' + clientName + '":', e.message || e);
      setPdfProgress(idx + 1, 'Error on ' + clientName + ' ‚Äî skipping',
        '<span style="color:#d97706">&#9888;</span> ' + clientName + ' (error: ' + (e.message || 'unknown') + ')');
      setTimeout(function() { generateClientPDF(idx + 1); }, 200);
    });
  }

  // Small delay to let the progress UI paint before heavy computation
  setTimeout(function() { generateClientPDF(0); }, 150);
}


function shPdfSelect(idx){var pdfs=window._shPdfResults;if(!pdfs||!pdfs[idx])return;
document.getElementById("shPdfFrame").src=pdfs[idx].url;
document.querySelectorAll(".shPdfTab").forEach(function(t){
t.style.background=parseInt(t.getAttribute("data-idx"))===idx?"var(--surface)":"";
t.style.borderColor=parseInt(t.getAttribute("data-idx"))===idx?"var(--border)":"transparent";
t.style.boxShadow=parseInt(t.getAttribute("data-idx"))===idx?"0 1px 3px rgba(0,0,0,.06)":"none"})}
function shPdfDownloadOne(idx){var pdfs=window._shPdfResults;if(!pdfs||!pdfs[idx])return;
var a=document.createElement("a");a.href=pdfs[idx].url;a.download=pdfs[idx].filename;a.click()}
function shPdfDownloadAll(){var pdfs=window._shPdfResults||[];pdfs.forEach(function(p,i){
setTimeout(function(){var a=document.createElement("a");a.href=p.url;a.download=p.filename;a.click()},i*500)})}
function shPdfGoBack(){var modal=document.getElementById("shReportModal");if(!modal||!window._shReportBackup)return;
var content=modal.querySelector("div:last-child");
content.style.padding="";content.style.display="";content.style.flexDirection="";content.style.height="";content.style.overflow="";
content.innerHTML=window._shReportBackup;
// Re-render charts
if(window._shReportData){setTimeout(function(){renderShCharts(window._shReportData)},200)}}

function renderStakeholderResults(data,from,to){
var modal=document.getElementById("shReportModal");if(!modal)return;
var rangeLabel=data.from+" ‚Äî "+data.to;
var genTime=data.generatedAt||new Date().toLocaleString("en-AU");
var co=data.company||{};
var coName=co.tradingName||"Delta Community Support";
var coLegal=co.legalName||"";
var coAddr=[co.address,co.suburb,co.postcode].filter(function(v){return v}).join(", ");
var coNDIS=co.ndisProvider||"";
var coABN=co.abn||"";
var coPhone=co.mobile||"";
var coEmail=co.email||"";
window._shCharts={};var chartIdx=0;

var html='<div id="shPrintArea" style="max-width:900px;width:100%;margin:0 auto">';

// ‚ïê‚ïê‚ïê COVER / HEADER ‚ïê‚ïê‚ïê
html+='<div style="background:linear-gradient(135deg,#1E4BA0,#7C3AED);border-radius:14px;padding:32px 36px;margin-bottom:24px;color:#fff">';
html+='<div style="display:flex;justify-content:space-between;align-items:flex-start">';
html+='<div>';
if(co.logo)html+='<img src="'+co.logo+'" crossorigin="anonymous" style="height:40px;margin-bottom:8px;border-radius:4px" onerror="this.style.display=\'none\'">';
html+='<div style="font-size:26px;font-weight:800;letter-spacing:-.5px">'+coName+'</div>';
if(coLegal)html+='<div style="font-size:11px;opacity:.7;margin-top:2px">'+coLegal+'</div>';
html+='<div style="font-size:16px;font-weight:600;opacity:.9;margin-top:8px">NDIS Stakeholder Report</div>';
html+='<div style="font-size:12px;opacity:.75;margin-top:4px">Reporting Period: '+rangeLabel+'</div>';
html+='</div>';
html+='<div style="text-align:right;font-size:10px;opacity:.8;line-height:1.8">';
if(coNDIS)html+='<div><strong>NDIS Provider:</strong> '+coNDIS+'</div>';
if(coABN)html+='<div><strong>ABN:</strong> '+coABN+'</div>';
if(coAddr)html+='<div>'+coAddr+'</div>';
if(coPhone)html+='<div>'+coPhone+'</div>';
if(coEmail)html+='<div>'+coEmail+'</div>';
html+='<div style="margin-top:4px;opacity:.7">Generated: '+genTime+'</div>';
html+='</div></div></div>';

// About
html+='<div style="padding:14px 16px;background:#fff;border:1px solid #E8EBF0;border-radius:10px;margin-bottom:20px;font-size:11px;color:#374151;line-height:1.7">';
html+='<div style="font-size:12px;font-weight:700;color:#111;margin-bottom:4px">About This Report</div>';
html+='This report is structured to support NDIA plan review decision-making. Each participant has an individual report section with evidence across four domains: <strong>(1) Participant Outcomes & Goal Progress</strong>, <strong>(2) Functional Capacity & Independence Metrics</strong>, <strong>(3) Incident, Risk & Safeguarding</strong>, and <strong>(4) Emerging Needs & Life Stage Transitions</strong>. All analysis is generated from factual service delivery records. Charts and photographic evidence are included where available.</div>';

if(!data.clients||data.clients.length===0){
html+='<div style="text-align:center;padding:40px;color:#6B7280">No participant data found for this period.</div>';
}else{

// ‚ïê‚ïê‚ïê INDIVIDUAL CLIENT REPORTS ‚ïê‚ïê‚ïê
data.clients.forEach(function(c,cIdx){
html+='<div class="client-page" style="padding:24px;background:#fff;border:1px solid #E8EBF0;border-radius:14px;margin-bottom:28px">';

// ‚îÄ‚îÄ Client Header ‚îÄ‚îÄ
html+='<div style="margin-bottom:18px;padding-bottom:14px;border-bottom:3px solid #1E4BA0">';
html+='<div style="display:flex;justify-content:space-between;align-items:flex-start">';
html+='<div><div style="font-size:10px;font-weight:700;color:#1E4BA0;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">Participant Report</div>';
html+='<div style="font-size:20px;font-weight:800;color:#111" data-client-name="1">'+c.name+'</div>';
var info=c.info||{};
// NDIS Ref and Age line
var refAge=[];
if(info.ndisNumber)refAge.push('NDIS Ref#: <strong>'+info.ndisNumber+'</strong>');
if(info.age)refAge.push('Age: <strong>'+info.age+'</strong>');
if(refAge.length>0)html+='<div style="font-size:10px;color:#374151;margin-top:3px">'+refAge.join(' &nbsp;&nbsp;|&nbsp;&nbsp; ')+'</div>';
var meta=[];
if(info.serviceType)meta.push(info.serviceType);if(info.ndisType)meta.push(info.ndisType);if(info.suburb)meta.push(info.suburb);
if(meta.length>0)html+='<div style="font-size:10px;color:#6B7280;margin-top:3px">'+meta.join(' &nbsp;¬∑&nbsp; ')+'</div>';
if(info.supportCoordinator)html+='<div style="font-size:10px;color:#6B7280;margin-top:1px">Support Coordinator: <strong>'+info.supportCoordinator+'</strong></div>';
if(info.planExpiry){try{var pe=new Date(info.planExpiry);if(!isNaN(pe)){var dl=Math.ceil((pe-new Date())/86400000);html+='<div style="font-size:10px;color:'+(dl<60?"#EF4444":"#6B7280")+';margin-top:1px">Plan Expiry: '+pe.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})+(dl<60?' <strong>('+dl+' days)</strong>':'')+'</div>'}}catch(e){}}
html+='</div></div></div>';
var incCount=(c.incidents||[]).length;


// ‚îÄ‚îÄ 4 NDIA SECTIONS ‚îÄ‚îÄ
function renderAISection(ai,key,num,icon,title,color,fallbackHtml){
var s=ai[key]||"";var secHtml='<div style="margin-bottom:18px">';
secHtml+='<div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;padding-bottom:6px;border-bottom:2px solid '+color+'20"><span style="font-size:14px">'+icon+'</span><div style="font-size:11px;font-weight:800;color:'+color+';text-transform:uppercase;letter-spacing:.4px">'+num+'. '+title+'</div></div>';
if(s){var sentences=s.replace(/\n\n/g,' ').split(/(?<=\.)\s+/).filter(function(t){return t.trim().length>5});
secHtml+='<div style="padding:12px 14px;background:linear-gradient(135deg,'+color+'04,'+color+'02);border:1px solid '+color+'15;border-radius:8px"><ul style="margin:0;padding-left:18px;list-style:disc">';
sentences.forEach(function(sent){secHtml+='<li style="font-size:11px;color:#374151;line-height:1.7;margin-bottom:4px">'+sent.trim()+'</li>'});
secHtml+='</ul></div>'}
if(fallbackHtml)secHtml+=fallbackHtml;secHtml+='</div>';return secHtml}

var ai=c.aiSections||{};

// S1: Goal Progress
var goalEvidence='';
if(c.goals&&c.goals.length>0){
goalEvidence='<div style="margin-top:8px"><div style="font-size:9px;font-weight:700;color:#7C3AED;text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">üìé Supporting Evidence ‚Äî Goal Observations</div>';
var goalsByField={};c.goals.forEach(function(g){if(!goalsByField[g.field])goalsByField[g.field]=[];if(goalsByField[g.field].length<2)goalsByField[g.field].push(g)});
Object.keys(goalsByField).slice(0,5).forEach(function(gk){var entries=goalsByField[gk];
goalEvidence+='<div style="padding:4px 8px;margin-bottom:3px;background:rgba(124,58,237,.02);border-radius:4px;border-left:2px solid #7C3AED"><div style="font-size:9px;font-weight:600;color:#7C3AED">'+gk+'</div>';
entries.forEach(function(e){goalEvidence+='<div style="font-size:9px;color:#6B7280;line-height:1.4"><span style="font-weight:600;color:#0A9396">'+e.date+'</span> '+e.content.substring(0,180)+'</div>'});goalEvidence+='</div>'});goalEvidence+='</div>'}
html+=renderAISection(ai,'goalProgress','1','üéØ','Participant Outcomes & Goal Progress','#7C3AED',goalEvidence);

// S2: Functional Capacity
var capEvidence='';
if(c.shifts&&c.shifts.length>0){var ev=c.shifts.filter(function(s){return s.activity&&s.activity.length>20}).slice(0,4);
if(ev.length>0){capEvidence='<div style="margin-top:8px"><div style="font-size:9px;font-weight:700;color:#0A9396;text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">üìé Supporting Evidence ‚Äî Progress Notes</div>';
ev.forEach(function(s){capEvidence+='<div style="padding:6px 8px;margin-bottom:4px;background:#F8F9FC;border-radius:6px;border-left:2px solid #0A9396"><div style="font-size:9px;margin-bottom:2px"><span style="font-weight:700;color:#0A9396">'+s.date+'</span>';
if(s.worker)capEvidence+=' <span style="color:#6B7280">'+s.worker+'</span>';if(s.hours>0)capEvidence+=' <span style="color:#6B7280">('+s.hours+' hrs)</span>';
capEvidence+='</div><div style="font-size:10px;color:#374151;line-height:1.5">'+s.activity.substring(0,300)+(s.activity.length>300?'...':'')+'</div></div>'});capEvidence+='</div>'}}
// Photos in S2
if(c.photos&&c.photos.length>0){capEvidence+='<div style="margin-top:8px"><div style="font-size:9px;font-weight:700;color:#F59E0B;text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">üì∏ Photographic Evidence ('+c.photos.length+')</div>';
capEvidence+='<div style="display:flex;flex-wrap:wrap;gap:6px">';
c.photos.forEach(function(p){capEvidence+='<div style="position:relative;border-radius:6px;overflow:hidden;border:1px solid #E8EBF0"><img src="'+p.thumbnail+'" style="width:140px;height:100px;object-fit:cover;display:block;cursor:pointer" onclick="window.open(\''+p.url+'\',\'_blank\')">';
capEvidence+='<div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.7));padding:3px 5px">';
if(p.date)capEvidence+='<span style="font-size:7px;font-weight:600;color:#fff">'+p.date+'</span> ';if(p.worker)capEvidence+='<span style="font-size:7px;color:rgba(255,255,255,.8)">'+p.worker+'</span>';
capEvidence+='</div></div>'});capEvidence+='</div><div style="font-size:8px;color:#6B7280;margin-top:3px;font-style:italic">Photographic evidence captured during service delivery demonstrating participation and engagement.</div></div>'}
html+=renderAISection(ai,'functionalCapacity','2','üìä','Functional Capacity & Independence Metrics','#0A9396',capEvidence);

// S3: Incident/Risk
var riskEv='';var icN=(c.incidents||[]).length;var coN=(c.concerns||[]).length;
if(icN>0||coN>0){riskEv='<div style="margin-top:8px">';
if(icN>0){riskEv+='<div style="font-size:9px;font-weight:700;color:#EF4444;text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">üìé Incident Records ('+icN+')</div>';
c.incidents.forEach(function(inc){riskEv+='<div style="padding:6px 8px;margin-bottom:4px;background:rgba(239,68,68,.02);border-radius:6px;border-left:2px solid #EF4444"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px"><span style="font-size:9px;font-weight:700;color:#EF4444">'+inc.date+'</span>';
if(inc.category)riskEv+='<span style="font-size:8px;font-weight:600;padding:1px 5px;border-radius:3px;background:rgba(239,68,68,.06);color:#EF4444">'+inc.category+'</span>';
riskEv+='</div>';if(inc.description)riskEv+='<div style="font-size:9px;color:#374151;line-height:1.4">'+inc.description+'</div>';riskEv+='</div>'})}
if(coN>0){riskEv+='<div style="font-size:9px;font-weight:700;color:#F59E0B;text-transform:uppercase;letter-spacing:.3px;margin:6px 0 4px">üìé Health & Behaviour Concerns ('+coN+')</div>';
c.concerns.forEach(function(con){riskEv+='<div style="padding:6px 8px;margin-bottom:3px;background:rgba(245,158,11,.02);border-radius:6px;border-left:2px solid #F59E0B"><span style="font-size:9px;font-weight:600;color:#F59E0B">'+con.date+'</span> ';
if(con.worker)riskEv+='<span style="font-size:8px;color:#6B7280">('+con.worker+')</span> ';riskEv+='<div style="font-size:9px;color:#374151;line-height:1.4;margin-top:1px">'+con.text+'</div></div>'})}
riskEv+='</div>'}else{riskEv='<div style="margin-top:6px;font-size:10px;color:#10B981;font-style:italic">‚úì No incidents or concerns recorded. Service delivery stable with effective risk management.</div>'}
// Incident charts - by day and by category
if((c.chartIncByDay&&c.chartIncByDay.labels&&c.chartIncByDay.labels.length>0)||(c.chartIncidents&&c.chartIncidents.length>0)){
riskEv+='<div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">';
if(c.chartIncByDay&&c.chartIncByDay.labels&&c.chartIncByDay.labels.length>0){var icId="shChart_inc_"+cIdx;
riskEv+='<div style="flex:2;min-width:260px;padding:10px;background:#F8F9FC;border-radius:8px;border:1px solid #E8EBF0"><div style="font-size:9px;font-weight:700;color:#EF4444;text-transform:uppercase;letter-spacing:.3px;margin-bottom:6px">Incidents by Day & Category</div><canvas id="'+icId+'" height="140"></canvas></div>'}
if(c.chartIncidents&&c.chartIncidents.length>0){var icId2="shChart_incCat_"+cIdx;
riskEv+='<div style="flex:1;min-width:200px;padding:10px;background:#F8F9FC;border-radius:8px;border:1px solid #E8EBF0"><div style="font-size:9px;font-weight:700;color:#EF4444;text-transform:uppercase;letter-spacing:.3px;margin-bottom:6px">Total by Category</div><canvas id="'+icId2+'" height="140"></canvas></div>'}
riskEv+='</div>'}
html+=renderAISection(ai,'incidentRisk','3','üõ°Ô∏è','Incident, Risk & Safeguarding Summary','#EF4444',riskEv);

// S4: Emerging Needs
html+=renderAISection(ai,'emergingNeeds','4','üîÆ','Emerging Needs & Life Stage Transitions','#1E4BA0','');

// Per-client footer
html+='<div style="padding:8px 0;border-top:1px solid #E8EBF0;margin-top:8px;text-align:center;font-size:9px;color:#9CA3AF">'+coName+' ‚Äî Individual Participant Report ‚Äî '+c.name+' ‚Äî '+rangeLabel+'</div>';
html+='</div>'; // end client-page
});
}

// ‚ïê‚ïê‚ïê REPORT FOOTER ‚ïê‚ïê‚ïê
html+='<div style="padding:16px;background:#F8F9FC;border:1px solid #E8EBF0;border-radius:10px;margin-top:12px">';
html+='<div style="font-size:10px;color:#6B7280;line-height:1.7">This report has been prepared to support NDIS plan review processes. All observations are drawn from factual service delivery records maintained by '+coName+'. Photographic evidence is captured during support sessions. This report is intended for NDIA planners, Local Area Coordinators, support coordinators, and participant stakeholders.</div>';
html+='<div style="font-size:9px;color:#9CA3AF;margin-top:8px;text-align:center">Created using <strong style="color:#6B7280">Titus CRM</strong> ‚Äî your CRM, QMS, Lead &amp; Operations Software<br>Visit us at <a href="https://www.tituscrm.com.au" target="_blank" style="color:#1E4BA0;text-decoration:none">www.tituscrm.com.au</a> or email <a href="mailto:info@tituscrm.com.au" style="color:#1E4BA0;text-decoration:none">info@tituscrm.com.au</a></div>';
html+='</div>';
html+='</div>'; // end shPrintArea

var content=modal.querySelector("div:last-child");
var fullHtml='<div style="padding:24px;display:flex;justify-content:center">'+html+'</div>';
if(content)content.innerHTML=fullHtml;
window._shPrintAreaHTML=fullHtml; // cache for PDF capture if modal content gets replaced
window._shReportData=data;
renderShCharts(data);
}

function renderShCharts(data){
setTimeout(function(){
window._shCharts=window._shCharts||{};
data.clients.forEach(function(c,cIdx){
// Incident categories
// Incident stacked bar by day/category
if(c.chartIncByDay&&c.chartIncByDay.labels&&c.chartIncByDay.labels.length>0){
var iEl=document.getElementById("shChart_inc_"+cIdx);
if(iEl){try{var incColors=["#EF4444","#F59E0B","#7C3AED","#1E4BA0","#0A9396","#EC4899","#6366F1","#10B981"];
window._shCharts["i"+cIdx]=new Chart(iEl,{type:"bar",data:{labels:c.chartIncByDay.labels,datasets:c.chartIncByDay.datasets.map(function(ds,di){return{label:ds.category,data:ds.data,backgroundColor:incColors[di%incColors.length],borderRadius:3}})},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:{padding:6,usePointStyle:true,font:{size:9,family:"Plus Jakarta Sans"}}}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{size:9,family:"Plus Jakarta Sans"}}},y:{stacked:true,beginAtZero:true,ticks:{stepSize:1,font:{size:9}}}}}})}catch(e){}}}
// Incident total by category horizontal bar
if(c.chartIncidents&&c.chartIncidents.length>0){
var iEl2=document.getElementById("shChart_incCat_"+cIdx);
if(iEl2){try{var incColors2=["#EF4444","#F59E0B","#7C3AED","#1E4BA0","#0A9396","#EC4899","#6366F1","#10B981"];
window._shCharts["ic"+cIdx]=new Chart(iEl2,{type:"bar",data:{labels:c.chartIncidents.map(function(i){return i.category.length>22?i.category.substring(0,20)+"‚Ä¶":i.category}),datasets:[{data:c.chartIncidents.map(function(i){return i.count}),backgroundColor:c.chartIncidents.map(function(i,di){return incColors2[di%incColors2.length]}),borderRadius:3}]},options:{indexAxis:"y",responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{stepSize:1,font:{size:9}}},y:{ticks:{font:{size:9,family:"Plus Jakarta Sans"}}}}}})}catch(e){}}}
})},200)
}

function renderReports(){var rp=document.getElementById("rightPanel");
// Destroy old charts
Object.keys(reportCharts).forEach(function(k){if(reportCharts[k]){reportCharts[k].destroy();delete reportCharts[k]}});
var html='<div class="rp-hdr"><div class="rp-hdr-info"><div class="rp-hdr-avatar" style="background:linear-gradient(135deg,var(--teal),var(--royal))">üìä</div><div><div class="rp-hdr-name">Reports Dashboard</div><div class="rp-hdr-sub">'+calls.length+' calls ¬∑ '+smsList.length+' messages</div></div></div></div>';
html+='<div class="reports-wrap">';
// Filters
html+='<div class="reports-filters">';
html+='<div><label>Date Range</label><br><select id="rptDateRange" onchange="updateReports()"><option value="all">All Time</option><option value="today">Today</option><option value="7d" selected>Last 7 Days</option><option value="30d">Last 30 Days</option><option value="90d">Last 90 Days</option></select></div>';
html+='<div><label>Call Direction</label><br><select id="rptDirection" onchange="updateReports()"><option value="all">All</option><option value="inbound">Inbound Only</option><option value="outbound">Outbound Only</option></select></div>';
html+='<div><label>Handled By</label><br><select id="rptHandler" onchange="updateReports()"><option value="all">All</option><option value="ai">ü§ñ Denise AI Only</option><option value="human">Human Only</option></select></div>';
html+='<div><label>Operator / User</label><br><select id="rptUser" onchange="updateReports()"><option value="all">All Users</option></select></div>';
html+='</div>';
// KPIs
html+='<div class="reports-kpi-row" id="rptKpis"></div>';
// Charts row 1: Type breakdown + Direction
html+='<div class="reports-charts-row">';
html+='<div class="reports-chart-card"><h4>ü§ñ AI vs Human Calls</h4><canvas id="chartDirection"></canvas></div>';
html+='<div class="reports-chart-card"><h4>üìä Communication Mix</h4><canvas id="chartMix"></canvas></div>';
html+='</div>';
// Charts row 2: Hourly activity (full width)
html+='<div class="reports-charts-row">';
html+='<div class="reports-chart-card reports-chart-full"><h4>üïê Calls by Hour of Day</h4><canvas id="chartHourly"></canvas></div>';
html+='</div>';
// Charts row 3: Daily volume
html+='<div class="reports-charts-row">';
html+='<div class="reports-chart-card reports-chart-full"><h4>üìà Daily Call Volume</h4><canvas id="chartDaily"></canvas></div>';
html+='</div>';
// Recent calls table
html+='<div class="reports-table" id="rptTable"><h4>Recent Activity</h4><table><thead><tr><th>Date/Time</th><th>Direction</th><th>Handled By</th><th>Number</th><th>Contact</th><th>Duration</th><th>Status</th></tr></thead><tbody id="rptTableBody"></tbody></table></div>';
html+='</div>';
rp.innerHTML=html;
// Populate user filter
populateReportUsers();
setTimeout(updateReports,100)}

function populateReportUsers(){var sel=document.getElementById("rptUser");if(!sel)return;apiCall("GET","/api/admin/users").then(function(users){if(!users||!users.length)return;users.forEach(function(u){var opt=document.createElement("option");opt.value=u.name||u.email;opt.textContent=(u.name||u.email)+" ("+u.role+")";sel.appendChild(opt)})}).catch(function(){})}

function getFilteredData(){var range=document.getElementById("rptDateRange")?document.getElementById("rptDateRange").value:"all";var dir=document.getElementById("rptDirection")?document.getElementById("rptDirection").value:"all";var handler=document.getElementById("rptHandler")?document.getElementById("rptHandler").value:"all";var user=document.getElementById("rptUser")?document.getElementById("rptUser").value:"all";var now=new Date();var cutoff=null;if(range==="today"){cutoff=new Date(now.getFullYear(),now.getMonth(),now.getDate())}else if(range==="7d"){cutoff=new Date(now-7*86400000)}else if(range==="30d"){cutoff=new Date(now-30*86400000)}else if(range==="90d"){cutoff=new Date(now-90*86400000)}
var fc=calls.filter(function(c){if(cutoff&&new Date(c.created_at)<cutoff)return false;if(dir!=="all"&&c.type!==dir)return false;if(handler==="ai"&&c.type!=="inbound")return false;if(handler==="human"&&c.type!=="outbound")return false;if(user!=="all"){var name=c.participant||findContactName(c.type==="inbound"?c.from_number:c.to_number);if(name!==user)return false}return true});
var fs=smsList.filter(function(m){if(cutoff&&new Date(m.created_at)<cutoff)return false;return true});
return{calls:fc,sms:fs}}

function updateReports(){var data=getFilteredData();var fc=data.calls;var fs=data.sms;
// KPIs
var totalCalls=fc.length;var inbound=fc.filter(function(c){return c.type==="inbound"}).length;var outbound=fc.filter(function(c){return c.type==="outbound"}).length;var totalSms=fs.length;var totalDur=fc.reduce(function(s,c){return s+(parseInt(c.duration)||0)},0);var avgDur=totalCalls>0?Math.round(totalDur/totalCalls):0;
var kpiHtml='<div class="reports-kpi"><div class="kpi-val">'+totalCalls+'</div><div class="kpi-label">Total Calls</div></div>';
kpiHtml+='<div class="reports-kpi inbound"><div class="kpi-val">'+inbound+'</div><div class="kpi-label">Inbound</div></div>';
kpiHtml+='<div class="reports-kpi outbound"><div class="kpi-val">'+outbound+'</div><div class="kpi-label">Outbound</div></div>';
kpiHtml+='<div class="reports-kpi ai"><div class="kpi-val">'+inbound+'</div><div class="kpi-label">ü§ñ Denise AI</div><div class="kpi-sub">AI-answered calls</div></div>';
kpiHtml+='<div class="reports-kpi sms"><div class="kpi-val">'+totalSms+'</div><div class="kpi-label">SMS Sent</div></div>';
kpiHtml+='<div class="reports-kpi duration"><div class="kpi-val">'+avgDur+'s</div><div class="kpi-label">Avg Duration</div><div class="kpi-sub">Total: '+Math.round(totalDur/60)+'m</div></div>';
document.getElementById("rptKpis").innerHTML=kpiHtml;
// Direction pie chart - with AI breakdown
var ctx1=document.getElementById("chartDirection");if(ctx1){if(reportCharts.direction)reportCharts.direction.destroy();reportCharts.direction=new Chart(ctx1,{type:"doughnut",data:{labels:["ü§ñ Denise AI (Inbound)","Outbound (Human)"],datasets:[{data:[inbound,outbound],backgroundColor:["#7C3AED","#0A9396"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:"bottom",labels:{padding:16,usePointStyle:true,font:{size:12,family:"Plus Jakarta Sans"}}}}}})}
// Mix pie chart
var smsSent=fs.filter(function(m){return m.direction==="outbound"}).length;var smsReceived=fs.filter(function(m){return m.direction==="inbound"}).length;
var ctx2=document.getElementById("chartMix");if(ctx2){if(reportCharts.mix)reportCharts.mix.destroy();reportCharts.mix=new Chart(ctx2,{type:"doughnut",data:{labels:["ü§ñ Denise AI (Inbound)","Outbound Calls","SMS Sent","SMS Received"],datasets:[{data:[inbound,outbound,smsSent,smsReceived],backgroundColor:["#7C3AED","#0A9396","#F59E0B","#10B981"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:"bottom",labels:{padding:12,usePointStyle:true,font:{size:11,family:"Plus Jakarta Sans"}}}}}})}
// Hourly chart
var tz=AU_TIMEZONES[getAppTimezone()]||"Australia/Brisbane";var hourlyIn=new Array(24).fill(0);var hourlyOut=new Array(24).fill(0);
fc.forEach(function(c){try{var h=parseInt(new Date(c.created_at).toLocaleString("en-AU",{hour:"numeric",hour12:false,timeZone:tz}));if(c.type==="inbound")hourlyIn[h]++;else hourlyOut[h]++}catch(e){}});
var hourLabels=[];for(var i=0;i<24;i++){var ampm=i<12?"am":"pm";var h12=i===0?12:i>12?i-12:i;hourLabels.push(h12+(i===0||i===12?"":"")+ampm)}
var ctx3=document.getElementById("chartHourly");if(ctx3){if(reportCharts.hourly)reportCharts.hourly.destroy();reportCharts.hourly=new Chart(ctx3,{type:"bar",data:{labels:hourLabels,datasets:[{label:"ü§ñ Denise AI (Inbound)",data:hourlyIn,backgroundColor:"rgba(124,58,237,.7)",borderRadius:4},{label:"Outbound (Human)",data:hourlyOut,backgroundColor:"rgba(10,147,150,.7)",borderRadius:4}]},options:{responsive:true,maintainAspectRatio:true,scales:{x:{grid:{display:false},ticks:{font:{size:10,family:"Plus Jakarta Sans"}}},y:{beginAtZero:true,ticks:{stepSize:1,font:{size:10,family:"Plus Jakarta Sans"}}}},plugins:{legend:{position:"top",labels:{usePointStyle:true,font:{size:11,family:"Plus Jakarta Sans"}}}}}})}
// Daily volume chart
var dailyMap={};fc.forEach(function(c){var d=fmtDateInTZ(c.created_at);if(!dailyMap[d])dailyMap[d]={calls:0,sms:0};dailyMap[d].calls++});fs.forEach(function(m){var d=fmtDateInTZ(m.created_at);if(!dailyMap[d])dailyMap[d]={calls:0,sms:0};dailyMap[d].sms++});
var dailyKeys=Object.keys(dailyMap).sort(function(a,b){return new Date(a)-new Date(b)});var dailyCalls=dailyKeys.map(function(k){return dailyMap[k].calls});var dailySms=dailyKeys.map(function(k){return dailyMap[k].sms});
var ctx4=document.getElementById("chartDaily");if(ctx4){if(reportCharts.daily)reportCharts.daily.destroy();reportCharts.daily=new Chart(ctx4,{type:"bar",data:{labels:dailyKeys,datasets:[{label:"Calls",data:dailyCalls,backgroundColor:"rgba(10,147,150,.7)",borderRadius:4},{label:"SMS",data:dailySms,backgroundColor:"rgba(245,158,11,.7)",borderRadius:4}]},options:{responsive:true,maintainAspectRatio:true,scales:{x:{grid:{display:false},ticks:{font:{size:10,family:"Plus Jakarta Sans"}}},y:{beginAtZero:true,ticks:{stepSize:1,font:{size:10,family:"Plus Jakarta Sans"}}}},plugins:{legend:{position:"top",labels:{usePointStyle:true,font:{size:11,family:"Plus Jakarta Sans"}}}}}})}
// Table
var recent=fc.slice().sort(function(a,b){return(b.created_at||"").localeCompare(a.created_at||"")}).slice(0,20);var tbHtml="";recent.forEach(function(c){var phone=c.type==="inbound"?c.from_number:c.to_number;var name=c.participant||findContactName(phone);tbHtml+="<tr><td>"+fmtDateInTZ(c.created_at)+" "+fmtTimeInTZ(c.created_at)+"</td><td><span style='color:"+(c.type==="inbound"?"var(--royal)":"var(--teal)")+";font-weight:600'>"+c.type+"</span></td><td>"+(c.type==="inbound"?"<span style='color:#7C3AED;font-weight:600'>ü§ñ Denise AI</span>":"<span style='color:var(--muted)'>Human</span>")+"</td><td style='font-family:JetBrains Mono,monospace;font-size:11px'>"+(phone||"")+"</td><td>"+name+"</td><td>"+(c.duration||0)+"s</td><td>"+c.status+"</td></tr>"});document.getElementById("rptTableBody").innerHTML=tbHtml||"<tr><td colspan='7' style='text-align:center;color:var(--dim);padding:20px'>No calls in selected range</td></tr>"}

// ‚ïê‚ïê‚ïê TRAINING RECORDS ‚ïê‚ïê‚ïê
function loadTrainingRecords(name,email){
var el=document.getElementById("trainingContent");if(!el)return;
apiCall("GET","/api/lms/enrollments?name="+encodeURIComponent(name||"")+"&email="+encodeURIComponent(email||"")).then(function(records){
if(!records||records.length===0){
el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üéì</div><div style="font-size:13px;font-weight:600">No training records</div><div style="font-size:11px;margin-top:4px">Enroll in courses via HR / Recruit ‚Üí LMS</div></div>';return}
var h='<div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:10px">'+records.length+' enrollment'+(records.length!==1?"s":"")+'</div>';
records.forEach(function(r){
var statusCol=(r.status||"").toLowerCase()==="completed"?"var(--green)":(r.status||"").toLowerCase()==="enrolled"?"#3B82F6":"var(--muted)";
h+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:6px;border-left:3px solid '+statusCol+'">';
h+='<div style="display:flex;justify-content:space-between;align-items:center">';
h+='<div><div style="font-size:12px;font-weight:700;color:var(--text)">'+(r.courseName||"Course")+'</div>';
if(r.category)h+='<div style="font-size:10px;color:var(--muted);margin-top:2px">'+r.category+'</div>';
h+='</div>';
h+='<span style="font-size:10px;font-weight:600;padding:3px 8px;border-radius:8px;background:'+statusCol+'12;color:'+statusCol+';border:1px solid '+statusCol+'25">'+(r.status||"‚Äî")+'</span>';
h+='</div>';
if(r.enrollDate)h+='<div style="font-size:10px;color:var(--dim);margin-top:4px">Enrolled: '+r.enrollDate+'</div>';
h+='</div>'});
el.innerHTML=h}).catch(function(e){
if(el)el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>'})}

// ‚ïê‚ïê‚ïê SIDEBAR COLLAPSE ‚ïê‚ïê‚ïê
function toggleSidebar(){document.getElementById("dashboard").classList.toggle("sb-collapsed")}

// ‚ïê‚ïê‚ïê RECRUIT MENU ‚ïê‚ïê‚ïê
var recruitSubView="overview";
function toggleInboxMenu(e){
if(e)e.stopPropagation();
var sub=document.getElementById("inboxSub");
sub.classList.toggle("open");
if(sub.classList.contains("open")&&currentView!=="conversations"&&currentView!=="dialer"&&currentView!=="agent"){currentView="conversations";selectedConv=null;render()}}
function setInboxView(view){
currentView=view;selectedConv=null;
document.querySelectorAll("#inboxSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('#inboxSub [data-view="'+view+'"]');if(active)active.classList.add("on");
// Ensure inbox sub is open
var sub=document.getElementById("inboxSub");if(sub&&!sub.classList.contains("open"))sub.classList.add("open");
render()}

function toggleLeadsMenu(e){
if(e)e.stopPropagation();
var sub=document.getElementById("leadsSub");
sub.classList.toggle("open");
if(sub.classList.contains("open")){currentView="leads";selectedConv=null;if(!leadsSubView)leadsSubView="list";render()}}
function setLeadsView(sv){
leadsSubView=sv;currentView="leads";selectedConv=null;
document.querySelectorAll("#leadsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('#leadsSub [data-subview="'+sv+'"]');if(active)active.classList.add("on");
render()}

function toggleRecruitMenu(e){
if(e)e.stopPropagation();
var sub=document.getElementById("recruitSub");
sub.classList.toggle("open");
if(sub.classList.contains("open")){currentView="recruit";selectedConv=null;render()}}
function setRecruitView(sv){
recruitSubView=sv;currentView="recruit";selectedConv=null;
document.querySelectorAll(".sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('[data-subview="'+sv+'"]');if(active)active.classList.add("on");
render()}

function toggleReportsMenu(e){
if(e)e.stopPropagation();
var sub=document.getElementById("reportsSub");
sub.classList.toggle("open");
if(sub.classList.contains("open")&&currentView!=="reports"&&currentView!=="registers"&&currentView!=="files"){currentView="reports";selectedConv=null;render()}}
function setReportsMenuView(sv){
window._reportsSubView=sv==="reports"?"menu":sv;currentView="reports";selectedConv=null;
document.querySelectorAll("#reportsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('#reportsSub [data-subview="'+sv+'"]');if(active)active.classList.add("on");
var sub=document.getElementById("reportsSub");if(sub&&!sub.classList.contains("open"))sub.classList.add("open");
render()}

function toggleRostersMenu(e){
if(e)e.stopPropagation();
var sub=document.getElementById("rostersSub");
sub.classList.toggle("open");
if(sub.classList.contains("open")&&currentView!=="accommodation"&&currentView!=="scheduler"&&currentView!=="clientBudget"){currentView="scheduler";selectedConv=null;render()}}
function setRostersView(sv){
currentView=sv;selectedConv=null;
if(sv==="accommodation")accomDetailIdx=null;
document.querySelectorAll("#rostersSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('#rostersSub [data-subview="'+sv+'"]');if(active)active.classList.add("on");
var sub=document.getElementById("rostersSub");if(sub&&!sub.classList.contains("open"))sub.classList.add("open");
render()}

var contactsSubView="all";
function toggleContactsMenu(e){
if(e)e.stopPropagation();
var sub=document.getElementById("contactsSub");
sub.classList.toggle("open");
var contactViews=["contacts","sendClientAgreement","sendEmploymentContract","sendContractorAgreement"];
if(sub.classList.contains("open")&&contactViews.indexOf(currentView)<0){contactsSubView="all";currentView="contacts";selectedConv=null;render()}}

function setContactsView(sv){
contactsSubView=sv;
document.querySelectorAll("#contactsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});
if(sv==="all"){
currentView="contacts";selectedConv=null;
var active=document.querySelector('#contactsSub [data-subview="all"]');if(active)active.classList.add("on");
}else{
currentView=sv;selectedConv=null;
var active=document.querySelector('#contactsSub [data-view="'+sv+'"]');if(active)active.classList.add("on");
}
var sub=document.getElementById("contactsSub");if(sub&&!sub.classList.contains("open"))sub.classList.add("open");
render()}

// ‚ïê‚ïê‚ïê ACCOMMODATION (SIL Properties) ‚ïê‚ïê‚ïê
var accommodationData=[];
var accommodationLoaded=false;

function renderAccommodation(){
var rp=document.getElementById("rightPanel");
if(!accommodationLoaded){accommodationLoaded=true;
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading properties...</div></div></div>';
apiCall("GET","/api/accommodation").then(function(d){accommodationData=d||[];renderAccommodationContent(rp)}).catch(function(){accommodationData=[];renderAccommodationContent(rp)});return}
renderAccommodationContent(rp)}

var accomStatusFilter="Active";
var accomTypeFilter="";
var accomSearchQ="";
var accomDetailIdx=null;
var accomDetailTab="details";

function renderAccommodationContent(rp){
// If a property is selected, show detail view
if(accomDetailIdx!==null){renderAccomDetail(rp);return}
var stColors={"Active":"#10B981","Not Active":"#EF4444"};
var tpColors={"SDA Property":"#3B82F6","SIL Headlease":"#8B5CF6","Storage Facility":"#F59E0B"};
var q=accomSearchQ.toLowerCase();
var filtered=accommodationData.filter(function(p){
var matchQ=!q||(p.name||"").toLowerCase().indexOf(q)>=0||(p.suburb||"").toLowerCase().indexOf(q)>=0||(p.clients||"").toLowerCase().indexOf(q)>=0;
var matchSt=!accomStatusFilter||(p.status||"")===accomStatusFilter;
var matchTp=!accomTypeFilter||(p.propertyType||"")===accomTypeFilter;
return matchQ&&matchSt&&matchTp});
var types={};accommodationData.forEach(function(p){if(p.propertyType)types[p.propertyType]=1});
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px"><div><div style="font-size:22px;font-weight:700;color:var(--text)">üè† Accommodation</div><div style="font-size:13px;color:var(--muted)">'+filtered.length+' of '+accommodationData.length+' propert'+(accommodationData.length!==1?"ies":"y")+' ‚Äî SIL Properties</div></div></div>';
// Filters
h+='<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center">';
h+='<select id="accomStatusFilter" onchange="accomStatusFilter=this.value;renderAccommodationContent(document.getElementById(\'rightPanel\'))" style="padding:10px 16px;border:2px solid '+(accomStatusFilter==="Active"?"var(--green)":accomStatusFilter==="Not Active"?"var(--red)":"var(--border)")+';border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;background:'+(accomStatusFilter==="Active"?"rgba(16,185,129,.06)":accomStatusFilter==="Not Active"?"rgba(239,68,68,.06)":"var(--surface2)")+';cursor:pointer;color:'+(accomStatusFilter==="Active"?"var(--green)":accomStatusFilter==="Not Active"?"var(--red)":"var(--text)")+';min-width:140px"><option value=""'+(!accomStatusFilter?" selected":"")+'>All Status</option><option value="Active"'+(accomStatusFilter==="Active"?" selected":"")+'>‚úÖ Active</option><option value="Not Active"'+(accomStatusFilter==="Not Active"?" selected":"")+'>‚ùå Not Active</option></select>';
h+='<select id="accomTypeFilter" onchange="accomTypeFilter=this.value;renderAccommodationContent(document.getElementById(\'rightPanel\'))" style="padding:10px 16px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-weight:600;font-family:inherit;background:var(--surface2);cursor:pointer;min-width:140px"><option value="">All Types</option>';
Object.keys(types).sort().forEach(function(t){h+='<option value="'+t+'"'+(accomTypeFilter===t?" selected":"")+'>'+t+'</option>'});
h+='</select>';
h+='<input id="accomSearchInp" value="'+accomSearchQ+'" oninput="accomSearchQ=this.value;renderAccommodationContent(document.getElementById(\'rightPanel\'))" placeholder="Search properties, suburbs, clients..." style="flex:1;min-width:200px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);outline:none">';
h+='</div>';
// Property Cards Grid
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px">';
if(filtered.length===0){
h+='<div style="grid-column:1/-1;padding:60px;text-align:center;color:var(--muted)"><div style="font-size:48px;margin-bottom:12px">üè†</div><div style="font-size:15px;font-weight:600">No properties found</div></div>';
}else{
filtered.forEach(function(p){
var origIdx=accommodationData.indexOf(p);
var stCol=stColors[p.status]||"var(--muted)";
var tpCol=tpColors[p.propertyType]||"#94A3B8";
var thumb=(p.galleryPhotos&&p.galleryPhotos.length>0)?p.galleryPhotos[0].thumbnailUrl||p.galleryPhotos[0].url:"";
var clientList=(p.clientNames||p.clients||"").split(",").map(function(s){return s.trim()}).filter(function(s){return s});
h+='<div onclick="accomDetailIdx='+origIdx+';accomDetailTab=\'details\';renderAccommodationContent(document.getElementById(\'rightPanel\'))" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.boxShadow=\'0 4px 16px rgba(0,0,0,.08)\';this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,.04)\';this.style.transform=\'none\'">';
// Photo
if(thumb){
h+='<div style="height:180px;overflow:hidden;background:var(--surface2)"><img src="'+thumb+'" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML=\'<div style=display:flex;align-items:center;justify-content:center;height:100%;font-size:48px;color:var(--dim)>üè†</div>\'"></div>';
}else{
h+='<div style="height:180px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--surface2),var(--border));font-size:48px;color:var(--dim)">üè†</div>';
}
h+='<div style="padding:14px 16px">';
// Name + status
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><div style="font-size:15px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1">'+(p.name||"Unnamed")+'</div>';
h+='<span style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:8px;background:'+stCol+'12;color:'+stCol+';border:1px solid '+stCol+'25;white-space:nowrap;margin-left:8px">'+(p.status||"‚Äî")+'</span></div>';
// Suburb
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:10px">üìç '+(p.suburb||"‚Äî")+(p.address?" ‚Äî "+p.address:"")+'</div>';
// Info pills
h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">';
if(p.propertyType)h+='<span style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:6px;background:'+tpCol+'10;color:'+tpCol+';border:1px solid '+tpCol+'20">'+p.propertyType+'</span>';
if(p.totalRooms)h+='<span style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:6px;background:var(--surface2);color:var(--text);border:1px solid var(--border)">üõè '+p.totalRooms+' rooms</span>';
if(p.bathrooms)h+='<span style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:6px;background:var(--surface2);color:var(--text);border:1px solid var(--border)">üöø '+p.bathrooms+' bath</span>';
if(p.weeklyRent)h+='<span style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:6px;background:rgba(16,185,129,.06);color:var(--green);border:1px solid rgba(16,185,129,.15)">$'+p.weeklyRent+'/wk</span>';
if(p.silNum)h+='<span style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:6px;background:var(--surface2);color:var(--muted);border:1px solid var(--border)">SIL #'+p.silNum+'</span>';
h+='</div>';
// Clients
if(clientList.length>0){
h+='<div style="display:flex;gap:4px;flex-wrap:wrap">';
clientList.forEach(function(c){h+='<span style="font-size:9px;font-weight:600;padding:2px 7px;border-radius:6px;background:rgba(30,75,160,.06);color:var(--royal);border:1px solid rgba(30,75,160,.12)">üë§ '+c+'</span>'});
h+='</div>'}
// Photo count
if(p.galleryPhotos&&p.galleryPhotos.length>1){
h+='<div style="font-size:10px;color:var(--dim);margin-top:8px">üì∏ '+p.galleryPhotos.length+' photos</div>'}
h+='</div></div>'})}
h+='</div></div>';
rp.innerHTML=h}

// ‚îÄ‚îÄ Property Detail View (tabbed) ‚îÄ‚îÄ
function renderAccomDetail(rp){
var p=accommodationData[accomDetailIdx];if(!p){accomDetailIdx=null;renderAccommodationContent(rp);return}
var stCol={"Active":"#10B981","Not Active":"#EF4444"}[p.status]||"var(--muted)";
var tpCol={"SDA Property":"#3B82F6","SIL Headlease":"#8B5CF6","Storage Facility":"#F59E0B"}[p.propertyType]||"#94A3B8";
var tabs=[
{id:"details",label:"Property Details",icon:"üè†"},
{id:"realestate",label:"Real Estate",icon:"üè¢"},
{id:"docs",label:"Property Docs",icon:"üìÑ"},
{id:"utilities",label:"Utilities",icon:"‚ö°"},
{id:"audit",label:"Site Audit",icon:"üìã"},
{id:"onboarding",label:"SIL Onboarding",icon:"‚úÖ"}
];
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
// Back button
h+='<button onclick="accomDetailIdx=null;renderAccommodationContent(document.getElementById(\'rightPanel\'))" style="background:var(--royal);color:#FFD166;border:none;padding:8px 16px;border-radius:var(--rs);font-size:12px;font-weight:700;cursor:pointer;margin-bottom:16px;font-family:inherit">‚Üê Back to SIL List</button>';
// Header
h+='<div style="font-size:20px;font-weight:700;color:var(--text);margin-bottom:4px">Property Overview</div>';
// Tabs
h+='<div style="display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:24px;overflow-x:auto">';
tabs.forEach(function(t){
var active=accomDetailTab===t.id;
h+='<button onclick="accomDetailTab=\''+t.id+'\';renderAccomDetail(document.getElementById(\'rightPanel\'))" style="padding:10px 16px;font-size:12px;font-weight:'+(active?"700":"500")+';color:'+(active?"var(--teal)":"var(--muted)")+';border:none;border-bottom:2px solid '+(active?"var(--teal)":"transparent")+';background:none;cursor:pointer;white-space:nowrap;font-family:inherit;transition:all .15s;margin-bottom:-2px" onmouseover="if(!'+active+')this.style.color=\'var(--text)\'" onmouseout="if(!'+active+')this.style.color=\'var(--muted)\'">'+t.label+'</button>'});
h+='</div>';

// TAB CONTENT
if(accomDetailTab==="details"){
h+=accomTabDetails(p,stCol,tpCol);
}else if(accomDetailTab==="realestate"){
h+=accomTabRealEstate(p);
}else if(accomDetailTab==="docs"){
h+=accomTabDocs(p);
}else if(accomDetailTab==="utilities"){
h+=accomTabUtilities(p);
}else if(accomDetailTab==="audit"){
h+=accomTabAudit(p);
}else if(accomDetailTab==="onboarding"){
h+=accomTabOnboarding(p);
}
h+='</div>';rp.innerHTML=h}

function accomFieldRow(label,val){
if(!val||val===""||val==="-")return '';
return '<div style="display:flex;border-bottom:1px solid var(--border);padding:12px 0"><div style="width:240px;min-width:240px;font-size:12px;font-weight:600;color:var(--muted)">'+label+'</div><div style="font-size:12px;color:var(--text);flex:1;word-break:break-word">'+val+'</div></div>';
}
function accomFieldRowLink(label,val,href){
if(!val||val===""||val==="-")return '';
return '<div style="display:flex;border-bottom:1px solid var(--border);padding:12px 0"><div style="width:240px;min-width:240px;font-size:12px;font-weight:600;color:var(--muted)">'+label+'</div><div style="font-size:12px;flex:1"><a href="'+(href||"mailto:"+val)+'" style="color:var(--teal);text-decoration:none" target="_blank">‚úâ '+val+'</a></div></div>';
}
function accomFieldRowBadge(label,val,col){
if(!val||val===""||val==="-")return '';
return '<div style="display:flex;border-bottom:1px solid var(--border);padding:12px 0"><div style="width:240px;min-width:240px;font-size:12px;font-weight:600;color:var(--muted)">'+label+'</div><div style="font-size:12px;flex:1"><span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:8px;background:'+(col||"var(--teal)")+'15;color:'+(col||"var(--teal)")+';border:1px solid '+(col||"var(--teal)")+'25">'+val+'</span></div></div>';
}
function accomFieldRowAttach(label,atts){
if(!atts||atts.length===0)return '';
var h='<div style="display:flex;border-bottom:1px solid var(--border);padding:12px 0"><div style="width:240px;min-width:240px;font-size:12px;font-weight:600;color:var(--muted)">'+label+'</div><div style="font-size:12px;flex:1;display:flex;flex-wrap:wrap;gap:6px">';
atts.forEach(function(a){h+='<a href="'+a.url+'" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);text-decoration:none;font-size:11px;font-weight:600;color:var(--text);transition:all .12s" onmouseover="this.style.borderColor=\'var(--teal)\'" onmouseout="this.style.borderColor=\'var(--border)\'">üìé '+a.name+'</a>'});
h+='</div></div>';return h}
function accomYesNo(label,val){
if(!val||val===""||val==="-"||val===0)return '';
var isYes=typeof val==="string"&&(val.toLowerCase()==="yes"||val==="true"||val==="1"||val==="Yes");
var isNo=typeof val==="string"&&(val.toLowerCase()==="no"||val==="false"||val==="0"||val==="No");
var badge=isYes?'<span style="font-size:10px;font-weight:700;padding:2px 10px;border-radius:8px;background:rgba(16,185,129,.1);color:#10B981">Yes</span>':isNo?'<span style="font-size:10px;font-weight:700;padding:2px 10px;border-radius:8px;background:rgba(239,68,68,.1);color:#EF4444">No</span>':'<span style="font-size:11px;color:var(--text)">'+val+'</span>';
return '<div style="display:flex;align-items:center;border-bottom:1px solid var(--border);padding:12px 0"><div style="width:240px;min-width:240px;font-size:12px;font-weight:600;color:var(--muted)">'+label+'</div><div style="flex:1">'+badge+'</div></div>';
}

// ‚îÄ‚îÄ Tab: Property Details ‚îÄ‚îÄ
function accomTabDetails(p,stCol,tpCol){
var h='<div style="text-align:center;font-size:16px;font-weight:700;color:var(--text);margin-bottom:20px">SIL Property Details</div>';
// Photo + name header
var thumb=(p.galleryPhotos&&p.galleryPhotos.length>0)?p.galleryPhotos[0].thumbnailUrl||p.galleryPhotos[0].url:"";
h+='<div style="display:flex;gap:16px;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap">';
if(thumb)h+='<div style="width:120px;height:90px;border-radius:8px;overflow:hidden;border:1px solid var(--border);flex-shrink:0"><img src="'+thumb+'" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.style.display=\'none\'"></div>';
h+='<div><div style="font-size:18px;font-weight:700;color:var(--text)">'+(p.suburb||p.name)+'</div><div style="font-size:13px;color:var(--muted)">'+(p.address||p.name)+'</div></div></div>';
// Fields
h+=accomFieldRowBadge("Active or Inactive?",p.status,stCol);
h+=accomFieldRowBadge("Type of Property",p.propertyType,tpCol);
// Client names
if(p.clientNames||p.clients){
var cls=(p.clientNames||p.clients).split(",").map(function(s){return s.trim()}).filter(function(s){return s});
if(cls.length>0){
h+='<div style="display:flex;border-bottom:1px solid var(--border);padding:12px 0"><div style="width:240px;min-width:240px;font-size:12px;font-weight:600;color:var(--muted)">Client Name(s)</div><div style="display:flex;gap:6px;flex-wrap:wrap;flex:1">';
cls.forEach(function(c){h+='<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:8px;background:var(--surface2);color:var(--text);border:1px solid var(--border)">'+c+'</span>'});
h+='</div></div>'}}
h+=accomFieldRow("Home Address",p.address);
h+=accomFieldRow("Suburb",p.suburb);
h+=accomFieldRow("SIL #",p.silNum);
h+=accomFieldRow("Total Rooms",p.totalRooms);
h+=accomFieldRow("Bathrooms",p.bathrooms);
h+=accomFieldRow("Vacancies",p.vacancies);
h+=accomFieldRow("Weekly Rent","$"+(p.weeklyRent||"‚Äî"));
h+=accomFieldRow("House Leader",p.houseLeader);
h+=accomFieldRow("SIL Mobile",p.silMobile);
h+=accomFieldRow("SIL Email",p.silEmail);
h+=accomFieldRow("SIL Landline",p.silLandline);
h+=accomFieldRow("Mobile Phone Pin #",p.mobilePin);
h+=accomFieldRow("Laptop Password",p.laptopPassword);
h+=accomFieldRow("WIFI Modem",p.wifiModem);
h+=accomFieldRow("WIFI Password",p.wifiPassword);
h+=accomFieldRow("Lockbox or Keypad Details",p.lockboxDetails);
h+=accomFieldRow("Description",p.description);
h+=accomFieldRow("Notes",p.notes);
// Photo Gallery
if(p.galleryPhotos&&p.galleryPhotos.length>0){
h+='<div style="margin-top:20px"><div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px">Property Photo Gallery</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">';
p.galleryPhotos.forEach(function(ph,pi){
h+='<div onclick="openAccomImage('+accomDetailIdx+','+pi+')" style="cursor:pointer;border-radius:8px;overflow:hidden;border:1px solid var(--border);aspect-ratio:1;background:var(--surface2);transition:all .12s" onmouseover="this.style.borderColor=\'var(--teal)\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
h+='<img src="'+(ph.thumbnailUrl||ph.url)+'" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML=\'<div style=padding:8px;text-align:center;font-size:10px;color:var(--dim)>üì∑</div>\'">';
h+='</div>'});
h+='</div></div>'}
return h}

// ‚îÄ‚îÄ Tab: Real Estate ‚îÄ‚îÄ
function accomTabRealEstate(p){
var h='<div style="text-align:center;font-size:16px;font-weight:700;color:var(--text);margin-bottom:20px">REAL ESTATE</div>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px">'+(p.suburb||"")+'</div>';
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:16px">'+(p.address||p.name)+'</div>';
h+=accomFieldRowBadge("Type of Property",p.propertyType,{"SDA Property":"#3B82F6","SIL Headlease":"#8B5CF6","Storage Facility":"#F59E0B"}[p.propertyType]||"#94A3B8");
h+=accomFieldRow("SDA Provider Name",p.sdaProviderName);
h+=accomFieldRow("SDA Phone Number",p.sdaPhone);
h+=accomFieldRowLink("SDA Email Address",p.sdaEmail);
h+=accomFieldRow("Real Estate Name",p.realEstateName);
h+=accomFieldRowLink("Real Estate Email",p.realEstateEmail);
h+=accomFieldRow("Real Estate Phone #",p.realEstatePhone);
h+=accomFieldRow("Lease Start Date",p.leaseStartDate);
h+=accomFieldRow("Lease End Date",p.leaseEndDate);
h+=accomFieldRowAttach("Entry Report",p.entryReport);
h+=accomFieldRow("Electrical Repairs",p.electricalRepairs);
h+=accomFieldRow("Plumbing Repairs",p.plumbingRepairs);
h+=accomFieldRow("Other Repairs",p.otherRepairs);
h+=accomFieldRow("Lawns Maintenance",p.lawns);
h+=accomFieldRowLink("Lawns Email",p.lawnsEmail);
h+=accomFieldRow("Lawns Mobile",p.lawnsMobile);
h+=accomFieldRow("Electricity Provider Name",p.electricityProvider);
h+=accomFieldRow("Gas Provider Name",p.gasProvider);
return h}

// ‚îÄ‚îÄ Tab: Property Docs ‚îÄ‚îÄ
function accomTabDocs(p){
var h='<div style="text-align:center;font-size:16px;font-weight:700;color:var(--text);margin-bottom:20px">PROPERTY DOCS</div>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px">'+(p.suburb||"")+'</div>';
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:16px">'+(p.address||p.name)+'</div>';
h+=accomFieldRowBadge("Type of Property",p.propertyType,{"SDA Property":"#3B82F6","SIL Headlease":"#8B5CF6","Storage Facility":"#F59E0B"}[p.propertyType]||"#94A3B8");
h+=accomFieldRow("Weekly Rent Amount",p.weeklyRent?"$"+p.weeklyRent:"");
h+=accomFieldRowAttach("Lease Agreement",p.leaseAgreement);
h+=accomFieldRow("Lease Start Date",p.leaseStartDate);
h+=accomFieldRow("Lease End Date",p.leaseEndDate);
h+=accomFieldRowAttach("Entry Report",p.entryReport);
h+=accomFieldRow("Condition Report Completed?",p.conditionReport);
h+=accomFieldRow("Completed by whom?",p.conditionReportBy);
h+=accomFieldRow("SDA Provider Name",p.sdaProviderName);
h+=accomFieldRow("SDA Phone Number",p.sdaPhone);
h+=accomFieldRowLink("SDA Email Address",p.sdaEmail);
h+=accomFieldRow("Real Estate Name",p.realEstateName);
h+=accomFieldRowLink("Real Estate Email",p.realEstateEmail);
h+=accomFieldRow("Real Estate Phone #",p.realEstatePhone);
h+=accomFieldRowAttach("Safe Environment Document",p.safeEnvDoc);
h+=accomFieldRowAttach("Fire Drill",p.fireDrill);
// Show all other doc attachments
var otherDocs=p.attachments.filter(function(a){
var skip=["Property Photo Gallery","Lease Agreement","Entry Report","Safe Environment Document","Fire Drill"];
return skip.indexOf(a.field)<0});
if(otherDocs.length>0)h+=accomFieldRowAttach("Other Documents",otherDocs);
return h}

// ‚îÄ‚îÄ Tab: Utilities ‚îÄ‚îÄ
function accomTabUtilities(p){
var h='<div style="text-align:center;font-size:16px;font-weight:700;color:var(--text);margin-bottom:20px">UTILITIES</div>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px">'+(p.suburb||"")+'</div>';
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:16px">'+(p.address||p.name)+'</div>';
h+=accomFieldRow("Gas Provider Name",p.gasProvider);
h+=accomFieldRow("Electricity Provider Name",p.electricityProvider);
h+=accomFieldRow("Internet Provider Name",p.internetProvider);
h+=accomFieldRow("Electricity Connected?",p.electricityConnected);
h+=accomFieldRow("Gas Connected?",p.gasConnected);
h+=accomFieldRow("Internet",p.internetConnected);
h+=accomFieldRow("WIFI Modem",p.wifiModem);
h+=accomFieldRow("WIFI Password",p.wifiPassword);
h+=accomFieldRow("Printer Make & Model",p.printerMakeModel);
h+=accomFieldRow("Printer Ink Cartridge",p.printerInkCartridge);
return h}

// ‚îÄ‚îÄ Tab: Site Audit ‚îÄ‚îÄ
function accomTabAudit(p){
var h='<div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:16px">Site Audit</div>';
h+=accomFieldRow("Gender of Support Workers",p.genderSW);
h+=accomFieldRow("Emergency & Fire Drill Date",p.emergencyDrillDate);
// Site visits from allFields
var visits=p.allFields["SIL Site Visits"]||[];
if(Array.isArray(visits)&&visits.length>0){
h+='<div style="margin-top:16px;font-size:12px;font-weight:700;color:var(--muted);margin-bottom:10px">SIL Site Visits</div>';
h+='<div style="font-size:11px;color:var(--muted)">'+visits.length+' visit record'+(visits.length!==1?"s":"")+" linked</div>";
}else{
h+='<div style="padding:40px;text-align:center;color:var(--muted);margin-top:20px"><div style="font-size:32px;margin-bottom:8px">üìã</div><div style="font-size:13px;font-weight:600">Site audit data is linked from the SIL Site Visits table</div></div>';
}
return h}

// ‚îÄ‚îÄ Tab: SIL Onboarding ‚îÄ‚îÄ
function accomTabOnboarding(p){
var pct=p.onboardingPct;
var pctNum=parseFloat(pct)||0;
var pctCol=pctNum>=100?"#10B981":pctNum>=70?"#F59E0B":"#EF4444";
var h='<div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:4px">SIL Onboarding Checklist</div>';
h+='<div style="font-size:11px;color:var(--muted);margin-bottom:16px">The Onboarding % if fully compliant should be at 100%, review the checklist of below. The checklist assists office staff to know what has been set up.</div>';
// Onboarding bar
h+='<div style="display:flex;gap:16px;align-items:center;margin-bottom:20px;flex-wrap:wrap">';
h+='<div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Onboarding Completion rate is %</div>';
h+='<div style="display:flex;align-items:center;gap:8px"><span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:8px;background:'+pctCol+'15;color:'+pctCol+'">Compliance</span><div style="width:120px;height:8px;background:var(--border);border-radius:4px;overflow:hidden"><div style="height:100%;width:'+pctNum+'%;background:'+pctCol+';border-radius:4px"></div></div><span style="font-size:11px;font-weight:700;color:'+pctCol+'">'+Math.round(pctNum)+'%</span></div></div>';
h+='<div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Address</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+(p.address||p.name)+'</div></div>';
h+='<div><div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Suburb</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+(p.suburb||"‚Äî")+'</div></div></div>';
// Checklist items
var items=[
{label:"Intake Form",val:p.intakeForm},
{label:"Individual Risk Assessment Form",val:p.riskAssessment},
{label:"Client Consent Form",val:p.clientConsent},
{label:"Emergency Personal Plan",val:p.emergencyPlan},
{label:"Support Plan",val:p.supportPlan},
{label:"Service Agreement",val:p.serviceAgreement},
{label:"Schedule of Support",val:p.scheduleOfSupport},
{label:"SIL Asset Register",val:p.silAssetRegister},
{label:"Wifi Connected?",val:p.wifiConnected},
{label:"Rooming Agreement",val:p.roomingAgreement},
{label:"Laptop, Email & Mobile?",val:p.laptopEmailMobile},
{label:"Client info in Titus CRM",val:p.clientInfoCRM},
{label:"Policies & Procedures in Staffroom?",val:p.policiesProcedures}
];
items.forEach(function(it){h+=accomYesNo(it.label,it.val)});
return h}

function filterAccomList(){}

function openAccomImage(propIdx,imgIdx){
var p=accommodationData[propIdx];if(!p)return;
var photos=p.galleryPhotos&&p.galleryPhotos.length>0?p.galleryPhotos:p.photos;
if(!photos||!photos[imgIdx])return;
var cur=imgIdx;
var ov=document.createElement("div");ov.id="accomImgOverlay";
ov.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px";
function renderImg(){
var ph=photos[cur];
ov.innerHTML='<div style="position:relative;max-width:90vw;max-height:90vh;text-align:center">'
+'<img src="'+ph.url+'" style="max-width:90vw;max-height:80vh;object-fit:contain;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.5)">'
+'<div style="margin-top:12px;color:#fff;font-size:12px;font-weight:600">'+(cur+1)+' / '+photos.length+(ph.name?' ‚Äî '+ph.name:'')+'</div>'
+(photos.length>1?'<button onclick="accomImgNav(-1)" style="position:absolute;left:-50px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.15);border:none;color:#fff;font-size:28px;width:40px;height:40px;border-radius:50%;cursor:pointer">‚Äπ</button><button onclick="accomImgNav(1)" style="position:absolute;right:-50px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.15);border:none;color:#fff;font-size:28px;width:40px;height:40px;border-radius:50%;cursor:pointer">‚Ä∫</button>':'')
+'<button onclick="document.getElementById(\'accomImgOverlay\').remove()" style="position:absolute;top:-40px;right:0;background:none;border:none;color:#fff;font-size:24px;cursor:pointer">‚úï</button></div>'}
renderImg();
ov.onclick=function(e){if(e.target===ov)ov.remove()};
window.accomImgNav=function(dir){cur=(cur+dir+photos.length)%photos.length;renderImg()};
document.body.appendChild(ov)}

// ‚ïê‚ïê‚ïê CLIENT BUDGET (NDIS Plan Budgets) ‚ïê‚ïê‚ïê
var clientBudgetData=[];
var clientBudgetLoaded=false;
var cbFiles=[];
var cbScanned=[];
var cbFilter="";
var cbSearch="";
var cbSelectedClient=null;

function renderClientBudget(){
var rp=document.getElementById("rightPanel");
if(!clientBudgetLoaded){clientBudgetLoaded=true;
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading client budgets...</div></div></div>';
apiCall("GET","/api/client-budgets").then(function(d){clientBudgetData=d||[];renderClientBudgetContent(rp)}).catch(function(){clientBudgetData=[];renderClientBudgetContent(rp)});return}
renderClientBudgetContent(rp)}

function renderClientBudgetContent(rp){
var data=clientBudgetData;
var searchVal=cbSearch.toLowerCase();
var filtered=data.filter(function(r){
var acct=(r.accountType||"").toLowerCase();
// Status filter ‚Äî must check "inactive"/"not active" BEFORE "active" since "inactive" contains "active"
if(cbFilter==="active"){
  var isActive=acct.indexOf("active")>=0&&acct.indexOf("not")< 0&&acct.indexOf("in")<0;
  if(!isActive)return false;
}
if(cbFilter==="inactive"){
  if(acct.indexOf("inactive")<0&&acct.indexOf("not active")<0)return false;
}
if(cbFilter==="prospect"){
  if(acct.indexOf("prospect")<0&&acct.indexOf("propsect")<0)return false;
}
if(searchVal&&(r.clientName||"").toLowerCase().indexOf(searchVal)<0&&(r.ndisRef||"").toLowerCase().indexOf(searchVal)<0&&(r.uniqueRef||"").toLowerCase().indexOf(searchVal)<0)return false;
return true});

// Calculate summary totals
var totalSIL=0,totalCA=0,totalTransport=0,totalBudget=0,totalInvoiced=0,activeClients=0;
filtered.forEach(function(r){
totalSIL+=parseFloat(r.coreBudgetSIL)||0;
totalCA+=parseFloat(r.coreBudgetCA)||0;
totalTransport+=parseFloat(r.coreBudgetTransport)||0;
totalBudget+=parseFloat(r.totalBudget)||0;
totalInvoiced+=parseFloat(r.invoiceAmount)||0;
if((r.accountType||"").toLowerCase().indexOf("active")>=0)activeClients++});
var totalRemaining=totalBudget-totalInvoiced;

var h='<div style="padding:24px;overflow-y:auto;height:100%">';

// ‚îÄ‚îÄ Header ‚îÄ‚îÄ
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px"><div><div style="font-size:22px;font-weight:700;color:var(--text)">üí∞ Client Budgets</div><div style="font-size:13px;color:var(--muted)">'+filtered.length+' budget record'+(filtered.length!==1?"s":"")+'</div></div>';
h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
h+='<button class="btn btn-teal" onclick="openUploadSOSModal()">üìÑ Upload SOS</button>';
h+='<button class="btn btn-p" style="width:auto;padding:8px 16px" onclick="openAddBudgetModal()">+ Add Budget</button>';
h+='</div></div>';

// ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ
h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px">';

var cards=[
{label:"Core Budget (SIL)",val:totalSIL,icon:"üè†",color:"#3B82F6"},
{label:"Core Budget (CA)",val:totalCA,icon:"üö∂",color:"#8B5CF6"},
{label:"Core Budget (Transport)",val:totalTransport,icon:"üöó",color:"#F59E0B"},
{label:"Total Budget",val:totalBudget,icon:"üí∞",color:"var(--teal)"},
{label:"Total Invoiced",val:totalInvoiced,icon:"üßæ",color:"#EC4899"},
{label:"Remaining",val:totalRemaining,icon:"üìä",color:totalRemaining>=0?"#10B981":"#EF4444"}
];
cards.forEach(function(c){
h+='<div style="padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);border-left:3px solid '+c.color+'">';
h+='<div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">'+c.icon+' '+c.label+'</div>';
h+='<div style="font-size:20px;font-weight:700;color:'+(c.label==="Remaining"?c.color:"var(--text)")+'">$'+c.val.toLocaleString("en-AU",{minimumFractionDigits:2,maximumFractionDigits:2})+'</div>';
h+='</div>'});
h+='</div>';

// ‚îÄ‚îÄ Utilisation Bar ‚îÄ‚îÄ
if(totalBudget>0){
var pct=Math.min(100,Math.round((totalInvoiced/totalBudget)*100));
var barCol=pct>90?"#EF4444":pct>75?"#F59E0B":"#10B981";
h+='<div style="margin-bottom:20px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r)">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-size:12px;font-weight:700;color:var(--text)">Budget Utilisation</span><span style="font-size:12px;font-weight:700;color:'+barCol+'">'+pct+'%</span></div>';
h+='<div style="height:10px;background:var(--border);border-radius:6px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+barCol+';border-radius:6px;transition:width .5s ease"></div></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:6px"><span style="font-size:10px;color:var(--muted)">$'+totalInvoiced.toLocaleString("en-AU",{minimumFractionDigits:2})+" invoiced</span><span style=\"font-size:10px;color:var(--muted)\">$"+totalBudget.toLocaleString("en-AU",{minimumFractionDigits:2})+" total</span></div>";
h+='</div>'}

// ‚îÄ‚îÄ Search & Filter ‚îÄ‚îÄ
h+='<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">';
h+='<select id="cbStatusFilter" onchange="cbFilter=this.value;renderClientBudgetContent(document.getElementById(\'rightPanel\'))" style="padding:10px 16px;border:2px solid '+(cbFilter==="active"?"var(--green)":cbFilter==="inactive"?"var(--red)":cbFilter==="prospect"?"var(--orange)":"var(--border)")+';border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;background:'+(cbFilter==="active"?"rgba(16,185,129,.06)":cbFilter==="inactive"?"rgba(239,68,68,.06)":cbFilter==="prospect"?"rgba(245,158,11,.06)":"var(--surface2)")+';cursor:pointer;color:'+(cbFilter==="active"?"var(--green)":cbFilter==="inactive"?"var(--red)":cbFilter==="prospect"?"var(--orange)":"var(--text)")+';min-width:160px">';
h+='<option value=""'+(cbFilter===""?" selected":"")+'>All Status</option>';
h+='<option value="active"'+(cbFilter==="active"?" selected":"")+'>‚úÖ Active</option>';
h+='<option value="inactive"'+(cbFilter==="inactive"?" selected":"")+'>‚ùå Inactive</option>';
h+='<option value="prospect"'+(cbFilter==="prospect"?" selected":"")+'>üî∂ Prospect</option></select>';
h+='<input id="cbSearchInput" value="'+cbSearch+'" oninput="cbSearch=this.value;renderClientBudgetContent(document.getElementById(\'rightPanel\'))" placeholder="Search by client name, NDIS ref..." style="flex:1;min-width:200px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);outline:none">';
h+='</div>';

// ‚îÄ‚îÄ Table ‚îÄ‚îÄ
h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
h+='<thead><tr style="border-bottom:2px solid var(--border)">';
["Client Name","NDIS Ref","Plan Type","SIL/CAS","SIL Budget","CA Budget","Transport","Total Budget","Invoiced","Remaining","Status","Created","Updated","SOS"].forEach(function(col){
h+='<th style="padding:8px 6px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>'});
h+='</tr></thead><tbody id="cbTbody">';

if(filtered.length===0){
h+='<tr><td colspan="14" style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:40px;margin-bottom:10px">üí∞</div><div style="font-size:14px;font-weight:600">No budget records found</div><div style="font-size:12px;margin-top:4px">Click <strong>+ Add Budget</strong> or <strong>üìÑ Upload SOS</strong> to get started</div></td></tr>'
}else{
filtered.forEach(function(r,idx){
var silB=parseFloat(r.coreBudgetSIL)||0;
var caB=parseFloat(r.coreBudgetCA)||0;
var trB=parseFloat(r.coreBudgetTransport)||0;
var totB=parseFloat(r.totalBudget)||0;
var inv=parseFloat(r.invoiceAmount)||0;
var rem=totB-inv;
var acctType=(r.accountType||"").toLowerCase();
var stCol=acctType.indexOf("active")>=0&&acctType.indexOf("not")<0&&acctType.indexOf("in")<0?"#10B981":acctType.indexOf("prospect")>=0||acctType.indexOf("propsect")>=0?"#F59E0B":"#EF4444";
var stLabel=acctType.indexOf("active")>=0&&acctType.indexOf("not")<0&&acctType.indexOf("in")<0?"Active":acctType.indexOf("prospect")>=0||acctType.indexOf("propsect")>=0?"Prospect":"Inactive";
var remCol=rem<0?"var(--red)":rem===0?"var(--muted)":"var(--green)";
var hasSOS=r.uploadSOS&&((Array.isArray(r.uploadSOS)&&r.uploadSOS.length>0)||(!Array.isArray(r.uploadSOS)&&r.uploadSOS));
var origIdx=data.indexOf(r);

h+='<tr data-cbidx="'+origIdx+'" onclick="openBudgetDetailModal('+origIdx+')" style="border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
h+='<td style="padding:8px 6px;font-weight:700;color:var(--text);white-space:nowrap">'+(r.clientName||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--muted);font-family:JetBrains Mono,monospace">'+(r.ndisRef||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:10px">'+(r.planType||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px"><span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px;background:'+(r.silOrCas==="SIL"?"rgba(59,130,246,.08)":"rgba(16,185,129,.08)")+';color:'+(r.silOrCas==="SIL"?"#3B82F6":"#10B981")+';border:1px solid '+(r.silOrCas==="SIL"?"rgba(59,130,246,.15)":"rgba(16,185,129,.15)")+'">'+(r.silOrCas||"‚Äî")+'</span></td>';
h+='<td style="padding:8px 6px;font-size:11px;font-weight:600;color:var(--text)">'+(silB?"$"+silB.toLocaleString("en-AU",{minimumFractionDigits:2}):"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;font-weight:600;color:var(--text)">'+(caB?"$"+caB.toLocaleString("en-AU",{minimumFractionDigits:2}):"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;font-weight:600;color:var(--text)">'+(trB?"$"+trB.toLocaleString("en-AU",{minimumFractionDigits:2}):"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:12px;font-weight:700;color:var(--teal)">'+(totB?"$"+totB.toLocaleString("en-AU",{minimumFractionDigits:2}):"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;font-weight:600;color:#EC4899">'+(inv?"$"+inv.toLocaleString("en-AU",{minimumFractionDigits:2}):"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;font-weight:700;color:'+remCol+'">'+(totB?"$"+rem.toLocaleString("en-AU",{minimumFractionDigits:2}):"‚Äî")+'</td>';
h+='<td style="padding:8px 6px"><span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px;background:'+stCol+'12;color:'+stCol+';border:1px solid '+stCol+'25">'+stLabel+'</span></td>';
h+='<td style="padding:8px 6px;font-size:10px;color:var(--muted);white-space:nowrap">'+(r.created||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:10px;color:var(--muted);white-space:nowrap">'+(r.lastUpdate||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;text-align:center">'+(hasSOS?'<span title="SOS uploaded" style="cursor:help">üìé</span>':'<span style="color:var(--dim)">‚Äî</span>')+'</td>';
h+='</tr>'})}

h+='</tbody></table></div></div>';
rp.innerHTML=h;
// Restore search focus
var si=document.getElementById("cbSearchInput");if(si&&cbSearch)si.focus()}

// ‚îÄ‚îÄ Budget Detail Modal ‚îÄ‚îÄ
function openBudgetDetailModal(idx){
var r=clientBudgetData[idx];if(!r)return;
var overlay=document.createElement("div");
overlay.id="cbDetailOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

var silB=parseFloat(r.coreBudgetSIL)||0;
var caB=parseFloat(r.coreBudgetCA)||0;
var trB=parseFloat(r.coreBudgetTransport)||0;
var totB=parseFloat(r.totalBudget)||0;
var inv=parseFloat(r.invoiceAmount)||0;
var rem=totB-inv;
var pct=totB>0?Math.round((inv/totB)*100):0;
var barCol=pct>90?"#EF4444":pct>75?"#F59E0B":"#10B981";
var acctType=(r.accountType||"").toLowerCase();
var stCol=acctType.indexOf("active")>=0&&acctType.indexOf("not")<0&&acctType.indexOf("in")<0?"#10B981":acctType.indexOf("prospect")>=0||acctType.indexOf("propsect")>=0?"#F59E0B":"#EF4444";
var stLabel=acctType.indexOf("active")>=0&&acctType.indexOf("not")<0&&acctType.indexOf("in")<0?"Active":acctType.indexOf("prospect")>=0||acctType.indexOf("propsect")>=0?"Prospect":"Inactive";

var h='<div style="background:var(--surface);border-radius:12px;max-width:680px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';

// Header
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0">';
h+='<div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">üí∞</span><div><div style="font-size:16px;font-weight:700;color:var(--text)">'+(r.clientName||"Client Budget")+'</div>';
h+='<div style="font-size:11px;color:var(--muted)">'+(r.ndisRef?"NDIS: "+r.ndisRef+" ‚Ä¢ ":"")+(r.uniqueRef||"")+'</div></div>';
h+='<span style="font-size:10px;font-weight:600;padding:3px 10px;border-radius:10px;background:'+stCol+'12;color:'+stCol+';border:1px solid '+stCol+'25;margin-left:8px">'+stLabel+'</span></div>';
h+='<button onclick="document.getElementById(\'cbDetailOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';

h+='<div style="padding:20px">';

// Plan info
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px">';
[{l:"Plan Type",v:r.planType},{l:"SIL or CAS",v:r.silOrCas},{l:"From Budget",v:r.fromWhichBudget}].forEach(function(f){
if(!f.v)return;
h+='<div style="padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">'+f.l+'</div><div style="font-size:13px;font-weight:700;color:var(--text)">'+f.v+'</div></div>'});
h+='</div>';

// Budget breakdown
h+='<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üí∞ Budget Breakdown</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">';
[{l:"Core Budget (SIL)",v:silB,c:"#3B82F6"},{l:"Core Budget (CA)",v:caB,c:"#8B5CF6"},{l:"Core Budget (Transport)",v:trB,c:"#F59E0B"}].forEach(function(b){
h+='<div style="padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);border-left:3px solid '+b.c+'"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">'+b.l+'</div><div style="font-size:18px;font-weight:700;color:var(--text)">$'+(b.v?b.v.toLocaleString("en-AU",{minimumFractionDigits:2}):"0.00")+'</div></div>'});
h+='</div></div>';

// Utilisation
if(totB>0){
h+='<div style="padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:16px">';
h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:12px;font-weight:700;color:var(--text)">Budget Utilisation</span><span style="font-size:16px;font-weight:700;color:'+barCol+'">'+pct+'%</span></div>';
h+='<div style="height:10px;background:var(--border);border-radius:6px;overflow:hidden;margin-bottom:10px"><div style="height:100%;width:'+pct+'%;background:'+barCol+';border-radius:6px"></div></div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">';
h+='<div style="text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Total Budget</div><div style="font-size:14px;font-weight:700;color:var(--teal)">$'+totB.toLocaleString("en-AU",{minimumFractionDigits:2})+'</div></div>';
h+='<div style="text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Invoiced</div><div style="font-size:14px;font-weight:700;color:#EC4899">$'+inv.toLocaleString("en-AU",{minimumFractionDigits:2})+'</div></div>';
h+='<div style="text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Remaining</div><div style="font-size:14px;font-weight:700;color:'+(rem>=0?"var(--green)":"var(--red)")+'">$'+rem.toLocaleString("en-AU",{minimumFractionDigits:2})+'</div></div>';
h+='</div></div>'}

// Line Items
if(r.lineItems){
h+='<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìã Line Items from SOS Agreement</div>';
h+='<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);font-size:12px;color:var(--text);line-height:1.6;white-space:pre-wrap">'+r.lineItems+'</div></div>'}

// SOS Attachments
var sosFiles=Array.isArray(r.uploadSOS)?r.uploadSOS:r.uploadSOS?[r.uploadSOS]:[];
if(sosFiles.length>0){
h+='<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìé SOS Agreement ('+ sosFiles.length+')</div>';
h+='<div style="display:flex;flex-direction:column;gap:6px">';
sosFiles.forEach(function(f){
var fname=typeof f==="object"?(f.filename||f.name||"Document"):f;
var furl=typeof f==="object"?(f.url||"#"):"#";
h+='<a href="'+furl+'" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);text-decoration:none;transition:all .12s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'var(--surface)\'"><span style="font-size:16px">üìÑ</span><div style="font-size:12px;font-weight:600;color:var(--text)">'+fname+'</div></a>'});
h+='</div></div>'}

// Timestamps
var meta=[];
if(r.created)meta.push("Created: "+r.created);
if(r.lastUpdate)meta.push("Last updated: "+r.lastUpdate);
if(meta.length>0)h+='<div style="font-size:10px;color:var(--dim);margin-top:8px">'+meta.join(" &nbsp;‚Ä¢&nbsp; ")+'</div>';

// All other fields (expandable)
var af=r.allFields||{};
var shownKeys={"Unique Ref":1,"Client Name":1,"NDIS Ref # (from Client Name)":1,"Type of NDIS Plan (from Client Name)":1,"Upload SOS Agreement":1,"Line Items from SOS Agreement":1,"Line Items from SOS Agreement uploaded":1,"Account Type:  Active or Inactive or Propsect (from Client Name)":1,"SIL or CAS? (from Client Name)":1,"Core Budget (SIL) (from Client Name)":1,"Core Budget (Community Access) (from Client Name)":1,"Core Budget (Transport) (from Client Name)":1,"Total Budget":1,"Invoice Amount":1,"from which Budget?":1,"Created":1,"Last update":1};
var extra={};
Object.keys(af).forEach(function(k){if(shownKeys[k])return;var v=af[k];if(!v||v===""||v===0||(Array.isArray(v)&&v.length===0))return;extra[k]=v});
var extraKeys=Object.keys(extra);
if(extraKeys.length>0){
h+='<details style="margin-top:12px"><summary style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;padding:6px 0">All Other Fields ('+extraKeys.length+')</summary><div style="display:grid;gap:6px;margin-top:6px">';
extraKeys.sort().forEach(function(k){var v=extra[k];if(Array.isArray(v))v=v.join(", ");if(typeof v==="object")v=JSON.stringify(v);
h+='<div style="padding:6px 8px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)"><div style="font-size:9px;font-weight:600;color:var(--muted)">'+k+'</div><div style="font-size:11px;color:var(--text);margin-top:1px;word-break:break-word">'+v+'</div></div>'});
h+='</div></details>'}

h+='</div></div>';
overlay.innerHTML=h;
document.body.appendChild(overlay)}

// ‚îÄ‚îÄ Add Budget Modal ‚îÄ‚îÄ
function openAddBudgetModal(){
var overlay=document.createElement("div");
overlay.id="cbAddOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

// Get client names for dropdown
var clientNames=[];
contacts.forEach(function(c){if((c.contactType||"").toLowerCase().indexOf("ndis client")>=0)clientNames.push(c.name)});
participants.forEach(function(p){if(p.name&&clientNames.indexOf(p.name)<0)clientNames.push(p.name)});
clientNames.sort();

var h='<div style="background:var(--surface);border-radius:12px;max-width:600px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">‚ûï</span><span style="font-size:15px;font-weight:700;color:var(--text)">Add Client Budget</span></div>';
h+='<button onclick="document.getElementById(\'cbAddOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';

h+='<div style="padding:20px">';

// Client Name
h+='<div class="fg"><label>Client Name</label><select id="cbAddClient" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);font-size:13px;font-family:inherit"><option value="">‚Äî Select Client ‚Äî</option>';
clientNames.forEach(function(n){h+='<option value="'+n+'">'+n+'</option>'});
h+='</select></div>';

// Plan Type + SIL/CAS
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
h+='<div class="fg"><label>Type of NDIS Plan</label><select id="cbAddPlanType" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);font-size:13px;font-family:inherit"><option value="">‚Äî Select ‚Äî</option><option>NDIA Managed</option><option>Plan Managed</option><option>Self Managed</option></select></div>';
h+='<div class="fg"><label>SIL or CAS?</label><select id="cbAddSilCas" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);font-size:13px;font-family:inherit"><option value="">‚Äî Select ‚Äî</option><option>SIL</option><option>CAS</option><option>Both</option></select></div></div>';

// Budgets
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">';
h+='<div class="fg"><label>Core Budget (SIL)</label><input id="cbAddSIL" type="number" step="0.01" placeholder="0.00"></div>';
h+='<div class="fg"><label>Core Budget (CA)</label><input id="cbAddCA" type="number" step="0.01" placeholder="0.00"></div>';
h+='<div class="fg"><label>Core Budget (Transport)</label><input id="cbAddTransport" type="number" step="0.01" placeholder="0.00"></div></div>';

// Invoice + From Budget
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
h+='<div class="fg"><label>Invoice Amount</label><input id="cbAddInvoice" type="number" step="0.01" placeholder="0.00"></div>';
h+='<div class="fg"><label>From Which Budget?</label><select id="cbAddFromBudget" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);font-size:13px;font-family:inherit"><option value="">‚Äî Select ‚Äî</option><option>SIL</option><option>Community Access</option><option>Transport</option></select></div></div>';

// Line Items
h+='<div class="fg"><label>Line Items from SOS Agreement</label><textarea id="cbAddLineItems" rows="3" placeholder="Enter line items..."></textarea></div>';

// Save button
h+='<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">';
h+='<button class="btn btn-s" onclick="document.getElementById(\'cbAddOverlay\').remove()">Cancel</button>';
h+='<button class="btn btn-p" style="width:auto;padding:10px 24px" id="cbSaveBtn" onclick="saveNewBudget()">üíæ Save Budget</button></div>';

h+='</div></div>';
overlay.innerHTML=h;
document.body.appendChild(overlay)}

function saveNewBudget(){
var client=document.getElementById("cbAddClient").value;
if(!client){alert("Please select a client");return}
var btn=document.getElementById("cbSaveBtn");
if(btn){btn.disabled=true;btn.innerHTML="‚è≥ Saving...";btn.style.opacity=".7"}

var silVal=parseFloat(document.getElementById("cbAddSIL").value)||0;
var caVal=parseFloat(document.getElementById("cbAddCA").value)||0;
var trVal=parseFloat(document.getElementById("cbAddTransport").value)||0;

var body={
clientName:client,
planType:document.getElementById("cbAddPlanType").value,
silOrCas:document.getElementById("cbAddSilCas").value,
coreBudgetSIL:silVal,
coreBudgetCA:caVal,
coreBudgetTransport:trVal,
totalBudget:silVal+caVal+trVal,
invoiceAmount:parseFloat(document.getElementById("cbAddInvoice").value)||0,
fromWhichBudget:document.getElementById("cbAddFromBudget").value,
lineItems:document.getElementById("cbAddLineItems").value
};

apiCall("POST","/api/client-budgets",body).then(function(d){
var ov=document.getElementById("cbAddOverlay");if(ov)ov.remove();
clientBudgetLoaded=false;
renderClientBudget()}).catch(function(e){
alert("Failed to save: "+(e.message||"Unknown error"));
if(btn){btn.disabled=false;btn.innerHTML="üíæ Save Budget";btn.style.opacity="1"}})}

// ‚îÄ‚îÄ Upload SOS (Schedule of Support) Modal ‚îÄ‚îÄ
function openUploadSOSModal(){
cbFiles=[];cbScanned=[];
var overlay=document.createElement("div");
overlay.id="cbSOSOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

var h='<div style="background:var(--surface);border-radius:12px;max-width:720px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìÑ</span><span style="font-size:15px;font-weight:700;color:var(--text)">Upload Schedule of Support</span></div>';
h+='<button onclick="document.getElementById(\'cbSOSOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';

h+='<div style="padding:20px">';
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:16px;line-height:1.5">Upload a PDF copy of the participant\'s <strong>Schedule of Support (SOS)</strong> agreement. AI will scan the document and extract budget details including line items, funding amounts, and plan information.</div>';

// Drop zone
h+='<div class="cv-drop-zone" id="cbDropZone" onclick="document.getElementById(\'cbFileInput\').click()" ondragover="event.preventDefault();this.classList.add(\'drag-active\')" ondragleave="this.classList.remove(\'drag-active\')" ondrop="handleCBDrop(event)">';
h+='<input type="file" id="cbFileInput" accept=".pdf" multiple style="display:none" onchange="handleCBFiles(this.files)">';
h+='<div style="font-size:40px;margin-bottom:12px">üìé</div>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px">Drop SOS PDF files here or click to browse</div>';
h+='<div style="font-size:12px;color:var(--muted)">Accepts PDF documents ‚Äî multiple files supported</div>';
h+='</div>';

// File list
h+='<div id="cbFileList" style="margin-top:16px"></div>';

// Scan button
h+='<div id="cbScanArea" style="margin-top:16px;display:none;align-items:center;gap:10px">';
h+='<button class="btn btn-p" id="cbScanBtn" style="width:auto;padding:10px 24px" onclick="scanAllSOS()">ü§ñ Scan with AI</button>';
h+='<span style="font-size:11px;color:var(--muted)" id="cbScanStatus"></span>';
h+='</div>';

// Results area
h+='<div id="cbScanResults" style="margin-top:20px;display:none"></div>';

h+='</div></div>';
overlay.innerHTML=h;
document.body.appendChild(overlay)}

function handleCBDrop(e){
e.preventDefault();e.currentTarget.classList.remove("drag-active");
var files=e.dataTransfer.files;
if(files&&files.length>0)handleCBFiles(files)}

function handleCBFiles(files){
for(var i=0;i<files.length;i++){
var f=files[i];
if(f.name.split(".").pop().toLowerCase()!=="pdf")continue;
var isDupe=cbFiles.some(function(cf){return cf.name===f.name&&cf.size===f.size});
if(isDupe)continue;
cbFiles.push({file:f,name:f.name,size:f.size,status:"ready",text:"",parsed:null})}
renderCBFileList();
var scanArea=document.getElementById("cbScanArea");
if(scanArea&&cbFiles.length>0)scanArea.style.display="flex"}

function renderCBFileList(){
var el=document.getElementById("cbFileList");if(!el)return;
if(cbFiles.length===0){el.innerHTML="";return}
var h='<div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:8px">'+cbFiles.length+' file'+(cbFiles.length!==1?"s":"")+" queued</div>";
cbFiles.forEach(function(cf,idx){
var statusHtml="";
if(cf.status==="ready")statusHtml='<span class="cv-file-status" style="background:var(--surface2);color:var(--muted)">Ready</span>';
else if(cf.status==="extracting")statusHtml='<span class="cv-file-status" style="background:rgba(10,147,150,.08);color:var(--teal)">Extracting text...</span>';
else if(cf.status==="scanning")statusHtml='<span class="cv-file-status" style="background:rgba(124,58,237,.08);color:#7C3AED">ü§ñ AI scanning...</span>';
else if(cf.status==="done")statusHtml='<span class="cv-file-status" style="background:rgba(16,185,129,.08);color:var(--green)">‚úÖ Scanned</span>';
else if(cf.status==="error")statusHtml='<span class="cv-file-status" style="background:rgba(239,68,68,.06);color:var(--red)">‚ùå Error</span>';
h+='<div class="cv-file-item">';
h+='<div class="cv-file-icon" style="background:rgba(239,68,68,.08)">üìï</div>';
h+='<div class="cv-file-info"><div class="cv-file-name">'+cf.name+'</div>';
h+='<div class="cv-file-size">'+(cf.size>1048576?(cf.size/1048576).toFixed(1)+" MB":(cf.size/1024).toFixed(0)+" KB")+" ‚Äî PDF"+'</div>';
if(cf.status==="extracting"||cf.status==="scanning")h+='<div class="cv-progress"><div class="cv-progress-bar" style="width:'+(cf.status==="extracting"?"40%":"75%")+'"></div></div>';
h+='</div>';
h+=statusHtml;
h+='<button onclick="removeCBFile('+idx+')" style="background:none;border:none;cursor:pointer;font-size:16px;color:var(--dim);padding:4px 8px" title="Remove">‚úï</button>';
h+='</div>'});
el.innerHTML=h}

function removeCBFile(idx){
cbFiles.splice(idx,1);
renderCBFileList();
var scanArea=document.getElementById("cbScanArea");
if(scanArea)scanArea.style.display=cbFiles.length>0?"flex":"none"}

// ‚îÄ‚îÄ Scan SOS PDFs with AI ‚îÄ‚îÄ
async function scanAllSOS(){
var btn=document.getElementById("cbScanBtn");
var status=document.getElementById("cbScanStatus");
if(btn){btn.disabled=true;btn.innerHTML="‚è≥ Scanning...";btn.style.opacity=".7"}
cbScanned=[];

for(var i=0;i<cbFiles.length;i++){
var cf=cbFiles[i];
if(cf.status==="done")continue;
if(status)status.textContent="Processing "+(i+1)+" of "+cbFiles.length+"...";

// Step 1: Extract text from PDF
cf.status="extracting";renderCBFileList();
try{cf.text=await extractPDFText(cf.file)}catch(e){cf.status="error";cf.text="";renderCBFileList();continue}
if(!cf.text||cf.text.trim().length<20){cf.status="error";renderCBFileList();continue}

// Step 2: AI scan for budget data
cf.status="scanning";renderCBFileList();
try{
var result=await apiCall("POST","/api/client-budgets/scan-sos",{text:cf.text.substring(0,12000),fileName:cf.name});
if(result&&result.parsed){cf.parsed=result.parsed;cf.status="done";cbScanned.push(result.parsed)}
else{cf.status="error"}}catch(e){cf.status="error"}
renderCBFileList()}

if(status)status.textContent="Done! "+cbScanned.length+" SOS"+(cbScanned.length!==1?"":"")+" scanned.";
if(btn){btn.disabled=false;btn.innerHTML="ü§ñ Scan with AI";btn.style.opacity="1"}
if(cbScanned.length>0)renderCBScanResults()}

function renderCBScanResults(){
var el=document.getElementById("cbScanResults");if(!el)return;
el.style.display="block";
var h='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px">üìã Extracted Budget Data</div>';
h+='<div style="font-size:11px;color:var(--muted);margin-bottom:12px">Review and edit the extracted data before saving to Airtable.</div>';

cbScanned.forEach(function(p,idx){
h+='<div style="padding:16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:12px">';
h+='<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px">üìÑ Document '+(idx+1)+'</div>';

h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>Client Name</label><input value="'+(p.clientName||"")+'" onchange="cbScanned['+idx+'].clientName=this.value" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface)"></div>';
h+='<div class="fg" style="margin:0"><label>NDIS Reference</label><input value="'+(p.ndisRef||"")+'" onchange="cbScanned['+idx+'].ndisRef=this.value" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface)"></div></div>';

h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>SIL Budget ($)</label><input type="number" step="0.01" value="'+(p.coreBudgetSIL||0)+'" onchange="cbScanned['+idx+'].coreBudgetSIL=parseFloat(this.value)||0" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface)"></div>';
h+='<div class="fg" style="margin:0"><label>CA Budget ($)</label><input type="number" step="0.01" value="'+(p.coreBudgetCA||0)+'" onchange="cbScanned['+idx+'].coreBudgetCA=parseFloat(this.value)||0" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface)"></div>';
h+='<div class="fg" style="margin:0"><label>Transport Budget ($)</label><input type="number" step="0.01" value="'+(p.coreBudgetTransport||0)+'" onchange="cbScanned['+idx+'].coreBudgetTransport=parseFloat(this.value)||0" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface)"></div></div>';

h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>Plan Type</label><select onchange="cbScanned['+idx+'].planType=this.value" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);cursor:pointer"><option value=""'+(!(p.planType)?" selected":"")+'>‚Äî Select ‚Äî</option><option'+(p.planType==="NDIA Managed"?" selected":"")+'>NDIA Managed</option><option'+(p.planType==="Plan Managed"?" selected":"")+'>Plan Managed</option><option'+(p.planType==="Self Managed"?" selected":"")+'>Self Managed</option></select></div>';
h+='<div class="fg" style="margin:0"><label>SIL or CAS?</label><select onchange="cbScanned['+idx+'].silOrCas=this.value" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);cursor:pointer"><option value=""'+(!(p.silOrCas)?" selected":"")+'>‚Äî Select ‚Äî</option><option'+(p.silOrCas==="SIL"?" selected":"")+'>SIL</option><option'+(p.silOrCas==="CAS"?" selected":"")+'>CAS</option><option'+(p.silOrCas==="Both"?" selected":"")+'>Both</option></select></div></div>';

if(p.lineItems){
h+='<div class="fg" style="margin:0"><label>Line Items</label><textarea rows="3" onchange="cbScanned['+idx+'].lineItems=this.value" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-family:inherit;background:var(--surface);resize:vertical">'+p.lineItems+'</textarea></div>'}

h+='</div>'});

h+='<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">';
h+='<button class="btn btn-s" onclick="document.getElementById(\'cbSOSOverlay\').remove()">Cancel</button>';
h+='<button class="btn btn-p" style="width:auto;padding:10px 24px" id="cbCreateAllBtn" onclick="createAllScannedBudgets()">‚úÖ Save All to Airtable</button></div>';

el.innerHTML=h}

async function createAllScannedBudgets(){
var btn=document.getElementById("cbCreateAllBtn");
if(btn){btn.disabled=true;btn.innerHTML="‚è≥ Saving...";btn.style.opacity=".7"}
var saved=0;
for(var i=0;i<cbScanned.length;i++){
var p=cbScanned[i];
var silVal=parseFloat(p.coreBudgetSIL)||0;
var caVal=parseFloat(p.coreBudgetCA)||0;
var trVal=parseFloat(p.coreBudgetTransport)||0;
try{
await apiCall("POST","/api/client-budgets",{
clientName:p.clientName||"",
ndisRef:p.ndisRef||"",
planType:p.planType||"",
silOrCas:p.silOrCas||"",
coreBudgetSIL:silVal,
coreBudgetCA:caVal,
coreBudgetTransport:trVal,
totalBudget:silVal+caVal+trVal,
invoiceAmount:parseFloat(p.invoiceAmount)||0,
fromWhichBudget:p.fromWhichBudget||"",
lineItems:p.lineItems||""
});saved++}catch(e){console.error("Failed to save budget",i,e)}}

if(btn){btn.disabled=false;btn.innerHTML="‚úÖ Saved "+saved+" / "+cbScanned.length;btn.style.opacity="1"}
var ov=document.getElementById("cbSOSOverlay");
setTimeout(function(){if(ov)ov.remove();clientBudgetLoaded=false;renderClientBudget()},1200)}

// ‚ïê‚ïê‚ïê SCHEDULER (Rosters 2025) ‚Äî Calendar View ‚ïê‚ïê‚ïê
var schedulerData=[];
var schedulerLoaded=false;
var schedView="week";
var schedGroupBy="staff";
var schedWeekStart=null;
var schedTab="calendar";
var schedDragIdx=null;

function getMonday(d){var dt=new Date(d);var day=dt.getDay();var diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);dt.setHours(0,0,0,0);return dt}
function schedInit(){if(!schedWeekStart)schedWeekStart=getMonday(new Date())}

function parseSchedDate(v){
if(!v)return null;
if(v instanceof Date&&!isNaN(v))return v;
if(typeof v==="string"&&v.indexOf("T")>=0){var d=new Date(v);if(!isNaN(d))return d}
if(typeof v==="string"){
var parts=v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})\s*(.*)?$/);
if(parts){var dd=parseInt(parts[1]),mm=parseInt(parts[2])-1,yy=parseInt(parts[3]),ts=parts[4]||"";
var d2=new Date(yy,mm,dd);
if(ts){var tm=ts.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/i);
if(tm){var hh=parseInt(tm[1]),mi=parseInt(tm[2]),ap=(tm[3]||"").toLowerCase();
if(ap==="pm"&&hh<12)hh+=12;if(ap==="am"&&hh===12)hh=0;
d2.setHours(hh,mi)}}
return d2}
var d3=new Date(v);if(!isNaN(d3))return d3}
return null}

function schedDateKey(d){if(!d)return"";return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")}
function schedFmtTime(d){if(!d)return"";var h=d.getHours(),m=d.getMinutes(),ap=h>=12?"pm":"am";h=h%12||12;return h+":"+String(m).padStart(2,"0")+ap}
function schedFmtDay(d){return["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()]+" "+d.getDate()+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()]}
function schedIsToday(d){var t=new Date();return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate()}

function schedCalcHours(s){
var ds=parseSchedDate(s.startShift),de=parseSchedDate(s.endShift);
if(!ds||!de)return{total:0,active:0,sleepover:0};
var activeH=(de-ds)/(3600000);if(activeH<=0||activeH>24)return{total:0,active:0,sleepover:0};
activeH=Math.round(activeH*10)/10;
// Sleepover = additional 1hr allowance if flagged (not hourly)
var hasSleepover=s.sleepover||(s.allFields&&s.allFields.Sleepover)||false;
var sleepH=hasSleepover?1:0;
return{total:Math.round((activeH+sleepH)*10)/10,active:activeH,sleepover:sleepH}}

// ‚îÄ‚îÄ‚îÄ Wrapper functions for toolbar buttons ‚îÄ‚îÄ‚îÄ
function schedSetTab(t){schedTab=t;schedRefresh()}
function schedSetGroup(g){schedGroupBy=g;schedRefresh()}
function schedSetView(v){schedView=v;schedRefresh()}
function schedNavWeek(dir){var step=schedView==="fortnight"?14:7;schedWeekStart=new Date(schedWeekStart);schedWeekStart.setDate(schedWeekStart.getDate()+(dir*step));schedRefresh()}
function schedNavToday(){schedWeekStart=getMonday(new Date());schedRefresh()}
function schedRefresh(){renderSchedulerContent(document.getElementById("rightPanel"))}

// ‚ïê‚ïê‚ïê SCHADS AWARD COMPLIANCE ENGINE ‚ïê‚ïê‚ïê
function schedComplianceCheck(data,days){
var warnings=[];
var viewStartKey=days.length>0?schedDateKey(days[0]):"";
var viewEndKey=days.length>0?schedDateKey(days[days.length-1]):"";

// Group shifts by staff
var byStaff={};
data.forEach(function(s){
if(!s.staffName||s.staffName.trim()==="")return;
if(!byStaff[s.staffName])byStaff[s.staffName]=[];
byStaff[s.staffName].push(s)});

// Check if independent contractor (exempt from some rules)
function isContractor(s){
var ct=(s.contactType||"").toLowerCase();
return ct.indexOf("contractor")>=0||ct.indexOf("independent")>=0||ct.indexOf("independant")>=0||ct.indexOf("abn")>=0}

Object.keys(byStaff).forEach(function(name){
var shifts=byStaff[name];
var isIC=shifts.length>0&&isContractor(shifts[0]);

// Get shifts in current view, sorted by start
var viewShifts=shifts.filter(function(s){return s._dateKey>=viewStartKey&&s._dateKey<=viewEndKey&&s._startDt}).sort(function(a,b){return a._startDt-b._startDt});

viewShifts.forEach(function(s,i){
var ds=s._startDt,de=s._endDt;
if(!ds||!de)return;
var durH=(de-ds)/3600000;

// Rule 1: Minimum 2hr shift (cl. 10.5)
if(durH>0&&durH<2){
warnings.push({type:"breach",icon:"‚ö†Ô∏è",rule:"Min 2hr Shift",ref:"cl. 10.5",staff:name,detail:schedFmtDay(ds)+": "+schedFmtTime(ds)+" ‚Äì "+schedFmtTime(de)+" ("+durH.toFixed(1)+"h) ‚Äî minimum engagement is 2 hours",idx:s._idx})}

// Rule 2: Max 10hrs/day (cl. 25.1, 28.1) ‚Äî not for ICs
if(!isIC&&durH>10){
warnings.push({type:"overtime",icon:"‚è∞",rule:"Daily >10hrs",ref:"cl. 25.1(b), 28.1",staff:name,detail:schedFmtDay(ds)+": "+durH.toFixed(1)+"h shift ‚Äî overtime triggered after 10hrs",idx:s._idx})}
else if(!isIC&&durH>8){
warnings.push({type:"approaching",icon:"‚ö°",rule:"Daily approaching 10hrs",ref:"cl. 25.1(b)",staff:name,detail:schedFmtDay(ds)+": "+durH.toFixed(1)+"h shift ‚Äî approaching 10hr overtime threshold ("+Math.round(10-durH)+"hrs remaining)",idx:s._idx})}

// Rule 3: Outside span of hours 6am-8pm (cl. 25.2)
var startH=ds.getHours()+(ds.getMinutes()/60);
var endH=de.getHours()+(de.getMinutes()/60);
if(startH<6){
warnings.push({type:"penalty",icon:"üåô",rule:"Before 6am",ref:"cl. 25.2(a), 28",staff:name,detail:schedFmtDay(ds)+": starts at "+schedFmtTime(ds)+" ‚Äî outside ordinary span (6am‚Äì8pm), penalty rates apply",idx:s._idx})}
if(endH>20&&de.getDate()===ds.getDate()){
warnings.push({type:"penalty",icon:"üåô",rule:"After 8pm",ref:"cl. 25.2(a), 28",staff:name,detail:schedFmtDay(ds)+": ends at "+schedFmtTime(de)+" ‚Äî outside ordinary span (6am‚Äì8pm), penalty rates apply",idx:s._idx})}

// Rule 4: Break between shifts (cl. 25.4) ‚Äî 10hr minimum
if(i>0){
var prevEnd=viewShifts[i-1]._endDt;
if(prevEnd){
var gap=(ds-prevEnd)/3600000;
if(gap>0&&gap<10){
warnings.push({type:"breach",icon:"üö´",rule:"<10hr Break",ref:"cl. 25.4",staff:name,detail:schedFmtDay(prevEnd)+" "+schedFmtTime(prevEnd)+" ‚Üí "+schedFmtDay(ds)+" "+schedFmtTime(ds)+" = "+gap.toFixed(1)+"h gap ‚Äî minimum 10hrs required between shifts",idx:s._idx})}}}
});

// Rule 5: Weekly hours >38 (cl. 28.1) ‚Äî not for ICs
if(!isIC){
// Group by week (Mon-Sun)
var weekBuckets={};
viewShifts.forEach(function(s){
if(!s._startDt||!s._endDt)return;
var mon=getMonday(s._startDt);var wk=schedDateKey(mon);
if(!weekBuckets[wk])weekBuckets[wk]={hrs:0,mon:mon};
var h=(s._endDt-s._startDt)/3600000;if(h>0&&h<24)weekBuckets[wk].hrs+=h});
Object.keys(weekBuckets).forEach(function(wk){
var b=weekBuckets[wk];
if(b.hrs>38){
warnings.push({type:"overtime",icon:"‚è∞",rule:"Weekly >38hrs",ref:"cl. 28.1(b)(i)",staff:name,detail:"Week of "+schedFmtDay(b.mon)+": "+b.hrs.toFixed(1)+"h total ‚Äî overtime triggered over 38hrs/week",idx:-1})}
else if(b.hrs>32){
warnings.push({type:"approaching",icon:"‚ö°",rule:"Weekly approaching 38hrs",ref:"cl. 28.1(b)(i)",staff:name,detail:"Week of "+schedFmtDay(b.mon)+": "+b.hrs.toFixed(1)+"h total ‚Äî approaching 38hr overtime threshold ("+(38-b.hrs).toFixed(1)+"hrs remaining)",idx:-1})}})}
// Rule 6: Fortnightly hours >76 (cl. 28.1) ‚Äî not for ICs
if(!isIC&&viewShifts.length>0){
var fnTotal=0;viewShifts.forEach(function(s){if(s._startDt&&s._endDt){var hh=(s._endDt-s._startDt)/3600000;if(hh>0&&hh<24)fnTotal+=hh}});
if(fnTotal>76){
warnings.push({type:"overtime",icon:"‚è∞",rule:"Fortnight >76hrs",ref:"cl. 28.1(b)(i)",staff:name,detail:"Fortnightly total: "+fnTotal.toFixed(1)+"h ‚Äî overtime triggered over 76hrs/fortnight",idx:-1})}
else if(fnTotal>64){
warnings.push({type:"approaching",icon:"‚ö°",rule:"Fortnight approaching 76hrs",ref:"cl. 28.1(b)(i)",staff:name,detail:"Fortnightly total: "+fnTotal.toFixed(1)+"h ‚Äî approaching 76hr overtime threshold ("+(76-fnTotal).toFixed(1)+"hrs remaining)",idx:-1})}}
});

// Rule 6: Vacant shifts
var vacant=data.filter(function(s){return(!s.staffName||s.staffName.trim()==="")&&s._dateKey>=viewStartKey&&s._dateKey<=viewEndKey});
if(vacant.length>0){
warnings.push({type:"vacant",icon:"üìã",rule:"Vacant Shifts",ref:"",staff:"",detail:vacant.length+" shift"+(vacant.length!==1?"s":"")+" in this period have no staff assigned",idx:-1})}

// Sort: breaches first, then overtime, then approaching, then penalties, then vacant
var order={breach:0,overtime:1,approaching:2,penalty:3,vacant:4};
warnings.sort(function(a,b){return(order[a.type]||9)-(order[b.type]||9)});
return warnings}

var schedShowCompliance=true;

function renderScheduler(){
schedInit();
var rp=document.getElementById("rightPanel");
if(!schedulerLoaded){schedulerLoaded=true;
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading roster...</div></div></div>';
apiCall("GET","/api/scheduler").then(function(d){schedulerData=d||[];renderSchedulerContent(rp)}).catch(function(){schedulerData=[];renderSchedulerContent(rp)});return}
renderSchedulerContent(rp)}

function renderSchedulerContent(rp){
var numDays=schedView==="fortnight"?14:7;
var days=[];for(var i=0;i<numDays;i++){var dd=new Date(schedWeekStart);dd.setDate(dd.getDate()+i);days.push(dd)}
var viewStartKey=schedDateKey(days[0]);
var viewEndDt=new Date(days[days.length-1]);viewEndDt.setHours(23,59,59);
var viewEndKey=schedDateKey(viewEndDt);

// Parse all shift dates
schedulerData.forEach(function(s,i){s._idx=i;s._startDt=parseSchedDate(s.startShift);s._endDt=parseSchedDate(s.endShift);s._dateKey=s._startDt?schedDateKey(s._startDt):""});

// Shifts in current view
var viewShifts=schedulerData.filter(function(s){return s._dateKey>=viewStartKey&&s._dateKey<=viewEndKey});
var vacantShifts=schedulerData.filter(function(s){return!s.staffName||s.staffName.trim()===""});
var viewVacant=viewShifts.filter(function(s){return!s.staffName||s.staffName.trim()===""});

// Group people
var people={};
schedulerData.forEach(function(s){
var key=schedGroupBy==="staff"?(s.staffName||"Unassigned"):(s.clientName||"Unknown Client");
if(!people[key])people[key]={all:[],contactType:"",silOrCas:""};
people[key].all.push(s);
if(schedGroupBy==="staff"&&s.contactType&&!people[key].contactType)people[key].contactType=s.contactType;
if(schedGroupBy==="client"&&s.silOrCas&&!people[key].silOrCas)people[key].silOrCas=s.silOrCas});
var personNames=Object.keys(people).sort(function(a,b){if(a==="Unassigned")return-1;if(b==="Unassigned")return 1;return a.localeCompare(b)});

var dayColW=schedView==="fortnight"?"minmax(80px,1fr)":"minmax(110px,1fr)";

var h='<div style="display:flex;flex-direction:column;height:100%;overflow:hidden">';

// ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ
h+='<div style="padding:14px 20px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">';
h+='<div><div style="font-size:20px;font-weight:700;color:var(--text)">üìÖ Scheduler</div><div style="font-size:12px;color:var(--muted)">'+viewShifts.length+' shifts this '+(schedView==="fortnight"?"fortnight":"week")+' ¬∑ '+viewVacant.length+' vacant'+(draftCount>0?' <span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(245,158,11,.12);color:#92400E;border:1px solid rgba(245,158,11,.25)">‚è≥ '+draftCount+' Draft ‚Äî Pending Signature</span>':'')+' </div></div>';
h+='<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">';

// New Shift
h+='<button onclick="openNewShiftModal()" style="padding:6px 14px;font-size:11px;font-weight:700;font-family:inherit;border:none;cursor:pointer;background:var(--teal);color:#fff;border-radius:var(--rs);display:'+(canEdit("scheduler")?"inline-block":"none")+'">+ New Shift</button>';

// Run compliance check
var compWarnings=schedComplianceCheck(schedulerData,days);
var compBreaches=compWarnings.filter(function(w){return w.type==="breach"});
var compOT=compWarnings.filter(function(w){return w.type==="overtime"});
var compApproach=compWarnings.filter(function(w){return w.type==="approaching"});
var compPen=compWarnings.filter(function(w){return w.type==="penalty"});
// Build set of flagged shift indices for card markers
var flaggedShifts={};compWarnings.forEach(function(w){if(w.idx>=0)flaggedShifts[w.idx]=w});

// Compliance toggle
var compCount=compWarnings.length;
var compCol=compBreaches.length>0?"var(--red)":compOT.length>0?"#F59E0B":compApproach.length>0?"#FB923C":"var(--teal)";
h+='<button onclick="schedShowCompliance=!schedShowCompliance;schedRefresh()" style="padding:6px 12px;font-size:10px;font-weight:700;font-family:inherit;border:none;cursor:pointer;border-radius:var(--rs);'+(schedShowCompliance?"background:"+compCol+";color:#fff":"background:var(--surface2);color:var(--muted)")+'">'+(compCount>0?"üõ° SCHADS "+compCount:"üõ° SCHADS ‚úì")+'</button>';

// Calendar / Job Board
h+='<div style="display:flex;border:1px solid var(--border);border-radius:var(--rs);overflow:hidden">';
h+='<button onclick="schedSetTab(\'calendar\')" style="padding:6px 12px;font-size:11px;font-weight:700;font-family:inherit;border:none;cursor:pointer;'+(schedTab==="calendar"?"background:var(--teal);color:#fff":"background:var(--surface2);color:var(--muted)")+'">üìÖ Calendar</button>';
h+='<button onclick="schedSetTab(\'jobboard\')" style="padding:6px 12px;font-size:11px;font-weight:700;font-family:inherit;border:none;cursor:pointer;'+(schedTab==="jobboard"?"background:var(--teal);color:#fff":"background:var(--surface2);color:var(--muted)")+'">üìã Job Board'+(vacantShifts.length>0?' <span style="background:'+(schedTab==="jobboard"?"#fff":"var(--red)")+';color:'+(schedTab==="jobboard"?"var(--teal)":"#fff")+';font-size:9px;padding:1px 5px;border-radius:8px;margin-left:2px">'+vacantShifts.length+'</span>':'')+'</button></div>';

// Staff / Client
h+='<div style="display:flex;border:1px solid var(--border);border-radius:var(--rs);overflow:hidden">';
h+='<button onclick="schedSetGroup(\'staff\')" style="padding:6px 10px;font-size:10px;font-weight:700;font-family:inherit;border:none;cursor:pointer;'+(schedGroupBy==="staff"?"background:var(--royal);color:#fff":"background:var(--surface2);color:var(--muted)")+'">üë∑ Staff</button>';
h+='<button onclick="schedSetGroup(\'client\')" style="padding:6px 10px;font-size:10px;font-weight:700;font-family:inherit;border:none;cursor:pointer;'+(schedGroupBy==="client"?"background:var(--royal);color:#fff":"background:var(--surface2);color:var(--muted)")+'">üßë Client</button></div>';

// Week / Fortnight
h+='<div style="display:flex;border:1px solid var(--border);border-radius:var(--rs);overflow:hidden">';
h+='<button onclick="schedSetView(\'week\')" style="padding:6px 10px;font-size:10px;font-weight:700;font-family:inherit;border:none;cursor:pointer;'+(schedView==="week"?"background:var(--teal);color:#fff":"background:var(--surface2);color:var(--muted)")+'">Week</button>';
h+='<button onclick="schedSetView(\'fortnight\')" style="padding:6px 10px;font-size:10px;font-weight:700;font-family:inherit;border:none;cursor:pointer;'+(schedView==="fortnight"?"background:var(--teal);color:#fff":"background:var(--surface2);color:var(--muted)")+'">Fortnight</button></div>';

// Navigation
var mStr=days[0].toLocaleDateString("en-AU",{day:"numeric",month:"short"})+" ‚Äî "+days[days.length-1].toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"});
h+='<div style="display:flex;align-items:center;gap:0">';
h+='<button onclick="schedNavWeek(-1)" style="padding:5px 8px;border:1px solid var(--border);border-radius:var(--rs) 0 0 var(--rs);background:var(--surface2);cursor:pointer;font-size:14px;font-family:inherit;color:var(--muted);line-height:1">‚Äπ</button>';
h+='<button onclick="schedNavToday()" style="padding:5px 10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);border-left:none;border-right:none;background:var(--surface2);cursor:pointer;font-size:10px;font-weight:700;font-family:inherit;color:var(--text);white-space:nowrap">'+mStr+'</button>';
h+='<button onclick="schedNavWeek(1)" style="padding:5px 8px;border:1px solid var(--border);border-radius:0 var(--rs) var(--rs) 0;background:var(--surface2);cursor:pointer;font-size:14px;font-family:inherit;color:var(--muted);line-height:1">‚Ä∫</button></div>';

h+='</div></div></div>';

// ‚îÄ‚îÄ‚îÄ VIEW-ONLY BANNER ‚îÄ‚îÄ‚îÄ
if(!canEdit("scheduler")){
h+='<div style="padding:8px 20px;background:rgba(59,130,246,.06);border-bottom:1px solid rgba(59,130,246,.15);text-align:center;flex-shrink:0"><span style="font-size:11px;font-weight:600;color:#3B82F6">üëÅ View only mode ‚Äî creating and editing shifts is disabled</span></div>';
}

// ‚îÄ‚îÄ‚îÄ COMPLIANCE PANEL ‚îÄ‚îÄ‚îÄ
if(schedShowCompliance&&compWarnings.length>0){
h+='<div style="border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;max-height:220px;overflow-y:auto">';
// Summary bar
h+='<div style="padding:8px 20px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);background:rgba(239,68,68,.02)">';
h+='<span style="font-size:12px;font-weight:800;color:var(--text)">üõ° SCHADS Award Compliance</span>';
if(compBreaches.length>0)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2)">'+compBreaches.length+' Breach'+(compBreaches.length!==1?"es":"")+'</span>';
if(compOT.length>0)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(245,158,11,.08);color:#F59E0B;border:1px solid rgba(245,158,11,.2)">'+compOT.length+' Overtime</span>';
if(compApproach.length>0)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(251,146,60,.08);color:#FB923C;border:1px solid rgba(251,146,60,.2)">'+compApproach.length+' Approaching</span>';
if(compPen.length>0)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(139,92,246,.08);color:#8B5CF6;border:1px solid rgba(139,92,246,.2)">'+compPen.length+' Penalty</span>';
h+='<span style="font-size:9px;color:var(--dim);margin-left:auto">SCHADS Award 2010 ¬∑ Home Care Stream</span>';
h+='</div>';
// Warning items
h+='<div style="padding:6px 12px">';
compWarnings.forEach(function(w){
var bgMap={breach:"rgba(239,68,68,.04)",overtime:"rgba(245,158,11,.04)",approaching:"rgba(251,146,60,.04)",penalty:"rgba(139,92,246,.04)",vacant:"rgba(59,130,246,.04)"};
var borderMap={breach:"rgba(239,68,68,.15)",overtime:"rgba(245,158,11,.15)",approaching:"rgba(251,146,60,.15)",penalty:"rgba(139,92,246,.15)",vacant:"rgba(59,130,246,.15)"};
var colMap={breach:"var(--red)",overtime:"#F59E0B",approaching:"#FB923C",penalty:"#8B5CF6",vacant:"#3B82F6"};
var click=w.idx>=0?'onclick="openSchedModal('+w.idx+')"':'';
h+='<div '+click+' style="padding:6px 10px;margin-bottom:3px;background:'+bgMap[w.type]+';border:1px solid '+borderMap[w.type]+';border-left:3px solid '+colMap[w.type]+';border-radius:var(--rs);display:flex;align-items:start;gap:8px;font-size:10px;'+(w.idx>=0?"cursor:pointer;":"")+'transition:all .1s" '+(w.idx>=0?'onmouseover="this.style.background=\'rgba(0,0,0,.04)\'" onmouseout="this.style.background=\''+bgMap[w.type]+'\'"':'')+'>';
h+='<span style="font-size:14px;flex-shrink:0;margin-top:-1px">'+w.icon+'</span>';
h+='<div style="flex:1;min-width:0">';
h+='<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">';
h+='<span style="font-weight:800;color:'+colMap[w.type]+'">'+w.rule+'</span>';
if(w.ref)h+='<span style="color:var(--dim);font-size:8px;font-weight:600">'+w.ref+'</span>';
if(w.staff)h+='<span style="font-weight:700;color:var(--text)">¬∑ '+w.staff+'</span>';
h+='</div>';
h+='<div style="color:var(--muted);margin-top:1px;line-height:1.3">'+w.detail+'</div>';
h+='</div></div>'});
h+='</div></div>'}
else if(schedShowCompliance&&compWarnings.length===0){
h+='<div style="padding:8px 20px;border-bottom:1px solid var(--border);background:rgba(16,185,129,.03);display:flex;align-items:center;gap:8px">';
h+='<span style="font-size:14px">‚úÖ</span><span style="font-size:11px;font-weight:700;color:#10B981">SCHADS Compliant</span>';
h+='<span style="font-size:10px;color:var(--dim)">‚Äî No breaches, overtime triggers, approaching limits, or penalty flags found this '+(schedView==="fortnight"?"fortnight":"week")+'</span>';
h+='</div>'}

if(schedTab==="calendar"){
// ‚îÄ‚îÄ‚îÄ CALENDAR GRID ‚îÄ‚îÄ‚îÄ
h+='<div style="flex:1;overflow:auto">';
h+='<div style="display:grid;grid-template-columns:140px repeat('+numDays+','+dayColW+');min-width:'+(140+numDays*80)+'px">';

// Day headers
h+='<div style="padding:10px 12px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);border-right:1px solid var(--border);background:var(--surface);position:sticky;top:0;left:0;z-index:3">'+(schedGroupBy==="staff"?"Staff":"Client")+'</div>';
days.forEach(function(day){
var isT=schedIsToday(day);var isW=day.getDay()===0||day.getDay()===6;
h+='<div style="padding:6px 4px;text-align:center;border-bottom:2px solid var(--border);border-right:1px solid var(--border);position:sticky;top:0;z-index:2;background:'+(isT?"rgba(10,147,150,.08)":isW?"var(--surface2)":"var(--surface)")+'">';
h+='<div style="font-size:9px;font-weight:700;color:'+(isT?"var(--teal)":"var(--muted)")+';text-transform:uppercase;letter-spacing:.5px">'+["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][day.getDay()]+'</div>';
h+='<div style="font-size:16px;font-weight:800;color:'+(isT?"var(--teal)":"var(--text)")+'">'+day.getDate()+'</div>';
h+='<div style="font-size:9px;color:var(--dim)">'+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][day.getMonth()]+'</div></div>'});

if(personNames.length===0){
h+='<div style="grid-column:1/-1;padding:40px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìÖ</div><div style="font-size:13px;font-weight:600">No roster data found</div></div>'}
else{
// Build set of staff in overtime (weekly or fortnightly)
var otStaff={};
compWarnings.forEach(function(w){if((w.type==="overtime")&&w.staff&&(w.rule.indexOf("Weekly")>=0||w.rule.indexOf("Fortnight")>=0)){otStaff[w.staff]=w}});

personNames.forEach(function(name,rowIdx){
var allShifts=people[name].all;
var cType=people[name].contactType;
var isUnassigned=name==="Unassigned";
var isOT=schedGroupBy==="staff"&&!isUnassigned&&otStaff[name];

// Only count hours for shifts in the visible view
var viewPersonShifts=allShifts.filter(function(s){return s._dateKey>=viewStartKey&&s._dateKey<=viewEndKey});
var activeH=0,sleepH=0,totalH=0;
viewPersonShifts.forEach(function(s){var c=schedCalcHours(s);activeH+=c.active;sleepH+=c.sleepover;totalH+=c.total});
activeH=Math.round(activeH*10)/10;sleepH=Math.round(sleepH*10)/10;totalH=Math.round(totalH*10)/10;

// Name cell ‚Äî highlight if in OT
var bg=rowIdx%2===1?"var(--surface2)":"var(--surface)";
var nameBg=isOT?"rgba(245,158,11,.06)":bg;
var nameBdr=isOT?"border-left:3px solid #F59E0B;":"";
h+='<div style="padding:8px 10px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);background:'+nameBg+';'+nameBdr+'position:sticky;left:0;z-index:1;display:flex;flex-direction:column;justify-content:center">';
h+='<div style="font-size:11px;font-weight:700;color:'+(isUnassigned?"var(--red)":"var(--text)")+';word-break:break-word;line-height:1.3" title="'+name+'">'+name+'</div>';
// Type badge: Staff view = Employee/Contractor, Client view = SIL/CAS
if(schedGroupBy==="staff"&&!isUnassigned){
var empType=(cType||"").toLowerCase();
var isIC=empType.indexOf("contractor")>=0||empType.indexOf("independent")>=0||empType.indexOf("independant")>=0||empType.indexOf("abn")>=0;
var empLabel=isIC?(cType||"Contractor"):(cType||"Employee");
var empBg=isIC?"rgba(245,158,11,.08)":"rgba(10,147,150,.08)";
var empCol=isIC?"#F59E0B":"var(--teal)";
var empBdr=isIC?"rgba(245,158,11,.15)":"rgba(10,147,150,.15)";
h+='<div style="margin-top:2px"><span style="font-size:8px;font-weight:700;padding:1px 6px;border-radius:6px;background:'+empBg+';color:'+empCol+';border:1px solid '+empBdr+'">'+empLabel+'</span>';
if(isOT)h+=' <span style="font-size:8px;font-weight:800;padding:1px 6px;border-radius:6px;background:rgba(245,158,11,.12);color:#F59E0B;border:1px solid rgba(245,158,11,.25);animation:otPulse 2s infinite">‚è∞ OT</span>';
h+='</div>';
}
if(schedGroupBy==="client"&&!isUnassigned){
var silCas=people[name].silOrCas||"";
if(silCas){
var isSil=silCas.toUpperCase().indexOf("SIL")>=0;
var scBg=isSil?"rgba(30,75,160,.08)":"rgba(16,185,129,.08)";
var scCol=isSil?"var(--royal)":"#10B981";
var scBdr=isSil?"rgba(30,75,160,.15)":"rgba(16,185,129,.15)";
h+='<div style="margin-top:2px"><span style="font-size:8px;font-weight:700;padding:1px 6px;border-radius:6px;background:'+scBg+';color:'+scCol+';border:1px solid '+scBdr+'">'+silCas+'</span></div>';
}}
// Hours breakdown
if(totalH>0){
h+='<div style="margin-top:3px;display:flex;gap:6px;flex-wrap:wrap">';
if(activeH>0)h+='<span style="font-size:8px;font-weight:700;color:var(--teal)" title="Active Hours">‚òÄ '+activeH+'h</span>';
if(sleepH>0)h+='<span style="font-size:8px;font-weight:700;color:#8B5CF6" title="Sleepover Hours">üåô '+sleepH+'h</span>';
h+='<span style="font-size:8px;font-weight:800;color:var(--text)" title="Total Hours">Œ£ '+totalH+'h</span>';
h+='</div>'}
else{h+='<div style="font-size:8px;color:var(--dim);margin-top:2px">'+viewPersonShifts.length+' shift'+(viewPersonShifts.length!==1?"s":"")+'</div>'}
h+='</div>';

// Day cells
days.forEach(function(day){
var dk=schedDateKey(day);
var dayShifts=allShifts.filter(function(s){return s._dateKey===dk});
var isT=schedIsToday(day);var isW=day.getDay()===0||day.getDay()===6;
var bgC=isOT?"rgba(245,158,11,.04)":isT?"rgba(10,147,150,.03)":isW?"rgba(0,0,0,.015)":bg;

h+='<div class="sched-cell" data-dk="'+dk+'" data-person="'+name.replace(/"/g,"&quot;")+'" onclick="schedCellClick(event,\''+name.replace(/'/g,"\\'")+'\',\''+dk+'\')" ondragover="event.preventDefault();this.style.background=\'rgba(10,147,150,.12)\';this.style.outline=\'2px dashed var(--teal)\'" ondragleave="this.style.background=\''+bgC+'\';this.style.outline=\'none\'" ondrop="schedDrop(event,this)" style="padding:2px;border-bottom:1px solid var(--border);border-right:1px solid var(--border);min-height:58px;background:'+bgC+';transition:background .1s;cursor:pointer;position:relative">';

dayShifts.forEach(function(s){
var fundCol={"High Intensity Funding":"#EF4444","Standard Funding":"#3B82F6"}[s.fundingLevel]||"#94A3B8";
var sT=s._startDt?schedFmtTime(s._startDt):"";
var eT=s._endDt?schedFmtTime(s._endDt):"";
var ch=schedCalcHours(s);
var label=schedGroupBy==="staff"?(s.clientName||""):(s.staffName||"Vacant");
var isVac=!s.staffName||s.staffName.trim()==="";
var flag=flaggedShifts[s._idx];
var flagBorder=flag?({breach:"#EF4444",overtime:"#F59E0B",approaching:"#FB923C",penalty:"#8B5CF6"}[flag.type]||fundCol):fundCol;
var flagBg=flag?({breach:"rgba(239,68,68,.08)",overtime:"rgba(245,158,11,.06)",approaching:"rgba(251,146,60,.06)",penalty:"rgba(139,92,246,.06)"}[flag.type]||fundCol+"0A"):(isVac?"repeating-linear-gradient(45deg,#fff,#fff 4px,#fef2f2 4px,#fef2f2 8px)":fundCol+"0A");

var isDraftShift = (s.Status||s.status||s["Status"]||"").toLowerCase()==="draft";
var pillBg = isDraftShift ? "repeating-linear-gradient(45deg,rgba(245,158,11,.05),rgba(245,158,11,.05) 4px,rgba(245,158,11,.12) 4px,rgba(245,158,11,.12) 8px)" : flagBg;
var pillBorder = isDraftShift ? "#F59E0B" : flagBorder;
h+='<div draggable="true" ondragstart="schedDragStart(event,'+s._idx+')" onclick="openSchedModal('+s._idx+')" style="padding:4px 5px;margin-bottom:2px;border-radius:4px;cursor:grab;font-size:10px;border-left:3px solid '+pillBorder+';background:'+pillBg+';transition:all .12s;box-shadow:0 1px 2px rgba(0,0,0,.05);position:relative" onmouseover="this.style.boxShadow=\'0 2px 8px rgba(0,0,0,.12)\';this.style.transform=\'scale(1.02)\'" onmouseout="this.style.boxShadow=\'0 1px 2px rgba(0,0,0,.05)\';this.style.transform=\'none\'">';
if(isDraftShift)h+='<div style="font-size:8px;font-weight:800;color:#92400E;background:rgba(245,158,11,.15);border-radius:3px;padding:1px 4px;margin-bottom:2px">\u23f3 DRAFT</div>';
if(flag)h+='<span title="'+flag.rule+' ('+flag.ref+')" style="position:absolute;top:2px;right:3px;font-size:8px">'+flag.icon+'</span>';
if(sT||eT)h+='<div style="font-weight:700;color:var(--text);font-size:9px">'+(sT||"?")+' ‚Äì '+(eT||"?")+'</div>';
if(ch.total>0){h+='<div style="display:flex;gap:4px;align-items:center">';
if(ch.active>0)h+='<span style="font-weight:800;color:'+fundCol+';font-size:8px">‚òÄ'+ch.active+'h</span>';
if(ch.sleepover>0)h+='<span style="font-weight:800;color:#8B5CF6;font-size:8px">üåô'+ch.sleepover+'h</span>';
h+='</div>'}
if(label)h+='<div style="color:'+(isVac?"var(--red)":"var(--muted)")+';font-weight:600;font-size:9px;word-break:break-word">'+(isVac?"‚ö† Vacant":label)+'</div>';
h+='</div>'});
h+='</div>'});
})}
h+='</div></div>';

}else{
// ‚îÄ‚îÄ‚îÄ JOB BOARD ‚îÄ‚îÄ‚îÄ
h+='<div style="flex:1;overflow-y:auto;padding:20px">';
h+='<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">';
h+='<input id="jobBoardSearch" oninput="filterJobBoard()" placeholder="Search vacant shifts..." style="flex:1;min-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);outline:none">';
var allSkills={};vacantShifts.forEach(function(s){(s.skills||[]).forEach(function(sk){allSkills[sk]=1})});
if(Object.keys(allSkills).length>0){
h+='<select id="jobBoardSkillFilter" onchange="filterJobBoard()" style="padding:7px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-weight:600;font-family:inherit;background:var(--surface2);cursor:pointer"><option value="">All Skills</option>';
Object.keys(allSkills).sort().forEach(function(sk){h+='<option value="'+sk+'">'+sk+'</option>'});
h+='</select>'}
h+='</div>';

if(vacantShifts.length===0){
h+='<div style="text-align:center;padding:40px;color:var(--muted)"><div style="font-size:48px;margin-bottom:12px">üéâ</div><div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:4px">All shifts filled!</div><div style="font-size:13px">No vacant shifts requiring staff</div></div>'}
else{
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px" id="jobBoardGrid">';
vacantShifts.forEach(function(s){
var ds=parseSchedDate(s.startShift),de=parseSchedDate(s.endShift);
var sT=ds?schedFmtTime(ds):"";var eT=de?schedFmtTime(de):"";
var ch=schedCalcHours(s);
var dateStr=ds?ds.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short"}):"No date";
var fundCol={"High Intensity Funding":"#EF4444","Standard Funding":"#3B82F6"}[s.fundingLevel]||"#94A3B8";
var dayCol={"Weekday":"#3B82F6","Saturday":"#F59E0B","Sunday":"#8B5CF6"}[s.dayType]||"#94A3B8";

h+='<div class="jb-card" draggable="true" ondragstart="schedDragStart(event,'+s._idx+')" onclick="openSchedModal('+s._idx+')" data-skills="'+((s.skills||[]).join(",").toLowerCase())+'" data-client="'+(s.clientName||"").toLowerCase()+'" style="padding:16px;background:var(--surface);border:1px solid var(--border);border-left:4px solid '+fundCol+';border-radius:var(--r);cursor:grab;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.04)" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,.08)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.borderLeftColor=\''+fundCol+'\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,.04)\'">';
h+='<div style="display:flex;justify-content:space-between;margin-bottom:8px"><div style="font-size:14px;font-weight:700;color:var(--royal)">'+(s.clientName||"Unknown")+'</div><span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:'+fundCol+'12;color:'+fundCol+';border:1px solid '+fundCol+'25;white-space:nowrap;height:fit-content">'+(s.fundingLevel||"")+'</span></div>';

h+='<div style="display:flex;gap:12px;margin-bottom:8px">';
h+='<div><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Date</div><div style="font-size:12px;font-weight:700;color:var(--text)">'+dateStr+'</div></div>';
h+='<div><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Time</div><div style="font-size:12px;font-weight:700;color:var(--text)">'+(sT||"?")+' ‚Äì '+(eT||"?")+'</div></div>';
if(ch.total>0){
h+='<div><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Hours</div><div style="display:flex;gap:4px">';
if(ch.active>0)h+='<span style="font-size:11px;font-weight:800;color:'+fundCol+'">‚òÄ'+ch.active+'h</span>';
if(ch.sleepover>0)h+='<span style="font-size:11px;font-weight:800;color:#8B5CF6">üåô'+ch.sleepover+'h</span>';
h+='</div></div>'}
h+='</div>';

h+='<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">';
if(s.dayType)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:'+dayCol+'10;color:'+dayCol+';border:1px solid '+dayCol+'20">'+s.dayType+'</span>';
if(s.silOrCas)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:8px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.2)">'+s.silOrCas+'</span>';
h+='</div>';

if(s.skills&&s.skills.length>0){
h+='<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:8px">';
s.skills.forEach(function(sk){h+='<span style="font-size:8px;font-weight:600;padding:2px 6px;border-radius:6px;background:rgba(16,185,129,.06);color:#10B981;border:1px solid rgba(16,185,129,.15)">'+sk+'</span>'});
h+='</div>'}

h+='<div style="padding:6px;background:rgba(239,68,68,.04);border:1px dashed rgba(239,68,68,.2);border-radius:var(--rs);text-align:center"><span style="font-size:10px;font-weight:700;color:var(--red)">‚ö† Staff Required</span></div>';
h+='</div>'});
h+='</div>'}
h+='</div>'}

h+='</div>';
rp.innerHTML=h}

function schedDragStart(e,idx){if(!canEdit("scheduler")){e.preventDefault();return}schedDragIdx=idx;e.dataTransfer.effectAllowed="move";e.dataTransfer.setData("text/plain",String(idx));e.target.style.opacity="0.5";setTimeout(function(){if(e.target)e.target.style.opacity="1"},300)}

function schedDrop(e,cell){
e.preventDefault();cell.style.background="";cell.style.outline="none";
if(schedDragIdx===null)return;
var s=schedulerData[schedDragIdx];if(!s)return;
var targetPerson=cell.getAttribute("data-person");
var targetDk=cell.getAttribute("data-dk");
if(!targetPerson||!targetDk)return;
if(schedGroupBy==="staff"){s.staffName=targetPerson;if(targetPerson==="Unassigned")s.staffName=""}
else{s.clientName=targetPerson}
var parts=targetDk.split("-");var newDate=new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
if(s._startDt&&s._endDt){
var dur=s._endDt.getTime()-s._startDt.getTime();
var ns=new Date(newDate);ns.setHours(s._startDt.getHours(),s._startDt.getMinutes(),0,0);
s._startDt=ns;s._endDt=new Date(ns.getTime()+dur);
s._dateKey=schedDateKey(ns);s.startShift=ns.toISOString();s.endShift=s._endDt.toISOString()}
else{s._dateKey=targetDk}
schedDragIdx=null;schedRefresh()}

function filterJobBoard(){
var q=(document.getElementById("jobBoardSearch")||{}).value||"";q=q.toLowerCase();
var sk=(document.getElementById("jobBoardSkillFilter")||{}).value||"";sk=sk.toLowerCase();
document.querySelectorAll(".jb-card").forEach(function(card){
var cl=card.getAttribute("data-client")||"";var sks=card.getAttribute("data-skills")||"";
var ok=(!q||cl.indexOf(q)>=0||sks.indexOf(q)>=0)&&(!sk||sks.indexOf(sk)>=0);
card.style.display=ok?"":"none"})}

// ‚îÄ‚îÄ‚îÄ Click cell to create shift ‚îÄ‚îÄ‚îÄ
function schedCellClick(event,personName,dateKey){
// Don't trigger if clicking on an existing shift card
if(event.target.closest('[draggable="true"]'))return;
openNewShiftModal();
// Pre-fill staff and date after modal renders
setTimeout(function(){
var staffSel=document.getElementById("nsStaff");
if(staffSel&&personName&&personName!=="Unassigned"){
for(var i=0;i<staffSel.options.length;i++){
if(staffSel.options[i].value===personName){staffSel.selectedIndex=i;break}}}
var dateInp=document.getElementById("nsDate");
if(dateInp&&dateKey){
// dateKey is YYYY-MM-DD format
dateInp.value=dateKey}
},50)}

// ‚îÄ‚îÄ‚îÄ New Shift Modal ‚îÄ‚îÄ‚îÄ
function openNewShiftModal(){
if(!canEdit("scheduler"))return;
var ov=document.createElement("div");ov.id="newShiftOverlay";
ov.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
ov.onclick=function(e){if(e.target===ov)ov.remove()};
// Get unique clients and staff
var clients={},staff={};
schedulerData.forEach(function(s){if(s.clientName)clients[s.clientName]=1;if(s.staffName)staff[s.staffName]=1});
var cList=Object.keys(clients).sort();var sList=Object.keys(staff).sort();

var h='<div style="background:var(--surface);border-radius:12px;max-width:520px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">‚ûï</span><span style="font-size:15px;font-weight:700;color:var(--text)">New Shift</span></div>';
h+='<button onclick="document.getElementById(\'newShiftOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';
h+='<div style="padding:20px">';

h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
// Client
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Client *</label>';
h+='<select id="nsClient" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"><option value="">Select client...</option>';
cList.forEach(function(c){h+='<option value="'+c+'">'+c+'</option>'});
h+='</select></div>';
// Staff
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Staff (leave empty for vacant)</label>';
h+='<select id="nsStaff" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"><option value="">Vacant / Unassigned</option>';
sList.forEach(function(s){h+='<option value="'+s+'">'+s+'</option>'});
h+='</select></div>';
// Date
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Date *</label>';
h+='<input type="date" id="nsDate" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"></div>';
// Funding
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Funding Level</label>';
h+='<select id="nsFunding" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"><option value="Standard Funding">Standard Funding</option><option value="High Intensity Funding">High Intensity Funding</option></select></div>';
// Start
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Start Time *</label>';
h+='<input type="time" id="nsStart" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"></div>';
// End
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">End Time *</label>';
h+='<input type="time" id="nsEnd" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"></div>';
// Day Type
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Day Type</label>';
h+='<select id="nsDayType" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"><option value="Weekday">Weekday</option><option value="Saturday">Saturday</option><option value="Sunday">Sunday</option></select></div>';
// SIL or CAS
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">SIL or CAS?</label>';
h+='<select id="nsSilCas" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2)"><option value="Comm Access">Comm Access</option><option value="SIL">SIL</option></select></div>';
h+='</div>';

// Sleepover toggle
h+='<div style="margin-top:14px;padding:10px 12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15);border-radius:var(--rs)">';
h+='<label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text)">';
h+='<input type="checkbox" id="nsSleepover" onchange="toggleSleepover(this.checked)" style="width:18px;height:18px;accent-color:#8B5CF6;cursor:pointer">';
h+='<span>üåô Add Sleepover</span>';
h+='<span style="font-size:10px;color:var(--dim);font-weight:400;margin-left:auto">Inactive shift ‚Ä¢ 10pm‚Äì6am ‚Ä¢ 1hr allowance</span>';
h+='</label>';
h+='<div id="nsSleepoverPreview" style="display:none;margin-top:8px;padding:8px 10px;background:rgba(139,92,246,.06);border-radius:4px;font-size:11px;color:#8B5CF6;font-weight:600">';
h+='‚òÄ <strong>Active Shift</strong>: Uses start/end times above (paid hourly)<br>';
h+='üåô <strong>Sleepover Shift</strong>: 10:00pm ‚Äì 6:00am added as Inactive (1hr allowance)';
h+='</div></div>';

h+='<button onclick="saveNewShift()" style="margin-top:16px;width:100%;padding:10px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer">Create Shift</button>';
h+='</div></div>';
ov.innerHTML=h;document.body.appendChild(ov)}

function toggleSleepover(isChecked){
var preview=document.getElementById("nsSleepoverPreview");
if(isChecked){
if(preview)preview.style.display="block";
}else{
if(preview)preview.style.display="none";
}}

function saveNewShift(){
var client=document.getElementById("nsClient").value;
var staff=document.getElementById("nsStaff").value;
var date=document.getElementById("nsDate").value;
var start=document.getElementById("nsStart").value;
var end=document.getElementById("nsEnd").value;
var fund=document.getElementById("nsFunding").value;
var dayType=document.getElementById("nsDayType").value;
var silCas=document.getElementById("nsSilCas").value;
var isSleepover=document.getElementById("nsSleepover")&&document.getElementById("nsSleepover").checked;
if(!client||!date||!start||!end){alert("Please fill in Client, Date, Start and End time");return}
var startDt=new Date(date+"T"+start+":00");
var endDt=new Date(date+"T"+end+":00");
if(endDt<=startDt)endDt.setDate(endDt.getDate()+1);// overnight
var newShift={
airtableId:"local-"+Date.now(),uniqueRef:"",
clientName:client,staffName:staff,fundingLevel:fund,
skills:[],silOrCas:silCas,staffEmail:"",contactType:"",
startShift:startDt.toISOString(),endShift:endDt.toISOString(),
dayType:dayType,sleepover:isSleepover,
allFields:isSleepover?{Sleepover:true}:{}};
schedulerData.push(newShift);
var ov=document.getElementById("newShiftOverlay");if(ov)ov.remove();
schedRefresh()}

function openSchedModal(idx){
var r=schedulerData[idx];if(!r)return;
var overlay=document.createElement("div");overlay.id="schedModalOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
var ds=parseSchedDate(r.startShift),de=parseSchedDate(r.endShift);
var ch=schedCalcHours(r);
var isVac=!r.staffName||r.staffName.trim()==="";
var fundCol={"High Intensity Funding":"#EF4444","Standard Funding":"#3B82F6"}[r.fundingLevel]||"#94A3B8";
var dayCol={"Weekday":"#3B82F6","Saturday":"#F59E0B","Sunday":"#8B5CF6"}[r.dayType]||"#94A3B8";

// Build dropdowns from existing data
var clients={},staff={};
schedulerData.forEach(function(s){if(s.clientName)clients[s.clientName]=1;if(s.staffName)staff[s.staffName]=1});
var cList=Object.keys(clients).sort();var sList=Object.keys(staff).sort();

// Pre-compute date/time values for inputs
var dateVal=ds?ds.getFullYear()+"-"+String(ds.getMonth()+1).padStart(2,"0")+"-"+String(ds.getDate()).padStart(2,"0"):"";
var startTimeVal=ds?String(ds.getHours()).padStart(2,"0")+":"+String(ds.getMinutes()).padStart(2,"0"):"";
var endTimeVal=de?String(de.getHours()).padStart(2,"0")+":"+String(de.getMinutes()).padStart(2,"0"):"";

var h='<div style="background:var(--surface);border-radius:12px;max-width:600px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';

// Header
h+='<div style="padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;border-radius:12px 12px 0 0">';
h+='<div style="display:flex;align-items:center;gap:8px"><span style="font-size:18px">üìÖ</span><span style="font-size:15px;font-weight:700;color:var(--text)">Edit Shift</span>';
if(ch.active>0)h+='<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.15)">‚òÄ '+ch.active+'h Active</span>';
if(ch.sleepover>0)h+='<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(139,92,246,.08);color:#8B5CF6;border:1px solid rgba(139,92,246,.15)">üåô '+ch.sleepover+'h Sleepover</span>';
h+='</div>';
h+='<button onclick="document.getElementById(\'schedModalOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);padding:4px 8px">‚úï</button></div>';
h+='<div style="padding:20px">';

if(isVac)h+='<div style="padding:8px 12px;background:rgba(239,68,68,.06);border:1px dashed rgba(239,68,68,.2);border-radius:var(--rs);margin-bottom:14px;display:flex;align-items:center;gap:8px"><span style="font-size:16px">‚ö†Ô∏è</span><span style="font-size:11px;font-weight:700;color:var(--red)">Vacant Shift ‚Äî Staff Required</span></div>';

// ‚îÄ‚îÄ Editable fields ‚îÄ‚îÄ
var schedReadOnly=!canEdit("scheduler");
var iS='style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:'+(schedReadOnly?"var(--surface)":"var(--surface2)")+';outline:none;'+(schedReadOnly?"opacity:.7;pointer-events:none":"")+'"'+(schedReadOnly?" disabled":"");
var lS='style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px"';

h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">';

// Client
h+='<div><label '+lS+'>Client</label><select id="emClient" '+iS+'>';
h+='<option value="">‚Äî Select ‚Äî</option>';
cList.forEach(function(c){h+='<option value="'+c+'"'+(c===r.clientName?' selected':'')+'>'+c+'</option>'});
h+='</select></div>';

// Staff
h+='<div><label '+lS+'>Staff</label><select id="emStaff" '+iS+'>';
h+='<option value="">Vacant / Unassigned</option>';
sList.forEach(function(s){h+='<option value="'+s+'"'+(s===r.staffName?' selected':'')+'>'+s+'</option>'});
h+='</select></div>';

// Date
h+='<div><label '+lS+'>Date</label><input type="date" id="emDate" value="'+dateVal+'" '+iS+'></div>';

// Funding
h+='<div><label '+lS+'>Funding Level</label><select id="emFunding" '+iS+'>';
["Standard Funding","High Intensity Funding"].forEach(function(f){h+='<option value="'+f+'"'+(f===r.fundingLevel?' selected':'')+'>'+f+'</option>'});
h+='</select></div>';

// Start time
h+='<div><label '+lS+'>Start Time</label><input type="time" id="emStart" value="'+startTimeVal+'" '+iS+'></div>';

// End time
h+='<div><label '+lS+'>End Time</label><input type="time" id="emEnd" value="'+endTimeVal+'" '+iS+'></div>';

// Day type
h+='<div><label '+lS+'>Day Type</label><select id="emDayType" '+iS+'>';
["Weekday","Saturday","Sunday"].forEach(function(d){h+='<option value="'+d+'"'+(d===r.dayType?' selected':'')+'>'+d+'</option>'});
h+='</select></div>';

// SIL/CAS
h+='<div><label '+lS+'>SIL or CAS?</label><select id="emSilCas" '+iS+'>';
["Comm Access","SIL"].forEach(function(v){h+='<option value="'+v+'"'+(v===r.silOrCas?' selected':'')+'>'+v+'</option>'});
h+='</select></div>';

h+='</div>';

// Sleepover toggle in edit modal
var hasSleep=r.sleepover||(r.allFields&&r.allFields.Sleepover)||false;
h+='<div style="margin-bottom:14px;padding:10px 12px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.15);border-radius:var(--rs)">';
h+='<label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text)">';
h+='<input type="checkbox" id="emSleepover" '+(hasSleep?'checked':'')+' style="width:18px;height:18px;accent-color:#8B5CF6;cursor:pointer">';
h+='<span>üåô Sleepover Included</span>';
h+='<span style="font-size:10px;color:var(--dim);font-weight:400;margin-left:auto">Inactive ‚Ä¢ 10pm‚Äì6am ‚Ä¢ 1hr allowance</span>';
h+='</label></div>';

// Hours display
if(ch.total>0||ch.sleepover>0){
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">';
h+='<div style="padding:8px;background:rgba(10,147,150,.04);border:1px solid rgba(10,147,150,.12);border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:2px">Active</div><div style="font-size:16px;font-weight:800;color:var(--teal)">‚òÄ '+ch.active+'h</div><div style="font-size:8px;color:var(--dim);margin-top:1px">'+(startTimeVal&&endTimeVal?startTimeVal+' ‚Äì '+endTimeVal:'Hourly')+'</div></div>';
h+='<div style="padding:8px;background:rgba(139,92,246,.04);border:1px solid rgba(139,92,246,.12);border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:2px">Sleepover</div><div style="font-size:16px;font-weight:800;color:#8B5CF6">üåô '+ch.sleepover+'h</div><div style="font-size:8px;color:var(--dim);margin-top:1px">'+(ch.sleepover>0?'10pm ‚Äì 6am':'Not added')+'</div></div>';
h+='<div style="padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);text-align:center"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:2px">Total</div><div style="font-size:16px;font-weight:800;color:var(--text)">'+ch.total+'h</div></div>';
h+='</div>'}

// Extra info (read only)
var infoFields=[];
if(r.staffEmail)infoFields.push({l:"Staff Email",v:r.staffEmail});
if(r.uniqueRef)infoFields.push({l:"Unique Ref #",v:r.uniqueRef});
if(r.contactType)infoFields.push({l:"Contact Type",v:r.contactType});
if(infoFields.length>0){
h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">';
infoFields.forEach(function(f){h+='<div style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);flex:1;min-width:120px"><div style="font-size:8px;font-weight:600;color:var(--muted);text-transform:uppercase">'+f.l+'</div><div style="font-size:11px;font-weight:600;color:var(--text);margin-top:1px">'+f.v+'</div></div>'});
h+='</div>'}

// Skills
if(r.skills&&r.skills.length>0){
h+='<div style="margin-bottom:14px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Required Skills</div><div style="display:flex;gap:3px;flex-wrap:wrap">';
r.skills.forEach(function(sk){h+='<span style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:8px;background:rgba(16,185,129,.08);color:#10B981;border:1px solid rgba(16,185,129,.2)">'+sk+'</span>'});
h+='</div></div>'}

// All other fields
var af=r.allFields||{};
var shown={"Unique Ref #":1,"Client Name":1,"Client Full Name":1,"Funding Level":1,"Required Staff Skills":1,"SIL or CAS?":1,"Staff Email":1,"Staff Name":1,"Type of Contact (Single Select)":1,"Type of Contact":1,"Start Shift":1,"End Shift":1,"Day Type":1};
var extra={};Object.keys(af).forEach(function(k){if(shown[k])return;var v=af[k];if(!v||v===""||v===0||v===false||(Array.isArray(v)&&v.length===0))return;extra[k]=v});
var ek=Object.keys(extra);
if(ek.length>0){
h+='<details style="margin-bottom:14px"><summary style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase;cursor:pointer;padding:4px 0">All Other Fields ('+ek.length+')</summary><div style="display:grid;gap:4px;margin-top:4px">';
ek.sort().forEach(function(k){var v=extra[k];if(Array.isArray(v))v=v.join(", ");if(typeof v==="object")v=JSON.stringify(v);h+='<div style="padding:4px 8px;background:var(--surface2);border-radius:var(--rs);border:1px solid var(--border)"><div style="font-size:8px;font-weight:600;color:var(--muted)">'+k+'</div><div style="font-size:10px;color:var(--text);word-break:break-word;white-space:pre-wrap">'+v+'</div></div>'});
h+='</div></details>'}

// ‚îÄ‚îÄ Compliance flags for this shift ‚îÄ‚îÄ
var shiftFlags=[];
if(ds&&de){
var durH=(de-ds)/3600000;
var isIC=(r.contactType||"").toLowerCase().indexOf("contractor")>=0||(r.contactType||"").toLowerCase().indexOf("independent")>=0||(r.contactType||"").toLowerCase().indexOf("independant")>=0;
if(durH>0&&durH<2)shiftFlags.push({icon:"‚ö†Ô∏è",rule:"Min 2hr Shift",ref:"cl. 10.5",msg:"Shift is "+durH.toFixed(1)+"h ‚Äî minimum engagement is 2 hours (Award breach)",type:"breach"});
if(!isIC&&durH>10)shiftFlags.push({icon:"‚è∞",rule:"Daily >10hrs",ref:"cl. 25.1(b), 28.1",msg:"Shift is "+durH.toFixed(1)+"h ‚Äî overtime triggered after 10hrs",type:"overtime"});
else if(!isIC&&durH>8)shiftFlags.push({icon:"‚ö°",rule:"Approaching 10hrs",ref:"cl. 25.1(b)",msg:"Shift is "+durH.toFixed(1)+"h ‚Äî approaching 10hr overtime threshold ("+(10-durH).toFixed(1)+"hrs remaining)",type:"approaching"});
var sH=ds.getHours()+(ds.getMinutes()/60);
var eH=de.getHours()+(de.getMinutes()/60);
if(sH<6)shiftFlags.push({icon:"üåô",rule:"Before 6am",ref:"cl. 25.2(a)",msg:"Starts at "+schedFmtTime(ds)+" ‚Äî outside ordinary span, penalty rates apply"});
if(eH>20&&de.getDate()===ds.getDate())shiftFlags.push({icon:"üåô",rule:"After 8pm",ref:"cl. 25.2(a)",msg:"Ends at "+schedFmtTime(de)+" ‚Äî outside ordinary span, penalty rates apply"});
}
if(shiftFlags.length>0){
var hasApproachOnly=shiftFlags.every(function(f){return f.type==="approaching"});
var flagBg=hasApproachOnly?"rgba(251,146,60,.03)":"rgba(239,68,68,.03)";
var flagBorder=hasApproachOnly?"rgba(251,146,60,.12)":"rgba(239,68,68,.12)";
var flagTitle=hasApproachOnly?"‚ö° Approaching Limits":"üõ° SCHADS Compliance Flags";
var flagTitleCol=hasApproachOnly?"#FB923C":"var(--red)";
h+='<div style="margin-bottom:14px;padding:8px 10px;background:'+flagBg+';border:1px solid '+flagBorder+';border-radius:var(--rs)">';
h+='<div style="font-size:9px;font-weight:800;color:'+flagTitleCol+';text-transform:uppercase;margin-bottom:6px">'+flagTitle+'</div>';
shiftFlags.forEach(function(f){
var fCol=f.type==="approaching"?"#FB923C":f.type==="overtime"?"#F59E0B":f.type==="penalty"?"#8B5CF6":"var(--red)";
h+='<div style="display:flex;gap:6px;align-items:start;padding:3px 0;font-size:10px">';
h+='<span style="flex-shrink:0">'+f.icon+'</span>';
h+='<div><span style="font-weight:700;color:'+fCol+'">'+f.rule+'</span> <span style="color:var(--dim);font-size:8px">'+f.ref+'</span>';
h+='<div style="color:var(--muted);margin-top:1px">'+f.msg+'</div></div></div>'});
h+='</div>'}

// ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ
if(canEdit("scheduler")){
h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
h+='<button onclick="saveSchedEdit('+idx+')" style="padding:10px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer">üíæ Save Changes</button>';
h+='<button onclick="duplicateShift('+idx+')" style="padding:10px;background:var(--royal);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer">üìã Duplicate as Vacant</button>';
h+='</div>';
h+='<div style="text-align:center;margin-top:6px"><button onclick="deleteSchedShift('+idx+')" style="padding:6px 16px;background:none;color:var(--red);border:1px solid rgba(239,68,68,.2);border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">üóë Remove Shift</button></div>';
}else{
h+='<div style="text-align:center;padding:10px;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:var(--rs);font-size:11px;font-weight:600;color:#3B82F6">üëÅ View only ‚Äî editing disabled</div>';
}

h+='</div></div>';
overlay.innerHTML=h;document.body.appendChild(overlay)}

function saveSchedEdit(idx){
var r=schedulerData[idx];if(!r)return;
var client=document.getElementById("emClient").value;
var staff=document.getElementById("emStaff").value;
var date=document.getElementById("emDate").value;
var start=document.getElementById("emStart").value;
var end=document.getElementById("emEnd").value;
var fund=document.getElementById("emFunding").value;
var dayType=document.getElementById("emDayType").value;
var silCas=document.getElementById("emSilCas").value;
if(!date||!start||!end){alert("Date, Start and End time are required");return}
var startDt=new Date(date+"T"+start+":00");
var endDt=new Date(date+"T"+end+":00");
if(endDt<=startDt)endDt.setDate(endDt.getDate()+1);
r.clientName=client;r.staffName=staff;r.fundingLevel=fund;
r.dayType=dayType;r.silOrCas=silCas;
r.startShift=startDt.toISOString();r.endShift=endDt.toISOString();
r._startDt=startDt;r._endDt=endDt;r._dateKey=schedDateKey(startDt);
// Update sleepover flag
var sleepCb=document.getElementById("emSleepover");
r.sleepover=sleepCb?sleepCb.checked:false;
if(!r.allFields)r.allFields={};
r.allFields.Sleepover=r.sleepover;
var ov=document.getElementById("schedModalOverlay");if(ov)ov.remove();
schedRefresh()}

function duplicateShift(idx){
var r=schedulerData[idx];if(!r)return;
// Prompt for date
var ov=document.getElementById("schedModalOverlay");if(ov)ov.remove();
var dupOv=document.createElement("div");dupOv.id="dupShiftOverlay";
dupOv.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
dupOv.onclick=function(e){if(e.target===dupOv)dupOv.remove()};
var ds=parseSchedDate(r.startShift);
var defDate=ds?ds.getFullYear()+"-"+String(ds.getMonth()+1).padStart(2,"0")+"-"+String(ds.getDate()).padStart(2,"0"):"";
var dh='<div style="background:var(--surface);border-radius:12px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:24px">';
dh+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px"><span style="font-size:20px">üìã</span><span style="font-size:16px;font-weight:700;color:var(--text)">Duplicate Shift</span></div>';
dh+='<div style="padding:10px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text)">'+(r.clientName||"Unknown Client")+'</div><div style="font-size:10px;color:var(--muted);margin-top:2px">'+(ds?schedFmtTime(ds):"")+(r._endDt?" ‚Äì "+schedFmtTime(r._endDt):"")+(r.fundingLevel?" ¬∑ "+r.fundingLevel:"")+'</div></div>';
dh+='<div style="padding:8px 10px;background:rgba(239,68,68,.04);border:1px dashed rgba(239,68,68,.15);border-radius:var(--rs);margin-bottom:12px;font-size:10px;font-weight:600;color:var(--red);text-align:center">Staff will be set to Unassigned (Vacant)</div>';
dh+='<label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:4px">New Shift Date *</label>';
dh+='<input type="date" id="dupDate" value="'+defDate+'" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface2);margin-bottom:14px">';
dh+='<button onclick="confirmDuplicate('+idx+')" style="width:100%;padding:10px;background:var(--royal);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer">üìã Create Vacant Copy</button>';
dh+='</div>';
dupOv.innerHTML=dh;document.body.appendChild(dupOv)}

function confirmDuplicate(idx){
var r=schedulerData[idx];if(!r)return;
var newDate=document.getElementById("dupDate").value;
if(!newDate){alert("Please select a date");return}
var ds=parseSchedDate(r.startShift),de=parseSchedDate(r.endShift);
var sH=ds?ds.getHours():0,sM=ds?ds.getMinutes():0;
var eH=de?de.getHours():0,eM=de?de.getMinutes():0;
var ns=new Date(newDate+"T"+String(sH).padStart(2,"0")+":"+String(sM).padStart(2,"0")+":00");
var ne=new Date(newDate+"T"+String(eH).padStart(2,"0")+":"+String(eM).padStart(2,"0")+":00");
if(ne<=ns)ne.setDate(ne.getDate()+1);
var dup={
airtableId:"local-dup-"+Date.now(),uniqueRef:"",
clientName:r.clientName,staffName:"",fundingLevel:r.fundingLevel,
skills:r.skills?r.skills.slice():[],silOrCas:r.silOrCas,
staffEmail:"",contactType:"",
startShift:ns.toISOString(),endShift:ne.toISOString(),
dayType:r.dayType,allFields:{}};
schedulerData.push(dup);
var ov=document.getElementById("dupShiftOverlay");if(ov)ov.remove();
schedRefresh()}

function deleteSchedShift(idx){
if(!confirm("Remove this shift from the scheduler?"))return;
schedulerData.splice(idx,1);
var ov=document.getElementById("schedModalOverlay");if(ov)ov.remove();
schedRefresh()}

// ‚ïê‚ïê‚ïê RECRUIT DATA ‚ïê‚ïê‚ïê
var recruitData=[];
var kanbanStages=["CV Received","Phone Interview","GA Interview","Onboard","Employed","Unsuccessful"];
var kanbanColors={"CV Received":"#3B82F6","Phone Interview":"#8B5CF6","GA Interview":"#F59E0B","Onboard":"#0A9396","Employed":"#10B981","Unsuccessful":"#EF4444"};
function loadRecruitData(){
apiCall("GET","/api/recruit").then(function(d){recruitData=d||[];renderRecruit()}).catch(function(){recruitData=[];renderRecruit()})}

function renderRecruit(){
var rp=document.getElementById("rightPanel");
// Ensure sub is open & highlighted
document.getElementById("recruitSub").classList.add("open");
document.querySelectorAll(".sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('[data-subview="'+recruitSubView+'"]');if(active)active.classList.add("on");
// Auto-load data if not loaded
if(!window._recruitLoaded){
window._recruitLoaded=true;
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading applicants...</div></div></div>';
apiCall("GET","/api/recruit").then(function(d){recruitData=d||[];
if(recruitSubView==="overview")renderRecruitOverview(rp);
else if(recruitSubView==="cvupload")renderCVUpload(rp);
else if(recruitSubView==="list")renderRecruitList(rp);
else if(recruitSubView==="kanban")renderRecruitKanban(rp);
else if(recruitSubView==="lms")renderLMS(rp)}).catch(function(){recruitData=[];renderRecruitOverview(rp)});return}
if(recruitSubView==="overview")renderRecruitOverview(rp);
else if(recruitSubView==="cvupload")renderCVUpload(rp);
else if(recruitSubView==="list")renderRecruitList(rp);
else if(recruitSubView==="kanban")renderRecruitKanban(rp);
else if(recruitSubView==="lms")renderLMS(rp)}

function renderRecruitOverview(rp){
var total=recruitData.length;
var bySt={};kanbanStages.forEach(function(s){bySt[s]=0});
recruitData.forEach(function(r){var st=r.stage||"CV Received";if(bySt[st]!==undefined)bySt[st]++;else bySt["CV Received"]++});
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="margin-bottom:20px"><div style="font-size:22px;font-weight:700;color:var(--text)">HR / Recruit</div><div style="font-size:13px;color:var(--muted)">'+total+' applicant'+(total!==1?"s":"")+'</div></div>';
// Stats cards
h+='<div style="display:grid;grid-template-columns:repeat('+kanbanStages.length+',1fr);gap:10px;margin-bottom:20px">';
kanbanStages.forEach(function(st){
var col=kanbanColors[st];
h+='<div style="padding:14px;background:'+col+'08;border:1px solid '+col+'20;border-radius:var(--r);text-align:center;cursor:pointer" onclick="filterRecruitOverview(\''+st+'\')">';
h+='<div style="font-size:22px;font-weight:800;color:'+col+'">'+bySt[st]+'</div>';
h+='<div style="font-size:9px;font-weight:600;color:var(--muted);margin-top:2px">'+st+'</div></div>'});
h+='</div>';
// Bulk actions bar
h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">';
h+='<input id="recruitOverviewSearch" oninput="filterRecruitOverview()" placeholder="Search applicants..." style="flex:1;min-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);outline:none">';
h+='<select id="recruitStageFilter" onchange="filterRecruitOverview()" style="padding:7px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-weight:600;font-family:inherit;background:var(--surface2);cursor:pointer"><option value="">All Stages</option>';
kanbanStages.forEach(function(s){h+='<option value="'+s+'">'+s+'</option>'});
h+='</select>';
h+='<select id="recruitBulkStage" style="padding:7px 10px;border:1px solid var(--tealBorder);border-radius:var(--rs);font-size:11px;font-weight:600;font-family:inherit;background:var(--tealLight);color:var(--teal);cursor:pointer"><option value="">Bulk: Change stage to...</option>';
kanbanStages.forEach(function(s){h+='<option value="'+s+'">‚Üí '+s+'</option>'});
h+='</select>';
h+='<button class="btn btn-teal btn-sm" onclick="applyBulkStage()">Apply</button>';
h+='</div>';
// Table
h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
h+='<thead><tr style="border-bottom:2px solid var(--border)">';
h+='<th style="padding:8px 4px;width:30px"><input type="checkbox" onchange="toggleAllRecruitChecks(this.checked)" id="recruitCheckAll"></th>';
["Name","Email","Date Applied","Last Modified","Stage"].forEach(function(col){
h+='<th style="padding:8px 6px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>'});
h+='</tr></thead><tbody id="recruitOverviewTbody">';
recruitData.forEach(function(r,idx){h+=buildOverviewRow(r,idx)});
h+='</tbody></table></div>';
if(recruitData.length===0)h+='<div style="padding:30px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìã</div><div style="font-size:13px;font-weight:600">No applicants found</div></div>';
h+='</div>';rp.innerHTML=h}

function buildOverviewRow(r,idx){
var col=kanbanColors[r.stage||"CV Received"]||"var(--muted)";
var dateApplied=r.dateApplied||"";if(dateApplied){try{var d=new Date(dateApplied);if(!isNaN(d))dateApplied=d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
var lastEdited=r.lastEdited||"";if(lastEdited){try{var d2=new Date(lastEdited);if(!isNaN(d2))lastEdited=d2.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
var fullName=(r.firstName||"")+" "+(r.lastName||"");
var h='<tr data-oidx="'+idx+'" style="border-bottom:1px solid var(--border);transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
h+='<td style="padding:6px 4px;text-align:center"><input type="checkbox" class="recruit-check" data-oidx="'+idx+'"></td>';
h+='<td style="padding:6px"><a href="#" onclick="openRecruitContactModal('+idx+');return false" style="font-weight:700;color:var(--royal);text-decoration:none;font-size:12px">'+fullName.trim()+'</a></td>';
h+='<td style="padding:6px;font-size:11px;color:var(--muted);font-family:JetBrains Mono,monospace">'+(r.email||"")+'</td>';
h+='<td style="padding:6px;font-size:11px;white-space:nowrap">'+dateApplied+'</td>';
h+='<td style="padding:6px;font-size:11px;white-space:nowrap;color:var(--muted)">'+lastEdited+'</td>';
h+='<td style="padding:6px"><select onchange="updateRecruitStageOverview('+idx+',this.value)" '+(canEdit("recruit_overview")?"":"disabled")+' style="padding:3px 6px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid '+col+'30;background:'+col+'10;color:'+col+';font-family:inherit;cursor:'+(canEdit("recruit_overview")?"pointer":"default")+'">';
kanbanStages.forEach(function(st){h+='<option value="'+st+'"'+((r.stage||"CV Received")===st?" selected":"")+'>'+st+'</option>'});
h+='</select></td>';
h+='</tr>';return h}

function filterRecruitOverview(stageFilt){
var q=(document.getElementById("recruitOverviewSearch")||{}).value||"";q=q.toLowerCase();
var sf=stageFilt||((document.getElementById("recruitStageFilter")||{}).value)||"";
if(sf&&document.getElementById("recruitStageFilter"))document.getElementById("recruitStageFilter").value=sf;
var rows=document.querySelectorAll("#recruitOverviewTbody tr");
rows.forEach(function(row){
var idx=parseInt(row.getAttribute("data-oidx"));var r=recruitData[idx];if(!r){row.style.display="none";return}
var matchQ=!q||((r.firstName||"")+" "+(r.lastName||"")).toLowerCase().indexOf(q)>=0||(r.email||"").toLowerCase().indexOf(q)>=0;
var matchSt=!sf||(r.stage||"CV Received")===sf;
row.style.display=(matchQ&&matchSt)?"":"none"})}

function toggleAllRecruitChecks(checked){
document.querySelectorAll(".recruit-check").forEach(function(cb){cb.checked=checked})}

function applyBulkStage(){
var sel=document.getElementById("recruitBulkStage");if(!sel||!sel.value)return;
var newStage=sel.value;
var checks=document.querySelectorAll(".recruit-check:checked");
if(checks.length===0)return;
checks.forEach(function(cb){
var idx=parseInt(cb.getAttribute("data-oidx"));
var r=recruitData[idx];if(!r)return;
r.stage=newStage;
if(r.airtableId)apiCall("PATCH","/api/recruit/"+r.airtableId,{stage:newStage}).catch(function(){})});
sel.value="";
renderRecruitOverview(document.getElementById("rightPanel"))}

function updateRecruitStageOverview(idx,newStage){
var r=recruitData[idx];if(!r)return;r.stage=newStage;
if(r.airtableId)apiCall("PATCH","/api/recruit/"+r.airtableId,{stage:newStage}).catch(function(){})}

function openRecruitContactModal(idx){
var r=recruitData[idx];if(!r)return;
// Find matching contact
var match=contacts.find(function(c){
return(c.email&&r.email&&c.email.toLowerCase()===r.email.toLowerCase())||
(c.name&&(c.name===((r.firstName||"")+" "+(r.lastName||"")).trim()))||
(c.phone&&r.phone&&c.phone===r.phone)});
if(match){currentView="contacts";selectedConv=match;selectedConv._activeTab="details";render();return}
// Not found in contacts - show overlay
var overlay=document.createElement("div");overlay.id="recruitModalOverlay";
overlay.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
var h='<div style="background:var(--surface);border-radius:12px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3)">';
h+='<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center"><span style="font-size:15px;font-weight:700">üë§ '+(r.firstName||"")+" "+(r.lastName||"")+'</span><button onclick="document.getElementById(\'recruitModalOverlay\').remove()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">‚úï</button></div>';
h+='<div style="padding:20px">';
var fields=[{l:"Email",v:r.email},{l:"Phone",v:r.phone},{l:"Suburb",v:r.suburb},{l:"State",v:r.state},{l:"Applied For",v:r.appliedFor},{l:"Stage",v:r.stage},{l:"Date Applied",v:r.dateApplied}];
fields.forEach(function(f){if(f.v)h+='<div style="margin-bottom:10px"><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">'+f.l+'</div><div style="font-size:13px;font-weight:600;color:var(--text)">'+f.v+'</div></div>'});
h+='<div style="font-size:11px;color:var(--dim);margin-top:16px">This applicant is not yet in Contacts. They may need to be created via CV Upload or + Add Contact.</div>';
h+='</div></div>';
overlay.innerHTML=h;document.body.appendChild(overlay)}

function renderRecruitList(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div><div style="font-size:18px;font-weight:700;color:var(--text)">Applicant List</div><div style="font-size:11px;color:var(--muted)">'+recruitData.length+' applicants</div></div>';
h+='<div style="display:flex;gap:6px"><button class="btn btn-p btn-sm" style="padding:7px 14px" onclick="setRecruitView(\'cvupload\')">üìÑ CV Upload</button><button class="btn btn-s btn-sm" onclick="setRecruitView(\'overview\')">‚Üê Overview</button><button class="btn btn-teal btn-sm" onclick="setRecruitView(\'kanban\')">üìå Kanban</button></div></div>';
// Search
h+='<input id="recruitSearch" oninput="filterRecruitList()" placeholder="Search applicants..." style="width:100%;max-width:400px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);margin-bottom:12px;outline:none">';
// Table
h+='<div style="overflow-x:auto"><table id="recruitTable" style="width:100%;border-collapse:collapse;font-size:12px">';
h+='<thead><tr style="border-bottom:2px solid var(--border)">';
["First Name","Last Name","Email","Suburb","State","Applied for Role","Date Applied","CV","Stage","Last Edited"].forEach(function(col){
h+='<th style="padding:10px 8px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>'});
h+='</tr></thead><tbody id="recruitTbody">';
recruitData.forEach(function(r,idx){h+=buildRecruitRow(r,idx)});
h+='</tbody></table></div>';
if(recruitData.length===0)h+='<div style="padding:30px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìã</div><div style="font-size:13px;font-weight:600">No applicants found</div><div style="font-size:11px;margin-top:4px">Data loads from the Jobseekers table</div></div>';
h+='</div>';rp.innerHTML=h}

function buildRecruitRow(r,idx){
var col=kanbanColors[r.stage||"CV Received"]||"var(--muted)";
var dateApplied=r.dateApplied||"";if(dateApplied){try{var d=new Date(dateApplied);if(!isNaN(d))dateApplied=d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
var lastEdited=r.lastEdited||"";if(lastEdited){try{var d2=new Date(lastEdited);if(!isNaN(d2))lastEdited=d2.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
var h='<tr data-ridx="'+idx+'" style="border-bottom:1px solid var(--border);transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
h+='<td style="padding:8px"><a href="#" onclick="openRecruitContactModal('+idx+',true);return false" style="font-weight:700;color:var(--royal);text-decoration:none">'+(r.firstName||"")+'</a></td>';
h+='<td style="padding:8px"><a href="#" onclick="openRecruitContactModal('+idx+',true);return false" style="font-weight:700;color:var(--royal);text-decoration:none">'+(r.lastName||"")+'</a></td>';
h+='<td style="padding:8px;color:var(--muted);font-family:JetBrains Mono,monospace;font-size:11px">'+(r.email||"")+'</td>';
h+='<td style="padding:8px">'+(r.suburb||"")+'</td>';
h+='<td style="padding:8px">'+(r.state||"")+'</td>';
h+='<td style="padding:8px;font-weight:600;color:var(--royal)">'+(r.appliedFor||"")+'</td>';
h+='<td style="padding:8px;white-space:nowrap">'+dateApplied+'</td>';
h+='<td style="padding:8px">';
if(r.cvUrl)h+='<a href="'+r.cvUrl+'" target="_blank" style="color:var(--teal);font-size:11px;font-weight:600;text-decoration:none">üìé View</a>';
else h+='<span style="color:var(--dim);font-size:11px">‚Äî</span>';
h+='</td>';
h+='<td style="padding:8px"><select onchange="updateRecruitStage('+idx+',this.value)" '+(canEdit("recruit_list")?"":"disabled")+' style="padding:3px 6px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid '+col+'30;background:'+col+'10;color:'+col+';font-family:inherit;cursor:'+(canEdit("recruit_list")?"pointer":"default")+'">';
kanbanStages.forEach(function(st){h+='<option value="'+st+'"'+((r.stage||"CV Received")===st?" selected":"")+'>'+st+'</option>'});
h+='</select></td>';
h+='<td style="padding:8px;font-size:11px;color:var(--muted);white-space:nowrap">'+lastEdited+'</td>';
h+='</tr>';return h}

function filterRecruitList(){
var q=(document.getElementById("recruitSearch").value||"").toLowerCase();
var rows=document.querySelectorAll("#recruitTbody tr");
rows.forEach(function(row){
var txt=row.textContent.toLowerCase();
row.style.display=(!q||txt.indexOf(q)>=0)?"":"none"})}

function renderRecruitKanban(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div><div style="font-size:18px;font-weight:700;color:var(--text)">Recruitment Pipeline</div><div style="font-size:11px;color:var(--muted)">Drag and drop to update candidate stages</div></div>';
h+='<div style="display:flex;gap:6px">';if(canEdit("recruit_cvupload"))h+='<button class="btn btn-p btn-sm" style="padding:7px 14px" onclick="setRecruitView(\'cvupload\')">üìÑ CV Upload</button>';h+='<button class="btn btn-s btn-sm" onclick="setRecruitView(\'overview\')">‚Üê Overview</button><button class="btn btn-teal btn-sm" onclick="setRecruitView(\'list\')">üìã List</button></div></div>';
h+='<div class="kanban-wrap">';
kanbanStages.forEach(function(stage){
var col=kanbanColors[stage];
var stageItems=recruitData.filter(function(r){return(r.stage||"CV Received")===stage});
h+='<div class="kanban-col" data-stage="'+stage+'">';
h+='<div class="kanban-col-hdr" style="color:'+col+';border-top:3px solid '+col+'"><span>'+stage+'</span><span style="background:'+col+'15;color:'+col+';padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700">'+stageItems.length+'</span></div>';
h+='<div class="kanban-col-body" ondragover="kanbanDragOver(event)" ondragleave="kanbanDragLeave(event)" ondrop="kanbanDrop(event,\''+stage+'\')">';
stageItems.forEach(function(r){
var globalIdx=recruitData.indexOf(r);
h+='<div class="kanban-card" draggable="'+(canEdit("recruit_kanban")?"true":"false")+'" ondragstart="kanbanDragStart(event,'+globalIdx+')" data-ridx="'+globalIdx+'">';
h+='<a href="#" onclick="openRecruitContactModal('+globalIdx+',true);return false" style="display:block;font-size:12px;font-weight:700;color:var(--royal);margin-bottom:4px;text-decoration:none">'+(r.firstName||"")+" "+(r.lastName||"")+'</a>';
if(r.appliedFor)h+='<div style="font-size:10px;color:var(--royal);font-weight:600;margin-bottom:4px">'+r.appliedFor+'</div>';
if(r.email)h+='<div style="font-size:10px;color:var(--muted);font-family:JetBrains Mono,monospace;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+r.email+'</div>';
var dateApplied=r.dateApplied||"";if(dateApplied){try{var d=new Date(dateApplied);if(!isNaN(d))dateApplied=d.toLocaleDateString("en-AU",{day:"numeric",month:"short"})}catch(e){}}
if(dateApplied)h+='<div style="font-size:9px;color:var(--dim)">Applied: '+dateApplied+'</div>';
if(r.cvUrl)h+='<a href="'+r.cvUrl+'" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;color:var(--teal);text-decoration:none;font-weight:600;margin-top:4px;display:inline-block">üìé CV</a>';
h+='</div>'});
h+='</div></div>'});
h+='</div></div>';rp.innerHTML=h}

// ‚ïê‚ïê‚ïê KANBAN DRAG & DROP ‚ïê‚ïê‚ïê
var _dragIdx=null;
function kanbanDragStart(e,idx){if(!canEdit("recruit_kanban")){e.preventDefault();return}_dragIdx=idx;e.dataTransfer.effectAllowed="move";e.target.classList.add("dragging");setTimeout(function(){e.target.style.opacity=".4"},0)}
function kanbanDragOver(e){e.preventDefault();e.dataTransfer.dropEffect="move";e.currentTarget.classList.add("drag-over")}
function kanbanDragLeave(e){e.currentTarget.classList.remove("drag-over")}
function kanbanDrop(e,newStage){
e.preventDefault();e.currentTarget.classList.remove("drag-over");
if(_dragIdx===null||_dragIdx===undefined)return;
var r=recruitData[_dragIdx];if(!r)return;
var oldStage=r.stage||"CV Received";
if(oldStage===newStage){_dragIdx=null;return}
r.stage=newStage;
// Update in Airtable
if(r.airtableId){apiCall("PATCH","/api/recruit/"+r.airtableId,{stage:newStage}).catch(function(e){console.error("Failed to update stage:",e)})}
_dragIdx=null;
renderRecruitKanban(document.getElementById("rightPanel"))}

function updateRecruitStage(idx,newStage){
var r=recruitData[idx];if(!r)return;
r.stage=newStage;
if(r.airtableId){apiCall("PATCH","/api/recruit/"+r.airtableId,{stage:newStage}).catch(function(e){console.error("Failed to update stage:",e)})}
renderRecruitList(document.getElementById("rightPanel"))}

// ‚ïê‚ïê‚ïê CV UPLOAD & AI SCANNING ‚ïê‚ïê‚ïê
var cvFiles=[];
var cvScanned=[];

function renderCVUpload(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><div style="font-size:18px;font-weight:700;color:var(--text)">üìÑ CV Upload & Scan</div><div style="font-size:11px;color:var(--muted)">Upload CVs to auto-create Jobseeker contacts</div></div>';
h+='<button class="btn btn-s btn-sm" onclick="setRecruitView(\'overview\')">‚Üê Overview</button></div>';

// Drop zone
h+='<div class="cv-drop-zone" id="cvDropZone" onclick="document.getElementById(\'cvFileInput\').click()" ondragover="event.preventDefault();this.classList.add(\'drag-active\')" ondragleave="this.classList.remove(\'drag-active\')" ondrop="handleCVDrop(event)">';
h+='<input type="file" id="cvFileInput" accept=".pdf,.doc,.docx" multiple style="display:none" onchange="handleCVFiles(this.files)">';
h+='<div style="font-size:40px;margin-bottom:12px">üìé</div>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px">Drop CV files here or click to browse</div>';
h+='<div style="font-size:12px;color:var(--muted)">Accepts PDF and Word documents (.pdf, .doc, .docx) ‚Äî multiple files supported</div>';
h+='</div>';

// File list
h+='<div id="cvFileList" style="margin-top:16px"></div>';

// Scan button
h+='<div id="cvScanArea" style="margin-top:16px;display:none">';
h+='<button class="btn btn-p" id="cvScanBtn" style="width:auto;padding:10px 24px" onclick="scanAllCVs()">ü§ñ Scan CVs with AI</button>';
h+='<span style="font-size:11px;color:var(--muted);margin-left:10px" id="cvScanStatus"></span>';
h+='</div>';

// Results table
h+='<div id="cvResultsArea" style="margin-top:20px;display:none">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div><div style="font-size:16px;font-weight:700;color:var(--text)">Scanned Results</div><div style="font-size:11px;color:var(--muted)" id="cvResultsCount">Review extracted data before creating contacts</div></div>';
h+='<button class="btn btn-p" id="cvCreateBtn" style="width:auto;padding:10px 20px" onclick="createJobseekerContacts()">‚úÖ Create All as Jobseekers</button></div>';
h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
h+='<thead><tr style="border-bottom:2px solid var(--border)">';
["","First Name","Last Name","Email","Phone","Suburb","State","Applied for Role","Skills"].forEach(function(col){
h+='<th style="padding:8px 6px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>'});
h+='</tr></thead><tbody id="cvResultsTbody"></tbody></table></div></div>';

h+='</div>';rp.innerHTML=h;
// Re-render file list if files already loaded
if(cvFiles.length>0)renderCVFileList();
if(cvScanned.length>0)renderCVResults()}

function handleCVDrop(e){
e.preventDefault();e.currentTarget.classList.remove("drag-active");
var files=e.dataTransfer.files;
if(files&&files.length>0)handleCVFiles(files)}

function handleCVFiles(files){
for(var i=0;i<files.length;i++){
var f=files[i];
var ext=f.name.split(".").pop().toLowerCase();
if(ext!=="pdf"&&ext!=="doc"&&ext!=="docx"){continue}
// Check for duplicates
var isDupe=cvFiles.some(function(cf){return cf.name===f.name&&cf.size===f.size});
if(isDupe)continue;
cvFiles.push({file:f,name:f.name,size:f.size,ext:ext,status:"ready",text:"",parsed:null})}
renderCVFileList();
var scanArea=document.getElementById("cvScanArea");
if(scanArea&&cvFiles.length>0)scanArea.style.display="flex"}

function renderCVFileList(){
var el=document.getElementById("cvFileList");if(!el)return;
if(cvFiles.length===0){el.innerHTML="";return}
var h='<div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:8px">'+cvFiles.length+' file'+(cvFiles.length!==1?"s":"")+" queued</div>";
cvFiles.forEach(function(cf,idx){
var isPdf=cf.ext==="pdf";
var iconBg=isPdf?"rgba(239,68,68,.08)":"rgba(59,130,246,.08)";
var iconCol=isPdf?"var(--red)":"#3B82F6";
var icon=isPdf?"üìï":"üìò";
var statusHtml="";
if(cf.status==="ready")statusHtml='<span class="cv-file-status" style="background:var(--surface2);color:var(--muted)">Ready</span>';
else if(cf.status==="extracting")statusHtml='<span class="cv-file-status" style="background:rgba(10,147,150,.08);color:var(--teal)">Extracting text...</span>';
else if(cf.status==="scanning")statusHtml='<span class="cv-file-status" style="background:rgba(124,58,237,.08);color:#7C3AED">ü§ñ AI scanning...</span>';
else if(cf.status==="done")statusHtml='<span class="cv-file-status" style="background:rgba(16,185,129,.08);color:var(--green)">‚úÖ Scanned</span>';
else if(cf.status==="error")statusHtml='<span class="cv-file-status" style="background:rgba(239,68,68,.06);color:var(--red)">‚ùå Error</span>';
h+='<div class="cv-file-item">';
h+='<div class="cv-file-icon" style="background:'+iconBg+'">'+icon+'</div>';
h+='<div class="cv-file-info"><div class="cv-file-name">'+cf.name+'</div>';
h+='<div class="cv-file-size">'+(cf.size>1048576?(cf.size/1048576).toFixed(1)+" MB":(cf.size/1024).toFixed(0)+" KB")+" ‚Äî "+cf.ext.toUpperCase()+'</div>';
if(cf.status==="extracting"||cf.status==="scanning")h+='<div class="cv-progress"><div class="cv-progress-bar" style="width:'+(cf.status==="extracting"?"40%":"75%")+'"></div></div>';
h+='</div>';
h+=statusHtml;
h+='<button onclick="removeCVFile('+idx+')" style="background:none;border:none;cursor:pointer;font-size:16px;color:var(--dim);padding:4px 8px" title="Remove">‚úï</button>';
h+='</div>'});
el.innerHTML=h}

function removeCVFile(idx){
cvFiles.splice(idx,1);
renderCVFileList();
var scanArea=document.getElementById("cvScanArea");
if(scanArea)scanArea.style.display=cvFiles.length>0?"flex":"none"}

// ‚îÄ‚îÄ Extract text from PDF using pdf.js ‚îÄ‚îÄ
function extractPDFText(file){
return new Promise(function(resolve,reject){
var reader=new FileReader();
reader.onload=function(){
var typedArray=new Uint8Array(reader.result);
pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
pdfjsLib.getDocument(typedArray).promise.then(function(pdf){
var pages=[];
var total=pdf.numPages;
function getPage(n){
if(n>total){resolve(pages.join("\n\n"));return}
pdf.getPage(n).then(function(page){
page.getTextContent().then(function(tc){
var text=tc.items.map(function(i){return i.str}).join(" ");
pages.push(text);
getPage(n+1)})}).catch(function(){getPage(n+1)})}
getPage(1)}).catch(reject)};
reader.onerror=reject;
reader.readAsArrayBuffer(file)})}

// ‚îÄ‚îÄ Extract text from DOCX using mammoth ‚îÄ‚îÄ
function extractDOCXText(file){
return new Promise(function(resolve,reject){
var reader=new FileReader();
reader.onload=function(){
mammoth.extractRawText({arrayBuffer:reader.result}).then(function(result){resolve(result.value||"")}).catch(reject)};
reader.onerror=reject;
reader.readAsArrayBuffer(file)})}

// ‚îÄ‚îÄ Scan all CVs ‚îÄ‚îÄ
async function scanAllCVs(){
var btn=document.getElementById("cvScanBtn");
var status=document.getElementById("cvScanStatus");
if(btn){btn.disabled=true;btn.innerHTML="‚è≥ Scanning...";btn.style.opacity=".7"}
cvScanned=[];
var pending=cvFiles.filter(function(cf){return cf.status==="ready"||cf.status==="error"});
if(pending.length===0){if(status)status.textContent="No files to scan";if(btn){btn.disabled=false;btn.innerHTML="ü§ñ Scan CVs with AI";btn.style.opacity="1"}return}

for(var i=0;i<cvFiles.length;i++){
var cf=cvFiles[i];
if(cf.status==="done")continue;
if(status)status.textContent="Processing "+(i+1)+" of "+cvFiles.length+"...";

// Step 1: Extract text
cf.status="extracting";renderCVFileList();
try{
if(cf.ext==="pdf")cf.text=await extractPDFText(cf.file);
else if(cf.ext==="docx"||cf.ext==="doc")cf.text=await extractDOCXText(cf.file);
else cf.text="";}catch(e){cf.status="error";cf.text="";renderCVFileList();continue}

if(!cf.text||cf.text.trim().length<20){cf.status="error";renderCVFileList();continue}

// Step 2: AI scan
cf.status="scanning";renderCVFileList();
try{
var result=await apiCall("POST","/api/recruit/scan-cv",{text:cf.text.substring(0,8000),fileName:cf.name});
if(result&&result.parsed){cf.parsed=result.parsed;cf.status="done";cvScanned.push(result.parsed)}
else{cf.status="error"}}catch(e){cf.status="error"}
renderCVFileList()}

if(status)status.textContent="Done! "+cvScanned.length+" CV"+(cvScanned.length!==1?"s":"")+" scanned.";
if(btn){btn.disabled=false;btn.innerHTML="ü§ñ Scan CVs with AI";btn.style.opacity="1"}
if(cvScanned.length>0)renderCVResults()}

function renderCVResults(){
var area=document.getElementById("cvResultsArea");
var tbody=document.getElementById("cvResultsTbody");
var countEl=document.getElementById("cvResultsCount");
if(!area||!tbody)return;
area.style.display="block";
if(countEl)countEl.textContent=cvScanned.length+" applicant"+(cvScanned.length!==1?"s":"")+" extracted ‚Äî review and edit before creating";
var h="";
cvScanned.forEach(function(p,idx){
h+='<tr style="border-bottom:1px solid var(--border)">';
h+='<td style="padding:6px;text-align:center"><input type="checkbox" checked data-cvidx="'+idx+'" class="cv-check"></td>';
h+='<td style="padding:6px"><input value="'+(p.firstName||"")+'" onchange="cvScanned['+idx+'].firstName=this.value" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px"><input value="'+(p.lastName||"")+'" onchange="cvScanned['+idx+'].lastName=this.value" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px"><input value="'+(p.email||"")+'" onchange="cvScanned['+idx+'].email=this.value" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px"><input value="'+(p.phone||"")+'" onchange="cvScanned['+idx+'].phone=this.value" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px"><input value="'+(p.suburb||"")+'" onchange="cvScanned['+idx+'].suburb=this.value" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px"><input value="'+(p.state||"")+'" onchange="cvScanned['+idx+'].state=this.value" style="width:60px;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px"><input value="'+(p.appliedFor||"Disability Support Worker")+'" onchange="cvScanned['+idx+'].appliedFor=this.value" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;background:var(--surface)"></td>';
h+='<td style="padding:6px;font-size:10px;color:var(--muted);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+(p.skills||"")+'">'+(p.skills||"‚Äî")+'</td>';
h+='</tr>'});
tbody.innerHTML=h}

async function createJobseekerContacts(){
var btn=document.getElementById("cvCreateBtn");
if(btn){btn.disabled=true;btn.innerHTML="‚è≥ Creating...";btn.style.opacity=".7"}
var checks=document.querySelectorAll(".cv-check");
var selected=[];
checks.forEach(function(cb){if(cb.checked)selected.push(cvScanned[parseInt(cb.getAttribute("data-cvidx"))])});
if(selected.length===0){if(btn){btn.disabled=false;btn.innerHTML="‚úÖ Create All as Jobseekers";btn.style.opacity="1"}return}

var created=0;var errors=0;
for(var i=0;i<selected.length;i++){
var p=selected[i];
try{
await apiCall("POST","/api/contacts",{
firstName:p.firstName||"",
lastName:p.lastName||"",
email:p.email||"",
phone:p.phone||"",
homeAddress:p.address||"",
suburb:p.suburb||"",
state:p.state||"",
contactType:"Jobseeker",
statusOfContact:"CV Received",
appliedForRole:p.appliedFor||"Disability Support Worker",
notes:""
});
created++}catch(e){errors++}}

// Refresh contacts
apiCall("GET","/api/contacts").then(function(d){contacts=d||[];buildConversations();render()});apiCall("GET","/api/clients").then(function(d){clientsList=d||[];console.log("Clients loaded from Clients table:",clientsList.length)}).catch(function(){clientsList=[]});
window._recruitLoaded=false;

if(btn){btn.disabled=false;btn.style.opacity="1";
btn.innerHTML="‚úÖ Created "+created+" contact"+(created!==1?"s":"")+(errors>0?" ("+errors+" failed)":"")}

// Show success
var area=document.getElementById("cvResultsArea");
if(area){var msg=document.createElement("div");
msg.style.cssText="padding:12px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:var(--rs);margin-top:12px;font-size:12px;font-weight:600;color:var(--green)";
msg.textContent="‚úÖ Successfully created "+created+" Jobseeker contact"+(created!==1?"s":"")+" in All Contacts"+(errors>0?". "+errors+" failed.":".");
area.appendChild(msg)}

// Clear state
cvFiles=[];cvScanned=[];
setTimeout(function(){renderCVFileList();var scanArea=document.getElementById("cvScanArea");if(scanArea)scanArea.style.display="none"},2000)}

// ‚ïê‚ïê‚ïê LMS STATE ‚ïê‚ïê‚ïê
var lmsCourses=[];
var lmsLoaded=false;
var lmsCurrentCourse=null;
var lmsCurrentLesson=null;
var lmsCompletedLessons={};
var lmsEnrollments={};

// ‚ïê‚ïê‚ïê LMS ENTRY POINT ‚ïê‚ïê‚ïê
function renderLMS(rp){
  if(!lmsLoaded){
    lmsLoaded=true;
    rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading courses...</div></div></div>';
    apiCall("GET","/api/lms/courses").then(function(d){
      lmsCourses=d||[];
      var uid=window._currentUser&&window._currentUser.airtableId;
      if(uid){
        apiCall("GET","/api/lms/staff-enrollments?staffId="+uid).then(function(enr){
          (enr||[]).forEach(function(e){ lmsEnrollments[e.courseId]=e; });
          renderLMSContent(rp);
        }).catch(function(){ renderLMSContent(rp); });
      } else { renderLMSContent(rp); }
    }).catch(function(){ lmsCourses=[]; renderLMSContent(rp); });
    return;
  }
  if(lmsCurrentCourse){ lmsRenderCourseViewer(rp); return; }
  renderLMSContent(rp);
}

// ‚ïê‚ïê‚ïê MAIN CATALOG VIEW ‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECEIPTS REGISTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _receiptsData = [];
var _receiptsLoaded = false;
var _receiptsFilters = { search:'', category:'', currency:'', period:'' };

function renderReceipts() {
  var rp = document.getElementById('rightPanel');
  rp.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading receipts...</div></div></div>';
  apiCall('GET', '/api/receipts').then(function(d) {
    _receiptsData = d || [];
    _receiptsLoaded = true;
    renderReceiptsDashboard();
  }).catch(function(e) {
    rp.innerHTML = '<div style="padding:24px;color:var(--red)">' + e.message + '</div>';
  });
}

function renderReceiptsDashboard() {
  var rp = document.getElementById('rightPanel');
  var data = _receiptsData;
  var totalAUD = 0, totalUSD = 0, totalOther = 0;
  data.forEach(function(r) {
    var amt = parseFloat(String(r.totalAmount||'0').replace(/[^0-9.]/g,'')) || 0;
    if(r.currency==='AUD') totalAUD+=amt;
    else if(r.currency==='USD') totalUSD+=amt;
    else totalOther+=amt;
  });

  var CATEGORIES = ['Airfares','Attending Conference','Car Rental','Client Meeting','Consultation',
    'Marketing for business','New Business Meeting','New Business Workshop','Office Shopping',
    'SIL Maintenance & Lawns','SIL Mobile Bill','SIL Shopping','Software','Staff Uniforms','Website','Other'];

  // Get public form URL
  var baseUrl = window.location.origin;
  var formUrl = baseUrl + '/receipt-form';

  var h = '<div style="height:100%;overflow-y:auto;background:var(--bg)">';

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  h += '<div style="background:linear-gradient(135deg,#78350f,#d97706);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">';
  h += '<div><div style="font-size:20px;font-weight:700;color:#fff">\xf0\x9f\xa7\xbe Receipts Register</div>';
  h += '<div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:2px">All business receipts \xe2\x80\x94 ' + data.length + ' records</div></div>';
  h += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
  h += '<button onclick="openReceiptFormLink()" style="padding:7px 14px;background:rgba(255,255,255,.15);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">\xf0\x9f\x93\xb1 Mobile Form Link</button>';
  h += '<button onclick="openAddReceiptModal()" style="padding:7px 14px;background:#fff;color:#d97706;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">+ Add Receipt</button>';
  h += '<button onclick="renderReceipts()" style="padding:7px 14px;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:8px;font-size:12px;cursor:pointer;font-family:inherit">\xf0\x9f\x94\x84</button>';
  h += '</div></div>';

  // ‚îÄ‚îÄ Stat tiles ‚îÄ‚îÄ
  h += '<div style="display:flex;gap:10px;padding:16px 24px;flex-wrap:wrap;background:var(--surface);border-bottom:1px solid var(--border)">';
  var tiles = [
    {lbl:'Total Receipts', val: data.length, color:'#374151', bg:'#f3f4f6'},
    {lbl:'AUD Total', val:'$' + totalAUD.toFixed(2), color:'#059669', bg:'#ecfdf5'},
    {lbl:'USD Total', val:'$' + totalUSD.toFixed(2), color:'#2563eb', bg:'#eff6ff'},
    {lbl:'This Month', val: data.filter(function(r){ var d=new Date(r.purchaseDate); var n=new Date(); return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear(); }).length, color:'#d97706', bg:'#fffbeb'}
  ];
  tiles.forEach(function(t) {
    h += '<div style="padding:12px 16px;background:'+t.bg+';border-radius:10px;min-width:120px">';
    h += '<div style="font-size:18px;font-weight:700;color:'+t.color+'">'+t.val+'</div>';
    h += '<div style="font-size:10px;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-top:2px">'+t.lbl+'</div></div>';
  });
  h += '</div>';

  // ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
  var cats = [''].concat(CATEGORIES);
  var catOpts = cats.map(function(c){ return '<option value="'+c+'"'+(c===_receiptsFilters.category?' selected':'')+'>'+( c||'All Categories')+'</option>'; }).join('');
  var curOpts = ['','AUD','USD','NZD'].map(function(c){ return '<option value="'+c+'"'+(c===_receiptsFilters.currency?' selected':'')+'>'+( c||'All Currencies')+'</option>'; }).join('');
  var perOpts = [['','All Time'],['thisMonth','This Month'],['lastMonth','Last Month'],['thisYear','This Year']].map(function(p){ return '<option value="'+p[0]+'"'+( p[0]===_receiptsFilters.period?' selected':'')+'>'+p[1]+'</option>'; }).join('');

  h += '<div style="padding:12px 24px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;align-items:center">';
  h += '<input id="rcptSearch" type="text" placeholder="\xf0\x9f\x94\x8d Search supplier, purpose..." value="'+(_receiptsFilters.search||'')+'" oninput="_receiptsFilters.search=this.value;renderReceiptsTable()" style="padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;outline:none;font-family:inherit;min-width:220px;flex:1">';
  h += '<select onchange="_receiptsFilters.category=this.value;renderReceiptsTable()" style="padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;outline:none;font-family:inherit">'+catOpts+'</select>';
  h += '<select onchange="_receiptsFilters.currency=this.value;renderReceiptsTable()" style="padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;outline:none;font-family:inherit">'+curOpts+'</select>';
  h += '<select onchange="_receiptsFilters.period=this.value;renderReceiptsTable()" style="padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;outline:none;font-family:inherit">'+perOpts+'</select>';
  h += '<button onclick="_receiptsFilters={search:\'\',category:\'\',currency:\'\',period:\'\'};renderReceiptsDashboard()" style="padding:7px 12px;border:1px solid var(--border);border-radius:8px;font-size:11px;cursor:pointer;font-family:inherit;background:transparent">Clear</button>';
  h += '</div>';

  // ‚îÄ‚îÄ Table ‚îÄ‚îÄ
  h += '<div style="padding:16px 24px">';
  h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden">';
  h += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
  h += '<thead><tr style="background:var(--surface2);border-bottom:2px solid var(--border)">';
  ['Date','Supplier','Category','Staff','Amount','GST','Currency','Receipt','Comments','Reimburse?'].forEach(function(col) {
    h += '<th style="padding:10px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>';
  });
  h += '</tr></thead><tbody id="rcptTbody"></tbody></table></div></div></div></div>';

  rp.innerHTML = h;
  renderReceiptsTable();
}

function renderReceiptsTable() {
  var tbody = document.getElementById('rcptTbody');
  if(!tbody) return;
  var f = _receiptsFilters;
  var now = new Date();
  var data = _receiptsData.filter(function(r) {
    if(f.search) { var q=f.search.toLowerCase(); if((r.supplierName||'').toLowerCase().indexOf(q)<0 && String(r.purpose||'').toLowerCase().indexOf(q)<0 && (r.staffName||'').toLowerCase().indexOf(q)<0 && (r.comments||'').toLowerCase().indexOf(q)<0) return false; }
    if(f.category && String(r.purpose||'').indexOf(f.category)<0) return false;
    if(f.currency && r.currency!==f.currency) return false;
    if(f.period) {
      var d = r.purchaseDate ? new Date(r.purchaseDate) : null;
      if(!d) return false;
      if(f.period==='thisMonth' && (d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear())) return false;
      if(f.period==='lastMonth') { var lm=new Date(now.getFullYear(),now.getMonth()-1,1); if(d.getMonth()!==lm.getMonth()||d.getFullYear()!==lm.getFullYear()) return false; }
      if(f.period==='thisYear' && d.getFullYear()!==now.getFullYear()) return false;
    }
    return true;
  });

  if(!data.length) { tbody.innerHTML='<tr><td colspan="10" style="padding:32px;text-align:center;color:var(--muted);font-size:13px">No receipts found</td></tr>'; return; }

  var PUR_COLORS = {'Software':'#6366f1','Airfares':'#0891b2','Client Meeting':'#059669','SIL Shopping':'#d97706','Office Shopping':'#7c3aed','Marketing for business':'#db2777'};

  var rows = '';
  data.forEach(function(r) {
    var purTags = (Array.isArray(r.purpose)?r.purpose:(String(r.purpose||'')).split(',')).map(function(p){ p=p.trim(); if(!p) return ''; var col=PUR_COLORS[p]||'#6b7280'; return '<span style="font-size:10px;padding:2px 7px;border-radius:8px;background:'+col+'12;color:'+col+';border:1px solid '+col+'22;margin-right:2px;white-space:nowrap">'+p+'</span>'; }).join('');
    var dateStr = r.purchaseDateFormatted || (r.purchaseDate ? new Date(r.purchaseDate).toLocaleDateString('en-AU',{day:'2-digit',month:'2-digit',year:'2-digit'}) : '‚Äî');
    var amt = r.totalAmount != null ? String(r.totalAmount) : '‚Äî';
    var gst = r.gstAmount != null ? String(r.gstAmount) : '‚Äî';
    var hasReceipt = r.receiptUrl ? '<a href="'+r.receiptUrl+'" target="_blank" style="color:var(--teal);font-size:11px;text-decoration:none">\xf0\x9f\x93\x84 View</a>' : '<span style="color:var(--muted)">‚Äî</span>';
    rows += '<tr onclick="openReceiptDetail(\''+r.id+'\')" style="border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
    rows += '<td style="padding:10px 12px;font-size:11px;color:var(--muted);white-space:nowrap">'+dateStr+'</td>';
    rows += '<td style="padding:10px 12px;font-weight:600;color:var(--text);white-space:nowrap">'+( r.supplierName||'‚Äî')+'</td>';
    rows += '<td style="padding:10px 12px">'+purTags+'</td>';
    rows += '<td style="padding:10px 12px;font-size:11px;color:var(--text2);white-space:nowrap">'+( r.staffName||'‚Äî')+'</td>';
    rows += '<td style="padding:10px 12px;font-weight:700;color:'+(parseFloat((amt||'').replace(/[^0-9.]/g,''))>500?'#dc2626':'var(--text)')+'">'+amt+'</td>';
    rows += '<td style="padding:10px 12px;font-size:11px;color:var(--muted)">'+gst+'</td>';
    rows += '<td style="padding:10px 12px;font-size:11px"><span style="padding:2px 7px;border-radius:6px;background:'+(r.currency==='AUD'?'rgba(5,150,105,.1)':r.currency==='USD'?'rgba(37,99,235,.1)':'#f3f4f6')+';color:'+(r.currency==='AUD'?'#059669':r.currency==='USD'?'#2563eb':'#374151')+'">'+( r.currency||'‚Äî')+'</span></td>';
    rows += '<td style="padding:10px 12px">'+hasReceipt+'</td>';
    rows += '<td style="padding:10px 12px;font-size:11px;color:var(--muted);max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+( r.comments||'‚Äî')+'</td>';
    var isYes = (r.reimbursement||'').toUpperCase()==='YES';
    rows += '<td style="padding:10px 12px;text-align:center" onclick="event.stopPropagation();toggleReceiptReimbursement(\'' + r.id + '\',\'' + (isYes?'YES':'NO') + '\')"><span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:12px;font-size:11px;font-weight:700;cursor:pointer;user-select:none;border:1.5px solid '+(isYes?'#059669':'#d1d5db')+';background:'+(isYes?'rgba(5,150,105,.1)':'rgba(0,0,0,.03)')+';color:'+(isYes?'#059669':'#9ca3af')+'">'+( isYes?'\u2713 YES':'\u2717 NO')+'</span></td>';
    rows += '</tr>';
  });
  tbody.innerHTML = rows;
}

// ‚îÄ‚îÄ Receipt detail modal ‚îÄ‚îÄ
window.openReceiptDetail = function(id) {
  var r = _receiptsData.find(function(x){ return x.id===id; });
  if(!r) return;
  var existing = document.getElementById('rcptDetailOverlay'); if(existing) existing.remove();
  var overlay = document.createElement('div');
  overlay.id = 'rcptDetailOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };

  var h = '<div style="background:var(--surface);border-radius:14px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.3)">';
  h += '<div style="background:linear-gradient(135deg,#78350f,#d97706);padding:16px 20px;border-radius:14px 14px 0 0;display:flex;align-items:flex-start;justify-content:space-between;position:sticky;top:0;z-index:2">';
  h += '<div><div style="font-size:15px;font-weight:700;color:#fff">'+(r.supplierName||'Receipt')+'</div>';
  h += '<div style="font-size:11px;color:rgba(255,255,255,.6);margin-top:3px">'+(r.purchaseDateFormatted||r.purchaseDate||'')+'</div></div>';
  h += '<button onclick="document.getElementById(\'rcptDetailOverlay\').remove()" style="background:rgba(255,255,255,.15);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px">&#10005;</button></div>';
  h += '<div style="padding:20px;display:flex;flex-direction:column;gap:14px">';

  // Amount highlight
  h += '<div style="background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1px solid #fde68a;border-radius:10px;padding:16px;display:flex;justify-content:space-between;align-items:center">';
  h += '<div><div style="font-size:11px;font-weight:700;color:#92400e;text-transform:uppercase;letter-spacing:.05em">Total Amount</div>';
  h += '<div style="font-size:28px;font-weight:800;color:#78350f">'+(r.totalAmount||'$0.00')+'</div>';
  h += '<div style="font-size:11px;color:#b45309">GST: '+(r.gstAmount||'$0.00')+' \xb7 Currency: '+(r.currency||'AUD')+'</div></div>';
  if(r.receiptUrl) h += '<a href="'+r.receiptUrl+'" target="_blank" style="padding:10px 16px;background:#d97706;color:#fff;text-decoration:none;border-radius:8px;font-size:12px;font-weight:700">\xf0\x9f\x93\x84 View Receipt</a>';
  h += '</div>';

  // Info grid
  function rcCell(lbl, val) { if(!val) return ''; return '<div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:3px">'+lbl+'</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+val+'</div></div>'; }
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  h += rcCell('Purchase Date', r.purchaseDateFormatted||r.purchaseDate);
  h += rcCell('Supplier', r.supplierName);
  h += rcCell('Staff Member', r.staffName);
  h += rcCell('Job Title', r.jobTitle);
  h += '</div>';

  // Purpose tags
  if(r.purpose) {
    h += '<div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Purpose of Purchase</div>';
    h += '<div style="display:flex;flex-wrap:wrap;gap:6px">';
    (Array.isArray(r.purpose)?r.purpose:String(r.purpose||'').split(',')).forEach(function(p){ p=p.trim(); if(p) h += '<span style="font-size:11px;padding:4px 10px;border-radius:8px;background:#fef3c7;color:#78350f;border:1px solid #fde68a">'+p+'</span>'; });
    h += '</div></div>';
  }

  if(r.aiSummary) {
    h += '<div style="background:rgba(99,102,241,.04);border:1px solid rgba(99,102,241,.15);border-radius:8px;padding:12px">';
    h += '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#6366f1;margin-bottom:6px">\xf0\x9f\xa4\x96 AI Summary</div>';
    h += '<div style="font-size:12px;color:var(--text);line-height:1.6">'+r.aiSummary+'</div></div>';
  }
  if(r.comments) {
    h += '<div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:4px">Comments</div>';
    h += '<div style="font-size:12px;color:var(--text)">'+r.comments+'</div></div>';
  }
  h += '</div></div>';
  overlay.innerHTML = h;
  document.body.appendChild(overlay);
};

// ‚îÄ‚îÄ Mobile form link modal ‚îÄ‚îÄ
window.openReceiptFormLink = function() {
  var existing = document.getElementById('rcptLinkOverlay'); if(existing) existing.remove();
  var overlay = document.createElement('div');
  overlay.id = 'rcptLinkOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };
  var formUrl = window.location.origin + '/receipt-form';
  var h = '<div style="background:var(--surface);border-radius:14px;max-width:440px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,.3)">';
  h += '<div style="background:linear-gradient(135deg,#78350f,#d97706);padding:16px 20px;border-radius:14px 14px 0 0;display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-size:15px;font-weight:700;color:#fff">\xf0\x9f\x93\xb1 Mobile Receipt Form</div>';
  h += '<button onclick="document.getElementById(\'rcptLinkOverlay\').remove()" style="background:rgba(255,255,255,.15);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px">&#10005;</button></div>';
  h += '<div style="padding:20px;text-align:center">';
  h += '<div style="background:#f9fafb;border:2px dashed var(--border);border-radius:10px;padding:16px;margin-bottom:14px">';
  h += '<div style="font-size:11px;color:var(--muted);margin-bottom:8px">Save this link to your phone home screen:</div>';
  h += '<div style="font-size:13px;font-weight:700;color:var(--teal);word-break:break-all">'+formUrl+'</div></div>';
  h += '<div style="display:flex;gap:8px;justify-content:center">';
  h += '<button onclick="navigator.clipboard.writeText(\''+formUrl+'\').then(function(){var b=document.getElementById(\'rcptCopyBtn\');b.textContent=\'\u2705 Copied!\';setTimeout(function(){b.textContent=\'\xf0\x9f\x93\x8b Copy Link\';},2000)})" id="rcptCopyBtn" style="padding:10px 20px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">\xf0\x9f\x93\x8b Copy Link</button>';
  h += '<a href="'+formUrl+'" target="_blank" style="padding:10px 20px;background:#f3f4f6;color:var(--text);border-radius:8px;font-size:13px;font-weight:600;text-decoration:none;display:inline-block">\xf0\x9f\x94\x97 Open Form</a>';
  h += '</div>';
  h += '<div style="margin-top:14px;font-size:11px;color:var(--muted)">Tip: On iPhone, tap Share \xe2\x86\x92 Add to Home Screen for instant access</div>';
  h += '</div></div>';
  overlay.innerHTML = h;
  document.body.appendChild(overlay);
};

// ‚îÄ‚îÄ Add Receipt modal (manual entry) ‚îÄ‚îÄ
window.openAddReceiptModal = function(prefill) {
  prefill = prefill || {};
  var existing = document.getElementById('addRcptOverlay'); if(existing) existing.remove();
  var overlay = document.createElement('div');
  overlay.id = 'addRcptOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };

  var CATS = ['Airfares','Attending Conference','Car Rental','Client Meeting','Consultation',
    'Marketing for business','New Business Meeting','New Business Workshop','Office Shopping',
    'SIL Maintenance & Lawns','SIL Mobile Bill','SIL Shopping','Software','Staff Uniforms','Website','Other'];
  var catCbs = CATS.map(function(c){
    var checked = (prefill.purpose||'').indexOf(c)>=0;
    return '<label style="display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;padding:3px 0"><input type="checkbox" value="'+c+'"'+(checked?' checked':'')+' class="rcpt-cat-cb"> '+c+'</label>';
  }).join('');

  var inp = 'width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface);box-sizing:border-box';
  var lbl = 'font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:5px;display:block';

  var h = '<div style="background:var(--surface);border-radius:14px;max-width:600px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.3)">';
  h += '<div style="background:linear-gradient(135deg,#78350f,#d97706);padding:16px 20px;border-radius:14px 14px 0 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:2">';
  h += '<div style="font-size:15px;font-weight:700;color:#fff">\xf0\x9f\xa7\xbe Add Receipt</div>';
  h += '<button onclick="document.getElementById(\'addRcptOverlay\').remove()" style="background:rgba(255,255,255,.15);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px">&#10005;</button></div>';
  h += '<div style="padding:20px;display:flex;flex-direction:column;gap:14px">';

  // AI Scan section
  h += '<div style="background:linear-gradient(135deg,rgba(99,102,241,.05),rgba(124,58,237,.05));border:1.5px solid rgba(99,102,241,.2);border-radius:10px;padding:14px">';
  h += '<div style="font-size:12px;font-weight:700;color:#6366f1;margin-bottom:8px">\xf0\x9f\xa4\x96 AI Receipt Scanner</div>';
  h += '<div style="font-size:11px;color:var(--muted);margin-bottom:10px">Take a photo or upload a receipt image and AI will automatically fill the form fields below</div>';
  h += '<label style="display:flex;align-items:center;gap:8px;padding:10px 14px;border:1.5px dashed rgba(99,102,241,.3);border-radius:8px;cursor:pointer;font-size:12px;color:#6366f1;background:rgba(99,102,241,.03)">';
  h += '\xf0\x9f\x93\xb7 Take Photo / Upload Receipt';
  h += '<input type="file" accept="image/*,.pdf,.doc,.docx" style="display:none" id="rcptScanInput" onchange="scanReceiptImage(this)">';
  h += '</label>';
  h += '<div id="rcptScanStatus" style="margin-top:8px;font-size:11px;color:var(--muted)"></div>';
  h += '</div>';

  // Form fields
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  h += '<div><label style="'+lbl+'">Supplier Name *</label><input id="rcptSupplier" type="text" value="'+(prefill.supplierName||'')+'" style="'+inp+'"></div>';
  h += '<div><label style="'+lbl+'">Purchase Date *</label><input id="rcptDate" type="date" value="'+(prefill.purchaseDate||'')+'" style="'+inp+'"></div>';
  h += '</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">';
  h += '<div><label style="'+lbl+'">Total Amount *</label><input id="rcptAmount" type="text" placeholder="$0.00" value="'+(prefill.totalAmount||'')+'" style="'+inp+'"></div>';
  h += '<div><label style="'+lbl+'">GST Amount</label><input id="rcptGST" type="text" placeholder="$0.00" value="'+(prefill.gstAmount||'')+'" style="'+inp+'"></div>';
  h += '<div><label style="'+lbl+'">Currency</label><select id="rcptCurrency" style="'+inp+'"><option value="AUD"'+(prefill.currency==='AUD'?' selected':'')+'>AUD</option><option value="USD"'+(prefill.currency==='USD'?' selected':'')+'>USD</option><option value="NZD"'+(prefill.currency==='NZD'?' selected':'')+'>NZD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select></div>';
  h += '</div>';

  // Categories
  h += '<div><label style="'+lbl+'">Purpose of Purchase</label>';
  h += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:10px;border:1.5px solid var(--border);border-radius:8px;background:var(--surface2)">'+catCbs+'</div></div>';

  // Staff
  var staffOpts = '<option value="">Select staff member...</option>';
  (contacts||[]).forEach(function(c){
    var ct=(c.contactType||'').toLowerCase();
    if(ct.indexOf('employee')>=0||ct.indexOf('contractor')>=0)
      staffOpts+='<option value="'+c.email+'"'+(c.email===(prefill.staffEmail||'')?' selected':'')+'>'+c.name+'</option>';
  });
  h += '<div><label style="'+lbl+'">Staff Member</label><select id="rcptStaff" style="'+inp+'">'+staffOpts+'</select></div>';

  // Comments
  h += '<div><label style="'+lbl+'">Comments</label><textarea id="rcptComments" style="'+inp+';resize:vertical;min-height:60px">'+(prefill.comments||'')+'</textarea></div>';

  // Reimbursement toggle
  h += '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:8px">';
  h += '<div><label style="'+lbl+';margin-bottom:0">Reimbursement Required?</label><div style="font-size:11px;color:var(--muted);margin-top:2px">Does this receipt need to be reimbursed to staff?</div></div>';
  h += '<label style="display:flex;align-items:center;gap:10px;cursor:pointer">';
  h += '<span id="rcptReimburseLabel" style="font-size:12px;font-weight:700;color:#9ca3af">NO</span>';
  h += '<div onclick="toggleRcptReimburse()" id="rcptReimburseToggle" style="width:44px;height:24px;border-radius:12px;background:#d1d5db;position:relative;cursor:pointer;transition:background .2s">';
  h += '<div id="rcptReimburseKnob" style="position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.2);transition:left .2s"></div>';
  h += '</div></label></div>';
  h += '<input type="hidden" id="rcptReimburse" value="NO">';

  // File upload
  h += '<div><label style="'+lbl+'">Receipt Upload</label>';
  h += '<label style="display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px dashed var(--border);border-radius:8px;cursor:pointer;font-size:11px;color:var(--muted);background:var(--surface)">';
  h += '\xf0\x9f\x93\x84 Attach receipt file';
  h += '<input type="file" id="rcptFileInput" accept="image/*,.pdf" style="display:none" onchange="document.getElementById(\'rcptFileName\').textContent=this.files[0]?this.files[0].name:\'\'"></label>';
  h += '<div id="rcptFileName" style="font-size:11px;color:var(--teal);margin-top:4px"></div></div>';

  // Buttons
  h += '<div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px;border-top:1px solid var(--border)">';
  h += '<button onclick="document.getElementById(\'addRcptOverlay\').remove()" style="padding:9px 20px;border:1px solid var(--border);background:transparent;border-radius:8px;font-size:12px;cursor:pointer;font-family:inherit">Cancel</button>';
  h += '<button onclick="submitReceipt()" id="rcptSubmitBtn" style="padding:9px 24px;background:#d97706;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">\xf0\x9f\x92\xbe Save Receipt</button>';
  h += '</div><div id="rcptMsg" style="font-size:12px;text-align:center"></div>';
  h += '</div></div>';
  overlay.innerHTML = h;
  document.body.appendChild(overlay);
};

// ‚îÄ‚îÄ Toggle reimbursement inline in table ‚îÄ‚îÄ
window.toggleReceiptReimbursement = function(id, currentVal) {
  var newVal = currentVal === 'YES' ? 'NO' : 'YES';
  var rec = _receiptsData.find(function(x){ return x.id === id; });
  if(rec) rec.reimbursement = newVal;
  renderReceiptsTable();
  apiCall('PATCH', '/api/receipts/' + id, { reimbursement: newVal }).catch(function(e) {
    console.warn('Reimbursement update failed:', e.message);
    // Revert on failure
    if(rec) rec.reimbursement = currentVal;
    renderReceiptsTable();
  });
};

// ‚îÄ‚îÄ Reimbursement toggle in modal ‚îÄ‚îÄ
window.toggleRcptReimburse = function() {
  var inp = document.getElementById('rcptReimburse');
  var toggle = document.getElementById('rcptReimburseToggle');
  var knob = document.getElementById('rcptReimburseKnob');
  var lbl = document.getElementById('rcptReimburseLabel');
  if(!inp) return;
  var isYes = inp.value === 'YES';
  if(isYes) {
    inp.value = 'NO';
    toggle.style.background = '#d1d5db';
    knob.style.left = '2px';
    lbl.style.color = '#9ca3af'; lbl.textContent = 'NO';
  } else {
    inp.value = 'YES';
    toggle.style.background = '#059669';
    knob.style.left = '22px';
    lbl.style.color = '#059669'; lbl.textContent = 'YES';
  }
};

// ‚îÄ‚îÄ AI receipt image scanner ‚îÄ‚îÄ
window.scanReceiptImage = function(input) {
  if(!input||!input.files||!input.files[0]||input.files[0].size===0) return;
  var file = input.files[0];
  var ext = file.name.split('.').pop().toLowerCase();
  var mime = file.type || '';
  var isPDF = mime==='application/pdf'||ext==='pdf';
  var isWord = ext==='docx'||ext==='doc'||mime.indexOf('wordprocessingml')>=0||mime==='application/msword';
  var isImage = mime.indexOf('image')===0;

  var status = document.getElementById('rcptScanStatus');
  if(status) status.innerHTML = '<span style="color:#6366f1">\u23f3 Scanning with AI...</span>';

  // Show image preview
  if(isImage) {
    var prev = document.getElementById('rcptPreview');
    if(!prev) {
      prev = document.createElement('div');
      prev.id = 'rcptPreview';
      prev.style.marginTop = '8px';
      if(status && status.parentNode) status.parentNode.insertBefore(prev, status);
    }
    var objUrl = URL.createObjectURL(file);
    prev.innerHTML = '<img src="'+objUrl+'" style="max-width:100%;max-height:120px;border-radius:6px;border:1px solid var(--border);object-fit:contain">';
  }

  var reader = new FileReader();
  reader.onload = function(e) {
    var dataUrl = e.target.result;
    var base64 = dataUrl.split(',')[1] || dataUrl;
    var mimeType = isPDF ? 'application/pdf'
                 : isWord ? (ext==='docx' ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' : 'application/msword')
                 : (mime || 'image/jpeg');

    function doScan(b64) {
      window._rcptScannedFile = { base64: b64, mimeType: mimeType, name: file.name };
      apiCall('POST', '/api/receipts/scan', { base64: b64, mimeType: mimeType, filename: file.name }).then(function(d) {
        if(d && d.supplierName) {
          if(document.getElementById('rcptSupplier')) document.getElementById('rcptSupplier').value = d.supplierName||'';
          if(document.getElementById('rcptDate') && d.purchaseDate) document.getElementById('rcptDate').value = d.purchaseDate;
          if(document.getElementById('rcptAmount')) document.getElementById('rcptAmount').value = d.totalAmount ? String(d.totalAmount).replace(/[^0-9.]/g,'') : '';
          if(document.getElementById('rcptGST')) document.getElementById('rcptGST').value = d.gstAmount ? String(d.gstAmount).replace(/[^0-9.]/g,'') : '';
          if(document.getElementById('rcptCurrency') && d.currency) document.getElementById('rcptCurrency').value = d.currency;
          if(document.getElementById('rcptComments') && d.description) document.getElementById('rcptComments').value = d.description;
          if(d.categories && d.categories.length) {
            document.querySelectorAll('.rcpt-cat-cb').forEach(function(cb){ cb.checked = d.categories.indexOf(cb.value)>=0; });
          }
          if(status) status.innerHTML = '<span style="color:#059669">\u2705 AI scanned! Review fields below.</span>';
        } else if(d && d.error) {
          if(status) status.innerHTML = '<span style="color:#d97706">\u26a0\ufe0f '+d.error+'</span>';
        } else {
          if(status) status.innerHTML = '<span style="color:#d97706">\u26a0\ufe0f Could not extract fields automatically \u2014 please fill in below.</span>';
        }
      }).catch(function(e) {
        if(status) status.innerHTML = '<span style="color:var(--red)">\u274c Scan error: '+e.message+'</span>';
      });
    }

    // Resize images before sending to keep payload small
    if(isImage) {
      var img = new Image();
      img.onload = function() {
        var MAX=1400, w=img.naturalWidth, h=img.naturalHeight;
        if(w>MAX||h>MAX){ if(w>h){h=Math.round(h*MAX/w);w=MAX;}else{w=Math.round(w*MAX/h);h=MAX;} }
        var canvas=document.createElement('canvas');
        canvas.width=w; canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        doScan(canvas.toDataURL('image/jpeg',0.82).split(',')[1]);
      };
      img.onerror = function(){ doScan(base64); };
      img.src = dataUrl;
    } else {
      doScan(base64);
    }
  };
  reader.onerror = function() {
    if(status) status.innerHTML = '<span style="color:var(--red)">\u274c Could not read file.</span>';
  };
  reader.readAsDataURL(file);
};

// ‚îÄ‚îÄ Submit receipt ‚îÄ‚îÄ
window.submitReceipt = function() {
  var supplier = (document.getElementById('rcptSupplier')||{}).value||'';
  var date = (document.getElementById('rcptDate')||{}).value||'';
  var amount = (document.getElementById('rcptAmount')||{}).value||'';
  if(!supplier.trim()||!amount.trim()) {
    var m=document.getElementById('rcptMsg'); if(m) m.innerHTML='<span style="color:var(--red)">Supplier name and amount are required</span>'; return;
  }
  var btn=document.getElementById('rcptSubmitBtn');
  if(btn){btn.disabled=true;btn.textContent='\u23f3 Saving...';}

  var cats = [];
  document.querySelectorAll('.rcpt-cat-cb:checked').forEach(function(cb){ cats.push(cb.value); });
  var staffSel = document.getElementById('rcptStaff');
  var staffEmail = staffSel ? staffSel.value : '';

  var fileInput = document.getElementById('rcptFileInput');
  var fileData = null;
  if(window._rcptScannedFile) { fileData = window._rcptScannedFile; }
  else if(fileInput && fileInput.files && fileInput.files[0]) {
    // Need to read this file too - handle async
    var reader = new FileReader();
    reader.onload = function(e) {
      window._rcptScannedFile = { base64: e.target.result.split(',')[1], mimeType: fileInput.files[0].type, name: fileInput.files[0].name };
      doSubmitReceipt(supplier, date, amount, cats, staffEmail);
    };
    reader.readAsDataURL(fileInput.files[0]);
    return;
  }
  doSubmitReceipt(supplier, date, amount, cats, staffEmail);
};

function doSubmitReceipt(supplier, date, amount, cats, staffEmail) {
  var btn=document.getElementById('rcptSubmitBtn');
  var payload = {
    supplierName: supplier,
    purchaseDate: date,
    totalAmount: (document.getElementById('rcptAmount')||{}).value||amount,
    gstAmount: (document.getElementById('rcptGST')||{}).value||'',
    currency: (document.getElementById('rcptCurrency')||{}).value||'AUD',
    purpose: cats.join(','),
    staffEmail: staffEmail,
    comments: (document.getElementById('rcptComments')||{}).value||'',
    reimbursement: (document.getElementById('rcptReimburse')||{}).value||'NO',
    fileData: window._rcptScannedFile||null
  };
  window._rcptScannedFile = null;

  apiCall('POST', '/api/receipts', payload).then(function(d) {
    if(d && d.id) {
      _receiptsData.unshift({ id:d.id, supplierName:payload.supplierName, purchaseDate:payload.purchaseDate,
        totalAmount:payload.totalAmount, gstAmount:payload.gstAmount, currency:payload.currency,
        purpose:payload.purpose, staffName:staffEmail, comments:payload.comments, receiptUrl:d.fileUrl||'',
        reimbursement:payload.reimbursement||'NO' });
      var ov = document.getElementById('addRcptOverlay'); if(ov) ov.remove();
      renderReceiptsDashboard();
      // Success toast
      var toast=document.createElement('div');
      toast.style.cssText='position:fixed;top:20px;right:20px;background:#d97706;color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:700;z-index:99999;box-shadow:0 4px 16px rgba(0,0,0,.2)';
      toast.textContent='\u2705 Receipt saved!';
      document.body.appendChild(toast);
      setTimeout(function(){toast.remove();},3000);
    } else {
      var m=document.getElementById('rcptMsg'); if(m) m.innerHTML='<span style="color:var(--red)">\u274c '+(d&&d.error?d.error:'Failed')+'</span>';
      var b=document.getElementById('rcptSubmitBtn'); if(b){b.disabled=false;b.textContent='\xf0\x9f\x92\xbe Save Receipt';}
    }
  }).catch(function(e) {
    var m=document.getElementById('rcptMsg'); if(m) m.innerHTML='<span style="color:var(--red)">\u274c '+e.message+'</span>';
    var b=document.getElementById('rcptSubmitBtn'); if(b){b.disabled=false;b.textContent='\xf0\x9f\x92\xbe Save Receipt';}
  });
}


function renderLMSContent(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px"><div><div style="font-size:18px;font-weight:700;color:var(--text)">\u{1F393} Learning Management System</div><div style="font-size:11px;color:var(--muted)">'+lmsCourses.filter(function(c){return(c.status||'').toLowerCase()==='active'}).length+' courses available \u2014 enroll candidates into training</div></div>';
h+='<button class="btn btn-s btn-sm" onclick="setRecruitView(\'overview\')">\u2190 Overview</button></div>';
h+='<div style="padding:16px;background:rgba(10,147,150,.04);border:1px solid var(--tealBorder);border-radius:var(--r);margin-bottom:20px">';
h+='<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px">\u{1F4CB} Enroll Candidate</div>';
h+='<div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:end">';
h+='<div><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:4px">Select Candidate</label><select id="lmsCandidate" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);cursor:pointer"><option value="">Choose a candidate...</option>';
contacts.forEach(function(c){
var ct=(c.contactType||'').toLowerCase();
if(ct.indexOf('jobseeker')>=0||ct.indexOf('employee')>=0||ct.indexOf('contractor')>=0){
h+='<option value="'+(c.id||c.airtable_id||'')+'">'+(c.name||'Unnamed')+' \u2014 '+(c.contactType||'')+'</option>'}});
h+='</select></div>';
h+='<div><label style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:4px">Select Course(s)</label><select id="lmsCourseSelect" multiple size="3" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-family:inherit;background:var(--surface);cursor:pointer">';
lmsCourses.forEach(function(c,i){if(c.name&&c.name!=='Name')h+='<option value="'+i+'">'+(c.name||'Course '+(i+1))+'</option>'});
h+='</select></div>';
h+='<button class="btn btn-p" style="width:auto;padding:10px 16px;white-space:nowrap" onclick="enrollCandidate()">Enroll \u2192</button>';
h+='</div><div id="lmsEnrollMsg" style="margin-top:8px;font-size:11px"></div></div>';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px">Course Catalog</div>';
if(lmsCourses.length===0){
h+='<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">No courses found.</div>';
}else{
h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
h+='<thead><tr style="border-bottom:2px solid var(--border)">';
['#','Course Name','Category','Description','Frequency','Status','Duration'].forEach(function(col){
h+='<th style="padding:8px 6px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>'});
h+='</tr></thead><tbody>';
var realCourses=lmsCourses.filter(function(c){return c.name&&c.name!=='Name'&&c.category&&c.category!=='Category';});
realCourses.sort(function(a,b){
  var na=parseInt(((a.name||'').match(/^(\d+)/)||[0,0])[1])||0;
  var nb=parseInt(((b.name||'').match(/^(\d+)/)||[0,0])[1])||0;
  return na-nb;
});
realCourses.forEach(function(c,i){
var statusCol=(c.status||'').toLowerCase()==='active'?'var(--green)':'var(--muted)';
var freqCol=(c.frequency||'').toLowerCase().indexOf('6month')>=0?'var(--orange)':'#3B82F6';
var mins=c.duration?c.duration.toString().replace('0:','').replace(':','h ')+'min':'--';
h+='<tr style="border-bottom:1px solid var(--border);cursor:pointer" onclick="lmsOpenCourse(\''+c.airtableId+'\')" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--dim)">'+(i+1)+'</td>';
h+='<td style="padding:8px 6px;font-weight:700;color:var(--teal)">'+(c.name||'\u2014')+'</td>';
h+='<td style="padding:8px 6px"><span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px;background:rgba(124,58,237,.06);color:#7C3AED">'+(c.category||'\u2014')+'</span></td>';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--dim);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(c.description||'\u2014')+'</td>';
h+='<td style="padding:8px 6px"><span style="font-size:10px;font-weight:700;color:'+freqCol+'">'+(c.frequency||'\u2014')+'</span></td>';
h+='<td style="padding:8px 6px"><span style="font-size:10px;font-weight:700;color:'+statusCol+'">'+(c.status||'\u2014')+'</span></td>';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--dim)">'+mins+'</td>';
h+='</tr>';
});
h+='</tbody></table></div>';
}
h+='</div>';
rp.innerHTML=h;
}

var _lmsCurrentCourse=null;
var _lmsCurrentDetail=null;
var _lmsCurrentModuleIdx=0;
var _lmsCurrentLessonIdx=0;
var _lmsQuizActive=false;
var _lmsQuizAnswers={};

function lmsOpenCourse(courseId){
var course=lmsCourses.find(function(c){return c.airtableId===courseId});
if(!course)return;
_lmsCurrentCourse=course;
_lmsCurrentDetail=null;
_lmsCurrentModuleIdx=0;
_lmsCurrentLessonIdx=0;
_lmsQuizActive=false;
_lmsQuizAnswers={};
var rp=document.getElementById('recruitPanel');
if(!rp)return;
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading course...</div></div></div>';
apiCall('GET','/api/lms/course-detail?id='+courseId).then(function(d){
  _lmsCurrentDetail=d;
  lmsRenderCourseViewer(rp);
}).catch(function(e){
  rp.innerHTML='<div style="padding:24px;color:var(--red)">Failed to load course: '+e.message+'</div>';
});
}

function lmsRenderCourseViewer(rp){
if(!rp)rp=document.getElementById('recruitPanel');
if(!rp||!_lmsCurrentCourse||!_lmsCurrentDetail)return;
var course=_lmsCurrentCourse;
var detail=_lmsCurrentDetail;
var modules=detail.modules||[];
var quiz=detail.quiz;
if(_lmsQuizActive&&quiz){lmsRenderQuiz(rp,quiz);return;}
var currentModule=modules[_lmsCurrentModuleIdx];
var currentLesson=currentModule?(currentModule.lessons||[])[_lmsCurrentLessonIdx]:null;
var totalLessons=0;
modules.forEach(function(m){totalLessons+=(m.lessons||[]).length});
var lessonNum=0;
for(var mi=0;mi<_lmsCurrentModuleIdx;mi++)lessonNum+=(modules[mi].lessons||[]).length;
lessonNum+=_lmsCurrentLessonIdx+1;
var h='<div style="display:flex;height:100%;overflow:hidden">';
h+='<div style="width:240px;min-width:240px;border-right:1px solid var(--border);overflow-y:auto;background:var(--surface2)">';
h+='<div style="padding:12px 14px;border-bottom:1px solid var(--border)">';
h+='<button class="btn btn-s btn-sm" style="margin-bottom:8px;width:100%" onclick="lmsBackToCatalog()">\u2190 Back to Catalog</button>';
h+='<div style="font-size:11px;font-weight:700;color:var(--text);line-height:1.3">'+course.name+'</div>';
h+='<div style="font-size:10px;color:var(--muted);margin-top:4px">'+lessonNum+' of '+totalLessons+' lessons</div>';
var pct=totalLessons>0?Math.round((lessonNum-1)/totalLessons*100):0;
h+='<div style="margin-top:8px;height:4px;background:var(--border);border-radius:2px"><div style="height:4px;width:'+pct+'%;background:var(--teal);border-radius:2px;transition:.3s"></div></div>';
h+='</div>';
modules.forEach(function(mod,mi){
h+='<div style="padding:8px 14px;background:'+(mi===_lmsCurrentModuleIdx?'rgba(10,147,150,.08)':'none')+'">';
h+='<div style="font-size:10px;font-weight:700;color:'+(mi===_lmsCurrentModuleIdx?'var(--teal)':'var(--muted)')+';text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px">'+mod.name+'</div>';
(mod.lessons||[]).forEach(function(les,li){
var isActive=mi===_lmsCurrentModuleIdx&&li===_lmsCurrentLessonIdx;
var isDone=(mi<_lmsCurrentModuleIdx)||(mi===_lmsCurrentModuleIdx&&li<_lmsCurrentLessonIdx);
var icon=isDone?'\u2705':isActive?'\u25B6\uFE0F':'\u25CB';
h+='<div onclick="lmsGoToLesson('+mi+','+li+')" style="padding:5px 6px;border-radius:4px;cursor:pointer;font-size:11px;color:'+(isActive?'var(--teal)':'var(--text)')+';font-weight:'+(isActive?'700':'400')+';background:'+(isActive?'rgba(10,147,150,.12)':'none')+';margin-bottom:2px;display:flex;gap:6px;align-items:flex-start">';
h+='<span style="flex-shrink:0;font-size:10px">'+icon+'</span><span>'+les.name+'</span></div>';
});
h+='</div>';
});
if(quiz){
h+='<div style="padding:8px 14px;border-top:1px solid var(--border)">';
h+='<div onclick="lmsStartQuiz()" style="padding:8px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;color:#7C3AED;background:rgba(124,58,237,.06);text-align:center">\u{1F4DD} Take Quiz</div></div>';
}
h+='</div>';
h+='<div style="flex:1;overflow-y:auto;padding:28px 32px">';
if(currentLesson){
var typeIcon=currentLesson.type==='Video'?'\u{1F3A5}':currentLesson.type==='File'?'\u{1F4C4}':'\u{1F4D6}';
var typeColor=currentLesson.type==='Video'?'#EF4444':currentLesson.type==='File'?'#F59E0B':'var(--teal)';
h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
h+='<span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(10,147,150,.08);color:'+typeColor+'">'+typeIcon+' '+currentLesson.type+'</span>';
h+='<span style="font-size:10px;color:var(--muted)">'+currentModule.name+'</span></div>';
h+='<h2 style="font-size:20px;font-weight:700;color:var(--text);margin-bottom:16px">'+currentLesson.name+'</h2>';
if(currentLesson.type==='Video'&&currentLesson.videoUrl){
var vidUrl=currentLesson.videoUrl;
if(vidUrl.indexOf('youtube.com/watch')>=0)vidUrl=vidUrl.replace('watch?v=','embed/');
else if(vidUrl.indexOf('youtu.be/')>=0)vidUrl='https://www.youtube.com/embed/'+vidUrl.split('youtu.be/')[1];
h+='<div style="background:#000;border-radius:8px;overflow:hidden;margin-bottom:20px;position:relative;padding-bottom:56.25%;height:0">';
h+='<iframe src="'+vidUrl+'" style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" allowfullscreen></iframe></div>';
}else if(currentLesson.content){
h+='<div style="font-size:14px;line-height:1.8;color:var(--text);background:var(--surface2);padding:20px;border-radius:8px;margin-bottom:20px;white-space:pre-wrap">'+currentLesson.content+'</div>';
}else{
h+='<div style="padding:20px;background:var(--surface2);border-radius:8px;margin-bottom:20px;color:var(--muted);font-size:13px;text-align:center">No content available for this lesson.</div>';
}
if(currentLesson.notes){
h+='<div style="padding:12px 16px;background:rgba(245,158,11,.08);border-left:3px solid #F59E0B;border-radius:0 6px 6px 0;margin-bottom:20px;font-size:12px;color:var(--text)">';
h+='<div style="font-weight:700;margin-bottom:4px">\u{1F4CC} Note</div>'+currentLesson.notes+'</div>';
}
var isFirst=_lmsCurrentModuleIdx===0&&_lmsCurrentLessonIdx===0;
var isLastLesson=_lmsCurrentModuleIdx===modules.length-1&&_lmsCurrentLessonIdx===(currentModule.lessons||[]).length-1;
h+='<div style="display:flex;gap:12px;margin-top:24px">';
if(!isFirst)h+='<button class="btn btn-s" onclick="lmsPrevLesson()">\u2190 Previous</button>';
if(!isLastLesson){h+='<button class="btn btn-p" onclick="lmsNextLesson()">Next \u2192</button>';}
else if(quiz){h+='<button class="btn btn-p" style="background:#7C3AED" onclick="lmsStartQuiz()">\u{1F4DD} Take Quiz \u2192</button>';}
h+='</div>';
}else{
h+='<div style="text-align:center;padding:40px;color:var(--muted)">Select a lesson from the sidebar to begin</div>';
}
h+='</div></div>';
rp.innerHTML=h;
}

function lmsGoToLesson(mi,li){_lmsCurrentModuleIdx=mi;_lmsCurrentLessonIdx=li;lmsRenderCourseViewer();}
function lmsNextLesson(){
var modules=(_lmsCurrentDetail||{}).modules||[];
var currentModule=modules[_lmsCurrentModuleIdx];
var lessons=(currentModule||{}).lessons||[];
if(_lmsCurrentLessonIdx<lessons.length-1){_lmsCurrentLessonIdx++;}
else if(_lmsCurrentModuleIdx<modules.length-1){_lmsCurrentModuleIdx++;_lmsCurrentLessonIdx=0;}
lmsRenderCourseViewer();
}
function lmsPrevLesson(){
var modules=(_lmsCurrentDetail||{}).modules||[];
if(_lmsCurrentLessonIdx>0){_lmsCurrentLessonIdx--;}
else if(_lmsCurrentModuleIdx>0){_lmsCurrentModuleIdx--;var pl=(modules[_lmsCurrentModuleIdx].lessons||[]);_lmsCurrentLessonIdx=Math.max(0,pl.length-1);}
lmsRenderCourseViewer();
}
function lmsBackToCatalog(){
_lmsCurrentCourse=null;_lmsCurrentDetail=null;
var rp=document.getElementById('recruitPanel');
if(rp){lmsLoaded=false;renderLMS(rp);}
}
function lmsStartQuiz(){_lmsQuizActive=true;_lmsQuizAnswers={};lmsRenderCourseViewer();}
function lmsBackToLesson(){_lmsQuizActive=false;lmsRenderCourseViewer();}
function lmsRetryQuiz(){_lmsQuizAnswers={};_lmsQuizActive=true;lmsRenderCourseViewer();}

function lmsRenderQuiz(rp,quiz){
var questions=quiz.questions||[];
var h='<div style="padding:28px 32px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">';
h+='<button class="btn btn-s btn-sm" onclick="lmsBackToLesson()">\u2190 Back to Lessons</button>';
h+='<div><div style="font-size:18px;font-weight:700;color:var(--text)">\u{1F4DD} '+quiz.name+'</div>';
h+='<div style="font-size:11px;color:var(--muted)">'+quiz.description+' \u2014 Pass mark: '+quiz.passPercentage+'%</div></div></div>';
if(questions.length===0){
h+='<div style="padding:20px;background:var(--surface2);border-radius:8px;color:var(--muted);text-align:center">Quiz questions are being prepared. Check back soon!</div>';
}else{
questions.forEach(function(q,qi){
var answered=_lmsQuizAnswers[qi]!==undefined;
h+='<div style="background:var(--surface2);border-radius:8px;padding:20px;margin-bottom:16px;border:1px solid '+(answered?'var(--teal)':'var(--border)')+'">';
h+='<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px"><span style="color:var(--teal)">Q'+(qi+1)+'.</span> '+q.question+'</div>';
if(q.options&&q.options.length>0){
q.options.forEach(function(opt,oi){
var isSel=_lmsQuizAnswers[qi]===oi;
h+='<div onclick="lmsSelectAnswer('+qi+','+oi+')" style="padding:10px 14px;border-radius:6px;margin-bottom:6px;cursor:pointer;font-size:12px;border:1px solid '+(isSel?'var(--teal)':'var(--border)')+';background:'+(isSel?'rgba(10,147,150,.1)':'var(--surface)')+';color:'+(isSel?'var(--teal)':'var(--text)')+';font-weight:'+(isSel?'700':'400')+'">';
h+='<span style="font-weight:700;margin-right:8px">'+'ABCD'[oi]+'.</span>'+opt+'</div>';
});
}else{
h+='<div style="color:var(--muted);font-size:11px;font-style:italic">Answer options not yet configured.</div>';
}
h+='</div>';
});
var answered=Object.keys(_lmsQuizAnswers).length;
var allAnswered=answered>=questions.length;
h+='<div style="text-align:center;padding:16px">';
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:12px">'+answered+' of '+questions.length+' questions answered</div>';
h+='<button class="btn btn-p" '+(allAnswered?'onclick="lmsSubmitQuiz()"':'disabled style="opacity:.4"')+'>Submit Quiz \u2192</button>';
h+='</div>';
}
h+='</div>';
rp.innerHTML=h;
}

function lmsSelectAnswer(qi,oi){
_lmsQuizAnswers[qi]=oi;
var rp=document.getElementById('recruitPanel');
if(rp&&_lmsCurrentDetail&&_lmsCurrentDetail.quiz)lmsRenderQuiz(rp,_lmsCurrentDetail.quiz);
}

function lmsSubmitQuiz(){
var quiz=(_lmsCurrentDetail||{}).quiz;
if(!quiz)return;
var questions=quiz.questions||[];
var correct=0;
questions.forEach(function(q,qi){if(_lmsQuizAnswers[qi]===q.correctAnswer)correct++;});
var pct=questions.length>0?Math.round(correct/questions.length*100):0;
var passed=pct>=(quiz.passPercentage||100);
var rp=document.getElementById('recruitPanel');
if(!rp)return;
var h='<div style="padding:40px;text-align:center;overflow-y:auto;height:100%">';
h+='<div style="font-size:56px;margin-bottom:16px">'+(passed?'\u{1F3C6}':'\u{1F504}')+'</div>';
h+='<div style="font-size:28px;font-weight:700;color:'+(passed?'var(--green)':'var(--red)')+';margin-bottom:8px">'+(passed?'Congratulations!':'Not quite there...')+'</div>';
h+='<div style="font-size:18px;color:var(--text);margin-bottom:8px">You scored <strong>'+pct+'%</strong> ('+correct+'/'+questions.length+')</div>';
h+='<div style="font-size:13px;color:var(--muted);margin-bottom:32px">'+(passed?'You have passed this assessment!':'You need '+quiz.passPercentage+'% to pass. Review the lessons and try again.')+'</div>';
h+='<div style="max-width:500px;margin:0 auto 32px;text-align:left">';
questions.forEach(function(q,qi){
var isCorrect=_lmsQuizAnswers[qi]===q.correctAnswer;
h+='<div style="padding:10px 14px;border-radius:6px;margin-bottom:8px;background:'+(isCorrect?'rgba(34,197,94,.06)':'rgba(239,68,68,.06)')+';border:1px solid '+(isCorrect?'rgba(34,197,94,.2)':'rgba(239,68,68,.2)')+'">';
h+='<div style="font-size:11px;font-weight:700;color:'+(isCorrect?'var(--green)':'var(--red)')+'">Q'+(qi+1)+' '+(isCorrect?'\u2705 Correct':'\u274C Incorrect')+'</div>';
h+='<div style="font-size:11px;color:var(--text);margin-top:2px">'+q.question+'</div>';
if(!isCorrect&&q.options&&q.options[q.correctAnswer]){
h+='<div style="font-size:10px;color:var(--green);margin-top:4px">\u2714 Correct answer: '+q.options[q.correctAnswer]+'</div>';
}
h+='</div>';
});
h+='</div>';
h+='<div style="display:flex;gap:12px;justify-content:center">';
if(!passed)h+='<button class="btn btn-s" onclick="lmsRetryQuiz()">Retry Quiz</button>';
h+='<button class="btn btn-p" onclick="lmsBackToCatalog()">'+(passed?'\u{1F3C6} Back to Catalog':'Back to Catalog')+'</button>';
h+='</div></div>';
rp.innerHTML=h;
}

function enrollCandidate(){
var candidateId=(document.getElementById('lmsCandidate')||{}).value;
var courseSelect=document.getElementById('lmsCourseSelect');
var msgEl=document.getElementById('lmsEnrollMsg');
if(!candidateId){if(msgEl)msgEl.innerHTML='<span style="color:var(--red)">Please select a candidate</span>';return;}
var selectedCourses=[];
if(courseSelect){for(var i=0;i<courseSelect.options.length;i++){if(courseSelect.options[i].selected)selectedCourses.push(lmsCourses[parseInt(courseSelect.options[i].value)]);}}
if(selectedCourses.length===0){if(msgEl)msgEl.innerHTML='<span style="color:var(--red)">Please select at least one course</span>';return;}
var candidate=contacts.find(function(c){return(c.id||c.airtable_id)===candidateId;});
if(msgEl)msgEl.innerHTML='<span style="color:var(--muted)">Enrolling...</span>';
var enrollNext=function(idx){
if(idx>=selectedCourses.length){
if(msgEl)msgEl.innerHTML='<span style="color:var(--green)">\u2705 '+(candidate?candidate.name:'Candidate')+' enrolled in '+selectedCourses.length+' course'+(selectedCourses.length!==1?'s':'')+'!</span>';
return;
}
var c=selectedCourses[idx];
apiCall('POST','/api/lms/enroll-v2',{
staffId:candidateId,courseId:c.airtableId,courseName:c.name,staffName:candidate?candidate.name:''
}).then(function(){enrollNext(idx+1);}).catch(function(e){
if(msgEl)msgEl.innerHTML='<span style="color:var(--red)">\u274C Error: '+e.message+'</span>';
});
};
enrollNext(0);
}


function enrollCandidate(){
  var sel=document.getElementById("lmsCandidate");
  var csel=document.getElementById("lmsCourseSelect");
  var msg=document.getElementById("lmsEnrollMsg");
  if(!sel||!sel.value){ if(msg) msg.innerHTML='<span style="color:var(--orange)">Please select a candidate</span>'; return; }
  var opts=csel?Array.from(csel.selectedOptions):[];
  if(!opts.length){ if(msg) msg.innerHTML='<span style="color:var(--orange)">Please select at least one course</span>'; return; }
  var candidateId=sel.value;
  var candidateName=sel.options[sel.selectedIndex].text.split(" \u2014 ")[0];
  var courses=opts.map(function(o){ return lmsCourses[parseInt(o.value)]; }).filter(Boolean);
  if(msg) msg.innerHTML='<span style="color:var(--teal)">Enrolling...</span>';
  var promises=courses.map(function(c){
    return apiCall("POST","/api/lms/enroll-v2",{
      staffId:candidateId,staffName:candidateName,
      courseId:c.airtableId,courseName:c.name
    });
  });
  Promise.all(promises).then(function(results){
    var ok=results.filter(function(r){ return r&&r.success; }).length;
    if(msg) msg.innerHTML='<span style="color:#059669">\u2705 Enrolled in '+ok+' course(s) successfully!</span>';
    setTimeout(function(){ lmsLoaded=false; renderLMS(document.getElementById("rightPanel")); },1500);
  }).catch(function(){
    if(msg) msg.innerHTML='<span style="color:red">Enrollment failed. Check connection.</span>';
  });
}


var tasksData=[];
var tasksLoaded=false;
var tasksFilters={q:"",status:"",priority:"",client:"",staff:""};


function renderTasks(){
  var rp=document.getElementById("rightPanel");
  rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading tasks...</div></div></div>';
  apiCall("GET","/api/tasks").then(function(d){
    tasksData=d||[];tasksLoaded=true;
    renderTasksDashboard();
  }).catch(function(e){
    rp.innerHTML='<div style="padding:24px;color:var(--red);font-size:13px">Error loading tasks: '+e.message+'</div>';
  });
}

function renderTasksDashboard(){
  var rp=document.getElementById("rightPanel");
  var data=tasksData;
  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
  var total=data.length;
  var done=data.filter(function(t){return t.status==="Completed"}).length;
  var prog=data.filter(function(t){return t.status==="In Progress"}).length;
  var ns=data.filter(function(t){return t.status==="Not Started"}).length;
  var crit=data.filter(function(t){return t.priority==="Critical"}).length;
  var overdue=data.filter(function(t){return t.dueDate&&t.status!=="Completed"&&new Date(t.dueDate)<new Date()}).length;
  // ‚îÄ‚îÄ Client list ‚îÄ‚îÄ
  var clientSet={};data.forEach(function(t){if(t.clientName)clientSet[t.clientName]=(clientSet[t.clientName]||0)+1});
  var clients=Object.keys(clientSet).sort();
  // ‚îÄ‚îÄ Staff list ‚îÄ‚îÄ
  var staffSet={};
  data.forEach(function(t){
    (t.assignee||"").split(",").forEach(function(s){s=s.trim();if(s)staffSet[s]=(staffSet[s]||0)+1});
  });
  var staffList=Object.keys(staffSet).sort(function(a,b){return staffSet[b]-staffSet[a]});

  var h='<div style="height:100%;overflow-y:auto;background:var(--bg)">';

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  h+='<div style="background:linear-gradient(135deg,#0f172a,#1e3a5f);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">';
  h+='<div><div style="font-size:20px;font-weight:700;color:#fff">üìã Tasks</div><div style="font-size:12px;color:rgba(255,255,255,.5);margin-top:2px">All tasks across all clients</div></div>';
  h+='<div style="display:flex;gap:8px"><button onclick="openNewTaskModal()" style="padding:7px 14px;background:rgba(10,147,150,.8);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">\u2795 New Task</button><button onclick="openNewProjectModal()" style="padding:7px 14px;background:rgba(99,102,241,.8);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">üìÅ New Project</button><button onclick="renderTasks()" style="padding:7px 14px;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">üîÑ</button></div>';
  h+='</div>';

  // ‚îÄ‚îÄ Stat tiles ‚îÄ‚îÄ
  h+='<div style="display:flex;gap:10px;padding:16px 24px;flex-wrap:wrap;background:var(--surface);border-bottom:1px solid var(--border)">';
  var tiles=[
    {num:total,lbl:"Total",bg:"#f3f4f6",col:"#374151"},
    {num:ns,lbl:"Not Started",bg:"#f9fafb",col:"#6b7280"},
    {num:prog,lbl:"In Progress",bg:"#eff6ff",col:"#2563eb"},
    {num:done,lbl:"Completed",bg:"#ecfdf5",col:"#059669"},
    {num:crit,lbl:"Critical",bg:"#fef2f2",col:"#dc2626"},
    {num:overdue,lbl:"Overdue",bg:"#fff7ed",col:"#ea580c"}
  ];
  tiles.forEach(function(t){
    h+='<div style="flex:1;min-width:80px;padding:12px;border-radius:10px;text-align:center;background:'+t.bg+';color:'+t.col+';border:2px solid transparent;cursor:pointer;transition:all .15s" onclick="taskQuickFilter(\''+t.lbl+'\')">';
    h+='<div style="font-size:24px;font-weight:700;font-variant-numeric:tabular-nums">'+t.num+'</div>';
    h+='<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;opacity:.8;margin-top:2px">'+t.lbl+'</div></div>';
  });
  h+='</div>';

  // ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ
  var dPct=total?(done/total*100).toFixed(0):0;
  var iPct=total?(prog/total*100).toFixed(0):0;
  h+='<div style="padding:12px 24px;background:var(--surface);border-bottom:1px solid var(--border)">';
  h+='<div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:11px;color:var(--muted);font-weight:600">Overall Completion</span><strong style="font-size:11px;color:var(--text)">'+dPct+'%</strong></div>';
  h+='<div style="height:10px;border-radius:5px;background:#f0f2f7;overflow:hidden;display:flex">';
  h+='<div style="height:100%;width:'+dPct+'%;background:#10b981;transition:width .6s"></div>';
  h+='<div style="height:100%;width:'+iPct+'%;background:#3b82f6;transition:width .6s"></div>';
  h+='</div>';
  h+='<div style="display:flex;gap:16px;margin-top:6px;flex-wrap:wrap">';
  [{c:"#10b981",l:"Completed ("+done+")"},{c:"#3b82f6",l:"In Progress ("+prog+")"},{c:"#e5e7eb",l:"Not Started ("+ns+")"}].forEach(function(lg){
    h+='<div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)"><div style="width:10px;height:10px;border-radius:2px;background:'+lg.c+'"></div>'+lg.l+'</div>';
  });
  h+='</div></div>';

  // ‚îÄ‚îÄ Charts row ‚îÄ‚îÄ
  h+='<div style="display:flex;gap:16px;padding:16px 24px;flex-wrap:wrap">';

  // Status pie chart
  h+='<div style="flex:1;min-width:240px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px">';
  h+='<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">Status Breakdown</div>';
  h+='<canvas id="statusPieChart" width="200" height="200" style="max-width:200px;margin:0 auto;display:block"></canvas>';
  h+='</div>';

  // Priority pie chart
  h+='<div style="flex:1;min-width:240px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px">';
  h+='<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">Priority Breakdown</div>';
  h+='<canvas id="priorityPieChart" width="200" height="200" style="max-width:200px;margin:0 auto;display:block"></canvas>';
  h+='</div>';

  // Staff bar chart
  h+='<div style="flex:2;min-width:280px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px">';
  h+='<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">Tasks by Staff Member</div>';
  h+='<canvas id="staffBarChart" height="200" style="width:100%"></canvas>';
  h+='</div>';

  h+='</div>';

  // ‚îÄ‚îÄ Client bar chart ‚îÄ‚îÄ
  h+='<div style="padding:0 24px 16px">';
  h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px">';
  h+='<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">Tasks by Client</div>';
  h+='<canvas id="clientBarChart" height="120" style="width:100%"></canvas>';
  h+='</div></div>';

  // ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
  h+='<div style="display:flex;gap:8px;padding:0 24px 12px;flex-wrap:wrap;align-items:center">';
  h+='<input id="txSearch" oninput="filterTX()" placeholder="üîç Search tasks, clients, staff..." value="'+(tasksFilters.q||"")+'" style="flex:2;min-width:200px;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;background:var(--surface);outline:none">';

  // Status filter
  h+='<select id="txStatus" onchange="filterTX()" style="padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;font-family:inherit;background:var(--surface);cursor:pointer">';
  h+='<option value="">All Statuses</option>';
  ["Not Started","In Progress","Completed"].forEach(function(s){h+='<option value="'+s+'"'+(tasksFilters.status===s?" selected":"")+'>'+s+'</option>'});
  h+='</select>';

  // Priority filter
  h+='<select id="txPriority" onchange="filterTX()" style="padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;font-family:inherit;background:var(--surface);cursor:pointer">';
  h+='<option value="">All Priorities</option>';
  ["Critical","High","Medium","Low"].forEach(function(p){h+='<option value="'+p+'"'+(tasksFilters.priority===p?" selected":"")+'>'+p+'</option>'});
  h+='</select>';

  // Client filter
  h+='<select id="txClient" onchange="filterTX()" style="padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;font-family:inherit;background:var(--surface);cursor:pointer;max-width:180px">';
  h+='<option value="">All Clients</option>';
  clients.forEach(function(c){h+='<option value="'+c+'"'+(tasksFilters.client===c?" selected":"")+'>'+c+'</option>'});
  h+='</select>';

  // Staff filter
  h+='<select id="txStaff" onchange="filterTX()" style="padding:7px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;font-family:inherit;background:var(--surface);cursor:pointer;max-width:180px">';
  h+='<option value="">All Staff</option>';
  staffList.forEach(function(s){h+='<option value="'+s+'"'+(tasksFilters.staff===s?" selected":"")+'>'+s+' ('+staffSet[s]+')</option>'});
  h+='</select>';

  h+='<button onclick="tasksClearFilters()" style="padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;color:var(--muted)">‚úï Clear</button>';
  h+='<span id="txCount" style="font-size:11px;color:var(--muted);white-space:nowrap"></span>';
  h+='</div>';

  // ‚îÄ‚îÄ Task table ‚îÄ‚îÄ
  h+='<div style="padding:0 24px 24px">';
  h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden">';
  h+='<table style="width:100%;border-collapse:collapse;font-size:12px">';
  h+='<thead><tr style="background:var(--surface2);border-bottom:2px solid var(--border)">';
  ["#","Task Name","Client","Project","Assigned To","Created By / Date","Priority","Status","Due Date"].forEach(function(col){
    h+='<th style="padding:10px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>';
  });
  h+='</tr></thead>';
  h+='<tbody id="txTbody"></tbody>';
  h+='</table></div></div>';

  // ‚îÄ‚îÄ Staff leaderboard ‚îÄ‚îÄ
  h+='<div style="padding:0 24px 24px">';
  h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px">';
  h+='<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">üèÜ Staff Task Leaderboard</div>';
  h+='<div id="staffLeaderboard"></div>';
  h+='</div></div>';

  h+='</div>';
  rp.innerHTML=h;

  // Render table
  filterTX();

  // Draw charts after DOM is ready
  setTimeout(function(){
    drawTaskCharts(data,staffSet,clientSet);
    renderStaffLeaderboard(staffSet,staffList,data);
  },100);
}

function getFilteredTasks(){
  var q=(tasksFilters.q||"").toLowerCase();
  var sf=tasksFilters.status||"";
  var pf=tasksFilters.priority||"";
  var cf=tasksFilters.client||"";
  var stf=tasksFilters.staff||"";
  return tasksData.filter(function(t){
    var matchQ=!q||(t.taskName||"").toLowerCase().indexOf(q)>=0||(t.clientName||"").toLowerCase().indexOf(q)>=0||(t.assignee||"").toLowerCase().indexOf(q)>=0||(t.typeOfUpdate||"").toLowerCase().indexOf(q)>=0;
    var matchS=!sf||t.status===sf;
    var matchP=!pf||t.priority===pf;
    var matchC=!cf||t.clientName===cf;
    var matchSt=!stf||(t.assignee||"").indexOf(stf)>=0;
    return matchQ&&matchS&&matchP&&matchC&&matchSt;
  });
}

// ‚îÄ‚îÄ Date formatter: Wed 19/02/25 2:44 pm ‚îÄ‚îÄ
function fmtTXDate(v){
  if(!v)return"‚Äî";
  try{
    var d=new Date(v);if(isNaN(d))return v;
    var days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var dd=String(d.getDate()).padStart(2,"0");
    var mm=String(d.getMonth()+1).padStart(2,"0");
    var yy=String(d.getFullYear()).slice(-2);
    var h=d.getHours();var min=String(d.getMinutes()).padStart(2,"0");
    var ampm=h>=12?"pm":"am";h=h%12||12;
    return days[d.getDay()]+" "+dd+"/"+mm+"/"+yy+" "+h+":"+min+" "+ampm;
  }catch(e){return v}
}
function fmtTXDateShort(v){
  if(!v)return"";
  try{
    var d=new Date(v);if(isNaN(d))return v;
    var dd=String(d.getDate()).padStart(2,"0");
    var mm=String(d.getMonth()+1).padStart(2,"0");
    var yy=String(d.getFullYear()).slice(-2);
    return dd+"/"+mm+"/"+yy;
  }catch(e){return v}
}

function filterTX(){
  tasksFilters.q=(document.getElementById("txSearch")||{}).value||"";
  tasksFilters.status=(document.getElementById("txStatus")||{}).value||"";
  tasksFilters.priority=(document.getElementById("txPriority")||{}).value||"";
  tasksFilters.client=(document.getElementById("txClient")||{}).value||"";
  tasksFilters.staff=(document.getElementById("txStaff")||{}).value||"";
  var ft=getFilteredTasks();
  var countEl=document.getElementById("txCount");
  if(countEl)countEl.textContent=ft.length+" of "+tasksData.length+" tasks";
  var tbody=document.getElementById("txTbody");if(!tbody)return;
  var PRI_COL={"Critical":"#dc2626","High":"#d97706","Medium":"#0891b2","Low":"#059669"};
  var STA_COL={"Completed":"#059669","In Progress":"#2563eb","Not Started":"#6b7280"};
  var rows="";
  if(ft.length===0){rows='<tr><td colspan="8" style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üìã</div><div style="font-size:13px;font-weight:600">No tasks match filters</div></td></tr>';}
  else{
    ft.forEach(function(t){
      var pc=PRI_COL[t.priority]||"#6b7280";var sc=STA_COL[t.status]||"#6b7280";
      var isOverdue=t.dueDate&&t.status!=="Completed"&&new Date(t.dueDate)<new Date();
      var dueFmt=fmtTXDateShort(t.dueDate);
      var createdFmt=fmtTXDate(t.createdDate);
      var names=(t.assignee||"").split(",").map(function(n){return n.trim()}).filter(Boolean);
      var assigneeHtml=names.length>0?'<span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:8px;background:rgba(59,130,246,.08);color:#3b82f6">'+names[0]+(names.length>1?" +"+(names.length-1):"")+'</span>':"‚Äî";
      rows+='<tr onclick="openTaskDetailModal(\''+t.id+'\')" style="border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
      rows+='<td style="padding:10px 12px;font-size:10px;color:var(--muted);white-space:nowrap">'+(t.refNumber?"#"+t.refNumber:"‚Äî")+'</td>';
      rows+='<td style="padding:10px 12px;font-weight:600;color:var(--text);max-width:220px"><div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(t.taskName||"‚Äî")+'</div></td>';
      rows+='<td style="padding:10px 12px;font-size:11px;color:var(--text2);white-space:nowrap">'+(t.clientName||"‚Äî")+'</td>';
      rows+='<td style="padding:10px 12px">'+(t.projectName?'<span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px;background:rgba(99,102,241,.08);color:#6366f1">'+t.projectName+'</span>':'‚Äî')+'</td>';
      rows+='<td style="padding:10px 12px">'+assigneeHtml+'</td>';
      rows+='<td style="padding:10px 12px;font-size:10px;color:var(--muted);white-space:nowrap">'+(t.createdBy?'<span style="font-weight:600;color:var(--text2)">'+(typeof t.createdBy==="object"?(t.createdBy.name||t.createdBy.email||"System"):t.createdBy)+'</span><br>':'')+createdFmt+'</td>';
      rows+='<td style="padding:10px 12px"><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:'+pc+'12;color:'+pc+';border:1px solid '+pc+'25">'+(t.priority||"‚Äî")+'</span></td>';
      rows+='<td style="padding:10px 12px"><span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:8px;background:'+sc+'12;color:'+sc+';border:1px solid '+sc+'25">'+(t.status||"‚Äî")+'</span></td>';
      rows+='<td style="padding:10px 12px;font-size:11px;white-space:nowrap;color:'+(isOverdue?"#dc2626":"var(--muted)")+'">'+(isOverdue?"‚ö† ":"")+dueFmt+'</td>';
      rows+='</tr>';
    });
  }
  tbody.innerHTML=rows;
}

function taskQuickFilter(lbl){
  var map={"Not Started":"Not Started","In Progress":"In Progress","Completed":"Completed","Critical":"","Overdue":""};
  tasksFilters.status="";tasksFilters.priority="";
  if(lbl==="Not Started")tasksFilters.status="Not Started";
  else if(lbl==="In Progress")tasksFilters.status="In Progress";
  else if(lbl==="Completed")tasksFilters.status="Completed";
  else if(lbl==="Critical")tasksFilters.priority="Critical";
  var ss=document.getElementById("txStatus");if(ss)ss.value=tasksFilters.status;
  var sp=document.getElementById("txPriority");if(sp)sp.value=tasksFilters.priority;
  filterTX();
}

function tasksClearFilters(){
  tasksFilters={q:"",status:"",priority:"",client:"",staff:""};
  var ids=["txSearch","txStatus","txPriority","txClient","txStaff"];
  ids.forEach(function(id){var el=document.getElementById(id);if(el)el.value=""});
  filterTX();
}

function drawTaskCharts(data,staffSet,clientSet){
  if(typeof Chart==="undefined")return;

  // Status pie
  var statusCounts={"Not Started":0,"In Progress":0,"Completed":0};
  data.forEach(function(t){var s=t.status||"Not Started";if(statusCounts[s]!==undefined)statusCounts[s]++;else statusCounts["Not Started"]++});
  var sc1=document.getElementById("statusPieChart");
  if(sc1){new Chart(sc1,{type:"doughnut",data:{labels:Object.keys(statusCounts),datasets:[{data:Object.values(statusCounts),backgroundColor:["#e5e7eb","#3b82f6","#10b981"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:true,plugins:{legend:{position:"bottom",labels:{font:{size:10},padding:8}}}}})}

  // Priority pie
  var priCounts={"Critical":0,"High":0,"Medium":0,"Low":0};
  data.forEach(function(t){var p=t.priority||"Low";if(priCounts[p]!==undefined)priCounts[p]++;else priCounts["Low"]++});
  var sc2=document.getElementById("priorityPieChart");
  if(sc2){new Chart(sc2,{type:"doughnut",data:{labels:Object.keys(priCounts),datasets:[{data:Object.values(priCounts),backgroundColor:["#ef4444","#f59e0b","#06b6d4","#10b981"],borderWidth:2,borderColor:"#fff"}]},options:{responsive:true,plugins:{legend:{position:"bottom",labels:{font:{size:10},padding:8}}}}})}

  // Staff bar (top 10)
  var topStaff=Object.keys(staffSet).sort(function(a,b){return staffSet[b]-staffSet[a]}).slice(0,10);
  var sc3=document.getElementById("staffBarChart");
  if(sc3&&topStaff.length>0){
    // Break down by status per staff member
    var staffDone={};var staffProg={};var staffNS={};
    topStaff.forEach(function(s){staffDone[s]=0;staffProg[s]=0;staffNS[s]=0});
    data.forEach(function(t){
      (t.assignee||"").split(",").forEach(function(s){
        s=s.trim();if(!staffDone[s]&&staffDone[s]!==0)return;
        if(t.status==="Completed")staffDone[s]++;
        else if(t.status==="In Progress")staffProg[s]++;
        else staffNS[s]++;
      });
    });
    new Chart(sc3,{type:"bar",data:{labels:topStaff.map(function(s){return s.split(" ")[0]}),datasets:[
      {label:"Completed",data:topStaff.map(function(s){return staffDone[s]||0}),backgroundColor:"#10b981"},
      {label:"In Progress",data:topStaff.map(function(s){return staffProg[s]||0}),backgroundColor:"#3b82f6"},
      {label:"Not Started",data:topStaff.map(function(s){return staffNS[s]||0}),backgroundColor:"#e5e7eb"}
    ]},options:{responsive:true,scales:{x:{stacked:true,ticks:{font:{size:10}}},y:{stacked:true,ticks:{font:{size:10},stepSize:1}}},plugins:{legend:{position:"bottom",labels:{font:{size:10},padding:8}}}}});
  }

  // Client bar (top 12)
  var topClients=Object.keys(clientSet).sort(function(a,b){return clientSet[b]-clientSet[a]}).slice(0,12);
  var sc4=document.getElementById("clientBarChart");
  if(sc4&&topClients.length>0){
    var clientDone={};var clientProg={};var clientNS={};
    topClients.forEach(function(c){clientDone[c]=0;clientProg[c]=0;clientNS[c]=0});
    data.forEach(function(t){
      var c=t.clientName||"";if(!clientDone[c]&&clientDone[c]!==0)return;
      if(t.status==="Completed")clientDone[c]++;
      else if(t.status==="In Progress")clientProg[c]++;
      else clientNS[c]++;
    });
    new Chart(sc4,{type:"bar",data:{labels:topClients.map(function(c){return c.split(" ")[0]}),datasets:[
      {label:"Completed",data:topClients.map(function(c){return clientDone[c]||0}),backgroundColor:"#10b981"},
      {label:"In Progress",data:topClients.map(function(c){return clientProg[c]||0}),backgroundColor:"#3b82f6"},
      {label:"Not Started",data:topClients.map(function(c){return clientNS[c]||0}),backgroundColor:"#e5e7eb"}
    ]},options:{responsive:true,scales:{x:{stacked:true,ticks:{font:{size:10}}},y:{stacked:true,ticks:{font:{size:10},stepSize:1}}},plugins:{legend:{display:false}}}});
  }
}

function renderStaffLeaderboard(staffSet,staffList,data){
  var el=document.getElementById("staffLeaderboard");if(!el)return;
  var top=staffList.slice(0,8);
  var max=top.length>0?staffSet[top[0]]:1;
  var PRI_COL={"Critical":"#dc2626","High":"#d97706","Medium":"#0891b2","Low":"#059669"};
  var html='<div style="display:flex;flex-direction:column;gap:8px">';
  top.forEach(function(name,i){
    var total=staffSet[name];
    var done=data.filter(function(t){return t.status==="Completed"&&(t.assignee||"").indexOf(name)>=0}).length;
    var prog=data.filter(function(t){return t.status==="In Progress"&&(t.assignee||"").indexOf(name)>=0}).length;
    var crit=data.filter(function(t){return t.priority==="Critical"&&(t.assignee||"").indexOf(name)>=0&&t.status!=="Completed"}).length;
    var pct=max?Math.round(total/max*100):0;
    var medals=["ü•á","ü•à","ü•â"];
    html+='<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border)">';
    html+='<div style="font-size:16px;width:24px;text-align:center">'+(medals[i]||"#"+(i+1))+'</div>';
    html+='<div style="flex:1;min-width:0">';
    html+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">';
    html+='<span style="font-size:12px;font-weight:700;color:var(--text)">'+name+'</span>';
    html+='<div style="display:flex;gap:6px;align-items:center">';
    if(crit>0)html+='<span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:8px;background:#fef2f2;color:#dc2626;border:1px solid #fecaca">'+crit+' Critical</span>';
    html+='<span style="font-size:11px;font-weight:700;color:var(--text)">'+total+' tasks</span>';
    html+='</div></div>';
    html+='<div style="height:6px;border-radius:3px;background:#e5e7eb;overflow:hidden">';
    html+='<div style="height:100%;width:'+pct+'%;background:linear-gradient(90deg,var(--teal),#2563eb);transition:width .5s"></div></div>';
    html+='<div style="display:flex;gap:10px;margin-top:4px">';
    html+='<span style="font-size:10px;color:#10b981">‚úì '+done+' done</span>';
    html+='<span style="font-size:10px;color:#3b82f6">‚ü≥ '+prog+' in progress</span>';
    html+='<span style="font-size:10px;color:#6b7280">‚óØ '+(total-done-prog)+' not started</span>';
    html+='</div></div></div>';
  });
  html+='</div>';
  el.innerHTML=html;
}

function openTaskDetailModal(taskId){
  var t=tasksData.find(function(x){return x.id===taskId});if(!t)return;
  var PRI_COL={"Critical":"#dc2626","High":"#d97706","Medium":"#0891b2","Low":"#059669"};
  var STA_COL={"Completed":"#059669","In Progress":"#2563eb","Not Started":"#6b7280"};
  var pc=PRI_COL[t.priority]||"#6b7280";var sc=STA_COL[t.status]||"#6b7280";
  var existing=document.getElementById("taskDetailOverlay");if(existing)existing.remove();
  var overlay=document.createElement("div");overlay.id="taskDetailOverlay";
  overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px";
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};
  var names=(t.assignee||"").split(",").map(function(n){return n.trim()}).filter(Boolean);

  var h='<div id="taskDetailInner" style="background:var(--surface);border-radius:14px;max-width:640px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.25)">';

  // Header
  h+='<div style="background:linear-gradient(135deg,#0f172a,#1e3a5f);padding:16px 20px;border-radius:14px 14px 0 0;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:2">';
  h+='<div style="flex:1"><div style="font-size:15px;font-weight:700;color:#fff;line-height:1.4">'+(t.taskName||"Task")+'</div>';
  h+='<div style="font-size:11px;color:rgba(255,255,255,.5);margin-top:4px">'+(t.clientName?"Client: "+t.clientName:"")+(t.refNumber?" ¬∑ #"+t.refNumber:"")+'</div></div>';
  h+='<button onclick="document.getElementById(\'taskDetailOverlay\').remove()" style="background:rgba(255,255,255,.1);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0">‚úï</button></div>';

  h+='<div style="padding:20px;display:flex;flex-direction:column;gap:16px">';

  // Badges
  h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
  h+='<span style="font-size:11px;font-weight:700;padding:4px 12px;border-radius:10px;background:'+pc+'12;color:'+pc+';border:1px solid '+pc+'25">'+(t.priority||"‚Äî")+'</span>';
  h+='<span style="font-size:11px;font-weight:700;padding:4px 12px;border-radius:10px;background:'+sc+'12;color:'+sc+';border:1px solid '+sc+'25">'+(t.status||"‚Äî")+'</span>';
  if(t.typeOfUpdate){t.typeOfUpdate.split(",").forEach(function(tp){tp=tp.trim();if(tp)h+='<span style="font-size:11px;font-weight:700;padding:4px 12px;border-radius:10px;background:#f5f3ff;color:#7c3aed;border:1px solid #e9d5ff">'+tp+'</span>'});}
  h+='</div>';

  // Info grid
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  function infoCell(lbl,val){if(!val)return"";return'<div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:3px">'+lbl+'</div><div style="font-size:12px;font-weight:600;color:var(--text)">'+val+'</div></div>'}
  h+=infoCell("Client",t.clientName);
  h+=infoCell("Project",t.projectName);
  h+=infoCell("Created By",(t.createdBy&&typeof t.createdBy==="object"?(t.createdBy.name||t.createdBy.email||"System"):t.createdBy)||"");
  h+=infoCell("Created",fmtTXDate(t.createdDate));
  h+=infoCell("Due Date",t.dueDate?fmtTXDateShort(t.dueDate):"");
  h+=infoCell("Date Completed",t.dateCompleted?fmtTXDate(t.dateCompleted):"");
  h+=infoCell("Follow-up Required?",t.followUpRequired);
  h+='</div>';

  // Assigned staff
  if(names.length>0){
    h+='<div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px"><div style="display:flex;align-items:center;justify-content:space-between"><span style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted)">Assigned To</span></div><div style="display:flex;gap:6px;flex-wrap:wrap">';
    names.forEach(function(n){h+='<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:10px;background:rgba(59,130,246,.08);color:#3b82f6;border:1px solid rgba(59,130,246,.2)">'+n+'</span>'});
    h+='</div></div>';
  }

  // Description (read-only)
  if(t.description)h+='<div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Description</div><div style="font-size:12px;color:var(--text);line-height:1.6;padding:12px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);white-space:pre-wrap">'+t.description+'</div></div>';

  // Incident box
  if(t.linkedIncidentRef)h+='<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px"><div style="font-size:10px;font-weight:700;color:#dc2626;text-transform:uppercase;letter-spacing:.05em">üö® Linked Incident: '+t.linkedIncidentRef+(t.isNdisReportable==="Yes"?" ¬∑ NDIS Reportable":"")+'</div></div>';

  // ‚îÄ‚îÄ EDITABLE SECTION ‚îÄ‚îÄ
  h+='<div style="border-top:2px solid var(--border);padding-top:16px">';
  h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:6px">‚úèÔ∏è Update Task</div>';

  // Status quick-change
  h+='<div style="margin-bottom:14px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:8px">Status</div>';
  h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
  ["Not Started","In Progress","Completed"].forEach(function(sv){
    var svc=STA_COL[sv]||"#6b7280";var isCur=t.status===sv;
    h+='<button onclick="txModalStatus(\''+taskId+'\',\''+sv+'\')" style="padding:7px 16px;border-radius:20px;border:2px solid '+svc+';font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;background:'+(isCur?svc:"transparent")+';color:'+(isCur?"#fff":svc)+'">'+sv+'</button>';
  });
  h+='</div></div>';

  // Actions taken
  h+='<div style="margin-bottom:12px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Actions Taken to Complete Task</div>';
  h+='<textarea id="txModalActions" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;resize:vertical;min-height:80px;outline:none;line-height:1.5;color:var(--text);box-sizing:border-box;transition:border-color .15s" onfocus="this.style.borderColor=\'var(--teal)\'" onblur="this.style.borderColor=\'var(--border)\'" placeholder="Describe what has been done to complete this task...">'+(t.actionsTaken||"")+'</textarea></div>';

  // Follow-up notes
  h+='<div style="margin-bottom:12px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Follow-up Notes / Details</div>';
  h+='<textarea id="txModalFollowUp" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;resize:vertical;min-height:80px;outline:none;line-height:1.5;color:var(--text);box-sizing:border-box;transition:border-color .15s" onfocus="this.style.borderColor=\'var(--teal)\'" onblur="this.style.borderColor=\'var(--border)\'" placeholder="Any pending follow-ups or additional notes...">'+(t.followUpDetails||"")+'</textarea></div>';

  // Follow-up required + due date row
  h+='<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">';
  h+='<div style="flex:1;min-width:140px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Follow-up Required?</div>';
  h+='<select id="txModalFUR" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;color:var(--text);font-family:inherit;outline:none;background:var(--surface)">';
  ["","Yes","No"].forEach(function(v){h+='<option value="'+v+'"'+(t.followUpRequired===v?" selected":"")+'>'+( v||"‚Äî select ‚Äî")+'</option>'});
  h+='</select></div>';
  h+='<div style="flex:1;min-width:140px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Due Date</div>';
  h+='<input type="date" id="txModalDue" value="'+(t.dueDate||"")+'" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;color:var(--text);font-family:inherit;outline:none;background:var(--surface)"></div>';
  h+='</div>';

  // Save button + status message
  h+='<div style="display:flex;align-items:center;gap:10px">';
  h+='<button id="txModalSaveBtn" onclick="txModalSave(\''+taskId+'\')" style="padding:9px 24px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s">üíæ Save Changes</button>';
  h+='<span id="txModalMsg" style="font-size:12px;color:var(--muted)"></span>';
  h+='</div>';

  h+='</div>'; // end editable section
  h+='</div></div>'; // end padding + modal
  overlay.innerHTML=h;document.body.appendChild(overlay);
  // Init rich text on editable areas
  initTaskModalRichText(taskId, t);
}


// Init rich text + file section in task modal
function initTaskModalRichText(taskId, t) {
  // Add reassign button next to Assigned To label
  var assignedLabel = document.querySelector('#taskDetailInner .assigned-to-label');
  if (!assignedLabel) {
    // Find by text content - look for the "ASSIGNED TO" span
    var spans = document.querySelectorAll('#taskDetailInner span');
    for (var i = 0; i < spans.length; i++) {
      if (spans[i].textContent === 'Assigned To') {
        var labelParent = spans[i].parentNode;
        if (labelParent && !labelParent.querySelector('.reassign-btn-real')) {
          var rbtn = document.createElement('button');
          rbtn.className = 'reassign-btn-real';
          rbtn.textContent = '‚úè Reassign';
          rbtn.style.cssText = 'padding:2px 8px;font-size:10px;font-weight:700;background:rgba(10,147,150,.1);color:var(--teal);border:1px solid rgba(10,147,150,.2);border-radius:5px;cursor:pointer;font-family:inherit';
          rbtn.onclick = function() { openReassignModal(taskId); };
          labelParent.appendChild(rbtn);
        }
        break;
      }
    }
  }

  // Convert Actions Taken textarea to rich-text-like div
  var actEl = document.getElementById('txModalActions');
  var fuEl = document.getElementById('txModalFollowUp');
  if (actEl) {
    var wrapper = document.createElement('div');
    wrapper.id = 'actWrapper';
    wrapper.innerHTML = buildRichBar('txModalActionsRT') + '<div id="txModalActionsRT" contenteditable="true" style="min-height:80px;max-height:180px;overflow-y:auto;padding:10px 12px;border:1.5px solid var(--border);border-radius:0 0 6px 6px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface);line-height:1.6"></div>';
    var rtFocus=document.getElementById('txModalActionsRT');if(rtFocus){rtFocus.onfocus=function(){this.style.borderColor='var(--teal)'};rtFocus.onblur=function(){this.style.borderColor='var(--border)'}}
    actEl.parentNode.replaceChild(wrapper, actEl);
    var rtEl = document.getElementById('txModalActionsRT');
    if (rtEl && t.actionsTaken) rtEl.innerHTML = t.actionsTaken.replace(/\n/g,'<br>');
  }
  if (fuEl) {
    var wrapper2 = document.createElement('div');
    wrapper2.id = 'fuWrapper';
    wrapper2.innerHTML = buildRichBar('txModalFollowUpRT') + '<div id="txModalFollowUpRT" contenteditable="true" style="min-height:80px;max-height:180px;overflow-y:auto;padding:10px 12px;border:1.5px solid var(--border);border-radius:0 0 6px 6px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface);line-height:1.6"></div>';
    var rtFocus2=document.getElementById('txModalFollowUpRT');if(rtFocus2){rtFocus2.onfocus=function(){this.style.borderColor='var(--teal)'};rtFocus2.onblur=function(){this.style.borderColor='var(--border)'}}
    fuEl.parentNode.replaceChild(wrapper2, fuEl);
    var rtEl2 = document.getElementById('txModalFollowUpRT');
    if (rtEl2 && t.followUpDetails) rtEl2.innerHTML = t.followUpDetails.replace(/\n/g,'<br>');
  }
  // Add file upload section before the save button
  var saveBtn = document.getElementById('txModalSaveBtn');
  if (saveBtn) {
    var fileSection = document.createElement('div');
    fileSection.style.cssText = 'margin-bottom:16px';
    fileSection.innerHTML =
      '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:8px">\uD83D\uDCCE Attachments</div>' +
      '<div id="taskFileList_'+taskId+'" style="margin-bottom:8px">' +
        (t.attachments && t.attachments.length ? t.attachments.map(function(a){
          return '<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:11px">' +
            '<span>\uD83D\uDCC4</span>' +
            '<a href="'+(a.url||'#')+'" target="_blank" style="flex:1;color:var(--teal);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(a.name||a.filename||'File')+'</a>' +
            '<span style="color:var(--muted)">'+(a.size?((a.size/1024).toFixed(0)+'KB'):'')+'</span></div>';
        }).join('') : '<div style="font-size:11px;color:var(--muted);padding:4px 0">No attachments yet</div>') +
      '</div>' +
      '<label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1.5px dashed var(--border);border-radius:6px;cursor:pointer;font-size:11px;color:var(--muted);background:var(--surface)">' +
      '\uD83D\uDCCE Attach files (PDF, images, docs)' +
      '<input type="file" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.csv" style="display:none" onchange="taskUploadFile(\'' + taskId + '\',this)" /></label>';
    saveBtn.parentNode.insertBefore(fileSection, saveBtn);
  }
}

function buildRichBar(targetId) {
  var btn = function(cmd, lbl, style) {
    return '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'' + cmd + '\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit;' + (style||'') + '">' + lbl + '</button>';
  };
  return '<div style="display:flex;gap:2px;padding:4px 6px;background:var(--surface2);border:1.5px solid var(--border);border-bottom:none;border-radius:6px 6px 0 0;flex-wrap:wrap">' +
    btn('bold','<b>B</b>','font-weight:700') +
    btn('italic','<i>I</i>','font-style:italic') +
    btn('underline','<u>U</u>','text-decoration:underline') +
    '<div style="width:1px;background:var(--border);margin:2px 2px"></div>' +
    btn('insertUnorderedList','&#8226; List','') +
    btn('insertOrderedList','1. List','') +
    '</div>';
}

// Status quick-change buttons inside modal
window.txModalStatus=function(taskId,newStatus){
  var t=tasksData.find(function(x){return x.id===taskId});if(!t)return;
  t.status=newStatus;
  if(newStatus==="Completed"&&!t.dateCompleted)t.dateCompleted=new Date().toISOString();
  // Re-render modal
  var overlay=document.getElementById("taskDetailOverlay");if(overlay)overlay.remove();
  openTaskDetailModal(taskId);
};

// Save changes from modal to Airtable
window.txModalSave=function(taskId){
  var t=tasksData.find(function(x){return x.id===taskId});if(!t)return;
  var btn=document.getElementById("txModalSaveBtn");
  var msg=document.getElementById("txModalMsg");
  var actEl=document.getElementById("txModalActionsRT")||document.getElementById("txModalActions");var actions=actEl?(actEl.innerHTML||actEl.value||""):"";
  var fuEl=document.getElementById("txModalFollowUpRT")||document.getElementById("txModalFollowUp");var followUp=fuEl?(fuEl.innerHTML||fuEl.value||""):"";
  var fur=(document.getElementById("txModalFUR")||{}).value||"";
  var due=(document.getElementById("txModalDue")||{}).value||"";
  if(btn){btn.disabled=true;btn.textContent="‚è≥ Saving...";}

  var STATUS_FIELD="Follow Up Status - Not started\n In Progress or Completed";
  var fields={};
  fields[STATUS_FIELD]=t.status;
  fields["Actions taken to Complete task"]=actions;
  fields["Details of follow up"]=followUp;
  if(fur)fields["Is there a follow up required?"]=fur;
  if(due)fields["Due Date for task to be completed"]=due;

  apiCall("PATCH","/api/update-task",{recordId:taskId,fields:fields}).then(function(){
    // Update local data
    t.actionsTaken=actions;t.followUpDetails=followUp;t.followUpRequired=fur;if(due)t.dueDate=due;
    if(msg)msg.innerHTML='<span style="color:var(--green)">‚úÖ Saved to Airtable!</span>';
    if(btn){btn.disabled=false;btn.textContent="üíæ Save Changes";}
    // Refresh table row
    filterTX();
    setTimeout(function(){if(msg)msg.innerHTML=""},3000);
  }).catch(function(e){
    if(msg)msg.innerHTML='<span style="color:var(--red)">‚ùå Failed: '+e.message+'</span>';
    if(btn){btn.disabled=false;btn.textContent="üíæ Save Changes";}
  });
};


// ‚îÄ‚îÄ NEW TASK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openNewTaskModal = function() {
  var existing = document.getElementById('newTaskOverlay'); if(existing) existing.remove();
  var overlay = document.createElement('div');
  overlay.id = 'newTaskOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };

  // Build staff options from contacts
  var staffOpts = '<option value="">Unassigned</option>';
  (contacts||[]).forEach(function(c){
    var ct = (c.contactType||'').toLowerCase();
    if(ct.indexOf('employee')>=0||ct.indexOf('contractor')>=0){
      staffOpts += '<option value="'+(c.id||c.airtable_id||'')+'" data-name="'+(c.name||'')+'">'+(c.name||'')+'</option>';
    }
  });

  // Build client options
  var clientOpts = '<option value="">No client</option>';
  var clientNames = {};
  (tasksData||[]).forEach(function(t){ if(t.clientName) clientNames[t.clientName]=1; });
  Object.keys(clientNames).sort().forEach(function(cn){
    clientOpts += '<option value="'+cn+'">'+cn+'</option>';
  });

  var h = '<div style="background:var(--surface);border-radius:14px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.3)">';
  // Header
  h += '<div style="background:linear-gradient(135deg,#0f172a,#1e3a5f);padding:16px 20px;border-radius:14px 14px 0 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:2">';
  h += '<div style="font-size:15px;font-weight:700;color:#fff">\u{1F4CB} New Task</div>';
  h += '<button onclick="document.getElementById(\'newTaskOverlay\').remove()" style="background:rgba(255,255,255,.1);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px">&#10005;</button></div>';
  h += '<div style="padding:20px;display:flex;flex-direction:column;gap:14px">';

  var inp = 'width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface);box-sizing:border-box';
  var lbl = 'font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:5px;display:block';

  // Task name
  h += '<div><label style="'+lbl+'">Task Name *</label>';
  h += '<input id="ntTaskName" type="text" placeholder="Describe the task..." style="'+inp+'" /></div>';

  // Priority + Status row
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  h += '<div><label style="'+lbl+'">Priority</label>';
  h += '<select id="ntPriority" style="'+inp+'"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option></select></div>';
  h += '<div><label style="'+lbl+'">Status</label>';
  h += '<select id="ntStatus" style="'+inp+'"><option value="Not Started">Not Started</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option></select></div>';
  h += '</div>';

  // Due date
  h += '<div><label style="'+lbl+'">Due Date</label>';
  h += '<input id="ntDueDate" type="date" style="'+inp+'" /></div>';

  // Client
  h += '<div><label style="'+lbl+'">Client (optional)</label>';
  h += '<select id="ntClient" style="'+inp+'">'+clientOpts+'</select></div>';

  // Assign to (multi)
  h += '<div><label style="'+lbl+'">Assign To</label>';
  h += '<select id="ntAssignee" multiple size="4" style="'+inp+';height:auto">'+staffOpts+'</select>';
  h += '<div style="font-size:10px;color:var(--muted);margin-top:4px">Hold Ctrl/Cmd to select multiple</div></div>';

  // Type of update
  h += '<div><label style="'+lbl+'">Type</label>';
  h += '<select id="ntType" style="'+inp+'"><option value="">General</option><option value="Incident">Incident</option><option value="Follow Up">Follow Up</option><option value="Compliance">Compliance</option><option value="Client">Client</option><option value="Staff">Staff</option><option value="Admin">Admin</option></select></div>';

  // Description
  h += '<div><label style="'+lbl+'">Description</label>';
  h += '<textarea id="ntDescription" style="'+inp+';resize:vertical;min-height:80px" placeholder="Detailed description of what needs to be done..."></textarea></div>';

  // Project selector
  h += '<div><label style="'+lbl+'">Add to Project (optional)</label>';
  h += '<select id="ntProject" style="'+inp+'"><option value="">No project</option>';
  (window._projectsData||[]).forEach(function(p){ h += '<option value="'+p.id+'">'+p.name+'</option>'; });
  h += '</select></div>';

  // Buttons
  h += '<div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px;border-top:1px solid var(--border)">';
  h += '<button onclick="document.getElementById(\'newTaskOverlay\').remove()" style="padding:9px 20px;border:1px solid var(--border);background:transparent;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">Cancel</button>';
  h += '<button onclick="submitNewTask()" id="ntSubmitBtn" style="padding:9px 24px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">\u{1F4BE} Create Task</button>';
  h += '</div>';
  h += '<div id="ntMsg" style="font-size:12px;text-align:center"></div>';
  h += '</div></div>';

  overlay.innerHTML = h;
  document.body.appendChild(overlay);
  setTimeout(function(){ var el=document.getElementById('ntTaskName'); if(el) el.focus(); }, 100);
};

window.submitNewTask = function() {
  var name = (document.getElementById('ntTaskName')||{}).value||'';
  if(!name.trim()){ var m=document.getElementById('ntMsg'); if(m) m.innerHTML='<span style="color:var(--red)">Task name is required</span>'; return; }
  var btn = document.getElementById('ntSubmitBtn');
  if(btn){ btn.disabled=true; btn.textContent='\u23F3 Creating...'; }

  // Get selected assignees
  var sel = document.getElementById('ntAssignee');
  var assigneeIds = [];
  var assigneeNames = [];
  if(sel){ for(var i=0;i<sel.options.length;i++){ if(sel.options[i].selected && sel.options[i].value){ assigneeIds.push(sel.options[i].value); assigneeNames.push(sel.options[i].getAttribute('data-name')||sel.options[i].text); } } }

  var payload = {
    taskName: name.trim(),
    priority: (document.getElementById('ntPriority')||{}).value||'Low',
    status: (document.getElementById('ntStatus')||{}).value||'Not Started',
    dueDate: (document.getElementById('ntDueDate')||{}).value||'',
    clientName: (document.getElementById('ntClient')||{}).value||'',
    assigneeIds: assigneeIds,
    assigneeNames: assigneeNames,
    typeOfUpdate: (document.getElementById('ntType')||{}).value||'',
    description: (document.getElementById('ntDescription')||{}).value||'',
    projectId: (document.getElementById('ntProject')||{}). value||'',
    projectName: (function(){ var sel=document.getElementById('ntProject'); if(!sel||!sel.value) return ''; var opt=sel.options[sel.selectedIndex]; return opt?opt.text:''; })()
  };

  apiCall('POST', '/api/tasks', payload).then(function(d){
    if(d && d.id){
      // Add to local data
      tasksData.unshift({ id:d.id, taskName:payload.taskName, priority:payload.priority, status:payload.status,
        dueDate:payload.dueDate, clientName:payload.clientName, assignee:assigneeNames.join(', '),
        typeOfUpdate:payload.typeOfUpdate, description:payload.description, createdDate:new Date().toISOString() });
      document.getElementById('newTaskOverlay').remove();
      renderTasksDashboard();
    } else {
      var m=document.getElementById('ntMsg');
      if(m) m.innerHTML='<span style="color:var(--red)">\u274C '+(d&&d.error?d.error:'Failed to create task')+'</span>';
      if(btn){ btn.disabled=false; btn.textContent='\u{1F4BE} Create Task'; }
    }
  }).catch(function(e){
    var m=document.getElementById('ntMsg');
    if(m) m.innerHTML='<span style="color:var(--red)">\u274C '+e.message+'</span>';
    if(btn){ btn.disabled=false; btn.textContent='\u{1F4BE} Create Task'; }
  });
};

// ‚îÄ‚îÄ REASSIGN MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openReassignModal = function(taskId) {
  var t = tasksData.find(function(x){ return x.id===taskId; }); if(!t) return;
  var existing = document.getElementById('reassignOverlay'); if(existing) existing.remove();
  var overlay = document.createElement('div');
  overlay.id = 'reassignOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };

  var currentNames = (t.assignee||'').split(',').map(function(s){ return s.trim(); }).filter(Boolean);
  var staffOpts = '';
  (contacts||[]).forEach(function(c){
    var ct = (c.contactType||'').toLowerCase();
    var isStaff=ct.indexOf('employee')>=0||ct.indexOf('contractor')>=0||ct.indexOf('independent')>=0||ct.indexOf('support worker')>=0||ct.indexOf('office staff')>=0||ct.indexOf('casual')>=0;
    if(isStaff){
      var isSelected = currentNames.indexOf(c.name||'') >= 0;
      staffOpts += '<option value="'+(c.id||c.airtable_id||'')+'" data-name="'+(c.name||'')+'"'+(isSelected?' selected':'')+'>'+( c.name||'')+'</option>';
    }
  });

  var h = '<div style="background:var(--surface);border-radius:14px;max-width:400px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,.3)">';
  h += '<div style="background:linear-gradient(135deg,#0f172a,#1e3a5f);padding:14px 18px;border-radius:14px 14px 0 0;display:flex;align-items:center;justify-content:space-between">';
  h += '<div style="font-size:14px;font-weight:700;color:#fff">\u{1F465} Reassign Task</div>';
  h += '<button onclick="document.getElementById(\'reassignOverlay\').remove()" style="background:rgba(255,255,255,.1);border:none;color:#fff;width:26px;height:26px;border-radius:50%;cursor:pointer">&#10005;</button></div>';
  h += '<div style="padding:18px">';
  h += '<div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:10px;padding:8px 12px;background:var(--surface2);border-radius:6px">'+(t.taskName||'Task')+'</div>';
  h += '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:6px">Select Staff Members</div>';
  h += '<select id="reassignSelect" multiple size="6" style="width:100%;padding:6px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;outline:none;color:var(--text)">'+staffOpts+'</select>';
  h += '<div style="font-size:10px;color:var(--muted);margin-top:4px;margin-bottom:14px">Hold Ctrl/Cmd to select multiple</div>';
  h += '<div style="display:flex;gap:8px;justify-content:flex-end">';
  h += '<button onclick="document.getElementById(\'reassignOverlay\').remove()" style="padding:8px 16px;border:1px solid var(--border);background:transparent;border-radius:8px;font-size:12px;cursor:pointer;font-family:inherit">Cancel</button>';
  h += '<button onclick="submitReassign(\''+taskId+'\')" style="padding:8px 20px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">Save Assignees</button>';
  h += '</div>';
  h += '<div id="reassignMsg" style="font-size:11px;margin-top:8px;text-align:center"></div>';
  h += '</div></div>';
  overlay.innerHTML = h;
  document.body.appendChild(overlay);
};

window.submitReassign = function(taskId) {
  var t = tasksData.find(function(x){ return x.id===taskId; }); if(!t) return;
  var sel = document.getElementById('reassignSelect');
  var ids = [], names = [];
  if(sel){ for(var i=0;i<sel.options.length;i++){ if(sel.options[i].selected && sel.options[i].value){ ids.push(sel.options[i].value); names.push(sel.options[i].getAttribute('data-name')||sel.options[i].text); } } }
  var msg = document.getElementById('reassignMsg');
  if(msg) msg.innerHTML = '<span style="color:var(--muted)">\u23F3 Saving...</span>';

  apiCall('PATCH', '/api/tasks/'+taskId, { assigneeIds: ids, assigneeNames: names }).then(function(){
    t.assignee = names.join(', ');
    if(msg) msg.innerHTML = '<span style="color:var(--green)">\u2705 Saved!</span>';
    filterTX();
    setTimeout(function(){
      var o=document.getElementById('reassignOverlay'); if(o) o.remove();
      openTaskDetailModal(taskId);
    }, 800);
  }).catch(function(e){
    if(msg) msg.innerHTML = '<span style="color:var(--red)">\u274C '+e.message+'</span>';
  });
};

// ‚îÄ‚îÄ PROJECT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._projectsData = window._projectsData || [];

window.openNewProjectModal = function() {
  var existing = document.getElementById('newProjectOverlay'); if(existing) existing.remove();
  var overlay = document.createElement('div');
  overlay.id = 'newProjectOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };

  var staffOpts = '<option value="">Unassigned</option>';
  (contacts||[]).forEach(function(c){
    var ct = (c.contactType||'').toLowerCase();
    if(ct.indexOf('employee')>=0||ct.indexOf('contractor')>=0)
      staffOpts += '<option value="'+(c.id||c.airtable_id||'')+'" data-name="'+(c.name||'')+'">'+(c.name||'')+'</option>';
  });

  var inp = 'width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface);box-sizing:border-box';
  var lbl = 'font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:5px;display:block';

  var h = '<div style="background:var(--surface);border-radius:14px;max-width:640px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.3)">';
  h += '<div style="background:linear-gradient(135deg,#1e1b4b,#3730a3);padding:16px 20px;border-radius:14px 14px 0 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:2">';
  h += '<div style="font-size:15px;font-weight:700;color:#fff">\u{1F4C1} New Project</div>';
  h += '<button onclick="document.getElementById(\'newProjectOverlay\').remove()" style="background:rgba(255,255,255,.1);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px">&#10005;</button></div>';
  h += '<div style="padding:20px;display:flex;flex-direction:column;gap:14px">';

  // Project name
  h += '<div><label style="'+lbl+'">Project Name *</label>';
  h += '<input id="npName" type="text" placeholder="e.g. Q1 Compliance Review" style="'+inp+'" /></div>';

  // Description
  h += '<div><label style="'+lbl+'">Project Description</label>';
  h += '<textarea id="npDescription" style="'+inp+';resize:vertical;min-height:60px" placeholder="What is this project about?"></textarea></div>';

  // Priority + Due date
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  h += '<div><label style="'+lbl+'">Priority</label>';
  h += '<select id="npPriority" style="'+inp+'"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option></select></div>';
  h += '<div><label style="'+lbl+'">Due Date</label>';
  h += '<input id="npDueDate" type="date" style="'+inp+'" /></div></div>';

  // Project lead
  h += '<div><label style="'+lbl+'">Project Lead</label>';
  h += '<select id="npLead" style="'+inp+'">'+staffOpts+'</select></div>';

  // ‚îÄ‚îÄ Subtasks section ‚îÄ‚îÄ
  h += '<div style="border:1.5px solid var(--border);border-radius:10px;padding:16px">';
  h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">';
  h += '<div style="font-size:12px;font-weight:700;color:var(--text)">\u{1F4CB} Tasks</div>';
  h += '<button onclick="addSubtaskRow()" style="padding:5px 12px;background:var(--teal);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">+ Add Task</button></div>';
  h += '<div id="subtaskList"><div style="text-align:center;padding:12px;color:var(--muted);font-size:12px">Click "+ Add Task" to add tasks to this project</div></div>';
  h += '</div>';

  // Buttons
  h += '<div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px;border-top:1px solid var(--border)">';
  h += '<button onclick="document.getElementById(\'newProjectOverlay\').remove()" style="padding:9px 20px;border:1px solid var(--border);background:transparent;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">Cancel</button>';
  h += '<button onclick="submitNewProject()" id="npSubmitBtn" style="padding:9px 24px;background:#3730a3;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">\u{1F4BE} Create Project</button>';
  h += '</div>';
  h += '<div id="npMsg" style="font-size:12px;text-align:center"></div>';
  h += '</div></div>';

  overlay.innerHTML = h;
  document.body.appendChild(overlay);
  setTimeout(function(){ var el=document.getElementById('npName'); if(el) el.focus(); }, 100);
};

var _subtaskCount = 0;

// ‚îÄ‚îÄ RICH TEXT TOOLBAR helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeRichToolbar(targetId) {
  return '<div style="display:flex;gap:2px;padding:4px 6px;background:var(--surface2);border:1px solid var(--border);border-bottom:none;border-radius:6px 6px 0 0;flex-wrap:wrap">' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'bold\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-weight:700;font-family:inherit" title="Bold"><b>B</b></button>' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'italic\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit;font-style:italic" title="Italic"><i>I</i></button>' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'underline\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit;text-decoration:underline" title="Underline"><u>U</u></button>' +
    '<div style="width:1px;background:var(--border);margin:2px 2px"></div>' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'insertUnorderedList\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit" title="Bullet list">\u2022 List</button>' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'insertOrderedList\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit" title="Numbered list">1. List</button>' +
    '<div style="width:1px;background:var(--border);margin:2px 2px"></div>' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'formatBlock\',false,\'h3\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit;font-weight:700" title="Heading">H</button>' +
    '<button type="button" onmousedown="event.preventDefault();document.execCommand(\'formatBlock\',false,\'p\')" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit" title="Normal text">P</button>' +
    '<div style="width:1px;background:var(--border);margin:2px 2px"></div>' +
    '<button type="button" onmousedown="event.preventDefault();(function(){var url=prompt(\'Link URL:\');if(url)document.execCommand(\'createLink\',false,url);})()" style="padding:3px 7px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;font-family:inherit" title="Link">\u{1F517}</button>' +
    '</div>' +
    '<div id="' + targetId + '" contenteditable="true" style="min-height:100px;padding:10px 12px;border:1.5px solid var(--border);border-radius:0 0 6px 6px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface);line-height:1.6;overflow-y:auto;max-height:200px" onfocus="this.style.borderColor=\'var(--teal)\'" onblur="this.style.borderColor=\'var(--border)\'"></div>';
}

// ‚îÄ‚îÄ SUBTASK ROW with rich text + file upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addSubtaskRow = function() {
  var list = document.getElementById('subtaskList'); if(!list) return;
  var placeholder = list.querySelector('[style*="text-align:center"]');
  if(placeholder) list.innerHTML = '';
  _subtaskCount++;
  var idx = _subtaskCount;

  var staffOpts = '<option value="">Unassigned</option>';
  (contacts||[]).forEach(function(c){
    var ct=(c.contactType||'').toLowerCase();
    if(ct.indexOf('employee')>=0||ct.indexOf('contractor')>=0)
      staffOpts += '<option value="'+(c.id||c.airtable_id||'')+'" data-name="'+(c.name||'')+'">'+(c.name||'')+'</option>';
  });

  var row = document.createElement('div');
  row.id = 'subtask-'+idx;
  row.style.cssText = 'background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:10px;border:1px solid var(--border)';
  row.innerHTML =
    // Row 1: drag handle + name + priority + delete
    '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">' +
    '<span style="color:var(--muted);cursor:grab;font-size:14px;padding:0 2px">\u2630</span>' +
    '<input type="text" placeholder="Task name..." style="flex:1;padding:8px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface)" class="st-name" />' +
    '<select style="padding:8px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:11px;font-family:inherit;outline:none;color:var(--text);background:var(--surface)" class="st-priority"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option></select>' +
    '<button onclick="document.getElementById(\'subtask-'+idx+'\').remove()" style="background:#fee2e2;border:none;color:#dc2626;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;flex-shrink:0" title="Remove task">&#10005;</button></div>' +
    // Row 2: assignee + due date
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">' +
    '<select style="padding:8px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;outline:none;color:var(--text);background:var(--surface)" class="st-assignee">'+staffOpts+'</select>' +
    '<input type="date" style="padding:8px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:11px;font-family:inherit;outline:none;color:var(--text);background:var(--surface)" class="st-due" />' +
    '</div>' +
    // Rich text notes
    '<div style="margin-bottom:10px">' +
    '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:4px">Notes</div>' +
    makeRichToolbar('st-notes-'+idx) +
    '</div>' +
    // File upload
    '<div>' +
    '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);margin-bottom:4px">Attachments</div>' +
    '<label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1.5px dashed var(--border);border-radius:6px;cursor:pointer;font-size:11px;color:var(--muted);background:var(--surface);transition:.2s" onmouseover="this.style.borderColor=\'var(--teal)\';this.style.color=\'var(--teal)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.color=\'var(--muted)\'">' +
    '\u{1F4CE} Click to attach files' +
    '<input type="file" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.csv" style="display:none" class="st-files" onchange="previewSubtaskFiles(this,\'st-file-list-'+idx+'\')" />' +
    '</label>' +
    '<div id="st-file-list-'+idx+'" style="margin-top:6px"></div>' +
    '</div>';

  list.appendChild(row);
};

window.previewSubtaskFiles = function(input, listId) {
  var list = document.getElementById(listId); if(!list) return;
  list.innerHTML = '';
  Array.from(input.files).forEach(function(f){
    var div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:8px;padding:5px 10px;background:var(--surface2);border-radius:6px;margin-bottom:4px;font-size:11px;border:1px solid var(--border)';
    var icon = f.type.indexOf('image')>=0 ? '\u{1F5BC}' : f.name.endsWith('.pdf') ? '\u{1F4C4}' : '\u{1F4CE}';
    div.innerHTML = '<span>'+icon+'</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)">'+f.name+'</span><span style="color:var(--muted)">'+(f.size>1024*1024?(f.size/1024/1024).toFixed(1)+'MB':(f.size/1024).toFixed(0)+'KB')+'</span>';
    list.appendChild(div);
  });
};

// ‚îÄ‚îÄ TASK DETAIL MODAL ‚Äî File upload + Rich text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.taskUploadFile = function(taskId, input) {
  if(!input.files||!input.files.length) return;
  var fileList = document.getElementById('taskFileList_'+taskId);
  Array.from(input.files).forEach(function(file){
    var reader = new FileReader();
    reader.onload = function(e){
      var base64 = e.target.result;
      var div = document.createElement('div');
      div.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;font-size:11px';
      div.innerHTML = '<span>\u23F3</span><span style="flex:1;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+file.name+'</span><span style="color:var(--muted)">Uploading...</span>';
      if(fileList) fileList.appendChild(div);

      apiCall('POST','/api/tasks/'+taskId+'/attachment',{
        filename: file.name,
        mimeType: file.type||'application/octet-stream',
        base64: base64.split(',')[1]||base64,
        size: file.size
      }).then(function(d){
        div.innerHTML = '<span>\u2705</span><a href="'+(d.url||'#')+'" target="_blank" style="flex:1;color:var(--teal);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+file.name+'</a><span style="color:var(--muted)">'+(file.size>1024*1024?(file.size/1024/1024).toFixed(1)+'MB':(file.size/1024).toFixed(0)+'KB')+'</span>';
      }).catch(function(){
        div.innerHTML = '<span>\u274C</span><span style="flex:1;color:var(--text)">'+file.name+'</span><span style="color:var(--red)">Failed</span>';
      });
    };
    reader.readAsDataURL(file);
  });
};




window.submitNewProject = function() {
  var name = (document.getElementById('npName')||{}).value||'';
  if(!name.trim()){ var m=document.getElementById('npMsg'); if(m) m.innerHTML='<span style="color:var(--red)">Project name is required</span>'; return; }
  var btn = document.getElementById('npSubmitBtn');
  if(btn){ btn.disabled=true; btn.textContent='\u23F3 Creating...'; }

  // Collect subtasks
  var subtasks = [];
  document.querySelectorAll('[id^="subtask-"]').forEach(function(row){
    var n = (row.querySelector('.st-name')||{}).value||'';
    if(n.trim()){
      var aEl = row.querySelector('.st-assignee');
      subtasks.push({
        taskName: n.trim(),
        priority: (row.querySelector('.st-priority')||{}).value||'Low',
        assigneeId: aEl ? aEl.value : '',
        assigneeName: aEl ? (aEl.options[aEl.selectedIndex]||{}).getAttribute('data-name')||'' : '',
        dueDate: (row.querySelector('.st-due')||{}).value||'',
        description: (row.querySelector('.st-notes')||{}).value||''
      });
    }
  });

  var leadEl = document.getElementById('npLead');
  var leadName = leadEl ? ((leadEl.options[leadEl.selectedIndex]||{}).getAttribute('data-name')||'') : '';

  var payload = {
    name: name.trim(),
    description: (document.getElementById('npDescription')||{}).value||'',
    priority: (document.getElementById('npPriority')||{}).value||'Low',
    dueDate: (document.getElementById('npDueDate')||{}).value||'',
    leadId: leadEl ? leadEl.value : '',
    leadName: leadName,
    subtasks: subtasks
  };

  apiCall('POST', '/api/projects', payload).then(function(d){
    if(d && (d.id || d.success)){
      // Add to local projects
      window._projectsData = window._projectsData || [];
      window._projectsData.unshift({ id: d.id||'local-'+Date.now(), name: payload.name, description: payload.description,
        priority: payload.priority, dueDate: payload.dueDate, leadName: leadName, subtasks: subtasks, status: 'Active' });
      document.getElementById('newProjectOverlay').remove();
      // Add subtasks to local tasksData
      (d.subtaskIds||[]).forEach(function(si,i){
        if(subtasks[i]) tasksData.unshift({ id:si.id, taskName:subtasks[i].taskName, priority:subtasks[i].priority,
          status:'Not Started', assignee:subtasks[i].assigneeName, dueDate:subtasks[i].dueDate,
          description:subtasks[i].description, projectName:payload.name, createdDate:new Date().toISOString() });
      });
      renderTasksDashboard();
      // Show success
      setTimeout(function(){
        var msg = document.createElement('div');
        msg.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--green);color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:700;z-index:99999;box-shadow:0 4px 16px rgba(0,0,0,.2)';
        msg.textContent = '\u2705 Project "'+payload.name+'" created with '+subtasks.length+' task'+(subtasks.length!==1?'s':'')+'!';
        document.body.appendChild(msg);
        setTimeout(function(){ msg.remove(); }, 3500);
      }, 100);
    } else {
      var m=document.getElementById('npMsg');
      if(m) m.innerHTML='<span style="color:var(--red)">\u274C '+(d&&d.error?d.error:'Failed to create project')+'</span>';
      if(btn){ btn.disabled=false; btn.textContent='\u{1F4BE} Create Project'; }
    }
  }).catch(function(e){
    var m=document.getElementById('npMsg');
    if(m) m.innerHTML='<span style="color:var(--red)">\u274C '+e.message+'</span>';
    if(btn){ btn.disabled=false; btn.textContent='\u{1F4BE} Create Project'; }
  });
};


function filterTasksList(){filterTX()}




// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê AGREEMENT CREATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _agreeClient = null;
var _agreeData = {};

var DCS_LOGO_B64 = "data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCARlB9ADASIAAhEBAxEB/8QAHQABAAMAAwEBAQAAAAAAAAAAAAYHCAQFCQMCAf/EAF8QAQABAgQDAwIOCwsKBgEEAwABAgMEBQYRBxIhCDFBEyIUFxgyN1FVVmF1lLPS0xYjNnFzgYSTlbLRFTVCRlKRoaSlsbQkM1NicnSCg5LDNEOio8HEVCVmwuPwROH/xAAcAQEAAgMBAQEAAAAAAAAAAAAABQYDBAcCCAH/xABIEQEAAQICAwoKCAQFBQEBAAAAAQIDBAURITEGEkFRYXGBkbHRExQVFiI0UlOhwQcyMzVUctLwI6Ky4RdCc4KSQ0RiwvHiJf/aAAwDAQACEQMRAD8AxkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/2Q==";

var DCS_COMPANY = {
  name: "Delta Community Support",
  abn: "24 665 987 622",
  address: "PO Box 7064, Sippy Downs QLD 4556",
  phone: "1300 850 955",
  email: "admin@deltacommunitysupport.com.au",
  website: "www.deltacommunitysupport.com.au",
  registrationNumber: "4-HXRG-1234",
  ndisRegistered: true
};


// Official NDIS Support Catalogue 2025-26 v1.1 (effective 24 Nov 2025)
// Source: ndis.gov.au/providers/pricing-arrangements
// rate = standard national price, remote = Remote area, veryRemote = Very Remote area
var NDIS_CATALOGUE = [
  {code:"01_002_0107_1_1",name:"Assistance With Self-Care Activities - Standard - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:78.81,remote:110.33,veryRemote:118.22},
  {code:"01_003_0107_1_1",name:"Assistance From Live-In Carer",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:0,remote:0,veryRemote:0},
  {code:"01_004_0107_1_1",name:"Assistance with Personal Domestic Activities",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:59.06,remote:82.68,veryRemote:88.59},
  {code:"01_010_0107_1_1",name:"Assistance With Self-Care Activities - Night-Time Sleepover",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:297.6,remote:416.64,veryRemote:446.4},
  {code:"01_011_0107_1_1",name:"Assistance With Self-Care Activities - Standard - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"01_012_0107_1_1",name:"Assistance With Self-Care Activities - Standard - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:156.03,remote:218.44,veryRemote:234.05},
  {code:"01_013_0107_1_1",name:"Assistance With Self-Care Activities - Standard - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:98.83,remote:138.36,veryRemote:148.25},
  {code:"01_014_0107_1_1",name:"Assistance With Self-Care Activities - Standard - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:127.43,remote:178.4,veryRemote:191.15},
  {code:"01_015_0107_1_1",name:"Assistance With Self-Care Activities - Standard - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:77.38,remote:108.33,veryRemote:116.07},
  {code:"01_016_0104_1_1",name:"Specialised Home Based Assistance For A Child",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:59.06,remote:82.68,veryRemote:88.59},
  {code:"01_017_0107_1_1",name:"On-Call Overnight Monitoring-Off Site or Onsite (Includes 1 hour of assistance)",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"01_019_0120_1_1",name:"House or Yard Maintenance",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:56.98,remote:79.77,veryRemote:85.47},
  {code:"01_020_0120_1_1",name:"House Cleaning And Other Household Activities",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:58.03,remote:81.24,veryRemote:87.05},
  {code:"01_021_0120_1_1",name:"Linen Service",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"01_023_0120_1_1",name:"Assistance with the cost of the preparation and delivery of meals",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_026_0115_1_1",name:"Assistance In Living Arrangements (Host Family/Alternative Family Situation)",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:0,remote:0,veryRemote:0},
  {code:"01_027_0115_1_1",name:"Assistance In A Shared Living Arrangement",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"01_045_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:4 - Weekday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:708.75,remote:992.25,veryRemote:1063.13},
  {code:"01_046_0115_1_1",name:"Assistance In Individual Living Arrangement For Person With Complex Needs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"01_049_0104_1_1",name:"Establishment Fee For Personal Care/Participation",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:702.3,remote:983.22,veryRemote:1053.45},
  {code:"01_049_0107_1_1",name:"Establishment Fee For Personal Care/Participation",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:702.3,remote:983.22,veryRemote:1053.45},
  {code:"01_050_0115_1_1",name:"Assistance With Daily Life Tasks Provided In Residential Aged Care Facility",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_051_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:4 - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:860.39,remote:1204.55,veryRemote:1290.59},
  {code:"01_052_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:4 - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1046.03,remote:1464.44,veryRemote:1569.05},
  {code:"01_053_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:4 - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1231.67,remote:1724.34,veryRemote:1847.51},
  {code:"01_054_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:2 - Weekday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1198.69,remote:1678.17,veryRemote:1798.04},
  {code:"01_055_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:2 - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1501.97,remote:2102.76,veryRemote:2252.96},
  {code:"01_056_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:2 - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1873.25,remote:2622.55,veryRemote:2809.88},
  {code:"01_057_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:2 - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:2244.53,remote:3142.34,veryRemote:3366.8},
  {code:"01_058_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:1 - Weekday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:2178.57,remote:3050.0,veryRemote:3267.86},
  {code:"01_059_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:1 - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:2785.13,remote:3899.18,veryRemote:4177.7},
  {code:"01_060_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:1 - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:3527.69,remote:4938.77,veryRemote:5291.54},
  {code:"01_061_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:1 - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:4270.25,remote:5978.35,veryRemote:6405.38},
  {code:"01_062_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:3 - Weekday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:872.06,remote:1220.88,veryRemote:1308.09},
  {code:"01_063_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:3 - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1074.25,remote:1503.95,veryRemote:1611.38},
  {code:"01_064_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:3 - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1321.77,remote:1850.48,veryRemote:1982.66},
  {code:"01_065_0115_1_1",name:"STA And Assistance (Inc. Respite) - 1:3 - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:1569.29,remote:2197.01,veryRemote:2353.94},
  {code:"01_066_0115_1_1",name:"Unplanned onsite shared supports in Specialist Disability Accommodation",category:"Assistance with Daily Life (Includes SIL)",unit:"WK",rate:1542.71,remote:2159.79,veryRemote:2314.07},
  {code:"01_082_0115_1_1",name:"Medium Term Accommodation",category:"Assistance with Daily Life (Includes SIL)",unit:"D",rate:155.68,remote:217.95,veryRemote:233.52},
  {code:"01_134_0117_8_1",name:"Capacity Building and Training in Self-Management and Plan Management",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"01_200_0115_1_1",name:"Assistance With Self-Care Activities in a STA - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"01_201_0115_1_1",name:"Assistance With Self-Care Activities in a STA - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:77.38,remote:108.33,veryRemote:116.07},
  {code:"01_202_0115_1_1",name:"Assistance With Self-Care Activities in a STA - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:98.83,remote:138.36,veryRemote:148.25},
  {code:"01_203_0115_1_1",name:"Assistance With Self-Care Activities in a STA - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:127.43,remote:178.4,veryRemote:191.15},
  {code:"01_204_0115_1_1",name:"Assistance With Self-Care Activities in a STA - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:156.03,remote:218.44,veryRemote:234.05},
  {code:"01_205_0115_1_1",name:"Assistance With Self-Care Activities in a STA - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:78.81,remote:110.33,veryRemote:118.22},
  {code:"01_400_0104_1_1",name:"Assistance With Self-Care Activities - High Intensity - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"01_401_0104_1_1",name:"Assistance With Self-Care Activities - High Intensity - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"01_402_0104_1_1",name:"Assistance With Self-Care Activities - High Intensity - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"01_403_0104_1_1",name:"Assistance With Self-Care Activities - High Intensity - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"01_404_0104_1_1",name:"Assistance With Self-Care Activities - High Intensity - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"01_405_0104_1_1",name:"Assistance With Self-Care Activities - High Intensity - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:85.27,remote:119.38,veryRemote:127.91},
  {code:"01_450_0107_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"01_450_0115_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"01_451_0107_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"01_451_0115_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"01_452_0107_1_1",name:"Intensive and Complex Behaviour Supports - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"01_452_0115_1_1",name:"Intensive and Complex Behaviour Supports - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"01_453_0107_1_1",name:"Intensive and Complex Behaviour Supports - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"01_453_0115_1_1",name:"Intensive and Complex Behaviour Supports - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"01_454_0107_1_1",name:"Intensive and Complex Behaviour Supports - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"01_454_0115_1_1",name:"Intensive and Complex Behaviour Supports - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"01_455_0107_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:85.27,remote:119.38,veryRemote:127.91},
  {code:"01_455_0115_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:85.27,remote:119.38,veryRemote:127.91},
  {code:"01_600_0114_1_1",name:"Delivery of Health Supports by an Enrolled Nurse - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:99.88,remote:139.83,veryRemote:149.82},
  {code:"01_601_0114_1_1",name:"Delivery of Health Supports by an Enrolled Nurse - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:110.18,remote:154.25,veryRemote:165.27},
  {code:"01_602_0114_1_1",name:"Delivery of Health Supports by an Enrolled Nurse - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:142.48,remote:199.47,veryRemote:213.72},
  {code:"01_603_0114_1_1",name:"Delivery of Health Supports by an Enrolled Nurse - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:163.79,remote:229.31,veryRemote:245.69},
  {code:"01_604_0114_1_1",name:"Delivery of Health Supports by an Enrolled Nurse - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:185.08,remote:259.11,veryRemote:277.62},
  {code:"01_605_0114_1_1",name:"Delivery of Health Supports by an Enrolled Nurse - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:112.22,remote:157.11,veryRemote:168.33},
  {code:"01_606_0114_1_1",name:"Delivery of Health Supports by a Registered Nurse - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:123.65,remote:173.11,veryRemote:185.48},
  {code:"01_607_0114_1_1",name:"Delivery of Health Supports by a Registered Nurse - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:136.41,remote:190.97,veryRemote:204.62},
  {code:"01_608_0114_1_1",name:"Delivery of Health Supports by a Registered Nurse - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:176.47,remote:247.06,veryRemote:264.71},
  {code:"01_609_0114_1_1",name:"Delivery of Health Supports by a Registered Nurse - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:202.87,remote:284.02,veryRemote:304.31},
  {code:"01_610_0114_1_1",name:"Delivery of Health Supports by a Registered Nurse - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:229.27,remote:320.98,veryRemote:343.91},
  {code:"01_611_0114_1_1",name:"Delivery of Health Supports by a Registered Nurse - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:138.95,remote:194.53,veryRemote:208.43},
  {code:"01_612_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:143.04,remote:200.26,veryRemote:214.56},
  {code:"01_613_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:157.77,remote:220.88,veryRemote:236.66},
  {code:"01_614_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:204.12,remote:285.77,veryRemote:306.18},
  {code:"01_615_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:234.67,remote:328.54,veryRemote:352.01},
  {code:"01_616_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:265.2,remote:371.28,veryRemote:397.8},
  {code:"01_617_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:160.73,remote:225.02,veryRemote:241.1},
  {code:"01_618_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:169.16,remote:236.82,veryRemote:253.74},
  {code:"01_619_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:186.63,remote:261.28,veryRemote:279.95},
  {code:"01_620_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:241.52,remote:338.13,veryRemote:362.28},
  {code:"01_621_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:277.69,remote:388.77,veryRemote:416.54},
  {code:"01_622_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:313.86,remote:439.4,veryRemote:470.79},
  {code:"01_623_0114_1_1",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:190.12,remote:266.17,veryRemote:285.18},
  {code:"01_624_0114_1_1",name:"Delivery of Health Supports by a Nurse Practitioner - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:176.85,remote:247.59,veryRemote:265.28},
  {code:"01_625_0114_1_1",name:"Delivery of Health Supports by a Nurse Practitioner - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:195.09,remote:273.13,veryRemote:292.64},
  {code:"01_626_0114_1_1",name:"Delivery of Health Supports by a Nurse Practitioner - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:252.51,remote:353.51,veryRemote:378.77},
  {code:"01_627_0114_1_1",name:"Delivery of Health Supports by a Nurse Practitioner - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:290.33,remote:406.46,veryRemote:435.5},
  {code:"01_628_0114_1_1",name:"Delivery of Health Supports by a Nurse Practitioner - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:328.16,remote:459.42,veryRemote:492.24},
  {code:"01_629_0114_1_1",name:"Delivery of Health Supports by a Nurse Practitioner - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:198.75,remote:278.25,veryRemote:298.13},
  {code:"01_650_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Occupational Therapist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"01_653_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Speech Pathologist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"01_661_0128_1_3",name:"Assessment Recommendation Therapy or Training Supports - Occupational Therapist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"01_663_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Podiatrist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"01_663_0128_1_3",name:"Assessment Recommendation Therapy or Training Supports - Podiatrist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"01_665_0128_1_3",name:"Assessment Recommendation Therapy or Training Supports - Speech Pathologist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"01_700_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Psychologist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"01_701_0128_1_3",name:"Assessment Recommendation Therapy or Training Supports - Psychologist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"01_720_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Physiotherapist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:183.99,remote:257.59,veryRemote:275.99},
  {code:"01_721_0128_1_3",name:"Assessment Recommendation Therapy or Training Supports - Physiotherapist",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:183.99,remote:257.59,veryRemote:275.99},
  {code:"01_740_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Other Professional",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"01_741_0128_1_3",name:"Assessment Recommendation Therapy or Training Supports - Other Professional",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"01_760_0118_1_3",name:"Assessment Recommendation Therapy or Training - EC - Dietitian",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"01_760_0128_3_3",name:"Assessment Recommendation Therapy or Training Supports - Dietitian",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"01_799_0102_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0104_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0106_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0107_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0110_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0114_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0115_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0117_8_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0118_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0119_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0120_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0126_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0128_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0129_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0132_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0134_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_799_0135_1_1",name:"Provider travel - non-labour costs",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"01_801_0115_1_1",name:"Assistance in Supported Independent Living - Standard - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"01_802_0115_1_1",name:"Assistance in Supported Independent Living - Standard - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:77.38,remote:108.33,veryRemote:116.07},
  {code:"01_803_0115_1_1",name:"Assistance in Supported Independent Living - Standard - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:78.81,remote:110.33,veryRemote:118.22},
  {code:"01_804_0115_1_1",name:"Assistance in Supported Independent Living - Standard - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:98.83,remote:138.36,veryRemote:148.25},
  {code:"01_805_0115_1_1",name:"Assistance in Supported Independent Living - Standard - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:127.43,remote:178.4,veryRemote:191.15},
  {code:"01_806_0115_1_1",name:"Assistance in Supported Independent Living - Standard - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:156.03,remote:218.44,veryRemote:234.05},
  {code:"01_811_0115_1_1",name:"Assistance in Supported Independent Living - High Intensity - Weekday Daytime",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"01_812_0115_1_1",name:"Assistance in Supported Independent Living - High Intensity - Weekday Evening",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"01_813_0115_1_1",name:"Assistance in Supported Independent Living - High Intensity - Weekday Night",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:85.27,remote:119.38,veryRemote:127.91},
  {code:"01_814_0115_1_1",name:"Assistance in Supported Independent Living - High Intensity - Saturday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"01_815_0115_1_1",name:"Assistance in Supported Independent Living - High Intensity - Sunday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"01_816_0115_1_1",name:"Assistance in Supported Independent Living - High Intensity - Public Holiday",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"01_821_0115_1_1",name:"Assistance in Supported Independent Living - Weekly",category:"Assistance with Daily Life (Includes SIL)",unit:"WK",rate:0,remote:0,veryRemote:0},
  {code:"01_822_0115_1_1",name:"Assistance in Supported Independent Living - Exit Accommodation Permanently",category:"Assistance with Daily Life (Includes SIL)",unit:"WK",rate:0,remote:0,veryRemote:0},
  {code:"01_832_0115_1_1",name:"Assistance in Supported Independent Living - Night-Time Sleepover",category:"Assistance with Daily Life (Includes SIL)",unit:"E",rate:297.6,remote:416.64,veryRemote:446.4},
  {code:"01_850_0106_1_1",name:"Individualised Living Options - Exploration and Design",category:"Assistance with Daily Life (Includes SIL)",unit:"H",rate:100.14,remote:140.19,veryRemote:150.21},
  {code:"01_851_0115_1_1",name:"Individualised Living Options - Support Model",category:"Assistance with Daily Life (Includes SIL)",unit:"WK",rate:0,remote:0,veryRemote:0},
  {code:"02_050_0108_1_1",name:"Specialised Transport To School/Educational Facility/Employment/Community",category:"Transport",unit:"D",rate:0,remote:0,veryRemote:0},
  {code:"02_051_0108_1_1",name:"Transport",category:"Transport",unit:"YR",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_040000111_0103_1_1",name:"Disability-Related Health Consumables - High Cost",category:"Consumables",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"03_040000919_0103_1_1",name:"Disability-Related Health Consumables - Low Cost",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_050903053_0103_1_1",name:"Incontinence Alarms",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_060000911_0135_1_1",name:"Low Cost AT - Prosthetics And Orthotics",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_089_0121_1_1",name:"Auslan Or Signed English Training",category:"Consumables",unit:"H",rate:0,remote:0,veryRemote:0},
  {code:"03_090_0121_1_1",name:"Interpreting And Translating",category:"Consumables",unit:"H",rate:0,remote:0,veryRemote:0},
  {code:"03_090000911_0103_1_1",name:"Low Cost AT - Personal Care And Safety",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_091_0121_1_1",name:"Telephone Or Video Interpreting",category:"Consumables",unit:"H",rate:0,remote:0,veryRemote:0},
  {code:"03_091800084_0103_1_1",name:"Continence - bowel care",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_092100082_0103_1_1",name:"Continence - consumables",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_092400080_0103_1_1",name:"Continence - catheters/sheaths",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_092700081_0103_1_1",name:"Continence - drain/leg bags",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_092700083_0103_1_1",name:"Continence - urinary collection items and accessories",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_093021078_0103_1_1",name:"Continence - reusable/washable personal protection",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_093021079_0103_1_1",name:"Continence - disposable personal protection",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_093040085_0103_1_1",name:"Continence - bed/chair/floor protection",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_120000911_0105_1_1",name:"Low Cost AT - Personal Mobility",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_150930078_0103_1_1",name:"HEN - pump plus accessory - syringe feed",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930079_0103_1_1",name:"HEN - pump plus accessory - non-syringe feed",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930080_0103_1_1",name:"HEN - bolus syringes",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930081_0103_1_1",name:"HEN - gastrostomy devices",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930082_0103_1_1",name:"Additional Extension Sets For Bolus Feeding - 10/Annual",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930083_0103_1_1",name:"Additional Extension Sets For Pump Feeding - 10/Annual",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930084_0103_1_1",name:"HEN - giving sets",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930085_0103_1_1",name:"HEN - containers",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930086_0103_1_1",name:"Additional Bolus Syringes - 100/Annual",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930087_0103_1_1",name:"HEN - water flush syringes",category:"Consumables",unit:"YR",rate:0,remote:0,veryRemote:0},
  {code:"03_150930088_0103_1_1",name:"HEN - Other equipment",category:"Consumables",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"03_220300911_0113_1_1",name:"Low Cost AT - Vision Related AT",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_220600911_0122_1_1",name:"Low Cost AT - Hearing Related AT",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_222100911_0124_1_1",name:"Low Cost AT - Communication Or Cognitive Support",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_501509092_0103_1_1",name:"Repairs and Maintenance - HEN AT",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_710400002_0103_1_1",name:"Disability-Related Health Equipment and Consumables - Set Up/Training",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_710930080_0103_1_1",name:"Delivery - Personal care Safety and Disability-related HealthConsumables",category:"Consumables",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"03_900100155_0130_1_1",name:"Assistance Dog (Including Guide Dog) Ongoing Costs",category:"Consumables",unit:"MON",rate:0,remote:0,veryRemote:0},
  {code:"04_049_0104_1_1",name:"Establishment Fee For Personal Care/Participation",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:702.3,remote:983.22,veryRemote:1053.45},
  {code:"04_049_0125_1_1",name:"Establishment Fee For Personal Care/Participation",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:702.3,remote:983.22,veryRemote:1053.45},
  {code:"04_049_0133_5_1",name:"Establishment Fee For Personal Care/Participation",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:702.3,remote:983.22,veryRemote:1053.45},
  {code:"04_049_0136_1_1",name:"Establishment Fee For Personal Care/Participation",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:702.3,remote:983.22,veryRemote:1053.45},
  {code:"04_102_0125_6_1",name:"Access Community Social and Rec Activ - Standard - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:156.03,remote:218.44,veryRemote:234.05},
  {code:"04_102_0136_6_1",name:"Group Activities - Standard - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"04_103_0125_6_1",name:"Access Community Social and Rec Activ - Standard - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:77.38,remote:108.33,veryRemote:116.07},
  {code:"04_103_0136_6_1",name:"Group Activities - Standard - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:77.38,remote:108.33,veryRemote:116.07},
  {code:"04_104_0125_6_1",name:"Access Community Social and Rec Activ - Standard - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"04_104_0136_6_1",name:"Group Activities - Standard - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:98.83,remote:138.36,veryRemote:148.25},
  {code:"04_105_0125_6_1",name:"Access Community Social and Rec Activ - Standard - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:98.83,remote:138.36,veryRemote:148.25},
  {code:"04_105_0136_6_1",name:"Group Activities - Standard - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:127.43,remote:178.4,veryRemote:191.15},
  {code:"04_106_0125_6_1",name:"Access Community Social and Rec Activ - Standard - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:127.43,remote:178.4,veryRemote:191.15},
  {code:"04_106_0136_6_1",name:"Group Activities - Standard - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:156.03,remote:218.44,veryRemote:234.05},
  {code:"04_210_0125_6_1",name:"Community Social And Recreational Activities",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"04_400_0104_1_1",name:"Access Community Social and Rec Activ - High Intensity - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"04_401_0104_1_1",name:"Access Community Social and Rec Activ - High Intensity - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"04_402_0104_1_1",name:"Access Community Social and Rec Activ - High Intensity - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"04_403_0104_1_1",name:"Access Community Social and Rec Activ - High Intensity - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"04_404_0104_1_1",name:"Access Community Social and Rec Activ - High Intensity - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"04_450_0125_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"04_450_0136_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"04_451_0125_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"04_451_0136_1_1",name:"Intensive and Complex Behaviour Supports - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"04_452_0125_1_1",name:"Intensive and Complex Behaviour Supports - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"04_452_0136_1_1",name:"Intensive and Complex Behaviour Supports - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"04_453_0125_1_1",name:"Intensive and Complex Behaviour Supports - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"04_453_0136_1_1",name:"Intensive and Complex Behaviour Supports - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"04_454_0125_1_1",name:"Intensive and Complex Behaviour Supports - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"04_454_0136_1_1",name:"Intensive and Complex Behaviour Supports - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"04_590_0125_6_1",name:"Activity Based Transport",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_591_0136_6_1",name:"Activity Based Transport",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_592_0104_6_1",name:"Activity Based Transport",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_599_0104_6_1",name:"Centre Capital Cost",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:2.59,remote:3.63,veryRemote:3.89},
  {code:"04_599_0133_5_1",name:"Centre Capital Cost",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:2.59,remote:3.63,veryRemote:3.89},
  {code:"04_599_0136_6_1",name:"Centre Capital Cost",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:2.59,remote:3.63,veryRemote:3.89},
  {code:"04_600_0104_6_1",name:"Group Activities - High Intensity - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:75.98,remote:106.37,veryRemote:113.97},
  {code:"04_601_0104_6_1",name:"Group Activities - High Intensity - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:83.72,remote:117.21,veryRemote:125.58},
  {code:"04_602_0104_6_1",name:"Group Activities - High Intensity - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:106.93,remote:149.7,veryRemote:160.4},
  {code:"04_603_0104_6_1",name:"Group Activities - High Intensity - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:137.87,remote:193.02,veryRemote:206.81},
  {code:"04_604_0104_6_1",name:"Group Activities - High Intensity - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:168.81,remote:236.33,veryRemote:253.22},
  {code:"04_799_0104_6_1",name:"Provider travel - non-labour costs",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_799_0125_6_1",name:"Provider travel - non-labour costs",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_799_0133_5_1",name:"Provider travel - non-labour costs",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_799_0136_6_1",name:"Provider travel - non-labour costs",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"04_801_0133_5_1",name:"Supports in Employment - Weekday Daytime",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"04_802_0133_5_1",name:"Supports in Employment - Weekday Evening",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:77.38,remote:108.33,veryRemote:116.07},
  {code:"04_803_0133_5_1",name:"Supports in Employment - Saturday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:98.83,remote:138.36,veryRemote:148.25},
  {code:"04_804_0133_5_1",name:"Supports in Employment - Sunday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:127.43,remote:178.4,veryRemote:191.15},
  {code:"04_805_0133_5_1",name:"Supports in Employment - Public Holiday",category:"Assistance with Social, Economic and Community Participation",unit:"H",rate:156.03,remote:218.44,veryRemote:234.05},
  {code:"04_821_0133_6_1",name:"Activity Based Transport",category:"Assistance with Social, Economic and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0103_1_2",name:"AT Supplementary Charge - AT Personal Care/Safety",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0105_1_2",name:"AT Supplementary Charge - Personal Mobility or Transfer",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0109_1_2",name:"AT Supplementary Charge - Vehicle modifications",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0112_1_2",name:"AT Supplementary Charge - Recreation including sport",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0113_1_2",name:"AT Supplementary Charge - Vision",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0122_1_2",name:"AT Supplementary Charge - Hearing products",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0123_1_2",name:"AT Supplementary Charge - Household Tasks and Control",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0124_1_2",name:"AT Supplementary Charge - Communication and Information support",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_0002_0135_1_2",name:"AT Supplementary Charge - Prosthesis or Orthosis",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_040312115_0103_1_2",name:"AT Rental - Assistive Products for Respiration Support",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_040312801_0103_1_1",name:"Ventilators - Supplemental Ventilation Support (including CPAP and BPAP)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_040312811_0103_1_1",name:"Ventilators - Invasive Ventilation for Continuous Use",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_040313111_0103_1_1",name:"Ventilator accessory - Filters and/or Humidifiers",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_040321811_0103_1_1",name:"Aspirators",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_040322811_0103_1_1",name:"Cough Assist Machine",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_040609171_0103_1_1",name:"Cyclic Pressure Unit - Replacement Garments and Compression Sleeves",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_040609811_0103_1_1",name:"Circulation Support - Air-Filled Garments and Compression Units",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_043006111_0103_1_2",name:"Cooling Vest - All Sizes",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_043303511_0103_1_2",name:"Postural Support - Air Floatation or Automated Pressure Management",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_043303811_0103_1_2",name:"Postural Support - Foam and/or Gel component system",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_043306002_0103_1_2",name:"Pressure Reduction Mattress - Air Filled Section",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_043306803_0103_1_2",name:"Pressure Reduction Mattress or Overlay - Complete",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_043306804_0103_1_2",name:"Pressure Reduction Mattress or Overlay - High Complexity Need",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_044839811_0103_1_2",name:"Standing Frame - Supports for Standing",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_044839870_0103_1_2",name:"Standing or Walking Frame accessory - Powered Component (including Myoelectric)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_060000115_0135_1_2",name:"AT Rental - Prosthesis and Orthosis",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_060315111_0135_1_2",name:"Orthosis - Cervical and Cranial",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_060318821_0135_1_2",name:"Orthosis - Cervico-Thoraco-Lumbo-Sacral",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_060600111_0135_1_2",name:"Orthosis - Upper Limb - Prefabricated",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_060600821_0135_1_2",name:"Orthosis - Upper Limb - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_060688121_0135_1_2",name:"Orthosis - Dynamic or Lycra - Limb",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061203111_0135_1_2",name:"Orthosis - Foot (all types) or Prefabricated Orthotic Footwear",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061203821_0135_1_2",name:"Orthosis - Footwear/Shoes Other - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061206111_0135_1_2",name:"Orthosis - Ankle Foot (AFO) - Prefabricated",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061206821_0135_1_2",name:"Orthosis - Ankle Foot (AFO) - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061206891_0135_1_2",name:"Orthosis - Ankle Foot with Ankle Joints - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061209111_0105_1_2",name:"Orthosis - Knee - Prefabricated",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061209121_0135_1_2",name:"Orthosis - Knee - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061209821_0135_1_2",name:"Orthosis - Thigh Knee Ankle - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061212821_0135_1_2",name:"Orthosis - Knee Ankle Foot - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061215111_0105_1_2",name:"Orthosis - Hip - Prefabricated",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061218811_0135_1_2",name:"Orthosis - Bilateral Hip Knee Ankle Foot Orthosis (incl RGO) - Prefabricated",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061218821_0135_1_2",name:"Orthosis - Hip Thigh Knee Ankle - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061219821_0135_1_2",name:"Orthosis - Bilateral Thoraco-lumbar/Lumbo-Sacral Hip Knee Ankle Foot - Custom",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061290821_0135_1_2",name:"Orthosis - Dynamic or Lycra - Full Body",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061500811_0135_1_2",name:"Orthosis - Trunk/Lower Body - FES or Powered - to supportstanding/walking",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061800121_0135_1_2",name:"Prosthesis - Upper Limb (Including Powered)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_061826871_0135_1_2",name:"Prosthesis - Accessory - Arm and Hand for Sport and Leisure",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_062200921_0135_1_2",name:"Prosthesis - Osseo-Integration Mounting (Upper or Lower) - Additional Cost",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_062409121_0135_1_2",name:"Prosthesis - Transtibial or Lower",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_062415121_0135_1_2",name:"Prosthesis - Transfemoral or Higher",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_062488034_0135_1_2",name:"Prosthesis - Lower Limb - Not Defined",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_062488121_0135_1_2",name:"Prosthesis - Specialist Lower Limb For Sports",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_062490191_0135_1_2",name:"Prosthesis - For Wet Area Use (i.e. waterproofing) - Additional Cost",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_063000821_0135_1_2",name:"Prosthesis - Not Limb Related",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_090000155_0103_1_2",name:"AT Rental - Personal Care and Safety",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_091200111_0103_1_2",name:"Toilet Attachments and Accessories - Seat/Toilet Raiser/Toileting Bidet",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_091203053_0103_1_2",name:"Shower Commode - Wheeled - Low Transporter",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_091203811_0103_1_2",name:"Shower Commode - Wheeled",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_091203821_0103_1_2",name:"Shower Commode - Wheeled - High High Intensityity need",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_091203891_0103_1_2",name:"Shower Commode - Wheeled - Tilt In Space",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_093305121_0103_1_2",name:"Bathing Support - Special Design",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_093312811_0103_1_2",name:"Change Table/Shower Trolley - Manual",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_093312891_0103_1_2",name:"Change Table/Shower Trolley - Powered",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120000115_0105_1_2",name:"AT Rental - Personal Mobility and Transfer",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_120000115_0105_1_2",name:"AT Rental - Personal Mobility and Transfer",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_120303111_0105_1_2",name:"Walking Supports - Sticks Canes And Crutches",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120603831_0103_1_2",name:"Standing and/or Walking Frame - Child",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120606096_0105_1_2",name:"Wheeled Walker - Standard",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120606097_0105_1_2",name:"Rollator - Standard",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120606811_0105_1_2",name:"Walking Frame or Walker",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120606831_0105_1_2",name:"Rollator - Standard - Child",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_120612100_0105_1_2",name:"Walking Tables",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121205811_0109_1_2",name:"Vehicle Modification - Adaptions for Driver Control",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121208111_0109_1_2",name:"Vehicle Modification - Adaptions For Ancillary Functions e.g. Lights Locking",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121209821_0109_1_2",name:"Vehicle Modification - For Seating and/or Seat Belts",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121212811_0103_1_2",name:"Specialised Child Car Seats - no Vehicle Modification Required",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121215811_0109_1_2",name:"Vehicle Modification - Hoist for Passenger Loading (without Wheelchair)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121218811_0109_1_2",name:"Vehicle Modification - Hoist for Occupied Wheelchair Loading",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121221811_0109_1_2",name:"Vehicle Modification - Hoist/Ramp for Unoccupied Wheelchair Loading",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121221811_0109_1_2",name:"Vehicle Modification - Hoist/Ramp for Unoccupied Wheelchair Loading",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121227121_0109_1_2",name:"Vehicle Modification - Chassis/Body work - For Wheelchair Passenger",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121227125_0108_1_2",name:"AT Rental - Vehicle modified for Access",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121227221_0109_1_2",name:"Vehicle Modification - Chassis/Body work - For Wheelchair Seated Driver",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121230811_0109_1_2",name:"Vehicle Accessory -Trailer for wheeled mobility device",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121290111_0109_1_2",name:"Vehicle Modification - Engineers Certification",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121800821_0112_1_2",name:"Bicycle - Tricycle and/or Carts",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121805111_0112_1_2",name:"Bicycle - Adapted FOR Hand Propulsion",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_121821871_0112_1_2",name:"Bicycle - Adaptation for Pedals/Seat/Handle Bars",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122203811_0105_1_2",name:"Wheelchair - Manual - Folding \u2013 Basic",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122203821_0105_1_2",name:"Wheelchair - Manual - Folding - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122203891_0105_1_2",name:"Wheelchair - Manual - Tilt In Space",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122203911_0105_1_2",name:"Wheelchair - Manual - Rigid Frame",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122218111_0105_1_2",name:"Wheelchair - Manual - Attendant Propel - Custom Folding/Rigid Frame",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122290811_0105_1_2",name:"Wheelchair - Manual - Sport and Recreation Use",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122303811_0105_1_2",name:"Scooter - Indoor/Outdoor use",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122303891_0105_1_2",name:"Scooter - Heavy Duty/Robust Activity Specific",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122303911_0105_1_2",name:"Scooter - Electric Powered \u2013 Portable",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122303991_0105_1_2",name:"Scooter - Small Folding/Travel Light-Weight",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122306139_0105_1_2",name:"Wheelchair - Powered - With Powered Standing Mechanism",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122306191_0105_1_2",name:"Wheelchair - Powered - All Terrain/Heavy Duty Base (WITHOUT Seating)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122306811_0105_1_2",name:"Wheelchair - Powered Base with or without Tilt - Indoor/Outdoor use",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122306824_0105_1_2",name:"Wheelchair - Powered Base - Portable/Folding",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122403811_0105_1_2",name:"Wheelchair Accessory - Powered Alternate Operator Control System",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122409871_0105_1_2",name:"Wheelchair Accessory - Power-Assist Drive Technology",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122442871_0105_1_2",name:"Wheelchair Accessory - Health-Related AT/Ventilator Carrier",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122490811_0105_1_2",name:"Wheelchair Accessory - Powered Adjustment for Limbs or Recline orElevate",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122500821_0105_1_2",name:"Postural Support - Seating System - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122503111_0105_1_2",name:"Postural Support - Positioning - Back",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122506111_0105_1_2",name:"Postural Support - Positioning - Seat",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122524111_0105_1_2",name:"Postural Support - Wheelchair Accessory",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122524811_0105_1_2",name:"Postural Support - Seating Componentry and Accessories",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122707821_0105_1_2",name:"Stroller/Pram/Buggy with Specialised Seating system",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122707831_0105_1_2",name:"Stroller/Pram/Buggy/Push Chair with Supportive Seating",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122707931_0105_1_2",name:"Wheeled base - paediatric - height adaptable for seating",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_122715831_0105_1_2",name:"Crawlers/Mobility Boards/Trolley",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_123603811_0105_1_2",name:"Transfer AT - Mobile Hoist including Slings (x2)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_123606868_0105_1_2",name:"Transfer AT - Mobile Hoist Seat or Table",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_123612811_0105_1_2",name:"Transfer AT - Pool Environment Hoist",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_123612891_0105_1_2",name:"Transfer AT - Ceiling Hoist",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_123621111_0105_1_2",name:"Transfer AT - Sling Standard",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_123621121_0105_1_2",name:"Transfer AT - Sling Non-Standard",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_150000115_0123_1_2",name:"AT Rental - Assistive Products for Household Tasks",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_174_0119_1_2",name:"Hearing Services Program - Adults With High Intensity Needs (AH Only)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_177_0119_1_2",name:"Hearing Services Program - Child Under 4 Yrs (AH Only)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_180315111_0103_1_2",name:"Bed - Ancillary Furniture",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_180909811_0103_1_2",name:"Specialised Seating with Sit-Stand Assistance",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_180915811_0103_1_2",name:"Specialised Lounge Chair - Mobile with Pressure Management/PositioningSystems",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_180921821_0103_1_2",name:"Specialised Static Seating with Pressure Management and/or PosturalSupport",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_180939882_0105_1_2",name:"Postural Support - Modular Seating Systems",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_181200711_0103_1_2",name:"Bed - Access/Transfer Pole/Blocks/Rails/Rail-Covers",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_181207811_0103_1_2",name:"Bed - Manually adjusted",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_181210811_0103_1_2",name:"Bed - Electrically adjusted",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_181224811_0103_1_2",name:"Sleep Positioning System and Accessories - Custom Made",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_181800111_0103_2_2",name:"Home Safety -  Slip Resistance Coating/Grab and/or Guide Rails",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_183015811_0103_2_2",name:"Ramp - portable for access needs",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220300115_0113_1_2",name:"AT Rental - Vision support or alternate access",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_220318811_0113_1_2",name:"Vision - Electronic Video Magnifier",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220321811_0113_1_2",name:"Vision - Image Enlargement Software",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220600112_0122_1_2",name:"AT Rental - Hearing Devices and Accessories",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_220615111_0122_1_2",name:"Hearing device - Standard level",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220615211_0122_1_2",name:"Hearing device - Intermediate level",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220615811_0122_1_2",name:"Hearing device - Advanced level",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220618811_0122_1_2",name:"Hearing device - Non-Standard",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220621811_0122_1_2",name:"Hearing device - External speech processor and accessories",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220625247_0122_1_2",name:"Hearing accessory - Induction Loop",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220627171_0122_1_2",name:"Hearing accessory - Remote Control",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220627232_0122_1_2",name:"Hearing accessory - TV function",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220627271_0122_1_2",name:"Hearing accessory - Music device",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220627811_0122_1_2",name:"Hearing device - Personal Amplifiers/Binaural Listener",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_220906234_0124_1_2",name:"Voice Amplifiers For Personal Use",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_221300111_0103_1_2",name:"Communication and Information AT - Computer/device interfaces",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_221315254_0124_1_2",name:"Communication AT - Simple Button or Keys with Voice Output",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_221315811_0124_1_2",name:"Communication - Face to Face - Electronic",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_221315880_0124_1_2",name:"Personal Reader - Speech and Visual Output",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_221321879_0124_1_2",name:"Personal Reader - Speech Output only",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_221336811_0113_1_2",name:"Vision - Braille device",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222100111_0124_1_2",name:"Communication AT: Non-Electronic Devices Books or Tools for face to face",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222100115_0124_1_2",name:"AT Rental - Communication and Computer access",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_222102111_0124_1_2",name:"Communication AT - Software/Related Items for Computer/Tablet/Phone \u2013 Advanced",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222102811_0124_1_2",name:"Computer Tablet or Smartphone - with critical sensory or cognitive apps",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222106253_0124_1_2",name:"Communication - Amplifiers",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222106843_0122_1_2",name:"Hearing accessory - Remote Microphone System",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222404225_0122_1_2",name:"Hearing device - Specialised Landline Telephone",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222404258_0113_1_2",name:"Vision - Mobile Phone with special functionality",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222421111_0111_2_2",name:"Home Adaptation/Access AT - Not Otherwise Described",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_222903111_0123_1_2",name:"Adapted Devices for Phone Access/Alarms/Clocks/Programmable Memory Devices",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222903266_0122_1_2",name:"Hearing device - Baby Alert Systems",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222906111_0103_1_2",name:"Safety Device - Seizure Mat/Location Alert - Alarm System",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222909111_0103_1_2",name:"Safety Device - Flashing or Vibrating Doorbell/Smoke Alert/PersonalAlarms",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_222909111_0123_1_2",name:"Safety Device - Adapted Smoke Detector/Doorbells",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_223906811_0113_1_2",name:"Vision - Alternate format Printer",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_223907278_0124_1_2",name:"Vision - Portable Audible Player for Read Content",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_223912811_0113_1_2",name:"Vision - Print Disability Software",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_224506811_0113_1_2",name:"Vision - Visual Navigation AT",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_241303121_0123_1_2",name:"Environmental Control (Ecu)/ Safety-Related Products",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_241327891_0124_1_2",name:"Communication or ICT AT - Complex need interface - Eye or EMG/neural Control",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_242400811_0103_1_2",name:"Device Positioning / Mounting Systems - Technology / other",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_300000111_0112_1_2",name:"Assisitive Products - Recreation and Sport not otherwise defined",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_300000115_0112_1_2",name:"AT Rental - Modified for accessible recreation",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_300309811_0112_1_2",name:"Recreation AT - Game Interface",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_500000303_0103_1_2",name:"Repairs and Maintenance - Other AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_500403159_0103_1_1",name:"Repairs and Maintenance - Disability-Related Health Machines",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_500433443_0103_1_2",name:"Repairs and Maintenance - Personal Care/Safety After-Hours",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_500612441_0135_1_2",name:"Repairs and Maintenance - Orthosis",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_500624304_0135_1_2",name:"Repairs and Maintenance - Prosthesis - Minor",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_500624305_0135_1_2",name:"Repairs and Maintenance - Prosthesis - Major",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_500933306_0103_1_2",name:"Repairs and Maintenance - Bathing And Toileting AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_501200307_0105_1_2",name:"Repairs and Maintenance - Wheeled Mobility Minor",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_501200308_0105_1_2",name:"Repairs and Maintenance - Wheeled Mobility Major",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_501212373_0109_1_2",name:"Repairs and Maintenance - Vehicle Modification",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_501224309_0105_1_2",name:"Tyre - Wheeled mobility",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_501224310_0105_1_2",name:"Wheelchair or Scooter - Battery or Charger",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_501236025_0105_1_2",name:"Repairs and Maintenance - Transfer AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_501288435_0105_1_2",name:"Repairs and Maintenance \u2013 Mobility and Transfer - After-Hours",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_501812311_0103_1_2",name:"Repairs and Maintenance - Electric Bed",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_502200312_0124_1_2",name:"Repairs and Maintenance - Communication Cognitive or ECU AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_502206151_0122_1_2",name:"Repairs and Maintenance - Hearing AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_502218315_0113_1_2",name:"Repairs and Maintenance - Vision AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_503000316_0112_1_2",name:"Repairs and Maintenance - Specialised Recreation AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_702288440_0124_1_2",name:"Programming/Customisation - For Electronic Equipment",category:"Assistive Technology",unit:"H",rate:0,remote:0,veryRemote:0},
  {code:"05_711000080_0103_1_2",name:"Delivery - Personal Care and Safety AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0105_1_2",name:"Delivery - Personal Mobility and Transfer AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0109_1_2",name:"Delivery - Vehicle modifications AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0112_1_2",name:"Delivery - Recreation AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0113_1_2",name:"Delivery - Vision AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0119_1_2",name:"Delivery - Specialised Hearing AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0122_1_2",name:"Delivery - Hearing AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0123_1_2",name:"Delivery - Household Tasks or Control AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0124_1_2",name:"Delivery - Communication and Information AT",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_711000080_0135_1_2",name:"Delivery - Prosthesis or Orthosis",category:"Assistive Technology",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"05_800188834_0103_1_2",name:"Early Childhood Flexible AT Package 1",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_800288834_0103_1_2",name:"Early Childhood Flexible AT Package 2",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_800388834_0103_1_2",name:"Early Childhood Flexible AT Package 3",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_801288834_0103_1_2",name:"Flexible AT Package - For Changing Need",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"05_900101111_0130_1_2",name:"Assistance Dog (Including Dog Guide)",category:"Assistive Technology",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_123615401_0111_2_2",name:"HM - Ceiling Hoist",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_180000111_0111_2_2",name:"HM Rental - Bathroom Toilet Ramp",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182100401_0111_2_2",name:"MHM - Electrical and Door Automation",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182409401_0111_2_2",name:"MHM - External Door",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182409402_0111_2_2",name:"MHM - Internal Door",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182415401_0111_2_2",name:"MHM - Flooring",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182488377_0111_2_2",name:"HM - Bathroom/Toilet - Structural work",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182488378_0111_2_2",name:"HM - Kitchen or Laundry - Structural Work",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182490112_0111_2_2",name:"HM - Building Works Project Management",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182495121_0111_2_2",name:"CHM - Deposit",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182495221_0111_2_2",name:"CHM - Progress Stage",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182495321_0111_2_2",name:"CHM - Practical Completion",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182495322_0111_2_2",name:"MHM - Practical Completion",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495401_0111_2_2",name:"MHM - Bathroom",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495402_0111_2_2",name:"MHM - Kitchen",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495405_0111_2_2",name:"MHM - Laundry",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495407_0111_2_2",name:"MHM - Other works including Bedroom",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495413_0111_2_2",name:"MHM - Toilet Replacement",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495414_0111_2_2",name:"MHM - Cabinetry Alterations",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_182495421_0111_2_2",name:"HM - Certification and Compliance Approval",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_182499311_0111_2_2",name:"HM - Design Consultation with Builder",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_183003384_0111_2_2",name:"HM - Elevator",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_183010387_0111_2_2",name:"HM - Stair Climber or Stair / Platform Lift",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_183018404_0111_2_2",name:"MHM - Ramp",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_183018405_0111_2_2",name:"HM - Ramp - Structural",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_183090401_0111_2_2",name:"MHM - Pathway - External",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_270303401_0111_2_2",name:"MHM - Airconditioning",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"06_431_0131_2_2",name:"Specialist Disability Accommodation (SDA) - Quotable Amount",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"06_432_0131_2_2",name:"SDA Vacancy - Person-Specific Adjustment",category:"Home Modifications and Specialised Disability Accommodation (SDA)",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"07_001_0106_8_3",name:"Support Coordination Level 1: Support Connection",category:"Support Coordination",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"07_002_0106_8_3",name:"Support Coordination Level 2: Coordination of Supports",category:"Support Coordination",unit:"H",rate:100.14,remote:140.19,veryRemote:150.21},
  {code:"07_004_0132_8_3",name:"Support Coordination Level 3: Specialist Support Coordination",category:"Support Coordination",unit:"H",rate:190.54,remote:266.75,veryRemote:285.8},
  {code:"07_101_0106_6_3",name:"Psychosocial Recovery Coaching - Weekday Daytime",category:"Support Coordination",unit:"H",rate:105.43,remote:147.6,veryRemote:158.15},
  {code:"07_102_0106_6_3",name:"Psychosocial Recovery Coaching - Weekday Evening",category:"Support Coordination",unit:"H",rate:116.16,remote:162.62,veryRemote:174.24},
  {code:"07_103_0106_6_3",name:"Psychosocial Recovery Coaching - Weekday Night",category:"Support Coordination",unit:"H",rate:118.31,remote:165.63,veryRemote:177.47},
  {code:"07_104_0106_6_3",name:"Psychosocial Recovery Coaching - Saturday",category:"Support Coordination",unit:"H",rate:148.36,remote:207.7,veryRemote:222.54},
  {code:"07_105_0106_6_3",name:"Psychosocial Recovery Coaching - Sunday",category:"Support Coordination",unit:"H",rate:191.29,remote:267.81,veryRemote:286.94},
  {code:"07_106_0106_6_3",name:"Psychosocial Recovery Coaching - Public Holiday",category:"Support Coordination",unit:"H",rate:234.23,remote:327.92,veryRemote:351.35},
  {code:"07_501_0106_6_3",name:"Activity Based Transport",category:"Support Coordination",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"07_799_0106_6_3",name:"Provider travel - non-labour costs",category:"Support Coordination",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"07_799_0117_8_3",name:"Provider travel - non-labour costs",category:"Support Coordination",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"07_799_0132_8_3",name:"Provider travel - non-labour costs",category:"Support Coordination",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"08_005_0106_2_3",name:"Assistance With Accommodation And Tenancy Obligations",category:"Improved Living Arrangements",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"08_590_0106_2_3",name:"Activity Based Transport",category:"Improved Living Arrangements",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"08_799_0106_2_3",name:"Provider travel - non-labour costs",category:"Improved Living Arrangements",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"09_006_0106_6_3",name:"Life Transition Planning Incl. Mentoring Peer-Support And Indiv Skill Develop",category:"Increased Social and Community Participation",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"09_008_0116_6_3",name:"Innovative Community Participation",category:"Increased Social and Community Participation",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"09_009_0117_6_3",name:"Skills Development And Training",category:"Increased Social and Community Participation",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"09_011_0125_6_3",name:"Community Participation Activities",category:"Increased Social and Community Participation",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"09_590_0106_6_3",name:"Activity Based Transport",category:"Increased Social and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"09_591_0117_6_3",name:"Activity Based Transport",category:"Increased Social and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"09_799_0106_6_3",name:"Provider travel - non-labour costs",category:"Increased Social and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"09_799_0117_6_3",name:"Provider travel - non-labour costs",category:"Increased Social and Community Participation",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"10_002_0106_8_3",name:"Support Coordination Level 2: Coordination of Supports",category:"Finding and Keeping a Job",unit:"H",rate:100.14,remote:140.19,veryRemote:150.21},
  {code:"10_011_0128_5_3",name:"Employment Related Assessment, Counselling and Advice  - Other Professional",category:"Finding and Keeping a Job",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"10_016_0102_5_3",name:"Employment Assistance",category:"Finding and Keeping a Job",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"10_021_0102_5_3",name:"School Leaver Employment Supports",category:"Finding and Keeping a Job",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"10_054_0128_5_3",name:"Employment Related  Assessment, Counselling and Advice - Psychologist",category:"Finding and Keeping a Job",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"10_055_0128_5_3",name:"Employment Related  Assessment, Counselling and Advice - Physiotherapist",category:"Finding and Keeping a Job",unit:"H",rate:183.99,remote:257.59,veryRemote:275.99},
  {code:"10_101_0106_6_3",name:"Psychosocial Recovery Coaching - Weekday Daytime",category:"Finding and Keeping a Job",unit:"H",rate:105.43,remote:147.6,veryRemote:158.15},
  {code:"10_590_0102_5_3",name:"Activity Based Transport",category:"Finding and Keeping a Job",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"10_590_0133_5_3",name:"Activity Based Transport",category:"Finding and Keeping a Job",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"10_599_0133_5_3",name:"Centre Capital Cost",category:"Finding and Keeping a Job",unit:"H",rate:2.59,remote:3.63,veryRemote:3.89},
  {code:"10_613_0128_5_3",name:"Employment Related  Assessment, Counselling and Advice - Developmental Educator",category:"Finding and Keeping a Job",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"10_617_0128_5_3",name:"Employment Related  Assessment, Counselling and Advice - Occupational Therapist",category:"Finding and Keeping a Job",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"10_620_0128_5_3",name:"Employment Related  Assessment, Counselling and Advice - Rehabilitation Counsellor",category:"Finding and Keeping a Job",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"10_622_0128_5_3",name:"Employment Related  Assessment, Counselling and Advice - Speech Pathologist",category:"Finding and Keeping a Job",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"10_799_0102_5_3",name:"Provider travel - non-labour costs",category:"Finding and Keeping a Job",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"10_799_0128_5_3",name:"Provider travel - non-labour costs",category:"Finding and Keeping a Job",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"10_799_0133_5_3",name:"Provider travel - non-labour costs",category:"Finding and Keeping a Job",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"10_806_0133_5_1",name:"Supports in Employment - Weekday Daytime",category:"Finding and Keeping a Job",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"11_022_0110_7_3",name:"Specialist Behavioural Intervention Support",category:"Improved Relationships",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"11_023_0110_7_3",name:"Behaviour Management Plan Including Training in Behaviour Management Strategies",category:"Improved Relationships",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"11_024_0117_7_3",name:"Individual Social Skills Development",category:"Improved Relationships",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"11_590_0117_7_3",name:"Activity Based Transport",category:"Improved Relationships",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"11_799_0110_7_3",name:"Provider travel - non-labour costs",category:"Improved Relationships",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"11_799_0117_7_3",name:"Provider travel - non-labour costs",category:"Improved Relationships",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"12_025_0128_3_3",name:"Advice provided by a Dietitian on managing diet for health and well-being",category:"Improved Health and Wellbeing",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"12_027_0126_3_3",name:"Advice provided by an Exercise Physiologist regarding exercise required",category:"Improved Health and Wellbeing",unit:"H",rate:166.99,remote:233.79,veryRemote:250.49},
  {code:"12_027_0128_3_3",name:"Advice provided by an Exercise Physiologist regarding exercise required",category:"Improved Health and Wellbeing",unit:"H",rate:166.99,remote:233.79,veryRemote:250.49},
  {code:"12_029_0126_3_3",name:"Personal training provided by a Personal Trainer to a participant",category:"Improved Health and Wellbeing",unit:"H",rate:67.0,remote:93.8,veryRemote:100.5},
  {code:"12_799_0126_3_3",name:"Provider travel - non-labour costs",category:"Improved Health and Wellbeing",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"12_799_0128_3_3",name:"Provider travel - non-labour costs",category:"Improved Health and Wellbeing",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"13_030_0102_4_3",name:"Transition Through School And To Further Education",category:"Improved Learning",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"13_590_0102_4_3",name:"Activity Based Transport",category:"Improved Learning",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"13_799_0102_4_3",name:"Provider travel - non-labour costs",category:"Improved Learning",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"14_034_0127_8_3",name:"Plan Management - Monthly Fee",category:"Improved Life Choices",unit:"MON",rate:104.45,remote:104.45,veryRemote:104.45},
  {code:"14_799_0127_8_3",name:"Provider travel - non-labour costs",category:"Improved Life Choices",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_001_0118_1_3",name:"Early Childhood Intervention Professional - Psychologist",category:"Improved Daily Living Skills",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"15_003_0118_1_3",name:"Early Childhood Intervention Professional - Physiotherapist",category:"Improved Daily Living Skills",unit:"H",rate:183.99,remote:257.59,veryRemote:275.99},
  {code:"15_005_0118_1_3",name:"Early Childhood Intervention Professional - Other Early Childhood Professional",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_007_0118_1_3",name:"Early Childhood Intervention Professional - Therapy Assistant - Level 1",category:"Improved Daily Living Skills",unit:"H",rate:56.16,remote:78.62,veryRemote:84.24},
  {code:"15_008_0118_1_3",name:"Early Childhood Intervention Professional - Therapy Assistant - Level 2",category:"Improved Daily Living Skills",unit:"H",rate:86.79,remote:121.51,veryRemote:130.19},
  {code:"15_035_0106_1_3",name:"Assistance With Decision Making Daily Planning and Budgeting",category:"Improved Daily Living Skills",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"15_037_0117_1_3",name:"Skill Development And Training\u00a0including Public Transport Training",category:"Improved Daily Living Skills",unit:"H",rate:70.23,remote:98.32,veryRemote:105.35},
  {code:"15_038_0117_1_3",name:"Training For Carers/Parents",category:"Improved Daily Living Skills",unit:"H",rate:80.06,remote:112.08,veryRemote:120.09},
  {code:"15_043_0128_1_3",name:"Assessment Recommendation Therapy or Training - Counsellor",category:"Improved Daily Living Skills",unit:"H",rate:156.16,remote:218.62,veryRemote:234.24},
  {code:"15_045_0128_1_3",name:"Community Engagement Assistance",category:"Improved Daily Living Skills",unit:"H",rate:51.2,remote:71.68,veryRemote:76.8},
  {code:"15_046_0129_1_3",name:"Specialised Driver Training",category:"Improved Daily Living Skills",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"15_047_0135_1_3",name:"Selection And/or Manufacture Of Customised Or Wearable Technology",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_049_0128_1_3",name:"Multidisciplinary Team",category:"Improved Daily Living Skills",unit:"E",rate:0,remote:0,veryRemote:0},
  {code:"15_052_0128_1_3",name:"Therapy Assistant - Level 1",category:"Improved Daily Living Skills",unit:"H",rate:56.16,remote:78.62,veryRemote:84.24},
  {code:"15_053_0128_1_3",name:"Therapy Assistant - Level 2",category:"Improved Daily Living Skills",unit:"H",rate:86.79,remote:121.51,veryRemote:130.19},
  {code:"15_054_0128_1_3",name:"Assessment Recommendation Therapy or Training - Psychologist",category:"Improved Daily Living Skills",unit:"H",rate:232.99,remote:326.19,veryRemote:349.49},
  {code:"15_055_0128_1_3",name:"Assessment Recommendation Therapy or Training - Physiotherapist",category:"Improved Daily Living Skills",unit:"H",rate:183.99,remote:257.59,veryRemote:275.99},
  {code:"15_056_0128_1_3",name:"Assessment Recommendation Therapy or Training - Other Professional",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_062_0118_1_3",name:"Early Childhood Intervention Professional - Dietitian",category:"Improved Daily Living Skills",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"15_062_0128_3_3",name:"Assessment Recommendation Therapy or Training - Dietitian",category:"Improved Daily Living Skills",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"15_200_0126_1_3",name:"Assessment Recommendation Therapy or Training - Exercise Physiologist",category:"Improved Daily Living Skills",unit:"H",rate:166.99,remote:233.79,veryRemote:250.49},
  {code:"15_200_0128_1_3",name:"Assessment Recommendation Therapy or Training - Exercise Physiologist",category:"Improved Daily Living Skills",unit:"H",rate:166.99,remote:233.79,veryRemote:250.49},
  {code:"15_222400911_0124_1_3",name:"Low Cost AT - Support Capacity Building",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_300_0103_1_3",name:"Assistive Technology Mentoring",category:"Improved Daily Living Skills",unit:"H",rate:105.43,remote:147.6,veryRemote:158.15},
  {code:"15_400_0114_1_3",name:"Delivery of Health Supports by an Enrolled Nurse - Weekday Daytime",category:"Improved Daily Living Skills",unit:"H",rate:99.88,remote:139.83,veryRemote:149.82},
  {code:"15_401_0114_1_3",name:"Delivery of Health Supports by an Enrolled Nurse - Weekday Evening",category:"Improved Daily Living Skills",unit:"H",rate:110.18,remote:154.25,veryRemote:165.27},
  {code:"15_402_0114_1_3",name:"Delivery of Health Supports by an Enrolled Nurse - Saturday",category:"Improved Daily Living Skills",unit:"H",rate:142.48,remote:199.47,veryRemote:213.72},
  {code:"15_403_0114_1_3",name:"Delivery of Health Supports by an Enrolled Nurse - Sunday",category:"Improved Daily Living Skills",unit:"H",rate:163.79,remote:229.31,veryRemote:245.69},
  {code:"15_404_0114_1_3",name:"Delivery of Health Supports by an Enrolled Nurse - Public Holiday",category:"Improved Daily Living Skills",unit:"H",rate:185.08,remote:259.11,veryRemote:277.62},
  {code:"15_405_0114_1_3",name:"Delivery of Health Supports by an Enrolled Nurse - Weekday Night",category:"Improved Daily Living Skills",unit:"H",rate:112.22,remote:157.11,veryRemote:168.33},
  {code:"15_406_0114_1_3",name:"Delivery of Health Supports by a Registered Nurse - Weekday Daytime",category:"Improved Daily Living Skills",unit:"H",rate:123.65,remote:173.11,veryRemote:185.48},
  {code:"15_407_0114_1_3",name:"Delivery of Health Supports by a Registered Nurse - Weekday Evening",category:"Improved Daily Living Skills",unit:"H",rate:136.41,remote:190.97,veryRemote:204.62},
  {code:"15_408_0114_1_3",name:"Delivery of Health Supports by a Registered Nurse - Saturday",category:"Improved Daily Living Skills",unit:"H",rate:176.47,remote:247.06,veryRemote:264.71},
  {code:"15_409_0114_1_3",name:"Delivery of Health Supports by a Registered Nurse - Sunday",category:"Improved Daily Living Skills",unit:"H",rate:202.87,remote:284.02,veryRemote:304.31},
  {code:"15_410_0114_1_3",name:"Delivery of Health Supports by a Registered Nurse - Public Holiday",category:"Improved Daily Living Skills",unit:"H",rate:229.27,remote:320.98,veryRemote:343.91},
  {code:"15_411_0114_1_3",name:"Delivery of Health Supports by a Registered Nurse - Weekday Night",category:"Improved Daily Living Skills",unit:"H",rate:138.95,remote:194.53,veryRemote:208.43},
  {code:"15_412_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse - Weekday Daytime",category:"Improved Daily Living Skills",unit:"H",rate:143.04,remote:200.26,veryRemote:214.56},
  {code:"15_413_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse - Weekday Evening",category:"Improved Daily Living Skills",unit:"H",rate:157.77,remote:220.88,veryRemote:236.66},
  {code:"15_414_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse - Saturday",category:"Improved Daily Living Skills",unit:"H",rate:204.12,remote:285.77,veryRemote:306.18},
  {code:"15_415_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse - Sunday",category:"Improved Daily Living Skills",unit:"H",rate:234.67,remote:328.54,veryRemote:352.01},
  {code:"15_416_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse - Public Holiday",category:"Improved Daily Living Skills",unit:"H",rate:265.2,remote:371.28,veryRemote:397.8},
  {code:"15_417_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse - Weekday Night",category:"Improved Daily Living Skills",unit:"H",rate:160.73,remote:225.02,veryRemote:241.1},
  {code:"15_418_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Weekday Daytime",category:"Improved Daily Living Skills",unit:"H",rate:169.16,remote:236.82,veryRemote:253.74},
  {code:"15_419_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Weekday Evening",category:"Improved Daily Living Skills",unit:"H",rate:186.63,remote:261.28,veryRemote:279.95},
  {code:"15_420_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Saturday",category:"Improved Daily Living Skills",unit:"H",rate:241.52,remote:338.13,veryRemote:362.28},
  {code:"15_421_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Sunday",category:"Improved Daily Living Skills",unit:"H",rate:277.69,remote:388.77,veryRemote:416.54},
  {code:"15_422_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Public Holiday",category:"Improved Daily Living Skills",unit:"H",rate:313.86,remote:439.4,veryRemote:470.79},
  {code:"15_423_0114_1_3",name:"Delivery of Health Supports by a Clinical Nurse Consultant - Weekday Night",category:"Improved Daily Living Skills",unit:"H",rate:190.12,remote:266.17,veryRemote:285.18},
  {code:"15_424_0114_1_3",name:"Delivery of Health Supports by a Nurse Practitioner - Weekday Daytime",category:"Improved Daily Living Skills",unit:"H",rate:176.85,remote:247.59,veryRemote:265.28},
  {code:"15_425_0114_1_3",name:"Delivery of Health Supports by a Nurse Practitioner - Weekday Evening",category:"Improved Daily Living Skills",unit:"H",rate:195.09,remote:273.13,veryRemote:292.64},
  {code:"15_426_0114_1_3",name:"Delivery of Health Supports by a Nurse Practitioner - Saturday",category:"Improved Daily Living Skills",unit:"H",rate:252.51,remote:353.51,veryRemote:378.77},
  {code:"15_427_0114_1_3",name:"Delivery of Health Supports by a Nurse Practitioner - Sunday",category:"Improved Daily Living Skills",unit:"H",rate:290.33,remote:406.46,veryRemote:435.5},
  {code:"15_428_0114_1_3",name:"Delivery of Health Supports by a Nurse Practitioner - Public Holiday",category:"Improved Daily Living Skills",unit:"H",rate:328.16,remote:459.42,veryRemote:492.24},
  {code:"15_429_0114_1_3",name:"Delivery of Health Supports by a Nurse Practitioner - Weekday Night",category:"Improved Daily Living Skills",unit:"H",rate:198.75,remote:278.25,veryRemote:298.13},
  {code:"15_501_0119_1_3",name:"Provision of Hearing Services by an Audiologist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_502_0134_1_3",name:"Provision of Hearing Services by an Audiologist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_503_0134_1_3",name:"Provision of Hearing Services by an Audiometrist",category:"Improved Daily Living Skills",unit:"H",rate:166.83,remote:233.56,veryRemote:250.25},
  {code:"15_606_0118_1_3",name:"Early Childhood Intervention Professional - Counsellor",category:"Improved Daily Living Skills",unit:"H",rate:156.16,remote:218.62,veryRemote:234.24},
  {code:"15_609_0118_1_3",name:"Early Childhood Intervention Professional - Exercise Physiologist",category:"Improved Daily Living Skills",unit:"H",rate:166.99,remote:233.79,veryRemote:250.49},
  {code:"15_610_0118_1_3",name:"Early Childhood Intervention Professional - Art Therapist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_610_0128_1_3",name:"Assessment Recommendation Therapy or Training - Art Therapist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_611_0128_1_3",name:"Assessment Recommendation Therapy or Training - Audiologist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_613_0118_1_3",name:"Early Childhood Intervention Professional - Developmental educator",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_613_0128_1_3",name:"Assessment Recommendation Therapy or Training - Developmental Educator",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_615_0118_1_3",name:"Early Childhood Intervention Professional - Music Therapist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_615_0128_1_3",name:"Assessment Recommendation Therapy or Training - Music Therapist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_617_0118_1_3",name:"Early Childhood Intervention Professional - Occupational Therapist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_617_0128_1_3",name:"Assessment Recommendation Therapy or Training - Occupational Therapist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_618_0128_1_3",name:"Assessment Recommendation Therapy or Training - Orthoptist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_619_0118_1_3",name:"Early Childhood Intervention Professional - Podiatrist",category:"Improved Daily Living Skills",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"15_619_0128_1_3",name:"Assessment Recommendation Therapy or Training - Podiatrist",category:"Improved Daily Living Skills",unit:"H",rate:188.99,remote:264.59,veryRemote:283.49},
  {code:"15_620_0128_1_3",name:"Assessment Recommendation Therapy or Training - Rehabilitation Counsellor",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_621_0118_1_3",name:"Early Childhood Intervention Professional - Social worker",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_621_0128_1_3",name:"Assessment Recommendation Therapy or Training - Social Worker",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_622_0118_1_3",name:"Early Childhood Intervention Professional - Speech Pathologist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_622_0128_1_3",name:"Assessment Recommendation Therapy or Training - Speech Pathologist",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_625_0118_1_3",name:"Early Childhood Intervention Professional - Early Childhood Teacher or Educator",category:"Improved Daily Living Skills",unit:"H",rate:193.99,remote:271.59,veryRemote:290.99},
  {code:"15_799_0103_6_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0106_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0114_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0117_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0118_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0119_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0126_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0128_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0134_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"15_799_0135_1_3",name:"Provider travel - non-labour costs",category:"Improved Daily Living Skills",unit:"E",rate:1.0,remote:1.0,veryRemote:1.0},
  {code:"Bereavement",name:"Plan Management - Bereavement Payment",category:"Improved Life Choices",unit:"MON",rate:104.45,remote:104.45,veryRemote:104.45},
];


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT DOCS TAB ‚Äî load and display signed docs for a client
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

var DCS_DISTRIBUTION_EMAILS = ['ndisaccounts@deltacommunity.com.au','rina@deltacommunity.com.au','rosters@deltacommunity.com.au','accounts@deltacommunity.com.au','gus@deltacommunity.com.au'];

function loadClientDocs(contactId, clientName){
var el=document.getElementById("clientDocsLoading");
if(!el){el=document.getElementById("clientDocsContent")}
if(!el)return;
el.innerHTML='<div style="text-align:center;padding:24px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading documents...</div>';

// Fetch from the real Client Docs Airtable table by client name
var name=clientName||"";
apiCall("GET","/api/client-docs?clientName="+encodeURIComponent(name)).then(function(docs){
var h="";
if(!docs||docs.length===0){
h='<div style="text-align:center;padding:40px;color:var(--muted)">';
h+='<div style="font-size:40px;margin-bottom:10px">üìÇ</div>';
h+='<div style="font-size:13px;font-weight:600;margin-bottom:4px">No documents on file yet</div>';
h+='<div style="font-size:11px">Signed agreements and uploaded documents will appear here.</div>';
h+='</div>';
}else{
// Summary counts
var active=docs.filter(function(d){return(d.statusOfDoc||"").toLowerCase()==="active"}).length;
var expiring=docs.filter(function(d){
if(!d.expiryDate)return false;
try{var ep=new Date(d.expiryDate);var diff=Math.ceil((ep-new Date())/(1000*60*60*24));return diff>=0&&diff<=90;}catch(e){return false}
}).length;
h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px">';
h+='<div style="padding:10px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.15);border-radius:var(--rs);text-align:center"><div style="font-size:20px;font-weight:800;color:#059669">'+docs.length+'</div><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Total Docs</div></div>';
h+='<div style="padding:10px;background:rgba(16,185,129,.04);border:1px solid rgba(16,185,129,.12);border-radius:var(--rs);text-align:center"><div style="font-size:20px;font-weight:800;color:#059669">'+active+'</div><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Active</div></div>';
h+='<div style="padding:10px;background:rgba(245,158,11,.04);border:1px solid rgba(245,158,11,.12);border-radius:var(--rs);text-align:center"><div style="font-size:20px;font-weight:800;color:#D97706">'+expiring+'</div><div style="font-size:9px;font-weight:600;color:var(--muted);text-transform:uppercase">Expiring Soon</div></div>';
h+='</div>';

h+='<div style="display:flex;flex-direction:column;gap:8px">';
docs.forEach(function(d){
var statusLower=(d.statusOfDoc||"").toLowerCase();
var statusColor=statusLower==="active"?"#059669":statusLower==="expired"?"#EF4444":"#D97706";
var statusBg=statusLower==="active"?"rgba(16,185,129,.08)":statusLower==="expired"?"rgba(239,68,68,.08)":"rgba(245,158,11,.08)";

// Expiry calculation
var expiryDisplay="";var expiryColor="var(--muted)";
if(d.expiryDate){
try{
var ep=new Date(d.expiryDate);
var diff=Math.ceil((ep-new Date())/(1000*60*60*24));
var dd=("0"+ep.getDate()).slice(-2);var dm=("0"+(ep.getMonth()+1)).slice(-2);var dy=ep.getFullYear();
expiryDisplay=dd+"/"+dm+"/"+dy;
expiryColor=diff<0?"var(--red)":diff<90?"var(--orange)":"var(--green)";
expiryDisplay+=' <span style="font-size:9px;font-weight:700;color:'+expiryColor+'">'+(diff<0?"EXPIRED":diff<30?diff+"d left":diff<90?diff+"d":"‚úì")+'</span>';
}catch(ex){}
}

// Document type icon
var typeIcon=d.docType==="Service Agreement"?"üìã":d.docType==="Schedule of Support"?"üìÖ":d.docType==="Support Plan"?"üõ°Ô∏è":d.docType==="Medical Report"?"üè•":d.docType==="Risk Assessment"?"‚ö†Ô∏è":d.docType==="PBSP Plan"?"üß†":d.docType==="Legal Document"?"‚öñÔ∏è":d.docType==="OT or FCA Report"?"üî¨":"üìÑ";

h+='<div style="padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);display:flex;align-items:flex-start;gap:12px">';
h+='<div style="font-size:24px;flex-shrink:0;margin-top:2px">'+typeIcon+'</div>';
h+='<div style="flex:1;min-width:0">';
h+='<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
h+='<div style="font-size:13px;font-weight:700;color:var(--text)">'+(d.docType||"Document")+'</div>';
h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:20px;background:'+statusBg+';color:'+statusColor+'">'+(d.statusOfDoc||"‚Äî")+'</span>';
if(d.uniqueRef)h+='<span style="font-size:9px;font-family:monospace;color:var(--muted);background:var(--surface2);padding:2px 6px;border-radius:4px">#'+d.uniqueRef+'</span>';
h+='</div>';
if(expiryDisplay)h+='<div style="font-size:10px;color:var(--muted);margin-top:3px">Expiry: '+expiryDisplay+'</div>';
if(d.lastUpdated){
var lu=new Date(d.lastUpdated);
var luStr=("0"+lu.getDate()).slice(-2)+"/"+("0"+(lu.getMonth()+1)).slice(-2)+"/"+lu.getFullYear();
var updBy=typeof d.updatedBy==="string"?d.updatedBy:(d.updatedBy&&d.updatedBy.name)?d.updatedBy.name:"";h+='<div style="font-size:10px;color:var(--muted)">Last updated: '+luStr+(updBy?' by '+updBy:'')+'</div>';
}
if(d.attachmentSummary)h+='<div style="font-size:10px;color:var(--muted);font-style:italic;margin-top:2px">'+d.attachmentSummary+'</div>';
// File links
if(d.files&&d.files.length>0){
h+='<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">';
d.files.forEach(function(file){
h+='<a href="'+file.url+'" target="_blank" rel="noopener" style="font-size:9px;font-weight:600;padding:3px 10px;background:rgba(5,150,105,.06);color:#059669;border:1px solid rgba(5,150,105,.15);border-radius:4px;text-decoration:none;display:flex;align-items:center;gap:4px">üìé '+(file.name||"Download")+'</a>';
});
h+='</div>';
}
h+='</div>';
// Edit button stored as data attribute to avoid quoting issues
h+='<div style="flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:6px">';
h+='<button class="clientDocEditBtn" data-docid="'+d.id+'" data-clientname="'+escHtml(name)+'" data-doctype="'+escHtml(d.docType)+'" data-expiry="'+escHtml(d.expiryDate||"")+'" data-status="'+escHtml(d.statusOfDoc||"")+'" style="padding:5px 12px;background:rgba(99,102,241,.08);color:#6366f1;border:1px solid rgba(99,102,241,.2);border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer;white-space:nowrap">‚úèÔ∏è Edit</button>';
h+='</div>';
h+='</div>';
});
h+='</div>';
}
el.innerHTML=h;
el.id="clientDocsContent";
// Wire up edit buttons via event delegation (avoids inline onclick quoting issues)
el.querySelectorAll(".clientDocEditBtn").forEach(function(btn){
  btn.addEventListener("click",function(){
    openClientDocInlineEdit(
      btn.getAttribute("data-docid"),
      btn.getAttribute("data-clientname"),
      {
        docType:btn.getAttribute("data-doctype"),
        expiryDate:btn.getAttribute("data-expiry"),
        statusOfDoc:btn.getAttribute("data-status")
      }
    );
  });
});
}).catch(function(e){
el.innerHTML='<div style="text-align:center;padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>';
});
}

function copyDocLink(url){
navigator.clipboard.writeText(url).then(function(){
showToast("üîó Signing link copied to clipboard!","success");
}).catch(function(){
prompt("Copy this signing link:",url);
});
}


function _triggerClientDocUpload(btn){
  var cid=btn.getAttribute("data-cid")||"";
  var cn=btn.getAttribute("data-cn")||"";
  openClientDocUpload(cid,cn);
}
function openClientDocUpload(contactId, clientName){
var overlay=document.createElement("div");
overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center";
overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

var modal=document.createElement("div");
modal.style.cssText="background:var(--surface);border-radius:var(--r);padding:24px;width:90%;max-width:480px;max-height:90vh;overflow-y:auto";

// Build modal content using DOM
var titleBar=document.createElement("div");
titleBar.style.cssText="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px";
titleBar.innerHTML='<div style="font-size:15px;font-weight:700;color:var(--text)">üì§ Upload Document ‚Äî '+(clientName||"Client")+'</div>';
var closeBtn=document.createElement("button");
closeBtn.textContent="‚úï";
closeBtn.style.cssText="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)";
closeBtn.onclick=function(){overlay.remove()};
titleBar.appendChild(closeBtn);
modal.appendChild(titleBar);

// Doc type
var typeLabel=document.createElement("label");
typeLabel.style.cssText="display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px";
typeLabel.textContent="Document Type";
var typeSelect=document.createElement("select");
typeSelect.id="uploadDocType";
typeSelect.style.cssText="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);margin-bottom:14px";
["Service Agreement","Schedule of Support","Support Plan","PBSP Plan","Risk Assessment","Safety Plan","Medical Report","OT or FCA Report","Legal Document","Consent Form","Intake Form","OPG Endorsement","NDIS Plan","Other"].forEach(function(t){
var opt=document.createElement("option");opt.value=t;opt.textContent=t;typeSelect.appendChild(opt);
});
modal.appendChild(typeLabel);
modal.appendChild(typeSelect);

// Expiry date
var expLabel=document.createElement("label");
expLabel.style.cssText="display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px";
expLabel.innerHTML='Expiry Date <span style="font-weight:400;text-transform:none">(optional)</span>';
var expInput=document.createElement("input");
expInput.type="text";expInput.id="uploadDocExpiry";expInput.placeholder="dd/mm/yyyy";
expInput.style.cssText="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box;margin-bottom:14px";
modal.appendChild(expLabel);
modal.appendChild(expInput);

// File picker
var fileLabel=document.createElement("label");
fileLabel.style.cssText="display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px";
fileLabel.textContent="File";
var fileInput=document.createElement("input");
fileInput.type="file";fileInput.id="uploadDocFile";
fileInput.accept=".pdf,.docx,.doc,.png,.jpg,.jpeg";
fileInput.style.display="none";

var fileArea=document.createElement("div");
fileArea.style.cssText="padding:24px;text-align:center;border:2px dashed var(--border);border-radius:var(--r);cursor:pointer;background:var(--surface2);margin-bottom:14px";
var fileAreaLabel=document.createElement("div");
fileAreaLabel.id="uploadDocFileLabel";
fileAreaLabel.innerHTML='<div style="font-size:24px;margin-bottom:6px">üìÑ</div><div style="font-size:12px;color:var(--muted)">Click to choose a file</div><div style="font-size:10px;color:var(--muted);margin-top:4px">PDF, Word, JPG, PNG supported</div>';
fileArea.onclick=function(){fileInput.click()};
fileInput.onchange=function(){
var name=this.files[0]?this.files[0].name:"No file chosen";
fileAreaLabel.innerHTML='<div style="font-size:20px;margin-bottom:4px">üìÑ</div><div style="font-size:12px;font-weight:700;color:var(--text)">'+name+'</div>';
};
fileArea.appendChild(fileAreaLabel);
modal.appendChild(fileLabel);
modal.appendChild(fileInput);
modal.appendChild(fileArea);

// Status
var statusEl=document.createElement("div");
statusEl.id="uploadDocStatus";
statusEl.style.cssText="font-size:11px;margin-bottom:12px;min-height:16px";
modal.appendChild(statusEl);

// Buttons
var btnRow=document.createElement("div");
btnRow.style.cssText="display:flex;gap:8px";
var cancelBtn=document.createElement("button");
cancelBtn.textContent="Cancel";
cancelBtn.style.cssText="flex:1;padding:11px;border:1px solid var(--border);background:transparent;border-radius:var(--rs);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;color:var(--text)";
cancelBtn.onclick=function(){overlay.remove()};
var uploadBtn=document.createElement("button");
uploadBtn.textContent="üìÅ Upload & File";
uploadBtn.style.cssText="flex:2;padding:11px;background:linear-gradient(135deg,var(--royal),#2563EB);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer";
uploadBtn.onclick=function(){submitClientDocUpload(contactId,clientName)};
btnRow.appendChild(cancelBtn);
btnRow.appendChild(uploadBtn);
modal.appendChild(btnRow);

overlay.appendChild(modal);
document.body.appendChild(overlay);
}
function submitClientDocUpload(contactId, clientName){
var file=(document.getElementById("uploadDocFile")||{}).files;
var docType=(document.getElementById("uploadDocType")||{}).value||"Other";
var expiryDate=(document.getElementById("uploadDocExpiry")||{}).value||"";
var statusEl=document.getElementById("uploadDocStatus");
if(!file||file.length===0){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Please select a file</span>';return}
var reader=new FileReader();
reader.onload=function(ev){
var b64=ev.target.result.split(",")[1];
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Uploading...</span>';
apiCall("POST","/api/client-docs/upload",{
contactId:contactId,clientName:clientName,docType:docType,
expiryDate:expiryDate,fileName:file[0].name,fileData:b64,fileType:file[0].type
}).then(function(d){
if(d.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">'+d.error+'</span>';return}
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Uploaded!</span>';
setTimeout(function(){document.querySelector("div[style*=fixed][style*=9999]").remove();loadClientDocs(contactId,clientName)},1200);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">'+e.message+'</span>'});
};
reader.readAsDataURL(file[0]);
}

function showToast(msg,type){
var t=document.createElement("div");
t.style.cssText="position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;font-size:13px;font-weight:600;color:#fff;z-index:99999;box-shadow:0 4px 16px rgba(0,0,0,.15);animation:fadeIn .2s";
t.style.background=type==="success"?"#059669":type==="error"?"#EF4444":"#1E4BA0";
t.textContent=msg;
document.body.appendChild(t);
setTimeout(function(){t.remove()},3000);
}

function openAgreementCreator(prefillClientId) {
  var ex = document.getElementById("agreementCreatorOverlay");
  if (ex) ex.remove();
  // Always fetch fresh contacts first so dropdown is populated
  apiCall("GET", "/api/contacts").then(function(freshContacts) {
    contacts = freshContacts || contacts || [];
    _buildAgreementCreator(prefillClientId);
  }).catch(function() {
    _buildAgreementCreator(prefillClientId);
  });
}

function _buildAgreementCreator(prefillClientId) {
  var overlay = document.createElement("div");
  overlay.id = "agreementCreatorOverlay";
  overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;display:flex;align-items:stretch;justify-content:stretch;";

  // Get NDIS clients - broad match to catch all client contact types
  var ndisClients = contacts.filter(function(c) {
    var ct = (c.contactType||"").toLowerCase();
    return ct.indexOf("ndis client") >= 0 || ct.indexOf("client") >= 0;
  }).sort(function(a,b){ return (a.name||"").localeCompare(b.name||""); });

  var preselect = "";
  if (prefillClientId) {
    preselect = prefillClientId;
  } else if (_sdpSelectedContact) {
    preselect = _sdpSelectedContact.id;
  }

  // Split into Active and Prospect groups for clearer dropdown
  var activeClients = ndisClients.filter(function(c){ return (c.contactType||"").indexOf("Active") >= 0; });
  var prospectClients = ndisClients.filter(function(c){ return (c.contactType||"").indexOf("Prospect") >= 0; });

  var clientOptions = '<option value="">‚Äî Select NDIS Client ‚Äî</option>';
  if (activeClients.length > 0) {
    clientOptions += '<optgroup label="‚úÖ NDIS Client (Active) ‚Äî ' + activeClients.length + '">';
    activeClients.forEach(function(c) {
      clientOptions += '<option value="'+c.id+'"'+(c.id===preselect?' selected':'')+'>'+c.name+'</option>';
    });
    clientOptions += '</optgroup>';
  }
  if (prospectClients.length > 0) {
    clientOptions += '<optgroup label="üîµ NDIS Client (Prospect) ‚Äî ' + prospectClients.length + '">';
    prospectClients.forEach(function(c) {
      clientOptions += '<option value="'+c.id+'"'+(c.id===preselect?' selected':'')+'>'+c.name+'</option>';
    });
    clientOptions += '</optgroup>';
  }

  var h = '<div style="display:flex;flex-direction:column;width:100%;height:100%;background:var(--surface)">';

  // ‚îÄ‚îÄ Header bar ‚îÄ‚îÄ
  h += '<div style="background:linear-gradient(135deg,#0f172a,#1e3a5f);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0">';
  h += '<div style="display:flex;align-items:center;gap:16px">';
  h += '<img src="'+DCS_LOGO_B64+'" style="height:36px;object-fit:contain">';
  h += '<div><div style="font-size:16px;font-weight:700;color:#fff">‚úçÔ∏è Agreement Creator</div>';
  h += '<div style="font-size:11px;color:rgba(255,255,255,.5)">NDIS Service Agreement & Schedule of Support</div></div>';
  h += '</div>';
  h += '<div style="display:flex;gap:8px">';
  h += '<button onclick="agreeGenerate()" style="padding:8px 18px;background:#10b981;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">üëÅÔ∏è Preview</button>';
  h += '<button onclick="agreeDownloadPDF()" style="padding:8px 18px;background:#3b82f6;color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">‚¨áÔ∏è Download PDF</button>';
  h += '<button onclick="document.getElementById(\'agreementCreatorOverlay\').remove()" style="padding:8px 12px;background:rgba(255,255,255,.1);color:#fff;border:none;border-radius:8px;font-size:12px;cursor:pointer;font-family:inherit">‚úï Close</button>';
  h += '</div></div>';

  // ‚îÄ‚îÄ Two-column layout ‚îÄ‚îÄ
  h += '<div style="display:flex;flex:1;overflow:hidden">';

  // LEFT PANEL ‚Äî Form
  h += '<div style="width:480px;flex-shrink:0;overflow-y:auto;border-right:1px solid var(--border);background:var(--surface2)">';
  h += '<div style="padding:20px">';

  // Step tabs
  h += '<div style="display:flex;gap:2px;margin-bottom:20px;background:var(--border);border-radius:8px;padding:3px">';
  ["1. Client","2. Services","3. Signatories"].forEach(function(tab,i){
    h += '<button onclick="agreeTab('+i+')" id="agreeTabBtn'+i+'" style="flex:1;padding:7px 4px;border:none;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;background:'+(i===0?'var(--royal)':'transparent')+';color:'+(i===0?'#fff':'var(--muted)')+'">'+tab+'</button>';
  });
  h += '</div>';

  // ‚îÄ‚îÄ TAB 0: Client Details ‚îÄ‚îÄ
  h += '<div id="agreeTabContent0">';
  h += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Participant Details</div>';

  h += '<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px">Select Client *</label>';
  h += '<select id="agreeClientSel" onchange="agreeLoadClient(this.value)" style="width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)">'+clientOptions+'</select></div>';

  h += '<div id="agreeClientFields" style="display:grid;grid-template-columns:1fr 1fr;gap:8px"></div>';

  h += '<div style="margin-top:16px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Agreement Details</div>';

  var today = new Date();
  var todayStr = today.getFullYear()+"-"+String(today.getMonth()+1).padStart(2,"0")+"-"+String(today.getDate()).padStart(2,"0");
  var nextYear = new Date(today); nextYear.setFullYear(nextYear.getFullYear()+1);
  var nextYearStr = nextYear.getFullYear()+"-"+String(nextYear.getMonth()+1).padStart(2,"0")+"-"+String(nextYear.getDate()).padStart(2,"0");

  // Date fields in a 3-column grid
  h += '<div style="margin-bottom:14px">';
  h += '<div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">\U0001f4c5 Agreement & Plan Dates</div>';
  h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">';
  h += '<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px">Agreement Start <span style="color:var(--red)">*</span></label><input type="date" id="agreeStartDate" value="'+todayStr+'" oninput="agreeUpdateHolidays()" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)"></div>';
  h += '<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px">NDIS Plan Start <span style="color:var(--red)">*</span></label><input type="date" id="agreePlanStartDate" oninput="agreeUpdateHolidays()" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)"></div>';
  h += '<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px">NDIS Plan End <span style="color:var(--red)">*</span></label><input type="date" id="agreePlanEndDate" oninput="agreeUpdateHolidays()" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)"></div>';
  h += '</div>';
  h += '<div id="agreeHolidayPanel" style="display:none;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.15);border-radius:8px;padding:12px;font-size:11px"></div>';
  h += '</div>';
  // Service Type ‚Äî multi-select chip UI (onclick approach for reliability)
  h += '<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:6px">Service Type <span style="color:var(--red)">*</span> <span style="font-weight:400;text-transform:none;letter-spacing:0">(select all that apply)</span></label>';
  h += '<div id="agreeServiceTypeChips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px">';
  var svcTypes=["Supported Independent Living (SIL)","Community Access (CAS)","In-Home Support","Personal Care","Support Coordination","Transport Assistance","Other"];
  svcTypes.forEach(function(svc){
    var svcId="chip_"+svc.replace(/[^a-zA-Z0-9]/g,"_");
    h+='<button type="button" id="'+svcId+'" data-svc="'+svc+'" data-selected="0" onclick="agreeToggleChip(this)" style="padding:6px 14px;border:1.5px solid var(--border);border-radius:20px;cursor:pointer;font-size:11px;font-weight:600;color:var(--muted);background:var(--surface);font-family:inherit;transition:all .12s">'+svc+'</button>';
  });
  h+='</div><div id="agreeServiceTypeError" style="display:none;color:var(--red);font-size:10px;margin-top:2px">Please select at least one service type</div></div>';
  h += '<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px">NDIS Plan Management <span style=\"color:var(--red)\">*</span></label><select id="agreePlanMgmt" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)"><option value="">\u2014 Select \u2014</option><option>NDIA Managed</option><option>Plan Managed</option><option selected>Self-Managed</option></select></div>';
  h += '</div>';

  // ‚îÄ‚îÄ TAB 1: Support Services ‚îÄ‚îÄ
  h += '<div id="agreeTabContent1" style="display:none">';
  h += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Support Line Items</div>';
  h += '<div id="agreeLineItems"><div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Select a client first to load their support items</div></div>';
  h += '<button onclick="agreeAddLineItem()" style="margin-top:10px;width:100%;padding:9px;background:rgba(30,75,160,.06);color:var(--royal);border:1.5px dashed rgba(30,75,160,.2);border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">+ Add Support Item</button>';

  // Schedule of Support with time pickers
  h += '<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:14px">';
  h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">';
  h += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em">Schedule of Support <span style="font-weight:400;text-transform:none;font-size:10px">(optional)</span></div>';
  h += '</div>';
  h += '<div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:7px;padding:8px 10px;margin-bottom:10px;font-size:10.5px;color:#92400E;line-height:1.5">';
  h += '<strong>\u26a0\ufe0f Draft Shifts:</strong> Entering shift times below will automatically create <strong>Draft</strong> shifts in the Scheduler when you click Preview or Download PDF. These will appear highlighted in the Scheduler as <strong>\u23f3 DRAFT \u2014 Pending Agreement Signature</strong> until the Service Agreement is signed. Shifts remain editable and unconfirmed until the agreement is countersigned.';
  h += '</div>';
  h += '<div style="display:flex;flex-direction:column;gap:6px">';
  // Column headers
  h += '<div style="display:grid;grid-template-columns:80px 1fr 1fr 60px;gap:6px;align-items:center;margin-bottom:4px;padding-bottom:4px;border-bottom:1px solid var(--border)">';
  h += '<div></div>';
  h += '<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:center">Start</div>';
  h += '<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:center">End</div>';
  h += '<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;text-align:center">Hours</div>';
  h += '</div>';
  ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"].forEach(function(day){
    h += '<div style="display:grid;grid-template-columns:80px 1fr 1fr 60px;gap:6px;align-items:center;margin-bottom:4px">';
    h += '<div style="font-size:11px;font-weight:600;color:var(--text)">'+day+'</div>';
    h += '<input type="time" id="agreeSchedStart_'+day+'" oninput="agreeUpdateSchedHours()" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:11px;font-family:inherit;background:var(--surface);color:var(--text)">';
    h += '<input type="time" id="agreeSchedEnd_'+day+'" oninput="agreeUpdateSchedHours()" style="width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:11px;font-family:inherit;background:var(--surface);color:var(--text)">';
    h += '<div id="agreeSchedHrs_'+day+'" style="font-size:11px;font-weight:700;color:var(--teal);text-align:center;padding:6px 0">‚Äî</div>';
    h += '</div>';
  });
  // Balance summary bar
  h += '<div id="agreeSchedBalance" style="display:none;margin-top:10px;padding:8px 10px;border-radius:7px;font-size:11px;border:1px solid var(--border)"></div>';
  h += '</div>';
  h += '</div>';

  h += '<div style="margin-top:12px">'+agreeField("Weekly Hours","agreeWeeklyHours","number","")+'</div>';
  h += '<div>'+agreeField("Total Annual Budget (approx)","agreeBudget","text","","","$")+'</div>';
  h += '</div>';

  // ‚îÄ‚îÄ TAB 2: Signatories ‚îÄ‚îÄ
  h += '<div id="agreeTabContent2" style="display:none">';
  h += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:12px">Provider Representative</div>';
  h += agreeField("Name","agreePrvName","text",(window.currentUser&&window.currentUser.name)||"");
  h += agreeField("Role / Title","agreePrvRole","text","Support Coordinator");
  h += agreeField("Email","agreePrvEmail","text",(window.currentUser&&window.currentUser.email)||DCS_COMPANY.email);
  h += agreeField("Phone","agreePrvPhone","text",DCS_COMPANY.phone);

  h += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin:16px 0 12px">Participant / Representative</div>';
  h += '<div id="agreeParticipantSig"><p style="font-size:11px;color:var(--muted)">Populated from client selection</p></div>';

  h += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin:16px 0 12px">Nominee / Guardian (if applicable)</div>';
  h += '<div id="agreeNomineeSig"><p style="font-size:11px;color:var(--muted)">Populated from client selection</p></div>';
  h += '</div>';


  h += '</div></div>'; // end left panel inner + panel

  // RIGHT PANEL ‚Äî Live Preview
  h += '<div style="flex:1;overflow-y:auto;background:#e5e7eb;padding:20px">';
  h += '<div style="text-align:center;margin-bottom:12px"><span style="font-size:11px;color:#6b7280;font-weight:600">LIVE PREVIEW ‚Äî Click "Preview" to refresh</span></div>';
  h += '<div id="agreementPreviewArea" style="max-width:794px;margin:0 auto">';
  h += '<div style="background:#fff;padding:60px;min-height:1123px;box-shadow:0 4px 24px rgba(0,0,0,.15);border-radius:4px">';
  h += '<div style="text-align:center;padding:40px 0;color:#9ca3af"><div style="font-size:32px;margin-bottom:8px">‚úçÔ∏è</div><div style="font-size:13px;font-weight:600">Select a client and click Preview to generate the agreement</div></div>';
  h += '</div></div></div>';

  h += '</div></div>'; // end columns + main

  overlay.innerHTML = h;
  document.body.appendChild(overlay);

  // Auto-load client if preselected
  if (preselect) {
    setTimeout(function(){ agreeLoadClient(preselect); }, 100);
  }
}

// Service type chip toggle styling
// ============================================================
// ALL-STATE AUSTRALIAN PUBLIC HOLIDAYS 2025-2028
// ============================================================
var NDIS_PUBLIC_HOLIDAYS = {
  QLD: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-04-18",name:"Good Friday"},{date:"2025-04-19",name:"Easter Saturday"},
    {date:"2025-04-21",name:"Easter Monday"},{date:"2025-04-25",name:"Anzac Day"},
    {date:"2025-06-11",name:"King's Birthday"},{date:"2025-08-13",name:"Royal Queensland Show"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-04-03",name:"Good Friday"},{date:"2026-04-04",name:"Easter Saturday"},
    {date:"2026-04-06",name:"Easter Monday"},{date:"2026-04-25",name:"Anzac Day"},
    {date:"2026-08-12",name:"Royal Queensland Show"},{date:"2026-10-05",name:"King's Birthday"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-26",name:"Good Friday"},{date:"2027-03-27",name:"Easter Saturday"},
    {date:"2027-03-29",name:"Easter Monday"},{date:"2027-04-25",name:"Anzac Day"},
    {date:"2027-08-11",name:"Royal Queensland Show"},{date:"2027-10-04",name:"King's Birthday"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-04-14",name:"Good Friday"},{date:"2028-04-15",name:"Easter Saturday"},
    {date:"2028-04-17",name:"Easter Monday"},{date:"2028-04-25",name:"Anzac Day"},
    {date:"2028-08-09",name:"Royal Queensland Show"},{date:"2028-10-02",name:"King's Birthday"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Boxing Day"}
  ],
  NSW: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-04-18",name:"Good Friday"},{date:"2025-04-19",name:"Easter Saturday"},
    {date:"2025-04-20",name:"Easter Sunday"},{date:"2025-04-21",name:"Easter Monday"},
    {date:"2025-04-25",name:"Anzac Day"},{date:"2025-06-09",name:"King's Birthday"},
    {date:"2025-08-04",name:"Bank Holiday"},{date:"2025-10-06",name:"Labour Day"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-04-03",name:"Good Friday"},{date:"2026-04-04",name:"Easter Saturday"},
    {date:"2026-04-05",name:"Easter Sunday"},{date:"2026-04-06",name:"Easter Monday"},
    {date:"2026-04-25",name:"Anzac Day"},{date:"2026-06-08",name:"King's Birthday"},
    {date:"2026-08-03",name:"Bank Holiday"},{date:"2026-10-05",name:"Labour Day"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-26",name:"Good Friday"},{date:"2027-03-27",name:"Easter Saturday"},
    {date:"2027-03-28",name:"Easter Sunday"},{date:"2027-03-29",name:"Easter Monday"},
    {date:"2027-04-25",name:"Anzac Day"},{date:"2027-06-14",name:"King's Birthday"},
    {date:"2027-08-02",name:"Bank Holiday"},{date:"2027-10-04",name:"Labour Day"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-04-14",name:"Good Friday"},{date:"2028-04-15",name:"Easter Saturday"},
    {date:"2028-04-16",name:"Easter Sunday"},{date:"2028-04-17",name:"Easter Monday"},
    {date:"2028-04-25",name:"Anzac Day"},{date:"2028-06-12",name:"King's Birthday"},
    {date:"2028-08-07",name:"Bank Holiday"},{date:"2028-10-02",name:"Labour Day"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Boxing Day"}
  ],
  VIC: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-03-10",name:"Labour Day"},{date:"2025-04-18",name:"Good Friday"},
    {date:"2025-04-19",name:"Easter Saturday"},{date:"2025-04-20",name:"Easter Sunday"},
    {date:"2025-04-21",name:"Easter Monday"},{date:"2025-04-25",name:"Anzac Day"},
    {date:"2025-06-09",name:"King's Birthday"},{date:"2025-11-04",name:"Melbourne Cup"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-03-09",name:"Labour Day"},{date:"2026-04-03",name:"Good Friday"},
    {date:"2026-04-04",name:"Easter Saturday"},{date:"2026-04-05",name:"Easter Sunday"},
    {date:"2026-04-06",name:"Easter Monday"},{date:"2026-04-25",name:"Anzac Day"},
    {date:"2026-06-08",name:"King's Birthday"},{date:"2026-11-03",name:"Melbourne Cup"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-08",name:"Labour Day"},{date:"2027-03-26",name:"Good Friday"},
    {date:"2027-03-27",name:"Easter Saturday"},{date:"2027-03-28",name:"Easter Sunday"},
    {date:"2027-03-29",name:"Easter Monday"},{date:"2027-04-25",name:"Anzac Day"},
    {date:"2027-06-14",name:"King's Birthday"},{date:"2027-11-02",name:"Melbourne Cup"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-03-13",name:"Labour Day"},{date:"2028-04-14",name:"Good Friday"},
    {date:"2028-04-15",name:"Easter Saturday"},{date:"2028-04-16",name:"Easter Sunday"},
    {date:"2028-04-17",name:"Easter Monday"},{date:"2028-04-25",name:"Anzac Day"},
    {date:"2028-06-12",name:"King's Birthday"},{date:"2028-11-07",name:"Melbourne Cup"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Boxing Day"}
  ],
  WA: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-03-03",name:"Labour Day"},{date:"2025-04-18",name:"Good Friday"},
    {date:"2025-04-21",name:"Easter Monday"},{date:"2025-04-25",name:"Anzac Day"},
    {date:"2025-06-02",name:"Western Australia Day"},{date:"2025-09-22",name:"Queen's Birthday"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-03-02",name:"Labour Day"},{date:"2026-04-03",name:"Good Friday"},
    {date:"2026-04-06",name:"Easter Monday"},{date:"2026-04-25",name:"Anzac Day"},
    {date:"2026-06-01",name:"Western Australia Day"},{date:"2026-09-28",name:"Queen's Birthday"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-01",name:"Labour Day"},{date:"2027-03-26",name:"Good Friday"},
    {date:"2027-03-29",name:"Easter Monday"},{date:"2027-04-25",name:"Anzac Day"},
    {date:"2027-06-07",name:"Western Australia Day"},{date:"2027-09-27",name:"Queen's Birthday"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-03-06",name:"Labour Day"},{date:"2028-04-14",name:"Good Friday"},
    {date:"2028-04-17",name:"Easter Monday"},{date:"2028-04-25",name:"Anzac Day"},
    {date:"2028-06-05",name:"Western Australia Day"},{date:"2028-09-25",name:"Queen's Birthday"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Boxing Day"}
  ],
  SA: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-02-10",name:"Adelaide Cup"},{date:"2025-04-18",name:"Good Friday"},
    {date:"2025-04-19",name:"Easter Saturday"},{date:"2025-04-21",name:"Easter Monday"},
    {date:"2025-04-25",name:"Anzac Day"},{date:"2025-06-09",name:"King's Birthday"},
    {date:"2025-10-06",name:"Labour Day"},{date:"2025-12-24",name:"Christmas Eve"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Proclamation Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-02-09",name:"Adelaide Cup"},{date:"2026-04-03",name:"Good Friday"},
    {date:"2026-04-04",name:"Easter Saturday"},{date:"2026-04-06",name:"Easter Monday"},
    {date:"2026-04-25",name:"Anzac Day"},{date:"2026-06-08",name:"King's Birthday"},
    {date:"2026-10-05",name:"Labour Day"},{date:"2026-12-24",name:"Christmas Eve"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Proclamation Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-02-08",name:"Adelaide Cup"},{date:"2027-03-26",name:"Good Friday"},
    {date:"2027-03-27",name:"Easter Saturday"},{date:"2027-03-29",name:"Easter Monday"},
    {date:"2027-04-25",name:"Anzac Day"},{date:"2027-06-14",name:"King's Birthday"},
    {date:"2027-10-04",name:"Labour Day"},{date:"2027-12-24",name:"Christmas Eve"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Proclamation Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-02-14",name:"Adelaide Cup"},{date:"2028-04-14",name:"Good Friday"},
    {date:"2028-04-15",name:"Easter Saturday"},{date:"2028-04-17",name:"Easter Monday"},
    {date:"2028-04-25",name:"Anzac Day"},{date:"2028-06-12",name:"King's Birthday"},
    {date:"2028-10-02",name:"Labour Day"},{date:"2028-12-24",name:"Christmas Eve"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Proclamation Day"}
  ],
  NT: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-04-18",name:"Good Friday"},{date:"2025-04-19",name:"Easter Saturday"},
    {date:"2025-04-21",name:"Easter Monday"},{date:"2025-04-25",name:"Anzac Day"},
    {date:"2025-05-05",name:"May Day"},{date:"2025-06-09",name:"King's Birthday"},
    {date:"2025-08-04",name:"Picnic Day"},{date:"2025-12-24",name:"Christmas Eve"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-04-03",name:"Good Friday"},{date:"2026-04-04",name:"Easter Saturday"},
    {date:"2026-04-06",name:"Easter Monday"},{date:"2026-04-25",name:"Anzac Day"},
    {date:"2026-05-04",name:"May Day"},{date:"2026-06-08",name:"King's Birthday"},
    {date:"2026-08-03",name:"Picnic Day"},{date:"2026-12-24",name:"Christmas Eve"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-26",name:"Good Friday"},{date:"2027-03-27",name:"Easter Saturday"},
    {date:"2027-03-29",name:"Easter Monday"},{date:"2027-04-25",name:"Anzac Day"},
    {date:"2027-05-03",name:"May Day"},{date:"2027-06-14",name:"King's Birthday"},
    {date:"2027-08-02",name:"Picnic Day"},{date:"2027-12-24",name:"Christmas Eve"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-04-14",name:"Good Friday"},{date:"2028-04-15",name:"Easter Saturday"},
    {date:"2028-04-17",name:"Easter Monday"},{date:"2028-04-25",name:"Anzac Day"},
    {date:"2028-05-01",name:"May Day"},{date:"2028-06-12",name:"King's Birthday"},
    {date:"2028-08-07",name:"Picnic Day"},{date:"2028-12-24",name:"Christmas Eve"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Boxing Day"}
  ],
  TAS: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-03-10",name:"Eight Hours Day"},{date:"2025-04-18",name:"Good Friday"},
    {date:"2025-04-19",name:"Easter Saturday"},{date:"2025-04-21",name:"Easter Monday"},
    {date:"2025-04-25",name:"Anzac Day"},{date:"2025-06-09",name:"King's Birthday"},
    {date:"2025-12-25",name:"Christmas Day"},{date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-03-09",name:"Eight Hours Day"},{date:"2026-04-03",name:"Good Friday"},
    {date:"2026-04-04",name:"Easter Saturday"},{date:"2026-04-06",name:"Easter Monday"},
    {date:"2026-04-25",name:"Anzac Day"},{date:"2026-06-08",name:"King's Birthday"},
    {date:"2026-12-25",name:"Christmas Day"},{date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-08",name:"Eight Hours Day"},{date:"2027-03-26",name:"Good Friday"},
    {date:"2027-03-27",name:"Easter Saturday"},{date:"2027-03-29",name:"Easter Monday"},
    {date:"2027-04-25",name:"Anzac Day"},{date:"2027-06-14",name:"King's Birthday"},
    {date:"2027-12-25",name:"Christmas Day"},{date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-03-13",name:"Eight Hours Day"},{date:"2028-04-14",name:"Good Friday"},
    {date:"2028-04-15",name:"Easter Saturday"},{date:"2028-04-17",name:"Easter Monday"},
    {date:"2028-04-25",name:"Anzac Day"},{date:"2028-06-12",name:"King's Birthday"},
    {date:"2028-12-25",name:"Christmas Day"},{date:"2028-12-26",name:"Boxing Day"}
  ],
  ACT: [
    {date:"2025-01-01",name:"New Year's Day"},{date:"2025-01-27",name:"Australia Day"},
    {date:"2025-03-10",name:"Canberra Day"},{date:"2025-04-18",name:"Good Friday"},
    {date:"2025-04-19",name:"Easter Saturday"},{date:"2025-04-20",name:"Easter Sunday"},
    {date:"2025-04-21",name:"Easter Monday"},{date:"2025-04-25",name:"Anzac Day"},
    {date:"2025-06-09",name:"King's Birthday"},{date:"2025-08-04",name:"Family & Community Day"},
    {date:"2025-10-06",name:"Labour Day"},{date:"2025-12-25",name:"Christmas Day"},
    {date:"2025-12-26",name:"Boxing Day"},
    {date:"2026-01-01",name:"New Year's Day"},{date:"2026-01-26",name:"Australia Day"},
    {date:"2026-03-09",name:"Canberra Day"},{date:"2026-04-03",name:"Good Friday"},
    {date:"2026-04-04",name:"Easter Saturday"},{date:"2026-04-05",name:"Easter Sunday"},
    {date:"2026-04-06",name:"Easter Monday"},{date:"2026-04-25",name:"Anzac Day"},
    {date:"2026-06-08",name:"King's Birthday"},{date:"2026-08-03",name:"Family & Community Day"},
    {date:"2026-10-05",name:"Labour Day"},{date:"2026-12-25",name:"Christmas Day"},
    {date:"2026-12-26",name:"Boxing Day"},
    {date:"2027-01-01",name:"New Year's Day"},{date:"2027-01-26",name:"Australia Day"},
    {date:"2027-03-08",name:"Canberra Day"},{date:"2027-03-26",name:"Good Friday"},
    {date:"2027-03-27",name:"Easter Saturday"},{date:"2027-03-28",name:"Easter Sunday"},
    {date:"2027-03-29",name:"Easter Monday"},{date:"2027-04-25",name:"Anzac Day"},
    {date:"2027-06-14",name:"King's Birthday"},{date:"2027-08-02",name:"Family & Community Day"},
    {date:"2027-10-04",name:"Labour Day"},{date:"2027-12-25",name:"Christmas Day"},
    {date:"2027-12-27",name:"Boxing Day"},
    {date:"2028-01-01",name:"New Year's Day"},{date:"2028-01-26",name:"Australia Day"},
    {date:"2028-03-13",name:"Canberra Day"},{date:"2028-04-14",name:"Good Friday"},
    {date:"2028-04-15",name:"Easter Saturday"},{date:"2028-04-16",name:"Easter Sunday"},
    {date:"2028-04-17",name:"Easter Monday"},{date:"2028-04-25",name:"Anzac Day"},
    {date:"2028-06-12",name:"King's Birthday"},{date:"2028-08-07",name:"Family & Community Day"},
    {date:"2028-10-02",name:"Labour Day"},{date:"2028-12-25",name:"Christmas Day"},
    {date:"2028-12-26",name:"Boxing Day"}
  ]
};

var STATE_NAMES = {QLD:"Queensland",NSW:"New South Wales",VIC:"Victoria",WA:"Western Australia",SA:"South Australia",NT:"Northern Territory",TAS:"Tasmania",ACT:"Australian Capital Territory"};
var STATE_URLS = {
  QLD:"https://publicholidays.com.au/queensland/",
  NSW:"https://publicholidays.com.au/new-south-wales/",
  VIC:"https://publicholidays.com.au/victoria/",
  WA:"https://publicholidays.com.au/western-australia/",
  SA:"https://publicholidays.com.au/south-australia/",
  NT:"https://publicholidays.com.au/northern-territory/",
  TAS:"https://publicholidays.com.au/tasmania/",
  ACT:"https://publicholidays.com.au/act/"
};

function agreeGetHolidaysForState(state, startDate, endDate) {
  var list = NDIS_PUBLIC_HOLIDAYS[state] || NDIS_PUBLIC_HOLIDAYS["QLD"];
  var s = new Date(startDate), e = new Date(endDate);
  return list.filter(function(h){ var d=new Date(h.date); return d>=s && d<=e; });
}

function agreeUpdateSchedHours() {
  var days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  var dayDowMap = {Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6,Sunday:0};
  var totalSched = 0;
  var phExcluded = 0;

  // Get public holiday dates within plan period
  var startVal = (document.getElementById("agreeStartDate")||{}).value;
  var endVal = (document.getElementById("agreePlanEndDate")||{}).value;
  var state = (document.getElementById("agreeHolidayState")||{}).value || "QLD";
  var holidayDateSet = {};
  if (startVal && endVal && typeof agreeGetHolidaysForState === "function") {
    agreeGetHolidaysForState(state, startVal, endVal).forEach(function(h) {
      holidayDateSet[h.date] = h.name;
    });
  }

  days.forEach(function(day) {
    var s = (document.getElementById("agreeSchedStart_"+day)||{}).value;
    var e = (document.getElementById("agreeSchedEnd_"+day)||{}).value;
    var hrsEl = document.getElementById("agreeSchedHrs_"+day);
    if (!hrsEl) return;
    if (s && e) {
      var sm = parseInt(s.split(":")[0])*60 + parseInt(s.split(":")[1]);
      var em = parseInt(e.split(":")[0])*60 + parseInt(e.split(":")[1]);
      var diff = (em - sm) / 60;
      if (diff > 0) {
        // Count how many occurrences of this weekday fall on a public holiday
        var dow = dayDowMap[day];
        var phCount = 0;
        if (startVal && endVal) {
          var cur = new Date(startVal);
          var end = new Date(endVal);
          while (cur <= end) {
            if (cur.getDay() === dow) {
              var dk = cur.getFullYear()+"-"+("0"+(cur.getMonth()+1)).slice(-2)+"-"+("0"+cur.getDate()).slice(-2);
              if (holidayDateSet[dk]) phCount++;
            }
            cur.setDate(cur.getDate()+1);
          }
        }
        var phHrsThisDay = phCount * diff;
        phExcluded += phHrsThisDay;
        var label = diff % 1 === 0 ? diff+"h" : diff.toFixed(1)+"h";
        if (phCount > 0) label += ' <span style="font-size:8px;color:#F59E0B" title="'+phCount+' public holiday shift(s) excluded">\u2b50</span>';
        hrsEl.innerHTML = label;
        hrsEl.style.color = "var(--teal)";
        totalSched += diff;
      } else { hrsEl.textContent = "‚Äî"; hrsEl.style.color = "var(--muted)"; }
    } else { hrsEl.textContent = "‚Äî"; hrsEl.style.color = "var(--muted)"; }
  });
  // Get target from non-PH line items only
  var targetHrs = 0;
  (window._agreeLineItems||[]).forEach(function(item){
    var isPH = item.name && item.name.toLowerCase().indexOf("public holiday") >= 0;
    if (!isPH) targetHrs += parseFloat(item.hours)||0;
  });
  var weeklyEl = document.getElementById("agreeWeeklyHours");
  if (weeklyEl && weeklyEl.value) targetHrs = parseFloat(weeklyEl.value)||targetHrs;
  var balEl = document.getElementById("agreeSchedBalance");
  if (!balEl) return;
  if (totalSched === 0 && targetHrs === 0) { balEl.style.display="none"; return; }
  balEl.style.display = "block";
  var balance = targetHrs - totalSched;
  var isOver = balance < -0.01;
  var isExact = Math.abs(balance) < 0.01;
  var bg = isExact?"rgba(16,185,129,.06)":isOver?"rgba(239,68,68,.06)":"rgba(245,158,11,.06)";
  var border = isExact?"rgba(16,185,129,.2)":isOver?"rgba(239,68,68,.2)":"rgba(245,158,11,.2)";
  var col = isExact?"#10B981":isOver?"var(--red)":"#F59E0B";
  var icon = isExact?"\u2705":isOver?"\u26a0\ufe0f":"\u23f3";
  var msg = isExact?"Schedule matches target hours perfectly"
    :isOver?Math.abs(balance).toFixed(1)+"h over target ‚Äî reduce shift times"
    :balance.toFixed(1)+"h remaining to schedule";
  balEl.style.background=bg; balEl.style.borderColor=border;
  var phNote = phExcluded > 0 ? ' &nbsp;<span style="color:#F59E0B;font-size:9px">\u2b50 '+phExcluded.toFixed(1)+'h on public holidays excluded from draft roster</span>' : '';
  balEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">'
    +'<div style="display:flex;align-items:center;gap:8px">'+icon
    +'<div><div style="font-size:11px;font-weight:700;color:'+col+'">'+msg+'</div>'
    +'<div style="font-size:10px;color:var(--muted);margin-top:1px">Scheduled: <strong>'+totalSched.toFixed(1)+'h</strong>'
    +(targetHrs>0?' &nbsp;|&nbsp; Target: <strong>'+targetHrs.toFixed(1)+'h/week</strong>':'') + phNote + '</div></div></div>'
    +(targetHrs>0&&!isExact&&!isOver?'<div style="font-size:13px;font-weight:900;color:'+col+'">'+balance.toFixed(1)+'h left</div>':'')+ '</div>';
}
window.agreeUpdateSchedHours = agreeUpdateSchedHours;

function agreeUpdateHolidays() {
  var startVal = (document.getElementById("agreeStartDate")||{}).value;
  var endVal = (document.getElementById("agreePlanEndDate")||{}).value;
  var state = (document.getElementById("agreeHolidayState")||{}).value || "QLD";
  var panel = document.getElementById("agreeHolidayPanel");
  if (!panel) return;
  if (!startVal || !endVal) { panel.style.display="none"; return; }

  var holidays = agreeGetHolidaysForState(state, startVal, endVal);
  panel.style.display = "block";

  function fmtShort(s) {
    var d = new Date(s);
    return ("0"+d.getDate()).slice(-2)+"/"+("0"+(d.getMonth()+1)).slice(-2)+"/"+d.getFullYear();
  }
  function fmtRange(s, e) {
    var ds=new Date(s), de=new Date(e);
    return ("0"+ds.getDate()).slice(-2)+"/"+("0"+(ds.getMonth()+1)).slice(-2)+"/"+(ds.getFullYear()+"").slice(-2)
      +" and "+("0"+de.getDate()).slice(-2)+"/"+("0"+(de.getMonth()+1)).slice(-2)+"/"+(de.getFullYear()+"").slice(-2);
  }

  var stateLabel = STATE_NAMES[state] || state;
  var stateUrl = (STATE_URLS[state] || 'https://publicholidays.com.au/') + new Date(startVal).getFullYear() + '-dates/';
  var html = '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;gap:8px">';
  html += '<div style="display:flex;align-items:center;gap:8px">';
  html += '<span style="font-size:16px">\U0001f4c5</span>';
  html += '<div>';
  html += '<div style="font-size:11px;font-weight:700;color:var(--royal)">Public Holidays in '+stateLabel+'</div>';
  html += '<div style="font-size:15px;font-weight:900;color:var(--royal)">'+holidays.length+' public holidays</div>';
  html += '<div style="font-size:10px;color:var(--muted)">Between '+fmtRange(startVal,endVal)+'</div>';
  html += '<a href="'+stateUrl+'" target="_blank" rel="noopener" style="font-size:10px;color:var(--royal);text-decoration:none;display:inline-flex;align-items:center;gap:3px;margin-top:3px">&#x1F517; publicholidays.com.au &#x2197;</a>';
  html += '</div></div>';
  // State selector inline
  html += '<div><label style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:3px">State</label>';
  html += '<select id="agreeHolidayState" onchange="agreeUpdateHolidays()" style="padding:5px 8px;border:1.5px solid var(--border);border-radius:6px;font-size:11px;font-family:inherit;background:var(--surface);color:var(--text);cursor:pointer">';
  ["QLD","NSW","VIC","WA","SA","NT","TAS","ACT"].forEach(function(s){
    html += '<option value="'+s+'"'+( s===state ? ' selected' : '')+'>'+ s + '</option>';
  });
  html += '</select></div></div>';

  if (holidays.length > 0) {
    html += '<div style="display:flex;flex-direction:column;gap:3px;max-height:220px;overflow-y:auto">';
    holidays.forEach(function(h) {
      html += '<div style="display:flex;align-items:center;gap:8px;font-size:10.5px;padding:2px 0">';
      html += '<span style="color:var(--royal);font-weight:700;min-width:72px;flex-shrink:0">'+fmtShort(h.date)+'</span>';
      html += '<span style="color:#999">‚Äî</span>';
      html += '<span>'+h.name+'</span></div>';
    });
    html += '</div>';
  } else {
    html += '<div style="font-size:11px;color:var(--muted);margin-top:6px">No public holidays in this period.</div>';
  }
  panel.innerHTML = html;
}

function agreeToggleChip(btn) {
  var selected = btn.getAttribute("data-selected") === "1";
  selected = !selected;
  btn.setAttribute("data-selected", selected ? "1" : "0");
  if (selected) {
    btn.style.borderColor = "var(--royal)";
    btn.style.background = "rgba(30,75,160,.1)";
    btn.style.color = "var(--royal)";
    btn.textContent = "\u2713 " + btn.getAttribute("data-svc");
  } else {
    btn.style.borderColor = "var(--border)";
    btn.style.background = "var(--surface)";
    btn.style.color = "var(--muted)";
    btn.textContent = btn.getAttribute("data-svc");
  }
  var err = document.getElementById("agreeServiceTypeError");
  if (err) err.style.display = "none";
}

function agreeGetSelectedServices() {
  var selected = [];
  document.querySelectorAll('#agreeServiceTypeChips button[data-selected="1"]').forEach(function(btn) {
    selected.push(btn.getAttribute("data-svc"));
  });
  return selected;
}

function agreeValidateForm() {
  var ok = true;
  // Service type check
  var svcs = agreeGetSelectedServices();
  var err = document.getElementById("agreeServiceTypeError");
  if (svcs.length === 0) { if (err) err.style.display = "block"; ok = false; }
  // Plan management check
  var pm = document.getElementById("agreePlanMgmt");
  if (pm && !pm.value) { pm.style.borderColor = "var(--red)"; ok = false; }
  // State (public holidays) mandatory check
  var stateEl = document.getElementById("agreeHolidayState");
  var stateErr = document.getElementById("agreeHolidayStateError");
  var panel = document.getElementById("agreeHolidayPanel");
  if (!stateEl || !stateEl.value) {
    if (stateErr) stateErr.style.display = "block";
    // Holiday panel must be visible & state selected - prompt user to go to Client tab
    if (panel) panel.style.borderColor = "var(--red)";
    ok = false;
  }
  return ok;
}

function agreeUpdateServiceChips(){
  // legacy no-op
}

function agreeField(label, id, type, val, options, prefix) {
  var h = '<div style="margin-bottom:10px">';
  h += '<label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px">'+label+'</label>';
  var style = 'width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:12px;font-family:inherit;background:var(--surface);color:var(--text);outline:none';
  if (prefix) {
    h += '<div style="position:relative"><span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:12px">'+prefix+'</span>';
    h += '<input id="'+id+'" type="'+type+'" value="'+(val||"")+'" style="'+style+';padding-left:22px"></div>';
  } else if (type === "select") {
    h += '<select id="'+id+'" style="'+style+'">';
    (options||[]).forEach(function(o){ h += '<option value="'+o+'"'+(o===val?' selected':'')+'>'+o+'</option>'; });
    h += '</select>';
  } else {
    h += '<input id="'+id+'" type="'+type+'" value="'+(val||"")+'" style="'+style+'">';
  }
  h += '</div>';
  return h;
}

function agreeTab(idx) {
  [0,1,2].forEach(function(i){
    var c = document.getElementById("agreeTabContent"+i);
    var b = document.getElementById("agreeTabBtn"+i);
    if (c) c.style.display = i===idx ? "" : "none";
    if (b) {
      b.style.background = i===idx ? "var(--royal)" : "transparent";
      b.style.color = i===idx ? "#fff" : "var(--muted)";
    }
  });
}

function agreeLoadClient(clientId) {
  if (!clientId) return;
  var c = contacts.find(function(x){ return x.id === clientId; });
  if (!c) return;
  _agreeClient = c;

  // Populate client fields panel
  var panel = document.getElementById("agreeClientFields");
  if (!panel) return;

  var dob = c.dob || c.dateOfBirth || "";
  if (dob) { try { var dp=new Date(dob); if(!isNaN(dp)) dob=("0"+dp.getDate()).slice(-2)+"/"+("0"+(dp.getMonth()+1)).slice(-2)+"/"+dp.getFullYear(); } catch(e){} }

  var addr = [c.address,c.suburb,c.state,c.postcode].filter(Boolean).join(", ");

  var fields = [
    ["Full Name", c.name||""],
    ["NDIS Number", c.ndisNumber||""],
    ["Date of Birth", dob],
    ["Gender", c.gender||""],
    ["Phone", c.phone||""],
    ["Email", c.email||""],
    ["Address", addr],
    ["Plan Expiry", c.planExpiry||""],
    ["Support Coordinator", c.supportCoordinator||""],
    ["Plan Manager", c.planManager||""],
    ["Nominee / Guardian", c.nominee||""],
    ["Emergency Contact", c.emergencyContact||""]
  ];

  var h = "";
  fields.forEach(function(f){
    if (!f[1]) return;
    var isSpan = f[0]==="Address"||f[0]==="Support Coordinator"||f[0]==="Plan Manager"||f[0]==="Nominee / Guardian"||f[0]==="Emergency Contact";
    h += '<div style="'+(isSpan?"grid-column:1/-1":"")+';padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-radius:7px">';
    h += '<div style="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em">'+f[0]+'</div>';
    h += '<div style="font-size:12px;font-weight:600;color:var(--text);margin-top:2px">'+f[1]+'</div></div>';
  });
  panel.innerHTML = h || '<div style="grid-column:1/-1;text-align:center;color:var(--muted);font-size:11px;padding:12px">No client data found in contacts</div>';

  // Also set plan management from client data
  var pm = document.getElementById("agreePlanMgmt");
  if (pm && c.planManager) pm.value = "Plan Managed";

  // Set service type chips based on client's silOrCas
  if (c.silOrCas) {
    var stLower = (c.silOrCas||c.serviceType||"").toLowerCase();
    // Uncheck all first
    document.querySelectorAll('#agreeServiceTypeChips input[type=checkbox]').forEach(function(cb){ cb.checked=false; });
    // Check matching ones
    if (stLower.indexOf("sil") >= 0) {
      var silBtn=document.querySelector('#agreeServiceTypeChips button[data-svc="Supported Independent Living (SIL)"]');
      if(silBtn&&silBtn.getAttribute("data-selected")!=="1")agreeToggleChip(silBtn);
    }
    if (stLower.indexOf("cas") >= 0 || stLower.indexOf("community") >= 0) {
      var casBtn=document.querySelector('#agreeServiceTypeChips button[data-svc="Community Access (CAS)"]');
      if(casBtn&&casBtn.getAttribute("data-selected")!=="1")agreeToggleChip(casBtn);
    }
  }

  // Populate participant signatory
  var pSig = document.getElementById("agreeParticipantSig");
  if (pSig) {
    pSig.innerHTML = [
      agreeField("Participant Full Name","agreeSigPartName","text",c.name||""),
      agreeField("Phone","agreeSigPartPhone","text",c.phone||""),
      agreeField("Email","agreeSigPartEmail","text",c.email||"")
    ].join("");
  }

  // Populate nominee
  var nSig = document.getElementById("agreeNomineeSig");
  if (nSig) {
    nSig.innerHTML = [
      agreeField("Nominee / Guardian Name","agreeSigNomName","text",c.nominee||""),
      agreeField("Relationship","agreeSigNomRel","text",""),
      agreeField("Phone","agreeSigNomPhone","text",""),
      agreeField("Email","agreeSigNomEmail","text","")
    ].join("");
  }

  // Populate support line items from client support needs
  agreePopulateLineItems(c);
}

function agreePopulateLineItems(c) {
  var container = document.getElementById("agreeLineItems");
  if (!container) return;
  // Always start empty - user selects their own items
  if (!window._agreeLineItems || window._agreeLineItems.length === 0) {
    window._agreeLineItems = [];
  }
  agreeRenderLineItems();
}

function agreeRenderLineItems() {
  var container = document.getElementById("agreeLineItems");
  if (!container) return;
  var items = window._agreeLineItems || [];
  if (items.length === 0) { container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--muted);font-size:11px">No line items. Click Add to add support items.</div>'; return; }

  var h = '<div style="display:flex;flex-direction:column;gap:6px">';
  items.forEach(function(item,idx){
    var isPH = item.name && item.name.toLowerCase().indexOf("public holiday") >= 0;
    var cardBg = isPH ? "rgba(245,158,11,.04)" : "var(--surface)";
    var cardBdr = isPH ? "1px solid rgba(245,158,11,.25)" : "1px solid var(--border)";
    h += '<div style="background:'+cardBg+';border:'+cardBdr+';border-radius:8px;padding:10px">';
    h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">';
    h += '<div style="display:flex;align-items:center;gap:6px">';
    h += '<span style="font-size:10px;font-weight:700;color:var(--royal);font-family:monospace">'+item.code+'</span>';
    if (isPH) h += '<span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:6px;background:rgba(245,158,11,.12);color:#92400E;border:1px solid rgba(245,158,11,.25)">üåü Once-off Fee</span>';
    h += '</div>';
    h += '<button onclick="agreeRemoveLineItem('+idx+')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 2px">‚úï</button>';
    h += '</div>';
    h += '<div style="font-size:12px;font-weight:600;color:var(--text);margin-bottom:6px">'+item.name+'</div>';
        h += '<div style="display:grid;grid-template-columns:1fr 1fr 80px;gap:6px">';
    h += '<div><div style="font-size:9px;color:var(--muted);font-weight:600;margin-bottom:2px">Rate</div><div style="font-size:11px;font-weight:600;color:var(--teal)">'+(item.rate)+'</div></div>';
    if (isPH) {
      h += '<div><div style="font-size:9px;color:#92400E;font-weight:600;margin-bottom:2px">Qty (# public holidays)</div>';
      h += '<input type="number" value="'+( item.qty||item.hours||1)+'" oninput="agreeUpdateLineItem('+idx+',\'qty\',this.value);agreeUpdateLineItem('+idx+',\'hours\',this.value);agreeUpdateSchedHours()" placeholder="1" min="1" style="width:100%;padding:4px 8px;border:1px solid rgba(245,158,11,.3);border-radius:5px;font-size:11px;font-family:inherit;background:rgba(245,158,11,.03)"></div>';
      h += '<div></div>';
    } else {
      h += '<div><label style="font-size:9px;color:var(--muted);font-weight:600;display:block;margin-bottom:2px">Est. Hours/Week</label>';
      h += '<input type="number" value="'+( item.hours||'')+'" oninput="agreeUpdateLineItem('+idx+',\'hours\',this.value);agreeUpdateSchedHours()" placeholder="0" style="width:100%;padding:4px 8px;border:1px solid var(--border);border-radius:5px;font-size:11px;font-family:inherit"></div>';
      h += '<div><label style="font-size:9px;color:var(--muted);font-weight:600;display:block;margin-bottom:2px">Ratio</label>';
      h += '<select onchange="agreeUpdateLineItem('+idx+',\'ratio\',this.value)" style="width:100%;padding:4px 6px;border:1px solid var(--border);border-radius:5px;font-size:11px;font-family:inherit;background:var(--surface);color:var(--text);cursor:pointer">';
      ['1:1','1:2','1:3','1:4','2:1','3:1','Group'].forEach(function(rv){
        h += '<option value="'+rv+'"'+((item.ratio||'1:1')===rv?' selected':'')+'>'+rv+'</option>';
      });
      h += '</select></div>';
    }
    h += '</div></div>';
  });
  h += '</div>';
  container.innerHTML = h;
}

function agreeAddLineItem() {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:10000';

  var picker = document.createElement('div');
  picker.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;z-index:10001;width:520px;max-width:96vw;box-shadow:0 16px 48px rgba(0,0,0,.25);display:flex;flex-direction:column;max-height:82vh';

  var title = document.createElement('div');
  title.innerHTML = '<div style="font-size:14px;font-weight:700;margin-bottom:4px">Add Support Item</div><div id="ndisPickerMeta" style="font-size:10px;color:var(--muted);margin-bottom:10px">Loading from Airtable\u2026</div>';

  var catFilter = document.createElement('select');
  catFilter.style.cssText = 'width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:7px;font-size:11px;font-family:inherit;margin-bottom:8px;background:var(--surface);color:var(--text)';
  catFilter.innerHTML = '<option value="">All Categories</option>';

  var searchBox = document.createElement('input');
  searchBox.type = 'text';
  searchBox.placeholder = 'Search by name, code or category\u2026';
  searchBox.style.cssText = 'width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;margin-bottom:10px;box-sizing:border-box;outline:none';

  var list = document.createElement('div');
  list.style.cssText = 'overflow-y:auto;flex:1;min-height:0';

  var cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.style.cssText = 'margin-top:10px;width:100%;padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;font-family:inherit';
  cancelBtn.onclick = function(){ document.body.removeChild(overlay); };
  overlay.onclick = function(e){ if(e.target===overlay){ document.body.removeChild(overlay); } };

  var allItems = [];

  function buildCatFilter(items) {
    var cats = {};
    items.forEach(function(i){ if(i.category) cats[i.category] = 1; });
    Object.keys(cats).sort().forEach(function(c){
      var opt = document.createElement('option');
      opt.value = c; opt.textContent = c;
      catFilter.appendChild(opt);
    });
  }

  function renderList(query, cat) {
    list.innerHTML = '';
    var q = (query||'').toLowerCase().trim();
    var c = cat || '';
    // Use live items if available, enriched with catalogue rates; else use catalogue directly
    var pool = allItems.length > 0 ? allItems : NDIS_CATALOGUE;
    // Enrich any item with rate=0 from NDIS_CATALOGUE
    pool = pool.map(function(item) {
      if (!item.rate || item.rate === 0) {
        var cat = NDIS_CATALOGUE.find(function(c){ return c.code === item.code; });
        if (cat && cat.rate) return Object.assign({}, item, {rate: cat.rate, remote: cat.remote, veryRemote: cat.veryRemote});
      }
      return item;
    });
    var filtered = pool.filter(function(item){
      var matchQ = !q || item.name.toLowerCase().indexOf(q) > -1 || (item.code||'').toLowerCase().indexOf(q) > -1 || (item.category||'').toLowerCase().indexOf(q) > -1;
      var matchC = !c || item.category === c;
      return matchQ && matchC;
    });
    var showing = q || c ? filtered : filtered.slice(0, 60);

    var meta = document.getElementById('ndisPickerMeta');
    if (meta) {
      if (allItems.length > 0) {
        meta.textContent = (q||c) ? (filtered.length + ' results from ' + allItems.length + ' items') : 'Showing 60 of ' + allItems.length + ' \u2014 type to search all ' + allItems.length + ' items';
      }
    }

    if (showing.length === 0) {
      list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">No items found</div>';
      return;
    }

    showing.forEach(function(item){
      var row = document.createElement('div');
      row.style.cssText = 'padding:9px 10px;border-radius:6px;cursor:pointer;border:1px solid var(--border);margin-bottom:4px;transition:background .1s';
      var rateStr = item.rate ? ('$' + (typeof item.rate === 'number' ? item.rate.toFixed(2) : item.rate)) : '';
      row.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">' +
          '<div style="font-size:12px;font-weight:600;flex:1">' + item.name + '</div>' +
          (rateStr ? '<div style="font-size:11px;font-weight:700;color:var(--teal);white-space:nowrap">' + rateStr + '</div>' : '') +
        '</div>' +
        '<div style="font-size:10px;color:var(--muted);margin-top:2px;display:flex;gap:8px">' +
          '<span style="font-family:monospace">' + (item.code||'') + '</span>' +
          (item.category ? '<span style="background:rgba(30,75,160,.06);color:var(--royal);padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700">' + item.category + '</span>' : '') +
        '</div>';
      row.onmouseover = function(){ this.style.background = 'rgba(10,147,150,.05)'; };
      row.onmouseout = function(){ this.style.background = ''; };
      row.onclick = function(){
        agreeSelectLineItem(item.code, item);
        document.body.removeChild(overlay);
      };
      list.appendChild(row);
    });
  }

  // Fetch live from Airtable
  list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 8px"></div>Loading NDIS Price Guide from Airtable\u2026</div>';

  apiCall('GET', '/api/ndis-items').then(function(data) { // fetches from Airtable 'NDIS Price Guide 2025 - 2026'
    if (data && data.items && data.items.length > 0) {
      // Merge Airtable items with NDIS_CATALOGUE rates as fallback for rate=0
      allItems = data.items.map(function(item) {
        if (!item.rate || item.rate === 0) {
          var local = NDIS_CATALOGUE.find(function(c){ return c.code === item.code; });
          if (local && local.rate) item.rate = local.rate;
        }
        return item;
      });
      window._ndisLiveItems = allItems;
      buildCatFilter(allItems);
      var meta = document.getElementById('ndisPickerMeta');
      if (meta) meta.textContent = allItems.length + ' items loaded from NDIS Price Guide 2025-26';
      renderList(searchBox.value, catFilter.value);
    } else {
      // Fall back to local catalogue
      allItems = NDIS_CATALOGUE.slice();
      buildCatFilter(allItems);
      var meta = document.getElementById('ndisPickerMeta');
      if (meta) meta.style.color = '#F59E0B';
      if (meta) meta.textContent = 'NDIS Price Guide 2025-26 unavailable \u2014 using local fallback (' + NDIS_CATALOGUE.length + ' items)';
      renderList(searchBox.value, catFilter.value);
    }
  }).catch(function() {
    allItems = NDIS_CATALOGUE.slice();
    buildCatFilter(allItems);
    var meta = document.getElementById('ndisPickerMeta');
    if (meta) { meta.style.color = '#F59E0B'; meta.textContent = 'Could not reach Airtable \u2014 using local fallback (may be outdated)'; }
    renderList(searchBox.value, catFilter.value);
  });

  searchBox.oninput = function(){ renderList(this.value, catFilter.value); };
  catFilter.onchange = function(){ renderList(searchBox.value, this.value); };

  picker.appendChild(title);
  picker.appendChild(catFilter);
  picker.appendChild(searchBox);
  picker.appendChild(list);
  picker.appendChild(cancelBtn);
  overlay.appendChild(picker);
  document.body.appendChild(overlay);
  setTimeout(function(){ searchBox.focus(); }, 100);
}


window.agreeSelectLineItem = function(code, itemObj) {
  var item = itemObj || (window._ndisLiveItems||[]).find(function(x){ return x.code===code; }) || NDIS_CATALOGUE.find(function(x){ return x.code===code; });
  if (!item) return;
  window._agreeLineItems = window._agreeLineItems||[];
  // Ensure rate is set from NDIS_CATALOGUE if Airtable returned 0
  if (!item.rate || item.rate === 0) {
    var cat = NDIS_CATALOGUE.find(function(c){ return c.code === item.code; });
    if (cat) item.rate = cat.rate;
  }
  window._agreeLineItems.push(Object.assign({},item,{hours:"",qty:1,ratio:"1:1",total:""}));
  agreeRenderLineItems();
  if (window._agreePicker) window._agreePicker.remove();
};

window.agreeRemoveLineItem = function(idx) {
  window._agreeLineItems.splice(idx,1);
  agreeRenderLineItems();
};

window.agreeUpdateLineItem = function(idx,field,val) {
  if (window._agreeLineItems && window._agreeLineItems[idx]) {
    window._agreeLineItems[idx][field] = val;
  }
};

function agreeCollectData() {
  function v(id){ var el=document.getElementById(id); return el?(el.value||""):""; }
  var schedDays = {};
  ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"].forEach(function(d){
    var start = v("agreeSchedStart_"+d);
    var end = v("agreeSchedEnd_"+d);
    if (start || end) schedDays[d] = {start: start, end: end, text: (start&&end) ? start+" - "+end : (start||end)};
  });

  return {
    client: _agreeClient,
    startDate: v("agreeStartDate"),
    endDate: v("agreeEndDate"),
    planStartDate: v("agreePlanStartDate"),
    planEndDate: v("agreePlanEndDate"),
    serviceType: (function(){
      var checked=[];
      document.querySelectorAll('#agreeServiceTypeChips button[data-selected="1"]').forEach(function(btn){
        checked.push(btn.getAttribute('data-svc'));
      });
      return checked.join(', ');
    })(),
    planMgmt: v("agreePlanMgmt"),
    lineItems: window._agreeLineItems||[],
    schedule: schedDays,
    weeklyHours: v("agreeWeeklyHours"),
    budget: v("agreeBudget"),
    prvName: v("agreePrvName"),
    prvRole: v("agreePrvRole"),
    prvEmail: v("agreePrvEmail"),
    prvPhone: v("agreePrvPhone"),
    sigPartName: v("agreeSigPartName"),
    sigPartPhone: v("agreeSigPartPhone"),
    sigPartEmail: v("agreeSigPartEmail"),
    sigNomName: v("agreeSigNomName"),
    sigNomRel: v("agreeSigNomRel"),
    cancelPolicy: v("agreeTerm_cancel"),
    noticePeriod: v("agreeTerm_notice"),
    priceGuide: "NDIS Price Arrangements 2025-26",
    invoiceFreq: v("agreeTerm_invoice"),
    paymentTerms: v("agreeTerm_payment"),
    extraTerms: v("agreeTermsExtra")
  };
}

function agreeSaveDraftShifts(d) {
  // Build recurring weekly shifts from schedule of support, status = Draft
  var c = d.client || {};
  var clientName = c.name || "";
  if (!clientName || !d.startDate) return Promise.resolve([]);

  var days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  var dayOffsets = {Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4,Saturday:5,Sunday:6};
  var shifts = [];
  var agreementStart = new Date(d.startDate);
  var planEnd = d.planEndDate ? new Date(d.planEndDate) : null;
  var endDate = planEnd || new Date(agreementStart.getTime() + 52*7*24*60*60*1000);

  days.forEach(function(day) {
    var sched = (d.schedDays||{})[day];
    if (!sched || !sched.start || !sched.end) return;

    // Find first occurrence of this day on or after agreement start
    var startDow = agreementStart.getDay(); // 0=Sun,1=Mon...
    var targetDow = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].indexOf(day);
    var diff = (targetDow - startDow + 7) % 7;
    var firstDate = new Date(agreementStart.getTime() + diff*24*60*60*1000);

    // Create a shift for every week from firstDate to endDate
    var cur = new Date(firstDate);
    while (cur <= endDate) {
      var dateStr = cur.getFullYear()+"-"+("0"+(cur.getMonth()+1)).slice(-2)+"-"+("0"+cur.getDate()).slice(-2);
      shifts.push({
        "Client Name": clientName,
        "Staff Name": "",
        "Start Shift": dateStr+"T"+sched.start+":00",
        "End Shift": dateStr+"T"+sched.end+":00",
        "Status": "Draft",
        "Shift Type": d.serviceType || "Support",
        "Notes": "Auto-created from Service Agreement. DRAFT - pending agreement signature.",
        "Agreement ID": d.agreeId || ""
      });
      cur = new Date(cur.getTime() + 7*24*60*60*1000);
    }
  });

  if (shifts.length === 0) return Promise.resolve([]);

  // Post all shifts to Airtable via server in batches of 10
  var batches = [];
  for (var i=0; i<shifts.length; i+=10) batches.push(shifts.slice(i,i+10));

  return batches.reduce(function(chain, batch) {
    return chain.then(function() {
      return apiCall("POST", "/api/shifts/draft-bulk", {shifts: batch});
    });
  }, Promise.resolve()).then(function() {
    console.log("Draft shifts created:", shifts.length);
    return shifts;
  }).catch(function(e) {
    console.warn("Could not save draft shifts:", e);
    return [];
  });
}

function agreeGenerate() {
  var d = agreeCollectData();
  // Create draft shifts when preview generated
  agreeSaveDraftShifts(d);
  var c = d.client || {};
  if (!c.name && !d.sigPartName) { alert("Please select a client first."); return; }

  var clientName = c.name || d.sigPartName || "Participant";
  var ndisNum = c.ndisNumber || "";
  var dob = c.dob||c.dateOfBirth||"";
  if (dob) { try { var dp=new Date(dob); if(!isNaN(dp)) dob=("0"+dp.getDate()).slice(-2)+"/"+(("0"+(dp.getMonth()+1)).slice(-2))+"/"+dp.getFullYear(); } catch(e){} }
  var addr = [c.address,c.suburb,c.state,c.postcode].filter(Boolean).join(", ") || "";
  var agreeId = (c.airtableId||c.id||"").replace("rec","rec").substring(0,9) || "‚Äî";
  var nominee = d.sigNomName || c.nominee || "";
  var nomRel = d.sigNomRel || "";
  var planMgr = c.planManager || "";
  var planMgrEmail = c.planManagerEmail || "";
  var planStart = d.planStartDate || c.planStart || "";
  var planEnd = d.planEndDate || c.planEnd || "";
  var planType = c.planType || d.planMgmt || "";

  function fmtDate(s){
    if(!s) return "‚Äî";
    try { var dd=new Date(s); if(!isNaN(dd)) return ("0"+dd.getDate()).slice(-2)+"/"+(("0"+(dd.getMonth()+1)).slice(-2))+"/"+dd.getFullYear(); } catch(e){}
    return s;
  }

  // Calculate weeks: Agreement Start -> NDIS Plan End
  var weeks = "";
  var weeksEnd = d.planEndDate || d.endDate || "";
  if (d.startDate && weeksEnd) {
    try {
      var ms = new Date(weeksEnd) - new Date(d.startDate);
      weeks = Math.round(ms / (7*24*60*60*1000));
    } catch(e) {}
  }

  // Calculate totals - split PH items into once-off
  var allItems = d.lineItems || [];
  var lineItems = allItems.filter(function(i){ return !i.name||i.name.toLowerCase().indexOf("public holiday")<0; });
  var phItems = allItems.filter(function(i){ return i.name&&i.name.toLowerCase().indexOf("public holiday")>=0; });
  var weeklyTotal = 0;
  lineItems.forEach(function(item) {
    var rate = parseFloat(item.rate)||0;
    var hrs = parseFloat(item.hours)||0;
    var qty = parseFloat(item.qty)||1;
    item._weekly = rate * hrs * qty;
    weeklyTotal += item._weekly;
  });
  var totalWeeklyValue = weeklyTotal * (weeks||1);

  // Once-off fees: establishment fee + PH items
  var onceOffFees = [];
  var estFee = { name:"Establishment Fee For Personal Care/Participation", code:"04_049_0104_1_1", rate:702.30, qty:1 };
  onceOffFees.push(estFee);
  phItems.forEach(function(item) {
    var qty = parseFloat(item.qty)||parseFloat(item.hours)||1;
    onceOffFees.push({ name:item.name, code:item.code, rate:parseFloat(item.rate)||0, qty:qty });
  });
  var totalOnceOff = onceOffFees.reduce(function(s,f){ return s + (f.rate * f.qty); }, 0);
  var totalAgreementValue = totalWeeklyValue + totalOnceOff;

  function money(n) { return "$"+(parseFloat(n)||0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","); }

  var logoHtml = (typeof DCS_LOGO_B64 !== "undefined") ? '<img src="'+DCS_LOGO_B64+'" style="height:52px;object-fit:contain">' : '<div style="font-size:16pt;font-weight:900;color:#1E4BA0">DCS</div>';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGE 1 ‚Äî SCHEDULE OF SUPPORTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var css = '<style>*{box-sizing:border-box}body{font-family:Arial,sans-serif;font-size:9.5pt;color:#111;margin:0}.page{width:210mm;min-height:297mm;padding:14mm 14mm;background:#fff;page-break-after:always}.box{border:1px solid #ccc;border-radius:4px;padding:12px 14px;margin-bottom:10px}.box-title{font-weight:700;font-size:10pt;border-bottom:1px solid #ddd;padding-bottom:6px;margin-bottom:10px}.label{font-size:8pt;color:#666;margin-bottom:1px}.value{font-weight:700;font-size:10pt;margin-bottom:6px}table{width:100%;border-collapse:collapse}th{background:#f5f5f5;font-size:8.5pt;font-weight:700;padding:7px 8px;border:1px solid #ddd;text-align:left}td{padding:7px 8px;border:1px solid #ddd;font-size:9pt}.total-row td{font-weight:700;background:#f0f0f0}.grand-box{border:1px solid #ccc;border-radius:4px;overflow:hidden;margin-top:10px}.grand-row{display:flex;justify-content:space-between;padding:8px 14px;border-bottom:1px solid #ddd;font-size:9.5pt}.grand-row:last-child{border-bottom:none}.grand-total-row{display:flex;justify-content:space-between;padding:10px 14px;font-weight:900;font-size:11pt;background:#f5f5f5}.page-footer{text-align:center;font-size:7.5pt;color:#888;margin-top:16px;border-top:1px solid #eee;padding-top:8px}.sig-line{border-bottom:1px solid #333;margin:32px 0 6px;height:1px}.sig-label{font-size:8pt;color:#444}.h1{font-size:18pt;font-weight:900;margin:0 0 2px}.h1-sub{font-size:9pt;color:#555}.badge{display:inline-block;border:1px solid #333;border-radius:3px;padding:2px 8px;font-size:8.5pt;font-weight:700;margin:6px 0 10px}@media print{.page{page-break-after:always}}</style>';

  var pageFooter = '<div class="page-footer">Page {PAGE} of 7 | Created using Titus CRM Software visit www.tituscrm.com.au | Created on '+new Date().toLocaleDateString("en-AU",{day:"2-digit",month:"2-digit",year:"2-digit"})+" at "+new Date().toLocaleTimeString("en-AU",{hour:"2-digit",minute:"2-digit",hour12:false})+'</div>';

  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">'+css+'</head><body>';

  // ‚îÄ‚îÄ PAGE 1: Schedule of Supports ‚îÄ‚îÄ
  html += '<div class="page">';
  // Header
  html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">';
  html += '<div><div class="h1">Schedule of Supports</div><div class="h1-sub">NDIS Service Agreement</div><div class="badge">Agreement ID: '+agreeId+'</div></div>';
  html += '<div>'+logoHtml+'</div></div>';

  // Provider + Participant boxes
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">';
  // Provider
  html += '<div class="box"><div class="box-title">Provider Details</div>';
  html += '<div class="label">Organisation</div><div class="value">Delta Community Support</div>';
  html += '<div class="label">NDIS Provider #</div><div class="value">405018246</div>';
  html += '<div class="label">Contact</div><div class="value">Angela Te Hira</div>';
  html += '<div class="label">Email</div><div class="value">angelat@deltacommunity.com.au</div>';
  html += '</div>';
  // Participant
  html += '<div class="box"><div class="box-title">Participant Details</div>';
  html += '<div class="label">Name</div><div class="value">'+clientName+'</div>';
  if(ndisNum) { html += '<div class="label">NDIS Number</div><div class="value">'+ndisNum+'</div>'; }
  if(dob) { html += '<div class="label">Date of Birth</div><div class="value">'+dob+'</div>'; }
  html += '</div>';
  html += '</div>';

  // Agreement Period
  html += '<div class="box" style="margin-bottom:10px"><div class="box-title">Agreement Period</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">';
  html += '<div><div class="label">Agreement Start</div><div class="value">'+fmtDate(d.startDate)+'</div></div>';
  html += '<div><div class="label">NDIS Plan Period</div><div class="value">'+(planStart?fmtDate(planStart):"‚Äî")+(planEnd?" - "+fmtDate(planEnd):"")+'</div></div>';
  html += '<div><div class="label">Duration</div><div class="value">'+(weeks?weeks+" weeks":"‚Äî")+'</div></div>';
  html += '</div></div>';

  // Weekly Support Items table
  html += '<div class="box-title" style="font-size:10.5pt;margin:10px 0 6px">Weekly Support Items</div>';
  html += '<table><thead><tr><th>Support Item</th><th style="width:120px">Code</th><th style="width:60px;text-align:right">Rate</th><th style="width:40px;text-align:right">Qty</th><th style="width:50px;text-align:center">Ratio</th><th style="width:80px;text-align:right">Weekly</th></tr></thead><tbody>';
  if (lineItems.length > 0) {
    lineItems.forEach(function(item) {
      var ratio = item.ratio || "1:1";
      var qty = item.qty || item.hours || 1;
      var dispQty = parseFloat(item.hours)||parseFloat(item.qty)||1;
      html += '<tr><td>'+item.name+'</td><td style="font-family:monospace;font-size:8pt">'+item.code+'</td><td style="text-align:right">'+money(item.rate)+'</td><td style="text-align:right">'+dispQty+'</td><td style="text-align:center">'+ratio+'</td><td style="text-align:right">'+money(item._weekly)+'</td></tr>';
    });
  } else {
    html += '<tr><td colspan="6" style="text-align:center;color:#888">No line items added</td></tr>';
  }
  html += '<tr class="total-row"><td colspan="5" style="text-align:right">Total Weekly:</td><td style="text-align:right">'+money(weeklyTotal)+'</td></tr>';
  html += '<tr class="total-row"><td colspan="5" style="text-align:right">Total Weekly Value ('+(weeks||"?")+" weeks):</td><td style=\"text-align:right\">"+money(totalWeeklyValue)+'</td></tr>';
  html += '</tbody></table>';

  // Once-off Fees table
  html += '<div class="box-title" style="font-size:10.5pt;margin:12px 0 6px">Once-off Fees</div>';
  html += '<table><thead><tr><th>Fee Description</th><th style="width:120px">Code</th><th style="width:80px;text-align:right">Rate</th><th style="width:40px;text-align:right">Qty</th><th style="width:80px;text-align:right">Total</th></tr></thead><tbody>';
  onceOffFees.forEach(function(f) {
    html += '<tr><td>'+f.name+'</td><td style="font-family:monospace;font-size:8pt">'+f.code+'</td><td style="text-align:right">'+money(f.rate)+'</td><td style="text-align:right">'+f.qty+'</td><td style="text-align:right">'+money(f.rate*f.qty)+'</td></tr>';
  });
  html += '<tr class="total-row"><td colspan="4" style="text-align:right">Total Once-off Fees:</td><td style="text-align:right">'+money(totalOnceOff)+'</td></tr>';
  html += '</tbody></table>';

  // Grand total summary box
  html += '<div class="grand-box" style="margin-top:12px">';
  html += '<div class="grand-row"><span>Total Weekly Value ('+(weeks||"?")+" weeks):</span><span>"+money(totalWeeklyValue)+'</span></div>';
  html += '<div class="grand-row"><span>Total Once-off Fees:</span><span>'+money(totalOnceOff)+'</span></div>';
  html += '<div class="grand-total-row"><span>TOTAL AGREEMENT VALUE:</span><span>'+money(totalAgreementValue)+'</span></div>';
  html += '</div>';

  html += pageFooter.replace("{PAGE}","1");
  html += '</div>'; // end page 1

  // ‚îÄ‚îÄ PAGE 2: Schedule Signature Page ‚îÄ‚îÄ
  html += '<div class="page">';
  html += '<div style="margin-bottom:40px"><div style="font-weight:700;font-size:10pt;margin-bottom:24px">Participant / Representative - Schedule of Support</div>';
  html += '<div style="margin-bottom:16px"><div class="label">Name:</div><div class="sig-line"></div></div>';
  html += '<div><div class="label">Signature:</div><div class="sig-line"></div></div>';
  html += '</div>';
  html += '<div><div style="font-weight:700;font-size:10pt;margin-bottom:24px">Provider Representative - Schedule of Support</div>';
  html += '<div style="margin-bottom:16px"><div class="label">Name:</div><div class="sig-line"></div></div>';
  html += '<div><div class="label">Signature:</div><div class="sig-line"></div></div>';
  html += '</div>';
  html += pageFooter.replace("{PAGE}","2");
  html += '</div>'; // end page 2

  // ‚îÄ‚îÄ PAGE 3: Service Agreement + Parties ‚îÄ‚îÄ
  html += '<div class="page">';
  html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">';
  html += '<div><div class="h1">NDIS Service Agreement</div><div class="h1-sub">National Disability Insurance Scheme</div><div class="badge">Agreement ID: '+agreeId+'</div></div>';
  html += '<div>'+logoHtml+'</div></div>';

  html += '<p style="font-size:8.5pt;margin-bottom:14px">This Service Agreement is made in accordance with the <strong>National Disability Insurance Scheme Act 2013 (NDIS Act)</strong>, associated NDIS Rules, the <strong>NDIS Practice Standards</strong>, the <strong>NDIS Code of Conduct</strong>, the <strong>Privacy Act 1988 (Cth)</strong>, and the <strong>Australian Consumer Law (ACL)</strong>.</p>';

  html += '<div style="font-weight:900;font-size:11pt;border-bottom:2px solid #111;margin-bottom:10px;padding-bottom:4px">1. PARTIES TO THE AGREEMENT</div>';

  // 1.1 Participant
  html += '<div class="box" style="margin-bottom:8px"><div class="box-title">1.1 Participant</div>';
  html += '<div class="label">Full Name</div><div class="value">'+clientName+'</div>';
  if(ndisNum){ html += '<div class="label">NDIS Number</div><div class="value">'+ndisNum+'</div>'; }
  if(dob){ html += '<div class="label">Date of Birth</div><div class="value">'+dob+'</div>'; }
  if(addr){ html += '<div class="label">Address</div><div class="value">'+addr+'</div>'; }
  html += '</div>';

  // 1.2 Representatives/Advocates
  if (nominee || c.emergencyContact) {
    html += '<div class="box" style="margin-bottom:8px"><div class="box-title">1.2 Representatives/Advocates</div>';
    html += '<table><thead><tr><th>Name</th><th>Relationship</th><th>Email</th><th>Phone</th></tr></thead><tbody>';
    if (nominee) {
      html += '<tr><td>'+nominee+'</td><td>'+(nomRel||"‚Äî")+'</td><td>'+(c.nomineeEmail||"‚Äî")+'</td><td>'+(c.nomineePhone||"‚Äî")+'</td></tr>';
    }
    if (c.emergencyContact) {
      html += '<tr><td>'+c.emergencyContact+'</td><td>'+(c.emergencyRelationship||"Emergency Contact")+'</td><td>‚Äî</td><td>'+(c.emergencyPhone||"‚Äî")+'</td></tr>';
    }
    html += '</tbody></table></div>';
  }

  // 1.3 Provider
  html += '<div class="box" style="margin-bottom:8px"><div class="box-title">1.3 Provider</div>';
  html += '<div class="label">Legal Entity Name</div><div class="value">Delta Community Support</div>';
  html += '<div class="label">Type of Organisation</div><div class="value">NDIS Registered Organisation</div>';
  html += '<div class="label">ABN</div><div class="value">28616760206</div>';
  html += '<div class="label">NDIS Provider #</div><div class="value">405018246</div>';
  html += '<div class="label">Contact Email / Phone</div><div class="value">angelat@deltacommunity.com.au</div>';
  html += '</div>';

  // Plan Management Details
  html += '<div class="box" style="margin-bottom:8px"><div class="box-title">Plan Management Details</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
  html += '<div><div class="label">NDIS Plan Start Date</div><div class="value">'+(planStart?fmtDate(planStart):"‚Äî")+'</div></div>';
  html += '<div><div class="label">NDIS Plan End Date</div><div class="value">'+(planEnd?fmtDate(planEnd):"‚Äî")+'</div></div>';
  html += '<div><div class="label">Type of NDIS Plan</div><div class="value">'+(planType||"‚Äî")+'</div></div>';
  html += '<div><div class="label">Plan Intensity</div><div class="value">Standard NDIS Plan</div></div>';
  if (planMgr) {
    html += '<div><div class="label">Plan Manager Name</div><div class="value">'+planMgr+'</div></div>';
    html += '<div><div class="label">Plan Manager Email</div><div class="value">'+(planMgrEmail||"‚Äî")+'</div></div>';
  }
  html += '</div></div>';

  // 1. Scope of Services
  html += '<div style="font-weight:900;font-size:11pt;border-bottom:2px solid #111;margin:14px 0 10px;padding-bottom:4px">1. SCOPE OF SERVICES</div>';
  html += '<p style="font-size:8.5pt;margin-bottom:6px"><strong>1.1</strong> The Provider will deliver supports in accordance with:</p>';
  html += '<ul style="font-size:8.5pt;margin:0 0 8px;padding-left:20px"><li>The Schedule of Supports</li><li>The Participant\'s current NDIS Plan</li><li>The National Disability Insurance Scheme Act 2013 and associated Rules</li><li>The NDIS Practice Standards and Code of Conduct</li><li>The current NDIS Pricing Arrangements and Price Limits</li></ul>';
  html += '<p style="font-size:8.5pt;margin-bottom:6px"><strong>1.2</strong> This Agreement may include the provision of:</p>';
  html += '<ul style="font-size:8.5pt;margin:0 0 8px;padding-left:20px"><li>Community Access</li><li>In-Home Supports</li><li>Supported Independent Living (SIL)</li><li>Short Term Accommodation (STA)</li></ul>';
  html += '<p style="font-size:8.5pt;margin-bottom:4px"><strong>1.3</strong> Supports are subject to funding availability, workforce availability, and safety, legal, and operational requirements.</p>';
  html += '<p style="font-size:8.5pt;margin-bottom:4px"><strong>1.4</strong> The Provider does not guarantee specific staff members, exact times, or continuity of individual workers.</p>';
  html += '<p style="font-size:8.5pt;margin-bottom:4px"><strong>1.5</strong> The Provider may vary, substitute, suspend, or withdraw supports where reasonably necessary to manage safety, compliance, operational viability, or financial risk.</p>';

  html += pageFooter.replace("{PAGE}","3");
  html += '</div>'; // end page 3

  // ‚îÄ‚îÄ PAGE 4: T&Cs Continued ‚îÄ‚îÄ
  html += '<div class="page">';

  var sections = [
    { num:"2", title:"PARTICIPANT RESPONSIBILITIES", body:[
      "<strong>2.1</strong> The Participant, their representatives, household members, and visitors must:<ul style='margin:4px 0 6px;padding-left:20px'><li>Treat staff with dignity, courtesy, and respect</li><li>Provide safe and reasonable access for service delivery</li><li>Maintain a safe environment free from hazards</li><li>Provide accurate, complete, and current information</li><li>Notify the Provider promptly of changes to circumstances, risks, funding, or support needs</li><li>Pay all amounts due under this Agreement</li></ul>",
      "<strong>2.2</strong> The Participant must not request supports that are unlawful, unsafe, or outside the agreed scope."
    ]},
    { num:"3", title:"SAFETY, CONDUCT, AND ZERO TOLERANCE", body:[
      "<strong>3.1</strong> The Provider applies a zero-tolerance approach to violence, threats, harassment, intimidation, discrimination, sexual harassment, coercion, or unsafe conduct.",
      "<strong>3.2</strong> Where safety is at risk, the Provider may immediately:<ul style='margin:4px 0 6px;padding-left:20px'><li>Withdraw staff</li><li>Suspend supports</li><li>Terminate this Agreement</li><li>Contact emergency services or relevant authorities</li></ul>",
      "<strong>3.3</strong> The Provider is not required to continue service delivery where it is unsafe to do so."
    ]},
    { num:"4", title:"DISCLOSURE OF RISKS AND COOPERATION", body:[
      "<strong>4.1</strong> The Participant must disclose all known risks relevant to service delivery, including behavioural, medical, environmental, and safety risks.",
      "<strong>4.2</strong> The Participant agrees to cooperate with incident management, investigations, and regulatory reporting.",
      "<strong>4.3</strong> Failure to disclose material risks may result in suspension or termination of supports and recovery of reasonable costs incurred, to the extent permitted by law."
    ]},
    { num:"5", title:"CONSENT, AUTHORITY, AND DECISION-MAKING", body:[
      "<strong>5.1</strong> The Participant consents to reasonable operational decisions necessary to deliver supports safely and lawfully, including the use of employees and contractors.",
      "<strong>5.2</strong> Where a nominee, guardian, or representative acts on behalf of the Participant, they warrant they have lawful authority to enter into and manage this Agreement.",
      "<strong>5.3</strong> The Provider may request evidence of authority at any time.",
      "<strong>5.4</strong> Instructions that are unlawful, unsafe, or inconsistent with NDIS requirements will not be followed."
    ]},
    { num:"6", title:"PROFESSIONAL BOUNDARIES", body:[
      "<strong>6.1</strong> Staff must maintain professional boundaries at all times.",
      "<strong>6.2</strong> The Participant must not:<ul style='margin:4px 0 6px;padding-left:20px'><li>Offer gifts, money, loans, or benefits to staff</li><li>Seek personal, financial, or social relationships with staff</li><li>Request services outside the agreed supports</li></ul>",
      "<strong>6.3</strong> Boundary concerns may result in staff reassignment, service modification, or withdrawal of supports."
    ]},
    { num:"7", title:"FEES, PRICING, AND FUNDING RESPONSIBILITY", body:[
      "<strong>7.1</strong> Supports are charged in accordance with the Schedule of Supports and the current NDIS Pricing Arrangements.",
      "<strong>7.2</strong> The Participant acknowledges that:<ul style='margin:4px 0 6px;padding-left:20px'><li>The Provider does not guarantee sufficient NDIS funding</li><li>NDIA or plan manager delays do not remove the obligation to pay for supports delivered</li><li>Supports delivered remain payable even if funding is later exhausted, to the extent permitted by law</li></ul>",
      "<strong>7.3</strong> Where the NDIA or a plan manager fails to pay, the Participant remains ultimately responsible for payment, to the extent permitted by law."
    ]}
  ];

  sections.forEach(function(s) {
    html += '<div style="font-weight:900;font-size:10.5pt;border-bottom:1.5px solid #111;margin:10px 0 6px;padding-bottom:3px">'+s.num+'. '+s.title+'</div>';
    s.body.forEach(function(p) { html += '<p style="font-size:8.5pt;margin-bottom:4px">'+p+'</p>'; });
  });

  html += pageFooter.replace("{PAGE}","4");
  html += '</div>'; // end page 4

  // ‚îÄ‚îÄ PAGE 5: T&Cs Continued ‚îÄ‚îÄ
  html += '<div class="page">';

  var sections2 = [
    { num:"8", title:"INVOICING AND PAYMENT TERMS", body:[
      "<strong>8.1</strong> Invoices will be issued weekly in arrears unless otherwise agreed in writing.",
      "<strong>8.2</strong> Invoices may be issued to the NDIA, plan manager, or the Participant depending on plan management arrangements.",
      "<strong>8.3</strong> Invoices must be paid by the due date specified on the invoice."
    ]},
    { num:"9", title:"OVERDUE INVOICES AND SUSPENSION OF SUPPORTS", body:[
      "<strong>9.1</strong> An invoice is overdue immediately after the due date if not paid in full.",
      "<strong>9.2</strong> If an invoice remains overdue, services will be suspended until all outstanding amounts are paid in full and the account is brought up to date.",
      "<strong>9.3</strong> The Provider is under no obligation to continue services while any invoice remains overdue.",
      "<strong>9.4</strong> Services will only recommence once all overdue amounts are paid and any reasonable conditions (including payment in advance) are met.",
      "<strong>9.5</strong> The Provider is not liable for any loss or inconvenience arising from suspension due to non-payment."
    ]},
    { num:"10", title:"DEBT RECOVERY AND COLLECTION COSTS", body:[
      "<strong>10.1</strong> If amounts remain unpaid, the Provider may refer the debt to a third-party debt collection agency or commence legal recovery.",
      "<strong>10.2</strong> The Participant agrees to pay all reasonable recovery costs, including debt collection fees, legal costs, court fees, and administrative costs, to the extent permitted by law.",
      "<strong>10.3</strong> The Provider may charge reasonable interest on overdue amounts as permitted by law."
    ]},
    { num:"11", title:"MINIMUM SHIFT LENGTH", body:[
      "<strong>11.1</strong> A minimum shift length of five (5) hours applies to all supports delivered under this Agreement.",
      "<strong>11.2</strong> Where a shift is rostered or delivered for less than five (5) hours, the minimum five (5) hours will be charged unless otherwise agreed in writing."
    ]},
    { num:"12", title:"CANCELLATIONS AND NON-ATTENDANCE", body:[
      "<strong>12.1</strong> The Participant must provide at least two (2) clear business days' notice to cancel any scheduled shift or support.",
      "<strong>12.2</strong> Where cancellation occurs with less than two (2) business days' notice, the Provider will charge 100% of the scheduled shift, subject to a minimum of five (5) hours, at the applicable rate.",
      "<strong>12.3</strong> Failure to attend, refusal of service, unsafe environments, or failure to provide access will be treated as a short-notice cancellation.",
      "<strong>12.4</strong> Repeated cancellations may result in review, requirement for payment in advance, reduction of services, or termination of this Agreement.",
      "<strong>12.5</strong> Cancellation charges will only be applied to the extent permitted under the current NDIS Pricing Arrangements."
    ]},
    { num:"13", title:"SUPPORTED INDEPENDENT LIVING (IF APPLICABLE)", body:[
      "<strong>13.1</strong> SIL supports are delivered in shared or individual living arrangements.",
      "<strong>13.2</strong> The Provider allows up to seven (7) consecutive days per NDIS Plan period for absences due to hospitalisation, planned or unplanned leave, or temporary relocation.",
      "<strong>13.3</strong> After seven (7) days, SIL charges may continue where staffing, accommodation, utilities, and fixed operational costs continue to be incurred, to the extent permitted by NDIS rules."
    ]},
    { num:"14", title:"SHORT TERM ACCOMMODATION (IF APPLICABLE)", body:[
      "<strong>14.1</strong> STA is temporary and does not create a tenancy, lease, or residential rights.",
      "<strong>14.2</strong> The Participant must comply with reasonable house rules and safety requirements.",
      "<strong>14.3</strong> Early departure does not entitle the Participant to a refund where fixed costs have been incurred, to the extent permitted by law.",
      "<strong>14.4</strong> The Participant is responsible for damage or excess cleaning caused by them or their visitors.",
      "<strong>14.5</strong> The Provider may terminate STA immediately for safety risks, serious misconduct, damage, or non-payment."
    ]},
    { num:"15", title:"NON-SOLICITATION OF STAFF", body:[
      "<strong>15.1</strong> The Participant agrees that they, and their agents, representatives, nominees, family members, or related parties, must not directly or indirectly solicit, engage, employ, or contract any staff member introduced to them by the Provider.",
      "<strong>15.2</strong> This restriction applies:<ul style='margin:4px 0 6px;padding-left:20px'><li>During the term of this Agreement; and</li><li>For a period of twelve (12) months from the date of the staff member's first introduction to the Participant.</li></ul>",
      "<strong>15.3</strong> This includes direct employment, independent contracting, or engagement through another entity.",
      "<strong>15.4</strong> The Participant acknowledges that this clause is reasonable and necessary to protect the Provider's workforce and business."
    ]}
  ];

  sections2.forEach(function(s) {
    html += '<div style="font-weight:900;font-size:10.5pt;border-bottom:1.5px solid #111;margin:10px 0 6px;padding-bottom:3px">'+s.num+'. '+s.title+'</div>';
    s.body.forEach(function(p) { html += '<p style="font-size:8.5pt;margin-bottom:4px">'+p+'</p>'; });
  });

  html += pageFooter.replace("{PAGE}","5");
  html += '</div>'; // end page 5

  // ‚îÄ‚îÄ PAGE 6: T&Cs Final ‚îÄ‚îÄ
  html += '<div class="page">';

  var sections3 = [
    { num:"16", title:"RESTRICTIVE PRACTICES", body:[
      "<strong>16.1</strong> Restrictive practices are prohibited unless lawfully authorised, included in an approved Behaviour Support Plan, and implemented by trained staff.",
      "<strong>16.2</strong> The Provider may suspend or withdraw supports where behaviour presents unmanaged risk."
    ]},
    { num:"17", title:"PRIVACY, RECORDING, AND MONITORING", body:[
      "<strong>17.1</strong> Personal information is handled in accordance with privacy laws and NDIS requirements.",
      "<strong>17.2</strong> The Participant must not audio or video record staff without consent, except where permitted by law.",
      "<strong>17.3</strong> The Provider may maintain records and monitoring systems for compliance, safety, quality, and financial management."
    ]},
    { num:"18", title:"COMPLAINTS AND FEEDBACK", body:[
      "<strong>18.1</strong> Complaints may be made to the Provider or the NDIS Quality and Safeguards Commission.",
      "<strong>18.2</strong> Making a complaint in good faith will not result in disadvantage."
    ]},
    { num:"19", title:"LIMITATION OF LIABILITY", body:[
      "<strong>19.1</strong> To the extent permitted by law, the Provider is not liable for indirect or consequential loss.",
      "<strong>19.2</strong> Nothing in this Agreement excludes rights under the Australian Consumer Law."
    ]},
    { num:"20", title:"FORCE MAJEURE", body:[
      "<strong>20.1</strong> The Provider is not liable for failure or delay in delivering supports due to events beyond reasonable control."
    ]},
    { num:"21", title:"GOVERNING LAW", body:[
      "<strong>21.1</strong> This Agreement is governed by the laws of Australia."
    ]},
    { num:"22", title:"ENTIRE AGREEMENT AND SEVERABILITY", body:[
      "<strong>22.1</strong> This Agreement, including the Schedule of Supports, constitutes the entire agreement.",
      "<strong>22.2</strong> If any clause is unenforceable, the remaining clauses continue to operate."
    ]}
  ];

  sections3.forEach(function(s) {
    html += '<div style="font-weight:900;font-size:10.5pt;border-bottom:1.5px solid #111;margin:10px 0 6px;padding-bottom:3px">'+s.num+'. '+s.title+'</div>';
    s.body.forEach(function(p) { html += '<p style="font-size:8.5pt;margin-bottom:4px">'+p+'</p>'; });
  });

  html += pageFooter.replace("{PAGE}","6");
  html += '</div>'; // end page 6

  // ‚îÄ‚îÄ PAGE 7: Consent + Service Agreement Signatures ‚îÄ‚îÄ
  html += '<div class="page">';
  html += '<div style="margin-bottom:20px"><div style="font-weight:700;font-size:10.5pt;border-bottom:1px solid #ccc;padding-bottom:6px;margin-bottom:12px">Consent Summary</div>';
  html += '<div class="label">Terms Accepted</div><div class="value">Yes</div>';
  html += '<div class="label">Terms Accepted At</div><div class="value">'+new Date().toLocaleDateString("en-AU",{day:"2-digit",month:"2-digit",year:"2-digit"})+" "+new Date().toLocaleTimeString("en-AU",{hour:"2-digit",minute:"2-digit",hour12:false})+" AEST"+'</div>';
  html += '<div class="label">Terms Version</div><div class="value">Website T&amp;Cs v1.0</div>';
  html += '<p style="font-size:8.5pt;margin-top:8px">By submitting this agreement, the user confirmed they have read and agree to the Titus CRM Terms &amp; Conditions and have authority to submit this information.</p>';
  html += '</div>';

  html += '<div style="margin-bottom:40px"><div style="font-weight:700;font-size:10pt;margin-bottom:24px">Participant / Representative - Service Agreement</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px">';
  html += '<div><div class="label">Name:</div><div class="sig-line"></div></div>';
  html += '<div><div class="label">Signature:</div><div class="sig-line"></div></div>';
  html += '<div><div class="label">Date:</div><div class="sig-line"></div></div>';
  html += '</div></div>';

  html += '<div><div style="font-weight:700;font-size:10pt;margin-bottom:24px">Provider Representative - Service Agreement</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">';
  html += '<div><div class="label">Name:</div><div class="sig-line"></div></div>';
  html += '<div><div class="label">Signature:</div><div class="sig-line"></div></div>';
  html += '<div><div class="label">Date:</div><div class="sig-line"></div></div>';
  html += '</div></div>';

  html += pageFooter.replace("{PAGE}","7");
  html += '</div>'; // end page 7

  html += '</body></html>';

  // Show preview (simplified version without the full CSS wrapper)
  var previewArea = document.getElementById("agreementPreviewArea");
  if (previewArea) {
    previewArea.innerHTML = '<iframe srcdoc="'+html.replace(/"/g,'&quot;')+'" style="width:100%;height:1000px;border:none;border-radius:4px"></iframe>';
  }
  window._agreeLastHTML = html;
  return html;
}

function agreeSectionHeader(text) {
  return '<div style="background:#1E4BA0;color:#fff;padding:8px 14px;border-radius:6px;font-size:10pt;font-weight:700;margin:20px 0 12px;letter-spacing:.02em">'+text+'</div>';
}

function agreeSaveToAirtable() {
  var d = agreeCollectData();
  var c = d.client || {};
  if (!c.name) return;

  function fmtAT(s) {
    if (!s) return null;
    try { var dd = new Date(s); if (!isNaN(dd)) return dd.toISOString().split("T")[0]; } catch(e){}
    return s || null;
  }

  var lineItems = window._agreeLineItems || [];
  var weeks = 0;
  var weeksEndAT = d.planEndDate || d.endDate || "";
  if (d.startDate && weeksEndAT) {
    try { weeks = Math.round((new Date(weeksEndAT) - new Date(d.startDate)) / (7*24*60*60*1000)); } catch(e){}
  }
  var weeklyTotal = 0;
  lineItems.forEach(function(item) {
    var rate = parseFloat(item.rate)||0;
    var hrs = parseFloat(item.hours)||0;
    var qty = parseFloat(item.qty)||1;
    weeklyTotal += rate * hrs * qty;
  });
  var onceOff = 702.30; // establishment fee
  var totalValue = (weeklyTotal * weeks) + onceOff;

  var supportItemNames = lineItems.map(function(i){ return i.name; }).join(", ");
  var supportItemCodes = lineItems.map(function(i){ return i.code; }).join(", ");

  var nameParts = (c.name||"").trim().split(" ");
  var firstName = nameParts[0]||"";
  var lastName = nameParts.slice(1).join(" ")||"";

  var payload = {
    "Agreement Start Date": fmtAT(d.startDate),
    "NDIS Plan Start": fmtAT(c.planStart||""),
    "NDIS Plan End": fmtAT(c.planEnd||""),
    "Participant Last Name": lastName,
    "NDIS Number": c.ndisNumber||"",
    "Date of Birth": fmtAT(c.dob||c.dateOfBirth||""),
    "Participant Email": c.email||"",
    "Participant Phone": c.phone||"",
    "Street Address": c.address||"",
    "Suburb": c.suburb||"",
    "Participant State": c.state||"QLD",
    "Postcode": c.postcode||"",
    "Plan Type": d.planMgmt||c.planType||"",
    "Plan Manager Name": c.planManager||"",
    "Plan Manager Email": c.planManagerEmail||"",
    "Support Coordinator First Name": (c.supportCoordinator||"").split(" ")[0]||"",
    "Support Coordinator Last Name": (c.supportCoordinator||"").split(" ").slice(1).join(" ")||"",
    "Provider First Name": d.prvName ? d.prvName.split(" ")[0] : "Angela",
    "Provider Last Name": d.prvName ? d.prvName.split(" ").slice(1).join(" ") : "Te Hira",
    "Provider Email": d.prvEmail||"angelat@deltacommunity.com.au",
    "Duration Weeks": weeks||null,
    "Weekly Recurring Amount": weeklyTotal||null,
    "Total Agreement Value": totalValue||null,
    "Support Items": supportItemNames,
    "Terms Accepted?": true,
    "Terms version": "Website T&Cs v1.0",
    "Terms Date & Time accepted": new Date().toISOString(),
    "Organisation Name": "Delta Community Support"
  };

  return apiCall("POST", "/api/agreements", payload).then(function(r) {
    if (r && r.id) {
      window._agreeAirtableId = r.id;
      console.log("Agreement saved to Airtable:", r.id);
    }
    return r;
  }).catch(function(e) {
    console.warn("Could not save agreement to Airtable:", e);
  });
}

function agreeDownloadPDF() {
  var html = window._agreeLastHTML || agreeGenerate();
  if (!html) return;
  var c = _agreeClient;
  var clientName = (c&&c.name)||"Client";

  // Save to Airtable in background
  agreeSaveToAirtable();
  // Create draft shifts in background
  var d = agreeCollectData();
  agreeSaveDraftShifts(d);

  var printWin = window.open("","_blank","width=900,height=700");
  if (!printWin) { alert("Please allow popups to download PDF"); return; }
  printWin.document.write(html);
  printWin.document.close();
  printWin.onload = function() {
    setTimeout(function(){ printWin.print(); }, 600);
  };
}

window.agreeLoadClient = agreeLoadClient;
window.agreeUpdateHolidays = agreeUpdateHolidays;
window.agreeToggleChip = agreeToggleChip;
window.agreeGetSelectedServices = agreeGetSelectedServices;
window.agreeValidateForm = agreeValidateForm;
window.agreeSaveDraftShifts = agreeSaveDraftShifts;
window.agreeTab = agreeTab;
window.agreeGenerate = agreeGenerate;
window.agreeDownloadPDF = agreeDownloadPDF;
window.agreeAddLineItem = agreeAddLineItem;
window.agreeRenderLineItems = agreeRenderLineItems;
window.openAgreementCreator = openAgreementCreator;
window._buildAgreementCreator = _buildAgreementCreator;



// ‚ïê‚ïê‚ïê LEADS MODULE ‚ïê‚ïê‚ïê
var leadsSubView="list";
var leadsData=[];
var leadsLoaded=false;
var leadsStages=["Enquiry","Follow Up","Meet & Greet","Agreements","WON","LOST"];
var leadsColors={"Enquiry":"#3B82F6","Follow Up":"#8B5CF6","Meet & Greet":"#F59E0B","Agreements":"#0A9396","WON":"#10B981","LOST":"#EF4444"};

function renderContactsOverview(){var rp=document.getElementById("rightPanel");rp.innerHTML='<div style="padding:20px"><h2 style="font-size:18px;font-weight:700;margin-bottom:16px">Contacts Overview</h2><div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:40px;margin-bottom:12px">üë•</div><div style="font-size:14px;font-weight:600">Overview dashboard coming soon</div><div style="font-size:12px;margin-top:4px">Use All Contacts to manage your contact list</div></div></div>'}
function renderLeadsOverview(){var rp=document.getElementById("rightPanel");rp.innerHTML='<div style="padding:20px"><h2 style="font-size:18px;font-weight:700;margin-bottom:16px">Leads Overview</h2><div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:40px;margin-bottom:12px">üìä</div><div style="font-size:14px;font-weight:600">Leads overview dashboard coming soon</div><div style="font-size:12px;margin-top:4px">Use the Leads view to manage your pipeline</div></div></div>'}
function renderLeads(){
var rp=document.getElementById("rightPanel");
// Highlight submenu
document.querySelectorAll("#leadsSub .sb-sub-item").forEach(function(b){b.classList.remove("on")});
var active=document.querySelector('#leadsSub [data-subview="'+leadsSubView+'"]');if(active)active.classList.add("on");
if(!leadsLoaded){leadsLoaded=true;
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted)"><div style="text-align:center"><div class="spin" style="width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--teal);border-radius:50%;margin:0 auto 12px"></div><div style="font-size:13px;font-weight:600">Loading leads...</div></div></div>';
apiCall("GET","/api/leads").then(function(d){leadsData=d||[];
if(leadsSubView==="list")renderLeadsList(rp);else renderLeadsKanban(rp)}).catch(function(){leadsData=[];renderLeadsList(rp)});return}
if(leadsSubView==="list")renderLeadsList(rp);else renderLeadsKanban(rp)}

function renderLeadsList(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div><div style="font-size:18px;font-weight:700;color:var(--text)">Leads</div><div style="font-size:11px;color:var(--muted)">'+leadsData.length+' leads</div></div>';
h+='<div style="display:flex;gap:6px"><button class="btn btn-teal btn-sm" onclick="setLeadsView(\'kanban\')">üìå Kanban</button></div></div>';
// Search
h+='<input id="leadsSearch" oninput="filterLeadsList()" placeholder="Search leads by name, suburb, disability, SC..." style="width:100%;max-width:500px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface2);outline:none;margin-bottom:12px">';
// Table
h+='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px">';
h+='<thead><tr style="border-bottom:2px solid var(--border)">';
["#","Client Name","Suburb","Disability","SC Name","SC Email","SC Mobile","Stage","Date"].forEach(function(col){
h+='<th style="padding:8px 6px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">'+col+'</th>'});
h+='</tr></thead><tbody id="leadsTbody">';
leadsData.forEach(function(r,idx){
var col=leadsColors[r.stage||"Enquiry"]||"var(--muted)";
var dateStr=r.date||"";if(dateStr){try{var d=new Date(dateStr);if(!isNaN(d))dateStr=d.toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"})}catch(e){}}
h+='<tr data-lidx="'+idx+'" style="border-bottom:1px solid var(--border);transition:background .1s" onmouseover="this.style.background=\'var(--tealLight)\'" onmouseout="this.style.background=\'none\'">';
h+='<td style="padding:8px 6px;font-size:10px;color:var(--dim)">'+(r.refNum||"")+'</td>';
h+='<td style="padding:8px 6px;font-weight:700;color:var(--text)">'+(r.name||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--text)">'+(r.suburb||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--text)">'+(r.disabilityType||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px;color:var(--text)">'+(r.scName||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:10px;color:var(--muted);font-family:JetBrains Mono,monospace">'+(r.scEmail?'<a href="mailto:'+r.scEmail+'" style="color:var(--teal);text-decoration:none">'+r.scEmail+'</a>':"‚Äî")+'</td>';
h+='<td style="padding:8px 6px;font-size:11px">'+(r.scMobile||"‚Äî")+'</td>';
h+='<td style="padding:8px 6px"><select onchange="updateLeadStage('+idx+',this.value)" '+(canEdit("leads_list")?"":"disabled")+' style="padding:3px 6px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid '+col+'30;background:'+col+'10;color:'+col+';font-family:inherit;cursor:'+(canEdit("leads_list")?"pointer":"default")+'">';
leadsStages.forEach(function(st){h+='<option value="'+st+'"'+((r.stage||"Enquiry")===st?" selected":"")+'>'+st+'</option>'});
h+='</select></td>';
h+='<td style="padding:8px 6px;font-size:10px;white-space:nowrap;color:var(--muted)">'+dateStr+'</td>';
h+='</tr>'});
if(leadsData.length===0)h+='</tbody></table></div><div style="padding:30px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">‚úÖ</div><div style="font-size:13px;font-weight:600">No leads found</div><div style="font-size:11px;margin-top:4px">Leads will load from the Leads table in Airtable</div></div>';
else h+='</tbody></table></div>';
h+='</div>';rp.innerHTML=h}

function filterLeadsList(){
var q=(document.getElementById("leadsSearch")||{}).value||"";q=q.toLowerCase();
document.querySelectorAll("#leadsTbody tr").forEach(function(row){
var idx=parseInt(row.getAttribute("data-lidx"));var r=leadsData[idx];if(!r){row.style.display="none";return}
var match=!q||(r.name||"").toLowerCase().indexOf(q)>=0||(r.suburb||"").toLowerCase().indexOf(q)>=0||(r.disabilityType||"").toLowerCase().indexOf(q)>=0||(r.scName||"").toLowerCase().indexOf(q)>=0||(r.scEmail||"").toLowerCase().indexOf(q)>=0||(r.source||"").toLowerCase().indexOf(q)>=0;
row.style.display=match?"":"none"})}

function updateLeadStage(idx,newStage){
var r=leadsData[idx];if(!r)return;r.stage=newStage;
if(r.airtableId)apiCall("PATCH","/api/leads/"+r.airtableId,{stage:newStage}).catch(function(){})}

function renderLeadsKanban(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px"><div><div style="font-size:18px;font-weight:700;color:var(--text)">Leads Pipeline</div><div style="font-size:11px;color:var(--muted)">Drag and drop to update lead stages</div></div>';
h+='<div style="display:flex;gap:6px"><button class="btn btn-teal btn-sm" onclick="setLeadsView(\'list\')">üìã List</button></div></div>';
h+='<div class="kanban-wrap">';
leadsStages.forEach(function(stage){
var col=leadsColors[stage];
var cards=leadsData.filter(function(r){return(r.stage||"Enquiry")===stage});
h+='<div class="kanban-col" data-lead-stage="'+stage+'" ondragover="leadsDragOver(event)" ondragleave="leadsDragLeave(event)" ondrop="leadsDrop(event,\''+stage+'\')">';
h+='<div class="kanban-col-hdr" style="border-top:3px solid '+col+';color:'+col+'"><span>'+stage+'</span><span style="background:'+col+'15;color:'+col+';font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px">'+cards.length+'</span></div>';
h+='<div class="kanban-col-body">';
cards.forEach(function(r){
var globalIdx=leadsData.indexOf(r);
h+='<div class="kanban-card" draggable="'+(canEdit("leads_kanban")?"true":"false")+'" ondragstart="leadsDragStart(event,'+globalIdx+')" data-leadidx="'+globalIdx+'">';
h+='<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:3px">'+(r.name||"‚Äî")+'</div>';
if(r.refNum)h+='<div style="font-size:9px;color:var(--dim);margin-bottom:4px">'+r.refNum+'</div>';
if(r.suburb)h+='<div style="font-size:10px;color:var(--muted);margin-bottom:2px">üìç '+r.suburb+'</div>';
if(r.disabilityType)h+='<div style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:6px;background:rgba(139,92,246,.08);color:#8B5CF6;display:inline-block;margin-bottom:4px">'+r.disabilityType+'</div>';
if(r.scName){
h+='<div style="margin-top:4px;padding-top:4px;border-top:1px solid var(--border)">';
h+='<div style="font-size:9px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.3px;margin-bottom:2px">Support Coordinator</div>';
h+='<div style="font-size:10px;font-weight:600;color:var(--text)">'+r.scName+'</div>';
if(r.scMobile)h+='<div style="font-size:9px;color:var(--muted)">üìû '+r.scMobile+'</div>';
if(r.scEmail)h+='<div style="font-size:9px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">‚úâ '+r.scEmail+'</div>';
h+='</div>'}
if(r.source)h+='<div style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:6px;background:rgba(59,130,246,.08);color:#3B82F6;display:inline-block;margin-top:3px">'+r.source+'</div>';
h+='</div>'});
h+='</div></div>'});
h+='</div></div>';rp.innerHTML=h}

function leadsDragStart(e,idx){if(!canEdit("leads_kanban")){e.preventDefault();return}e.dataTransfer.setData("text/plain",idx);e.target.classList.add("dragging")}
function leadsDragOver(e){e.preventDefault();var body=e.currentTarget.querySelector(".kanban-col-body");if(body)body.classList.add("drag-over")}
function leadsDragLeave(e){var body=e.currentTarget.querySelector(".kanban-col-body");if(body)body.classList.remove("drag-over")}
function leadsDrop(e,newStage){
e.preventDefault();var body=e.currentTarget.querySelector(".kanban-col-body");if(body)body.classList.remove("drag-over");
var idx=parseInt(e.dataTransfer.getData("text/plain"));var r=leadsData[idx];if(!r)return;
r.stage=newStage;
if(r.airtableId)apiCall("PATCH","/api/leads/"+r.airtableId,{stage:newStage}).catch(function(){});
renderLeadsKanban(document.getElementById("rightPanel"))}

// ‚ïê‚ïê‚ïê PLACEHOLDER VIEWS ‚ïê‚ïê‚ïê
function renderPlaceholder(title,icon,desc){
var rp=document.getElementById("rightPanel");
rp.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%"><div style="text-align:center;max-width:400px"><div style="font-size:56px;margin-bottom:16px">'+icon+'</div><div style="font-size:22px;font-weight:700;color:var(--text);margin-bottom:8px">'+title+'</div><div style="font-size:13px;color:var(--muted);line-height:1.6">'+desc+'</div></div></div>'}

var adminTab="users";
var adminTemplates=[];
var adminUsers=[];
var adminEditingUser=null;
var adminDocTemplates=[];

function renderAdmin(){var rp=document.getElementById("rightPanel");
Promise.all([apiCall("GET","/api/admin/users"),apiCall("GET","/api/admin/templates"),apiCall("GET","/api/doc-templates?all=1")]).then(function(res){
adminUsers=res[0]||[];adminTemplates=res[1]||[];adminDocTemplates=res[2]||[];renderAdminContent(rp);
}).catch(function(){renderAdminContent(rp)})}

function renderAdminContent(rp){
var h='<div style="padding:24px;overflow-y:auto;height:100%">';
h+='<div style="font-size:20px;font-weight:700;color:var(--text);margin-bottom:4px">‚öôÔ∏è User Management & Permissions</div>';
h+='<div style="font-size:12px;color:var(--muted);margin-bottom:16px">Manage users, job titles, and granular access control</div>';
// Tabs
h+='<div style="display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:20px">';
["users","templates","docTemplates","timezone","emailSig"].forEach(function(t){
var label=t==="users"?"üë• Users ("+adminUsers.length+")":t==="templates"?"üìã Job Title Templates":t==="docTemplates"?"üìÑ Document Templates":t==="timezone"?"üïê Timezone":"üìß Email Signature";
var active=adminTab===t;
h+='<button onclick="adminTab=\''+t+'\';renderAdminContent(document.getElementById(\'rightPanel\'))" style="padding:10px 20px;font-size:12px;font-weight:'+(active?"700":"500")+';color:'+(active?"var(--teal)":"var(--muted)")+';border:none;border-bottom:2px solid '+(active?"var(--teal)":"transparent")+';background:none;cursor:pointer;font-family:inherit;margin-bottom:-2px">'+label+'</button>'});
h+='</div>';

if(adminTab==="users")h+=renderAdminUsers();
else if(adminTab==="templates")h+=renderAdminTemplates();
else if(adminTab==="docTemplates")h+=renderAdminDocTemplates();
else if(adminTab==="emailSig")h+=renderAdminEmailSig();
else h+=renderAdminTimezone();
h+='</div>';rp.innerHTML=h}

function renderAdminTimezone(){
var currentTZ=getAppTimezone();
var h='<div class="admin-form"><h3>üïê App Timezone (Australia)</h3><p style="font-size:12px;color:var(--muted);margin-bottom:12px">Set the timezone used across the app for all users.</p><div class="fg" style="margin-bottom:8px"><label>State / Territory</label><select id="tzSelect" onchange="saveTimezone(this.value)">';
var tzOpts=[{v:"QLD",l:"QLD ‚Äî Brisbane (AEST, no DST)"},{v:"NSW",l:"NSW ‚Äî Sydney (AEST/AEDT)"},{v:"VIC",l:"VIC ‚Äî Melbourne (AEST/AEDT)"},{v:"SA",l:"SA ‚Äî Adelaide (ACST/ACDT)"},{v:"NT",l:"NT ‚Äî Darwin (ACST, no DST)"},{v:"WA",l:"WA ‚Äî Perth (AWST, no DST)"},{v:"TAS",l:"TAS ‚Äî Hobart (AEST/AEDT)"},{v:"ACT",l:"ACT ‚Äî Canberra (AEST/AEDT)"}];
tzOpts.forEach(function(o){h+='<option value="'+o.v+'"'+(currentTZ===o.v?' selected':'')+'>'+o.l+'</option>'});
h+='</select></div></div>';return h}

function renderAdminEmailSig(){
var h='<div class="admin-form"><h3>üìß Email Signature</h3>';
h+='<p style="font-size:12px;color:var(--muted);margin-bottom:4px">This signature is automatically appended to all outgoing emails sent from <strong>rosters@deltacommunity.com.au</strong>.</p>';
h+='<p style="font-size:11px;color:var(--muted);margin-bottom:14px">Use the formatting tools to style your signature with bold, colours, links, etc.</p>';
h+='<div style="border:1px solid var(--border);border-radius:var(--rs);overflow:hidden;margin-bottom:12px">';
h+='<div style="display:flex;gap:2px;padding:6px 8px;background:var(--surface2);border-bottom:1px solid var(--border);flex-wrap:wrap">';
h+='<button type="button" onclick="sigExec(\'bold\')" title="Bold" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-weight:bold;font-size:13px;display:flex;align-items:center;justify-content:center">B</button>';
h+='<button type="button" onclick="sigExec(\'italic\')" title="Italic" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-style:italic;font-size:13px;display:flex;align-items:center;justify-content:center">I</button>';
h+='<button type="button" onclick="sigExec(\'underline\')" title="Underline" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;text-decoration:underline;font-size:13px;display:flex;align-items:center;justify-content:center">U</button>';
h+='<span style="width:1px;background:var(--border);margin:0 4px"></span>';
h+='<select onchange="sigExecVal(\'fontSize\',this.value);this.selectedIndex=0" style="height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);font-size:11px;padding:0 4px;cursor:pointer"><option value="">Size</option><option value="1">Small</option><option value="3">Normal</option><option value="5">Large</option></select>';
h+='<select onchange="sigExecVal(\'foreColor\',this.value);this.selectedIndex=0" style="height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);font-size:11px;padding:0 4px;cursor:pointer"><option value="">Color</option><option value="#000000">Black</option><option value="#0a9396">Teal (DCS)</option><option value="#e53e3e">Red</option><option value="#3182ce">Blue</option><option value="#38a169">Green</option><option value="#805ad5">Purple</option><option value="#6B7280">Grey</option></select>';
h+='<span style="width:1px;background:var(--border);margin:0 4px"></span>';
h+='<button type="button" onclick="sigInsertLink()" title="Insert link" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">üîó</button>';
h+='<button type="button" onclick="sigInsertImage()" title="Insert image URL" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">üñº</button>';
h+='<button type="button" onclick="sigExec(\'removeFormat\')" title="Clear formatting" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">‚úï</button>';
h+='</div>';
h+='<div id="sigEditor" contenteditable="true" style="min-height:150px;padding:12px;font-size:13px;font-family:inherit;line-height:1.6;outline:none;color:var(--text)"></div>';
h+='</div>';
h+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:16px"><button onclick="saveEmailSig()" id="sigSaveBtn" class="btn btn-p" style="padding:8px 24px">üíæ Save Signature</button><span id="sigStatus" style="font-size:11px"></span></div>';
h+='<div style="padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs)"><div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Preview</div><div id="sigPreview" style="font-size:13px;line-height:1.6;color:var(--text)"><em style="color:var(--muted)">Save a signature to see preview</em></div></div>';
h+='</div>';
setTimeout(function(){loadEmailSig()},100);
return h}
function sigExec(cmd){document.execCommand(cmd,false,null);document.getElementById("sigEditor").focus()}
function sigExecVal(cmd,val){if(!val)return;document.execCommand(cmd,false,val);document.getElementById("sigEditor").focus()}
function sigInsertLink(){var url=prompt("Enter URL:","https://");if(url)document.execCommand("createLink",false,url);document.getElementById("sigEditor").focus()}
function sigInsertImage(){var url=prompt("Enter image URL:","https://");if(url)document.execCommand("insertImage",false,url);document.getElementById("sigEditor").focus()}
function loadEmailSig(){apiCall("GET","/api/settings/email_signature").then(function(d){var editor=document.getElementById("sigEditor");var preview=document.getElementById("sigPreview");if(editor&&d.value){editor.innerHTML=d.value;if(preview)preview.innerHTML=d.value}})}
function saveEmailSig(){var editor=document.getElementById("sigEditor");if(!editor)return;var html=editor.innerHTML;var btn=document.getElementById("sigSaveBtn");var st=document.getElementById("sigStatus");if(btn){btn.disabled=true;btn.textContent="‚è≥ Saving..."}apiCall("POST","/api/settings/email_signature",{value:html}).then(function(d){if(st)st.innerHTML='<span style="color:var(--green);font-weight:700">‚úÖ Signature saved!</span>';if(btn){btn.disabled=false;btn.textContent="üíæ Save Signature"}var preview=document.getElementById("sigPreview");if(preview)preview.innerHTML=html}).catch(function(e){if(st)st.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';if(btn){btn.disabled=false;btn.textContent="üíæ Save Signature"}})}
function renderAdminUsers(){
var h='';
// Add User form
h+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px">‚ûï Add New User</div>';
h+='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:10px">';
h+='<div class="fg" style="margin:0"><label>Name</label><input id="newName" placeholder="Full name"></div>';
h+='<div class="fg" style="margin:0"><label>Email</label><input id="newEmail" placeholder="user@deltacommunity.com.au"></div>';
h+='<div class="fg" style="margin:0"><label>Password</label><input id="newPass" type="password" placeholder="Password"></div>';
h+='<div class="fg" style="margin:0"><label>Role</label><select id="newRole"><option value="operator">Operator</option><option value="admin">Admin</option><option value="superadmin">Super Admin</option></select></div>';
h+='<div class="fg" style="margin:0"><label>Job Title</label><input id="newJobTitle" placeholder="e.g. Support Coordinator"></div>';
h+='<div class="fg" style="margin:0"><label>Apply Template</label><select id="newTemplate"><option value="">‚Äî No template ‚Äî</option>';
adminTemplates.forEach(function(t){h+='<option value="'+t.id+'">'+t.name+'</option>'});
h+='</select></div>';
h+='</div><button class="btn btn-p" style="padding:8px 20px" onclick="addUserWithPerms()">Add User</button></div>';

// User List
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:12px">Current Users</div>';
adminUsers.forEach(function(u,idx){
var isSA=u.role==="superadmin";
var isEditing=adminEditingUser===u.id;
h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;overflow:hidden">';
// User header row
h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer" onclick="toggleUserPerms('+u.id+')">';
h+='<div style="display:flex;align-items:center;gap:10px">';
h+='<div style="width:36px;height:36px;border-radius:50%;background:var(--royal);color:#FFD166;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700">'+getInitials(u.name||u.email)+'</div>';
h+='<div><div style="font-size:13px;font-weight:700;color:var(--text)">'+(u.name||"Unnamed")+'</div>';
h+='<div style="font-size:10px;color:var(--muted);font-family:JetBrains Mono,monospace">'+u.email+'</div></div></div>';
h+='<div style="display:flex;align-items:center;gap:8px">';
if(u.job_title)h+='<span style="font-size:9px;font-weight:600;padding:3px 8px;border-radius:6px;background:rgba(59,130,246,.08);color:#3B82F6;border:1px solid rgba(59,130,246,.15)">'+u.job_title+'</span>';
var ucf=(u.permissions||{}).client_filter||"all";
if(ucf==="linked_sc")h+='<span style="font-size:9px;font-weight:600;padding:3px 8px;border-radius:6px;background:rgba(245,158,11,.08);color:#D97706;border:1px solid rgba(245,158,11,.15)">üîí SC Filter</span>';
h+='<span class="role-badge" style="font-size:9px;font-weight:700;padding:3px 8px;border-radius:6px;background:'+(isSA?"rgba(245,158,11,.1)":"rgba(16,185,129,.1)")+';color:'+(isSA?"#F59E0B":"#10B981")+'">'+u.role+'</span>';
h+='<span style="font-size:14px;transition:transform .2s;transform:rotate('+(isEditing?"180":"0")+'deg)">‚ñæ</span>';
if(!isSA&&!isImpersonating())h+='<button class="btn btn-sm" onclick="event.stopPropagation();impersonateUser('+u.id+')" style="font-size:10px;padding:4px 10px;background:#F59E0B;color:#fff;border:none;border-radius:var(--rs);cursor:pointer;font-family:inherit" title="View the app as this user">üëÅ View as</button>';
if(!isSA)h+='<button class="btn btn-d btn-sm" onclick="event.stopPropagation();deleteUser('+u.id+')" style="font-size:10px;padding:4px 10px">‚úï</button>';
h+='</div></div>';

// Expandable permissions panel
if(isEditing){
h+='<div style="border-top:1px solid var(--border);padding:16px;background:var(--surface2)">';
if(isSA){
h+='<div style="font-size:12px;color:var(--muted);padding:12px;text-align:center">üîí Super Admin has full access to everything</div>';
}else{
// Job title + template quick-apply
h+='<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:flex-end">';
h+='<div class="fg" style="margin:0;flex:1;min-width:160px"><label>Job Title</label><input id="ujt_'+u.id+'" value="'+(u.job_title||"")+'" placeholder="Job title" style="padding:6px 10px;font-size:12px" onchange="updateUserField('+u.id+',\'job_title\',this.value)"></div>';
h+='<div class="fg" style="margin:0;flex:1;min-width:140px"><label>üìû Mobile <span style="font-weight:400;color:var(--muted);font-size:10px">(call routing)</span></label><input id="phone_'+u.id+'" value="'+(u.phone_number||'')+'" placeholder="+61412345678" style="padding:6px 10px;font-size:12px;font-family:monospace" onchange="updateUserField('+u.id+',\'phone_number\',this.value)"></div>';
h+='<div class="fg" style="margin:0;flex:1;min-width:160px"><label>Apply Template</label><select onchange="applyTemplateToUser('+u.id+',this.value)" style="padding:6px 10px;font-size:12px"><option value="">‚Äî Select template ‚Äî</option>';
adminTemplates.forEach(function(t){h+='<option value="'+t.id+'">'+t.name+'</option>'});
h+='</select></div>';
h+='<div class="fg" style="margin:0"><label>Role</label><select onchange="updateUserField('+u.id+',\'role\',this.value)" style="padding:6px 10px;font-size:12px"><option value="operator"'+(u.role==="operator"?" selected":"")+'>Operator</option><option value="admin"'+(u.role==="admin"?" selected":"")+'>Admin</option></select></div>';
h+='</div>';
// Client filter toggle
var cf=(u.permissions||{}).client_filter||"all";
h+='<div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">';
h+='<div><div style="font-size:12px;font-weight:700;color:var(--text)">üë• Client Data Access</div>';
h+='<div style="font-size:10px;color:var(--muted)">Controls which clients this user can see in Contacts</div></div>';
h+='<select onchange="setClientFilter('+u.id+',this.value)" style="padding:6px 10px;font-size:12px;font-weight:600;border:2px solid '+(cf==="linked_sc"?"#F59E0B":"var(--green)")+';border-radius:var(--rs);background:'+(cf==="linked_sc"?"rgba(245,158,11,.06)":"rgba(16,185,129,.06)")+';color:'+(cf==="linked_sc"?"#F59E0B":"var(--green)")+';cursor:pointer;font-family:inherit">';
h+='<option value="all"'+(cf==="all"?" selected":"")+'>üîì All Clients</option>';
h+='<option value="linked_sc"'+(cf==="linked_sc"?" selected":"")+'>üîí Linked Clients Only (SC)</option>';
h+='</select></div>';
if(cf==="linked_sc")h+='<div style="margin-top:8px;font-size:10px;color:#F59E0B;background:rgba(245,158,11,.06);padding:6px 10px;border-radius:var(--rs)">‚ö†Ô∏è This user will only see clients where their login email matches the <strong>Support Coordinator Email</strong> field in the Clients table</div>';
h+='</div>';
// Permission grid
h+=renderPermGrid(u.permissions||{},u.id,"user");
}
h+='</div>'}
h+='</div>'});
return h}

function renderPermGrid(perms,entityId,entityType){
var groups={};
PERM_KEYS.forEach(function(pk){
if(!groups[pk.group])groups[pk.group]={label:pk.group,keys:[]};
groups[pk.group].keys.push(pk);
});
var h='<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">';
h+='<thead><tr><th style="padding:6px 8px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;border-bottom:2px solid var(--border);width:200px">Section</th>';
h+='<th style="padding:6px;text-align:center;font-size:9px;font-weight:700;color:var(--red);text-transform:uppercase;border-bottom:2px solid var(--border);width:70px">None</th>';
h+='<th style="padding:6px;text-align:center;font-size:9px;font-weight:700;color:#3B82F6;text-transform:uppercase;border-bottom:2px solid var(--border);width:70px">View</th>';
h+='<th style="padding:6px;text-align:center;font-size:9px;font-weight:700;color:var(--green);text-transform:uppercase;border-bottom:2px solid var(--border);width:70px">Edit</th>';
h+='</tr></thead><tbody>';
var prevGroup="";
Object.keys(groups).forEach(function(g){
var grp=groups[g];
h+='<tr><td colspan="4" style="padding:8px 8px 4px;font-size:10px;font-weight:700;color:var(--teal);text-transform:uppercase;letter-spacing:.5px;border-top:1px solid var(--border)">'+grp.label+'</td></tr>';
grp.keys.forEach(function(pk){
var val=perms[pk.key]||"edit";
var radioName=entityType+'_'+entityId+'_'+pk.key;
h+='<tr style="border-bottom:1px solid var(--border)">';
h+='<td style="padding:6px 8px;color:var(--text)">'+pk.icon+' '+pk.label+'</td>';
["none","view","edit"].forEach(function(lvl){
var checked=val===lvl;
var col=lvl==="none"?"var(--red)":lvl==="view"?"#3B82F6":"var(--green)";
h+='<td style="padding:6px;text-align:center"><label style="cursor:pointer"><input type="radio" name="'+radioName+'" value="'+lvl+'"'+(checked?" checked":"")+'  onchange="setPermValue(\''+entityType+'\','+entityId+',\''+pk.key+'\',\''+lvl+'\')" style="accent-color:'+col+'"></label></td>';
});
h+='</tr>'});
});
h+='</tbody></table></div>';
// Save status + bulk actions bar
h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="display:flex;gap:6px">';
h+='<button class="btn btn-sm" style="font-size:10px;padding:5px 12px;background:var(--green);color:#fff;border:none;border-radius:var(--rs);cursor:pointer;font-family:inherit" onclick="bulkSetPerms(\''+entityType+'\','+entityId+',\'edit\')">‚úÖ Set All Edit</button>';
h+='<button class="btn btn-sm" style="font-size:10px;padding:5px 12px;background:#3B82F6;color:#fff;border:none;border-radius:var(--rs);cursor:pointer;font-family:inherit" onclick="bulkSetPerms(\''+entityType+'\','+entityId+',\'view\')">üëÅ Set All View</button>';
h+='<button class="btn btn-sm" style="font-size:10px;padding:5px 12px;background:var(--red);color:#fff;border:none;border-radius:var(--rs);cursor:pointer;font-family:inherit" onclick="bulkSetPerms(\''+entityType+'\','+entityId+',\'none\')">üö´ Set All None</button>';
h+='</div>';
h+='<div id="permSave_'+entityType+'_'+entityId+'" style="font-size:11px;font-weight:600;opacity:.4;transition:opacity .3s"><span style="color:var(--muted)">Changes auto-save</span></div>';
h+='</div>';
return h}

function toggleUserPerms(uid){adminEditingUser=adminEditingUser===uid?null:uid;renderAdminContent(document.getElementById("rightPanel"))}

function setPermValue(entityType,entityId,key,val){
if(entityType==="user"){
var u=adminUsers.find(function(u){return u.id===entityId});
if(!u)return;
u.permissions[key]=val;
showPermSaveIndicator(entityType+"_"+entityId);
apiCall("PATCH","/api/admin/users/"+entityId,{permissions:u.permissions}).then(function(){
showPermSaved(entityType+"_"+entityId);
}).catch(function(){showPermSaveError(entityType+"_"+entityId)});
// Update currentUser if editing self
if(currentUser&&currentUser.id===entityId){currentUser.permissions[key]=val;localStorage.setItem("titus_user",JSON.stringify(currentUser));applySidebarPermissions()}
}else if(entityType==="tpl"){
var t=adminTemplates.find(function(t){return t.id===entityId});
if(!t)return;
t.permissions[key]=val;
showPermSaveIndicator(entityType+"_"+entityId);
apiCall("PATCH","/api/admin/templates/"+entityId,{permissions:t.permissions}).then(function(){
showPermSaved(entityType+"_"+entityId);
}).catch(function(){showPermSaveError(entityType+"_"+entityId)});
}}

function showPermSaveIndicator(id){
var el=document.getElementById("permSave_"+id);
if(el){el.innerHTML='<span style="color:var(--teal)">‚è≥ Saving...</span>';el.style.opacity="1"}
}
function showPermSaved(id){
var el=document.getElementById("permSave_"+id);
if(el){el.innerHTML='<span style="color:var(--green)">‚úÖ Saved</span>';el.style.opacity="1";
setTimeout(function(){if(el)el.style.opacity=".4"},2000)}
}
function showPermSaveError(id){
var el=document.getElementById("permSave_"+id);
if(el){el.innerHTML='<span style="color:var(--red)">‚ùå Save failed</span>';el.style.opacity="1"}
}

function bulkSetPerms(entityType,entityId,val){
var perms=null;
if(entityType==="user"){
var u=adminUsers.find(function(u){return u.id===entityId});if(!u)return;
PERM_KEYS.forEach(function(pk){u.permissions[pk.key]=val});
perms=u.permissions;
showPermSaveIndicator(entityType+"_"+entityId);
apiCall("PATCH","/api/admin/users/"+entityId,{permissions:perms}).then(function(){
showPermSaved(entityType+"_"+entityId);
if(currentUser&&currentUser.id===entityId){currentUser.permissions=JSON.parse(JSON.stringify(perms));localStorage.setItem("titus_user",JSON.stringify(currentUser));applySidebarPermissions()}
}).catch(function(){showPermSaveError(entityType+"_"+entityId)});
}else if(entityType==="tpl"){
var t=adminTemplates.find(function(t){return t.id===entityId});if(!t)return;
PERM_KEYS.forEach(function(pk){t.permissions[pk.key]=val});
perms=t.permissions;
showPermSaveIndicator(entityType+"_"+entityId);
apiCall("PATCH","/api/admin/templates/"+entityId,{permissions:perms}).then(function(){
showPermSaved(entityType+"_"+entityId);
}).catch(function(){showPermSaveError(entityType+"_"+entityId)});
}
renderAdminContent(document.getElementById("rightPanel"))}

function updateUserField(uid,field,val){
var body={};body[field]=val;
apiCall("PATCH","/api/admin/users/"+uid,body).then(function(){
var u=adminUsers.find(function(u){return u.id===uid});if(u)u[field]=val;
}).catch(function(){})}

function applyTemplateToUser(uid,tplId){
if(!tplId)return;
var tpl=adminTemplates.find(function(t){return t.id===parseInt(tplId)});
if(!tpl)return;
var u=adminUsers.find(function(u){return u.id===uid});
if(!u)return;
// Copy template permissions to user (including client_filter)
var newPerms=JSON.parse(JSON.stringify(tpl.permissions));
u.permissions=newPerms;
apiCall("PATCH","/api/admin/users/"+uid,{permissions:newPerms,job_title:tpl.name}).then(function(){
u.job_title=tpl.name;
if(currentUser&&currentUser.id===uid){currentUser.permissions=newPerms;currentUser.job_title=tpl.name;localStorage.setItem("titus_user",JSON.stringify(currentUser));applySidebarPermissions()}
renderAdminContent(document.getElementById("rightPanel"));
}).catch(function(){})}

function setClientFilter(uid,val){
var u=adminUsers.find(function(u){return u.id===uid});
if(!u)return;
u.permissions.client_filter=val;
showPermSaveIndicator("user_"+uid);
apiCall("PATCH","/api/admin/users/"+uid,{permissions:u.permissions}).then(function(){
showPermSaved("user_"+uid);
if(currentUser&&currentUser.id===uid){currentUser.permissions.client_filter=val;localStorage.setItem("titus_user",JSON.stringify(currentUser))}
renderAdminContent(document.getElementById("rightPanel"));
}).catch(function(){showPermSaveError("user_"+uid)})}

function addUserWithPerms(){
var name=document.getElementById("newName").value;
var email=document.getElementById("newEmail").value;
var password=document.getElementById("newPass").value;
var role=document.getElementById("newRole").value;
var jobTitle=document.getElementById("newJobTitle").value;
var tplId=document.getElementById("newTemplate").value;
if(!email||!password){alert("Email and password required");return}
var perms=null;
if(tplId){var tpl=adminTemplates.find(function(t){return t.id===parseInt(tplId)});if(tpl)perms=tpl.permissions}
apiCall("POST","/api/admin/users",{name:name,email:email,password:password,role:role,job_title:jobTitle||"",phone_number:(document.getElementById("newPhoneNumber")||{}).value||"",permissions:perms}).then(function(){renderAdmin()}).catch(function(e){alert("Error: "+(e.message||"Failed"))})}

// ‚îÄ‚îÄ Templates Tab ‚îÄ‚îÄ
function renderAdminTemplates(){
var h='';
// Add template form
h+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:20px">';
h+='<div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:12px">‚ûï Create Job Title Template</div>';
h+='<div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">';
h+='<div class="fg" style="margin:0;flex:1;min-width:280px"><label style="font-size:12px;font-weight:700">Template Name (Job Title)</label><input id="newTplName" placeholder="e.g. Support Coordinator, Rostering Officer, Team Leader" style="padding:12px 14px;font-size:14px;border:2px solid var(--border);border-radius:var(--rs);width:100%;box-sizing:border-box;font-family:inherit;background:var(--surface);outline:none" onfocus="this.style.borderColor=\'var(--teal)\'" onblur="this.style.borderColor=\'var(--border)\'"></div>';
h+='<button class="btn btn-p" style="padding:12px 32px;font-size:13px;font-weight:700;white-space:nowrap" onclick="createTemplate()">+ Create Template</button></div></div>';

if(adminTemplates.length===0){
h+='<div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:40px;margin-bottom:10px">üìã</div><div style="font-size:14px;font-weight:600">No templates yet</div><div style="font-size:12px;margin-top:4px">Create a template above to get started. Templates let you quickly assign permissions by job title.</div></div>';
}else{
adminTemplates.forEach(function(t){
h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;overflow:hidden">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer" onclick="toggleTplPerms('+t.id+')">';
h+='<div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">üìã</span><span style="font-size:14px;font-weight:700;color:var(--text)">'+t.name+'</span></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
// Count permissions summary
var editCount=0,viewCount=0,noneCount=0;
PERM_KEYS.forEach(function(pk){var v=t.permissions[pk.key]||"edit";if(v==="edit")editCount++;else if(v==="view")viewCount++;else noneCount++});
h+='<span style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px;background:rgba(16,185,129,.1);color:#10B981">'+editCount+' edit</span>';
h+='<span style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px;background:rgba(59,130,246,.1);color:#3B82F6">'+viewCount+' view</span>';
if(noneCount>0)h+='<span style="font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px;background:rgba(239,68,68,.1);color:#EF4444">'+noneCount+' none</span>';
h+='<span style="font-size:14px;transform:rotate('+(adminEditingUser===("tpl_"+t.id)?"180":"0")+'deg)">‚ñæ</span>';
h+='<button class="btn btn-d btn-sm" onclick="event.stopPropagation();deleteTemplate('+t.id+')" style="font-size:10px;padding:4px 10px">‚úï</button>';
h+='</div></div>';
if(adminEditingUser===("tpl_"+t.id)){
h+='<div style="border-top:1px solid var(--border);padding:16px;background:var(--surface2)">';
// Client filter for template
var tcf=(t.permissions||{}).client_filter||"all";
h+='<div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">';
h+='<div><div style="font-size:12px;font-weight:700;color:var(--text)">üë• Client Data Access</div>';
h+='<div style="font-size:10px;color:var(--muted)">Controls which clients users with this template can see</div></div>';
h+='<select onchange="setTplClientFilter('+t.id+',this.value)" style="padding:6px 10px;font-size:12px;font-weight:600;border:2px solid '+(tcf==="linked_sc"?"#F59E0B":"var(--green)")+';border-radius:var(--rs);background:'+(tcf==="linked_sc"?"rgba(245,158,11,.06)":"rgba(16,185,129,.06)")+';color:'+(tcf==="linked_sc"?"#F59E0B":"var(--green)")+';cursor:pointer;font-family:inherit">';
h+='<option value="all"'+(tcf==="all"?" selected":"")+'>üîì All Clients</option>';
h+='<option value="linked_sc"'+(tcf==="linked_sc"?" selected":"")+'>üîí Linked Clients Only (SC)</option>';
h+='</select></div></div>';
h+=renderPermGrid(t.permissions||{},t.id,"tpl");
h+='</div>'}
h+='</div>'});
}
return h}

function toggleTplPerms(tid){var k="tpl_"+tid;adminEditingUser=adminEditingUser===k?null:k;renderAdminContent(document.getElementById("rightPanel"))}

function createTemplate(){
var name=(document.getElementById("newTplName")||{}).value||"";
if(!name){alert("Template name required");return}
var defaultPerms={};
PERM_KEYS.forEach(function(pk){defaultPerms[pk.key]="none"});
defaultPerms.client_filter="all";
apiCall("POST","/api/admin/templates",{name:name,permissions:defaultPerms}).then(function(){renderAdmin()}).catch(function(e){alert("Error: "+(e.message||"Failed"))})}

function deleteTemplate(id){if(!confirm("Delete this template?"))return;apiCall("DELETE","/api/admin/templates/"+id).then(function(){renderAdmin()}).catch(function(){})}

function setTplClientFilter(tid,val){
var t=adminTemplates.find(function(t){return t.id===tid});
if(!t)return;
t.permissions.client_filter=val;
apiCall("PATCH","/api/admin/templates/"+tid,{permissions:t.permissions}).then(function(){
renderAdminContent(document.getElementById("rightPanel"));
}).catch(function(){})}

// ‚îÄ‚îÄ Impersonation ‚îÄ‚îÄ

// ‚ïê‚ïê‚ïê ADMIN DOCUMENT TEMPLATES ‚ïê‚ïê‚ïê
var _pendingTemplateFile = null; // holds uploaded file info {url, filename, size, storedName}
var _pendingSigningFields = []; // signing field config

function renderAdminDocTemplates(){
var h='';

// ‚îÄ‚îÄ Create New Template Form ‚îÄ‚îÄ
h+='<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:20px;margin-bottom:20px">';
h+='<div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:14px">‚ûï Add Document Template</div>';

h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">';
h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Template Name *</label>';
h+='<input id="newDocTplName" placeholder="e.g. Casual Employment Agreement" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box" onfocus="this.style.borderColor=\'var(--teal)\'" onblur="this.style.borderColor=\'var(--border)\'"></div>';

h+='<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Document Type *</label>';
h+='<select id="newDocTplType" style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box">';
h+='<option value="">‚Äî Select type ‚Äî</option>';
h+='<optgroup label="Employee Documents">';
h+='<option value="Employment Contract (PT/FT)">Employment Contract (PT/FT)</option>';
h+='<option value="Casual Employment Agreement">Casual Employment Agreement</option>';
h+='<option value="Independent Contractor Agreement">Independent Contractor Agreement</option>';
h+='<option value="Policy / Code of Conduct Acknowledgement">Policy / Code of Conduct</option>';
h+='</optgroup>';
h+='<optgroup label="Client Documents">';
h+='<option value="Service Agreement">Service Agreement</option>';
h+='<option value="Schedule of Support">Schedule of Support</option>';
h+='<option value="Consent Form">Consent Form</option>';
h+='<option value="Client Policy Acknowledgement">Client Policy Acknowledgement</option>';
h+='</optgroup>';
h+='</select></div>';
h+='</div>';

h+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Description</label>';
h+='<input id="newDocTplDesc" placeholder="Brief description of this template..." style="width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box"></div>';

// ‚îÄ‚îÄ File Upload Section ‚îÄ‚îÄ
h+='<div style="margin-bottom:14px">';
h+='<label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px">Template Document *</label>';
h+='<div id="newDocTplUploadZone" style="padding:24px;background:var(--surface);border:2px dashed var(--border2);border-radius:var(--r);text-align:center;cursor:pointer;transition:all .2s" onclick="document.getElementById(\'newDocTplFileInput\').click()" ondragover="event.preventDefault();this.style.borderColor=\'var(--teal)\';this.style.background=\'rgba(10,147,150,.03)\'" ondragleave="this.style.borderColor=\'var(--border2)\';this.style.background=\'var(--surface)\'" ondrop="handleDocTplDrop(event)">';

if(_pendingTemplateFile){
h+='<div style="display:flex;align-items:center;gap:10px;justify-content:center">';
h+='<span style="font-size:24px">üìÑ</span>';
h+='<div style="text-align:left"><div style="font-size:13px;font-weight:700;color:var(--teal)">'+(_pendingTemplateFile.filename||"File")+'</div>';
h+='<div style="font-size:10px;color:var(--muted)">'+(_pendingTemplateFile.size>1048576?(_pendingTemplateFile.size/1048576).toFixed(1)+" MB":(_pendingTemplateFile.size/1024).toFixed(0)+" KB")+'</div></div>';
h+='<button onclick="event.stopPropagation();_pendingTemplateFile=null;renderAdminContent(document.getElementById(\'rightPanel\'))" style="padding:4px 10px;background:rgba(239,68,68,.08);color:#EF4444;border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">‚úï Remove</button>';
h+='</div>';
}else{
h+='<div style="font-size:28px;margin-bottom:6px">üì§</div>';
h+='<div style="font-size:12px;font-weight:600;color:var(--text)">Drop your DOCX or PDF file here, or click to browse</div>';
h+='<div style="font-size:10px;color:var(--muted);margin-top:4px">Supports PDF, DOCX, DOC ‚Äî Max 25MB</div>';
}
h+='</div>';
h+='<input type="file" id="newDocTplFileInput" accept=".pdf,.docx,.doc,.xlsx,.xls" style="display:none" onchange="handleDocTplFileSelect(this)">';
h+='<div id="newDocTplUploadStatus" style="font-size:11px;margin-top:4px"></div>';
h+='</div>';

// ‚îÄ‚îÄ Signing Fields Configuration ‚îÄ‚îÄ
h+='<div style="margin-bottom:14px;padding:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:6px"><span>‚úçÔ∏è</span> Signing Fields</div>';
h+='<div style="font-size:10px;color:var(--muted);margin-bottom:10px">Choose which fields the recipient must fill in when signing this document</div>';

h+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">';
var availableSigningFields = [
  {id:"signature",label:"‚úçÔ∏è Signature",desc:"Draw signature on canvas"},
  {id:"full_name",label:"üë§ Full Name",desc:"Typed full legal name"},
  {id:"date",label:"üìÖ Date",desc:"Date of signing"},
  {id:"initials",label:"üî§ Initials",desc:"Typed initials"},
  {id:"email",label:"üìß Email",desc:"Email address"},
  {id:"phone",label:"üì± Phone",desc:"Phone number"},
  {id:"address",label:"üè† Address",desc:"Home address"},
  {id:"abn",label:"üè¢ ABN",desc:"Australian Business Number"},
  {id:"tfn",label:"üî¢ TFN",desc:"Tax File Number"},
  {id:"bank_bsb",label:"üè¶ Bank BSB",desc:"Bank BSB number"},
  {id:"bank_account",label:"üè¶ Bank Account",desc:"Bank account number"},
  {id:"emergency_contact",label:"üÜò Emergency Contact",desc:"Emergency contact details"},
  {id:"witness_name",label:"üëÅÔ∏è Witness Name",desc:"Witness full name"},
  {id:"witness_signature",label:"üëÅÔ∏è‚úçÔ∏è Witness Signature",desc:"Witness draw signature"}
];
availableSigningFields.forEach(function(sf){
var isSelected=_pendingSigningFields.indexOf(sf.id)>=0;
h+='<button onclick="toggleNewDocSigningField(\''+sf.id+'\')" style="padding:6px 12px;border-radius:20px;font-size:10px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .15s;border:1px solid '+(isSelected?"var(--teal)":"var(--border)")+';background:'+(isSelected?"rgba(10,147,150,.1)":"var(--surface)")+';color:'+(isSelected?"var(--teal)":"var(--muted)")+'" title="'+sf.desc+'">'+sf.label+'</button>';
});
h+='</div>';

if(_pendingSigningFields.length>0){
h+='<div style="font-size:10px;color:var(--teal);font-weight:600">'+_pendingSigningFields.length+' field'+ (_pendingSigningFields.length!==1?'s':'')+' selected ‚Äî recipient will see these when signing</div>';
}else{
h+='<div style="font-size:10px;color:var(--muted)">Signature field is always included by default</div>';
}
h+='</div>';

// Reminder settings
h+='<div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:6px"><span>‚è∞</span> Auto-Reminder Settings</div>';
h+='<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">';
h+='<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--text)"><input type="checkbox" id="newDocTplReminder" style="accent-color:var(--teal)" checked> Enable auto-reminders for unsigned documents</label>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<label style="font-size:10px;font-weight:700;color:var(--muted)">Remind every</label>';
h+='<select id="newDocTplReminderDays" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)">';
h+='<option value="1">1 day</option><option value="2">2 days</option><option value="3" selected>3 days</option><option value="5">5 days</option><option value="7">7 days</option><option value="14">14 days</option>';
h+='</select></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<label style="font-size:10px;font-weight:700;color:var(--muted)">Max</label>';
h+='<select id="newDocTplMaxReminders" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-family:inherit;background:var(--surface);color:var(--text)">';
h+='<option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="5">5</option>';
h+='</select><label style="font-size:10px;font-weight:700;color:var(--muted)">reminders</label></div>';
h+='</div></div>';

h+='<div style="display:flex;gap:8px;align-items:center">';
h+='<button onclick="createDocTemplate()" class="btn btn-p" style="padding:12px 28px;font-size:13px;font-weight:700">+ Create Template</button>';
h+='<span id="docTplCreateStatus" style="font-size:11px"></span>';
h+='</div></div>';

// ‚îÄ‚îÄ Template List ‚îÄ‚îÄ
var empDocs=adminDocTemplates.filter(function(t){return["Employment Contract (PT/FT)","Casual Employment Agreement","Independent Contractor Agreement","Policy / Code of Conduct Acknowledgement"].indexOf(t.type)>=0});
var clientDocs=adminDocTemplates.filter(function(t){return["Service Agreement","Schedule of Support","Consent Form","Client Policy Acknowledgement"].indexOf(t.type)>=0});
var otherDocs=adminDocTemplates.filter(function(t){return empDocs.indexOf(t)<0&&clientDocs.indexOf(t)<0});

// Employee section
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üë∑</span> Employee & Contractor Templates <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;background:rgba(59,130,246,.08);color:#3B82F6">'+empDocs.length+'</span></div>';
if(empDocs.length===0){
h+='<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px;background:var(--surface2);border:1px dashed var(--border);border-radius:var(--r)">No employee templates yet. Create one above to get started.</div>';
}else{
empDocs.forEach(function(t){h+=renderDocTemplateCard(t)});
}
h+='</div>';

// Client section
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="font-size:18px">üßë‚Äçü¶Ω</span> Client Document Templates <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;background:rgba(16,185,129,.08);color:#059669">'+clientDocs.length+'</span></div>';
if(clientDocs.length===0){
h+='<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px;background:var(--surface2);border:1px dashed var(--border);border-radius:var(--r)">No client templates yet. Add Service Agreements or Schedules of Support above.</div>';
}else{
clientDocs.forEach(function(t){h+=renderDocTemplateCard(t)});
}
h+='</div>';

// Other
if(otherDocs.length>0){
h+='<div style="margin-bottom:20px">';
h+='<div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px">üìÑ Other Templates <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;background:var(--surface2);color:var(--muted)">'+otherDocs.length+'</span></div>';
otherDocs.forEach(function(t){h+=renderDocTemplateCard(t)});
h+='</div>';
}

return h;
}

function renderDocTemplateCard(t){
var h='';
var statusLower=(t.status||"").toLowerCase();
var statusCol=statusLower==="active"?"#059669":statusLower==="draft"?"#F59E0B":"var(--muted)";
var typeCol=getDocTypeColor(t.type);
var isExpanded=adminEditingUser===("doc_"+t.id);
var hasFile=t.files&&t.files.length>0;

h+='<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px;overflow:hidden">';

// Header row
h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer" onclick="toggleDocTplExpand(\''+t.id+'\')">';
h+='<div style="display:flex;align-items:center;gap:10px">';
h+='<span style="font-size:20px">'+(hasFile?"üìÑ":"üìù")+'</span>';
h+='<div><div style="font-size:13px;font-weight:700;color:var(--text)">'+t.name+'</div>';
h+='<div style="display:flex;gap:4px;margin-top:3px">';
h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+typeCol+'10;color:'+typeCol+';border:1px solid '+typeCol+'20">'+t.type+'</span>';
h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+statusCol+'10;color:'+statusCol+';border:1px solid '+statusCol+'20">'+t.status+'</span>';
if(!hasFile)h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(239,68,68,.08);color:#EF4444;border:1px solid rgba(239,68,68,.15)">‚ö†Ô∏è No file uploaded</span>';
h+='</div></div></div>';

h+='<div style="display:flex;align-items:center;gap:6px">';
if(hasFile)h+='<a href="'+t.files[0].url+'" target="_blank" onclick="event.stopPropagation()" style="font-size:10px;font-weight:600;color:var(--teal);text-decoration:none;padding:4px 10px;background:rgba(10,147,150,.06);border-radius:4px">üìé View</a>';
h+='<span style="font-size:14px;transform:rotate('+(isExpanded?"180":"0")+'deg);transition:transform .2s">‚ñæ</span>';
h+='</div></div>';

// Expanded details
if(isExpanded){
h+='<div style="border-top:1px solid var(--border);padding:16px;background:var(--surface2)">';

// Description
if(t.description){
h+='<div style="font-size:11px;color:var(--muted);margin-bottom:12px;padding:8px 10px;background:var(--surface);border-radius:var(--rs)">'+t.description+'</div>';
}

// File info
h+='<div style="margin-bottom:14px">';
h+='<div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Template File</div>';
if(hasFile){
h+='<div style="display:flex;align-items:center;gap:8px;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<span style="font-size:18px">üìé</span>';
h+='<div style="flex:1"><div style="font-size:12px;font-weight:700;color:var(--teal)">'+t.files[0].name+'</div>';
if(t.files[0].size)h+='<div style="font-size:9px;color:var(--muted)">'+(t.files[0].size>1048576?(t.files[0].size/1048576).toFixed(1)+" MB":(t.files[0].size/1024).toFixed(0)+" KB")+'</div>';
h+='</div>';
h+='<a href="'+t.files[0].url+'" target="_blank" style="padding:6px 12px;background:rgba(10,147,150,.08);color:var(--teal);border-radius:var(--rs);font-size:10px;font-weight:700;text-decoration:none">Download</a>';
h+='</div>';
}else{
h+='<div id="docTplUploadZone_'+t.id+'" style="padding:16px;text-align:center;background:rgba(245,158,11,.04);border:2px dashed rgba(245,158,11,.2);border-radius:var(--r);font-size:11px;color:#D97706;cursor:pointer" onclick="document.getElementById(\'docTplFileInput_'+t.id+'\').click()" ondragover="event.preventDefault();this.style.borderColor=\'var(--teal)\'" ondragleave="this.style.borderColor=\'rgba(245,158,11,.2)\'" ondrop="handleExistingDocTplDrop(event,\''+t.id+'\')">';
h+='<div style="font-weight:700;margin-bottom:4px">üì§ Click or drop to upload template file</div>';
h+='<div style="color:var(--muted)">Supports PDF, DOCX ‚Äî Max 25MB</div>';
h+='</div>';
h+='<input type="file" id="docTplFileInput_'+t.id+'" accept=".pdf,.docx,.doc" style="display:none" onchange="handleExistingDocTplFileSelect(this,\''+t.id+'\')">';
h+='<div id="docTplUploadStatus_'+t.id+'" style="font-size:10px;margin-top:4px"></div>';
}
h+='</div>';

// Signing fields display
h+='<div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:6px"><span>‚úçÔ∏è</span> Signing Fields</div>';
var tplSigningFields=t.signingFields||[];
if(tplSigningFields.length>0){
h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';
var sfLabels={signature:"‚úçÔ∏è Signature",full_name:"üë§ Full Name",date:"üìÖ Date",initials:"üî§ Initials",email:"üìß Email",phone:"üì± Phone",address:"üè† Address",abn:"üè¢ ABN",tfn:"üî¢ TFN",bank_bsb:"üè¶ BSB",bank_account:"üè¶ Account",emergency_contact:"üÜò Emergency",witness_name:"üëÅÔ∏è Witness Name",witness_signature:"üëÅÔ∏è‚úçÔ∏è Witness Sig"};
tplSigningFields.forEach(function(sf){
h+='<span style="padding:4px 10px;border-radius:20px;font-size:9px;font-weight:600;background:rgba(10,147,150,.08);color:var(--teal);border:1px solid rgba(10,147,150,.15)">'+(sfLabels[sf]||sf)+'</span>';
});
h+='</div>';
}else{
h+='<div style="font-size:10px;color:var(--muted)">Default: Signature only. <a href="javascript:void(0)" onclick="event.stopPropagation();editDocTplSigningFields(\''+t.id+'\')" style="color:var(--teal);font-weight:600">Configure fields ‚Üí</a></div>';
}
h+='<div style="margin-top:6px"><button onclick="event.stopPropagation();editDocTplSigningFields(\''+t.id+'\')" style="padding:4px 12px;background:rgba(10,147,150,.06);color:var(--teal);border:1px solid rgba(10,147,150,.12);border-radius:var(--rs);font-size:10px;font-weight:600;font-family:inherit;cursor:pointer">‚úèÔ∏è Edit Signing Fields</button></div>';
h+='<div id="docTplSigningFieldsEditor_'+t.id+'" style="display:none;margin-top:10px"></div>';
h+='</div>';

// Who Signs display in card
h+='<div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:6px"><span>üë•</span> Signing Workflow</div>';

var signerConfig = t.signerConfig || {participantRequired:true,nomineeRequired:false,providerCountersign:true};
h+='<div style="display:flex;flex-direction:column;gap:6px">';

// Participant row
h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(30,75,160,.04);border:1px solid rgba(30,75,160,.12);border-radius:6px">';
h+='<span style="font-size:16px">1Ô∏è‚É£</span>';
h+='<div style="flex:1"><div style="font-size:11px;font-weight:700;color:var(--royal)">Participant / Client</div>';
h+='<div style="font-size:9px;color:var(--muted)">Signs with: Signature, Name, Date</div></div>';
h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(30,75,160,.08);color:var(--royal)">Required</span>';
h+='</div>';

// Nominee row
var nomReq = signerConfig.nomineeRequired;
h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:'+(nomReq?'rgba(124,58,237,.04)':'var(--surface2)')+';border:1px solid '+(nomReq?'rgba(124,58,237,.12)':'var(--border)')+';border-radius:6px">';
h+='<span style="font-size:16px">2Ô∏è‚É£</span>';
h+='<div style="flex:1"><div style="font-size:11px;font-weight:700;color:'+(nomReq?'#7C3AED':'var(--muted)')+'">Nominee / Guardian</div>';
h+='<div style="font-size:9px;color:var(--muted)">'+(nomReq?'Signs with: Signature, Name, Date, Relationship':'Not required for this template')+'</div></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+(nomReq?'rgba(124,58,237,.08)':'rgba(107,114,128,.08)')+';color:'+(nomReq?'#7C3AED':'var(--muted)')+'">'+( nomReq?'Required':'Optional')+'</span>';
h+='<button onclick="event.stopPropagation();toggleNomineeRequiredOnTemplate(+t.id+,'+(!nomReq)+')" style="padding:3px 10px;background:rgba(124,58,237,.06);color:#7C3AED;border:1px solid rgba(124,58,237,.12);border-radius:4px;font-size:9px;font-weight:700;font-family:inherit;cursor:pointer">'+(nomReq?'Remove':'Add Nominee')+'</button>';
h+='</div></div>';

// Provider row
var prvSign = signerConfig.providerCountersign !== false;
h+='<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:'+(prvSign?'rgba(16,185,129,.04)':'var(--surface2)')+';border:1px solid '+(prvSign?'rgba(16,185,129,.12)':'var(--border)')+';border-radius:6px">';
h+='<span style="font-size:16px">‚úÖ</span>';
h+='<div style="flex:1"><div style="font-size:11px;font-weight:700;color:'+(prvSign?'#059669':'var(--muted)')+'">DCS Provider Counter-Signature</div>';
h+='<div style="font-size:9px;color:var(--muted)">'+(prvSign?'DCS rep signs last after all parties':'Counter-signature not required')+'</div></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:'+(prvSign?'rgba(16,185,129,.08)':'rgba(107,114,128,.08)')+';color:'+(prvSign?'#059669':'var(--muted)')+'">'+( prvSign?'Included':'Excluded')+'</span>';
h+='<button onclick="event.stopPropagation();toggleProviderSignOnTemplate(+t.id+,'+(!prvSign)+')" style="padding:3px 10px;background:rgba(16,185,129,.06);color:#059669;border:1px solid rgba(16,185,129,.12);border-radius:4px;font-size:9px;font-weight:700;font-family:inherit;cursor:pointer">'+(prvSign?'Remove':'Add Counter-sign')+'</button>';
h+='</div></div>';

h+='</div></div>';

// Reminder settings display
h+='<div style="margin-bottom:14px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs)">';
h+='<div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:6px"><span>‚è∞</span> Auto-Reminder Settings</div>';
h+='<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">';
h+='<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;color:var(--text)"><input type="checkbox" id="docTplReminder_'+t.id+'" onchange="updateDocTplReminder(\''+t.id+'\')" style="accent-color:var(--teal)" '+(t.reminderEnabled!==false?"checked":"")+'> Reminders '+(t.reminderEnabled!==false?"enabled":"disabled")+'</label>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<label style="font-size:10px;font-weight:700;color:var(--muted)">Every</label>';
h+='<select id="docTplReminderDays_'+t.id+'" onchange="updateDocTplReminder(\''+t.id+'\')" style="padding:5px 8px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-family:inherit;background:var(--surface);color:var(--text)">';
[1,2,3,5,7,14].forEach(function(d){h+='<option value="'+d+'"'+(parseInt(t.reminderDays||3)===d?" selected":"")+'>'+d+' day'+(d!==1?"s":"")+'</option>'});
h+='</select></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<label style="font-size:10px;font-weight:700;color:var(--muted)">Max</label>';
h+='<select id="docTplMaxReminders_'+t.id+'" onchange="updateDocTplReminder(\''+t.id+'\')" style="padding:5px 8px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-family:inherit;background:var(--surface);color:var(--text)">';
[1,2,3,5].forEach(function(d){h+='<option value="'+d+'"'+(parseInt(t.maxReminders||3)===d?" selected":"")+'>'+d+'</option>'});
h+='</select><label style="font-size:10px;font-weight:700;color:var(--muted)">reminders</label></div>';
h+='<div style="display:flex;align-items:center;gap:6px">';
h+='<label style="font-size:10px;font-weight:700;color:var(--muted)">Via</label>';
h+='<select id="docTplReminderVia_'+t.id+'" onchange="updateDocTplReminder(\''+t.id+'\')" style="padding:5px 8px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-family:inherit;background:var(--surface);color:var(--text)">';
h+='<option value="SMS"'+(t.reminderVia==="SMS"?" selected":"")+'>üì± SMS</option>';
h+='<option value="Email"'+((t.reminderVia||"Email")==="Email"?" selected":"")+'>üìß Email</option>';
h+='<option value="Both"'+(t.reminderVia==="Both"?" selected":"")+'>üì±üìß Both</option>';
h+='</select></div>';
h+='</div></div>';

// Actions
h+='<div style="display:flex;gap:8px;justify-content:space-between;align-items:center">';
h+='<div style="display:flex;gap:6px">';
h+='<select id="docTplStatus_'+t.id+'" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:11px;font-family:inherit;background:var(--surface);color:var(--text)">';
["Active","Draft","Archived"].forEach(function(s){h+='<option value="'+s+'"'+((t.status||"Active")===s?" selected":"")+'>'+s+'</option>'});
h+='</select>';
h+='<button onclick="updateDocTplStatus(\''+t.id+'\')" style="padding:6px 14px;background:var(--royal);color:#fff;border:none;border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">Update Status</button>';
h+='</div>';
h+='<button onclick="deleteDocTemplate(\''+t.id+'\')" style="padding:6px 14px;background:rgba(239,68,68,.08);color:#EF4444;border:1px solid rgba(239,68,68,.15);border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">üóë Delete</button>';
h+='</div>';
h+='<span id="docTplActionStatus_'+t.id+'" style="font-size:10px;display:block;margin-top:6px"></span>';

h+='</div>';
}

h+='</div>';
return h;
}

function getDocTypeColor(type){
var t=(type||"").toLowerCase();
if(t.indexOf("employment contract")>=0)return"#3B82F6";
if(t.indexOf("casual")>=0)return"#8B5CF6";
if(t.indexOf("contractor")>=0)return"#8B5CF6";
if(t.indexOf("policy")>=0||t.indexOf("code of conduct")>=0)return"#F59E0B";
if(t.indexOf("service agreement")>=0)return"#059669";
if(t.indexOf("schedule of support")>=0)return"#0A9396";
if(t.indexOf("consent")>=0)return"#6366F1";
return"#64748B";
}

function toggleDocTplExpand(id){
var k="doc_"+id;
adminEditingUser=adminEditingUser===k?null:k;
renderAdminContent(document.getElementById("rightPanel"));
}

function toggleNewDocSigningField(fieldId){
var idx=_pendingSigningFields.indexOf(fieldId);
if(idx>=0)_pendingSigningFields.splice(idx,1);else _pendingSigningFields.push(fieldId);
renderAdminContent(document.getElementById("rightPanel"));
}

function handleDocTplFileSelect(input){
if(!input.files||!input.files[0])return;
uploadDocTplFile(input.files[0],"new");
}

function handleDocTplDrop(event){
event.preventDefault();
event.currentTarget.style.borderColor="var(--border2)";
event.currentTarget.style.background="var(--surface)";
if(!event.dataTransfer.files||!event.dataTransfer.files[0])return;
uploadDocTplFile(event.dataTransfer.files[0],"new");
}

function handleExistingDocTplFileSelect(input,templateId){
if(!input.files||!input.files[0])return;
uploadDocTplFile(input.files[0],"existing",templateId);
}

function handleExistingDocTplDrop(event,templateId){
event.preventDefault();
event.currentTarget.style.borderColor="rgba(245,158,11,.2)";
if(!event.dataTransfer.files||!event.dataTransfer.files[0])return;
uploadDocTplFile(event.dataTransfer.files[0],"existing",templateId);
}

function uploadDocTplFile(file,mode,templateId){
var statusId=mode==="new"?"newDocTplUploadStatus":"docTplUploadStatus_"+templateId;
var statusEl=document.getElementById(statusId);
var allowed=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"];
var ext=(file.name||"").split(".").pop().toLowerCase();
var allowedExt=["pdf","docx","doc","xlsx","xls"];
if(allowed.indexOf(file.type)<0&&allowedExt.indexOf(ext)<0){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå Only PDF, DOCX, DOC files are supported</span>';return;
}
if(file.size>25*1024*1024){
if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå File too large (max 25MB)</span>';return;
}
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Uploading '+file.name+'...</span>';

var formData=new FormData();
formData.append("file",file);
var headers={};
if(token)headers["Authorization"]="Bearer "+token;
fetch("/api/doc-templates/upload",{method:"POST",headers:headers,body:formData}).then(function(r){return r.json()}).then(function(data){
if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';return}

if(mode==="new"){
_pendingTemplateFile={url:data.url,filename:data.filename,size:data.size,storedName:data.storedName};
if(statusEl)statusEl.innerHTML='<span style="color:#059669">‚úÖ File ready</span>';
renderAdminContent(document.getElementById("rightPanel"));
}else{
// Attach file to existing template via PATCH
apiCall("PATCH","/api/doc-templates/"+templateId,{fileUrl:data.url,fileName:data.filename}).then(function(patchData){
if(patchData.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+patchData.error+'</span>';return}
if(statusEl)statusEl.innerHTML='<span style="color:#059669">‚úÖ File uploaded & attached!</span>';
// Refresh
setTimeout(function(){renderAdmin()},1000);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå Upload failed: '+e.message+'</span>'});
}

function editDocTplSigningFields(templateId){
var editorEl=document.getElementById("docTplSigningFieldsEditor_"+templateId);
if(!editorEl)return;
if(editorEl.style.display!=="none"){editorEl.style.display="none";return}
editorEl.style.display="block";

var t=adminDocTemplates.find(function(t){return t.id===templateId});
var currentFields=(t&&t.signingFields)||[];

var allFields=[
{id:"signature",label:"‚úçÔ∏è Signature"},{id:"full_name",label:"üë§ Full Name"},{id:"date",label:"üìÖ Date"},
{id:"initials",label:"üî§ Initials"},{id:"email",label:"üìß Email"},{id:"phone",label:"üì± Phone"},
{id:"address",label:"üè† Address"},{id:"abn",label:"üè¢ ABN"},{id:"tfn",label:"üî¢ TFN"},
{id:"bank_bsb",label:"üè¶ Bank BSB"},{id:"bank_account",label:"üè¶ Bank Account"},
{id:"emergency_contact",label:"üÜò Emergency Contact"},
{id:"witness_name",label:"üëÅÔ∏è Witness Name"},{id:"witness_signature",label:"üëÅÔ∏è‚úçÔ∏è Witness Signature"}
];

var h='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
allFields.forEach(function(sf){
var isSel=currentFields.indexOf(sf.id)>=0;
h+='<button onclick="toggleExistingDocSigningField(\''+templateId+'\',\''+sf.id+'\')" style="padding:5px 10px;border-radius:20px;font-size:10px;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid '+(isSel?"var(--teal)":"var(--border)")+';background:'+(isSel?"rgba(10,147,150,.1)":"var(--surface)")+';color:'+(isSel?"var(--teal)":"var(--muted)")+'">'+sf.label+'</button>';
});
h+='</div>';
h+='<button onclick="saveDocTplSigningFields(\''+templateId+'\')" style="padding:6px 14px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:10px;font-weight:700;font-family:inherit;cursor:pointer">üíæ Save Signing Fields</button>';
h+='<span id="docTplSFStatus_'+templateId+'" style="font-size:10px;margin-left:6px"></span>';
editorEl.innerHTML=h;
}

function toggleExistingDocSigningField(templateId,fieldId){
var t=adminDocTemplates.find(function(t){return t.id===templateId});
if(!t)return;
if(!t.signingFields)t.signingFields=[];
var idx=t.signingFields.indexOf(fieldId);
if(idx>=0)t.signingFields.splice(idx,1);else t.signingFields.push(fieldId);
editDocTplSigningFields(templateId); // re-render editor
// Force show
var editorEl=document.getElementById("docTplSigningFieldsEditor_"+templateId);
if(editorEl)editorEl.style.display="block";
}

function saveDocTplSigningFields(templateId){
var t=adminDocTemplates.find(function(t){return t.id===templateId});
if(!t)return;
var statusEl=document.getElementById("docTplSFStatus_"+templateId);
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Saving...</span>';
apiCall("PATCH","/api/doc-templates/"+templateId,{signingFields:t.signingFields||[]}).then(function(data){
if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';return}
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Saved!</span>';
setTimeout(function(){if(statusEl)statusEl.innerHTML="";renderAdminContent(document.getElementById("rightPanel"))},1200);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}


function toggleNomineeSignerConfig(){
  var chk=document.getElementById("newDocTplNomineeRequired");
  var fields=document.getElementById("nomineeSignerFields");
  var box=document.getElementById("nomineSignerBox");
  if(!chk||!fields)return;
  fields.style.display=chk.checked?"":"none";
  if(box){box.style.borderColor=chk.checked?"rgba(124,58,237,.3)":"var(--border)";}
}

function toggleNomineeRequiredOnTemplate(tplId, newVal){
  var tpl=adminDocTemplates.find(function(t){return t.id===tplId});
  if(!tpl)return;
  if(!tpl.signerConfig)tpl.signerConfig={participantRequired:true,nomineeRequired:false,providerCountersign:true};
  tpl.signerConfig.nomineeRequired=newVal;
  // Save to Airtable
  apiCall("PATCH","/api/doc-templates/"+tplId,{signerConfig:JSON.stringify(tpl.signerConfig)}).then(function(){
    loadAdminData();
  }).catch(function(e){console.error("signerConfig update error:",e)});
}

function toggleProviderSignOnTemplate(tplId, newVal){
  var tpl=adminDocTemplates.find(function(t){return t.id===tplId});
  if(!tpl)return;
  if(!tpl.signerConfig)tpl.signerConfig={participantRequired:true,nomineeRequired:false,providerCountersign:true};
  tpl.signerConfig.providerCountersign=newVal;
  apiCall("PATCH","/api/doc-templates/"+tplId,{signerConfig:JSON.stringify(tpl.signerConfig)}).then(function(){
    loadAdminData();
  }).catch(function(e){console.error("signerConfig update error:",e)});
}

// Enhanced send for signing ‚Äî supports multi-signer workflow

// ‚îÄ‚îÄ Distribution recipient picker ‚îÄ‚îÄ
// Add from input field ‚Äî called by Enter key or + Add button
function sdpAddDistFromInput(){
  var input=document.getElementById("sdpDistSearch");
  if(!input)return;
  var val=(input.value||"").trim();
  if(!val)return;
  // If it looks like an email, add directly
  if(val.indexOf("@")>0){
    sdpAddDistRecipient(val, val);
  } else {
    // Try to find a contact match and add first one
    var match=contacts.find(function(c){
      return c.email&&((c.name||"").toLowerCase()===val.toLowerCase()||(c.email||"").toLowerCase()===val.toLowerCase());
    });
    if(match){
      sdpAddDistRecipient(match.email, match.name||match.email);
    } else {
      // Shake the input to indicate it needs a valid email
      input.style.borderColor="var(--red)";
      input.placeholder="Please enter a valid email address";
      setTimeout(function(){input.style.borderColor="rgba(99,102,241,.3)";input.placeholder="name@example.com or search a contact..."},2000);
    }
  }
}

function sdpSearchDistRecipients(){
  var input=document.getElementById("sdpDistSearch");
  var results=document.getElementById("sdpDistResults");
  if(!input||!results)return;
  var q=(input.value||"").trim();
  var ql=q.toLowerCase();
  var already=_sdpDistRecipients.map(function(r){return r.email.toLowerCase()});

  results.innerHTML="";

  // If empty ‚Äî hide dropdown
  if(!q){results.style.display="none";return;}

  // Always show a "use this email" row if it looks like an email
  if(q.indexOf("@")>0){
    var isAlready=already.indexOf(ql)>=0;
    var topRow=document.createElement("div");
    topRow.style.cssText="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:"+(isAlready?"var(--surface2)":"rgba(99,102,241,.04)");
    topRow.innerHTML='<span style="font-size:16px">'+(isAlready?"‚úì":"‚ûï")+'</span><div><div style="font-size:12px;font-weight:700;color:'+(isAlready?"var(--muted)":"#4F46E5")+'">'+(isAlready?"Already added: ":"Add: ")+q+'</div><div style="font-size:10px;color:var(--muted)">'+(isAlready?"This email is already in the list":"Press Enter or click + Add")+'</div></div>';
    if(!isAlready){
      topRow.onmouseover=function(){this.style.background="rgba(99,102,241,.1)"};
      topRow.onmouseout=function(){this.style.background="rgba(99,102,241,.04)"};
      (function(e){topRow.onclick=function(){sdpAddDistRecipient(e,e)}})(q);
    }
    results.appendChild(topRow);
  }

  // Contact matches below
  var matches=contacts.filter(function(c){
    if(!c.email)return false;
    if(already.indexOf(c.email.toLowerCase())>=0)return false;
    return(c.name||"").toLowerCase().indexOf(ql)>=0||(c.email||"").toLowerCase().indexOf(ql)>=0;
  }).slice(0,6);

  matches.forEach(function(c){
    var div=document.createElement("div");
    div.style.cssText="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px";
    div.innerHTML='<div style="width:28px;height:28px;border-radius:50%;background:#4F46E5;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0">'+((c.name||"?").charAt(0).toUpperCase())+'</div><div><div style="font-size:12px;font-weight:700;color:var(--text)">'+(c.name||"Unknown")+'</div><div style="font-size:10px;color:var(--muted)">'+c.email+'</div></div>';
    div.onmouseover=function(){this.style.background="var(--surface2)"};
    div.onmouseout=function(){this.style.background="transparent"};
    (function(email,name){div.onclick=function(){sdpAddDistRecipient(email,name)}})(c.email,c.name||c.email);
    results.appendChild(div);
  });

  if(results.children.length===0){
    results.innerHTML='<div style="padding:10px 12px;font-size:11px;color:var(--muted)">No contacts found. Type or paste an email address above.</div>';
  }
  results.style.display="block";
}
function sdpAddDistRecipient(email,name){
  if(!email)return;
  if(_sdpDistRecipients.length>=10){alert("Maximum 10 recipients.");return;}
  var already=_sdpDistRecipients.some(function(r){return r.email.toLowerCase()===email.toLowerCase()});
  if(already)return;
  _sdpDistRecipients.push({email:email,name:name||email});
  sdpRenderDistList();
  var input=document.getElementById("sdpDistSearch");
  var results=document.getElementById("sdpDistResults");
  if(input)input.value="";
  if(results)results.style.display="none";
}

function sdpRemoveDistRecipient(email){
  _sdpDistRecipients=_sdpDistRecipients.filter(function(r){return r.email!==email});
  sdpRenderDistList();
}

function sdpRenderDistList(){
  var el=document.getElementById("sdpDistList");
  if(!el)return;
  el.innerHTML="";
  if(_sdpDistRecipients.length===0){
    el.innerHTML='<div style="font-size:10px;color:var(--muted);font-style:italic">No recipients added yet ‚Äî search above or type an email address</div>';
    return;
  }
  var header=document.createElement("div");
  header.style.cssText="font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;width:100%;margin-bottom:4px";
  header.textContent=_sdpDistRecipients.length+"/10 recipients";
  el.appendChild(header);

  _sdpDistRecipients.forEach(function(r){
    var chip=document.createElement("div");
    chip.style.cssText="display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.2);border-radius:20px;font-size:11px;max-width:100%;box-sizing:border-box";
    var label=document.createElement("span");
    label.style.cssText="font-weight:700;color:#4F46E5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px";
    label.title=r.email;
    label.textContent=r.name!==r.email?r.name+" <"+r.email+">":r.email;
    var removeBtn=document.createElement("button");
    removeBtn.style.cssText="background:none;border:none;color:#4F46E5;cursor:pointer;font-size:13px;line-height:1;padding:0;flex-shrink:0";
    removeBtn.textContent="‚úï";
    (function(email){removeBtn.onclick=function(){sdpRemoveDistRecipient(email)}})(r.email);
    chip.appendChild(label);
    chip.appendChild(removeBtn);
    el.appendChild(chip);
  });
}
// Close dist dropdown on outside click
document.addEventListener("click",function(e){
  var dd=document.getElementById("sdpDistResults");
  var inp=document.getElementById("sdpDistSearch");
  if(dd&&inp&&!dd.contains(e.target)&&e.target!==inp)dd.style.display="none";
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _auditFilters={from:"",to:"",userEmail:"",search:"",entityType:""};
var _auditOffset=0;
var _auditTotal=0;

function renderAuditLog(){
  var rp=document.getElementById("rightPanel");
  rp.innerHTML="";

  var wrap=document.createElement("div");
  wrap.style.cssText="display:flex;flex-direction:column;height:100%";

  // Header
  var hdr=document.createElement("div");
  hdr.className="rp-hdr";
  hdr.innerHTML='<div class="rp-hdr-info"><div class="rp-hdr-avatar" style="background:linear-gradient(135deg,#6366f1,#7C3AED)">üîç</div><div><div class="rp-hdr-name">Audit Log</div><div class="rp-hdr-sub">Complete record of all changes made in Titus</div></div></div>';
  wrap.appendChild(hdr);

  // Filter bar
  var filters=document.createElement("div");
  filters.style.cssText="padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;flex-shrink:0";
  filters.innerHTML=
    '<div><label style="display:block;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">From</label><input type="date" id="auditFrom" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:12px"></div>'+
    '<div><label style="display:block;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">To</label><input type="date" id="auditTo" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:12px"></div>'+
    '<div><label style="display:block;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">User</label><select id="auditUser" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:12px"><option value="">All Users</option></select></div>'+
    '<div><label style="display:block;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">Type</label><select id="auditType" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:12px"><option value="">All Types</option><option value="Contact">Contacts</option><option value="Client Doc">Client Docs</option></select></div>'+
    '<div style="flex:1;min-width:180px"><label style="display:block;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">Search</label><input type="text" id="auditSearch" placeholder="Name, field, value..." style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--rs);background:var(--surface);color:var(--text);font-family:inherit;font-size:12px;box-sizing:border-box"></div>'+
    '<button onclick="loadAuditLog(0)" style="padding:7px 18px;background:linear-gradient(135deg,#6366f1,#7C3AED);color:#fff;border:none;border-radius:var(--rs);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;flex-shrink:0">üîç Search</button>'+
    '<button onclick="exportAuditCSV()" style="padding:7px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;flex-shrink:0;color:var(--text)">üì• Export CSV</button>';
  wrap.appendChild(filters);

  // Set default dates (last 30 days)
  var now=new Date();
  var from=new Date(now-30*86400000);

  // Results area
  var results=document.createElement("div");
  results.id="auditResults";
  results.style.cssText="flex:1;overflow-y:auto;padding:0";
  results.innerHTML='<div style="text-align:center;padding:60px;color:var(--muted)"><div style="font-size:40px;margin-bottom:12px">üîç</div><div style="font-size:14px;font-weight:600">Set filters and click Search</div></div>';
  wrap.appendChild(results);

  rp.appendChild(wrap);

  // Set default dates after DOM is ready
  setTimeout(function(){
    var af=document.getElementById("auditFrom");
    var at=document.getElementById("auditTo");
    if(af)af.value=from.toISOString().split("T")[0];
    if(at)at.value=now.toISOString().split("T")[0];
    // Load user list and default search
    loadAuditLog(0);
  },50);
}

function loadAuditLog(offset){
  var resultsEl=document.getElementById("auditResults");
  if(!resultsEl)return;

  var from=(document.getElementById("auditFrom")||{}).value||"";
  var to=(document.getElementById("auditTo")||{}).value||"";
  var userEmail=(document.getElementById("auditUser")||{}).value||"";
  var entityType=(document.getElementById("auditType")||{}).value||"";
  var search=(document.getElementById("auditSearch")||{}).value||"";

  if(!offset)resultsEl.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)"><div class="spin" style="width:28px;height:28px;border:2px solid var(--border);border-top-color:#6366f1;border-radius:50%;margin:0 auto 12px"></div>Loading audit log...</div>';

  var params="?limit=100&offset="+(offset||0);
  if(from)params+="&from="+encodeURIComponent(from);
  if(to)params+="&to="+encodeURIComponent(to);
  if(userEmail)params+="&userEmail="+encodeURIComponent(userEmail);
  if(entityType)params+="&entityType="+encodeURIComponent(entityType);
  if(search)params+="&search="+encodeURIComponent(search);

  apiCall("GET","/api/audit-log"+params).then(function(data){
    if(data.error){resultsEl.innerHTML='<div style="padding:20px;color:var(--red)">Error: '+data.error+'</div>';return}

    // Populate user filter dropdown
    var userSel=document.getElementById("auditUser");
    if(userSel&&data.users){
      var currentVal=userSel.value;
      userSel.innerHTML='<option value="">All Users</option>';
      data.users.forEach(function(u){
        var opt=document.createElement("option");
        opt.value=u.user_email;
        opt.textContent=(u.user_name||u.user_email)+" <"+u.user_email+">";
        if(u.user_email===currentVal)opt.selected=true;
        userSel.appendChild(opt);
      });
    }

    var entries=data.entries||[];
    _auditTotal=data.total||0;

    if(entries.length===0&&!offset){
      resultsEl.innerHTML='<div style="text-align:center;padding:60px;color:var(--muted)"><div style="font-size:40px;margin-bottom:12px">üìã</div><div style="font-size:14px;font-weight:600">No audit entries found</div><div style="font-size:12px;margin-top:4px">Try adjusting your filters or date range</div></div>';
      return;
    }

    // Action colour map
    var actionColors={update_contact:"#6366f1",update_client_doc:"#059669",create_contact:"#0A9396",delete_contact:"#EF4444"};
    var actionLabels={update_contact:"Contact Updated",update_client_doc:"Doc Updated",create_contact:"Contact Created",delete_contact:"Contact Deleted"};

    var html='';
    // Summary bar
    html+='<div style="padding:10px 16px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:11px;color:var(--muted);display:flex;align-items:center;gap:12px">';
    html+='<span><strong style="color:var(--text)">'+_auditTotal.toLocaleString()+'</strong> entries found</span>';
    if(_auditTotal>100)html+='<span>Showing '+(offset+1)+'‚Äì'+Math.min(offset+entries.length,_auditTotal)+'</span>';
    html+='</div>';

    // Table
    html+='<table style="width:100%;border-collapse:collapse;font-size:11px">';
    html+='<thead><tr style="background:var(--surface);border-bottom:2px solid var(--border);position:sticky;top:0;z-index:10">';
    html+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap">Date & Time</th>';
    html+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">User</th>';
    html+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Action</th>';
    html+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Record</th>';
    html+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">Field</th>';
    html+='<th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px">New Value</th>';
    html+='</tr></thead><tbody>';

    entries.forEach(function(e,i){
      var dt=new Date(e.created_at);
      var dateStr=("0"+dt.getDate()).slice(-2)+"/"+("0"+(dt.getMonth()+1)).slice(-2)+"/"+dt.getFullYear();
      var timeStr=("0"+dt.getHours()).slice(-2)+":"+("0"+dt.getMinutes()).slice(-2)+":"+("0"+dt.getSeconds()).slice(-2);
      var color=actionColors[e.action]||"var(--muted)";
      var label=actionLabels[e.action]||e.action;
      var rowBg=i%2===0?"var(--surface)":"var(--surface2)";

      html+='<tr style="background:'+rowBg+';border-bottom:1px solid var(--border)" onmouseover="this.style.background=\'rgba(99,102,241,.04)\'" onmouseout="this.style.background=\''+rowBg+'\'">';
      html+='<td style="padding:9px 12px;white-space:nowrap;vertical-align:top"><div style="font-size:11px;font-weight:600;color:var(--text)">'+dateStr+'</div><div style="font-size:10px;color:var(--muted)">'+timeStr+'</div></td>';
      html+='<td style="padding:9px 12px;vertical-align:top"><div style="font-size:11px;font-weight:700;color:var(--text)">'+(e.user_name||"‚Äî")+'</div><div style="font-size:9px;color:var(--muted)">'+(e.user_email||"")+'</div></td>';
      html+='<td style="padding:9px 12px;vertical-align:top"><span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:20px;background:'+color+'18;color:'+color+';border:1px solid '+color+'30">'+label+'</span></td>';
      html+='<td style="padding:9px 12px;vertical-align:top"><div style="font-size:11px;font-weight:600;color:var(--text)">'+(e.entity_label||e.entity_id||"‚Äî")+'</div><div style="font-size:9px;color:var(--muted)">'+(e.entity_type||"")+'</div></td>';
      html+='<td style="padding:9px 12px;vertical-align:top;font-size:11px;color:var(--muted)">'+(e.field_name||"‚Äî")+'</td>';
      var newVal=e.new_value||"";
      if(newVal.length>60)newVal=newVal.substring(0,60)+"‚Ä¶";
      html+='<td style="padding:9px 12px;vertical-align:top;font-size:11px;color:var(--text);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(newVal)+'</td>';
      html+='</tr>';
    });
    html+='</tbody></table>';

    // Pagination
    if(_auditTotal>100){
      html+='<div style="padding:12px 16px;display:flex;gap:8px;justify-content:center;border-top:1px solid var(--border)">';
      if(offset>0)html+='<button onclick="loadAuditLog('+(Math.max(0,offset-100))+')" style="padding:6px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);font-size:12px;cursor:pointer;font-family:inherit">‚Üê Prev</button>';
      if(offset+entries.length<_auditTotal)html+='<button onclick="loadAuditLog('+(offset+100)+')" style="padding:6px 16px;background:#6366f1;color:#fff;border:none;border-radius:var(--rs);font-size:12px;cursor:pointer;font-family:inherit">Next ‚Üí</button>';
      html+='</div>';
    }

    if(offset>0){
      resultsEl.innerHTML+=html;
    } else {
      resultsEl.innerHTML=html;
      resultsEl.scrollTop=0;
    }
  }).catch(function(e){
    resultsEl.innerHTML='<div style="padding:20px;color:var(--red)">Failed to load: '+e.message+'</div>';
  });
}

function escHtml(str){return String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

function exportAuditCSV(){
  var from=(document.getElementById("auditFrom")||{}).value||"";
  var to=(document.getElementById("auditTo")||{}).value||"";
  var params="?limit=500&offset=0";
  if(from)params+="&from="+encodeURIComponent(from);
  if(to)params+="&to="+encodeURIComponent(to);
  apiCall("GET","/api/audit-log"+params).then(function(data){
    var entries=data.entries||[];
    var headers=["Date","Time","User","Email","Action","Entity Type","Record","Field","New Value"];
    var rows=[headers.join(",")];
    entries.forEach(function(e){
      var dt=new Date(e.created_at);
      var dateStr=("0"+dt.getDate()).slice(-2)+"/"+("0"+(dt.getMonth()+1)).slice(-2)+"/"+dt.getFullYear();
      var timeStr=("0"+dt.getHours()).slice(-2)+":"+("0"+dt.getMinutes()).slice(-2);
      rows.push([dateStr,timeStr,e.user_name||"",e.user_email||"",e.action||"",e.entity_type||"",e.entity_label||"",e.field_name||"",'"'+(e.new_value||"").replace(/"/g,"''")+'"'].join(","));
    });
    var blob=new Blob([rows.join("\n")],{type:"text/csv"});
    var url=URL.createObjectURL(blob);
    var a=document.createElement("a");a.href=url;a.download="audit-log-"+from+"-to-"+to+".csv";a.click();
    URL.revokeObjectURL(url);
  }).catch(function(e){alert("Export failed: "+e.message)});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INLINE EDIT for Client Doc cards
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openClientDocInlineEdit(docId, clientName, currentData){
  var overlay=document.createElement("div");
  overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;display:flex;align-items:center;justify-content:center";
  overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};

  var modal=document.createElement("div");
  modal.style.cssText="background:var(--surface);border-radius:var(--r);padding:24px;width:90%;max-width:460px;box-shadow:0 20px 60px rgba(0,0,0,.25)";

  var title=document.createElement("div");
  title.style.cssText="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px";
  title.innerHTML='<div><div style="font-size:15px;font-weight:700;color:var(--text)">‚úèÔ∏è Edit Document</div><div style="font-size:11px;color:var(--muted);margin-top:2px">'+escHtml(clientName||"Client")+'</div></div>';
  var closeBtn=document.createElement("button");
  closeBtn.textContent="‚úï";
  closeBtn.style.cssText="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)";
  closeBtn.onclick=function(){overlay.remove()};
  title.appendChild(closeBtn);
  modal.appendChild(title);

  // Doc Type
  var typeRow=document.createElement("div");
  typeRow.style.marginBottom="14px";
  typeRow.innerHTML='<label style="display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Document Type</label>';
  var typeSelect=document.createElement("select");
  typeSelect.style.cssText="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)";
  ["Service Agreement","Schedule of Support","Support Plan","PBSP Plan","Risk Assessment","Safety Plan","Medical Report","OT or FCA Report","Legal Document","Consent Form","Intake Form","OPG Endorsement","NDIS Plan","Other"].forEach(function(t){
    var o=document.createElement("option");o.value=t;o.textContent=t;
    if(t===currentData.docType)o.selected=true;
    typeSelect.appendChild(o);
  });
  typeRow.appendChild(typeSelect);
  modal.appendChild(typeRow);

  // Expiry Date
  var expRow=document.createElement("div");
  expRow.style.marginBottom="14px";
  expRow.innerHTML='<label style="display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Expiry Date <span style="font-weight:400;text-transform:none">(dd/mm/yyyy or blank)</span></label>';
  var expInput=document.createElement("input");
  expInput.type="text";expInput.placeholder="dd/mm/yyyy";
  // Format existing date for display
  var displayExpiry="";
  if(currentData.expiryDate){
    try{
      var ep=new Date(currentData.expiryDate);
      displayExpiry=("0"+ep.getDate()).slice(-2)+"/"+("0"+(ep.getMonth()+1)).slice(-2)+"/"+ep.getFullYear();
    }catch(ex){displayExpiry=currentData.expiryDate;}
  }
  expInput.value=displayExpiry;
  expInput.style.cssText="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text);box-sizing:border-box";
  expRow.appendChild(expInput);
  modal.appendChild(expRow);

  // Status
  var statusRow=document.createElement("div");
  statusRow.style.marginBottom="20px";
  statusRow.innerHTML='<label style="display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Status</label>';
  var statusSelect=document.createElement("select");
  statusSelect.style.cssText="width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)";
  ["Active","Expired","Superseded","Archived","Pending"].forEach(function(s){
    var o=document.createElement("option");o.value=s;o.textContent=s;
    if(s===(currentData.statusOfDoc||"Active"))o.selected=true;
    statusSelect.appendChild(o);
  });
  statusRow.appendChild(statusSelect);
  modal.appendChild(statusRow);

  // Status message
  var statusMsg=document.createElement("div");
  statusMsg.style.cssText="font-size:11px;min-height:16px;margin-bottom:12px";
  modal.appendChild(statusMsg);

  // Buttons
  var btnRow=document.createElement("div");
  btnRow.style.cssText="display:flex;gap:8px";
  var cancelBtn=document.createElement("button");
  cancelBtn.textContent="Cancel";
  cancelBtn.style.cssText="flex:1;padding:10px;border:1px solid var(--border);background:transparent;border-radius:var(--rs);font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;color:var(--text)";
  cancelBtn.onclick=function(){overlay.remove()};
  var saveBtn=document.createElement("button");
  saveBtn.textContent="üíæ Save Changes";
  saveBtn.style.cssText="flex:2;padding:10px;background:linear-gradient(135deg,#6366f1,#7C3AED);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer";
  saveBtn.onclick=function(){
    saveBtn.disabled=true;saveBtn.textContent="Saving...";
    var payload={
      docType:typeSelect.value,
      expiryDate:expInput.value,
      statusOfDoc:statusSelect.value,
      clientName:clientName,
      "_old_docType":currentData.docType,
      "_old_expiryDate":displayExpiry,
      "_old_statusOfDoc":currentData.statusOfDoc
    };
    apiCall("PATCH","/api/client-docs/"+docId,payload).then(function(d){
      if(d.error){statusMsg.innerHTML='<span style="color:var(--red)">‚ùå '+d.error+'</span>';saveBtn.disabled=false;saveBtn.textContent="üíæ Save Changes";return;}
      statusMsg.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Saved!</span>';
      setTimeout(function(){
        overlay.remove();
        // Reload docs tab
        if(typeof loadClientDocs==="function"){
          var el=document.getElementById("clientDocsContent")||document.getElementById("clientDocsLoading");
          if(el)el.id="clientDocsLoading";
          loadClientDocs("",clientName);
        }
      },800);
    }).catch(function(e){statusMsg.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';saveBtn.disabled=false;saveBtn.textContent="üíæ Save Changes"});
  };
  btnRow.appendChild(cancelBtn);
  btnRow.appendChild(saveBtn);
  modal.appendChild(btnRow);

  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

function sendDocWithSignerWorkflow(docCategory){
  var templateSel=document.getElementById("sdpTemplate");
  var statusEl=document.getElementById("sdpStatus");
  var btn=document.getElementById("sdpSendBtn");
  if(!templateSel||!templateSel.value){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Select a template</span>';return}
  if(!_sdpSelectedContact){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Select a recipient</span>';return}

  var tplId=templateSel.value;
  var tpl=adminDocTemplates.find(function(t){return t.id===tplId});
  var signerConfig=(tpl&&tpl.signerConfig)?tpl.signerConfig:{participantRequired:true,nomineeRequired:false,providerCountersign:true};

  // Check if nominee is required but client has none
  var client=contacts.find(function(c){return c.id===_sdpSelectedContact.id});
  if(signerConfig.nomineeRequired && client && !client.nominee){
    if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ö†Ô∏è This template requires a Nominee/Guardian signature, but none is on file for this client. Please update their contact record first.</span>';
    return;
  }

  if(btn){btn.disabled=true;btn.textContent="Sending..."}
  if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Creating signing request...</span>';

  // If nominee is required, we need to create two signing requests
  var c=_sdpSelectedContact;
  // Find full contact to get signingEmail
  var fullContact=contacts.find(function(ct){return ct.id===c.id})||c;
  var recipientEmail=fullContact.signingEmail||fullContact.email||c.email;
  var sendVia=_sdpSendVia==="Copy Link"?"Link":_sdpSendVia;
  var opt=templateSel.options[templateSel.selectedIndex];
  var docType=opt?opt.getAttribute("data-type"):"";

  var sendPayload={
    recipientName:c.name,
    recipientEmail:recipientEmail,   // ‚Üê uses signing email if set
    recipientPhone:c.phone,
    templateId:tplId,documentType:docType,sendVia:sendVia,contactRecordId:c.id,
    signerConfig:signerConfig,
    signerRole:"participant",
    signingOrder:"contact_first",    // Contact signs first, DCS last
    distributionEmails:_sdpDistRecipients.map(function(r){return r.email}),
    distributionNames:_sdpDistRecipients.map(function(r){return r.name})
  };

  apiCall("POST","/api/doc-signing/send",sendPayload).then(function(data){
    if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';if(btn){btn.disabled=false;btn.textContent="üì§ Send for Signing"}return}

    var successMsg='<span style="color:#059669;font-weight:700">‚úÖ Signing request sent to '+c.name+'</span>';

    // If nominee required, send them a link too
    if(signerConfig.nomineeRequired&&client&&client.nominee){
      var nomineePayload={
        recipientName:client.nominee,
        recipientEmail:client.nomineeEmail||"",
        recipientPhone:client.nomineePhone||client.emergencyPhone||"",
        templateId:tplId,documentType:docType,
        sendVia:(client.nomineePhone||client.emergencyPhone)?sendVia:"Link",
        contactRecordId:c.id,
        signerConfig:signerConfig,
        signerRole:"nominee",
        parentSigningToken:data.token
      };
      apiCall("POST","/api/doc-signing/send",nomineePayload).then(function(d2){
        if(!d2.error){
          successMsg+='<br><span style="color:#7C3AED;font-size:10px">+ Nominee link also created for '+client.nominee+'</span>';
        }
        if(statusEl)statusEl.innerHTML=successMsg;
        if(btn){btn.textContent="‚úÖ Sent";btn.style.background="#059669"}
        setTimeout(function(){renderSendDocPage(docCategory)},2000);
      });
    } else {
      if(_sdpSendVia==="Copy Link"&&data.signingUrl){
        navigator.clipboard.writeText(data.signingUrl).catch(function(){});
        successMsg='<span style="color:#059669;font-weight:700">‚úÖ Link copied!</span><div style="margin-top:4px;padding:6px 8px;background:var(--surface2);border-radius:4px;font-family:JetBrains Mono,monospace;font-size:9px;word-break:break-all;user-select:all">'+data.signingUrl+'</div>';
      }
      if(statusEl)statusEl.innerHTML=successMsg;
      if(btn){btn.textContent="‚úÖ Sent";btn.style.background="#059669"}
      _sdpDistRecipients=[];
      setTimeout(function(){renderSendDocPage(docCategory)},2000);
    }
  }).catch(function(e){
    if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';
    if(btn){btn.disabled=false;btn.textContent="üì§ Send for Signing"}
  });
}

// Show the signer config summary badge on the "Send Document for Signing" panel
function getSignerBadges(tplId){
  var tpl=adminDocTemplates.find(function(t){return t.id===tplId});
  if(!tpl)return"";
  var sc=tpl.signerConfig||{participantRequired:true,nomineeRequired:false,providerCountersign:true};
  var badges='<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">';
  badges+='<span style="padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;background:rgba(30,75,160,.08);color:var(--royal);border:1px solid rgba(30,75,160,.15)">1Ô∏è‚É£ Participant</span>';
  if(sc.nomineeRequired)badges+='<span style="padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;background:rgba(124,58,237,.08);color:#7C3AED;border:1px solid rgba(124,58,237,.15)">2Ô∏è‚É£ Nominee/Guardian</span>';
  if(sc.providerCountersign!==false)badges+='<span style="padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;background:rgba(16,185,129,.08);color:#059669;border:1px solid rgba(16,185,129,.15)">‚úÖ DCS Counter-sign</span>';
  badges+='</div>';
  return badges;
}

function createDocTemplate(){
var name=(document.getElementById("newDocTplName")||{}).value||"";
var type=(document.getElementById("newDocTplType")||{}).value||"";
var desc=(document.getElementById("newDocTplDesc")||{}).value||"";
var reminderEnabled=(document.getElementById("newDocTplReminder")||{}).checked!==false;
var reminderDays=(document.getElementById("newDocTplReminderDays")||{}).value||"3";
var maxReminders=(document.getElementById("newDocTplMaxReminders")||{}).value||"3";
var statusEl=document.getElementById("docTplCreateStatus");

if(!name||!type){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Name and type required</span>';return}
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Creating...</span>';

var payload={
name:name,type:type,description:desc,status:"Active",
reminderEnabled:reminderEnabled,reminderDays:parseInt(reminderDays),maxReminders:parseInt(maxReminders),
signingFields:_pendingSigningFields.length>0?_pendingSigningFields:["signature"]
};

// Include uploaded file if present
if(_pendingTemplateFile){
payload.fileUrl=_pendingTemplateFile.url;
payload.fileName=_pendingTemplateFile.filename;
}

apiCall("POST","/api/doc-templates",payload).then(function(data){
if(data.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+data.error+'</span>';return}
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Template created!</span>';
_pendingTemplateFile=null;
_pendingSigningFields=[];
setTimeout(function(){renderAdmin()},800);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}

function deleteDocTemplate(id){
if(!confirm("Delete this document template? This cannot be undone."))return;
apiCall("DELETE","/api/doc-templates/"+id).then(function(){renderAdmin()}).catch(function(e){alert("Error: "+e.message)});
}

function updateDocTplStatus(id){
var sel=document.getElementById("docTplStatus_"+id);
var statusEl=document.getElementById("docTplActionStatus_"+id);
if(!sel)return;
if(statusEl)statusEl.innerHTML='<span style="color:#F59E0B">‚è≥ Updating...</span>';
apiCall("PATCH","/api/doc-templates/"+id,{status:sel.value}).then(function(){
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Updated</span>';
var t=adminDocTemplates.find(function(t){return t.id===id});
if(t)t.status=sel.value;
setTimeout(function(){renderAdminContent(document.getElementById("rightPanel"))},800);
}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>'});
}

function updateDocTplReminder(id){
var enabled=(document.getElementById("docTplReminder_"+id)||{}).checked;
var days=(document.getElementById("docTplReminderDays_"+id)||{}).value||"3";
var max=(document.getElementById("docTplMaxReminders_"+id)||{}).value||"3";
var via=(document.getElementById("docTplReminderVia_"+id)||{}).value||"Email";
var statusEl=document.getElementById("docTplActionStatus_"+id);

apiCall("PATCH","/api/doc-templates/"+id,{
reminderEnabled:enabled,reminderDays:parseInt(days),maxReminders:parseInt(max),reminderVia:via
}).then(function(){
var t=adminDocTemplates.find(function(t){return t.id===id});
if(t){t.reminderEnabled=enabled;t.reminderDays=parseInt(days);t.maxReminders=parseInt(max);t.reminderVia=via}
if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-size:10px">‚úÖ Reminder settings saved</span>';
setTimeout(function(){if(statusEl)statusEl.innerHTML=""},2000);
}).catch(function(){});
}

function impersonateUser(uid){
var u=adminUsers.find(function(u){return u.id===uid});
if(!u)return;
if(!confirm("View the app as "+u.name+" ("+u.email+")?\n\nYou will see exactly what they see. Click the orange banner to return to your account."))return;
// Save current superadmin session
localStorage.setItem("titus_impersonate_original_token",token);
localStorage.setItem("titus_impersonate_original_user",JSON.stringify(currentUser));
apiCall("POST","/api/admin/impersonate/"+uid).then(function(data){
if(data.error){alert("Error: "+data.error);return}
// Switch to impersonated user
token=data.token;
currentUser=data.user;
localStorage.setItem("titus_token",data.token);
localStorage.setItem("titus_user",JSON.stringify(data.user));
// Reset all loaded data caches
accommodationLoaded=false;leadsLoaded=false;contacts=[];conversations=[];emailList=[];
// Rebuild UI
showDashboard();
currentView="dashboard";render();
}).catch(function(e){alert("Impersonation failed: "+(e.message||"Error"))})}

function exitImpersonation(){
var origToken=localStorage.getItem("titus_impersonate_original_token");
var origUser=null;
try{origUser=JSON.parse(localStorage.getItem("titus_impersonate_original_user"))}catch(e){}
if(!origToken||!origUser){alert("No original session found");return}
// Delete the impersonated session
apiCall("POST","/api/auth/logout",{}).catch(function(){});
// Restore superadmin
token=origToken;
currentUser=origUser;
localStorage.setItem("titus_token",origToken);
localStorage.setItem("titus_user",JSON.stringify(origUser));
localStorage.removeItem("titus_impersonate_original_token");
localStorage.removeItem("titus_impersonate_original_user");
// Remove banner + margin
var banner=document.getElementById("impersonateBanner");if(banner)banner.remove();
var dash=document.getElementById("dashboard");if(dash)dash.style.marginTop="";
// Reset all sidebar items to visible
document.querySelectorAll(".sb-item,.sb-sub-item").forEach(function(b){b.style.display=""});
// Reset caches
accommodationLoaded=false;leadsLoaded=false;contacts=[];conversations=[];
// Rebuild
showDashboard();
currentView="admin";render()}

function isImpersonating(){
return !!localStorage.getItem("titus_impersonate_original_token")
}

function renderImpersonationBanner(){
var existing=document.getElementById("impersonateBanner");
if(existing)existing.remove();
if(!isImpersonating())return;
var origUser=null;try{origUser=JSON.parse(localStorage.getItem("titus_impersonate_original_user"))}catch(e){}
var div=document.createElement("div");
div.id="impersonateBanner";
div.style.cssText="position:fixed;top:0;left:0;right:0;z-index:99999;background:linear-gradient(90deg,#D97706,#F59E0B);color:#fff;padding:8px 16px;display:flex;align-items:center;justify-content:center;gap:12px;font-size:12px;font-weight:700;font-family:inherit;box-shadow:0 2px 8px rgba(0,0,0,.2)";
div.innerHTML='<span>üëÅÔ∏è VIEWING AS: '+(currentUser.name||currentUser.email)+' ('+(currentUser.role||"")+''+(currentUser.job_title?" ‚Äî "+currentUser.job_title:"")+')</span><button onclick="exitImpersonation()" style="background:#fff;color:#D97706;border:none;padding:5px 16px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">‚Üê Return to '+(origUser?origUser.name:"Super Admin")+'</button>';
document.body.appendChild(div);
// Push dashboard down
var dash=document.getElementById("dashboard");
if(dash)dash.style.marginTop="38px";
var login=document.getElementById("loginScreen");
if(login)login.style.marginTop="38px"}
function saveTimezone(val){localStorage.setItem("titus_timezone",val);window._appTimezone=val;updateTzBar();render();apiCall("POST","/api/settings/timezone",{timezone:val})}
function makeCall(phone){if(!phone)return;openDialerWithNumber(phone,findContactName(phone))}
function focusSms(){if(selectedConv){openSmsComposer(selectedConv.phone,selectedConv.name)}else{openSmsComposer()}}
function sendSms(){if(!selectedConv)return;var input=document.getElementById("smsInput");var body=input.value.trim();if(!body)return;apiCall("POST","/api/sms/send",{to:selectedConv.phone,body:body}).then(function(d){if(d.error){alert("SMS error: "+d.error);return}input.value="";apiCall("GET","/api/sms").then(function(d){smsList=d||[];buildConversations();render()})})}

// ‚ïê‚ïê‚ïê EMAIL FUNCTIONS ‚ïê‚ïê‚ïê
function syncEmails(daysBack){var days=daysBack||90;var btn=event&&event.target;if(btn){btn.textContent="‚è≥ Syncing...";btn.disabled=true}apiCall("POST","/api/email/sync",{daysBack:days}).then(function(d){if(d.error){alert("Email sync error: "+d.error);if(btn){btn.textContent="üìß Sync Emails";btn.disabled=false}return}apiCall("GET","/api/email/list").then(function(emails){emailList=emails||[];buildConversations();render();if(btn){btn.textContent="‚úÖ Synced!";setTimeout(function(){btn.textContent="üìß Sync Emails";btn.disabled=false},2000)}})}).catch(function(e){alert("Email sync failed: "+e.message);if(btn){btn.textContent="üìß Sync Emails";btn.disabled=false}})}
window._emailDaysFetched=90;
function fetchMoreEmails(){window._emailDaysFetched=(window._emailDaysFetched||90)+90;var btn=event&&event.target;if(btn){btn.textContent="‚è≥ Fetching older emails...";btn.disabled=true}apiCall("POST","/api/email/sync",{daysBack:window._emailDaysFetched}).then(function(d){apiCall("GET","/api/email/list").then(function(emails){emailList=emails||[];buildConversations();render();if(btn){btn.textContent="‚úÖ Fetched!";setTimeout(function(){btn.textContent="üì¨ Fetch More ("+window._emailDaysFetched+" ‚Üí "+(window._emailDaysFetched+90)+" days)";btn.disabled=false},2000)}})}).catch(function(e){alert("Failed: "+e.message);if(btn){btn.textContent="üì¨ Fetch More";btn.disabled=false}})}

function openEmailCompose(toEmail,toName,subject){var overlay=document.getElementById("emailOverlay");if(!overlay){var h='<div id="emailOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center">';h+='<div style="background:var(--surface);border-radius:var(--r);width:90%;max-width:680px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">';h+='<div style="padding:16px 20px;background:linear-gradient(135deg,#4F46E5,#6366F1);color:#fff;display:flex;align-items:center;justify-content:space-between">';h+='<div style="font-size:14px;font-weight:700">üìß Compose Email</div>';h+='<button onclick="closeEmailCompose()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0 4px">‚úï</button></div>';h+='<div style="padding:16px 20px;overflow-y:auto;max-height:70vh">';h+='<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">To</label><input id="emailTo" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';h+='<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">CC <span style="font-weight:400">(optional)</span></label><input id="emailCc" placeholder="email@example.com" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';h+='<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Subject</label><input id="emailSubject" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';
h+='<div style="margin-bottom:10px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Message</label>';
h+='<div style="border:1px solid var(--border);border-radius:var(--rs);overflow:hidden">';
h+='<div id="emailToolbar" style="display:flex;gap:2px;padding:6px 8px;background:var(--surface2);border-bottom:1px solid var(--border);flex-wrap:wrap">';
h+='<button type="button" onclick="emailExec(\'bold\')" title="Bold" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-weight:bold;font-size:13px;font-family:inherit;display:flex;align-items:center;justify-content:center">B</button>';
h+='<button type="button" onclick="emailExec(\'italic\')" title="Italic" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-style:italic;font-size:13px;font-family:inherit;display:flex;align-items:center;justify-content:center">I</button>';
h+='<button type="button" onclick="emailExec(\'underline\')" title="Underline" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;text-decoration:underline;font-size:13px;font-family:inherit;display:flex;align-items:center;justify-content:center">U</button>';
h+='<span style="width:1px;background:var(--border);margin:0 4px"></span>';
h+='<button type="button" onclick="emailExec(\'insertUnorderedList\')" title="Bullet list" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">‚ò∞</button>';
h+='<button type="button" onclick="emailExec(\'insertOrderedList\')" title="Numbered list" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">1.</button>';
h+='<span style="width:1px;background:var(--border);margin:0 4px"></span>';
h+='<select onchange="emailExecVal(\'fontSize\',this.value);this.selectedIndex=0" style="height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);font-size:11px;padding:0 4px;cursor:pointer"><option value="">Size</option><option value="1">Small</option><option value="3">Normal</option><option value="5">Large</option><option value="7">Huge</option></select>';
h+='<select onchange="emailExecVal(\'foreColor\',this.value);this.selectedIndex=0" style="height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);font-size:11px;padding:0 4px;cursor:pointer"><option value="">Color</option><option value="#000000">Black</option><option value="#e53e3e">Red</option><option value="#3182ce">Blue</option><option value="#38a169">Green</option><option value="#805ad5">Purple</option><option value="#dd6b20">Orange</option></select>';
h+='<span style="width:1px;background:var(--border);margin:0 4px"></span>';
h+='<button type="button" onclick="emailInsertLink()" title="Insert link" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">üîó</button>';
h+='<button type="button" onclick="emailExec(\'removeFormat\')" title="Clear formatting" style="width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--surface);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center">‚úï</button>';
h+='</div>';
h+='<div id="emailBody" contenteditable="true" style="min-height:200px;max-height:350px;overflow-y:auto;padding:12px;font-size:13px;font-family:inherit;line-height:1.6;outline:none;color:var(--text)"></div>';
h+='</div></div>';
h+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Attachments</label>';
h+='<div id="emailAttachmentsList" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px"></div>';
h+='<label style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--surface2);border:1px dashed var(--border);border-radius:var(--rs);cursor:pointer;font-size:11px;font-weight:600;color:var(--muted)"><input type="file" id="emailFileInput" multiple onchange="handleEmailAttachments(this)" style="display:none">üìé Attach Files</label>';
h+='<span style="font-size:10px;color:var(--muted);margin-left:8px">Max 10MB per file</span></div>';
h+='<div style="display:flex;gap:8px;align-items:center"><button onclick="sendEmail()" id="emailSendBtn" style="padding:10px 24px;background:#4F46E5;color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">üì® Send Email</button><span id="emailSendStatus" style="font-size:11px"></span></div>';h+='<div style="font-size:10px;color:var(--muted);margin-top:8px">Sending from: rosters@deltacommunity.com.au</div>';h+='</div></div></div>';document.body.insertAdjacentHTML("beforeend",h);overlay=document.getElementById("emailOverlay")}overlay.style.display="flex";document.getElementById("emailTo").value=toEmail||"";document.getElementById("emailCc").value="";document.getElementById("emailSubject").value=subject||"";document.getElementById("emailBody").innerHTML="";document.getElementById("emailAttachmentsList").innerHTML="";document.getElementById("emailSendStatus").textContent="";document.getElementById("emailSendBtn").disabled=false;document.getElementById("emailSendBtn").textContent="üì® Send Email";window._emailAttachments=[];document.getElementById("emailBody").focus()}

function emailExec(cmd){document.execCommand(cmd,false,null);document.getElementById("emailBody").focus()}
function emailExecVal(cmd,val){if(!val)return;document.execCommand(cmd,false,val);document.getElementById("emailBody").focus()}
function emailInsertLink(){var url=prompt("Enter URL:","https://");if(url)document.execCommand("createLink",false,url);document.getElementById("emailBody").focus()}

function handleEmailAttachments(input){var files=input.files;if(!files||!files.length)return;for(var i=0;i<files.length;i++){var f=files[i];if(f.size>10*1024*1024){alert(f.name+" is too large (max 10MB)");continue}window._emailAttachments=window._emailAttachments||[];window._emailAttachments.push(f)}input.value="";renderEmailAttachments()}
function renderEmailAttachments(){var el=document.getElementById("emailAttachmentsList");if(!el)return;var atts=window._emailAttachments||[];if(atts.length===0){el.innerHTML="";return}var html="";atts.forEach(function(f,idx){var sizeStr=f.size>1048576?(f.size/1048576).toFixed(1)+" MB":(f.size/1024).toFixed(0)+" KB";html+='<div style="display:flex;align-items:center;gap:6px;padding:4px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);font-size:11px"><span>üìé '+f.name+' ('+sizeStr+')</span><button onclick="removeEmailAttachment('+idx+')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;padding:0 2px">‚úï</button></div>'});el.innerHTML=html}
function removeEmailAttachment(idx){window._emailAttachments.splice(idx,1);renderEmailAttachments()}

function closeEmailCompose(){var overlay=document.getElementById("emailOverlay");if(overlay)overlay.style.display="none"}

function openNewEmailCompose(){var overlay=document.createElement("div");overlay.id="newEmailOverlay";overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1001;display:flex;align-items:center;justify-content:center";overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};var h='<div style="background:var(--surface);border-radius:var(--r);width:90%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.3)">';h+='<div style="padding:14px 20px;background:linear-gradient(135deg,#4F46E5,#6366F1);color:#fff;border-radius:var(--r) var(--r) 0 0;display:flex;align-items:center;justify-content:space-between"><div style="font-size:14px;font-weight:700">‚úâÔ∏è New Email</div><button onclick="document.getElementById(\'newEmailOverlay\').remove()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer">‚úï</button></div>';h+='<div style="padding:20px">';h+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Send to a Contact</label>';h+='<select id="newEmailContactSelect" onchange="newEmailSelectContact(this.value)" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box;background:var(--surface)">';h+='<option value="">‚Äî Select a contact ‚Äî</option>';var emailContacts=contacts.filter(function(c){return c.email}).sort(function(a,b){return(a.name||"").localeCompare(b.name||"")});emailContacts.forEach(function(c){h+='<option value="'+c.email+'">'+c.name+' ('+c.email+')</option>'});h+='</select></div>';h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:14px"><div style="flex:1;height:1px;background:var(--border)"></div><span style="font-size:10px;font-weight:600;color:var(--muted)">OR</span><div style="flex:1;height:1px;background:var(--border)"></div></div>';h+='<div style="margin-bottom:14px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:4px">Type an Email Address</label>';h+='<input id="newEmailManualAddr" placeholder="email@example.com" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';h+='<button onclick="submitNewEmail()" style="width:100%;padding:10px;background:#4F46E5;color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">‚Üí Continue to Compose</button>';h+='</div></div>';overlay.innerHTML=h;document.body.appendChild(overlay)}
function newEmailSelectContact(email){if(email){document.getElementById("newEmailManualAddr").value=email}}
function submitNewEmail(){var sel=(document.getElementById("newEmailContactSelect")||{}).value||"";var manual=(document.getElementById("newEmailManualAddr")||{}).value||"";var toEmail=manual||sel;if(!toEmail){alert("Please select a contact or enter an email address");return}var toName="";if(sel===toEmail){var c=contacts.find(function(ct){return ct.email===toEmail});if(c)toName=c.name||""}var ov=document.getElementById("newEmailOverlay");if(ov)ov.remove();openEmailCompose(toEmail,toName)}

function openEmailForward(emailId,subject){apiCall("GET","/api/email/"+emailId).then(function(em){var fwdSubject="Fwd: "+(subject||em.subject||"");var fwdBody='<br><br>---------- Forwarded message ----------<br>';fwdBody+='<b>From:</b> '+(em.from_name||"")+" &lt;"+(em.from_address||"")+"&gt;<br>";fwdBody+='<b>Date:</b> '+(em.received_at||em.sent_at||"")+"<br>";fwdBody+='<b>Subject:</b> '+(em.subject||"")+"<br>";fwdBody+='<b>To:</b> '+(em.to_name||"")+" &lt;"+(em.to_address||"")+"&gt;<br><br>";fwdBody+=(em.body_html||em.body_preview||"");openEmailCompose("","",fwdSubject);setTimeout(function(){var bodyEl=document.getElementById("emailBody");if(bodyEl)bodyEl.innerHTML=fwdBody},200)}).catch(function(e){openEmailCompose("","","Fwd: "+(subject||""))})}

function sendEmail(){var to=(document.getElementById("emailTo")||{}).value||"";var cc=(document.getElementById("emailCc")||{}).value||"";var subject=(document.getElementById("emailSubject")||{}).value||"";var bodyEl=document.getElementById("emailBody");var body=bodyEl?bodyEl.innerHTML:"";var statusEl=document.getElementById("emailSendStatus");var btn=document.getElementById("emailSendBtn");if(!to){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Recipient email required</span>';return}if(!subject){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Subject required</span>';return}if(btn){btn.disabled=true;btn.textContent="‚è≥ Sending..."}var payload={to:to,subject:subject,body:body,isHtml:true,toName:""};if(cc)payload.cc=cc.split(",").map(function(e){return e.trim()}).filter(Boolean);
var atts=window._emailAttachments||[];if(atts.length>0){var promises=atts.map(function(f){return new Promise(function(resolve){var reader=new FileReader();reader.onload=function(){resolve({name:f.name,contentType:f.type||"application/octet-stream",contentBytes:reader.result.split(",")[1]})};reader.readAsDataURL(f)})});Promise.all(promises).then(function(attachments){payload.attachments=attachments;doSendEmail(payload,btn,statusEl)}).catch(function(){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Failed to process attachments</span>';if(btn){btn.disabled=false;btn.textContent="üì® Send Email"}})}else{doSendEmail(payload,btn,statusEl)}}

function doSendEmail(payload,btn,statusEl){apiCall("POST","/api/email/send",payload).then(function(d){if(d.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+d.error+'</span>';if(btn){btn.disabled=false;btn.textContent="üì® Send Email"}return}if(statusEl)statusEl.innerHTML='<span style="color:#059669;font-weight:700">‚úÖ Email sent!</span>';if(btn)btn.textContent="‚úÖ Sent!";apiCall("GET","/api/email/list").then(function(emails){emailList=emails||[];buildConversations();render()});setTimeout(function(){closeEmailCompose()},1500)}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">‚ùå '+e.message+'</span>';if(btn){btn.disabled=false;btn.textContent="üì® Send Email"}})}

function filterAecClients(){var q=(document.getElementById("aecClientSearch").value||"").toLowerCase();var dd=document.getElementById("aecClientDD");if(!dd)return;dd.style.display="block";var opts=dd.querySelectorAll(".aec-client-opt");opts.forEach(function(el){var name=(el.getAttribute("data-name")||"").toLowerCase();el.style.display=name.indexOf(q)>=0?"flex":"none"})}
function selectAecClient(el){var id=el.getAttribute("data-id");var name=el.getAttribute("data-name");document.getElementById("aecClientId").value=id;document.getElementById("aecClientSearch").value=name;document.getElementById("aecClientDD").style.display="none";var linked=document.getElementById("aecLinkedClient");if(linked){linked.style.display="flex";document.getElementById("aecLinkedName").textContent="üîó Linked to: "+name}}
function clearAecClient(){document.getElementById("aecClientId").value="";document.getElementById("aecClientSearch").value="";var linked=document.getElementById("aecLinkedClient");if(linked)linked.style.display="none"}
function addEmailAsContact(email,name){var parts=(name||"").split(" ");var firstName=parts[0]||"";var lastName=parts.slice(1).join(" ")||"";var overlay=document.createElement("div");overlay.id="addEmailContactOverlay";overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1001;display:flex;align-items:center;justify-content:center";overlay.onclick=function(e){if(e.target===overlay)overlay.remove()};var h='<div style="background:var(--surface);border-radius:var(--r);width:90%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">';h+='<div style="padding:14px 20px;background:linear-gradient(135deg,var(--teal),#0d9488);color:#fff;border-radius:var(--r) var(--r) 0 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:2"><div style="font-size:14px;font-weight:700">\u{1F464} Save as Contact</div><button onclick="document.getElementById(\'addEmailContactOverlay\').remove()" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer">\u2715</button></div>';h+='<div style="padding:20px">';h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px"><div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">First Name</label><input id="aecFirstName" value="'+firstName.replace(/"/g,"&quot;")+'" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div><div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Last Name</label><input id="aecLastName" value="'+lastName.replace(/"/g,"&quot;")+'" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div></div>';h+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Email</label><input id="aecEmail" value="'+email.replace(/"/g,"&quot;")+'" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';h+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Phone <span style="font-weight:400">(optional)</span></label><input id="aecPhone" placeholder="e.g. 0412345678" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';h+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Organisation / Company <span style="font-weight:400">(optional)</span></label><input id="aecOrg" placeholder="e.g. Wholesome Solutions" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"></div>';h+='<div style="margin-bottom:12px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Type of Contact</label><select id="aecType" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box;background:var(--surface)">';h+='<option value="">\u2014 Select type \u2014</option>';CONTACT_TYPES.forEach(function(t){h+='<option value="'+t+'">'+t+'</option>'});h+='</select></div>';h+='<div style="margin-bottom:16px"><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px">Link to NDIS Client <span style="font-weight:400">(optional)</span></label>';h+='<div style="position:relative"><input id="aecClientSearch" placeholder="Search client name..." oninput="filterAecClients()" onfocus="document.getElementById(\'aecClientDD\').style.display=\'block\'" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rs);font-size:13px;font-family:inherit;box-sizing:border-box"><div id="aecClientDD" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:50;max-height:180px;overflow-y:auto;margin-top:2px">';var ndisClients=clientsList.sort(function(a,b){return(a.name||"").localeCompare(b.name||"")});ndisClients.forEach(function(c){h+='<div class="aec-client-opt" data-id="'+c.airtable_id+'" data-name="'+(c.name||"").replace(/"/g,"&quot;")+'" onclick="selectAecClient(this)" style="padding:8px 10px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border)"><span class="contact-type-badge '+(c.contactType==="NDIS Client (Active)"?"type-green":"type-orange")+'" style="font-size:9px">'+(c.contactType==="NDIS Client (Active)"?"Active":"Prospect")+'</span> <span>'+(c.name||"Unknown")+'</span></div>'});if(ndisClients.length===0)h+='<div style="padding:10px;font-size:11px;color:var(--muted);text-align:center">No NDIS clients found</div>';h+='</div></div>';h+='<div id="aecLinkedClient" style="display:none;margin-top:6px;padding:6px 10px;background:rgba(10,175,171,.06);border:1px solid rgba(10,175,171,.15);border-radius:var(--rs);font-size:11px;display:none;align-items:center;justify-content:space-between"><span id="aecLinkedName"></span><button onclick="clearAecClient()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:11px;font-weight:700">\u2715 Remove</button></div>';h+='<input type="hidden" id="aecClientId" value=""></div>';h+='<div style="display:flex;gap:8px;align-items:center"><button onclick="submitEmailContact()" id="aecSaveBtn" style="padding:10px 24px;background:var(--teal);color:#fff;border:none;border-radius:var(--rs);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">\u{1F4BE} Save Contact</button><span id="aecStatus" style="font-size:11px"></span></div>';h+='</div></div>';overlay.innerHTML=h;document.body.appendChild(overlay);document.getElementById("aecFirstName").focus();document.addEventListener("click",function _aecClose(e){var dd=document.getElementById("aecClientDD");if(dd&&!dd.contains(e.target)&&e.target.id!=="aecClientSearch")dd.style.display="none"},{once:false})}
function submitEmailContact(){var firstName=(document.getElementById("aecFirstName")||{}).value||"";var lastName=(document.getElementById("aecLastName")||{}).value||"";var email=(document.getElementById("aecEmail")||{}).value||"";var phone=(document.getElementById("aecPhone")||{}).value||"";var org=(document.getElementById("aecOrg")||{}).value||"";var contactType=(document.getElementById("aecType")||{}).value||"";var statusEl=document.getElementById("aecStatus");var btn=document.getElementById("aecSaveBtn");if(!firstName&&!lastName){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Name required</span>';return}if(!contactType){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">Please select a contact type</span>';return}if(btn){btn.disabled=true;btn.textContent="‚è≥ Saving..."}var payload={firstName:firstName,lastName:lastName,email:email,contactType:contactType};if(phone)payload.phone=phone;if(org)payload.organisation=org;apiCall("POST","/api/contacts",payload).then(function(d){if(d.error){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">'+d.error+'</span>';if(btn){btn.disabled=false;btn.textContent="üíæ Save Contact"}return}if(statusEl)statusEl.innerHTML='<span style="color:var(--green);font-weight:700">‚úÖ Contact saved!</span>';if(btn)btn.textContent="‚úÖ Saved!";apiCall("GET","/api/contacts").then(function(c){contacts=c||[];buildConversations();render()});setTimeout(function(){var ov=document.getElementById("addEmailContactOverlay");if(ov)ov.remove()},1200)}).catch(function(e){if(statusEl)statusEl.innerHTML='<span style="color:var(--red)">'+e.message+'</span>';if(btn){btn.disabled=false;btn.textContent="üíæ Save Contact"}})}

function viewFullEmail(emailId){apiCall("GET","/api/email/"+emailId).then(function(em){if(!em||em.error){alert("Failed to load email");return}var overlay=document.createElement("div");overlay.id="emailViewOverlay";overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1001;display:flex;align-items:center;justify-content:center";var h='<div style="background:var(--surface);border-radius:var(--r);width:90%;max-width:700px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">';h+='<div style="padding:14px 20px;background:linear-gradient(135deg,#4F46E5,#6366F1);color:#fff;display:flex;align-items:center;justify-content:space-between">';h+='<div style="font-size:14px;font-weight:700">üìß '+(em.subject||"(No subject)")+'</div>';h+='<button onclick="document.getElementById(\'emailViewOverlay\').remove()" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0 4px">‚úï</button></div>';h+='<div style="padding:16px 20px;overflow-y:auto;max-height:calc(90vh - 60px)">';h+='<div style="display:flex;gap:20px;margin-bottom:12px;font-size:12px;flex-wrap:wrap">';h+='<div><span style="font-weight:700;color:var(--muted)">From:</span> '+(em.from_name||"")+" &lt;"+(em.from_address||"")+"&gt;</div>";h+='<div><span style="font-weight:700;color:var(--muted)">To:</span> '+(em.to_name||"")+" &lt;"+(em.to_address||"")+"&gt;</div>";if(em.cc)h+='<div><span style="font-weight:700;color:var(--muted)">CC:</span> '+em.cc+'</div>';h+='<div><span style="font-weight:700;color:var(--muted)">Date:</span> '+fmtDateInTZ(em.received_at||em.sent_at)+" "+fmtTimeInTZ(em.received_at||em.sent_at)+"</div>";h+='</div><hr style="border:none;border-top:1px solid var(--border);margin:12px 0">';if(em.body_html&&em.body_html.length>10){h+='<div style="font-size:13px;line-height:1.6;color:var(--text)">'+em.body_html+'</div>'}else{h+='<div style="font-size:13px;line-height:1.6;color:var(--text);white-space:pre-wrap">'+(em.body_preview||"No content")+'</div>'}h+='</div></div>';overlay.innerHTML=h;document.body.appendChild(overlay);overlay.addEventListener("click",function(e){if(e.target===overlay)overlay.remove()})}).catch(function(e){alert("Failed to load email: "+e.message)})}
function sendAi(){var input=document.getElementById("aiInput");var q=input.value.trim();if(!q)return;var msgs=document.getElementById("aiMessages");msgs.innerHTML+='<div class="ai-msg user">'+q+'</div>';input.value="";msgs.innerHTML+='<div class="ai-msg bot" id="aiLoading" style="opacity:.5">Thinking...</div>';msgs.scrollTop=msgs.scrollHeight;apiCall("POST","/api/ai/ask",{question:q}).then(function(data){var loading=document.getElementById("aiLoading");if(loading)loading.remove();msgs.innerHTML+='<div class="ai-msg bot">'+(data.answer||"No response")+'</div>';msgs.scrollTop=msgs.scrollHeight}).catch(function(){var loading=document.getElementById("aiLoading");if(loading)loading.remove();msgs.innerHTML+='<div class="ai-msg bot">Sorry, something went wrong.</div>'})}
function addUser(){addUserWithPerms()}
function deleteUser(id){if(confirm("Remove this user?")){apiCall("DELETE","/api/admin/users/"+id).then(function(){renderAdmin()})}}
document.getElementById("loginBtn").addEventListener("click",function(){var email=document.getElementById("loginEmail").value;var password=document.getElementById("loginPassword").value;var errEl=document.getElementById("loginError");if(!email||!password){errEl.textContent="Please enter email and password";errEl.style.display="block";return}errEl.style.display="none";fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:email,password:password})}).then(function(r){return r.json()}).then(function(data){if(data.error){errEl.textContent=data.error;errEl.style.display="block";return}token=data.token;currentUser=data.user;localStorage.setItem("titus_token",data.token);localStorage.setItem("titus_user",JSON.stringify(data.user));showDashboard()}).catch(function(){errEl.textContent="Connection failed";errEl.style.display="block"})});
document.getElementById("loginPassword").addEventListener("keydown",function(e){if(e.key==="Enter")document.getElementById("loginBtn").click()});
document.getElementById("loginEmail").addEventListener("keydown",function(e){if(e.key==="Enter")document.getElementById("loginBtn").click()});
document.getElementById("logoutBtn").addEventListener("click",function(){if(isImpersonating()){exitImpersonation();return}apiCall("POST","/api/auth/logout",{});localStorage.removeItem("titus_token");localStorage.removeItem("titus_user");token=null;currentUser=null;showLogin()});
document.querySelectorAll(".sb-item").forEach(function(btn){btn.addEventListener("click",function(){var view=this.getAttribute("data-view");if(view==="recruit"||view==="inbox"||view==="leads"||view==="rosters"||view==="reports")return;currentView=view;selectedConv=null;render()})});
document.querySelectorAll(".mid-tab").forEach(function(tab){tab.addEventListener("click",function(){convFilter=this.getAttribute("data-filter");document.querySelectorAll(".mid-tab").forEach(function(t){t.classList.remove("on")});this.classList.add("on");renderConvList()})});
document.getElementById("midSearch").addEventListener("input",function(){if(currentView==="conversations")renderConvList();else if(currentView==="contacts")renderContactsList()});
socket.on("call:incoming",function(d){calls.unshift({sid:d.sid,type:"inbound",from_number:d.from,to_number:d.to,status:"ringing",created_at:new Date().toISOString()});buildConversations();render()});
socket.on("call:status",function(d){calls=calls.map(function(c){return c.sid===d.sid?Object.assign({},c,{status:d.status,duration:d.duration}):c});buildConversations();render()});
socket.on("call:summarised",function(d){calls=calls.map(function(c){return c.sid===d.sid?Object.assign({},c,{summary:d.summary}):c});buildConversations();render()});
socket.on("sms:incoming",function(d){smsList.unshift({sid:d.sid,direction:"inbound",from_number:d.from,body:d.body,created_at:new Date().toISOString()});buildConversations();render()});
socket.on("call:recording",function(d){calls=calls.map(function(c){if(c.sid!==d.sid)return c;return Object.assign({},c,{recording_url:d.recording_url});});buildConversations();if(currentView==="conversations")render();console.log("Recording ready for",d.sid);});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TWILIO BROWSER SOFTPHONE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var twilioDevice = null;
var twilioConnection = null;
var twilioIdentity = null;
var softphoneRinging = false;

function initTwilioDevice() {
  if (!window.Twilio || !window.Twilio.Device) {
    // SDK may still be loading ‚Äî retry in 2 seconds
    console.log("Twilio SDK not ready yet, retrying in 2s...");
    setTimeout(initTwilioDevice, 2000);
    return;
  }
  apiCall("GET", "/api/twilio/token").then(function(data) {
    if (!data.token) { console.error("Twilio token API response:", JSON.stringify(data)); return; }
    twilioIdentity = data.identity;
    twilioDevice = new Twilio.Device(data.token, {
      codecPreferences: ["opus","pcmu"],
      logLevel: 1
    });
    // SDK 2.x uses .register() and emits "registered" instead of "ready"
    twilioDevice.on("registered", function() {
      console.log("Twilio Device ready:", twilioIdentity);
      updateSoftphoneStatus("ready");
    });
    twilioDevice.on("error", function(err) {
      console.error("Twilio Device error:", err.message);
      updateSoftphoneStatus("offline");
    });
    twilioDevice.on("incoming", function(call) {
      twilioConnection = call;
      softphoneRinging = true;
      var callerNum = call.parameters.From || "Unknown";
      showIncomingCallBanner(callerNum, call);
      // SDK 2.x call events
      call.on("disconnect", function() {
        softphoneRinging = false;
        twilioConnection = null;
        hideIncomingCallBanner();
        updateSoftphoneStatus("ready");
        setMyAvailability("available");
      });
      call.on("cancel", function() {
        softphoneRinging = false;
        hideIncomingCallBanner();
        updateSoftphoneStatus("ready");
      });
    });
    twilioDevice.on("tokenWillExpire", function() {
      console.log("Twilio token expiring ‚Äî refreshing");
      apiCall("GET", "/api/twilio/token").then(function(d) {
        if (d.token) twilioDevice.updateToken(d.token);
      });
    });
    twilioDevice.register();
    // Refresh token before expiry (50 min fallback)
    setTimeout(function(){ initTwilioDevice(); }, 50*60*1000);
  }).catch(function(e){ console.log("Twilio token fetch failed:", e.message); });
}

function updateSoftphoneStatus(status) {
  var dot = document.getElementById("softphoneDot");
  var label = document.getElementById("softphoneLabel");
  if (!dot || !label) return;
  var map = { ready: ["#10b981","Ready"], ringing: ["#f59e0b","Ringing..."], active: ["#ef4444","On Call"], offline: ["#94a3b8","Offline"] };
  var s = map[status] || map.offline;
  dot.style.background = s[0];
  label.textContent = s[1];
  var dd = document.getElementById("dialerSoftphoneDot");
  var dl = document.getElementById("dialerSoftphoneLabel");
  if (dd && dl) { dd.style.background = s[0]; dl.textContent = "Softphone " + s[1]; }
}

function showIncomingCallBanner(callerNum, conn) {
  updateSoftphoneStatus("ringing");
  var existing = document.getElementById("incomingCallBanner");
  if (existing) existing.remove();
  var banner = document.createElement("div");
  banner.id = "incomingCallBanner";
  banner.style.cssText = "position:fixed;top:20px;right:20px;z-index:9999;background:var(--surface);border:2px solid var(--teal);border-radius:16px;padding:20px 24px;box-shadow:0 8px 32px rgba(0,0,0,.25);min-width:300px;animation:slideInRight .3s ease";
  banner.innerHTML = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">'
    + '<div style="width:44px;height:44px;border-radius:50%;background:rgba(10,147,150,.15);display:flex;align-items:center;justify-content:center;font-size:22px;animation:otPulse 1s infinite">üìû</div>'
    + '<div><div style="font-size:14px;font-weight:700;color:var(--text)">Incoming Call</div>'
    + '<div style="font-size:13px;color:var(--muted)">' + callerNum + '</div></div></div>'
    + '<div style="display:flex;gap:10px">'
    + '<button onclick="answerCall()" style="flex:1;padding:10px;background:#10b981;color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">‚úÖ Answer</button>'
    + '<button onclick="rejectCall()" style="flex:1;padding:10px;background:#ef4444;color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit">‚ùå Decline</button>'
    + '</div>';
  document.body.appendChild(banner);
  // Play ring sound
  try {
    var ctx = new (window.AudioContext || window.webkitAudioContext)();
    function ringTone() {
      if (!softphoneRinging) return;
      var osc = ctx.createOscillator(); var gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = 440; gain.gain.setValueAtTime(0.3, ctx.currentTime);
      osc.start(); osc.stop(ctx.currentTime + 0.4);
      setTimeout(function(){ var o2=ctx.createOscillator();var g2=ctx.createGain();o2.connect(g2);g2.connect(ctx.destination);o2.frequency.value=480;g2.gain.setValueAtTime(0.3,ctx.currentTime);o2.start();o2.stop(ctx.currentTime+0.4); }, 500);
      setTimeout(ringTone, 2500);
    }
    ringTone();
  } catch(e) {}
}

function hideIncomingCallBanner() {
  var b = document.getElementById("incomingCallBanner");
  if (b) b.remove();
  var ac = document.getElementById("activeCallBar");
  if (ac) ac.remove();
}

function answerCall() {
  if (!twilioConnection) return;
  twilioConnection.accept();
  softphoneRinging = false;
  var callerNum = (twilioConnection.parameters && twilioConnection.parameters.From) || "Caller";
  hideIncomingCallBanner();
  updateSoftphoneStatus("active");
  showActiveCallBar(callerNum);
  setMyAvailability("busy");
}

function rejectCall() {
  if (!twilioConnection) return;
  twilioConnection.reject();
  softphoneRinging = false;
  hideIncomingCallBanner();
  updateSoftphoneStatus("ready");
}

function hangupCall() {
  if (twilioConnection) { twilioConnection.disconnect(); }
  else if (twilioDevice) { twilioDevice.disconnectAll(); }
  softphoneRinging = false;
  twilioConnection = null;
  hideIncomingCallBanner();
  updateSoftphoneStatus("ready");
  setMyAvailability("available");
}

function showActiveCallBar(callerLabel) {
  var existing = document.getElementById("activeCallBar");
  if (existing) existing.remove();
  var bar = document.createElement("div");
  bar.id = "activeCallBar";
  bar.style.cssText = "position:fixed;bottom:20px;right:20px;z-index:9998;background:var(--surface);border:2px solid #ef4444;border-radius:12px;padding:12px 18px;box-shadow:0 4px 20px rgba(0,0,0,.2);display:flex;align-items:center;gap:12px";
  bar.innerHTML = '<div style="width:10px;height:10px;border-radius:50%;background:#ef4444;animation:otPulse .8s infinite"></div>'
    + '<span style="font-size:12px;font-weight:700;color:var(--text)">On call: ' + callerLabel + '</span>'
    + '<span id="callTimer" style="font-size:11px;color:var(--muted)">0:00</span>'
    + '<button onclick="hangupCall()" style="padding:5px 12px;background:#ef4444;color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">Hang Up</button>';
  document.body.appendChild(bar);
  var secs = 0;
  window._callTimerInterval = setInterval(function(){
    if (!document.getElementById("activeCallBar")) { clearInterval(window._callTimerInterval); return; }
    secs++;
    var m = Math.floor(secs/60); var s = secs%60;
    var el = document.getElementById("callTimer");
    if (el) el.textContent = m + ":" + (s<10?"0":"") + s;
  }, 1000);
}

// Add softphone indicator to sidebar bottom
function renderSoftphoneIndicator() {
  var existing = document.getElementById("softphoneIndicator");
  if (existing) return;
  var sidebar = document.getElementById("sidebar") || document.querySelector(".sidebar");
  if (!sidebar) return;
  var ind = document.createElement("div");
  ind.id = "softphoneIndicator";
  ind.style.cssText = "padding:8px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:11px;color:var(--muted)";
  ind.innerHTML = '<div id="softphoneDot" style="width:8px;height:8px;border-radius:50%;background:#94a3b8;flex-shrink:0"></div><span id="softphoneLabel">Softphone</span>';
  sidebar.appendChild(ind);
}

if(token&&currentUser){showDashboard()}else{showLogin()}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEKLY REPORTS TAB - Service Records
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.loadWeeklyReports = function(clientName) {
  var el = document.getElementById("weeklyReportsContent");
  if (!el) return;
  el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="width:20px;height:20px;border:2px solid var(--border);border-top-color:#7c3aed;border-radius:50%;margin:0 auto 8px"></div>Loading weekly reports...</div>';

  apiCall("GET", "/api/weekly-reports?clientName=" + encodeURIComponent(clientName))
    .then(function(data) {
      var reports = Array.isArray(data) ? data : [];
      var h = '';

      // Header + Generate button
      h += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">';
      h += '<div><div style="font-size:15px;font-weight:700;color:var(--text)">üìä Weekly Reports</div>';
      h += '<div style="font-size:11px;color:var(--muted)">NDIS Stakeholder Reports for ' + (clientName || 'this client') + '</div></div>';
      h += '<button class="btn btn-p" id="wrGenBtn" style="font-size:11px;padding:7px 14px;background:#7c3aed;white-space:nowrap">&#128209; Generate New Report</button>';
      h += '</div>';

      if (reports.length === 0) {
        h += '<div style="text-align:center;padding:40px;color:var(--muted);background:var(--surface);border:1px solid var(--border);border-radius:var(--r)">';
        h += '<div style="font-size:36px;margin-bottom:10px">üìä</div>';
        h += '<div style="font-size:13px;font-weight:600">No weekly reports yet</div>';
        h += '<div style="font-size:11px;margin-top:4px">Click "Generate New Report" to create the first NDIS stakeholder report for this client.</div>';
        h += '</div>';
      } else {
        h += '<div style="display:flex;flex-direction:column;gap:8px">';
        reports.forEach(function(r) {
          var dateStr = r.dateCreated ? new Date(r.dateCreated).toLocaleDateString('en-AU', {day:'2-digit',month:'short',year:'numeric'}) : 'Unknown date';
          var hasPDF = r.pdfUrl ? true : false;
          h += '<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);transition:box-shadow .15s" onmouseover="this.style.boxShadow=\'0 2px 8px rgba(0,0,0,.08)\'" onmouseout="this.style.boxShadow=\'none\'">';
          h += '<div style="width:36px;height:36px;background:rgba(124,58,237,.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">üìä</div>';
          h += '<div style="flex:1;min-width:0">';
          h += '<div style="font-size:13px;font-weight:700;color:var(--text)">' + (r.uniqueRef || 'Report') + '</div>';
          h += '<div style="font-size:11px;color:var(--muted);margin-top:1px">Created ' + dateStr + '</div>';
          h += '</div>';
          if (hasPDF) {
            h += '<a href="' + r.pdfUrl + '" target="_blank" class="btn btn-s" style="font-size:11px;padding:5px 12px;text-decoration:none;display:flex;align-items:center;gap:4px">&#128229; View PDF</a>';
          } else {
            h += '<span style="font-size:10px;color:var(--muted);font-style:italic">No PDF attached</span>';
          }
          h += '</div>';
        });
        h += '</div>';
      }

      el.innerHTML = h;
      // Wire up generate button safely (avoids quote-breaking in onclick attr)
      var genBtn = document.getElementById('wrGenBtn');
      if (genBtn) {
        genBtn.addEventListener('click', function() { generateWeeklyReportForClient(clientName); });
      }
    })
    .catch(function(e) {
      el.innerHTML = '<div style="color:var(--red);font-size:12px;padding:16px">Error loading reports: ' + e.message + '</div>';
    });
};

window.generateWeeklyReportForClient = function(clientName) {
  if (!clientName) return;

  // Navigate to stakeholder report with this client pre-selected
  window._shSelectedClients = [clientName];

  // Show date range picker modal
  var overlay = document.createElement('div');
  overlay.id = 'weeklyRptDateOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };

  var now = new Date();
  var from = new Date(now - 7*86400000);
  var fromStr = from.toISOString().split('T')[0];
  var toStr = now.toISOString().split('T')[0];

  overlay.innerHTML = '<div style="background:var(--surface);border-radius:14px;padding:24px;max-width:400px;width:100%;box-shadow:0 24px 64px rgba(0,0,0,.3)">'
    + '<div style="font-size:15px;font-weight:800;color:var(--text);margin-bottom:4px">&#128209; Generate Report</div>'
    + '<div style="font-size:12px;color:var(--muted);margin-bottom:20px">For: <strong>' + clientName + '</strong></div>'
    + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">'
    + '<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px">From</label>'
    + '<input type="date" id="wrFrom" value="' + fromStr + '" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)"></div>'
    + '<div><label style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:5px">To</label>'
    + '<input type="date" id="wrTo" value="' + toStr + '" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:var(--surface);color:var(--text)"></div>'
    + '</div>'
    + '<div style="display:flex;gap:6px;margin-bottom:16px">'
    + '<button class="btn btn-s" style="font-size:11px;flex:1" onclick="document.getElementById(\'wrFrom\').value=new Date(Date.now()-7*86400000).toISOString().split(\'T\')[0];document.getElementById(\'wrTo\').value=new Date().toISOString().split(\'T\')[0]">Last 7d</button>'
    + '<button class="btn btn-s" style="font-size:11px;flex:1" onclick="document.getElementById(\'wrFrom\').value=new Date(Date.now()-14*86400000).toISOString().split(\'T\')[0];document.getElementById(\'wrTo\').value=new Date().toISOString().split(\'T\')[0]">Last 14d</button>'
    + '<button class="btn btn-s" style="font-size:11px;flex:1" onclick="document.getElementById(\'wrFrom\').value=new Date(Date.now()-30*86400000).toISOString().split(\'T\')[0];document.getElementById(\'wrTo\').value=new Date().toISOString().split(\'T\')[0]">Last 30d</button>'
    + '</div>'
    + '<div style="display:flex;gap:8px">'
    + '<button class="btn btn-s" style="flex:1" onclick="document.getElementById(\'weeklyRptDateOverlay\').remove()">Cancel</button>'
    + '<button class="btn btn-p" id="wrStartBtn" style="flex:2;background:#7c3aed">&#128209; Generate Report</button>'
    + '</div></div>';

  document.body.appendChild(overlay);
  // Wire up start button safely ‚Äî avoids quote-breaking with client names containing special chars
  var startBtn = document.getElementById('wrStartBtn');
  if (startBtn) {
    startBtn.addEventListener('click', function() { startWeeklyReportGen(clientName); });
  }
};

window.startWeeklyReportGen = function(clientName) {
  var from = document.getElementById('wrFrom').value;
  var to = document.getElementById('wrTo').value;
  var overlay = document.getElementById('weeklyRptDateOverlay');
  if (overlay) overlay.remove();
  if (!from || !to) return;

  // Store client ref for after PDF is saved
  window._wrSaveClientName = clientName;
  window._wrSaveFrom = from;
  window._wrSaveTo = to;

  // Set up stakeholder report state
  window._shSelectedClients = [clientName];
  window._shReportFrom = from;
  window._shReportTo = to;

  // Use generateStakeholderReport flow
  var fromEl = document.getElementById('shFrom');
  var toEl = document.getElementById('shTo');
  if (!fromEl) {
    // Not on that page - run directly
    runWeeklyReportFlow(clientName, from, to);
    return;
  }
  fromEl.value = from;
  toEl.value = to;
  generateStakeholderReport();
};

window.runWeeklyReportFlow = function(clientName, from, to) {
  // Full modal flow same as generateStakeholderReport but for single client
  window._shSelectedClients = [clientName];
  window._shReportFrom = from;
  window._shReportTo = to;

  var modal = document.createElement('div');
  modal.id = 'shReportModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:9999;overflow-y:auto;display:flex;flex-direction:column';

  modal.innerHTML = '<div style="position:sticky;top:0;z-index:10;background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;justify-content:space-between;align-items:center">'
    + '<div style="display:flex;align-items:center;gap:10px"><button onclick="closeShModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">&#x2715;</button>'
    + '<div style="font-size:15px;font-weight:800;color:var(--text)">NDIS Stakeholder Report</div></div>'
    + '<div style="display:flex;gap:8px"><button class="btn btn-s" style="font-size:11px" onclick="minimiseShModal()" title="Minimise">&#8212; Minimise</button><button id="shPdfBtn" class="btn btn-p" style="font-size:11px;padding:6px 14px;background:var(--royal)" onclick="downloadShPDF()">&#128229; Generate PDF</button>'
    + '<button class="btn btn-s" style="font-size:11px" onclick="printShReport()">&#128424; Print</button></div></div>'
    + '<div style="flex:1;padding:24px;display:flex;justify-content:center">'
    + '<div id="shProgressArea" style="max-width:520px;width:100%;text-align:center;padding:48px 20px">'
    + '<div style="font-size:48px;margin-bottom:16px">&#128209;</div>'
    + '<div style="font-size:17px;font-weight:800;color:var(--text);margin-bottom:6px">Generating NDIS Report</div>'
    + '<div id="shProgressStatus" style="font-size:13px;color:var(--muted);margin-bottom:20px">Starting...</div>'
    + '<div style="background:var(--border);border-radius:10px;height:16px;overflow:hidden;margin-bottom:8px">'
    + '<div id="shProgressBar" style="height:100%;background:linear-gradient(90deg,#7c3aed,#6366f1);border-radius:10px;width:0%;transition:width .5s ease"></div></div>'
    + '<div id="shProgressCount" style="font-size:12px;color:var(--muted)">Generating report for ' + clientName + '</div>'
    + '</div></div>';

  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';

  var headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = 'Bearer ' + token;

  var bar = function(pct, msg) {
    var b = document.getElementById('shProgressBar');
    var s = document.getElementById('shProgressStatus');
    if (b) b.style.width = pct + '%';
    if (s) s.textContent = msg;
  };

  bar(20, 'Fetching service records...');
  fetch('/api/stakeholder-report', { method: 'POST', headers: headers, body: JSON.stringify({ from: from, to: to, clients: [clientName] }) })
    .then(function(r) { if (!r.ok) throw new Error('Server error ' + r.status); return r.json(); })
    .then(function(data) {
      bar(80, 'Building report...');
      setTimeout(function() {
        renderStakeholderResults(data, from, to);
        // Wait for charts to render (renderShCharts uses setTimeout internally)
        // Poll until charts are drawn or max 5s
        var pollStart = Date.now();
        var pollTimer = setInterval(function() {
          var elapsed = Date.now() - pollStart;
          var chartCount = Object.keys(window._shCharts || {}).length;
          if (chartCount > 0 || elapsed > 4000) {
            clearInterval(pollTimer);
            console.log('Charts ready (' + chartCount + ' rendered), starting PDF');
            downloadShPDF();
          }
        }, 300);
        // Hard fallback after 5s regardless
        setTimeout(function() { clearInterval(pollTimer); downloadShPDF(); }, 5000);
      }, 300);
    })
    .catch(function(e) {
      bar(0, '');
      var c = modal.querySelector('div:last-child');
      if (c) c.innerHTML = '<div style="text-align:center;padding:40px"><div style="font-size:40px;margin-bottom:12px">&#9888;&#65039;</div>'
        + '<div style="color:var(--red);font-size:14px;font-weight:600">' + e.message + '</div>'
        + '<button class="btn btn-s" style="margin-top:16px" onclick="closeShModal()">Close</button></div>';
    });
};

// ‚ïê‚ïê‚ïê COMPANY FILES MODULE ‚ïê‚ïê‚ïê
var _companyFiles = [];
var _filesCategory = "All";
var _filesStatus = "Active";
var _filesSearch = "";

function renderCompanyFiles() {
  var rp = document.getElementById("rightPanel");
  rp.innerHTML = '<div style="padding:24px;max-width:1200px;margin:0 auto">' +
    '<div style="display:flex;align-items:center;gap:14px;margin-bottom:24px">' +
      '<div style="width:48px;height:48px;background:linear-gradient(135deg,#d97706,#b45309);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üìÅ</div>' +
      '<div><div style="font-size:22px;font-weight:800;color:var(--text)">Company Files</div>' +
      '<div style="font-size:13px;color:var(--muted)">Documents and files from Airtable</div></div>' +
    '</div>' +
    '<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:center">' +
      '<div style="display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:3px;flex-wrap:wrap" id="filesCatTabs"></div>' +
      '<div style="display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:3px" id="filesStatusTabs"></div>' +
      '<input type="text" id="filesSearchInput" placeholder="Search files..." style="flex:1;min-width:180px;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);font-size:13px;font-family:inherit;outline:none">' +
    '</div>' +
    '<div id="filesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px"></div>' +
    '<div id="filesLoading" style="text-align:center;padding:40px;color:var(--muted)"><div class="spinner" style="margin:0 auto 10px"></div>Loading files...</div>' +
  '</div>';
  var cats = ["All","Company Details","HR","Insurances","Marketing","Operations","Recruitment"];
  var catHtml = "";
  cats.forEach(function(c) {
    var on = c === _filesCategory;
    catHtml += '<button onclick="_filesCategory=\'' + c + '\';loadCompanyFiles()" style="padding:6px 12px;border:none;border-radius:6px;font-size:11px;font-weight:' + (on ? '700' : '500') + ';cursor:pointer;font-family:inherit;background:' + (on ? 'var(--royal)' : 'transparent') + ';color:' + (on ? '#fff' : 'var(--muted)') + '">' + c + '</button>';
  });
  document.getElementById("filesCatTabs").innerHTML = catHtml;
  var statuses = ["Active","Archive","All"];
  var stHtml = "";
  statuses.forEach(function(s) {
    var on = s === _filesStatus;
    stHtml += '<button onclick="_filesStatus=\'' + s + '\';loadCompanyFiles()" style="padding:6px 12px;border:none;border-radius:6px;font-size:11px;font-weight:' + (on ? '700' : '500') + ';cursor:pointer;font-family:inherit;background:' + (on ? (s === 'Active' ? 'var(--ok)' : s === 'Archive' ? '#6b7280' : 'var(--royal)') : 'transparent') + ';color:' + (on ? '#fff' : 'var(--muted)') + '">' + s + '</button>';
  });
  document.getElementById("filesStatusTabs").innerHTML = stHtml;
  var si = document.getElementById("filesSearchInput");
  si.value = _filesSearch;
  si.addEventListener("input", function() {
    _filesSearch = this.value;
    clearTimeout(window._filesSearchTimer);
    window._filesSearchTimer = setTimeout(function() { renderFilesGrid(); }, 300);
  });
  loadCompanyFiles();
}

function loadCompanyFiles() {
  var grid = document.getElementById("filesGrid");
  var loading = document.getElementById("filesLoading");
  if (grid) grid.innerHTML = "";
  if (loading) loading.style.display = "block";
  var params = "?status=" + encodeURIComponent(_filesStatus === "All" ? "All" : _filesStatus);
  if (_filesCategory !== "All") params += "&category=" + encodeURIComponent(_filesCategory);
  fetch("/api/company-files" + params, { headers: { "Authorization": "Bearer " + localStorage.getItem("token") } })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (loading) loading.style.display = "none";
      if (data.error) {
        if (grid) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--error)">‚ùå ' + data.error + '</div>';
        return;
      }
      _companyFiles = data.files || [];
      renderFilesGrid();
    }).catch(function(e) {
      if (loading) loading.style.display = "none";
      if (grid) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--error)">‚ùå ' + e.message + '</div>';
    });
}

function renderFilesGrid() {
  var grid = document.getElementById("filesGrid");
  if (!grid) return;
  var files = _companyFiles;
  if (_filesSearch) {
    var q = _filesSearch.toLowerCase();
    files = files.filter(function(f) {
      return (f.name || "").toLowerCase().indexOf(q) >= 0 ||
             (f.description || "").toLowerCase().indexOf(q) >= 0 ||
             (f.fileName || "").toLowerCase().indexOf(q) >= 0;
    });
  }
  if (files.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px 20px">' +
      '<div style="font-size:48px;margin-bottom:12px">üì≠</div>' +
      '<div style="font-size:15px;font-weight:600;color:var(--text)">No files found</div>' +
      '<div style="font-size:13px;color:var(--muted);margin-top:4px">Try a different category or search term</div></div>';
    return;
  }
  var html = "";
  files.forEach(function(f) {
    var ext = (f.fileName || "").split(".").pop().toLowerCase();
    var icon = ext === "pdf" ? "üìÑ" : ext === "docx" || ext === "doc" ? "üìù" : ext === "xlsx" || ext === "xls" || ext === "csv" ? "üìä" : ext === "jpg" || ext === "jpeg" || ext === "png" || ext === "gif" ? "üñºÔ∏è" : ext === "mp4" || ext === "mov" ? "üé¨" : "üìé";
    var catColor = f.category === "Company Details" ? "#2454A0" : f.category === "HR" ? "#7c3aed" : f.category === "Insurances" ? "#d97706" : f.category === "Marketing" ? "#059669" : f.category === "Operations" ? "#0891b2" : f.category === "Recruitment" ? "#be185d" : "#6b7280";
    var statusBg = f.status === "Active" ? "rgba(16,185,129,.1)" : "rgba(107,114,128,.1)";
    var statusColor = f.status === "Active" ? "var(--ok)" : "#6b7280";
    var modDate = f.lastModified || "";
    var viewers = f.viewableBy || "";
    html += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;transition:all .15s;cursor:pointer" onmouseover="this.style.borderColor=\'var(--royal)\';this.style.transform=\'translateY(-1px)\'" onmouseout="this.style.borderColor=\'var(--border)\';this.style.transform=\'none\'">' +
      '<div style="display:flex;align-items:flex-start;gap:12px">' +
        '<div style="width:42px;height:42px;background:var(--surface2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">' + icon + '</div>' +
        '<div style="flex:1;min-width:0">' +
          '<div style="font-size:14px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="' + (f.name || "").replace(/"/g, '&quot;') + '">' + (f.name || "Untitled") + '</div>' +
          '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">' +
            '<span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;background:' + catColor + '22;color:' + catColor + '">' + (f.category || "‚Äî") + '</span>' +
            '<span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px;background:' + statusBg + ';color:' + statusColor + '">' + (f.status || "‚Äî") + '</span>' +
          '</div>' +
          (f.description ? '<div style="font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">' + f.description + '</div>' : '') +
          '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:11px;color:var(--muted)">' +
            (f.fileName ? '<span title="' + f.fileName.replace(/"/g, '&quot;') + '">üìé ' + (f.fileName.length > 25 ? f.fileName.substring(0, 22) + '...' : f.fileName) + '</span>' : '') +
            (modDate ? '<span>üïê ' + modDate + '</span>' : '') +
            (f.lastModifiedBy ? '<span>üë§ ' + f.lastModifiedBy + '</span>' : '') +
          '</div>' +
          (viewers ? '<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">' + viewers.split(",").map(function(v) { return '<span style="font-size:9px;padding:1px 6px;border-radius:3px;background:var(--surface2);color:var(--muted)">' + v.trim() + '</span>'; }).join("") + '</div>' : '') +
        '</div>' +
      '</div>' +
      (f.fileUrl ? '<div style="margin-top:12px;border-top:1px solid var(--border);padding-top:10px;text-align:right"><a href="' + f.fileUrl + '" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--royal);color:#fff;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none" onclick="event.stopPropagation()">‚¨á Download</a></div>' : '') +
    '</div>';
  });
  grid.innerHTML = html;
}

</script>
</body>
</html>
