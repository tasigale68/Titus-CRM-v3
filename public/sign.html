<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sign Document — Delta Community Support</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✍️</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f0f4f8;color:#1a202c;min-height:100vh}
.header{color:#fff;padding:16px 24px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.header h1{font-size:18px;font-weight:700;letter-spacing:-.3px}
.header .sub{font-size:11px;opacity:.7}
.container{max-width:800px;margin:24px auto;padding:0 16px}
.card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);overflow:hidden;margin-bottom:20px}
.card-header{padding:16px 20px;border-bottom:1px solid #e8ecf1;display:flex;align-items:center;gap:10px}
.card-body{padding:20px}
.badge{font-size:10px;font-weight:700;padding:3px 10px;border-radius:6px;text-transform:uppercase;letter-spacing:.5px}
.badge-sent{background:#FEF3C7;color:#D97706}
.badge-signed{background:#D1FAE5;color:#059669}
.info-row{display:flex;gap:20px;margin-bottom:12px;flex-wrap:wrap}
.info-item{flex:1;min-width:180px}
.info-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#64748b;margin-bottom:2px}
.info-value{font-size:14px;font-weight:600;color:#1a202c}
.doc-preview{padding:16px;background:#f8fafc;border:2px dashed #d1d5db;border-radius:8px;text-align:center;margin-bottom:16px}
.doc-preview a{color:#0A9396;font-weight:700;text-decoration:none;font-size:14px}
.doc-preview a:hover{text-decoration:underline}
.sig-section{margin-top:16px}
.sig-label{font-size:12px;font-weight:700;color:#475569;margin-bottom:8px}
.sig-canvas-wrap{border:2px solid #d1d5db;border-radius:8px;background:#fff;position:relative;touch-action:none}
canvas{display:block;width:100%;cursor:crosshair}
.sig-actions{display:flex;gap:8px;margin-top:10px}
.btn{padding:10px 24px;border:none;border-radius:8px;font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-clear{background:#f1f5f9;color:#64748b;border:1px solid #d1d5db}
.btn-clear:hover{background:#e2e8f0}
.btn-sign{background:linear-gradient(135deg,#0A9396,#0E9AA7);color:#fff;flex:1}
.btn-sign:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(10,147,150,.3)}
.btn-sign:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.signed-msg{text-align:center;padding:40px 20px}
.signed-msg .icon{font-size:48px;margin-bottom:12px}
.signed-msg h2{color:#059669;font-size:20px;margin-bottom:8px}
.signed-msg p{color:#64748b;font-size:14px}
.status-msg{margin-top:12px;padding:10px;border-radius:6px;font-size:13px;font-weight:600;text-align:center}
.checkbox-row{display:flex;align-items:flex-start;gap:10px;margin:16px 0;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e8ecf1}
.checkbox-row input{margin-top:2px;width:18px;height:18px;accent-color:#0A9396}
.checkbox-row label{font-size:12px;color:#475569;line-height:1.5}
.footer{text-align:center;padding:20px;color:#94a3b8;font-size:11px}
.role-desc{padding:10px 14px;margin-bottom:12px;border-radius:8px;font-size:12px;color:#475569}
.steps-bar{display:flex;gap:4px;align-items:center}
.step-chip{font-size:9px;font-weight:700;padding:4px 8px;border-radius:4px;color:#fff}
.step-arrow{color:rgba(255,255,255,.4);font-size:10px}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;gap:16px}
.loading .spinner{width:40px;height:40px;border:4px solid #e2e8f0;border-top-color:#0A9396;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error-state{text-align:center;padding:60px 20px}
.error-state .icon{font-size:48px;margin-bottom:12px}
.error-state h2{color:#DC2626;font-size:20px;margin-bottom:8px}
.error-state p{color:#64748b;font-size:14px}
@media(max-width:600px){.container{padding:0 8px;margin-top:12px}.card-body{padding:14px}.info-row{flex-direction:column;gap:8px}}
</style>
</head>
<body>
<div id="headerEl" class="header" style="background:linear-gradient(135deg,#1e3a5f,#1e3a5fcc)">
  <div style="flex:1">
    <h1 id="headerTitle">Document Signing Portal</h1>
    <div class="sub">Delta Community Support · Document Signing Portal</div>
  </div>
  <div id="stepsBar" class="steps-bar" style="display:none"></div>
</div>

<div class="container">
  <div id="roleDescEl" class="role-desc" style="display:none"></div>
</div>

<div class="container" id="mainContent">
  <div class="loading">
    <div class="spinner"></div>
    <div style="color:#64748b;font-size:14px">Loading document...</div>
  </div>
</div>

<div class="footer">Delta Community Support · NDIS Registered Provider<br>This is a secure document signing portal. Your signature and IP address are recorded for verification.</div>

<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  var token = params.get("token");
  if (!token || token.length < 10) {
    showError("Invalid Signing Link", "This signing link appears to be invalid or malformed. Please check the link and try again.");
    return;
  }

  fetch("/api/doc-signing/details/" + encodeURIComponent(token))
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) { showError("Document Not Found", data.error); return; }
      renderPage(data);
    })
    .catch(function(err) {
      showError("Connection Error", "Unable to load the signing page. Please check your internet connection and try again.");
    });

  function showError(title, message) {
    document.getElementById("mainContent").innerHTML =
      '<div class="card"><div class="card-body"><div class="error-state">' +
      '<div class="icon">⚠️</div><h2>' + escapeHtml(title) + '</h2><p>' + escapeHtml(message) + '</p></div></div></div>';
  }

  function escapeHtml(str) {
    var div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function renderPage(data) {
    var signerRole = data.signerRole || "participant";
    var signerConfig = data.signerConfig || {};
    var alreadySigned = data.status === "Signed";

    // Role-specific colors and labels
    var roleColor = signerRole === "nominee" ? "#7C3AED" : signerRole === "provider" ? "#059669" : "#1e3a5f";
    var roleLabel = signerRole === "nominee" ? "Nominee / Guardian Signature" : signerRole === "provider" ? "Provider Counter-Signature" : "Participant Signature";
    var roleIcon = signerRole === "nominee" ? "\uD83D\uDEE1\uFE0F" : signerRole === "provider" ? "\u2705" : "\u270D\uFE0F";
    var roleDesc = signerRole === "nominee"
      ? "You are signing as the legal representative / nominee for the participant named below."
      : signerRole === "provider"
        ? "You are counter-signing this agreement as an authorised DCS representative."
        : "You are signing this document as the NDIS participant.";

    // Update header
    var headerEl = document.getElementById("headerEl");
    headerEl.style.background = "linear-gradient(135deg," + roleColor + "," + roleColor + "cc)";
    document.getElementById("headerTitle").textContent = roleIcon + " " + roleLabel;

    // Steps bar
    var steps = ["\u0031\uFE0F\u20E3 Participant"];
    if (signerConfig.nomineeRequired) steps.push("\u0032\uFE0F\u20E3 Nominee/Guardian");
    if (signerConfig.providerCountersign !== false) steps.push("\u2705 DCS Provider");
    var currentStep = signerRole === "nominee" ? 1 : signerRole === "provider" ? steps.length - 1 : 0;

    if (steps.length > 1) {
      var stepsBar = document.getElementById("stepsBar");
      stepsBar.style.display = "flex";
      var stepsHtml = "";
      for (var i = 0; i < steps.length; i++) {
        if (i > 0) stepsHtml += '<span class="step-arrow">\u2192</span>';
        stepsHtml += '<span class="step-chip" style="background:' + (i === currentStep ? "rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.4)" : "rgba(0,0,0,.2)") + '">' + steps[i] + '</span>';
      }
      stepsBar.innerHTML = stepsHtml;
    }

    // Role description
    var roleDescEl = document.getElementById("roleDescEl");
    var descBg = signerRole === "nominee" ? "rgba(124,58,237,.08)" : signerRole === "provider" ? "rgba(16,185,129,.08)" : "rgba(30,75,160,.08)";
    var descBorder = signerRole === "nominee" ? "rgba(124,58,237,.2)" : signerRole === "provider" ? "rgba(16,185,129,.2)" : "rgba(30,75,160,.2)";
    roleDescEl.style.display = "block";
    roleDescEl.style.background = descBg;
    roleDescEl.style.border = "1px solid " + descBorder;
    roleDescEl.textContent = roleDesc;

    // Main content
    var content = document.getElementById("mainContent");
    if (alreadySigned) {
      var nextStep = "";
      if (signerConfig.nomineeRequired && signerRole === "participant") {
        nextStep = '<p style="margin-top:12px;font-size:13px;color:#7C3AED;font-weight:600">\uD83D\uDCCB Next Step: The Nominee/Guardian signature is also required. A link has been sent to them separately.</p>';
      } else if (signerConfig.providerCountersign !== false && (signerRole === "nominee" || (!signerConfig.nomineeRequired && signerRole === "participant"))) {
        nextStep = '<p style="margin-top:12px;font-size:13px;color:#059669;font-weight:600">\u2705 Next Step: Awaiting DCS Provider counter-signature.</p>';
      }
      content.innerHTML = '<div class="card"><div class="card-body"><div class="signed-msg">' +
        '<div class="icon">\u2705</div><h2>Document Already Signed</h2>' +
        '<p>This document was signed on ' + escapeHtml(data.signedDate || "a previous date") + '.</p>' +
        nextStep + '</div></div></div>';
      return;
    }

    // Signing form
    var fileSection = "";
    if (data.fileUrl) {
      fileSection = '<div class="doc-preview"><div style="font-size:32px;margin-bottom:8px">\uD83D\uDCCB</div>' +
        '<a href="' + escapeHtml(data.fileUrl) + '" target="_blank">\uD83D\uDCCE View & Download Document: ' + escapeHtml(data.fileName || "Open Document") + '</a>' +
        '<div style="font-size:11px;color:#94a3b8;margin-top:8px">Please review the document above before signing below</div></div>';
    } else {
      fileSection = '<div class="doc-preview"><div style="font-size:32px;margin-bottom:8px">\uD83D\uDCCB</div>' +
        '<div style="font-size:13px;color:#64748b">Document template will be provided. Please sign below to confirm.</div></div>';
    }

    content.innerHTML =
      '<div class="card">' +
        '<div class="card-header">' +
          '<span style="font-size:20px">\uD83D\uDCC4</span>' +
          '<div style="flex:1"><div style="font-size:14px;font-weight:700">' + escapeHtml(data.docType || "Document") + '</div>' +
          '<div style="font-size:11px;color:#64748b">' + escapeHtml(data.templateName || "") + '</div></div>' +
          '<span class="badge badge-sent">Awaiting Signature</span>' +
        '</div>' +
        '<div class="card-body">' +
          '<div class="info-row">' +
            '<div class="info-item"><div class="info-label">Recipient</div><div class="info-value">' + escapeHtml(data.recipientName || "") + '</div></div>' +
            '<div class="info-item"><div class="info-label">Document Type</div><div class="info-value">' + escapeHtml(data.docType || "Document") + '</div></div>' +
          '</div>' +
          fileSection +
          '<div class="sig-section">' +
            '<div class="sig-label">Draw your signature below:</div>' +
            '<div class="sig-canvas-wrap"><canvas id="sigCanvas" width="760" height="200"></canvas></div>' +
            '<div class="checkbox-row">' +
              '<input type="checkbox" id="agreeCheck">' +
              '<label for="agreeCheck">I, <strong>' + escapeHtml(data.recipientName || "the undersigned") + '</strong>, confirm that I have read and understood the document above and agree to its terms. I understand that this digital signature is legally binding.</label>' +
            '</div>' +
            '<div class="sig-actions">' +
              '<button class="btn btn-clear" id="clearBtn">Clear</button>' +
              '<button class="btn btn-sign" id="signBtn" disabled>\u270D\uFE0F Sign Document</button>' +
            '</div>' +
            '<div id="statusMsg"></div>' +
          '</div>' +
        '</div>' +
      '</div>';

    // Initialize canvas
    var canvas = document.getElementById("sigCanvas");
    if (!canvas) return;
    var ctx = canvas.getContext("2d");
    var rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * 2;
    canvas.height = rect.height * 2;
    ctx.scale(2, 2);
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.lineWidth = 2.5;
    ctx.strokeStyle = "#1a202c";

    var drawing = false;
    var hasDrawn = false;

    function getPos(e) {
      var r = canvas.getBoundingClientRect();
      var t = e.touches ? e.touches[0] : e;
      return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    canvas.addEventListener("mousedown", function(e) {
      drawing = true;
      var p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    });
    canvas.addEventListener("mousemove", function(e) {
      if (!drawing) return;
      hasDrawn = true;
      var p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      checkSign();
    });
    canvas.addEventListener("mouseup", function() { drawing = false; });
    canvas.addEventListener("mouseleave", function() { drawing = false; });
    canvas.addEventListener("touchstart", function(e) {
      e.preventDefault();
      drawing = true;
      var p = getPos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }, { passive: false });
    canvas.addEventListener("touchmove", function(e) {
      e.preventDefault();
      if (!drawing) return;
      hasDrawn = true;
      var p = getPos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      checkSign();
    }, { passive: false });
    canvas.addEventListener("touchend", function() { drawing = false; });

    function checkSign() {
      var btn = document.getElementById("signBtn");
      var chk = document.getElementById("agreeCheck");
      if (btn) btn.disabled = !(hasDrawn && chk && chk.checked);
    }

    document.getElementById("agreeCheck").addEventListener("change", checkSign);

    document.getElementById("clearBtn").addEventListener("click", function() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      hasDrawn = false;
      checkSign();
    });

    document.getElementById("signBtn").addEventListener("click", function() {
      var btn = document.getElementById("signBtn");
      var st = document.getElementById("statusMsg");
      if (!hasDrawn) {
        if (st) st.innerHTML = '<div class="status-msg" style="background:#FEF2F2;color:#DC2626">Please draw your signature above</div>';
        return;
      }
      if (btn) { btn.disabled = true; btn.textContent = "Submitting..."; }
      var sigData = canvas.toDataURL("image/png");
      fetch("/api/doc-signing/sign/" + encodeURIComponent(data.token), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ signature: sigData })
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.error) {
          if (st) st.innerHTML = '<div class="status-msg" style="background:#FEF2F2;color:#DC2626">' + escapeHtml(d.error) + '</div>';
          if (btn) { btn.disabled = false; btn.textContent = "\u270D\uFE0F Sign Document"; }
          return;
        }
        if (st) st.innerHTML = '<div class="status-msg" style="background:#D1FAE5;color:#059669">\u2705 Document signed successfully! Thank you.</div>';
        if (btn) { btn.textContent = "\u2705 Signed"; btn.style.background = "#059669"; }
      })
      .catch(function(err) {
        if (st) st.innerHTML = '<div class="status-msg" style="background:#FEF2F2;color:#DC2626">Error: ' + escapeHtml(err.message) + '</div>';
        if (btn) { btn.disabled = false; btn.textContent = "\u270D\uFE0F Sign Document"; }
      });
    });
  }
})();
</script>
</body>
</html>
