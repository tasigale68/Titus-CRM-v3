<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Stakeholder Portal - Titus CRM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%230d9488'/><circle cx='50' cy='38' r='16' stroke='white' stroke-width='6' fill='none'/><path d='M20 82c0-16.57 13.43-30 30-30s30 13.43 30 30' stroke='white' stroke-width='6' fill='none' stroke-linecap='round'/></svg>">
<style>
:root {
  --teal: #0d9488;
  --teal-light: #14b8a6;
  --teal-dark: #0f766e;
  --teal-bg: #f0fdfa;
  --navy: #0f172a;
  --navy-light: #1e293b;
  --navy-mid: #334155;
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #0f172a;
  --text-secondary: #64748b;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --green: #059669;
  --green-bg: #d1fae5;
  --amber: #d97706;
  --amber-bg: #fef3c7;
  --red: #dc2626;
  --red-bg: #fee2e2;
  --blue: #2563eb;
  --blue-bg: #dbeafe;
  --radius: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,.06), 0 4px 16px rgba(0,0,0,.04);
  --shadow-lg: 0 4px 24px rgba(0,0,0,.08);
  --sidebar-w: 260px;
  --transition: 200ms ease;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* ===== AUTH SCREEN ===== */
.auth-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
}
.auth-card {
  background: var(--card);
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  max-width: 420px;
  width: 100%;
  overflow: hidden;
  animation: fadeUp 0.3s ease-out;
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.auth-card-header {
  background: var(--card);
  padding: 36px 32px 24px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}
.auth-logo {
  width: 56px;
  height: 56px;
  background: var(--teal);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
}
.auth-logo svg { width: 28px; height: 28px; }
.auth-card-header h2 {
  font-size: 22px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.5px;
}
.auth-powered {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
  padding: 4px 12px;
  background: var(--border-light);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
}
.auth-powered svg { width: 12px; height: 12px; color: var(--teal); }
.auth-card-body { padding: 28px 32px 32px; }
.auth-error {
  background: var(--red-bg);
  color: var(--red);
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 16px;
  display: none;
}
.form-group { margin-bottom: 14px; }
.form-label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--navy-light);
  margin-bottom: 6px;
}
.form-input {
  width: 100%;
  padding: 11px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  font-family: inherit;
  color: var(--text);
  background: #fff;
  transition: border-color var(--transition);
}
.form-input:focus {
  outline: none;
  border-color: var(--teal);
}
.btn {
  padding: 11px 20px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.btn svg { width: 16px; height: 16px; flex-shrink: 0; }
.btn-primary {
  background: var(--teal);
  color: #fff;
  width: 100%;
}
.btn-primary:hover {
  background: var(--teal-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(13,148,136,.3);
}
.btn-primary:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
.btn-outline {
  background: #fff;
  border: 2px solid var(--border);
  color: var(--text-secondary);
}
.btn-outline:hover { border-color: var(--teal); color: var(--teal); }
.btn-sm { padding: 7px 14px; font-size: 12px; }
.btn-sm svg { width: 14px; height: 14px; }
.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  padding: 8px;
  border-radius: 8px;
}
.btn-ghost:hover { background: rgba(255,255,255,.1); color: #fff; }
.btn-icon {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  color: var(--text-secondary);
  transition: all var(--transition);
}
.btn-icon:hover { background: var(--border-light); color: var(--teal); }
.btn-icon svg { width: 18px; height: 18px; }

/* ===== CHANGE PASSWORD ===== */
.change-pw-notice {
  background: var(--amber-bg);
  color: var(--amber);
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}
.change-pw-notice svg { width: 16px; height: 16px; flex-shrink: 0; }

/* ===== DASHBOARD LAYOUT ===== */
.app-layout { display: flex; min-height: 100vh; }

/* Sidebar */
.sidebar {
  width: var(--sidebar-w);
  background: var(--navy);
  color: #fff;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  z-index: 100;
  transition: transform 0.25s ease;
}
.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.sidebar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}
.sidebar-brand-icon {
  width: 36px;
  height: 36px;
  background: var(--teal);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.sidebar-brand-icon svg { width: 18px; height: 18px; }
.sidebar-brand-text h3 {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: -0.3px;
}
.sidebar-brand-text p {
  font-size: 10px;
  color: rgba(255,255,255,.4);
}
.sidebar-user {
  background: rgba(255,255,255,.06);
  border-radius: 10px;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.sidebar-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--teal);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  flex-shrink: 0;
}
.sidebar-user-info h4 { font-size: 13px; font-weight: 600; }
.sidebar-user-info p { font-size: 10px; color: rgba(255,255,255,.5); }

.sidebar-nav {
  flex: 1;
  padding: 12px 8px;
  overflow-y: auto;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255,255,255,.55);
  cursor: pointer;
  transition: all 150ms ease;
  text-decoration: none;
  position: relative;
}
.nav-item:hover {
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.85);
}
.nav-item.active {
  background: rgba(13,148,136,.2);
  color: #fff;
}
.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 6px;
  bottom: 6px;
  width: 3px;
  background: var(--teal);
  border-radius: 0 3px 3px 0;
}
.nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
.nav-badge {
  margin-left: auto;
  background: var(--teal);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
}

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid rgba(255,255,255,.08);
}
.logout-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.45);
  font-size: 13px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 150ms;
}
.logout-btn:hover {
  background: rgba(220,38,38,.15);
  color: #f87171;
}
.logout-btn svg { width: 18px; height: 18px; }

/* Main content */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-w);
  min-height: 100vh;
}
.main-header {
  background: var(--card);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 50;
}
.mobile-menu-btn {
  display: none;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  color: var(--text);
  transition: background var(--transition);
}
.mobile-menu-btn:hover { background: var(--border-light); }
.mobile-menu-btn svg { width: 22px; height: 22px; }
.main-header h1 {
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.3px;
  flex: 1;
}
.main-header-actions { display: flex; gap: 8px; }
.main-body { padding: 24px; }

/* Overlay for mobile */
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,.5);
  z-index: 99;
}

/* ===== CARDS ===== */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.card + .card { margin-top: 16px; }
.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-header-icon {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.card-header-icon svg { width: 16px; height: 16px; }
.card-header h3 { font-size: 14px; font-weight: 700; flex: 1; }
.card-body { padding: 18px; }

/* Stat cards grid */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.stat-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 18px;
  display: flex;
  align-items: flex-start;
  gap: 14px;
}
.stat-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.stat-icon svg { width: 20px; height: 20px; }
.stat-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.stat-value {
  font-size: 24px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.5px;
  line-height: 1.2;
}
.stat-sub {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.badge-green { background: var(--green-bg); color: var(--green); }
.badge-amber { background: var(--amber-bg); color: var(--amber); }
.badge-red { background: var(--red-bg); color: var(--red); }
.badge-blue { background: var(--blue-bg); color: var(--blue); }
.badge-gray { background: var(--border-light); color: var(--text-secondary); }

/* Data list */
.data-list { list-style: none; }
.data-list-item {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-light);
  cursor: pointer;
  transition: background 150ms;
}
.data-list-item:last-child { border-bottom: none; }
.data-list-item:hover { background: var(--border-light); }
.data-list-item-header {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.data-list-item-title {
  font-size: 13px;
  font-weight: 700;
  flex: 1;
}
.data-list-item-meta {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
}
.data-list-item-body {
  display: none;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
  font-size: 13px;
  line-height: 1.7;
  color: var(--navy-mid);
}
.data-list-item.expanded .data-list-item-body { display: block; }
.expand-icon {
  transition: transform 200ms;
}
.data-list-item.expanded .expand-icon { transform: rotate(180deg); }

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.data-table th {
  text-align: left;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  padding: 10px 14px;
  border-bottom: 2px solid var(--border);
}
.data-table td {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border-light);
  vertical-align: middle;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: var(--border-light); }

/* Calendar grid */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}
.cal-header {
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-secondary);
  padding: 8px 0;
}
.cal-day {
  min-height: 80px;
  padding: 6px;
  border: 1px solid var(--border-light);
  border-radius: 6px;
  font-size: 11px;
}
.cal-day-num {
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 4px;
}
.cal-day.today .cal-day-num {
  background: var(--teal);
  color: #fff;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
.cal-event {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 4px;
  border-radius: 3px;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cal-event-active { background: var(--teal-bg); color: var(--teal); }
.cal-event-cancelled { background: var(--red-bg); color: var(--red); text-decoration: line-through; }

/* Schedule list (mobile-friendly) */
.schedule-list {}
.schedule-item {
  display: flex;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-light);
  align-items: flex-start;
}
.schedule-item:last-child { border-bottom: none; }
.schedule-date {
  width: 48px;
  text-align: center;
  flex-shrink: 0;
}
.schedule-date-day {
  font-size: 20px;
  font-weight: 800;
  color: var(--text);
  line-height: 1;
}
.schedule-date-month {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-secondary);
}
.schedule-info { flex: 1; }
.schedule-info-title {
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 2px;
}
.schedule-info-time {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}
.schedule-info-time svg { width: 12px; height: 12px; }
.schedule-item.cancelled .schedule-info-title {
  text-decoration: line-through;
  color: var(--red);
}

/* Goals */
.goal-item {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-light);
}
.goal-item:last-child { border-bottom: none; }
.goal-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.goal-title { font-size: 13px; font-weight: 700; flex: 1; }
.goal-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }
.goal-meta { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }

/* Messages */
.messages-wrap {
  display: flex;
  flex-direction: column;
  height: 500px;
}
.messages-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.msg-bubble {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.5;
}
.msg-bubble.sent {
  background: var(--teal);
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.msg-bubble.received {
  background: var(--border-light);
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.msg-meta {
  font-size: 10px;
  color: var(--text-secondary);
  margin-top: 4px;
}
.msg-bubble.sent .msg-meta { color: rgba(255,255,255,.7); }
.messages-input {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  background: var(--card);
}
.messages-input input {
  flex: 1;
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 13px;
  font-family: inherit;
  transition: border-color var(--transition);
}
.messages-input input:focus { outline: none; border-color: var(--teal); }
.msg-send-btn {
  padding: 10px 18px;
  background: var(--teal);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  transition: background var(--transition);
  display: flex;
  align-items: center;
  gap: 6px;
}
.msg-send-btn:hover { background: var(--teal-dark); }
.msg-send-btn svg { width: 16px; height: 16px; }

/* Activity list */
.activity-item {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border-light);
  align-items: flex-start;
}
.activity-item:last-child { border-bottom: none; }
.activity-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-top: 5px;
  flex-shrink: 0;
}
.activity-text { font-size: 13px; flex: 1; }
.activity-time { font-size: 11px; color: var(--text-secondary); white-space: nowrap; }

/* Empty state */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-secondary);
}
.empty-state-icon {
  width: 48px;
  height: 48px;
  background: var(--border-light);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 12px;
}
.empty-state-icon svg { width: 24px; height: 24px; color: var(--text-secondary); }
.empty-state h3 { font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
.empty-state p { font-size: 13px; }

/* Loading spinner */
.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--teal);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.tab-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 48px;
}

/* Unread dot */
.unread-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--teal);
  display: inline-block;
  margin-left: 6px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.open {
    transform: translateX(0);
  }
  .sidebar-overlay.show {
    display: block;
  }
  .main-content {
    margin-left: 0;
  }
  .mobile-menu-btn {
    display: flex;
  }
  .main-body {
    padding: 16px;
  }
  .stat-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .calendar-grid {
    display: none;
  }
  .messages-wrap {
    height: 400px;
  }
}
@media (max-width: 480px) {
  .stat-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen" class="auth-screen">
  <div class="auth-card">
    <div class="auth-card-header">
      <div class="auth-logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="8" r="5"/>
          <path d="M20 21a8 8 0 0 0-16 0"/>
        </svg>
      </div>
      <h2>Stakeholder Portal</h2>
      <div class="auth-powered">
        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
        Powered by Titus CRM
      </div>
    </div>
    <div class="auth-card-body">
      <div class="auth-error" id="authError"></div>

      <!-- Login form -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label" for="emailInput">Email Address</label>
          <input class="form-input" type="email" id="emailInput" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label" for="passwordInput">Password</label>
          <input class="form-input" type="password" id="passwordInput" placeholder="Enter your password" autocomplete="current-password">
        </div>
        <button class="btn btn-primary" id="loginBtn" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
          Sign In
        </button>
      </div>

      <!-- Change password form (hidden by default) -->
      <div id="changePwForm" style="display:none">
        <div class="change-pw-notice">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          You must change your password before continuing.
        </div>
        <div class="form-group">
          <label class="form-label" for="newPwInput">New Password</label>
          <input class="form-input" type="password" id="newPwInput" placeholder="Enter new password" autocomplete="new-password">
        </div>
        <div class="form-group">
          <label class="form-label" for="confirmPwInput">Confirm Password</label>
          <input class="form-input" type="password" id="confirmPwInput" placeholder="Confirm new password" autocomplete="new-password">
        </div>
        <button class="btn btn-primary" id="changePwBtn" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Update Password
        </button>
      </div>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardScreen" class="app-layout" style="display:none">
  <!-- Mobile overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="sidebar-brand-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="8" r="5"/>
            <path d="M20 21a8 8 0 0 0-16 0"/>
          </svg>
        </div>
        <div class="sidebar-brand-text">
          <h3>Stakeholder Portal</h3>
          <p>Titus CRM</p>
        </div>
      </div>
      <div class="sidebar-user">
        <div class="sidebar-avatar" id="userAvatar">?</div>
        <div class="sidebar-user-info">
          <h4 id="userName">User</h4>
          <p id="userRelationship">Stakeholder</p>
        </div>
      </div>
    </div>

    <nav class="sidebar-nav" id="sidebarNav">
      <a class="nav-item active" data-tab="dashboard" href="#dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </a>
      <a class="nav-item" data-tab="notes" href="#notes">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Progress Notes
        <span class="nav-badge" id="notesBadge" style="display:none">0</span>
      </a>
      <a class="nav-item" data-tab="reports" href="#reports">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
        Reports
        <span class="nav-badge" id="reportsBadge" style="display:none">0</span>
      </a>
      <a class="nav-item" data-tab="incidents" href="#incidents">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Incidents
      </a>
      <a class="nav-item" data-tab="schedule" href="#schedule">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Schedule
      </a>
      <a class="nav-item" data-tab="goals" href="#goals">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
        Goals
      </a>
      <a class="nav-item" data-tab="documents" href="#documents">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
        Documents
      </a>
      <a class="nav-item" data-tab="messages" href="#messages">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Messages
        <span class="nav-badge" id="messagesBadge" style="display:none">0</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" id="logoutBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <div class="main-header">
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <h1 id="pageTitle">Dashboard</h1>
      <div class="main-header-actions">
        <button class="btn-icon" id="refreshBtn" title="Refresh data">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        </button>
      </div>
    </div>
    <div class="main-body" id="tabContent">
      <!-- Tab content rendered here -->
    </div>
  </main>
</div>

<script>
(function() {
  'use strict';

  // ===== STATE =====
  var portalState = {
    token: null,
    user: null,
    currentTab: 'dashboard',
    data: {}
  };

  var SVG = {
    notes: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
    report: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
    incident: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
    chevDown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
    send: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
    empty: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 15h8"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/></svg>'
  };

  function escapeHtml(str) {
    if (!str) return '';
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function formatDate(d) {
    if (!d) return '';
    return new Date(d).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
  }

  function formatDateTime(d) {
    if (!d) return '';
    return new Date(d).toLocaleString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
  }

  function getInitials(name) {
    if (!name) return '?';
    return name.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
  }

  function apiCall(method, path, body) {
    var opts = {
      method: method,
      headers: { 'Content-Type': 'application/json' }
    };
    if (portalState.token) {
      opts.headers['x-portal-token'] = portalState.token;
    }
    if (body) opts.body = JSON.stringify(body);
    return fetch('/api/portal' + path, opts).then(function(r) { return r.json(); });
  }

  // ===== AUTH =====
  var authScreen = document.getElementById('authScreen');
  var dashScreen = document.getElementById('dashboardScreen');
  var authError = document.getElementById('authError');
  var loginForm = document.getElementById('loginForm');
  var changePwForm = document.getElementById('changePwForm');
  var emailInput = document.getElementById('emailInput');
  var passwordInput = document.getElementById('passwordInput');
  var loginBtn = document.getElementById('loginBtn');
  var newPwInput = document.getElementById('newPwInput');
  var confirmPwInput = document.getElementById('confirmPwInput');
  var changePwBtn = document.getElementById('changePwBtn');

  function showAuthError(msg) {
    authError.textContent = msg;
    authError.style.display = 'block';
  }
  function hideAuthError() { authError.style.display = 'none'; }

  loginBtn.addEventListener('click', doLogin);
  passwordInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
  emailInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') passwordInput.focus(); });

  function doLogin() {
    hideAuthError();
    var email = emailInput.value.trim();
    var password = passwordInput.value;
    if (!email || !password) { showAuthError('Please enter email and password.'); return; }

    loginBtn.disabled = true;
    loginBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Signing in...';

    // Extract tenant slug from URL if present
    var params = new URLSearchParams(window.location.search);
    var tenant = params.get('tenant') || params.get('org') || undefined;

    apiCall('POST', '/login', { email: email, password: password, tenant_slug: tenant })
      .then(function(data) {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg> Sign In';

        if (data.error) { showAuthError(data.error); return; }

        portalState.token = data.token;
        portalState.user = data.user || data;
        localStorage.setItem('x-portal-token', portalState.token);

        if (data.must_change_password) {
          loginForm.style.display = 'none';
          changePwForm.style.display = 'block';
          return;
        }

        showDashboard();
      })
      .catch(function() {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg> Sign In';
        showAuthError('Connection failed. Please try again.');
      });
  }

  changePwBtn.addEventListener('click', function() {
    hideAuthError();
    var newPw = newPwInput.value;
    var confirm = confirmPwInput.value;
    if (newPw.length < 8) { showAuthError('Password must be at least 8 characters.'); return; }
    if (newPw !== confirm) { showAuthError('Passwords do not match.'); return; }

    changePwBtn.disabled = true;
    apiCall('POST', '/change-password', { new_password: newPw })
      .then(function(data) {
        changePwBtn.disabled = false;
        if (data.error) { showAuthError(data.error); return; }
        showDashboard();
      })
      .catch(function() {
        changePwBtn.disabled = false;
        showAuthError('Failed to update password. Please try again.');
      });
  });

  // Check stored token
  var storedToken = localStorage.getItem('x-portal-token');
  if (storedToken) {
    portalState.token = storedToken;
    apiCall('GET', '/me')
      .then(function(data) {
        if (data.error || !data.user) {
          localStorage.removeItem('x-portal-token');
          portalState.token = null;
          return;
        }
        portalState.user = data.user;
        showDashboard();
      })
      .catch(function() {
        localStorage.removeItem('x-portal-token');
        portalState.token = null;
      });
  }

  // ===== DASHBOARD =====
  function showDashboard() {
    authScreen.style.display = 'none';
    dashScreen.style.display = 'flex';

    var user = portalState.user || {};
    document.getElementById('userName').textContent = user.name || user.full_name || 'User';
    document.getElementById('userRelationship').textContent = user.relationship || 'Stakeholder';
    document.getElementById('userAvatar').textContent = getInitials(user.name || user.full_name);

    // Set initial tab from hash
    var hash = window.location.hash.replace('#', '') || 'dashboard';
    switchTab(hash);
  }

  // ===== SIDEBAR NAV =====
  var sidebar = document.getElementById('sidebar');
  var overlay = document.getElementById('sidebarOverlay');
  var mobileMenuBtn = document.getElementById('mobileMenuBtn');

  mobileMenuBtn.addEventListener('click', function() {
    sidebar.classList.add('open');
    overlay.classList.add('show');
  });
  overlay.addEventListener('click', function() {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });

  document.getElementById('sidebarNav').addEventListener('click', function(e) {
    var navItem = e.target.closest('.nav-item');
    if (!navItem) return;
    e.preventDefault();
    var tab = navItem.getAttribute('data-tab');
    window.location.hash = tab;
    switchTab(tab);
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });

  window.addEventListener('hashchange', function() {
    var hash = window.location.hash.replace('#', '') || 'dashboard';
    if (portalState.token) switchTab(hash);
  });

  document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('x-portal-token');
    portalState.token = null;
    portalState.user = null;
    portalState.data = {};
    dashScreen.style.display = 'none';
    authScreen.style.display = 'flex';
    emailInput.value = '';
    passwordInput.value = '';
    loginForm.style.display = 'block';
    changePwForm.style.display = 'none';
    hideAuthError();
  });

  document.getElementById('refreshBtn').addEventListener('click', function() {
    delete portalState.data[portalState.currentTab];
    switchTab(portalState.currentTab);
  });

  // ===== TAB SWITCHING =====
  var tabTitles = {
    dashboard: 'Dashboard',
    notes: 'Progress Notes',
    reports: 'Reports',
    incidents: 'Incidents',
    schedule: 'Schedule',
    goals: 'Goals',
    documents: 'Documents',
    messages: 'Messages'
  };

  function switchTab(tab) {
    if (!tabTitles[tab]) tab = 'dashboard';
    portalState.currentTab = tab;
    document.getElementById('pageTitle').textContent = tabTitles[tab];

    // Update nav active state
    var navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(function(n) {
      n.classList.toggle('active', n.getAttribute('data-tab') === tab);
    });

    var content = document.getElementById('tabContent');
    content.innerHTML = '<div class="tab-loading"><div class="spinner"></div></div>';

    var renderFn = tabRenderers[tab];
    if (renderFn) {
      if (portalState.data[tab]) {
        renderFn(content, portalState.data[tab]);
      } else {
        fetchTabData(tab, function(data) {
          portalState.data[tab] = data;
          renderFn(content, data);
        });
      }
    }
  }

  function fetchTabData(tab, cb) {
    var endpoints = {
      dashboard: '/dashboard',
      notes: '/notes',
      reports: '/reports',
      incidents: '/incidents',
      schedule: '/schedule',
      goals: '/goals',
      documents: '/documents',
      messages: '/messages'
    };
    apiCall('GET', endpoints[tab] || '/dashboard')
      .then(function(data) { cb(data); })
      .catch(function() { cb({ error: 'Failed to load data' }); });
  }

  // ===== TAB RENDERERS =====
  var tabRenderers = {};

  // Dashboard
  tabRenderers.dashboard = function(container, data) {
    var user = portalState.user || {};
    var clientName = user.client_name || user.name || 'there';
    var stats = data.stats || {};
    var activities = data.activities || data.recent_activity || [];

    var html = '<div style="margin-bottom:20px"><h2 style="font-size:20px;font-weight:800;letter-spacing:-0.5px">Welcome back, ' + escapeHtml(clientName) + '</h2><p style="font-size:13px;color:var(--text-secondary);margin-top:2px">Here is an overview of recent activity.</p></div>';

    html += '<div class="stat-grid">' +
      statCard('var(--teal-bg)', 'var(--teal)', SVG.notes, 'Recent Notes', stats.recent_notes || 0, 'Last 30 days') +
      statCard('var(--blue-bg)', 'var(--blue)', SVG.report, 'Reports Available', stats.reports || 0, 'Weekly reports') +
      statCard('#f0f9ff', '#0284c7', SVG.calendar, 'Upcoming Shifts', stats.upcoming_shifts || 0, 'This week') +
      statCard('var(--amber-bg)', 'var(--amber)', SVG.incident, 'Open Incidents', stats.open_incidents || 0, 'Pending review') +
    '</div>';

    html += '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:var(--border-light);color:var(--text-secondary)">' + SVG.clock + '</div><h3>Recent Activity</h3></div>';
    if (activities.length === 0) {
      html += '<div class="card-body"><div class="empty-state"><div class="empty-state-icon">' + SVG.empty + '</div><h3>No recent activity</h3><p>Activity will appear here as updates are made.</p></div></div>';
    } else {
      html += '<div class="card-body">';
      activities.forEach(function(a) {
        var dotColor = a.type === 'note' ? 'var(--teal)' : a.type === 'incident' ? 'var(--amber)' : a.type === 'report' ? 'var(--blue)' : 'var(--border)';
        html += '<div class="activity-item"><div class="activity-dot" style="background:' + dotColor + '"></div><div class="activity-text">' + escapeHtml(a.description || a.text) + '</div><div class="activity-time">' + formatDateTime(a.date || a.created_at) + '</div></div>';
      });
      html += '</div>';
    }
    html += '</div>';

    container.innerHTML = html;
  };

  function statCard(bgColor, iconColor, iconSvg, label, value, sub) {
    return '<div class="stat-card"><div class="stat-icon" style="background:' + bgColor + ';color:' + iconColor + '">' + iconSvg + '</div><div><div class="stat-label">' + label + '</div><div class="stat-value">' + value + '</div><div class="stat-sub">' + sub + '</div></div></div>';
  }

  // Progress Notes
  tabRenderers.notes = function(container, data) {
    var notes = data.notes || data || [];
    if (!Array.isArray(notes)) notes = [];

    if (notes.length === 0) {
      container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">' + SVG.notes + '</div><h3>No Progress Notes</h3><p>Shared progress notes will appear here.</p></div></div>';
      return;
    }

    var html = '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:var(--teal-bg);color:var(--teal)">' + SVG.notes + '</div><h3>Progress Notes (' + notes.length + ')</h3></div><ul class="data-list">';
    notes.forEach(function(note, i) {
      html += '<li class="data-list-item" data-idx="' + i + '">' +
        '<div class="data-list-item-header">' +
          '<span class="data-list-item-title">' + escapeHtml(note.title || note.category || 'Progress Note') + '</span>' +
          (note.category ? '<span class="badge badge-blue">' + escapeHtml(note.category) + '</span>' : '') +
          '<span style="font-size:11px;color:var(--text-secondary)">' + formatDate(note.date || note.created_at) + '</span>' +
          '<span class="expand-icon">' + SVG.chevDown + '</span>' +
        '</div>' +
        '<div class="data-list-item-meta">' + escapeHtml(note.author || note.created_by || '') + '</div>' +
        '<div class="data-list-item-body">' + escapeHtml(note.content || note.body || note.notes || '') + '</div>' +
      '</li>';
    });
    html += '</ul></div>';
    container.innerHTML = html;

    container.querySelectorAll('.data-list-item').forEach(function(item) {
      item.addEventListener('click', function() { item.classList.toggle('expanded'); });
    });
  };

  // Reports
  tabRenderers.reports = function(container, data) {
    var reports = data.reports || data || [];
    if (!Array.isArray(reports)) reports = [];

    if (reports.length === 0) {
      container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">' + SVG.report + '</div><h3>No Reports Available</h3><p>Weekly reports will appear here once generated.</p></div></div>';
      return;
    }

    var html = '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:var(--blue-bg);color:var(--blue)">' + SVG.report + '</div><h3>Reports</h3></div><table class="data-table"><thead><tr><th>Report</th><th>Period</th><th>Date</th><th>Status</th><th></th></tr></thead><tbody>';
    reports.forEach(function(r) {
      var isUnread = !r.read && !r.viewed;
      html += '<tr>' +
        '<td style="font-weight:' + (isUnread ? '700' : '500') + '">' + escapeHtml(r.title || 'Weekly Report') + (isUnread ? ' <span class="unread-dot"></span>' : '') + '</td>' +
        '<td>' + escapeHtml(r.period || '') + '</td>' +
        '<td>' + formatDate(r.date || r.created_at) + '</td>' +
        '<td>' + (isUnread ? '<span class="badge badge-blue">New</span>' : '<span class="badge badge-gray">Read</span>') + '</td>' +
        '<td>' + (r.download_url ? '<a href="' + r.download_url + '" class="btn btn-outline btn-sm" style="text-decoration:none">' + SVG.download + ' Download</a>' : '') + '</td>' +
      '</tr>';
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  };

  // Incidents
  tabRenderers.incidents = function(container, data) {
    var incidents = data.incidents || data || [];
    if (!Array.isArray(incidents)) incidents = [];

    if (incidents.length === 0) {
      container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">' + SVG.incident + '</div><h3>No Incidents</h3><p>Incident reports will appear here if any are logged.</p></div></div>';
      return;
    }

    var html = '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:var(--amber-bg);color:var(--amber)">' + SVG.incident + '</div><h3>Incidents</h3></div><table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Status</th></tr></thead><tbody>';
    incidents.forEach(function(inc) {
      var statusClass = inc.status === 'Resolved' || inc.status === 'Closed' ? 'badge-green' : inc.status === 'Under Investigation' ? 'badge-amber' : 'badge-red';
      html += '<tr>' +
        '<td>' + formatDate(inc.date || inc.created_at) + '</td>' +
        '<td>' + escapeHtml(inc.type || inc.category || 'General') + '</td>' +
        '<td style="max-width:300px">' + escapeHtml(inc.description || inc.summary || '') + '</td>' +
        '<td><span class="badge ' + statusClass + '">' + escapeHtml(inc.status || 'Open') + '</span></td>' +
      '</tr>';
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  };

  // Schedule
  tabRenderers.schedule = function(container, data) {
    var shifts = data.shifts || data.schedule || data || [];
    if (!Array.isArray(shifts)) shifts = [];

    if (shifts.length === 0) {
      container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon">' + SVG.calendar + '</div><h3>No Upcoming Shifts</h3><p>Scheduled supports will appear here.</p></div></div>';
      return;
    }

    var html = '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:#f0f9ff;color:#0284c7">' + SVG.calendar + '</div><h3>Upcoming Schedule</h3></div><div class="card-body"><div class="schedule-list">';
    shifts.forEach(function(s) {
      var isCancelled = s.cancelled || s.status === 'Cancelled';
      var d = new Date(s.date || s.start_time);
      html += '<div class="schedule-item' + (isCancelled ? ' cancelled' : '') + '">' +
        '<div class="schedule-date"><div class="schedule-date-day">' + d.getDate() + '</div><div class="schedule-date-month">' + d.toLocaleDateString('en-AU', { month: 'short' }) + '</div></div>' +
        '<div class="schedule-info">' +
          '<div class="schedule-info-title">' + escapeHtml(s.support_type || s.type || 'Support Shift') + (isCancelled ? ' <span class="badge badge-red">Cancelled</span>' : '') + '</div>' +
          '<div class="schedule-info-time">' + SVG.clock + ' ' + escapeHtml(s.time || (d.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }))) + (s.duration ? ' (' + s.duration + ')' : '') + '</div>' +
          (s.worker ? '<div style="font-size:11px;color:var(--text-secondary);margin-top:2px">Support Worker: ' + escapeHtml(s.worker) + '</div>' : '') +
        '</div>' +
      '</div>';
    });
    html += '</div></div></div>';
    container.innerHTML = html;
  };

  // Goals
  tabRenderers.goals = function(container, data) {
    var goals = data.goals || data || [];
    if (!Array.isArray(goals)) goals = [];

    if (goals.length === 0) {
      container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div><h3>No Goals Set</h3><p>NDIS plan goals will appear here once added.</p></div></div>';
      return;
    }

    var html = '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:var(--green-bg);color:var(--green)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div><h3>NDIS Plan Goals</h3></div>';
    goals.forEach(function(g) {
      var statusClass = g.status === 'On Track' ? 'badge-green' : g.status === 'Needs Review' ? 'badge-amber' : 'badge-gray';
      html += '<div class="goal-item">' +
        '<div class="goal-header"><span class="goal-title">' + escapeHtml(g.title || g.name || 'Goal') + '</span><span class="badge ' + statusClass + '">' + escapeHtml(g.status || 'Active') + '</span></div>' +
        (g.description ? '<div class="goal-desc">' + escapeHtml(g.description) + '</div>' : '') +
        (g.next_review ? '<div class="goal-meta">Next review: ' + formatDate(g.next_review) + '</div>' : '') +
      '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
  };

  // Documents
  tabRenderers.documents = function(container, data) {
    var docs = data.documents || data || [];
    if (!Array.isArray(docs)) docs = [];

    if (docs.length === 0) {
      container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg></div><h3>No Documents</h3><p>Signed agreements and documents will appear here.</p></div></div>';
      return;
    }

    var html = '<div class="card"><div class="card-header"><div class="card-header-icon" style="background:var(--border-light);color:var(--text-secondary)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg></div><h3>Documents</h3></div><table class="data-table"><thead><tr><th>Document</th><th>Type</th><th>Date</th><th>Status</th><th></th></tr></thead><tbody>';
    docs.forEach(function(doc) {
      var statusClass = doc.status === 'Signed' ? 'badge-green' : doc.status === 'Pending' ? 'badge-amber' : 'badge-gray';
      html += '<tr>' +
        '<td style="font-weight:600">' + escapeHtml(doc.title || doc.name || 'Document') + '</td>' +
        '<td>' + escapeHtml(doc.type || '') + '</td>' +
        '<td>' + formatDate(doc.date || doc.created_at) + '</td>' +
        '<td><span class="badge ' + statusClass + '">' + escapeHtml(doc.status || 'Draft') + '</span></td>' +
        '<td>' + (doc.download_url ? '<a href="' + doc.download_url + '" class="btn btn-outline btn-sm" style="text-decoration:none">' + SVG.download + ' Download</a>' : '') + '</td>' +
      '</tr>';
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  };

  // Messages
  tabRenderers.messages = function(container, data) {
    var messages = data.messages || data || [];
    if (!Array.isArray(messages)) messages = [];

    var html = '<div class="card" style="overflow:hidden"><div class="messages-wrap"><div class="messages-list" id="messagesList">';
    if (messages.length === 0) {
      html += '<div class="empty-state" style="padding:40px 20px"><div class="empty-state-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div><h3>No Messages Yet</h3><p>Start a conversation with the team.</p></div>';
    } else {
      messages.forEach(function(m) {
        var isSent = m.sent_by === 'portal' || m.direction === 'outgoing' || m.is_mine;
        html += '<div class="msg-bubble ' + (isSent ? 'sent' : 'received') + '">' +
          (!isSent && m.sender ? '<div style="font-size:10px;font-weight:700;margin-bottom:2px;opacity:0.7">' + escapeHtml(m.sender) + '</div>' : '') +
          escapeHtml(m.text || m.content || m.message || '') +
          '<div class="msg-meta">' + formatDateTime(m.date || m.created_at || m.timestamp) + '</div>' +
        '</div>';
      });
    }
    html += '</div><div class="messages-input"><input type="text" id="msgInput" placeholder="Type a message..."><button class="msg-send-btn" id="msgSendBtn">' + SVG.send + ' Send</button></div></div></div>';

    container.innerHTML = html;

    // Scroll to bottom
    var list = document.getElementById('messagesList');
    list.scrollTop = list.scrollHeight;

    // Send message
    var msgInput = document.getElementById('msgInput');
    var sendBtn = document.getElementById('msgSendBtn');

    function sendMessage() {
      var text = msgInput.value.trim();
      if (!text) return;
      msgInput.value = '';

      // Optimistic UI
      var bubble = document.createElement('div');
      bubble.className = 'msg-bubble sent';
      bubble.innerHTML = escapeHtml(text) + '<div class="msg-meta">' + formatDateTime(new Date().toISOString()) + '</div>';
      list.appendChild(bubble);
      list.scrollTop = list.scrollHeight;

      // Clear empty state if present
      var emptyEl = list.querySelector('.empty-state');
      if (emptyEl) emptyEl.remove();

      apiCall('POST', '/messages', { message: text })
        .then(function(data) {
          if (data.error) {
            bubble.style.opacity = '0.5';
          }
        })
        .catch(function() {
          bubble.style.opacity = '0.5';
        });

      // Clear cached data so refresh fetches new messages
      delete portalState.data['messages'];
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') sendMessage(); });
  };

})();
</script>
</body>
</html>
