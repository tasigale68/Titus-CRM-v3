<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Budget Dashboard — NDIS Plan Tracking — Titus CRM</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════════
   CLIENT BUDGET DASHBOARD — NDIS PLAN TRACKING — TITUS CRM
   ═══════════════════════════════════════════════════════════════ */

:root {
  --teal: #0d9488;
  --teal-light: rgba(13,148,136,.08);
  --teal-border: rgba(13,148,136,.2);
  --teal-dark: #0f766e;
  --navy: #0f172a;
  --navy-light: #1e293b;
  --bg: #f1f5f9;
  --surface: #ffffff;
  --surface2: #f8fafc;
  --border: #e2e8f0;
  --border2: #cbd5e1;
  --text: #0f172a;
  --text2: #334155;
  --muted: #64748b;
  --dim: #94a3b8;
  --green: #10b981;
  --green-bg: rgba(16,185,129,.08);
  --green-border: rgba(16,185,129,.2);
  --amber: #f59e0b;
  --amber-bg: rgba(245,158,11,.08);
  --amber-border: rgba(245,158,11,.2);
  --orange: #f97316;
  --orange-bg: rgba(249,115,22,.08);
  --orange-border: rgba(249,115,22,.2);
  --red: #ef4444;
  --red-bg: rgba(239,68,68,.08);
  --red-border: rgba(239,68,68,.2);
  --blue: #3b82f6;
  --blue-bg: rgba(59,130,246,.08);
  --blue-border: rgba(59,130,246,.2);
  --purple: #8b5cf6;
  --purple-bg: rgba(139,92,246,.08);
  --purple-border: rgba(139,92,246,.2);
  --r: 12px;
  --rs: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
  --shadow-md: 0 4px 12px rgba(0,0,0,.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,.12);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }

body {
  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--dim); }

h1, h2, h3, h4 { font-weight: 700; letter-spacing: -0.02em; }
.mono { font-family: 'JetBrains Mono', monospace; }

/* ─── Header ─── */
.page-header {
  background: var(--navy);
  padding: 20px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 50;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.back-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.1);
  color: var(--teal);
  text-decoration: none;
  cursor: pointer;
  transition: all 200ms;
}
.back-btn:hover {
  background: rgba(255,255,255,.15);
  color: #5eead4;
}

.header-title h1 {
  font-size: 20px;
  font-weight: 800;
  color: #f8fafc;
  letter-spacing: -0.3px;
}
.header-title .breadcrumb {
  font-size: 12px;
  color: rgba(255,255,255,.5);
  margin-top: 2px;
}
.header-title .breadcrumb a {
  color: rgba(255,255,255,.5);
  text-decoration: none;
  transition: color 200ms;
}
.header-title .breadcrumb a:hover { color: #5eead4; }

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.header-badge {
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 6px;
  background: rgba(13,148,136,.15);
  color: #5eead4;
  letter-spacing: .02em;
}

/* ─── Container ─── */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px 32px;
}

/* ─── Filter Bar ─── */
.filter-bar {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px 20px;
  margin-bottom: 20px;
  display: flex;
  align-items: flex-end;
  gap: 12px;
  flex-wrap: wrap;
  box-shadow: var(--shadow);
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.form-group.grow { flex: 1; min-width: 200px; }
.form-group label {
  font-size: 10px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .5px;
}

input[type="text"],
input[type="number"],
input[type="date"],
input[type="search"],
select,
textarea {
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--rs);
  background: var(--surface2);
  color: var(--text);
  outline: none;
  transition: border 200ms;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--teal);
  box-shadow: 0 0 0 3px rgba(13,148,136,.1);
}
input::placeholder, textarea::placeholder { color: var(--dim); }

textarea {
  font-family: inherit;
  min-height: 80px;
  resize: vertical;
  width: 100%;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 9px 16px;
  border-radius: var(--rs);
  font-size: 13px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  font-family: inherit;
  transition: all 200ms;
  white-space: nowrap;
}
.btn svg { width: 16px; height: 16px; flex-shrink: 0; }
.btn:active { transform: scale(.97); }

.btn-primary { background: var(--teal); color: #fff; }
.btn-primary:hover { background: var(--teal-dark); box-shadow: 0 4px 12px rgba(13,148,136,.3); }

.btn-secondary { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--border); color: var(--text); }

.btn-sm { padding: 6px 10px; font-size: 11px; }
.btn-xs { padding: 4px 8px; font-size: 10px; }

.btn-success { background: var(--green); color: #fff; }
.btn-success:hover { background: #059669; }

.btn-danger { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.btn-danger:hover { background: var(--red); color: #fff; }

/* ─── Stats Cards ─── */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px;
  box-shadow: var(--shadow);
  transition: all 200ms;
}
.stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }

.stat-card .stat-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}
.stat-card .stat-icon svg { width: 20px; height: 20px; }
.stat-card .stat-icon.teal { background: var(--teal-light); color: var(--teal); }
.stat-card .stat-icon.green { background: var(--green-bg); color: var(--green); }
.stat-card .stat-icon.amber { background: var(--amber-bg); color: var(--amber); }
.stat-card .stat-icon.blue { background: var(--blue-bg); color: var(--blue); }

.stat-card .stat-value {
  font-size: 24px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.5px;
  font-family: 'JetBrains Mono', monospace;
}
.stat-card .stat-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  margin-top: 4px;
}

/* ─── Panel ─── */
.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  box-shadow: var(--shadow);
  margin-bottom: 20px;
  overflow: hidden;
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 10px;
}

.panel-header h2 {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.panel-header h2 svg { width: 18px; height: 18px; color: var(--teal); }

.panel-header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-body { padding: 0; }

/* ─── Table ─── */
.table-wrap { overflow-x: auto; }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead th {
  background: var(--surface2);
  padding: 10px 14px;
  text-align: left;
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .5px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  position: sticky;
  top: 0;
  z-index: 2;
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 200ms;
  cursor: pointer;
}
tbody tr:hover { background: var(--surface2); }
tbody tr:last-child { border-bottom: none; }

tbody td {
  padding: 12px 14px;
  color: var(--text2);
  vertical-align: middle;
}

.td-name { font-weight: 600; color: var(--text); }
.td-mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; }

/* ─── Badges ─── */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.badge-green { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
.badge-amber { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }
.badge-orange { background: var(--orange-bg); color: var(--orange); border: 1px solid var(--orange-border); }
.badge-red { background: var(--red-bg); color: var(--red); border: 1px solid var(--red-border); }
.badge-blue { background: var(--blue-bg); color: var(--blue); border: 1px solid var(--blue-border); }
.badge-info { background: var(--blue-bg); color: var(--blue); border: 1px solid var(--blue-border); }

/* ─── Progress Bar ─── */
.progress-cell {
  min-width: 150px;
}

.progress-bar-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}

.progress-bar-bg {
  flex: 1;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 600ms ease;
}

.progress-bar-fill.green { background: var(--green); }
.progress-bar-fill.amber { background: var(--amber); }
.progress-bar-fill.orange { background: var(--orange); }
.progress-bar-fill.red { background: var(--red); }

.progress-bar-fill.pulse {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.progress-pct {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  min-width: 40px;
  text-align: right;
}

.progress-label {
  font-size: 10px;
  font-weight: 600;
  margin-top: 2px;
}

/* ─── Countdown ─── */
.countdown {
  font-size: 11px;
  font-weight: 600;
}
.countdown.urgent { color: var(--red); }
.countdown.soon { color: var(--amber); }
.countdown.ok { color: var(--muted); }

/* ─── Detail Panel ─── */
.detail-panel {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  box-shadow: var(--shadow-md);
  margin-bottom: 20px;
  overflow: hidden;
  animation: slideDown 200ms ease;
}
.detail-panel.show { display: block; }

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

.detail-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--surface2);
}

.detail-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.detail-avatar {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: var(--teal-light);
  color: var(--teal);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 14px;
}

.detail-name {
  font-size: 16px;
  font-weight: 700;
}
.detail-meta {
  font-size: 12px;
  color: var(--muted);
}

.detail-close {
  width: 32px;
  height: 32px;
  border: none;
  background: var(--surface);
  border-radius: var(--rs);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--muted);
  transition: all 200ms;
}
.detail-close:hover { background: var(--border); color: var(--text); }

.detail-body { padding: 20px; }

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.detail-section h3 {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.detail-section h3 svg { width: 16px; height: 16px; color: var(--teal); }

/* ─── Category Breakdown ─── */
.category-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.category-item:last-child { border-bottom: none; }

.category-name {
  flex: 1;
  min-width: 0;
}
.category-name .name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}
.category-name .amounts {
  font-size: 11px;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
}

.category-bar {
  width: 120px;
  flex-shrink: 0;
}

/* ─── Transaction Table ─── */
.txn-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.txn-table thead th {
  background: var(--surface2);
  padding: 8px 10px;
  font-size: 10px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .5px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.txn-table tbody td {
  padding: 8px 10px;
  font-size: 12px;
  border-bottom: 1px solid var(--border);
  color: var(--text2);
}
.txn-table tbody tr:last-child td { border-bottom: none; }
.txn-table tbody tr:hover { background: var(--surface2); }

/* ─── Burn Rate Bar ─── */
.burn-chart {
  display: flex;
  align-items: flex-end;
  gap: 4px;
  height: 100px;
  padding: 10px 0;
}
.burn-bar {
  flex: 1;
  background: var(--teal);
  border-radius: 3px 3px 0 0;
  min-height: 4px;
  transition: height 400ms ease;
  position: relative;
}
.burn-bar:hover { opacity: 0.8; }
.burn-bar .burn-tip {
  display: none;
  position: absolute;
  bottom: calc(100% + 4px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--navy);
  color: #fff;
  font-size: 10px;
  font-weight: 600;
  padding: 3px 6px;
  border-radius: 4px;
  white-space: nowrap;
  font-family: 'JetBrains Mono', monospace;
}
.burn-bar:hover .burn-tip { display: block; }

.burn-labels {
  display: flex;
  gap: 4px;
  margin-top: 4px;
}
.burn-labels span {
  flex: 1;
  text-align: center;
  font-size: 9px;
  font-weight: 600;
  color: var(--dim);
}

/* ─── Alerts Section ─── */
.alerts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 12px;
  padding: 16px 20px;
}

.alert-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: var(--rs);
  transition: all 200ms;
}
.alert-item:hover {
  box-shadow: var(--shadow);
  transform: translateY(-1px);
}

.alert-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.alert-icon svg { width: 18px; height: 18px; }
.alert-icon.red { background: var(--red-bg); color: var(--red); }
.alert-icon.orange { background: var(--orange-bg); color: var(--orange); }
.alert-icon.amber { background: var(--amber-bg); color: var(--amber); }
.alert-icon.blue { background: var(--blue-bg); color: var(--blue); }

.alert-content {
  flex: 1;
  min-width: 0;
}
.alert-client {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 2px;
}
.alert-issue {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}
.alert-action {
  font-size: 11px;
  font-weight: 600;
  color: var(--teal);
}

/* ─── Modal ─── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,.6);
  backdrop-filter: blur(4px);
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.modal-overlay.show { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  width: 520px;
  max-width: 100%;
  box-shadow: var(--shadow-lg);
  animation: modalIn 200ms ease;
}

@keyframes modalIn {
  from { opacity: 0; transform: translateY(12px) scale(.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}
.modal-header h3 { font-size: 15px; font-weight: 700; }
.modal-close {
  width: 32px;
  height: 32px;
  border: none;
  background: var(--surface2);
  border-radius: var(--rs);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--muted);
  transition: all 200ms;
}
.modal-close:hover { background: var(--border); color: var(--text); }

.modal-body { padding: 20px; }
.modal-body .form-group { margin-bottom: 14px; }

.modal-footer {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 20px;
  border-top: 1px solid var(--border);
}

/* ─── Loading / Empty States ─── */
.loading-state,
.empty-state {
  padding: 48px 24px;
  text-align: center;
  color: var(--muted);
}
.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--teal);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state svg { width: 48px; height: 48px; color: var(--dim); margin-bottom: 12px; }
.empty-state h3 { font-size: 15px; font-weight: 700; color: var(--text2); margin-bottom: 4px; }
.empty-state p { font-size: 13px; }

/* ─── Toast ─── */
.toast-container {
  position: fixed;
  top: 80px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--rs);
  padding: 12px 16px;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  font-weight: 500;
  min-width: 300px;
  animation: slideIn 300ms ease;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--blue); }
.toast svg { width: 18px; height: 18px; flex-shrink: 0; }
.toast.success svg { color: var(--green); }
.toast.error svg { color: var(--red); }
.toast.info svg { color: var(--blue); }

@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* ─── Responsive ─── */
@media (max-width: 1024px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .container { padding: 16px; }
  .detail-grid { grid-template-columns: 1fr; }
  .alerts-grid { grid-template-columns: 1fr; }
}

@media (max-width: 768px) {
  .page-header { padding: 14px 16px; }
  .header-title h1 { font-size: 16px; }
  .filter-bar { flex-direction: column; align-items: stretch; }
  .stats-row { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 480px) {
  .stats-row { grid-template-columns: 1fr; }
  .header-right { display: none; }
}
</style>
</head>
<body>

<!-- ═══ Header ═══ -->
<header class="page-header">
  <div class="header-left">
    <a href="/" class="back-btn" title="Back to Titus CRM">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><polyline points="15 18 9 12 15 6"/></svg>
    </a>
    <div class="header-title">
      <h1>Client Budget Dashboard -- NDIS Plan Tracking</h1>
      <div class="breadcrumb"><a href="/">Titus CRM</a> / Budgets / Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <span class="header-badge">NDIS Budget Monitor</span>
  </div>
</header>

<!-- ═══ Main Content ═══ -->
<div class="container">

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="form-group grow">
      <label>Search Client</label>
      <input type="search" id="filterSearch" placeholder="Search by client name..." oninput="applyFilters()">
    </div>
    <div class="form-group">
      <label>Budget Status</label>
      <select id="filterStatus" onchange="applyFilters()">
        <option value="">All Statuses</option>
        <option value="green">Green (0-70%)</option>
        <option value="amber">Amber (71-85%)</option>
        <option value="orange">Orange (86-95%)</option>
        <option value="red">Red (96-100%)</option>
        <option value="over">Over Budget (100%+)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Category</label>
      <select id="filterCategory" onchange="applyFilters()">
        <option value="">All Categories</option>
        <option value="core">Core Supports</option>
        <option value="capacity">Capacity Building</option>
        <option value="capital">Capital Supports</option>
        <option value="sil">SIL</option>
        <option value="community">Community Access</option>
      </select>
    </div>
    <button class="btn btn-secondary" onclick="exportCSV()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export CSV
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      </div>
      <div class="stat-value" id="statClients">0</div>
      <div class="stat-label">Clients Tracked</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon teal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      </div>
      <div class="stat-value" id="statFunding">$0</div>
      <div class="stat-label">Total Funding</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon amber">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      </div>
      <div class="stat-value" id="statSpent">$0</div>
      <div class="stat-label">Total Spent</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      </div>
      <div class="stat-value" id="statUtilisation">0%</div>
      <div class="stat-label">Average Utilisation</div>
    </div>
  </div>

  <!-- Client Detail Panel (hidden by default) -->
  <div class="detail-panel" id="detailPanel">
    <div class="detail-header">
      <div class="detail-header-left">
        <div class="detail-avatar" id="detailAvatar">--</div>
        <div>
          <div class="detail-name" id="detailName">Client Name</div>
          <div class="detail-meta" id="detailMeta">Plan details</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-sm btn-primary" onclick="openAddTransaction()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Transaction
        </button>
        <button class="detail-close" onclick="closeDetail()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>
    <div class="detail-body">
      <div class="detail-grid">
        <div class="detail-section">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Budget Breakdown by Category
          </h3>
          <div id="categoryBreakdown">
            <!-- Populated by JS -->
          </div>
        </div>
        <div class="detail-section">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            Burn Rate (Last 12 Weeks)
          </h3>
          <div class="burn-chart" id="burnChart">
            <!-- Populated by JS -->
          </div>
          <div class="burn-labels" id="burnLabels"></div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted);" id="burnProjection">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
      <div class="detail-section">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Transaction History
        </h3>
        <div class="table-wrap" style="max-height:300px;overflow-y:auto;">
          <table class="txn-table" id="txnTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Roster Link</th>
              </tr>
            </thead>
            <tbody id="txnBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Budget Health Table -->
  <div class="panel">
    <div class="panel-header">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Budget Health Overview
      </h2>
      <div class="panel-header-actions">
        <span class="badge badge-info" id="budgetCount">0 clients</span>
      </div>
    </div>
    <div class="panel-body">
      <div class="table-wrap">
        <table id="budgetTable">
          <thead>
            <tr>
              <th>Client</th>
              <th>Plan End</th>
              <th>Category</th>
              <th>Total Funding</th>
              <th>Spent</th>
              <th>Committed</th>
              <th>Remaining</th>
              <th>Utilisation</th>
              <th>Projected</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="budgetBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
      <div class="loading-state" id="budgetLoading">
        <div class="loading-spinner"></div>
        <p>Loading budget data...</p>
      </div>
      <div class="empty-state" id="budgetEmpty" style="display:none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        <h3>No Budget Data</h3>
        <p>No client budgets found. Check API connection or add budget entries.</p>
      </div>
    </div>
  </div>

  <!-- Alerts Section -->
  <div class="panel">
    <div class="panel-header">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        Budget Alerts
      </h2>
      <span class="badge badge-red" id="alertCount">0 alerts</span>
    </div>
    <div class="alerts-grid" id="alertsGrid">
      <div class="loading-state" style="grid-column:1/-1;">
        <div class="loading-spinner"></div>
        <p>Loading alerts...</p>
      </div>
    </div>
  </div>

</div>

<!-- Add Transaction Modal -->
<div class="modal-overlay" id="txnModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Add Transaction</h3>
      <button class="modal-close" onclick="closeTxnModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Client</label>
        <input type="text" id="txnClient" readonly style="background:var(--surface2);cursor:default;">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="txnDate">
        </div>
        <div class="form-group">
          <label>Amount ($)</label>
          <input type="number" id="txnAmount" placeholder="0.00" step="0.01" min="0">
        </div>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="txnType">
          <option value="service">Service Delivery</option>
          <option value="transport">Transport</option>
          <option value="consumable">Consumable</option>
          <option value="capital">Capital Purchase</option>
          <option value="adjustment">Adjustment</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="txnDescription" placeholder="Transaction description..."></textarea>
      </div>
      <div class="form-group">
        <label>Roster Link (optional)</label>
        <input type="text" id="txnRosterLink" placeholder="Roster ID or reference...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeTxnModal()">Cancel</button>
      <button class="btn btn-primary" id="btnSaveTxn" onclick="saveTransaction()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
        Save Transaction
      </button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
/* ═══════════════════════════════════════════════════════════════
   CLIENT BUDGET DASHBOARD — JavaScript
   ═══════════════════════════════════════════════════════════════ */

const API_BASE = '';
const token = localStorage.getItem('titus_token');
const headers = {
  'Authorization': 'Bearer ' + token,
  'Content-Type': 'application/json'
};

let allBudgets = [];
let filteredBudgets = [];
let allAlerts = [];
let selectedClient = null;
let selectedClientDetail = null;

// ─── Init ───
document.addEventListener('DOMContentLoaded', () => {
  loadBudgets();
  loadAlerts();
});

// ─── Formatting ───
function formatCurrency(n) {
  return '$' + (n || 0).toLocaleString('en-AU', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function formatCurrencyFull(n) {
  return '$' + (n || 0).toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDate(d) { return d.toISOString().split('T')[0]; }

// ─── API ───
async function apiGet(url) {
  const res = await fetch(API_BASE + url, { headers });
  if (!res.ok) throw new Error(`GET ${url}: ${res.status}`);
  return res.json();
}

async function apiPost(url, body) {
  const res = await fetch(API_BASE + url, {
    method: 'POST', headers,
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`POST ${url}: ${res.status}`);
  return res.json();
}

// ─── Load Budgets ───
async function loadBudgets() {
  const loading = document.getElementById('budgetLoading');
  loading.style.display = 'block';
  document.getElementById('budgetTable').style.display = 'none';

  try {
    const data = await apiGet('/api/budgets/dashboard');
    allBudgets = Array.isArray(data) ? data : (data.budgets || data.clients || data.data || []);
    applyFilters();
    updateStats();
  } catch (err) {
    console.error('Failed to load budgets:', err);
    loading.style.display = 'none';
    document.getElementById('budgetEmpty').style.display = 'block';
    document.getElementById('budgetEmpty').querySelector('h3').textContent = 'Could not load budget data';
    document.getElementById('budgetEmpty').querySelector('p').textContent = err.message;
  }
}

// ─── Load Alerts ───
async function loadAlerts() {
  try {
    const data = await apiGet('/api/budgets/alerts');
    allAlerts = Array.isArray(data) ? data : (data.alerts || []);
    renderAlerts();
  } catch (err) {
    console.error('Failed to load alerts:', err);
    deriveAlerts();
  }
}

function deriveAlerts() {
  allAlerts = [];
  allBudgets.forEach(b => {
    const util = getUtilisation(b);
    const daysLeft = getDaysRemaining(b.plan_end);

    if (util > 100) {
      allAlerts.push({ type: 'over_budget', severity: 'red', client: b.client_name || b.name, issue: `Budget exceeded by ${(util - 100).toFixed(1)}%`, action: 'Review spending immediately and contact plan manager.' });
    } else if (util >= 86) {
      allAlerts.push({ type: 'nearing_limit', severity: 'orange', client: b.client_name || b.name, issue: `Utilisation at ${util.toFixed(1)}% - nearing limit`, action: 'Monitor closely and plan remaining services.' });
    }

    if (daysLeft !== null && daysLeft <= 30 && daysLeft > 0) {
      allAlerts.push({ type: 'plan_ending', severity: 'amber', client: b.client_name || b.name, issue: `Plan ends in ${daysLeft} days`, action: 'Initiate plan review and coordinate with NDIA.' });
    }

    if (util < 40 && daysLeft !== null && daysLeft < 90) {
      allAlerts.push({ type: 'under_utilised', severity: 'blue', client: b.client_name || b.name, issue: `Only ${util.toFixed(1)}% utilised with ${daysLeft} days remaining`, action: 'Review service delivery and increase supports if needed.' });
    }
  });
  renderAlerts();
}

// ─── Filters ───
function applyFilters() {
  const search = document.getElementById('filterSearch').value.toLowerCase();
  const statusFilter = document.getElementById('filterStatus').value;
  const categoryFilter = document.getElementById('filterCategory').value;

  filteredBudgets = allBudgets.filter(b => {
    const name = (b.client_name || b.name || '').toLowerCase();
    if (search && !name.includes(search)) return false;

    if (categoryFilter) {
      const cat = (b.category || b.support_category || '').toLowerCase();
      if (!cat.includes(categoryFilter)) return false;
    }

    if (statusFilter) {
      const util = getUtilisation(b);
      const status = getStatusFromUtil(util);
      if (statusFilter !== status) return false;
    }

    return true;
  });

  renderBudgetTable();
}

function getUtilisation(b) {
  const total = b.total_funding || b.budget || b.total || 0;
  const spent = b.spent || b.total_spent || 0;
  if (total === 0) return 0;
  return (spent / total) * 100;
}

function getStatusFromUtil(util) {
  if (util > 100) return 'over';
  if (util >= 96) return 'red';
  if (util >= 86) return 'orange';
  if (util >= 71) return 'amber';
  return 'green';
}

function getStatusLabel(status) {
  const map = {
    green: 'On Track',
    amber: 'On Target',
    orange: 'Nearing Limit',
    red: 'Almost Exhausted',
    over: 'OVER BUDGET'
  };
  return map[status] || status;
}

function getDaysRemaining(planEnd) {
  if (!planEnd) return null;
  const end = new Date(planEnd);
  const now = new Date();
  const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
  return diff;
}

function getProjectedExhaustion(b) {
  const total = b.total_funding || b.budget || b.total || 0;
  const spent = b.spent || b.total_spent || 0;
  const remaining = total - spent;
  if (remaining <= 0) return 'Exhausted';

  const burnRate = b.weekly_burn_rate || b.burn_rate;
  if (burnRate && burnRate > 0) {
    const weeks = Math.floor(remaining / burnRate);
    return weeks <= 0 ? 'This week' : weeks + ' week' + (weeks !== 1 ? 's' : '');
  }

  const planEnd = b.plan_end || b.plan_end_date;
  const daysLeft = getDaysRemaining(planEnd);
  if (daysLeft && daysLeft > 0 && spent > 0) {
    const planStart = b.plan_start || b.plan_start_date;
    if (planStart) {
      const totalDays = Math.ceil((new Date(planEnd) - new Date(planStart)) / (1000 * 60 * 60 * 24));
      const elapsed = totalDays - daysLeft;
      if (elapsed > 0) {
        const dailyRate = spent / elapsed;
        const daysToExhaust = Math.floor(remaining / dailyRate);
        const weeks = Math.floor(daysToExhaust / 7);
        return weeks <= 0 ? 'This week' : weeks + ' week' + (weeks !== 1 ? 's' : '');
      }
    }
  }

  return '--';
}

// ─── Stats ───
function updateStats() {
  let totalFunding = 0, totalSpent = 0, count = allBudgets.length, totalUtil = 0;
  allBudgets.forEach(b => {
    totalFunding += b.total_funding || b.budget || b.total || 0;
    totalSpent += b.spent || b.total_spent || 0;
    totalUtil += getUtilisation(b);
  });
  const avgUtil = count > 0 ? totalUtil / count : 0;

  document.getElementById('statClients').textContent = count;
  document.getElementById('statFunding').textContent = formatCurrency(totalFunding);
  document.getElementById('statSpent').textContent = formatCurrency(totalSpent);
  document.getElementById('statUtilisation').textContent = avgUtil.toFixed(1) + '%';
}

// ─── Render Budget Table ───
function renderBudgetTable() {
  const loading = document.getElementById('budgetLoading');
  const empty = document.getElementById('budgetEmpty');
  const table = document.getElementById('budgetTable');
  const body = document.getElementById('budgetBody');

  loading.style.display = 'none';
  body.innerHTML = '';

  if (filteredBudgets.length === 0) {
    empty.style.display = 'block';
    table.style.display = 'none';
    document.getElementById('budgetCount').textContent = '0 clients';
    return;
  }

  table.style.display = 'table';
  empty.style.display = 'none';
  document.getElementById('budgetCount').textContent = filteredBudgets.length + ' client' + (filteredBudgets.length !== 1 ? 's' : '');

  filteredBudgets.forEach(b => {
    const total = b.total_funding || b.budget || b.total || 0;
    const spent = b.spent || b.total_spent || 0;
    const committed = b.committed || 0;
    const remaining = total - spent - committed;
    const util = getUtilisation(b);
    const status = getStatusFromUtil(util);
    const daysLeft = getDaysRemaining(b.plan_end || b.plan_end_date);
    const projected = getProjectedExhaustion(b);

    const barColor = status === 'over' ? 'red pulse' : status === 'red' ? 'red' : status === 'orange' ? 'orange' : status === 'amber' ? 'amber' : 'green';
    const barWidth = Math.min(util, 100);

    const countdownClass = daysLeft !== null ? (daysLeft <= 14 ? 'urgent' : daysLeft <= 30 ? 'soon' : 'ok') : 'ok';

    const clientId = b.client_id || b.id || '';
    const clientName = b.client_name || b.name || 'Unknown';
    const category = b.category || b.support_category || 'Core Supports';

    const tr = document.createElement('tr');
    tr.onclick = () => openClientDetail(clientId);
    tr.innerHTML = `
      <td class="td-name">${escapeHtml(clientName)}</td>
      <td>
        ${daysLeft !== null
          ? `<span class="countdown ${countdownClass}">${daysLeft > 0 ? daysLeft + ' days' : daysLeft === 0 ? 'Today' : 'Expired'}</span>`
          : '<span style="color:var(--dim);">--</span>'}
      </td>
      <td><span style="font-size:12px;">${escapeHtml(category)}</span></td>
      <td class="td-mono">${formatCurrency(total)}</td>
      <td class="td-mono">${formatCurrency(spent)}</td>
      <td class="td-mono">${formatCurrency(committed)}</td>
      <td class="td-mono" style="font-weight:600;${remaining < 0 ? 'color:var(--red);' : ''}">${formatCurrency(remaining)}</td>
      <td class="progress-cell">
        <div class="progress-bar-wrap">
          <div class="progress-bar-bg">
            <div class="progress-bar-fill ${barColor}" style="width:${barWidth}%"></div>
          </div>
          <span class="progress-pct" style="color:var(--${status === 'over' ? 'red' : status === 'red' ? 'red' : status === 'orange' ? 'orange' : status === 'amber' ? 'amber' : 'green'});">${util.toFixed(1)}%</span>
        </div>
        <div class="progress-label" style="color:var(--${status === 'over' ? 'red' : status});">${getStatusLabel(status)}</div>
      </td>
      <td style="font-size:12px;color:var(--muted);">${projected}</td>
      <td><span class="badge badge-${status === 'over' ? 'red' : status}">${getStatusLabel(status)}</span></td>
      <td>
        <div style="display:flex;gap:4px;" onclick="event.stopPropagation();">
          <button class="btn btn-xs btn-secondary" onclick="openClientDetail('${clientId}')" title="View Details">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <button class="btn btn-xs btn-primary" onclick="openAddTransactionFor('${clientId}','${escapeHtml(clientName)}')" title="Add Transaction">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="12" height="12"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
      </td>
    `;
    body.appendChild(tr);
  });
}

// ─── Render Alerts ───
function renderAlerts() {
  const grid = document.getElementById('alertsGrid');

  if (allAlerts.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><h3>No Active Alerts</h3><p>All client budgets are within normal parameters.</p></div>';
    document.getElementById('alertCount').textContent = '0 alerts';
    document.getElementById('alertCount').className = 'badge badge-green';
    return;
  }

  document.getElementById('alertCount').textContent = allAlerts.length + ' alert' + (allAlerts.length !== 1 ? 's' : '');

  const alertIcons = {
    red: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    orange: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    amber: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    blue: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
  };

  grid.innerHTML = allAlerts.map(a => `
    <div class="alert-item">
      <div class="alert-icon ${a.severity}">${alertIcons[a.severity] || alertIcons.amber}</div>
      <div class="alert-content">
        <div class="alert-client">${escapeHtml(a.client)}</div>
        <div class="alert-issue">${escapeHtml(a.issue)}</div>
        <div class="alert-action">${escapeHtml(a.action)}</div>
      </div>
    </div>
  `).join('');
}

// ─── Client Detail ───
async function openClientDetail(clientId) {
  if (!clientId) return;
  selectedClient = clientId;

  const panel = document.getElementById('detailPanel');
  panel.classList.add('show');
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  const budget = allBudgets.find(b => (b.client_id || b.id) === clientId);
  if (budget) {
    const name = budget.client_name || budget.name || 'Unknown';
    document.getElementById('detailAvatar').textContent = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    document.getElementById('detailName').textContent = name;
    document.getElementById('detailMeta').textContent = `${budget.category || 'Core Supports'} | Plan: ${budget.plan_start || '--'} to ${budget.plan_end || '--'}`;
  }

  try {
    const data = await apiGet('/api/budgets/client/' + clientId);
    selectedClientDetail = data;
    renderClientDetail(data);
  } catch (err) {
    console.error('Failed to load client detail:', err);
    if (budget) {
      renderClientDetailFromBudget(budget);
    }
  }
}

function renderClientDetail(data) {
  renderCategoryBreakdown(data.categories || data.breakdown || []);
  renderBurnChart(data.burn_rate || data.weekly_spending || []);
  renderTransactions(data.transactions || data.history || []);

  const remaining = (data.total_funding || 0) - (data.spent || 0);
  const burnRate = data.average_weekly_burn || 0;
  const projection = burnRate > 0 ? Math.floor(remaining / burnRate) : null;
  document.getElementById('burnProjection').innerHTML = projection !== null
    ? `Average weekly burn: <strong class="mono">${formatCurrencyFull(burnRate)}</strong> | Projected exhaustion in <strong>${projection} weeks</strong>`
    : 'Insufficient data for burn rate projection.';
}

function renderClientDetailFromBudget(b) {
  const total = b.total_funding || b.budget || b.total || 0;
  const spent = b.spent || b.total_spent || 0;
  const cat = b.category || 'Core Supports';

  renderCategoryBreakdown([{ name: cat, total: total, spent: spent }]);
  renderBurnChart([]);
  renderTransactions([]);
  document.getElementById('burnProjection').textContent = 'Load client detail for full burn rate data.';
}

function renderCategoryBreakdown(categories) {
  const el = document.getElementById('categoryBreakdown');
  if (!categories || categories.length === 0) {
    el.innerHTML = '<p style="font-size:13px;color:var(--muted);padding:12px 0;">No category breakdown available.</p>';
    return;
  }

  el.innerHTML = categories.map(c => {
    const total = c.total || c.budget || 0;
    const spent = c.spent || 0;
    const pct = total > 0 ? (spent / total) * 100 : 0;
    const status = getStatusFromUtil(pct);
    const barColor = status === 'over' ? 'red' : status;

    return `
      <div class="category-item">
        <div class="category-name">
          <div class="name">${escapeHtml(c.name || c.category || 'Unknown')}</div>
          <div class="amounts">${formatCurrency(spent)} of ${formatCurrency(total)}</div>
        </div>
        <div class="category-bar">
          <div class="progress-bar-wrap">
            <div class="progress-bar-bg">
              <div class="progress-bar-fill ${barColor}" style="width:${Math.min(pct, 100)}%"></div>
            </div>
            <span class="progress-pct" style="color:var(--${barColor});">${pct.toFixed(0)}%</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderBurnChart(weeklyData) {
  const chart = document.getElementById('burnChart');
  const labels = document.getElementById('burnLabels');

  if (!weeklyData || weeklyData.length === 0) {
    chart.innerHTML = '<div style="flex:1;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--dim);">No burn rate data available</div>';
    labels.innerHTML = '';
    return;
  }

  const max = Math.max(...weeklyData.map(w => w.amount || w.value || w || 0));

  chart.innerHTML = weeklyData.slice(-12).map((w, i) => {
    const val = w.amount || w.value || w || 0;
    const h = max > 0 ? (val / max) * 100 : 0;
    return `<div class="burn-bar" style="height:${Math.max(h, 4)}%"><span class="burn-tip">${formatCurrencyFull(val)}</span></div>`;
  }).join('');

  labels.innerHTML = weeklyData.slice(-12).map((w, i) => {
    const label = w.week || w.label || ('W' + (i + 1));
    return `<span>${label}</span>`;
  }).join('');
}

function renderTransactions(transactions) {
  const body = document.getElementById('txnBody');
  if (!transactions || transactions.length === 0) {
    body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">No transactions recorded.</td></tr>';
    return;
  }

  body.innerHTML = transactions.map(t => `
    <tr>
      <td class="td-mono">${t.date || '--'}</td>
      <td>${escapeHtml(capitalize(t.type || 'service'))}</td>
      <td class="td-mono" style="font-weight:600;">${formatCurrencyFull(t.amount)}</td>
      <td>${escapeHtml(t.description || '--')}</td>
      <td>${t.roster_link || t.roster_id ? `<a href="#" style="color:var(--teal);font-size:11px;">${escapeHtml(t.roster_link || t.roster_id)}</a>` : '<span style="color:var(--dim);">--</span>'}</td>
    </tr>
  `).join('');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('show');
  selectedClient = null;
  selectedClientDetail = null;
}

// ─── Transaction Modal ───
function openAddTransaction() {
  if (!selectedClient) {
    showToast('Select a client first.', 'error');
    return;
  }
  const budget = allBudgets.find(b => (b.client_id || b.id) === selectedClient);
  document.getElementById('txnClient').value = budget ? (budget.client_name || budget.name) : selectedClient;
  document.getElementById('txnDate').value = formatDate(new Date());
  document.getElementById('txnAmount').value = '';
  document.getElementById('txnDescription').value = '';
  document.getElementById('txnRosterLink').value = '';
  document.getElementById('txnModal').classList.add('show');
}

function openAddTransactionFor(clientId, clientName) {
  selectedClient = clientId;
  document.getElementById('txnClient').value = clientName;
  document.getElementById('txnDate').value = formatDate(new Date());
  document.getElementById('txnAmount').value = '';
  document.getElementById('txnDescription').value = '';
  document.getElementById('txnRosterLink').value = '';
  document.getElementById('txnModal').classList.add('show');
}

function closeTxnModal() {
  document.getElementById('txnModal').classList.remove('show');
}

async function saveTransaction() {
  const amount = parseFloat(document.getElementById('txnAmount').value);
  const date = document.getElementById('txnDate').value;
  const type = document.getElementById('txnType').value;
  const description = document.getElementById('txnDescription').value.trim();

  if (!amount || amount <= 0) {
    showToast('Please enter a valid amount.', 'error');
    return;
  }
  if (!date) {
    showToast('Please select a date.', 'error');
    return;
  }

  const btn = document.getElementById('btnSaveTxn');
  btn.disabled = true;

  try {
    await apiPost('/api/budgets/transaction', {
      client_id: selectedClient,
      date,
      amount,
      type,
      description,
      roster_link: document.getElementById('txnRosterLink').value.trim()
    });

    showToast('Transaction saved successfully.', 'success');
    closeTxnModal();
    loadBudgets();

    if (selectedClientDetail) {
      openClientDetail(selectedClient);
    }
  } catch (err) {
    showToast('Failed to save: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
  }
}

// ─── Export ───
async function exportCSV() {
  try {
    const res = await fetch(API_BASE + '/api/budgets/export', { headers });
    if (res.ok) {
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'budget-dashboard.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('CSV exported.', 'success');
      return;
    }
  } catch (e) {}

  // Fallback: client-side CSV
  const rows = [['Client', 'Plan End', 'Category', 'Total Funding', 'Spent', 'Committed', 'Remaining', 'Utilisation %', 'Status']];
  filteredBudgets.forEach(b => {
    const total = b.total_funding || b.budget || b.total || 0;
    const spent = b.spent || b.total_spent || 0;
    const committed = b.committed || 0;
    const remaining = total - spent - committed;
    const util = getUtilisation(b);
    rows.push([
      b.client_name || b.name, b.plan_end || '', b.category || '',
      total, spent, committed, remaining,
      util.toFixed(1), getStatusLabel(getStatusFromUtil(util))
    ]);
  });
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'budget-dashboard.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('CSV exported (client-side).', 'success');
}

// ─── Utilities ───
function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ─── Toast ───
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
  };
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.innerHTML = (icons[type] || icons.info) + '<span>' + message + '</span>';
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(20px)';
    toast.style.transition = 'all 300ms';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}
</script>
</body>
</html>
