<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DCS Worker">
<meta name="theme-color" content="#0B1D3A">
<link rel="manifest" href="/manifest.json">
<title>DCS Support Worker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
:root{
  --navy:#0B1D3A;--surface:#0F2440;--royal:#2454A0;--teal:#00B4D8;--aqua:#48CAE4;
  --green:#10B981;--warning:#F59E0B;--error:#EF4444;--text:#FFFFFF;--muted:#94A3B8;
  --card:#162B4D;--card-border:#1E3A5F;--input-bg:#0F2440;--input-border:#1E3A5F;
}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--text);overflow:hidden;}
body{display:flex;flex-direction:column;}

/* ── Login Screen ── */
.login-wrap{position:fixed;inset:0;background:linear-gradient(160deg,#0B1D3A 0%,#0F2440 40%,#162B4D 100%);display:flex;align-items:center;justify-content:center;z-index:9999;padding:24px;}
.login-card{width:100%;max-width:380px;text-align:center;}
.login-logo{width:72px;height:72px;background:linear-gradient(135deg,var(--teal),var(--aqua));border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;color:var(--navy);margin:0 auto 16px;letter-spacing:-1px;}
.login-card h1{font-size:22px;font-weight:800;margin-bottom:4px;}
.login-card p{font-size:13px;color:var(--muted);margin-bottom:28px;}
.login-field{margin-bottom:14px;text-align:left;}
.login-field label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:5px;}
.login-field input{width:100%;padding:13px 14px;background:var(--surface);border:1.5px solid var(--input-border);border-radius:10px;color:var(--text);font-size:15px;font-family:inherit;outline:none;transition:border-color .15s;}
.login-field input:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,180,216,.15);}
.login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--teal),var(--royal));color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:6px;min-height:48px;transition:opacity .15s;}
.login-btn:disabled{opacity:.5;cursor:not-allowed;}
.login-error{background:rgba(239,68,68,.12);color:var(--error);padding:10px 14px;border-radius:8px;font-size:13px;font-weight:500;margin-top:12px;display:none;}

/* ── Password Strength ── */
.pw-strength{margin-top:8px;display:none;}
.pw-strength.visible{display:block;}
.pw-strength-bar{height:4px;background:var(--input-border);border-radius:2px;overflow:hidden;margin-bottom:6px;}
.pw-strength-bar .fill{height:100%;border-radius:2px;transition:width .3s,background .3s;width:0;}
.pw-reqs{list-style:none;padding:0;}
.pw-reqs li{font-size:11px;color:var(--muted);padding:1px 0;display:flex;align-items:center;gap:5px;transition:color .15s;}
.pw-reqs li.met{color:var(--green);}
.pw-reqs li .icon{width:14px;text-align:center;font-size:10px;}

/* ── OTP Screen ── */
.otp-wrap{display:none;}
.otp-wrap.visible{display:block;}
.otp-icon{font-size:40px;margin-bottom:12px;}
.otp-subtitle{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.5;}
.otp-subtitle strong{color:var(--text);}
.otp-input{width:100%;padding:16px;background:var(--surface);border:1.5px solid var(--input-border);border-radius:12px;color:var(--text);font-size:24px;font-family:'JetBrains Mono',monospace;text-align:center;letter-spacing:8px;outline:none;transition:border-color .15s;}
.otp-input:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,180,216,.15);}
.otp-actions{margin-top:16px;text-align:center;}
.otp-resend{background:none;border:none;color:var(--teal);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;padding:8px;margin-top:8px;}
.otp-resend:disabled{color:var(--muted);cursor:not-allowed;}
.otp-back{background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;font-family:inherit;padding:8px;margin-top:4px;}

/* ── Forgot / Reset Flow ── */
.forgot-link{background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;font-family:inherit;padding:10px;margin-top:12px;transition:color .15s;width:100%;text-align:center;}
.forgot-link:hover{color:var(--teal);}
.reset-wrap{display:none;}
.reset-wrap.visible{display:block;}
.login-success{background:rgba(16,185,129,.12);color:var(--green);padding:10px 14px;border-radius:8px;font-size:13px;font-weight:500;margin-bottom:14px;display:none;text-align:center;}

/* ── App Shell ── */
.app{display:none;flex-direction:column;height:100%;overflow:hidden;}
.app.active{display:flex;}

/* ── Top Bar ── */
.top-bar{background:var(--surface);padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--card-border);flex-shrink:0;min-height:56px;}
.top-bar .avatar{width:36px;height:36px;border-radius:10px;object-fit:cover;background:var(--royal);flex-shrink:0;}
.top-bar .avatar-placeholder{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--teal),var(--royal));display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#fff;flex-shrink:0;}
.top-bar .info{flex:1;min-width:0;}
.top-bar .info h2{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.top-bar .info span{font-size:11px;color:var(--muted);font-weight:500;}
.top-bar .badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.04em;flex-shrink:0;}

/* ── Scrollable Content Area ── */
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 0 8px 0;}
.content::-webkit-scrollbar{display:none;}

/* ── Section ── */
.section{padding:16px;}
.section-title{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.section-title .count{background:var(--royal);color:var(--aqua);font-size:10px;padding:2px 7px;border-radius:10px;font-weight:600;}

/* ── Shift Card ── */
.shift-card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:14px;margin-bottom:10px;transition:transform .1s;}
.shift-card:active{transform:scale(.98);}
.shift-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;}
.shift-row:last-child{margin-bottom:0;}
.shift-client{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.shift-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap;}
.badge-sil{background:rgba(0,180,216,.15);color:var(--teal);}
.badge-cas{background:rgba(16,185,129,.15);color:var(--green);}
.badge-active{background:rgba(16,185,129,.15);color:var(--green);}
.badge-completed{background:rgba(148,163,184,.15);color:var(--muted);}
.badge-scheduled{background:rgba(72,202,228,.15);color:var(--aqua);}
.badge-cancelled{background:rgba(239,68,68,.15);color:var(--error);}
.badge-draft{background:rgba(148,163,184,.1);color:var(--muted);}
.shift-meta{display:flex;align-items:center;gap:10px;font-size:12px;color:var(--muted);flex-wrap:wrap;}
.shift-meta .mono{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--aqua);}
.shift-time{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text);font-weight:500;}
.shift-icons{display:flex;gap:6px;align-items:center;font-size:12px;}
.pn-done{color:var(--green);font-size:14px;}
.pn-pending{color:var(--warning);font-size:10px;}
.clock-btn{min-height:44px;padding:10px 16px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;width:100%;margin-top:8px;transition:opacity .15s;display:flex;align-items:center;justify-content:center;gap:6px;}
.clock-btn:disabled{opacity:.5;cursor:not-allowed;}
.clock-in-btn{background:linear-gradient(135deg,var(--green),#059669);color:#fff;}
.clock-out-btn{background:linear-gradient(135deg,var(--error),#DC2626);color:#fff;}

/* ── Live Timer ── */
.pulse-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.live-timer{padding:6px 10px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:8px;}

/* ── Geo Map ── */
.geo-map-container{width:100%;height:200px;border-radius:10px;overflow:hidden;margin:8px 0;border:1px solid var(--card-border);}
.geo-success{padding:12px;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:10px;margin:8px 0;text-align:center;}
.geo-success .distance{font-size:18px;font-weight:800;font-family:'JetBrains Mono',monospace;}
.geo-success .label{font-size:11px;color:var(--muted);margin-top:4px;}

/* ── Bottom Nav ── */
.bottom-nav{display:flex;background:var(--surface);border-top:1px solid var(--card-border);flex-shrink:0;padding-bottom:env(safe-area-inset-bottom,0);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 4px;min-height:56px;cursor:pointer;color:var(--muted);font-size:10px;font-weight:600;transition:color .15s;-webkit-user-select:none;user-select:none;gap:3px;}
.nav-item.active{color:var(--teal);}
.nav-item .nav-icon{font-size:20px;line-height:1;}

/* ── Empty State ── */
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty .icon{font-size:36px;margin-bottom:8px;opacity:.5;}
.empty p{font-size:13px;}

/* ── Forms ── */
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:5px;}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:12px 14px;background:var(--input-bg);border:1.5px solid var(--input-border);border-radius:10px;color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none;}
.form-group input:focus,.form-group textarea:focus,.form-group select:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(0,180,216,.12);}
.form-group textarea{resize:vertical;min-height:100px;}
.form-group select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394A3B8'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;}
.form-group .char-count{font-size:10px;color:var(--muted);text-align:right;margin-top:3px;}
.form-group .char-count.ok{color:var(--green);}
.submit-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--teal),var(--royal));color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;min-height:48px;transition:opacity .15s;}
.submit-btn:disabled{opacity:.5;cursor:not-allowed;}
.form-status{padding:10px 14px;border-radius:8px;font-size:13px;font-weight:500;margin-top:10px;text-align:center;display:none;}
.form-status.success{display:block;background:rgba(16,185,129,.12);color:var(--green);}
.form-status.error{display:block;background:rgba(239,68,68,.12);color:var(--error);}
.back-btn{min-height:44px;display:flex;align-items:center;gap:6px;background:none;border:none;color:var(--teal);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;padding:8px 0;margin-bottom:8px;}

/* ── Override Modal ── */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:var(--surface);border-radius:16px 16px 0 0;width:100%;max-width:420px;padding:20px 16px 32px;max-height:80vh;overflow-y:auto;}
.modal-sheet h3{font-size:17px;font-weight:700;margin-bottom:4px;}
.modal-sheet p{font-size:13px;color:var(--muted);margin-bottom:16px;}
.modal-sheet .warning-banner{background:rgba(245,158,11,.12);color:var(--warning);padding:12px;border-radius:10px;font-size:13px;font-weight:600;margin-bottom:14px;text-align:center;}

/* ── Training ── */
.enrollment-card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:14px;margin-bottom:10px;cursor:pointer;transition:transform .1s;}
.enrollment-card:active{transform:scale(.98);}
.enrollment-card h4{font-size:14px;font-weight:700;margin-bottom:6px;}
.progress-bar{height:6px;background:var(--input-border);border-radius:3px;overflow:hidden;margin:8px 0;}
.progress-bar .fill{height:100%;border-radius:3px;transition:width .3s;}
.status-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;text-transform:uppercase;letter-spacing:.04em;}
.status-not-started{background:rgba(148,163,184,.15);color:var(--muted);}
.status-in-progress{background:rgba(245,158,11,.15);color:var(--warning);}
.status-completed{background:rgba(16,185,129,.15);color:var(--green);}
.status-overdue{background:rgba(239,68,68,.15);color:var(--error);}

/* ── Course Player ── */
.course-player{padding:16px;}
.module-card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;margin-bottom:10px;overflow:hidden;}
.module-header{padding:14px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;}
.module-header h4{font-size:14px;font-weight:700;}
.module-body{padding:0 14px 14px;display:none;}
.module-body.open{display:block;}
.lesson-item{padding:10px 12px;background:var(--input-bg);border-radius:8px;margin-bottom:8px;}
.lesson-item h5{font-size:13px;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:6px;}
.lesson-item .lesson-type{font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;background:rgba(0,180,216,.15);color:var(--teal);}
.lesson-content{font-size:13px;color:var(--muted);line-height:1.5;margin-top:6px;white-space:pre-wrap;}
.lesson-video{width:100%;border-radius:8px;margin-top:8px;background:#000;max-height:220px;}
.lesson-attachment{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:8px;color:var(--teal);font-size:12px;font-weight:600;text-decoration:none;margin-top:6px;}

/* ── Quiz ── */
.quiz-wrap{padding:16px;}
.quiz-question{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:14px;margin-bottom:12px;}
.quiz-question h4{font-size:14px;font-weight:600;margin-bottom:10px;}
.quiz-option{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--input-bg);border:1.5px solid var(--input-border);border-radius:8px;margin-bottom:6px;cursor:pointer;min-height:44px;transition:border-color .15s;font-size:13px;}
.quiz-option.selected{border-color:var(--teal);background:rgba(0,180,216,.08);}
.quiz-option .radio{width:18px;height:18px;border:2px solid var(--input-border);border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.quiz-option.selected .radio{border-color:var(--teal);}
.quiz-option.selected .radio::after{content:'';width:10px;height:10px;background:var(--teal);border-radius:50%;}
.quiz-result{text-align:center;padding:20px;border-radius:12px;margin-bottom:16px;}
.quiz-result.pass{background:rgba(16,185,129,.12);color:var(--green);}
.quiz-result.fail{background:rgba(239,68,68,.12);color:var(--error);}
.quiz-result .score{font-size:32px;font-weight:800;margin-bottom:4px;}

/* ── Profile ── */
.profile-section{padding:16px;}
.profile-header{text-align:center;padding:24px 16px;background:var(--card);border-radius:12px;margin-bottom:16px;border:1px solid var(--card-border);}
.profile-avatar{width:80px;height:80px;border-radius:20px;object-fit:cover;margin:0 auto 12px;display:block;background:var(--royal);}
.profile-avatar-placeholder{width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,var(--teal),var(--royal));display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#fff;margin:0 auto 12px;}
.profile-header h2{font-size:20px;font-weight:800;}
.profile-header p{font-size:13px;color:var(--muted);}
.profile-item{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--card);border:1px solid var(--card-border);border-radius:10px;margin-bottom:8px;min-height:48px;}
.profile-item .label{font-size:12px;color:var(--muted);font-weight:500;}
.profile-item .value{font-size:13px;font-weight:600;text-align:right;max-width:60%;word-break:break-word;}
.logout-btn{width:100%;padding:14px;background:rgba(239,68,68,.12);color:var(--error);border:1px solid rgba(239,68,68,.2);border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;min-height:48px;margin-top:16px;}

/* ── Spinner ── */
.spinner{width:18px;height:18px;border:2.5px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-center{display:flex;align-items:center;justify-content:center;padding:40px;}

/* ── Reminder Banner ── */
.reminder-banner{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.2);color:var(--warning);padding:12px 14px;border-radius:10px;font-size:13px;font-weight:600;margin:0 16px 8px;text-align:center;}
.reminder-banner.critical{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.2);color:var(--error);}

/* ── Page views ── */
.page{display:none;}
.page.active{display:block;}
</style>
</head>
<body>

<!-- ════ LOGIN ════ -->
<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="login-logo">DCS</div>
    <h1>Support Worker Portal</h1>
    <p>Delta Community Support</p>

    <!-- Success banner (shown after password set) -->
    <div class="login-success" id="loginSuccess"></div>

    <!-- Step 1: Email + Password -->
    <div id="loginStep1">
      <div class="login-field">
        <label>Email Address</label>
        <input type="email" id="loginEmail" placeholder="your.email@example.com" autocomplete="email" autocapitalize="off">
      </div>
      <div class="login-field">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password" oninput="updatePwStrength()">
        <div class="pw-strength" id="pwStrength">
          <div class="pw-strength-bar"><div class="fill" id="pwStrengthFill"></div></div>
          <ul class="pw-reqs">
            <li id="pwReq12"><span class="icon">&#10005;</span> 12+ characters</li>
            <li id="pwReqUpper"><span class="icon">&#10005;</span> Uppercase letter</li>
            <li id="pwReqLower"><span class="icon">&#10005;</span> Lowercase letter</li>
            <li id="pwReqNum"><span class="icon">&#10005;</span> Number</li>
            <li id="pwReqSpec"><span class="icon">&#10005;</span> Special character</li>
          </ul>
        </div>
      </div>
      <button class="login-btn" id="loginBtn" onclick="doLogin()">Sign In</button>
      <button class="forgot-link" onclick="showForgotPassword()">First time login or forgot password? Click here</button>
    </div>

    <!-- Step 2: OTP Entry (login flow) -->
    <div class="otp-wrap" id="otpWrap">
      <div class="otp-icon">&#128274;</div>
      <h1 style="font-size:18px;margin-bottom:4px;">Check your email</h1>
      <p class="otp-subtitle">We sent a 6-digit login code to<br><strong id="otpEmail"></strong></p>
      <div class="login-field">
        <label>Verification Code</label>
        <input type="text" id="otpInput" class="otp-input" placeholder="000000" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code">
      </div>
      <button class="login-btn" id="otpBtn" onclick="verifyOtp()">Verify Code</button>
      <div class="otp-actions">
        <button class="otp-resend" id="otpResendBtn" onclick="resendOtp()">Resend Code</button><br>
        <button class="otp-back" onclick="backToLogin()">&#8592; Back to login</button>
      </div>
    </div>

    <!-- Forgot Password Step 1: Enter email -->
    <div class="reset-wrap" id="resetStep1">
      <div class="otp-icon">&#128272;</div>
      <h1 style="font-size:18px;margin-bottom:4px;">Reset your password</h1>
      <p class="otp-subtitle">Enter your email address and we'll send you a verification code.</p>
      <div class="login-field">
        <label>Email Address</label>
        <input type="email" id="resetEmail" placeholder="your.email@example.com" autocomplete="email" autocapitalize="off">
      </div>
      <button class="login-btn" id="resetEmailBtn" onclick="submitForgotPassword()">Send Verification Code</button>
      <div class="otp-actions">
        <button class="otp-back" onclick="backToLoginFromReset()">&#8592; Back to login</button>
      </div>
    </div>

    <!-- Forgot Password Step 2: Enter OTP -->
    <div class="reset-wrap" id="resetStep2">
      <div class="otp-icon">&#128274;</div>
      <h1 style="font-size:18px;margin-bottom:4px;">Check your email</h1>
      <p class="otp-subtitle">We sent a 6-digit code to<br><strong id="resetOtpEmail"></strong></p>
      <div class="login-field">
        <label>Verification Code</label>
        <input type="text" id="resetOtpInput" class="otp-input" placeholder="000000" maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code">
      </div>
      <button class="login-btn" id="resetOtpBtn" onclick="verifyResetOtp()">Verify Code</button>
      <div class="otp-actions">
        <button class="otp-resend" id="resetResendBtn" onclick="resendResetOtp()">Resend Code</button><br>
        <button class="otp-back" onclick="backToLoginFromReset()">&#8592; Back to login</button>
      </div>
    </div>

    <!-- Forgot Password Step 3: Set new password -->
    <div class="reset-wrap" id="resetStep3">
      <div class="otp-icon">&#128275;</div>
      <h1 style="font-size:18px;margin-bottom:4px;">Set your password</h1>
      <p class="otp-subtitle">Create a strong password for your account.</p>
      <div class="login-field">
        <label>New Password</label>
        <input type="password" id="resetNewPw" placeholder="Create password" autocomplete="new-password" oninput="updateResetPwStrength()">
        <div class="pw-strength" id="resetPwStrength">
          <div class="pw-strength-bar"><div class="fill" id="resetPwStrengthFill"></div></div>
          <ul class="pw-reqs">
            <li id="resetReq12"><span class="icon">&#10005;</span> 12+ characters</li>
            <li id="resetReqUpper"><span class="icon">&#10005;</span> Uppercase letter</li>
            <li id="resetReqLower"><span class="icon">&#10005;</span> Lowercase letter</li>
            <li id="resetReqNum"><span class="icon">&#10005;</span> Number</li>
            <li id="resetReqSpec"><span class="icon">&#10005;</span> Special character</li>
          </ul>
        </div>
      </div>
      <div class="login-field">
        <label>Confirm Password</label>
        <input type="password" id="resetConfirmPw" placeholder="Confirm password" autocomplete="new-password">
      </div>
      <button class="login-btn" id="resetSetPwBtn" onclick="submitSetPassword()">Set Password</button>
      <div class="otp-actions">
        <button class="otp-back" onclick="backToLoginFromReset()">&#8592; Back to login</button>
      </div>
    </div>

    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ════ APP ════ -->
<div class="app" id="app">

  <!-- Top Bar -->
  <div class="top-bar" id="topBar">
    <div id="topAvatar"></div>
    <div class="info">
      <h2 id="topName"></h2>
      <span id="topType"></span>
    </div>
    <div id="topBadge"></div>
  </div>

  <!-- Content -->
  <div class="content" id="contentArea">

    <!-- HOME -->
    <div class="page active" id="pageHome">
      <div id="homeContent"><div class="loading-center"><div class="spinner"></div></div></div>
    </div>

    <!-- MY SHIFTS -->
    <div class="page" id="pageShifts">
      <div id="shiftsContent"><div class="loading-center"><div class="spinner"></div></div></div>
    </div>

    <!-- NOTES (Progress Notes) -->
    <div class="page" id="pageNotes">
      <div id="notesContent"></div>
    </div>

    <!-- INCIDENTS -->
    <div class="page" id="pageIncidents">
      <div id="incidentsContent"></div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="pageProfile">
      <div id="profileContent"></div>
    </div>

    <!-- MY DOCUMENTS -->
    <div class="page" id="pageDocs">
      <div id="docsContent"></div>
    </div>

    <!-- TRAINING (sub-page accessed from profile or home) -->
    <div class="page" id="pageTraining">
      <div id="trainingContent"></div>
    </div>

    <!-- COURSE PLAYER -->
    <div class="page" id="pageCourse">
      <div id="courseContent"></div>
    </div>

    <!-- QUIZ -->
    <div class="page" id="pageQuiz">
      <div id="quizContent"></div>
    </div>

  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" data-page="pageHome" onclick="switchPage('pageHome')">
      <span class="nav-icon">&#127968;</span>Home
    </div>
    <div class="nav-item" data-page="pageShifts" onclick="switchPage('pageShifts')">
      <span class="nav-icon">&#128197;</span>My Shifts
    </div>
    <div class="nav-item" data-page="pageNotes" onclick="switchPage('pageNotes')">
      <span class="nav-icon">&#128221;</span>Notes
    </div>
    <div class="nav-item" data-page="pageIncidents" onclick="switchPage('pageIncidents')">
      <span class="nav-icon">&#9888;&#65039;</span>Incidents
    </div>
    <div class="nav-item" data-page="pageProfile" onclick="switchPage('pageProfile')">
      <span class="nav-icon">&#128100;</span>Profile
    </div>
  </div>
</div>

<!-- ════ Override Modal ════ -->
<div class="modal-overlay" id="overrideModal">
  <div class="modal-sheet">
    <h3>Geo-fence Override</h3>
    <p id="overrideDistance"></p>
    <div class="warning-banner" id="overrideWarning">You are outside the 200m geo-fence for this client's address.</div>
    <div id="overrideMapContainer"></div>
    <div class="form-group">
      <label>Reason for override (min 10 characters)</label>
      <textarea id="overrideReason" rows="3" placeholder="e.g. Client was picked up from a different location..."></textarea>
      <div class="char-count" id="overrideCharCount">0 / 10 min</div>
    </div>
    <button class="submit-btn" id="overrideSubmitBtn" onclick="submitOverride()" disabled>Confirm Override</button>
    <button class="back-btn" onclick="closeOverrideModal()" style="width:100%;justify-content:center;margin-top:8px;">Cancel</button>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
// ═══ STATE ═══
// ═══════════════════════════════════════════
var swToken = localStorage.getItem("sw_token") || "";
var swUser = null;
try { swUser = JSON.parse(localStorage.getItem("sw_user") || "null"); } catch(e) {}
var allShifts = [];
var enrollments = [];
var currentPage = "pageHome";
var pendingClock = null; // {action, rosterId, clientName, lat, lng}

// ═══════════════════════════════════════════
// ═══ API HELPER ═══
// ═══════════════════════════════════════════
function api(method, url, body) {
  var opts = { method: method, headers: { "Content-Type": "application/json" } };
  if (swToken) opts.headers["x-sw-token"] = swToken;
  if (body) opts.body = JSON.stringify(body);
  return fetch(url, opts).then(function(r) {
    if (r.status === 401) { doLogout(); throw new Error("Session expired"); }
    return r.json();
  });
}

// ═══════════════════════════════════════════
// ═══ AUTH ═══
// ═══════════════════════════════════════════
var otpEmailPending = "";

function doLogin() {
  var email = (document.getElementById("loginEmail").value || "").trim();
  var pw = document.getElementById("loginPassword").value || "";
  if (!email || !pw) return showLoginError("Email and password required");
  var btn = document.getElementById("loginBtn");
  btn.disabled = true; btn.textContent = "Signing in...";
  hideLoginError();
  api("POST", "/api/sw/login", { email: email, password: pw }).then(function(d) {
    btn.disabled = false; btn.textContent = "Sign In";
    if (d.error) return showLoginError(d.error);
    if (d.otpRequired) {
      otpEmailPending = d.email || email;
      showOtpScreen(otpEmailPending);
      return;
    }
    // Fallback direct login (shouldn't happen with OTP flow)
    if (d.token) {
      swToken = d.token; swUser = d.user;
      localStorage.setItem("sw_token", swToken);
      localStorage.setItem("sw_user", JSON.stringify(swUser));
      enterApp();
    }
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Sign In";
    showLoginError(e.message || "Login failed");
  });
}

function showOtpScreen(email) {
  hideAllLoginSteps();
  document.getElementById("otpWrap").classList.add("visible");
  document.getElementById("otpEmail").textContent = email;
  document.getElementById("otpInput").value = "";
  document.getElementById("otpInput").focus();
}

function backToLogin() {
  hideAllLoginSteps();
  document.getElementById("loginStep1").style.display = "block";
  document.getElementById("loginPassword").value = "";
  otpEmailPending = "";
}

function verifyOtp() {
  var code = (document.getElementById("otpInput").value || "").trim();
  if (!code || code.length !== 6) return showLoginError("Enter the 6-digit code");
  var btn = document.getElementById("otpBtn");
  btn.disabled = true; btn.textContent = "Verifying...";
  hideLoginError();
  api("POST", "/api/sw/verify-otp", { email: otpEmailPending, code: code }).then(function(d) {
    btn.disabled = false; btn.textContent = "Verify Code";
    if (d.error) {
      if (d.locked) {
        showLoginError(d.error);
        return;
      }
      if (d.expired) {
        showLoginError(d.error);
        document.getElementById("otpResendBtn").style.display = "inline-block";
        return;
      }
      return showLoginError(d.error);
    }
    if (d.token) {
      swToken = d.token; swUser = d.user;
      localStorage.setItem("sw_token", swToken);
      localStorage.setItem("sw_user", JSON.stringify(swUser));
      enterApp();
    }
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Verify Code";
    showLoginError(e.message || "Verification failed");
  });
}

function resendOtp() {
  var btn = document.getElementById("otpResendBtn");
  btn.disabled = true; btn.textContent = "Sending...";
  hideLoginError();
  api("POST", "/api/sw/resend-otp", { email: otpEmailPending }).then(function(d) {
    btn.disabled = false; btn.textContent = "Resend Code";
    if (d.error) {
      if (d.locked) return showLoginError(d.error);
      return showLoginError(d.error);
    }
    showLoginError(""); // clear
    hideLoginError();
    document.getElementById("otpInput").value = "";
    document.getElementById("otpInput").focus();
    // Brief confirmation
    var el = document.getElementById("loginError");
    el.textContent = "New code sent!";
    el.style.display = "block";
    el.style.background = "rgba(16,185,129,.12)";
    el.style.color = "var(--green)";
    setTimeout(function() { el.style.display = "none"; el.style.background = ""; el.style.color = ""; }, 3000);
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Resend Code";
    showLoginError(e.message || "Failed to resend");
  });
}

// ── Password Strength Indicator ──
function updatePwStrength() {
  var pw = document.getElementById("loginPassword").value;
  var panel = document.getElementById("pwStrength");
  if (pw.length === 0) { panel.classList.remove("visible"); return; }
  panel.classList.add("visible");

  var checks = [
    { id: "pwReq12", met: pw.length >= 12 },
    { id: "pwReqUpper", met: /[A-Z]/.test(pw) },
    { id: "pwReqLower", met: /[a-z]/.test(pw) },
    { id: "pwReqNum", met: /[0-9]/.test(pw) },
    { id: "pwReqSpec", met: /[^A-Za-z0-9]/.test(pw) }
  ];
  var metCount = 0;
  checks.forEach(function(c) {
    var el = document.getElementById(c.id);
    if (c.met) { el.classList.add("met"); el.querySelector(".icon").innerHTML = "&#10003;"; metCount++; }
    else { el.classList.remove("met"); el.querySelector(".icon").innerHTML = "&#10005;"; }
  });
  var pct = (metCount / 5) * 100;
  var fill = document.getElementById("pwStrengthFill");
  fill.style.width = pct + "%";
  if (metCount <= 1) fill.style.background = "var(--error)";
  else if (metCount <= 2) fill.style.background = "var(--warning)";
  else if (metCount <= 3) fill.style.background = "#EAB308";
  else if (metCount <= 4) fill.style.background = "var(--aqua)";
  else fill.style.background = "var(--green)";
}

function showLoginError(msg) { var el = document.getElementById("loginError"); el.textContent = msg; el.style.display = msg ? "block" : "none"; el.style.background = ""; el.style.color = ""; }
function hideLoginError() { var el = document.getElementById("loginError"); el.style.display = "none"; el.style.background = ""; el.style.color = ""; }

function doLogout() {
  api("POST", "/api/sw/logout", {}).catch(function(){});
  swToken = ""; swUser = null;
  localStorage.removeItem("sw_token");
  localStorage.removeItem("sw_user");
  document.getElementById("app").classList.remove("active");
  document.getElementById("loginWrap").style.display = "flex";
  document.getElementById("loginPassword").value = "";
  // Reset to login step 1
  hideAllLoginSteps();
  document.getElementById("loginStep1").style.display = "block";
  otpEmailPending = "";
  resetEmailPending = "";
  resetToken = "";
}

// Enter key handlers
document.getElementById("loginPassword").addEventListener("keydown", function(e) { if (e.key === "Enter") doLogin(); });
document.getElementById("loginEmail").addEventListener("keydown", function(e) { if (e.key === "Enter") document.getElementById("loginPassword").focus(); });
document.getElementById("otpInput").addEventListener("keydown", function(e) { if (e.key === "Enter") verifyOtp(); });
document.getElementById("resetEmail").addEventListener("keydown", function(e) { if (e.key === "Enter") submitForgotPassword(); });
document.getElementById("resetOtpInput").addEventListener("keydown", function(e) { if (e.key === "Enter") verifyResetOtp(); });
document.getElementById("resetConfirmPw").addEventListener("keydown", function(e) { if (e.key === "Enter") submitSetPassword(); });

// ═══════════════════════════════════════════
// ═══ FORGOT PASSWORD / FIRST TIME LOGIN ═══
// ═══════════════════════════════════════════
var resetEmailPending = "";
var resetToken = "";

function hideAllLoginSteps() {
  document.getElementById("loginStep1").style.display = "none";
  document.getElementById("otpWrap").classList.remove("visible");
  document.getElementById("resetStep1").classList.remove("visible");
  document.getElementById("resetStep2").classList.remove("visible");
  document.getElementById("resetStep3").classList.remove("visible");
  document.getElementById("loginSuccess").style.display = "none";
  hideLoginError();
}

function showForgotPassword() {
  hideAllLoginSteps();
  document.getElementById("resetStep1").classList.add("visible");
  document.getElementById("resetEmail").value = document.getElementById("loginEmail").value || "";
  document.getElementById("resetEmail").focus();
}

function backToLoginFromReset() {
  hideAllLoginSteps();
  document.getElementById("loginStep1").style.display = "block";
  document.getElementById("loginPassword").value = "";
  resetEmailPending = "";
  resetToken = "";
}

function submitForgotPassword() {
  var email = (document.getElementById("resetEmail").value || "").trim();
  if (!email) return showLoginError("Please enter your email address");
  var btn = document.getElementById("resetEmailBtn");
  btn.disabled = true; btn.textContent = "Sending...";
  hideLoginError();
  api("POST", "/api/sw/forgot-password", { email: email }).then(function(d) {
    btn.disabled = false; btn.textContent = "Send Verification Code";
    if (d.error) return showLoginError(d.error);
    if (d.otpSent) {
      resetEmailPending = d.email || email;
      hideAllLoginSteps();
      document.getElementById("resetStep2").classList.add("visible");
      document.getElementById("resetOtpEmail").textContent = resetEmailPending;
      document.getElementById("resetOtpInput").value = "";
      document.getElementById("resetOtpInput").focus();
    }
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Send Verification Code";
    showLoginError(e.message || "Something went wrong");
  });
}

function verifyResetOtp() {
  var code = (document.getElementById("resetOtpInput").value || "").trim();
  if (!code || code.length !== 6) return showLoginError("Enter the 6-digit code");
  var btn = document.getElementById("resetOtpBtn");
  btn.disabled = true; btn.textContent = "Verifying...";
  hideLoginError();
  api("POST", "/api/sw/verify-reset-otp", { email: resetEmailPending, code: code }).then(function(d) {
    btn.disabled = false; btn.textContent = "Verify Code";
    if (d.error) {
      if (d.locked) return showLoginError(d.error);
      if (d.expired) {
        showLoginError(d.error);
        document.getElementById("resetResendBtn").style.display = "inline-block";
        return;
      }
      return showLoginError(d.error);
    }
    if (d.verified && d.resetToken) {
      resetToken = d.resetToken;
      hideAllLoginSteps();
      document.getElementById("resetStep3").classList.add("visible");
      document.getElementById("resetNewPw").value = "";
      document.getElementById("resetConfirmPw").value = "";
      document.getElementById("resetPwStrength").classList.remove("visible");
      document.getElementById("resetNewPw").focus();
    }
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Verify Code";
    showLoginError(e.message || "Verification failed");
  });
}

function resendResetOtp() {
  var btn = document.getElementById("resetResendBtn");
  btn.disabled = true; btn.textContent = "Sending...";
  hideLoginError();
  api("POST", "/api/sw/forgot-password", { email: resetEmailPending }).then(function(d) {
    btn.disabled = false; btn.textContent = "Resend Code";
    if (d.error) return showLoginError(d.error);
    document.getElementById("resetOtpInput").value = "";
    document.getElementById("resetOtpInput").focus();
    var el = document.getElementById("loginError");
    el.textContent = "New code sent!";
    el.style.display = "block";
    el.style.background = "rgba(16,185,129,.12)";
    el.style.color = "var(--green)";
    setTimeout(function() { el.style.display = "none"; el.style.background = ""; el.style.color = ""; }, 3000);
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Resend Code";
    showLoginError(e.message || "Failed to resend");
  });
}

function updateResetPwStrength() {
  var pw = document.getElementById("resetNewPw").value;
  var panel = document.getElementById("resetPwStrength");
  if (pw.length === 0) { panel.classList.remove("visible"); return; }
  panel.classList.add("visible");
  var checks = [
    { id: "resetReq12", met: pw.length >= 12 },
    { id: "resetReqUpper", met: /[A-Z]/.test(pw) },
    { id: "resetReqLower", met: /[a-z]/.test(pw) },
    { id: "resetReqNum", met: /[0-9]/.test(pw) },
    { id: "resetReqSpec", met: /[^A-Za-z0-9]/.test(pw) }
  ];
  var metCount = 0;
  checks.forEach(function(c) {
    var el = document.getElementById(c.id);
    if (c.met) { el.classList.add("met"); el.querySelector(".icon").innerHTML = "&#10003;"; metCount++; }
    else { el.classList.remove("met"); el.querySelector(".icon").innerHTML = "&#10005;"; }
  });
  var pct = (metCount / 5) * 100;
  var fill = document.getElementById("resetPwStrengthFill");
  fill.style.width = pct + "%";
  if (metCount <= 1) fill.style.background = "var(--error)";
  else if (metCount <= 2) fill.style.background = "var(--warning)";
  else if (metCount <= 3) fill.style.background = "#EAB308";
  else if (metCount <= 4) fill.style.background = "var(--aqua)";
  else fill.style.background = "var(--green)";
}

function submitSetPassword() {
  var pw = document.getElementById("resetNewPw").value;
  var confirm = document.getElementById("resetConfirmPw").value;
  if (!pw) return showLoginError("Please enter a password");
  if (pw !== confirm) return showLoginError("Passwords do not match");
  var pwOk = pw.length >= 12 && /[A-Z]/.test(pw) && /[a-z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  if (!pwOk) return showLoginError("Password does not meet all requirements");
  var btn = document.getElementById("resetSetPwBtn");
  btn.disabled = true; btn.textContent = "Setting password...";
  hideLoginError();
  api("POST", "/api/sw/set-password", { email: resetEmailPending, resetToken: resetToken, newPassword: pw }).then(function(d) {
    btn.disabled = false; btn.textContent = "Set Password";
    if (d.error) return showLoginError(d.error);
    if (d.success) {
      // Redirect to login with success message
      hideAllLoginSteps();
      document.getElementById("loginStep1").style.display = "block";
      document.getElementById("loginEmail").value = resetEmailPending;
      document.getElementById("loginPassword").value = "";
      resetEmailPending = "";
      resetToken = "";
      var successEl = document.getElementById("loginSuccess");
      successEl.textContent = "Password set successfully. Please log in.";
      successEl.style.display = "block";
    }
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Set Password";
    showLoginError(e.message || "Failed to set password");
  });
}

// ═══════════════════════════════════════════
// ═══ APP ENTRY ═══
// ═══════════════════════════════════════════
function enterApp() {
  document.getElementById("loginWrap").style.display = "none";
  document.getElementById("app").classList.add("active");
  renderTopBar();
  loadShifts();
  loadEnrollments();
  switchPage("pageHome");
}

function renderTopBar() {
  if (!swUser) return;
  var avatarEl = document.getElementById("topAvatar");
  if (swUser.photoUrl) {
    avatarEl.innerHTML = '<img class="avatar" src="' + escHtml(swUser.photoUrl) + '" alt="" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div class="avatar-placeholder" style="display:none">' + escHtml((swUser.name || "?")[0]) + '</div>';
  } else {
    avatarEl.innerHTML = '<div class="avatar-placeholder">' + escHtml((swUser.name || "?")[0]) + '</div>';
  }
  document.getElementById("topName").textContent = swUser.name || swUser.email;
  document.getElementById("topType").textContent = swUser.typeOfEmployment || swUser.contactType || "";
  var badgeEl = document.getElementById("topBadge");
  if (swUser.typeOfEmployment) {
    badgeEl.innerHTML = '<span class="badge" style="background:rgba(0,180,216,.15);color:var(--teal)">' + escHtml(swUser.typeOfEmployment) + '</span>';
  }
}

// ═══════════════════════════════════════════
// ═══ PAGE SWITCHING ═══
// ═══════════════════════════════════════════
function switchPage(pageId) {
  currentPage = pageId;
  document.querySelectorAll(".page").forEach(function(p) { p.classList.remove("active"); });
  document.getElementById(pageId).classList.add("active");
  document.querySelectorAll(".nav-item").forEach(function(n) { n.classList.toggle("active", n.dataset.page === pageId); });
  // Show/hide bottom nav for sub-pages
  var isSubPage = pageId === "pageTraining" || pageId === "pageCourse" || pageId === "pageQuiz" || pageId === "pageDocs";
  document.getElementById("bottomNav").style.display = isSubPage ? "none" : "flex";

  if (pageId === "pageHome") { renderHome(); startTimers(); }
  else if (pageId === "pageShifts") renderAllShifts();
  else if (pageId === "pageNotes") renderNotesForm();
  else if (pageId === "pageIncidents") renderIncidentForm();
  else if (pageId === "pageProfile") renderProfile();
  else if (pageId === "pageTraining") renderTraining();
  else if (pageId === "pageDocs") renderMyDocs();

  // Scroll to top
  document.getElementById("contentArea").scrollTop = 0;
}

// ═══════════════════════════════════════════
// ═══ LOAD DATA ═══
// ═══════════════════════════════════════════
function loadShifts() {
  api("GET", "/api/sw/shifts").then(function(data) {
    allShifts = data || [];
    if (currentPage === "pageHome") renderHome();
    if (currentPage === "pageShifts") renderAllShifts();
  }).catch(function() { allShifts = []; });
}

function loadEnrollments() {
  api("GET", "/api/sw/enrollments").then(function(data) {
    enrollments = data || [];
  }).catch(function() { enrollments = []; });
}

// ═══════════════════════════════════════════
// ═══ HOME PAGE ═══
// ═══════════════════════════════════════════
function renderHome() {
  var today = todayStr();
  var todayShifts = allShifts.filter(function(s) { return dateStr(s.startShift) === today; });
  var upcoming = allShifts.filter(function(s) {
    var d = dateStr(s.startShift);
    var inFuture = d > today;
    var within7 = daysDiff(today, d) <= 7;
    return inFuture && within7;
  }).sort(function(a, b) { return (a.startShift || "").localeCompare(b.startShift || ""); });

  var html = '';

  // Today's Shifts
  html += '<div class="section"><div class="section-title">Today\'s Shifts <span class="count">' + todayShifts.length + '</span></div>';
  if (todayShifts.length === 0) {
    html += '<div class="empty"><div class="icon">&#128197;</div><p>No shifts today</p></div>';
  } else {
    todayShifts.forEach(function(s) { html += renderShiftCard(s, true); });
  }
  html += '</div>';

  // Upcoming Shifts
  html += '<div class="section"><div class="section-title">Upcoming 7 Days <span class="count">' + upcoming.length + '</span></div>';
  if (upcoming.length === 0) {
    html += '<div class="empty"><div class="icon">&#128197;</div><p>No upcoming shifts</p></div>';
  } else {
    upcoming.forEach(function(s) { html += renderShiftCard(s, false); });
  }
  html += '</div>';

  // Training summary
  if (enrollments.length > 0) {
    var overdue = enrollments.filter(function(e) { return getEnrollmentStatus(e) === "overdue"; });
    if (overdue.length > 0) {
      html += '<div class="reminder-banner critical">You have ' + overdue.length + ' overdue training course' + (overdue.length > 1 ? 's' : '') + '</div>';
    }
    html += '<div class="section"><div class="section-title">Training <span class="count">' + enrollments.length + '</span></div>';
    html += '<div class="enrollment-card" onclick="switchPage(\'pageTraining\')" style="text-align:center;padding:16px"><p style="color:var(--teal);font-weight:600;font-size:14px">View Training &rarr;</p></div>';
    html += '</div>';
  }

  document.getElementById("homeContent").innerHTML = html;
}

// ═══════════════════════════════════════════
// ═══ SHIFT CARD RENDERER ═══
// ═══════════════════════════════════════════
function renderShiftCard(s, showClock) {
  var start = parseTime(s.startShift);
  var end = parseTime(s.endShift);
  var statusClass = getStatusBadgeClass(s.shiftStatus);
  var silCasClass = (s.silOrCas || "").toLowerCase().indexOf("sil") >= 0 ? "badge-sil" : "badge-cas";
  var pnIcon = s.progressNoteCompleted ? '<span class="pn-done" title="Progress note done">&#10004;</span>' : '<span class="pn-pending" title="Progress note pending">&#9679;</span>';

  var h = '<div class="shift-card">';
  h += '<div class="shift-row"><span class="shift-client">' + escHtml(s.clientName) + '</span>' + pnIcon + '</div>';
  h += '<div class="shift-row"><span class="shift-time">' + start + ' — ' + end + '</span>';
  h += '<span class="shift-badge ' + statusClass + '">' + escHtml(s.shiftStatus || "Scheduled") + '</span></div>';
  h += '<div class="shift-meta">';
  if (s.totalHoursHMM) h += '<span class="mono">' + escHtml(s.totalHoursHMM) + '</span>';
  if (s.dayType) h += '<span>' + escHtml(s.dayType) + '</span>';
  if (s.silOrCas) h += '<span class="shift-badge ' + silCasClass + '">' + escHtml(s.silOrCas) + '</span>';
  if (s.typeOfShift) h += '<span>' + escHtml(s.typeOfShift) + '</span>';
  if (s.hasSleepover === "Yes" || s.hasSleepover === true) h += '<span>&#127769; Sleepover</span>';
  h += '</div>';

  if (s.startShift) {
    h += '<div class="shift-meta" style="margin-top:4px"><span style="font-size:11px;color:var(--muted)">' + formatDateNice(s.startShift) + '</span></div>';
  }

  // Live shift timer for active shifts
  var status = (s.shiftStatus || "").toLowerCase();
  if (status === "active" && showClock) {
    h += '<div class="live-timer" id="timer_' + escAttr(s.id) + '" data-start="' + escAttr(s.startShift) + '">';
    h += '<div style="display:flex;align-items:center;gap:8px;margin:8px 0 4px">';
    h += '<span class="pulse-dot"></span>';
    h += '<span style="font-size:12px;font-weight:700;color:var(--green)">ACTIVE NOW</span>';
    h += '<span class="timer-display" style="font-family:JetBrains Mono,monospace;font-size:14px;font-weight:700;color:var(--teal);margin-left:auto">--:--:--</span>';
    h += '</div></div>';
  }

  // Clock buttons
  if (showClock) {
    if (status === "completed" || status === "cancelled") {
      // No buttons
    } else if (status === "active") {
      h += '<button class="clock-btn clock-out-btn" onclick="startClock(\'clock-out\',\'' + escAttr(s.id) + '\',\'' + escAttr(s.clientName) + '\')">&#128308; Clock Out</button>';
    } else {
      h += '<button class="clock-btn clock-in-btn" onclick="startClock(\'clock-in\',\'' + escAttr(s.id) + '\',\'' + escAttr(s.clientName) + '\')">&#128994; Clock In</button>';
    }
  }

  // Expandable details
  if (s.supportItemName || s.supportCategoryPACE || s.chargePerHour) {
    h += '<div class="shift-details" style="display:none;margin-top:8px;padding:8px 10px;background:rgba(255,255,255,.03);border:1px solid var(--card-border);border-radius:8px;font-size:12px">';
    if (s.supportItemName) h += '<div style="color:var(--muted);margin-bottom:4px"><strong style="color:var(--text)">Support Item:</strong> ' + escHtml(s.supportItemName) + '</div>';
    if (s.supportCategoryPACE) h += '<div style="color:var(--muted);margin-bottom:4px"><strong style="color:var(--text)">Category:</strong> ' + escHtml(s.supportCategoryPACE) + '</div>';
    if (s.chargePerHour) h += '<div style="color:var(--muted)"><strong style="color:var(--text)">Rate:</strong> $' + escHtml(String(s.chargePerHour)) + '/hr</div>';
    h += '</div>';
    h += '<div style="text-align:center;margin-top:4px"><button onclick="toggleShiftDetails(this)" style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;font-family:inherit;padding:4px 8px">&#9660; Details</button></div>';
  }

  h += '</div>';
  return h;
}

function toggleShiftDetails(btn) {
  var card = btn.closest(".shift-card");
  var details = card.querySelector(".shift-details");
  if (details) {
    var showing = details.style.display !== "none";
    details.style.display = showing ? "none" : "block";
    btn.innerHTML = showing ? "&#9660; Details" : "&#9650; Hide";
  }
}

// Live timer updater
var timerInterval = null;
function startTimers() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(function() {
    document.querySelectorAll(".live-timer").forEach(function(el) {
      var startStr = el.dataset.start;
      if (!startStr) return;
      var startDate = new Date(startStr);
      var now = new Date();
      var diff = Math.max(0, Math.floor((now - startDate) / 1000));
      var hrs = Math.floor(diff / 3600);
      var mins = Math.floor((diff % 3600) / 60);
      var secs = diff % 60;
      var display = el.querySelector(".timer-display");
      if (display) display.textContent = pad2(hrs) + ":" + pad2(mins) + ":" + pad2(secs);
    });
  }, 1000);
}
function pad2(n) { return n < 10 ? "0" + n : String(n); }

// ═══════════════════════════════════════════
// ═══ ALL SHIFTS PAGE ═══
// ═══════════════════════════════════════════
function renderAllShifts() {
  var sorted = allShifts.slice().sort(function(a, b) { return (a.startShift || "").localeCompare(b.startShift || ""); });
  var today = todayStr();
  var pastShifts = sorted.filter(function(s) { return dateStr(s.startShift) < today; });
  var todayShifts = sorted.filter(function(s) { return dateStr(s.startShift) === today; });
  var futureShifts = sorted.filter(function(s) { return dateStr(s.startShift) > today; });

  var html = '';
  if (todayShifts.length > 0) {
    html += '<div class="section"><div class="section-title">Today <span class="count">' + todayShifts.length + '</span></div>';
    todayShifts.forEach(function(s) { html += renderShiftCard(s, true); });
    html += '</div>';
  }
  if (futureShifts.length > 0) {
    html += '<div class="section"><div class="section-title">Upcoming <span class="count">' + futureShifts.length + '</span></div>';
    futureShifts.forEach(function(s) { html += renderShiftCard(s, false); });
    html += '</div>';
  }
  if (pastShifts.length > 0) {
    html += '<div class="section"><div class="section-title">Past Shifts <span class="count">' + pastShifts.length + '</span></div>';
    pastShifts.slice(-20).reverse().forEach(function(s) { html += renderShiftCard(s, false); });
    html += '</div>';
  }
  if (sorted.length === 0) {
    html += '<div class="empty"><div class="icon">&#128197;</div><p>No shifts found</p></div>';
  }
  document.getElementById("shiftsContent").innerHTML = html;
}

// ═══════════════════════════════════════════
// ═══ CLOCK IN / CLOCK OUT ═══
// ═══════════════════════════════════════════
function startClock(action, rosterId, clientName) {
  // Disable the button that was clicked
  event.target.disabled = true;
  event.target.innerHTML = '<div class="spinner"></div> Getting location...';

  if (!navigator.geolocation) {
    alert("GPS not available on this device");
    event.target.disabled = false;
    event.target.innerHTML = action === "clock-in" ? "&#128994; Clock In" : "&#128308; Clock Out";
    return;
  }

  navigator.geolocation.getCurrentPosition(function(pos) {
    var lat = pos.coords.latitude;
    var lng = pos.coords.longitude;
    pendingClock = { action: action, rosterId: rosterId, clientName: clientName, lat: lat, lng: lng };
    submitClock(lat, lng, action, rosterId, clientName, "");
  }, function(err) {
    alert("Location access denied. Please enable GPS and try again.");
    event.target.disabled = false;
    event.target.innerHTML = action === "clock-in" ? "&#128994; Clock In" : "&#128308; Clock Out";
  }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
}

function submitClock(lat, lng, action, rosterId, clientName, overrideReason) {
  api("POST", "/api/sw/clock", {
    action: action, rosterId: rosterId, lat: lat, lng: lng,
    clientName: clientName, overrideReason: overrideReason
  }).then(function(d) {
    if (d.error) { alert(d.error); loadShifts(); return; }
    if (d.allowed === false) {
      // Show override modal with distance
      document.getElementById("overrideDistance").textContent = "You are " + d.distance + " metres from " + clientName + "'s address.";
      document.getElementById("overrideReason").value = "";
      document.getElementById("overrideCharCount").textContent = "0 / 10 min";
      document.getElementById("overrideCharCount").className = "char-count";
      document.getElementById("overrideSubmitBtn").disabled = true;
      document.getElementById("overrideModal").classList.add("show");
      // Show map in override modal if coords available
      if (d.clientLat && d.clientLng) {
        showGeoFenceMap("overrideMapContainer", lat, lng, d.clientLat, d.clientLng, d.distance, false);
      }
      return;
    }
    // Success — show geo confirmation
    showClockSuccessToast(action, clientName, d.distance, d.withinFence, d.overrideUsed);
    loadShifts();
    startTimers();
  }).catch(function(e) {
    alert("Clock failed: " + e.message);
    loadShifts();
  });
}

function showClockSuccessToast(action, clientName, distance, withinFence, overrideUsed) {
  var existing = document.getElementById("clockSuccessToast");
  if (existing) existing.remove();
  var isIn = action === "clock-in";
  var col = isIn ? "var(--green)" : "var(--error)";
  var icon = isIn ? "&#128994;" : "&#128308;";
  var label = isIn ? "Clocked In" : "Clocked Out";
  var distText = distance > 0 ? distance + "m from site" : "";
  var fenceIcon = withinFence ? "&#9989;" : (overrideUsed ? "&#9888;&#65039;" : "&#9989;");

  var toast = document.createElement("div");
  toast.id = "clockSuccessToast";
  toast.style.cssText = "position:fixed;top:0;left:0;right:0;z-index:10000;padding:16px;background:" + (isIn ? "rgba(16,185,129,.95)" : "rgba(239,68,68,.95)") + ";color:#fff;text-align:center;animation:slideDown .3s ease";
  toast.innerHTML = '<div style="font-size:18px;font-weight:800">' + icon + ' ' + label + '</div><div style="font-size:13px;margin-top:4px;opacity:.9">' + escHtml(clientName) + (distText ? ' — ' + fenceIcon + ' ' + distText : '') + '</div>';
  document.body.appendChild(toast);
  setTimeout(function() { toast.style.transition = "opacity .5s"; toast.style.opacity = "0"; setTimeout(function() { toast.remove(); }, 500); }, 3000);
}

function showGeoFenceMap(containerId, workerLat, workerLng, clientLat, clientLng, distance, isWithin) {
  var container = document.getElementById(containerId);
  if (!container || typeof L === "undefined") return;
  container.innerHTML = '<div id="geoMap_' + containerId + '" class="geo-map-container"></div>';
  setTimeout(function() {
    var mapEl = document.getElementById("geoMap_" + containerId);
    if (!mapEl) return;
    var map = L.map(mapEl, { zoomControl: false, attributionControl: false });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    // Client location + 200m radius
    var clientMarker = L.circleMarker([clientLat, clientLng], { radius: 8, color: "#00B4D8", fillColor: "#00B4D8", fillOpacity: 0.8 }).addTo(map);
    clientMarker.bindTooltip("Client", { permanent: true, direction: "top", offset: [0, -10] });
    L.circle([clientLat, clientLng], { radius: 200, color: "#00B4D8", fillColor: "#00B4D8", fillOpacity: 0.08, weight: 2, dashArray: "6 4" }).addTo(map);
    // Worker location
    var wCol = isWithin ? "#10B981" : "#EF4444";
    var workerMarker = L.circleMarker([workerLat, workerLng], { radius: 8, color: wCol, fillColor: wCol, fillOpacity: 0.8 }).addTo(map);
    workerMarker.bindTooltip("You", { permanent: true, direction: "top", offset: [0, -10] });
    // Fit bounds
    var bounds = L.latLngBounds([[clientLat, clientLng], [workerLat, workerLng]]);
    map.fitBounds(bounds.pad(0.3));
  }, 100);
}

// Override reason character tracking
document.getElementById("overrideReason").addEventListener("input", function() {
  var len = this.value.trim().length;
  var countEl = document.getElementById("overrideCharCount");
  countEl.textContent = len + " / 10 min";
  countEl.className = "char-count" + (len >= 10 ? " ok" : "");
  document.getElementById("overrideSubmitBtn").disabled = len < 10;
});

function submitOverride() {
  if (!pendingClock) return;
  var reason = document.getElementById("overrideReason").value.trim();
  if (reason.length < 10) return;
  closeOverrideModal();
  submitClock(pendingClock.lat, pendingClock.lng, pendingClock.action, pendingClock.rosterId, pendingClock.clientName, reason);
}

function closeOverrideModal() {
  document.getElementById("overrideModal").classList.remove("show");
}

// ═══════════════════════════════════════════
// ═══ PROGRESS NOTES FORM ═══
// ═══════════════════════════════════════════
function renderNotesForm() {
  var todayShifts = allShifts.filter(function(s) {
    var d = dateStr(s.startShift);
    var today = todayStr();
    return daysDiff(d, today) <= 7; // last 7 days + today + future
  }).sort(function(a, b) { return (b.startShift || "").localeCompare(a.startShift || ""); });

  var shiftOptions = todayShifts.map(function(s) {
    return '<option value="' + escAttr(s.id) + '" data-client="' + escAttr(s.clientName) + '" data-start="' + escAttr(s.startShift) + '" data-end="' + escAttr(s.endShift) + '" data-hours="' + (s.totalHoursDecimal || 0) + '">' + escHtml(s.clientName) + ' — ' + formatDateNice(s.startShift) + '</option>';
  }).join("");

  var html = '<div class="section">';
  html += '<div class="section-title">Submit Progress Note</div>';

  html += '<div class="form-group"><label>Select Shift</label>';
  html += '<select id="noteShift" onchange="onNoteShiftChange()">';
  html += '<option value="">-- Select a shift --</option>' + shiftOptions;
  html += '</select></div>';

  html += '<div class="form-group"><label>Client Name</label>';
  html += '<input type="text" id="noteClient" readonly placeholder="Auto-filled from shift"></div>';

  html += '<div class="form-group"><label>Date / Time</label>';
  html += '<input type="text" id="noteDateTime" readonly></div>';

  html += '<div class="form-group"><label>Notes (min 50 characters)</label>';
  html += '<textarea id="noteText" rows="5" placeholder="Describe what happened during the shift, client wellbeing, activities completed..." oninput="updateNoteCharCount()"></textarea>';
  html += '<div class="char-count" id="noteCharCount">0 / 50 min</div></div>';

  html += '<button class="submit-btn" id="noteSubmitBtn" onclick="submitNote()">Submit Progress Note</button>';
  html += '<div class="form-status" id="noteStatus"></div>';
  html += '</div>';

  document.getElementById("notesContent").innerHTML = html;
  document.getElementById("noteDateTime").value = new Date().toLocaleString("en-AU");
}

function onNoteShiftChange() {
  var sel = document.getElementById("noteShift");
  var opt = sel.options[sel.selectedIndex];
  if (opt && opt.dataset.client) {
    document.getElementById("noteClient").value = opt.dataset.client;
  }
}

function updateNoteCharCount() {
  var len = (document.getElementById("noteText").value || "").length;
  var el = document.getElementById("noteCharCount");
  el.textContent = len + " / 50 min";
  el.className = "char-count" + (len >= 50 ? " ok" : "");
}

function submitNote() {
  var shiftSel = document.getElementById("noteShift");
  var rosterId = shiftSel.value;
  var clientName = document.getElementById("noteClient").value.trim();
  var notes = document.getElementById("noteText").value.trim();

  if (!clientName) return showNoteStatus("error", "Please select a shift");
  if (notes.length < 50) return showNoteStatus("error", "Notes must be at least 50 characters (" + notes.length + " entered)");

  var opt = shiftSel.options[shiftSel.selectedIndex];
  var startDT = opt ? opt.dataset.start : new Date().toISOString();
  var endDT = opt ? opt.dataset.end : new Date().toISOString();
  var hours = opt ? parseFloat(opt.dataset.hours || 0) : 0;

  var btn = document.getElementById("noteSubmitBtn");
  btn.disabled = true; btn.textContent = "Submitting...";
  hideNoteStatus();

  api("POST", "/api/sw/progress-note", {
    rosterId: rosterId, clientName: clientName, notes: notes,
    startDateTime: startDT, endDateTime: endDT, totalHours: hours
  }).then(function(d) {
    btn.disabled = false; btn.textContent = "Submit Progress Note";
    if (d.error) return showNoteStatus("error", d.error);
    showNoteStatus("success", "Progress note submitted successfully!");
    document.getElementById("noteText").value = "";
    updateNoteCharCount();
    loadShifts(); // refresh to update progress note flag
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Submit Progress Note";
    showNoteStatus("error", e.message || "Failed to submit");
  });
}

function showNoteStatus(type, msg) {
  var el = document.getElementById("noteStatus");
  el.className = "form-status " + type;
  el.textContent = msg;
  el.style.display = "block";
}
function hideNoteStatus() { document.getElementById("noteStatus").style.display = "none"; }

// ═══════════════════════════════════════════
// ═══ INCIDENT REPORT FORM ═══
// ═══════════════════════════════════════════
function renderIncidentForm() {
  var shiftOptions = allShifts.map(function(s) {
    return '<option value="' + escAttr(s.clientName) + '">' + escHtml(s.clientName) + ' — ' + formatDateNice(s.startShift) + '</option>';
  }).join("");

  var html = '<div class="section">';
  html += '<div class="section-title">Report Incident</div>';

  html += '<div class="form-group"><label>Client Name</label>';
  html += '<select id="incidentClient" onchange="onIncidentClientChange()">';
  html += '<option value="">-- Select client or type below --</option>' + shiftOptions;
  html += '</select></div>';

  html += '<div class="form-group"><label>Or type client name</label>';
  html += '<input type="text" id="incidentClientText" placeholder="Client name"></div>';

  html += '<div class="form-group"><label>Date & Time of Incident</label>';
  html += '<input type="datetime-local" id="incidentDateTime" value="' + localISOString() + '"></div>';

  html += '<div class="form-group"><label>Severity</label>';
  html += '<select id="incidentSeverity">';
  html += '<option value="">-- Select severity --</option>';
  html += '<option value="Low">Low</option><option value="Medium">Medium</option>';
  html += '<option value="High">High</option><option value="Critical">Critical</option>';
  html += '</select></div>';

  html += '<div class="form-group"><label>Description (min 50 characters)</label>';
  html += '<textarea id="incidentDesc" rows="5" placeholder="Describe what happened in detail..." oninput="updateIncidentCharCount()"></textarea>';
  html += '<div class="char-count" id="incidentCharCount">0 / 50 min</div></div>';

  html += '<button class="submit-btn" id="incidentSubmitBtn" onclick="submitIncident()">Submit Incident Report</button>';
  html += '<div class="form-status" id="incidentStatus"></div>';
  html += '</div>';

  document.getElementById("incidentsContent").innerHTML = html;
}

function onIncidentClientChange() {
  var val = document.getElementById("incidentClient").value;
  if (val) document.getElementById("incidentClientText").value = val;
}

function updateIncidentCharCount() {
  var len = (document.getElementById("incidentDesc").value || "").length;
  var el = document.getElementById("incidentCharCount");
  el.textContent = len + " / 50 min";
  el.className = "char-count" + (len >= 50 ? " ok" : "");
}

function submitIncident() {
  var clientName = document.getElementById("incidentClientText").value.trim() || document.getElementById("incidentClient").value;
  var dateTime = document.getElementById("incidentDateTime").value;
  var severity = document.getElementById("incidentSeverity").value;
  var desc = document.getElementById("incidentDesc").value.trim();

  if (!clientName) return showIncidentStatus("error", "Please select or enter a client name");
  if (!severity) return showIncidentStatus("error", "Please select a severity level");
  if (desc.length < 50) return showIncidentStatus("error", "Description must be at least 50 characters (" + desc.length + " entered)");

  var btn = document.getElementById("incidentSubmitBtn");
  btn.disabled = true; btn.textContent = "Submitting...";
  hideIncidentStatus();

  api("POST", "/api/sw/incident", {
    clientName: clientName, dateTime: dateTime || new Date().toISOString(),
    severity: severity, description: desc
  }).then(function(d) {
    btn.disabled = false; btn.textContent = "Submit Incident Report";
    if (d.error) return showIncidentStatus("error", d.error);

    var msg = "Incident report submitted successfully!";
    if (d.severity === "High" || d.severity === "Critical") {
      msg += "\n\nIMPORTANT: This is a " + d.severity + " severity incident. Please call your Team Leader immediately.";
      showIncidentStatus("error", msg);
    } else {
      showIncidentStatus("success", msg);
    }
    document.getElementById("incidentDesc").value = "";
    updateIncidentCharCount();
  }).catch(function(e) {
    btn.disabled = false; btn.textContent = "Submit Incident Report";
    showIncidentStatus("error", e.message || "Failed to submit");
  });
}

function showIncidentStatus(type, msg) {
  var el = document.getElementById("incidentStatus");
  el.className = "form-status " + type;
  el.textContent = msg;
  el.style.display = "block";
}
function hideIncidentStatus() { document.getElementById("incidentStatus").style.display = "none"; }

// ═══════════════════════════════════════════
// ═══ PROFILE PAGE ═══
// ═══════════════════════════════════════════
function renderProfile() {
  if (!swUser) return;
  var html = '<div class="profile-section">';

  // Header with photo
  html += '<div class="profile-header">';
  if (swUser.photoUrl) {
    html += '<img class="profile-avatar" src="' + escHtml(swUser.photoUrl) + '" alt="" onerror="this.style.display=\'none\'">';
  } else {
    html += '<div class="profile-avatar-placeholder">' + escHtml((swUser.name || "?")[0]) + '</div>';
  }
  html += '<h2>' + escHtml(swUser.name || "") + '</h2>';
  html += '<p>' + escHtml(swUser.typeOfEmployment || swUser.contactType || "") + '</p>';
  html += '</div>';

  // Info items
  html += profileItem("Email", swUser.email);
  html += profileItem("Phone", swUser.phone || "—");
  html += profileItem("Employment Type", swUser.typeOfEmployment || "—");
  html += profileItem("Contact Type", swUser.contactType || "—");
  html += profileItem("Total Shifts", String(allShifts.length));

  // Training link
  html += '<div class="profile-item" onclick="switchPage(\'pageTraining\')" style="cursor:pointer">';
  html += '<span class="label">Training Courses</span>';
  html += '<span class="value" style="color:var(--teal)">' + enrollments.length + ' enrolled &rarr;</span>';
  html += '</div>';

  // My Documents link
  html += '<div class="profile-item" onclick="switchPage(\'pageDocs\')" style="cursor:pointer">';
  html += '<span class="label">My Documents</span>';
  html += '<span class="value" style="color:var(--teal)">View &rarr;</span>';
  html += '</div>';

  // Change password
  html += '<div class="profile-item" onclick="showChangePassword()" style="cursor:pointer">';
  html += '<span class="label">Change Password</span>';
  html += '<span class="value" style="color:var(--teal)">&rarr;</span>';
  html += '</div>';
  html += '<div id="changePasswordForm" style="display:none;margin-top:8px">';
  html += '<div class="form-group"><label>Current Password</label><input type="password" id="cpCurrent"></div>';
  html += '<div class="form-group"><label>New Password</label><input type="password" id="cpNew" oninput="updateCpStrength()">';
  html += '<div class="pw-strength" id="cpStrength"><div class="pw-strength-bar"><div class="fill" id="cpStrengthFill"></div></div>';
  html += '<ul class="pw-reqs"><li id="cpReq12"><span class="icon">&#10005;</span> 12+ characters</li>';
  html += '<li id="cpReqUpper"><span class="icon">&#10005;</span> Uppercase letter</li>';
  html += '<li id="cpReqLower"><span class="icon">&#10005;</span> Lowercase letter</li>';
  html += '<li id="cpReqNum"><span class="icon">&#10005;</span> Number</li>';
  html += '<li id="cpReqSpec"><span class="icon">&#10005;</span> Special character</li></ul></div></div>';
  html += '<button class="submit-btn" onclick="changePassword()" style="margin-bottom:8px">Update Password</button>';
  html += '<div class="form-status" id="cpStatus"></div>';
  html += '</div>';

  html += '<button class="logout-btn" onclick="doLogout()">Sign Out</button>';
  html += '</div>';
  document.getElementById("profileContent").innerHTML = html;
}

function profileItem(label, value) {
  return '<div class="profile-item"><span class="label">' + escHtml(label) + '</span><span class="value">' + escHtml(value) + '</span></div>';
}

function showChangePassword() {
  var form = document.getElementById("changePasswordForm");
  form.style.display = form.style.display === "none" ? "block" : "none";
}

function updateCpStrength() {
  var pw = document.getElementById("cpNew").value;
  var panel = document.getElementById("cpStrength");
  if (pw.length === 0) { panel.classList.remove("visible"); return; }
  panel.classList.add("visible");
  var checks = [
    { id: "cpReq12", met: pw.length >= 12 },
    { id: "cpReqUpper", met: /[A-Z]/.test(pw) },
    { id: "cpReqLower", met: /[a-z]/.test(pw) },
    { id: "cpReqNum", met: /[0-9]/.test(pw) },
    { id: "cpReqSpec", met: /[^A-Za-z0-9]/.test(pw) }
  ];
  var metCount = 0;
  checks.forEach(function(c) {
    var el = document.getElementById(c.id);
    if (c.met) { el.classList.add("met"); el.querySelector(".icon").innerHTML = "&#10003;"; metCount++; }
    else { el.classList.remove("met"); el.querySelector(".icon").innerHTML = "&#10005;"; }
  });
  var pct = (metCount / 5) * 100;
  var fill = document.getElementById("cpStrengthFill");
  fill.style.width = pct + "%";
  if (metCount <= 1) fill.style.background = "var(--error)";
  else if (metCount <= 2) fill.style.background = "var(--warning)";
  else if (metCount <= 3) fill.style.background = "#EAB308";
  else if (metCount <= 4) fill.style.background = "var(--aqua)";
  else fill.style.background = "var(--green)";
}

function changePassword() {
  var cur = document.getElementById("cpCurrent").value;
  var nw = document.getElementById("cpNew").value;
  if (!cur || !nw) return;
  // Client-side validation
  var pwOk = nw.length >= 12 && /[A-Z]/.test(nw) && /[a-z]/.test(nw) && /[0-9]/.test(nw) && /[^A-Za-z0-9]/.test(nw);
  if (!pwOk) {
    var el = document.getElementById("cpStatus");
    el.className = "form-status error"; el.textContent = "Password does not meet all requirements"; el.style.display = "block";
    return;
  }
  api("POST", "/api/sw/change-password", { currentPassword: cur, newPassword: nw }).then(function(d) {
    var el = document.getElementById("cpStatus");
    if (d.error) { el.className = "form-status error"; el.textContent = d.error; el.style.display = "block"; }
    else { el.className = "form-status success"; el.textContent = "Password updated!"; el.style.display = "block";
      document.getElementById("cpCurrent").value = "";
      document.getElementById("cpNew").value = "";
      document.getElementById("cpStrength").classList.remove("visible");
    }
  });
}

// ═══════════════════════════════════════════
// ═══ MY DOCUMENTS PAGE ═══
// ═══════════════════════════════════════════
function renderMyDocs() {
  var html = '<div class="section">';
  html += '<button class="back-btn" onclick="switchPage(\'pageProfile\')">&larr; Back to Profile</button>';
  html += '<div class="section-title">My Documents</div>';

  // Compliance documents status
  var docs = [
    { name: "First Aid Certificate", field: "firstAidExpiry", icon: "&#129657;" },
    { name: "CPR Certificate", field: "cprExpiry", icon: "&#10084;&#65039;" },
    { name: "NDIS Worker Screening", field: "ndisExpiry", icon: "&#128737;&#65039;" },
    { name: "WWCC / Blue Card", field: "wwccExpiry", icon: "&#128196;" },
    { name: "Driver's Licence", field: "driversLicenseExpiry", icon: "&#128663;" },
    { name: "Car Insurance", field: "insuranceExpiry", icon: "&#128663;" },
    { name: "Police Check", field: "policeCheckExpiry", icon: "&#128274;" }
  ];

  var now = new Date();
  var valid = 0, expiring = 0, expired = 0, missing = 0;
  docs.forEach(function(d) {
    var val = swUser[d.field] || "";
    if (!val) { missing++; d.status = "missing"; d.statusLabel = "Not on file"; d.statusCol = "#6B7280"; }
    else {
      var exp = new Date(val);
      var daysLeft = Math.ceil((exp - now) / 86400000);
      if (daysLeft < 0) { expired++; d.status = "expired"; d.statusLabel = "Expired"; d.statusCol = "#EF4444"; }
      else if (daysLeft <= 30) { expiring++; d.status = "expiring"; d.statusLabel = "Expires in " + daysLeft + " days"; d.statusCol = "#F59E0B"; }
      else { valid++; d.status = "valid"; d.statusLabel = "Valid until " + formatDateShort(val); d.statusCol = "#10B981"; }
    }
  });

  // Summary
  html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">';
  html += '<div style="text-align:center;padding:12px 4px;background:rgba(16,185,129,.1);border-radius:10px"><div style="font-size:20px;font-weight:800;color:var(--green)">' + valid + '</div><div style="font-size:9px;color:var(--muted);font-weight:600">Valid</div></div>';
  html += '<div style="text-align:center;padding:12px 4px;background:rgba(245,158,11,.1);border-radius:10px"><div style="font-size:20px;font-weight:800;color:var(--warning)">' + expiring + '</div><div style="font-size:9px;color:var(--muted);font-weight:600">Expiring</div></div>';
  html += '<div style="text-align:center;padding:12px 4px;background:rgba(239,68,68,.1);border-radius:10px"><div style="font-size:20px;font-weight:800;color:var(--error)">' + expired + '</div><div style="font-size:9px;color:var(--muted);font-weight:600">Expired</div></div>';
  html += '<div style="text-align:center;padding:12px 4px;background:rgba(107,114,128,.1);border-radius:10px"><div style="font-size:20px;font-weight:800;color:var(--muted)">' + missing + '</div><div style="font-size:9px;color:var(--muted);font-weight:600">Missing</div></div>';
  html += '</div>';

  // Document cards
  docs.forEach(function(d) {
    html += '<div style="background:var(--card);border:1px solid var(--card-border);border-left:3px solid ' + d.statusCol + ';border-radius:10px;padding:14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">';
    html += '<div><div style="font-size:14px;font-weight:600">' + d.icon + ' ' + d.name + '</div>';
    html += '<div style="font-size:11px;color:' + d.statusCol + ';font-weight:600;margin-top:2px">' + d.statusLabel + '</div></div>';
    if (d.status === "expired" || d.status === "missing" || d.status === "expiring") {
      html += '<label style="padding:8px 12px;background:linear-gradient(135deg,var(--teal),var(--royal));color:#fff;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer"><input type="file" accept="image/*,.pdf" style="display:none" onchange="uploadComplianceDoc(\'' + escAttr(d.name) + '\', this)">Upload</label>';
    } else {
      html += '<span style="font-size:18px">&#9989;</span>';
    }
    html += '</div>';
  });

  // Upload instructions
  html += '<div style="padding:12px;background:rgba(0,180,216,.06);border:1px solid rgba(0,180,216,.15);border-radius:10px;margin-top:12px;font-size:12px;color:var(--muted);line-height:1.5">';
  html += '<strong style="color:var(--teal)">Need to update a document?</strong><br>Upload a photo or PDF of your updated certificate. Your team leader will review and verify it.';
  html += '</div>';

  html += '</div>';
  document.getElementById("docsContent").innerHTML = html;
}

function formatDateShort(d) {
  try { var dt = new Date(d); return ("0" + dt.getDate()).slice(-2) + "/" + ("0" + (dt.getMonth() + 1)).slice(-2) + "/" + dt.getFullYear(); }
  catch(e) { return d; }
}

function uploadComplianceDoc(docName, input) {
  if (!input.files || !input.files[0]) return;
  var file = input.files[0];
  if (file.size > 10 * 1024 * 1024) { alert("File too large (max 10MB)"); return; }
  var reader = new FileReader();
  reader.onload = function() {
    var base64 = reader.result.split(",")[1];
    api("POST", "/api/sw/upload-doc", {
      docName: docName, fileName: file.name, fileType: file.type, fileData: base64
    }).then(function(d) {
      if (d.error) { alert("Upload failed: " + d.error); return; }
      alert("Document uploaded! Your team leader will review it.");
      renderMyDocs();
    }).catch(function(e) { alert("Upload failed: " + e.message); });
  };
  reader.readAsDataURL(file);
}

// ═══════════════════════════════════════════
// ═══ TRAINING PAGE ═══
// ═══════════════════════════════════════════
function renderTraining() {
  var html = '<div class="section">';
  html += '<button class="back-btn" onclick="switchPage(\'pageProfile\')">&larr; Back to Profile</button>';
  html += '<div class="section-title">My Training <span class="count">' + enrollments.length + '</span></div>';

  if (enrollments.length === 0) {
    html += '<div class="empty"><div class="icon">&#127891;</div><p>No training courses enrolled</p></div>';
  } else {
    enrollments.forEach(function(e) {
      var status = getEnrollmentStatus(e);
      var statusClass = "status-" + status.replace(" ", "-").toLowerCase();
      var statusLabel = status.charAt(0).toUpperCase() + status.slice(1).replace("-", " ");
      var pct = Math.round((e.progress || 0) * 100);
      var barColor = status === "completed" ? "var(--green)" : status === "overdue" ? "var(--error)" : status === "in-progress" ? "var(--warning)" : "var(--muted)";

      html += '<div class="enrollment-card" onclick="openCourse(\'' + escAttr(e.courseId) + '\',\'' + escAttr(e.enrollmentId) + '\')">';
      html += '<div style="display:flex;justify-content:space-between;align-items:start;gap:8px">';
      html += '<h4 style="flex:1">' + escHtml(e.courseName || "Unnamed Course") + '</h4>';
      html += '<span class="status-badge ' + statusClass + '">' + escHtml(statusLabel) + '</span>';
      html += '</div>';
      html += '<div class="progress-bar"><div class="fill" style="width:' + pct + '%;background:' + barColor + '"></div></div>';
      html += '<div class="shift-meta"><span>' + pct + '% complete</span>';
      if (e.enrolledDate) html += '<span>Enrolled: ' + formatDateNice(e.enrolledDate) + '</span>';
      if (e.courseExpiry) html += '<span>Expires: ' + formatDateNice(e.courseExpiry) + '</span>';
      html += '</div>';
      html += '</div>';
    });
  }
  html += '</div>';
  document.getElementById("trainingContent").innerHTML = html;
}

function getEnrollmentStatus(e) {
  var progress = parseFloat(e.progress || 0);
  if (progress >= 1) return "completed";
  if (e.courseExpiry) {
    var expiry = new Date(e.courseExpiry);
    if (expiry < new Date() && progress < 1) return "overdue";
  }
  if (progress > 0) return "in-progress";
  return "not-started";
}

// ═══════════════════════════════════════════
// ═══ COURSE PLAYER ═══
// ═══════════════════════════════════════════
var currentCourseId = "";
var currentEnrollmentId = "";
var courseData = null;

function openCourse(courseId, enrollmentId) {
  currentCourseId = courseId;
  currentEnrollmentId = enrollmentId;
  switchPage("pageCourse");
  document.getElementById("courseContent").innerHTML = '<div class="loading-center"><div class="spinner"></div></div>';

  api("GET", "/api/sw/course-detail?id=" + encodeURIComponent(courseId)).then(function(data) {
    courseData = data;
    renderCoursePlayer();
  }).catch(function(e) {
    document.getElementById("courseContent").innerHTML = '<div class="section"><div class="empty"><p>Failed to load course</p></div></div>';
  });
}

function renderCoursePlayer() {
  if (!courseData) return;
  var html = '<div class="course-player">';
  html += '<button class="back-btn" onclick="switchPage(\'pageTraining\')">&larr; Back to Training</button>';

  var modules = courseData.modules || [];
  if (modules.length === 0) {
    html += '<div class="empty"><div class="icon">&#128218;</div><p>No modules in this course</p></div>';
  }

  modules.forEach(function(mod, mi) {
    html += '<div class="module-card">';
    html += '<div class="module-header" onclick="toggleModule(this)"><h4>Module ' + (mi + 1) + ': ' + escHtml(mod.name) + '</h4><span style="color:var(--muted)">' + (mod.lessons || []).length + ' lessons</span></div>';
    html += '<div class="module-body' + (mi === 0 ? ' open' : '') + '">';

    if (mod.description) {
      html += '<p style="font-size:12px;color:var(--muted);margin-bottom:10px">' + escHtml(mod.description) + '</p>';
    }

    (mod.lessons || []).forEach(function(lesson) {
      html += '<div class="lesson-item">';
      html += '<h5><span class="lesson-type">' + escHtml(lesson.type || "Content") + '</span> ' + escHtml(lesson.name) + '</h5>';

      if (lesson.type === "Video" && lesson.videoUrl) {
        html += '<video class="lesson-video" controls preload="metadata"><source src="' + escAttr(lesson.videoUrl) + '">Your browser does not support video.</video>';
      }
      if (lesson.content) {
        html += '<div class="lesson-content">' + escHtml(lesson.content) + '</div>';
      }
      if (lesson.attachments && lesson.attachments.length > 0) {
        lesson.attachments.forEach(function(att) {
          html += '<a class="lesson-attachment" href="' + escAttr(att.url) + '" target="_blank" rel="noopener">&#128206; ' + escHtml(att.name || "Download") + '</a>';
        });
      }
      html += '</div>';
    });

    html += '</div></div>';
  });

  // Quiz button
  if (courseData.quiz) {
    html += '<button class="submit-btn" onclick="openQuiz()" style="margin-top:12px">Take Quiz: ' + escHtml(courseData.quiz.name || "Course Quiz") + '</button>';
  }

  html += '</div>';
  document.getElementById("courseContent").innerHTML = html;
}

function toggleModule(el) {
  var body = el.nextElementSibling;
  body.classList.toggle("open");
}

// ═══════════════════════════════════════════
// ═══ QUIZ ═══
// ═══════════════════════════════════════════
var quizAnswers = {};

function openQuiz() {
  if (!courseData || !courseData.quiz) return;
  quizAnswers = {};
  switchPage("pageQuiz");
  renderQuiz();
}

function renderQuiz() {
  var quiz = courseData.quiz;
  var html = '<div class="quiz-wrap">';
  html += '<button class="back-btn" onclick="switchPage(\'pageCourse\')">&larr; Back to Course</button>';
  html += '<div class="section-title">' + escHtml(quiz.name || "Quiz") + '</div>';
  html += '<p style="font-size:13px;color:var(--muted);margin-bottom:16px">Pass mark: ' + (quiz.passPercentage || 100) + '%</p>';

  (quiz.questions || []).forEach(function(q, qi) {
    html += '<div class="quiz-question"><h4>Q' + (qi + 1) + ': ' + escHtml(q.question) + '</h4>';
    (q.options || []).forEach(function(opt, oi) {
      var isSelected = quizAnswers[q.id] === oi;
      html += '<div class="quiz-option' + (isSelected ? ' selected' : '') + '" onclick="selectQuizAnswer(\'' + escAttr(q.id) + '\',' + oi + ')">';
      html += '<div class="radio"></div><span>' + escHtml(opt) + '</span>';
      html += '</div>';
    });
    html += '</div>';
  });

  html += '<button class="submit-btn" onclick="submitQuiz()">Submit Quiz</button>';
  html += '<div id="quizResult" style="margin-top:12px"></div>';
  html += '</div>';
  document.getElementById("quizContent").innerHTML = html;
}

function selectQuizAnswer(questionId, optionIndex) {
  quizAnswers[questionId] = optionIndex;
  renderQuiz();
}

function submitQuiz() {
  var quiz = courseData.quiz;
  var questions = quiz.questions || [];
  if (Object.keys(quizAnswers).length < questions.length) {
    alert("Please answer all questions before submitting.");
    return;
  }

  var correct = 0;
  questions.forEach(function(q) {
    var selected = quizAnswers[q.id];
    // correctAnswer is 1-indexed from Airtable
    if (selected === (q.correctAnswer - 1)) correct++;
  });

  var score = Math.round((correct / questions.length) * 100);
  var passPct = quiz.passPercentage || 100;
  var passed = score >= passPct;

  // Calculate progress: if passed, update
  var totalLessons = 0;
  (courseData.modules || []).forEach(function(m) { totalLessons += (m.lessons || []).length; });
  var completedLessons = totalLessons; // Consider all lessons complete if quiz passed
  var progress = totalLessons > 0 ? completedLessons / totalLessons : 1;

  var resultEl = document.getElementById("quizResult");
  if (passed) {
    resultEl.innerHTML = '<div class="quiz-result pass"><div class="score">' + score + '%</div><p>Congratulations! You passed!</p></div>';
    // Update progress in Airtable
    api("POST", "/api/sw/quiz-submit", {
      enrollmentId: currentEnrollmentId, score: score, passed: true, progress: progress
    }).then(function() {
      loadEnrollments();
    });
  } else {
    resultEl.innerHTML = '<div class="quiz-result fail"><div class="score">' + score + '%</div><p>Score: ' + correct + '/' + questions.length + '. You need ' + passPct + '% to pass. You can retry.</p></div>';
    api("POST", "/api/sw/quiz-submit", { enrollmentId: currentEnrollmentId, score: score, passed: false });
  }
}

// ═══════════════════════════════════════════
// ═══ UTILITY FUNCTIONS ═══
// ═══════════════════════════════════════════
function escHtml(s) {
  if (!s) return "";
  var div = document.createElement("div");
  div.textContent = String(s);
  return div.innerHTML;
}
function escAttr(s) {
  return escHtml(s).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
}
function todayStr() {
  var d = new Date();
  return d.getFullYear() + "-" + pad2(d.getMonth() + 1) + "-" + pad2(d.getDate());
}
function dateStr(iso) {
  if (!iso) return "";
  return iso.substring(0, 10);
}
function pad2(n) { return n < 10 ? "0" + n : String(n); }
function daysDiff(d1, d2) {
  var a = new Date(d1); var b = new Date(d2);
  return Math.round(Math.abs((b - a) / 86400000));
}
function parseTime(iso) {
  if (!iso) return "--:--";
  var d = new Date(iso);
  if (isNaN(d.getTime())) {
    // Try extracting time from string
    var m = (iso || "").match(/(\d{1,2}):(\d{2})/);
    return m ? m[0] : "--:--";
  }
  return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
}
function formatDateNice(iso) {
  if (!iso) return "";
  var d = new Date(iso);
  if (isNaN(d.getTime())) return iso.substring(0, 10);
  var days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return days[d.getDay()] + " " + d.getDate() + " " + months[d.getMonth()];
}
function localISOString() {
  var d = new Date();
  var offset = d.getTimezoneOffset();
  var local = new Date(d.getTime() - offset * 60000);
  return local.toISOString().slice(0, 16);
}
function getStatusBadgeClass(status) {
  if (!status) return "badge-scheduled";
  var s = status.toLowerCase();
  if (s === "active" || s === "in progress") return "badge-active";
  if (s === "completed" || s === "done") return "badge-completed";
  if (s === "cancelled" || s === "canceled") return "badge-cancelled";
  if (s === "draft") return "badge-draft";
  return "badge-scheduled";
}

// ═══════════════════════════════════════════
// ═══ INIT ═══
// ═══════════════════════════════════════════
(function init() {
  // Register service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(function(e) {
      console.log("SW registration failed:", e);
    });
  }

  // Check for existing session
  if (swToken && swUser) {
    // Verify session is still valid
    api("GET", "/api/sw/me").then(function(d) {
      if (d.user) {
        swUser = d.user;
        localStorage.setItem("sw_user", JSON.stringify(swUser));
        enterApp();
      } else {
        doLogout();
      }
    }).catch(function() {
      // Offline? Use cached data
      if (swUser) enterApp();
    });
  }
})();
</script>
</body>
</html>
