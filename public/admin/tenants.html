<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tenant Manager - Titus CRM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect rx='20' width='100' height='100' fill='%230f172a'/><path d='M25 70V35l25-15 25 15v35' stroke='%2314b8a6' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/><rect x='38' y='48' width='24' height='22' rx='2' stroke='%2314b8a6' stroke-width='5' fill='none'/></svg>">
<style>
:root {
  --teal: #0d9488;
  --teal-light: #14b8a6;
  --teal-dark: #0f766e;
  --teal-bg: #f0fdfa;
  --navy: #0f172a;
  --navy-light: #1e293b;
  --navy-mid: #334155;
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #0f172a;
  --text-secondary: #64748b;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --green: #059669;
  --green-bg: #d1fae5;
  --amber: #d97706;
  --amber-bg: #fef3c7;
  --red: #dc2626;
  --red-bg: #fee2e2;
  --blue: #2563eb;
  --blue-bg: #dbeafe;
  --purple: #7c3aed;
  --purple-bg: #ede9fe;
  --radius: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,.06), 0 4px 16px rgba(0,0,0,.04);
  --shadow-lg: 0 8px 32px rgba(0,0,0,.12);
  --transition: 200ms ease;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* Header */
.header {
  background: var(--navy);
  padding: 0 24px;
  display: flex;
  align-items: center;
  height: 60px;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-logo {
  width: 36px;
  height: 36px;
  background: var(--teal);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.header-logo svg { width: 20px; height: 20px; }
.header-text {
  flex: 1;
}
.header-text h1 {
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  letter-spacing: -0.3px;
}
.header-text p {
  font-size: 10px;
  color: rgba(255,255,255,.4);
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}
.header-user {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(255,255,255,.06);
  border-radius: 8px;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
}
.header-user svg { width: 16px; height: 16px; opacity: 0.6; }

/* Container */
.container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 24px;
}

/* Stats row */
.stats-row {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 18px;
  display: flex;
  align-items: flex-start;
  gap: 14px;
}
.stat-icon {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.stat-icon svg { width: 20px; height: 20px; }
.stat-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.stat-value {
  font-size: 26px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.5px;
  line-height: 1.2;
}
.stat-sub {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Card */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}
.card-header-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.card-header-icon svg { width: 16px; height: 16px; }
.card-header h2 {
  font-size: 15px;
  font-weight: 700;
  flex: 1;
}
.card-body { padding: 20px; }

/* Toolbar */
.toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.search-box {
  flex: 1;
  min-width: 200px;
  position: relative;
}
.search-box svg {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  color: var(--text-secondary);
}
.search-box input {
  width: 100%;
  padding: 9px 12px 9px 36px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  font-family: inherit;
  color: var(--text);
  transition: border-color var(--transition);
}
.search-box input:focus { outline: none; border-color: var(--teal); }
.filter-select {
  padding: 9px 14px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  font-family: inherit;
  color: var(--text);
  background: #fff;
  cursor: pointer;
  transition: border-color var(--transition);
}
.filter-select:focus { outline: none; border-color: var(--teal); }

/* Buttons */
.btn {
  padding: 9px 18px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.btn svg { width: 16px; height: 16px; flex-shrink: 0; }
.btn-primary {
  background: var(--teal);
  color: #fff;
}
.btn-primary:hover {
  background: var(--teal-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(13,148,136,.3);
}
.btn-outline {
  background: #fff;
  border: 2px solid var(--border);
  color: var(--text-secondary);
}
.btn-outline:hover { border-color: var(--teal); color: var(--teal); }
.btn-danger {
  background: var(--red-bg);
  color: var(--red);
}
.btn-danger:hover { background: #fecaca; }
.btn-success {
  background: var(--green-bg);
  color: var(--green);
}
.btn-success:hover { background: #a7f3d0; }
.btn-sm { padding: 6px 12px; font-size: 11px; }
.btn-sm svg { width: 13px; height: 13px; }
.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  padding: 6px 10px;
}
.btn-ghost:hover { background: var(--border-light); color: var(--teal); }

/* Badge */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.badge-green { background: var(--green-bg); color: var(--green); }
.badge-amber { background: var(--amber-bg); color: var(--amber); }
.badge-red { background: var(--red-bg); color: var(--red); }
.badge-blue { background: var(--blue-bg); color: var(--blue); }
.badge-gray { background: var(--border-light); color: var(--text-secondary); }
.badge-purple { background: var(--purple-bg); color: var(--purple); }

/* Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.data-table th {
  text-align: left;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  padding: 12px 16px;
  border-bottom: 2px solid var(--border);
  background: var(--border-light);
}
.data-table td {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border-light);
  vertical-align: middle;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr { transition: background 150ms; }
.data-table tr:hover td { background: #fafbfc; }
.data-table .org-cell {
  display: flex;
  align-items: center;
  gap: 10px;
}
.org-logo {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 800;
  flex-shrink: 0;
}
.org-name { font-weight: 700; }
.org-slug { font-size: 11px; color: var(--text-secondary); }
.actions-cell {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15,23,42,.6);
  backdrop-filter: blur(4px);
  z-index: 200;
  display: none;
  align-items: flex-start;
  justify-content: center;
  padding: 40px 16px;
  overflow-y: auto;
}
.modal-overlay.show {
  display: flex;
}
.modal {
  background: var(--card);
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 640px;
  animation: modalIn 0.2s ease-out;
}
@keyframes modalIn {
  from { opacity: 0; transform: translateY(-8px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}
.modal-header h2 { font-size: 17px; font-weight: 800; flex: 1; }
.modal-close {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  color: var(--text-secondary);
  transition: all var(--transition);
}
.modal-close:hover { background: var(--border-light); color: var(--text); }
.modal-close svg { width: 20px; height: 20px; }
.modal-body { padding: 24px; }
.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* Form elements */
.form-group { margin-bottom: 16px; }
.form-label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--navy-light);
  margin-bottom: 6px;
}
.form-input {
  width: 100%;
  padding: 10px 14px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  font-family: inherit;
  color: var(--text);
  background: #fff;
  transition: border-color var(--transition);
}
.form-input:focus { outline: none; border-color: var(--teal); }
.form-hint {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

/* Color picker */
.color-picker-group {
  display: flex;
  align-items: center;
  gap: 10px;
}
.color-swatch {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  border: 2px solid var(--border);
  cursor: pointer;
  overflow: hidden;
  position: relative;
}
.color-swatch input[type="color"] {
  position: absolute;
  top: -4px;
  left: -4px;
  width: 44px;
  height: 44px;
  border: none;
  cursor: pointer;
}
.color-hex {
  font-size: 13px;
  font-weight: 600;
  font-family: 'SF Mono', Consolas, monospace;
  color: var(--text-secondary);
}

/* Module toggles */
.modules-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.module-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border: 2px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 150ms;
}
.module-toggle:hover { border-color: var(--teal); }
.module-toggle.active {
  border-color: var(--teal);
  background: var(--teal-bg);
}
.module-toggle-switch {
  width: 36px;
  height: 20px;
  background: var(--border);
  border-radius: 10px;
  position: relative;
  transition: background 150ms;
  flex-shrink: 0;
}
.module-toggle.active .module-toggle-switch { background: var(--teal); }
.module-toggle-switch::after {
  content: '';
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform 150ms;
  box-shadow: 0 1px 3px rgba(0,0,0,.15);
}
.module-toggle.active .module-toggle-switch::after { transform: translateX(16px); }
.module-info { flex: 1; }
.module-name { font-size: 12px; font-weight: 700; }
.module-price { font-size: 11px; color: var(--text-secondary); }

/* Price preview */
.price-preview {
  background: var(--navy);
  border-radius: 10px;
  padding: 16px;
  color: #fff;
  margin-top: 16px;
}
.price-preview-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: rgba(255,255,255,.5);
}
.price-preview-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  font-size: 13px;
}
.price-preview-row.total {
  border-top: 1px solid rgba(255,255,255,.15);
  margin-top: 6px;
  padding-top: 10px;
  font-size: 18px;
  font-weight: 800;
}
.price-preview-row .amount { font-weight: 700; }
.price-preview-row.total .amount { color: var(--teal-light); }

/* Detail panel (right slide) */
.detail-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15,23,42,.4);
  z-index: 150;
  display: none;
}
.detail-overlay.show { display: block; }
.detail-panel {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: 520px;
  max-width: 90vw;
  background: var(--card);
  box-shadow: -8px 0 32px rgba(0,0,0,.12);
  z-index: 151;
  transform: translateX(100%);
  transition: transform 0.25s ease;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}
.detail-panel.show { transform: translateX(0); }
.detail-panel-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  top: 0;
  background: var(--card);
  z-index: 10;
}
.detail-panel-header h2 { font-size: 16px; font-weight: 800; flex: 1; }
.detail-tabs {
  display: flex;
  gap: 2px;
  padding: 0 24px;
  border-bottom: 1px solid var(--border);
  background: var(--card);
  position: sticky;
  top: 65px;
  z-index: 9;
}
.detail-tab {
  padding: 12px 16px;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 150ms;
  background: transparent;
  border-top: none;
  border-left: none;
  border-right: none;
  font-family: inherit;
}
.detail-tab:hover { color: var(--text); }
.detail-tab.active {
  color: var(--teal);
  border-bottom-color: var(--teal);
}
.detail-body { padding: 24px; flex: 1; }

/* Usage bar */
.usage-bar-wrap {
  margin-bottom: 14px;
}
.usage-bar-header {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  margin-bottom: 4px;
}
.usage-bar-label { font-weight: 600; }
.usage-bar-value { color: var(--text-secondary); }
.usage-bar {
  height: 8px;
  background: var(--border-light);
  border-radius: 4px;
  overflow: hidden;
}
.usage-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s ease;
}

/* Activity log */
.activity-log {}
.activity-log-item {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 12px;
  align-items: flex-start;
}
.activity-log-item:last-child { border-bottom: none; }
.activity-log-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-top: 4px;
  flex-shrink: 0;
}
.activity-log-text { flex: 1; line-height: 1.5; }
.activity-log-time { color: var(--text-secondary); white-space: nowrap; font-size: 11px; }

/* Spinner */
.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--teal);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Section header in forms */
.section-header {
  font-size: 13px;
  font-weight: 800;
  color: var(--text);
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  margin: 20px 0 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.section-header:first-child { margin-top: 0; }
.section-header svg { width: 16px; height: 16px; color: var(--teal); }

/* Logo upload */
.logo-upload {
  display: flex;
  align-items: center;
  gap: 14px;
}
.logo-preview {
  width: 56px;
  height: 56px;
  border-radius: 12px;
  border: 2px dashed var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  font-size: 12px;
  font-weight: 700;
  overflow: hidden;
  flex-shrink: 0;
  cursor: pointer;
  transition: border-color var(--transition);
}
.logo-preview:hover { border-color: var(--teal); }
.logo-preview img { width: 100%; height: 100%; object-fit: cover; }
.logo-preview svg { width: 24px; height: 24px; }
.logo-upload-text { font-size: 12px; color: var(--text-secondary); }
.logo-upload-text strong { color: var(--teal); cursor: pointer; }

/* Responsive */
@media (max-width: 1024px) {
  .stats-row { grid-template-columns: repeat(3, 1fr); }
  .detail-panel { width: 100%; max-width: 100%; }
}
@media (max-width: 768px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .container { padding: 16px; }
  .data-table { font-size: 12px; }
  .data-table th, .data-table td { padding: 10px 8px; }
  .toolbar { gap: 8px; }
  .form-row { grid-template-columns: 1fr; }
  .modules-grid { grid-template-columns: 1fr; }
  .actions-cell { gap: 2px; }
}
@media (max-width: 480px) {
  .stats-row { grid-template-columns: 1fr; }
  .header-user { display: none; }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-logo">
    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
      <polyline points="9 22 9 12 15 12 15 22"/>
    </svg>
  </div>
  <div class="header-text">
    <h1>Titus CRM &mdash; Tenant Manager</h1>
    <p>Superadmin Dashboard</p>
  </div>
  <div class="header-actions">
    <div class="header-user">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Superadmin
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container">
  <!-- Stats Row -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card">
      <div class="stat-icon" style="background:var(--blue-bg);color:var(--blue)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
      <div><div class="stat-label">Total Tenants</div><div class="stat-value" id="statTotal">--</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:var(--green-bg);color:var(--green)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
      <div><div class="stat-label">Active</div><div class="stat-value" id="statActive">--</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:var(--amber-bg);color:var(--amber)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div><div class="stat-label">Trial</div><div class="stat-value" id="statTrial">--</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:var(--red-bg);color:var(--red)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div>
      <div><div class="stat-label">Suspended</div><div class="stat-value" id="statSuspended">--</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:var(--purple-bg);color:var(--purple)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
      <div><div class="stat-label">Weekly Revenue</div><div class="stat-value" id="statRevenue">--</div><div class="stat-sub">per week</div></div>
    </div>
  </div>

  <!-- Tenant Table Card -->
  <div class="card">
    <div class="card-header">
      <div class="card-header-icon" style="background:var(--teal-bg);color:var(--teal)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <h2>Tenants</h2>
      <button class="btn btn-primary" id="createTenantBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Create Tenant
      </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="searchInput" placeholder="Search tenants...">
      </div>
      <select class="filter-select" id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="trial">Trial</option>
        <option value="suspended">Suspended</option>
      </select>
    </div>

    <!-- Table -->
    <div style="overflow-x:auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>Organisation</th>
            <th>Status</th>
            <th>Users</th>
            <th>Clients</th>
            <th>Weekly Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tenantTableBody">
          <tr><td colspan="6" style="text-align:center;padding:40px"><div class="spinner" style="margin:0 auto"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Create Tenant Modal -->
<div class="modal-overlay" id="createModal">
  <div class="modal">
    <div class="modal-header">
      <div class="card-header-icon" style="background:var(--teal-bg);color:var(--teal)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
      <h2>Create Tenant</h2>
      <button class="modal-close" id="closeCreateModal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
        Organisation Details
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Organisation Name</label>
          <input class="form-input" type="text" id="createOrgName" placeholder="e.g. Delta Community Support">
        </div>
        <div class="form-group">
          <label class="form-label">Slug</label>
          <input class="form-input" type="text" id="createSlug" placeholder="auto-generated">
          <div class="form-hint">URL-friendly identifier. Auto-generated from name.</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Admin Email</label>
          <input class="form-input" type="email" id="createAdminEmail" placeholder="admin@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Custom Domain (optional)</label>
          <input class="form-input" type="text" id="createDomain" placeholder="e.g. app.company.com">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Logo</label>
        <div class="logo-upload">
          <div class="logo-preview" id="logoPreview" title="Click to upload logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          </div>
          <input type="file" id="logoFileInput" accept="image/*" style="display:none">
          <div class="logo-upload-text"><strong id="logoUploadTrigger">Click to upload</strong> or drag and drop<br>PNG, JPG up to 2MB</div>
        </div>
      </div>

      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r="2.5"/><path d="M17 14c0-2.76-2.24-5-5-5H12c-2.76 0-5 2.24-5 5"/><circle cx="12" cy="17" r="4"/></svg>
        Branding
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Primary Color</label>
          <div class="color-picker-group">
            <div class="color-swatch">
              <input type="color" id="createPrimaryColor" value="#0d9488">
            </div>
            <span class="color-hex" id="primaryColorHex">#0d9488</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Secondary Color</label>
          <div class="color-picker-group">
            <div class="color-swatch">
              <input type="color" id="createSecondaryColor" value="#0f172a">
            </div>
            <span class="color-hex" id="secondaryColorHex">#0f172a</span>
          </div>
        </div>
      </div>

      <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Plan &amp; Modules
      </div>

      <div class="form-group">
        <label class="form-label">Base Tier</label>
        <select class="form-input" id="createTier" style="cursor:pointer">
          <option value="starter" data-price="49">Starter - $49/week</option>
          <option value="professional" data-price="99" selected>Professional - $99/week</option>
          <option value="enterprise" data-price="199">Enterprise - $199/week</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Add-on Modules</label>
        <div class="modules-grid" id="modulesGrid">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="price-preview" id="pricePreview">
        <div class="price-preview-label">Price Summary</div>
        <div class="price-preview-row"><span>Base tier</span><span class="amount" id="priceBase">$99/wk</span></div>
        <div id="priceAddons"></div>
        <div class="price-preview-row total"><span>Total</span><span class="amount" id="priceTotal">$99/wk</span></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelCreateBtn">Cancel</button>
      <button class="btn btn-primary" id="submitCreateBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Create Tenant
      </button>
    </div>
  </div>
</div>

<!-- Detail Panel -->
<div class="detail-overlay" id="detailOverlay"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-panel-header">
    <h2 id="detailTitle">Tenant Details</h2>
    <button class="modal-close" id="closeDetailPanel">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="detail-tabs">
    <button class="detail-tab active" data-detail-tab="edit">Edit</button>
    <button class="detail-tab" data-detail-tab="modules">Modules</button>
    <button class="detail-tab" data-detail-tab="usage">Usage</button>
    <button class="detail-tab" data-detail-tab="activity">Activity</button>
  </div>
  <div class="detail-body" id="detailBody">
    <!-- Rendered by JS -->
  </div>
</div>

<script>
(function() {
  'use strict';

  // ===== MODULES CONFIG =====
  var MODULES = [
    { id: 'voice', name: 'Voice & Telephony', price: 29, icon: 'phone' },
    { id: 'recruitment', name: 'Recruitment', price: 19, icon: 'users' },
    { id: 'lms', name: 'Learning (LMS)', price: 15, icon: 'book' },
    { id: 'documents', name: 'Document Signing', price: 12, icon: 'file' },
    { id: 'compliance', name: 'Compliance & Audit', price: 19, icon: 'shield' },
    { id: 'reports_ai', name: 'AI Reports', price: 25, icon: 'chart' },
    { id: 'portal', name: 'Stakeholder Portal', price: 15, icon: 'globe' },
    { id: 'email', name: 'Email Integration', price: 10, icon: 'mail' },
    { id: 'budget', name: 'NDIS Budget Tracking', price: 15, icon: 'dollar' },
    { id: 'accommodation', name: 'SIL Properties', price: 12, icon: 'home' }
  ];

  var TIERS = { starter: 49, professional: 99, enterprise: 199 };

  // ===== STATE =====
  var tenants = [];
  var selectedTenant = null;
  var createModules = {};

  function getToken() {
    return localStorage.getItem('titus_token') || '';
  }

  function apiCall(method, path, body) {
    var opts = {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'x-auth-token': getToken()
      }
    };
    if (body) opts.body = JSON.stringify(body);
    return fetch('/api/admin/tenants' + path, opts).then(function(r) { return r.json(); });
  }

  function escapeHtml(str) {
    if (!str) return '';
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function slugify(str) {
    return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  }

  function formatCurrency(num) {
    return '$' + Number(num || 0).toLocaleString('en-AU', { minimumFractionDigits: 0 });
  }

  function getStatusBadge(status) {
    var s = (status || '').toLowerCase();
    if (s === 'active') return '<span class="badge badge-green">Active</span>';
    if (s === 'trial') return '<span class="badge badge-amber">Trial</span>';
    if (s === 'suspended') return '<span class="badge badge-red">Suspended</span>';
    return '<span class="badge badge-gray">' + escapeHtml(status || 'Unknown') + '</span>';
  }

  function getOrgColor(name) {
    var colors = ['#0d9488','#2563eb','#7c3aed','#db2777','#ea580c','#059669','#d97706'];
    var hash = 0;
    for (var i = 0; i < (name || '').length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
  }

  // ===== FETCH TENANTS =====
  function loadTenants() {
    apiCall('GET', '')
      .then(function(data) {
        tenants = data.tenants || data || [];
        if (!Array.isArray(tenants)) tenants = [];
        updateStats();
        renderTable();
      })
      .catch(function() {
        document.getElementById('tenantTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-secondary)">Failed to load tenants. Check your connection.</td></tr>';
      });
  }

  function updateStats() {
    var total = tenants.length;
    var active = tenants.filter(function(t) { return (t.status || '').toLowerCase() === 'active'; }).length;
    var trial = tenants.filter(function(t) { return (t.status || '').toLowerCase() === 'trial'; }).length;
    var suspended = tenants.filter(function(t) { return (t.status || '').toLowerCase() === 'suspended'; }).length;
    var revenue = tenants.reduce(function(sum, t) { return sum + (t.weekly_price || 0); }, 0);

    document.getElementById('statTotal').textContent = total;
    document.getElementById('statActive').textContent = active;
    document.getElementById('statTrial').textContent = trial;
    document.getElementById('statSuspended').textContent = suspended;
    document.getElementById('statRevenue').textContent = formatCurrency(revenue);
  }

  function renderTable() {
    var tbody = document.getElementById('tenantTableBody');
    var search = document.getElementById('searchInput').value.toLowerCase();
    var statusFilter = document.getElementById('statusFilter').value.toLowerCase();

    var filtered = tenants.filter(function(t) {
      var matchSearch = !search || (t.org_name || t.name || '').toLowerCase().indexOf(search) > -1 || (t.slug || '').toLowerCase().indexOf(search) > -1;
      var matchStatus = !statusFilter || (t.status || '').toLowerCase() === statusFilter;
      return matchSearch && matchStatus;
    });

    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-secondary)">' +
        (tenants.length === 0 ? 'No tenants yet. Create your first tenant to get started.' : 'No tenants match your search.') +
      '</td></tr>';
      return;
    }

    var html = '';
    filtered.forEach(function(t) {
      var name = t.org_name || t.name || 'Unnamed';
      var color = t.primary_color || getOrgColor(name);
      var initials = name.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 2);

      html += '<tr data-id="' + (t.id || '') + '" style="cursor:pointer">' +
        '<td><div class="org-cell">' +
          '<div class="org-logo" style="background:' + color + ';color:#fff">' + (t.logo_url ? '<img src="' + t.logo_url + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px">' : initials) + '</div>' +
          '<div><div class="org-name">' + escapeHtml(name) + '</div><div class="org-slug">' + escapeHtml(t.slug || '') + '</div></div>' +
        '</div></td>' +
        '<td>' + getStatusBadge(t.status) + '</td>' +
        '<td>' + (t.user_count != null ? t.user_count : '--') + '</td>' +
        '<td>' + (t.client_count != null ? t.client_count : '--') + '</td>' +
        '<td style="font-weight:700">' + formatCurrency(t.weekly_price) + '<span style="font-size:10px;color:var(--text-secondary);font-weight:500">/wk</span></td>' +
        '<td><div class="actions-cell">' +
          '<button class="btn btn-ghost btn-sm action-edit" data-id="' + (t.id || '') + '" title="Edit">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>' +
          '</button>' +
          '<button class="btn btn-ghost btn-sm action-modules" data-id="' + (t.id || '') + '" title="Modules">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>' +
          '</button>' +
          ((t.status || '').toLowerCase() === 'suspended' ?
            '<button class="btn btn-success btn-sm action-activate" data-id="' + (t.id || '') + '" title="Activate"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></button>' :
            '<button class="btn btn-danger btn-sm action-suspend" data-id="' + (t.id || '') + '" title="Suspend"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></button>'
          ) +
          '<button class="btn btn-ghost btn-sm action-impersonate" data-id="' + (t.id || '') + '" title="Impersonate">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' +
          '</button>' +
        '</div></td>' +
      '</tr>';
    });

    tbody.innerHTML = html;

    // Row click -> detail panel
    tbody.querySelectorAll('tr').forEach(function(row) {
      row.addEventListener('click', function(e) {
        if (e.target.closest('.actions-cell')) return;
        var id = row.getAttribute('data-id');
        openDetail(id);
      });
    });

    // Action buttons
    tbody.querySelectorAll('.action-edit').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        openDetail(btn.getAttribute('data-id'), 'edit');
      });
    });
    tbody.querySelectorAll('.action-modules').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        openDetail(btn.getAttribute('data-id'), 'modules');
      });
    });
    tbody.querySelectorAll('.action-suspend').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm('Suspend this tenant? They will lose access immediately.')) {
          apiCall('PUT', '/' + btn.getAttribute('data-id'), { status: 'suspended' })
            .then(function() { loadTenants(); });
        }
      });
    });
    tbody.querySelectorAll('.action-activate').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        apiCall('PUT', '/' + btn.getAttribute('data-id'), { status: 'active' })
          .then(function() { loadTenants(); });
      });
    });
    tbody.querySelectorAll('.action-impersonate').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var id = btn.getAttribute('data-id');
        apiCall('POST', '/' + id + '/impersonate')
          .then(function(data) {
            if (data.redirect_url) {
              window.open(data.redirect_url, '_blank');
            } else if (data.token) {
              window.open('/?impersonate_token=' + data.token, '_blank');
            }
          });
      });
    });
  }

  // ===== SEARCH & FILTER =====
  document.getElementById('searchInput').addEventListener('input', renderTable);
  document.getElementById('statusFilter').addEventListener('change', renderTable);

  // ===== CREATE MODAL =====
  var createModal = document.getElementById('createModal');

  document.getElementById('createTenantBtn').addEventListener('click', function() {
    createModal.classList.add('show');
    document.getElementById('createOrgName').value = '';
    document.getElementById('createSlug').value = '';
    document.getElementById('createAdminEmail').value = '';
    document.getElementById('createDomain').value = '';
    document.getElementById('createTier').value = 'professional';
    document.getElementById('createPrimaryColor').value = '#0d9488';
    document.getElementById('createSecondaryColor').value = '#0f172a';
    document.getElementById('primaryColorHex').textContent = '#0d9488';
    document.getElementById('secondaryColorHex').textContent = '#0f172a';
    createModules = {};
    renderModulesGrid();
    updatePricePreview();
  });

  document.getElementById('closeCreateModal').addEventListener('click', function() { createModal.classList.remove('show'); });
  document.getElementById('cancelCreateBtn').addEventListener('click', function() { createModal.classList.remove('show'); });
  createModal.addEventListener('click', function(e) { if (e.target === createModal) createModal.classList.remove('show'); });

  // Slug auto-gen
  document.getElementById('createOrgName').addEventListener('input', function() {
    document.getElementById('createSlug').value = slugify(this.value);
  });

  // Color pickers
  document.getElementById('createPrimaryColor').addEventListener('input', function() {
    document.getElementById('primaryColorHex').textContent = this.value;
  });
  document.getElementById('createSecondaryColor').addEventListener('input', function() {
    document.getElementById('secondaryColorHex').textContent = this.value;
  });

  // Logo upload
  var logoPreview = document.getElementById('logoPreview');
  var logoFileInput = document.getElementById('logoFileInput');
  logoPreview.addEventListener('click', function() { logoFileInput.click(); });
  document.getElementById('logoUploadTrigger').addEventListener('click', function() { logoFileInput.click(); });
  logoFileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      var reader = new FileReader();
      reader.onload = function(e) {
        logoPreview.innerHTML = '<img src="' + e.target.result + '">';
      };
      reader.readAsDataURL(this.files[0]);
    }
  });

  // Modules grid
  function renderModulesGrid() {
    var grid = document.getElementById('modulesGrid');
    var html = '';
    MODULES.forEach(function(m) {
      var active = createModules[m.id] ? ' active' : '';
      html += '<div class="module-toggle' + active + '" data-module="' + m.id + '">' +
        '<div class="module-toggle-switch"></div>' +
        '<div class="module-info"><div class="module-name">' + m.name + '</div><div class="module-price">+$' + m.price + '/wk</div></div>' +
      '</div>';
    });
    grid.innerHTML = html;

    grid.querySelectorAll('.module-toggle').forEach(function(toggle) {
      toggle.addEventListener('click', function() {
        var id = toggle.getAttribute('data-module');
        if (createModules[id]) {
          delete createModules[id];
          toggle.classList.remove('active');
        } else {
          createModules[id] = true;
          toggle.classList.add('active');
        }
        updatePricePreview();
      });
    });
  }

  // Tier change
  document.getElementById('createTier').addEventListener('change', updatePricePreview);

  function updatePricePreview() {
    var tier = document.getElementById('createTier').value;
    var basePrice = TIERS[tier] || 99;
    document.getElementById('priceBase').textContent = '$' + basePrice + '/wk';

    var addonsHtml = '';
    var addonsTotal = 0;
    MODULES.forEach(function(m) {
      if (createModules[m.id]) {
        addonsHtml += '<div class="price-preview-row"><span>' + m.name + '</span><span class="amount">+$' + m.price + '/wk</span></div>';
        addonsTotal += m.price;
      }
    });
    document.getElementById('priceAddons').innerHTML = addonsHtml;
    document.getElementById('priceTotal').textContent = '$' + (basePrice + addonsTotal) + '/wk';
  }

  // Submit create
  document.getElementById('submitCreateBtn').addEventListener('click', function() {
    var orgName = document.getElementById('createOrgName').value.trim();
    var slug = document.getElementById('createSlug').value.trim();
    var email = document.getElementById('createAdminEmail').value.trim();
    var domain = document.getElementById('createDomain').value.trim();
    var tier = document.getElementById('createTier').value;
    var primaryColor = document.getElementById('createPrimaryColor').value;
    var secondaryColor = document.getElementById('createSecondaryColor').value;

    if (!orgName) { alert('Organisation name is required.'); return; }
    if (!email) { alert('Admin email is required.'); return; }

    var btn = document.getElementById('submitCreateBtn');
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px"></div> Creating...';

    var enabledModules = Object.keys(createModules);
    var basePrice = TIERS[tier] || 99;
    var addonsPrice = enabledModules.reduce(function(sum, id) {
      var m = MODULES.find(function(mod) { return mod.id === id; });
      return sum + (m ? m.price : 0);
    }, 0);

    apiCall('POST', '', {
      org_name: orgName,
      slug: slug || slugify(orgName),
      admin_email: email,
      domain: domain || null,
      tier: tier,
      primary_color: primaryColor,
      secondary_color: secondaryColor,
      modules: enabledModules,
      weekly_price: basePrice + addonsPrice
    })
    .then(function(data) {
      btn.disabled = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Create Tenant';

      if (data.error) { alert(data.error); return; }
      createModal.classList.remove('show');
      loadTenants();
    })
    .catch(function() {
      btn.disabled = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Create Tenant';
      alert('Failed to create tenant. Please try again.');
    });
  });

  renderModulesGrid();
  updatePricePreview();

  // ===== DETAIL PANEL =====
  var detailOverlay = document.getElementById('detailOverlay');
  var detailPanel = document.getElementById('detailPanel');
  var detailBody = document.getElementById('detailBody');
  var currentDetailTab = 'edit';

  function openDetail(id, tab) {
    selectedTenant = tenants.find(function(t) { return String(t.id) === String(id); });
    if (!selectedTenant) return;

    document.getElementById('detailTitle').textContent = selectedTenant.org_name || selectedTenant.name || 'Tenant Details';
    detailOverlay.classList.add('show');
    setTimeout(function() { detailPanel.classList.add('show'); }, 10);

    currentDetailTab = tab || 'edit';
    document.querySelectorAll('.detail-tab').forEach(function(t) {
      t.classList.toggle('active', t.getAttribute('data-detail-tab') === currentDetailTab);
    });
    renderDetailTab(currentDetailTab);
  }

  function closeDetail() {
    detailPanel.classList.remove('show');
    detailOverlay.classList.remove('show');
    selectedTenant = null;
  }

  document.getElementById('closeDetailPanel').addEventListener('click', closeDetail);
  detailOverlay.addEventListener('click', closeDetail);

  document.querySelectorAll('.detail-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      currentDetailTab = tab.getAttribute('data-detail-tab');
      document.querySelectorAll('.detail-tab').forEach(function(t) {
        t.classList.toggle('active', t === tab);
      });
      renderDetailTab(currentDetailTab);
    });
  });

  function renderDetailTab(tab) {
    if (!selectedTenant) return;
    var t = selectedTenant;

    if (tab === 'edit') {
      detailBody.innerHTML = '<div class="form-row"><div class="form-group"><label class="form-label">Organisation Name</label><input class="form-input" type="text" id="editOrgName" value="' + escapeHtml(t.org_name || t.name || '') + '"></div><div class="form-group"><label class="form-label">Slug</label><input class="form-input" type="text" id="editSlug" value="' + escapeHtml(t.slug || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Admin Email</label><input class="form-input" type="email" id="editEmail" value="' + escapeHtml(t.admin_email || '') + '"></div><div class="form-group"><label class="form-label">Domain</label><input class="form-input" type="text" id="editDomain" value="' + escapeHtml(t.domain || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Status</label><select class="form-input" id="editStatus" style="cursor:pointer"><option value="active"' + (t.status === 'active' ? ' selected' : '') + '>Active</option><option value="trial"' + (t.status === 'trial' ? ' selected' : '') + '>Trial</option><option value="suspended"' + (t.status === 'suspended' ? ' selected' : '') + '>Suspended</option></select></div><div class="form-group"><label class="form-label">Tier</label><select class="form-input" id="editTier" style="cursor:pointer"><option value="starter"' + (t.tier === 'starter' ? ' selected' : '') + '>Starter</option><option value="professional"' + (t.tier === 'professional' ? ' selected' : '') + '>Professional</option><option value="enterprise"' + (t.tier === 'enterprise' ? ' selected' : '') + '>Enterprise</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label class="form-label">Primary Color</label><div class="color-picker-group"><div class="color-swatch"><input type="color" id="editPrimary" value="' + (t.primary_color || '#0d9488') + '"></div><span class="color-hex">' + (t.primary_color || '#0d9488') + '</span></div></div><div class="form-group"><label class="form-label">Secondary Color</label><div class="color-picker-group"><div class="color-swatch"><input type="color" id="editSecondary" value="' + (t.secondary_color || '#0f172a') + '"></div><span class="color-hex">' + (t.secondary_color || '#0f172a') + '</span></div></div></div>' +
        '<div style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-primary" id="saveEditBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes</button></div>';

      document.getElementById('saveEditBtn').addEventListener('click', function() {
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';
        apiCall('PUT', '/' + t.id, {
          org_name: document.getElementById('editOrgName').value.trim(),
          slug: document.getElementById('editSlug').value.trim(),
          admin_email: document.getElementById('editEmail').value.trim(),
          domain: document.getElementById('editDomain').value.trim(),
          status: document.getElementById('editStatus').value,
          tier: document.getElementById('editTier').value,
          primary_color: document.getElementById('editPrimary').value,
          secondary_color: document.getElementById('editSecondary').value
        }).then(function(data) {
          btn.disabled = false;
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes';
          if (!data.error) { loadTenants(); closeDetail(); }
          else alert(data.error);
        }).catch(function() {
          btn.disabled = false;
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes';
        });
      });

    } else if (tab === 'modules') {
      var tenantModules = t.modules || [];
      var html = '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Toggle modules for this tenant. Price recalculates automatically.</p>';
      html += '<div class="modules-grid">';
      MODULES.forEach(function(m) {
        var isActive = tenantModules.indexOf(m.id) > -1;
        html += '<div class="module-toggle' + (isActive ? ' active' : '') + '" data-module="' + m.id + '">' +
          '<div class="module-toggle-switch"></div>' +
          '<div class="module-info"><div class="module-name">' + m.name + '</div><div class="module-price">+$' + m.price + '/wk</div></div>' +
        '</div>';
      });
      html += '</div>';

      var basePrice = TIERS[t.tier] || 99;
      var addonTotal = tenantModules.reduce(function(sum, id) {
        var m = MODULES.find(function(mod) { return mod.id === id; });
        return sum + (m ? m.price : 0);
      }, 0);
      html += '<div class="price-preview" style="margin-top:16px"><div class="price-preview-label">Price Summary</div><div class="price-preview-row"><span>Base (' + (t.tier || 'professional') + ')</span><span class="amount">$' + basePrice + '/wk</span></div><div id="detailPriceAddons"></div><div class="price-preview-row total"><span>Total</span><span class="amount" id="detailPriceTotal">$' + (basePrice + addonTotal) + '/wk</span></div></div>';
      html += '<div style="margin-top:16px;display:flex;justify-content:flex-end"><button class="btn btn-primary" id="saveModulesBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Modules</button></div>';

      detailBody.innerHTML = html;

      // Module toggles
      var detailModules = tenantModules.slice();
      detailBody.querySelectorAll('.module-toggle').forEach(function(toggle) {
        toggle.addEventListener('click', function() {
          var id = toggle.getAttribute('data-module');
          var idx = detailModules.indexOf(id);
          if (idx > -1) {
            detailModules.splice(idx, 1);
            toggle.classList.remove('active');
          } else {
            detailModules.push(id);
            toggle.classList.add('active');
          }
          // Update price
          var newAddonTotal = detailModules.reduce(function(sum, mid) {
            var m = MODULES.find(function(mod) { return mod.id === mid; });
            return sum + (m ? m.price : 0);
          }, 0);
          var addonsHtml = '';
          MODULES.forEach(function(m) {
            if (detailModules.indexOf(m.id) > -1) {
              addonsHtml += '<div class="price-preview-row"><span>' + m.name + '</span><span class="amount">+$' + m.price + '/wk</span></div>';
            }
          });
          var detailPriceAddons = document.getElementById('detailPriceAddons');
          if (detailPriceAddons) detailPriceAddons.innerHTML = addonsHtml;
          var detailPriceTotal = document.getElementById('detailPriceTotal');
          if (detailPriceTotal) detailPriceTotal.textContent = '$' + (basePrice + newAddonTotal) + '/wk';
        });
      });

      document.getElementById('saveModulesBtn').addEventListener('click', function() {
        var btn = this;
        btn.disabled = true;
        var newAddonTotal = detailModules.reduce(function(sum, mid) {
          var m = MODULES.find(function(mod) { return mod.id === mid; });
          return sum + (m ? m.price : 0);
        }, 0);
        apiCall('PUT', '/' + t.id, { modules: detailModules, weekly_price: basePrice + newAddonTotal })
          .then(function() { btn.disabled = false; loadTenants(); closeDetail(); })
          .catch(function() { btn.disabled = false; });
      });

    } else if (tab === 'usage') {
      var usage = t.usage || {};
      detailBody.innerHTML = '<div class="usage-bar-wrap"><div class="usage-bar-header"><span class="usage-bar-label">Users</span><span class="usage-bar-value">' + (usage.users || t.user_count || 0) + ' / ' + (usage.user_limit || 50) + '</span></div><div class="usage-bar"><div class="usage-bar-fill" style="width:' + Math.min(100, ((usage.users || t.user_count || 0) / (usage.user_limit || 50)) * 100) + '%;background:var(--teal)"></div></div></div>' +
        '<div class="usage-bar-wrap"><div class="usage-bar-header"><span class="usage-bar-label">Clients</span><span class="usage-bar-value">' + (usage.clients || t.client_count || 0) + ' / ' + (usage.client_limit || 200) + '</span></div><div class="usage-bar"><div class="usage-bar-fill" style="width:' + Math.min(100, ((usage.clients || t.client_count || 0) / (usage.client_limit || 200)) * 100) + '%;background:var(--blue)"></div></div></div>' +
        '<div class="usage-bar-wrap"><div class="usage-bar-header"><span class="usage-bar-label">Storage</span><span class="usage-bar-value">' + (usage.storage_mb || 0) + ' MB / ' + (usage.storage_limit_mb || 5000) + ' MB</span></div><div class="usage-bar"><div class="usage-bar-fill" style="width:' + Math.min(100, ((usage.storage_mb || 0) / (usage.storage_limit_mb || 5000)) * 100) + '%;background:var(--purple)"></div></div></div>' +
        '<div class="usage-bar-wrap"><div class="usage-bar-header"><span class="usage-bar-label">API Calls (this month)</span><span class="usage-bar-value">' + ((usage.api_calls || 0).toLocaleString()) + ' / ' + ((usage.api_limit || 100000).toLocaleString()) + '</span></div><div class="usage-bar"><div class="usage-bar-fill" style="width:' + Math.min(100, ((usage.api_calls || 0) / (usage.api_limit || 100000)) * 100) + '%;background:var(--amber)"></div></div></div>';

    } else if (tab === 'activity') {
      var logs = t.activity_log || t.activity || [];
      if (logs.length === 0) {
        detailBody.innerHTML = '<div style="text-align:center;padding:32px;color:var(--text-secondary)"><p style="font-size:13px">No activity recorded yet.</p></div>';
        return;
      }
      var html = '<div class="activity-log">';
      logs.forEach(function(log) {
        var dotColor = log.type === 'create' ? 'var(--green)' : log.type === 'update' ? 'var(--blue)' : log.type === 'suspend' ? 'var(--red)' : 'var(--border)';
        html += '<div class="activity-log-item"><div class="activity-log-dot" style="background:' + dotColor + '"></div><div class="activity-log-text">' + escapeHtml(log.description || log.text) + (log.user ? '<br><span style="color:var(--text-secondary)">by ' + escapeHtml(log.user) + '</span>' : '') + '</div><div class="activity-log-time">' + (log.date ? new Date(log.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : '') + '</div></div>';
      });
      html += '</div>';
      detailBody.innerHTML = html;
    }
  }

  // ===== INIT =====
  loadTenants();

})();
</script>
</body>
</html>
